<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Ya</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.chenyalun.com/"/>
  <updated>2019-12-06T08:53:05.141Z</updated>
  <id>http://blog.chenyalun.com/</id>
  
  <author>
    <name>Ya</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Appä½œå“ï¼šSplash</title>
    <link href="http://blog.chenyalun.com/2019/12/06/App%E4%BD%9C%E5%93%81%EF%BC%9ASplash/"/>
    <id>http://blog.chenyalun.com/2019/12/06/Appä½œå“ï¼šSplash/</id>
    <published>2019-12-06T06:55:25.000Z</published>
    <updated>2019-12-06T08:53:05.141Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> å®è·µä¸€äº›æƒ³æ³•ã€‚ </p><br><a id="more"></a><p></p><h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>æ‹œè¯»äº†Casaå‰è¾ˆçš„<a href="https://casatwy.com/iosying-yong-jia-gou-tan-kai-pian.html" target="_blank" rel="noopener">ã€ŠiOSåº”ç”¨æ¶æ„è°ˆã€‹</a>ç³»åˆ—æ–‡ç« ï¼Œæ”¶è·é¢‡ä¸°ï¼ŒèŒç”Ÿäº†æƒ³å®è·µçš„æƒ³æ³•ã€‚2017å¹´åˆ°ç°åœ¨ï¼Œè™½ç„¶å†™è¿‡ä¸å°‘é¡¹ç›®ï¼Œä½†æ˜¯å§‹ç»ˆæ²¡æœ‰Appä½œå“åœ¨App Storeä¸Šæ¶è¿‡ï¼Œä¹Ÿä¸€ç›´æœ‰è¿™ä¸ªå°å¿ƒæ„¿ã€‚æ‰‹æœºé‡Œé¢æœ‰ä¸ªå«Splasherçš„Appï¼Œæ˜¯å£çº¸ç±»å‹çš„Appï¼Œè™½ç„¶å£çº¸è´¨é‡ä¸é”™ï¼Œä½†æ˜¯Appä½“éªŒä¸å¤ªå¥½ï¼ŒåŠ è½½æ…¢ï¼Œç•Œé¢å†·é…·æ— æƒ…ã€‚åæ¥æ‰“å¬åˆ°å®ƒçš„APIæ¥è‡ªæ— ç‰ˆæƒå¯ä»¥å•†ç”¨çš„UnSplashã€‚å¤©æ—¶åœ°åˆ©äººå’Œéƒ½æœ‰äº†ï¼Œæˆ‘çš„ç¬¬ä¸€ä¸ªæœŸæœ›ä¸Šæ¶App Storeçš„ä½œå“ï¼šSplashï¼Œè¯ç”Ÿäº†ã€‚</p><p>è™½ç„¶åªæ˜¯å£çº¸ç±»çš„æ²¡æœ‰å¤šå°‘åŠŸèƒ½çš„ä¸éœ€è¦å¤šå°‘é“è¡Œå°±èƒ½å†™å‡ºæ¥çš„Appï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³ç®€å•èŠä¸€èŠã€‚</p><h1 id="äºŒã€æ€è·¯"><a href="#äºŒã€æ€è·¯" class="headerlink" title="äºŒã€æ€è·¯"></a>äºŒã€æ€è·¯</h1><h2 id="1ï¼Œä»£ç ç»“æ„"><a href="#1ï¼Œä»£ç ç»“æ„" class="headerlink" title="1ï¼Œä»£ç ç»“æ„"></a>1ï¼Œä»£ç ç»“æ„</h2><p>ä¸ä¿ºç›®å‰çš„ä¹ æƒ¯ä¸€è‡´ï¼šæ–¹æ³•ç»“æ„æŒ‰ç…§life cycleã€Delegateæ–¹æ³•å®ç°ã€event responseã€getters and settersé¡ºåºã€‚<br><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - Life cycle</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - Event response</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - Getter and setter</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - Private methods</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - Public methods</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - UITableViewDelegate</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> - UITableViewDataSource</span><br></pre></td></tr></table></figure></p><blockquote><p>åœ¨viewDidloadé‡Œé¢åªåšaddSubviewçš„äº‹æƒ…ï¼Œåœ¨viewDidLoadé‡Œé¢å¼€ä¸€ä¸ªlayoutPageSubviewsçš„æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªé‡Œé¢åˆ›å»ºConstraintså¹¶æ·»åŠ ï¼Œåœ¨viewDidAppearé‡Œé¢åšNotificationçš„ç›‘å¬ä¹‹ç±»çš„äº‹æƒ…ã€‚æ‰€æœ‰çš„å±æ€§éƒ½ä½¿ç”¨getterå’Œsetterï¼Œå¹¶ä¸”å…¨éƒ¨éƒ½æ”¾åœ¨æœ€åã€‚</p></blockquote><p>æˆ‘è§‰å¾—ä½œè€…è¯´çš„è¿˜æ˜¯æœ‰é“ç†çš„ï¼Œè™½ç„¶æŸäº›getterä¸€å®šä¼šç”¨åˆ°ï¼Œå†åšä¸€å±‚æ‡’åŠ è½½è²Œä¼¼æ˜¾å¾—å†—ä½™ï¼Œä½†æ˜¯ä»ç»“æ„ä¸Šçœ‹æ›´æ¸…æ™°ã€‚</p><h2 id="2ï¼Œå…¬æœ‰ç‰¹æ€§"><a href="#2ï¼Œå…¬æœ‰ç‰¹æ€§" class="headerlink" title="2ï¼Œå…¬æœ‰ç‰¹æ€§"></a>2ï¼Œå…¬æœ‰ç‰¹æ€§</h2><p>é¢å‘åˆ‡ç‰‡ç¼–ç¨‹</p><ul><li>ä»€ä¹ˆæ˜¯åˆ‡ç‰‡ï¼Ÿ<br>ç¨‹åºè¦å®Œæˆä¸€ä»¶äº‹æƒ…ï¼Œä¸€å®šä¼šæœ‰ä¸€äº›æ­¥éª¤ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4è¿™æ ·ã€‚è¿™é‡Œåˆ†è§£å‡ºæ¥çš„æ¯ä¸€ä¸ªæ­¥éª¤æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ‡ç‰‡ã€‚</li><li>ä»€ä¹ˆæ˜¯é¢å‘åˆ‡ç‰‡ç¼–ç¨‹ï¼Ÿ<br>ä½ é’ˆå¯¹æ¯ä¸€ä¸ªåˆ‡ç‰‡çš„é—´éš™ï¼Œå¡ä¸€äº›ä»£ç è¿›å»ï¼Œåœ¨ç¨‹åºæ­£å¸¸è¿›è¡Œ1ï¼Œ2ï¼Œ3ï¼Œ4æ­¥çš„é—´éš™å¯ä»¥è·‘åˆ°ä½ å¡è¿›å»çš„ä»£ç ï¼Œé‚£ä¹ˆä½ å†™è¿™äº›ä»£ç å°±æ˜¯é¢å‘åˆ‡ç‰‡ç¼–ç¨‹ã€‚</li><li>ä¸ºä»€ä¹ˆä¼šå‡ºç°é¢å‘åˆ‡ç‰‡ç¼–ç¨‹ï¼Ÿ<br>ä½ è¦æƒ³åšåˆ°åœ¨æ¯ä¸€ä¸ªæ­¥éª¤ä¸­é—´åšä½ è‡ªå·±çš„äº‹æƒ…ï¼Œä¸ç”¨AOPä¹Ÿä¸€æ ·å¯ä»¥è¾¾åˆ°ç›®çš„ï¼Œç›´æ¥å¾€æ­¥éª¤ä¹‹é—´å¡ä»£ç å°±å¥½äº†ã€‚ä½†æ˜¯äº‹å®æƒ…å†µå¾€å¾€å¾ˆå¤æ‚ï¼Œç›´æ¥æŠŠä»£ç å¡è¿›å»ï¼Œä¸»è¦é—®é¢˜å°±åœ¨äºï¼šå¡è¿›å»çš„ä»£ç å¾ˆæœ‰å¯èƒ½æ˜¯è·ŸåŸä¸šåŠ¡æ— å…³çš„ä»£ç ï¼Œåœ¨åŒä¸€ä»½ä»£ç æ–‡ä»¶é‡Œé¢æºæ‚å¤šç§ä¸šåŠ¡ï¼Œè¿™ä¼šå¸¦æ¥ä¸šåŠ¡é—´è€¦åˆã€‚ä¸ºäº†é™ä½è¿™ç§è€¦åˆåº¦ï¼Œæˆ‘ä»¬å¼•å…¥äº†AOPã€‚</li><li>å¦‚ä½•å®ç°AOPï¼Ÿ<br>Method Swizzlingæˆ–è€…protocolçš„æ–¹å¼æ¥å®ç°æ‹¦æˆªå™¨ï¼ˆbeforePerformã€afterPerformï¼‰</li></ul><p>ä½¿ç”¨AOPè€Œéç»§æ‰¿æ¥å®ç°å…¬æœ‰ç‰¹æ€§ã€‚æ¯”å¦‚æ¯ä¸ªViewControlleréƒ½æœ‰ä¸€ä¸ªé€šç”¨çš„navigationHeaderBar:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAObjectIntercepter</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    [YAObjectIntercepter sharedInstance];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> YAObjectIntercepter *sharedInstance;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        sharedInstance = [YAObjectIntercepter new];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> sharedInstance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="comment">// æ–¹æ³•æ‹¦æˆª</span></span><br><span class="line">        [<span class="built_in">UIViewController</span> aspect_hookSelector:<span class="keyword">@selector</span>(viewDidLoad) withOptions:AspectPositionBefore usingBlock:^(<span class="keyword">id</span> &lt;AspectInfo&gt; aspectInfo)&#123;</span><br><span class="line">            [<span class="keyword">self</span> viewDidLoadWithViewController:[aspectInfo instance]];</span><br><span class="line">        &#125; error:<span class="literal">NULL</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - fake methods</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoadWithViewController:(<span class="built_in">UIViewController</span> *)viewController &#123;</span><br><span class="line">    <span class="keyword">if</span> ([viewController isKindOfClass:<span class="built_in">UIViewController</span>.class] &amp;&amp; [<span class="built_in">NSStringFromClass</span>(viewController.class) hasPrefix:<span class="string">@"YA"</span>]) &#123;</span><br><span class="line">        viewController.view.backgroundColor = <span class="built_in">UIColor</span>.whiteColor;</span><br><span class="line">        viewController.navigationHeaderBar.backgroundColor = <span class="built_in">UIColor</span>.whiteColor;</span><br><span class="line">        [viewController.view addSubview:viewController.navigationHeaderBar];</span><br><span class="line">        viewController.navigationHeaderBar.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, kIPHONEX_TOP, kScreenWidth, kNavigationBarHeight);</span><br><span class="line">        [viewController.navigationHeaderBar.leftButton setBackgroundImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"feed_back"</span>] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">        [viewController.navigationHeaderBar.leftButton setBackgroundImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"feed_back"</span>] forState:<span class="built_in">UIControlStateHighlighted</span>];</span><br><span class="line">        [viewController.navigationHeaderBar.leftButton addTarget:viewController action:<span class="keyword">@selector</span>(popViewControllerWithAnimation) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="3ï¼Œç½‘ç»œå±‚è®¾è®¡"><a href="#3ï¼Œç½‘ç»œå±‚è®¾è®¡" class="headerlink" title="3ï¼Œç½‘ç»œå±‚è®¾è®¡"></a>3ï¼Œç½‘ç»œå±‚è®¾è®¡</h2><blockquote><p>1ï¼Œç½‘ç»œå±‚æ•°æ®é€šä¿¡ä»¥Delegateä¸ºä¸»ï¼ŒNotificationä¸ºè¾…ï¼ˆç½‘ç»œä¿¡å·ä»2Gå˜æˆ3Gå˜æˆ4Gå˜æˆWi-Fiï¼‰ã€‚<br>2ï¼Œæä¾›reformeræœºåˆ¶æ¥å¤„ç†ç½‘ç»œå±‚åé¦ˆçš„æ•°æ®ï¼Œäº¤ä»˜NSDictionaryç»™ä¸šåŠ¡å±‚ï¼Œä½¿ç”¨Constå­—ç¬¦ä¸²ä½œä¸ºKeyæ¥ä¿æŒå¯è¯»æ€§ã€‚<br>3ï¼Œç½‘ç»œå±‚ä¸Šéƒ¨åˆ†ä½¿ç”¨ç¦»æ•£å‹è®¾è®¡ï¼Œä¸‹éƒ¨åˆ†ä½¿ç”¨é›†çº¦å‹è®¾è®¡ã€‚è®¾è®¡åˆç†çš„ç»§æ‰¿æœºåˆ¶ï¼Œè®©æ´¾ç”Ÿå‡ºæ¥çš„APIManagerå—åˆ°é™åˆ¶ï¼Œé¿å…æ··ä¹±ã€‚<br>å…³äºé›†çº¦å‹çš„APIè°ƒç”¨å’Œç¦»æ•£å‹çš„APIè°ƒç”¨ï¼Œæˆ‘å€¾å‘äºè¿™æ ·ï¼šå¯¹å¤–æä¾›ä¸€ä¸ªBaseAPIManageræ¥ç»™ä¸šåŠ¡æ–¹åšæ´¾ç”Ÿï¼Œåœ¨BaseManageré‡Œé¢é‡‡ç”¨é›†çº¦åŒ–çš„æ‰‹æ®µç»„è£…è¯·æ±‚ï¼Œæ”¾é£è¯·æ±‚ï¼Œç„¶è€Œä¸šåŠ¡æ–¹è°ƒç”¨APIçš„æ—¶å€™ï¼Œåˆ™æ˜¯ä»¥ç¦»æ•£çš„APIè°ƒç”¨æ–¹å¼æ¥è°ƒç”¨ã€‚å¦‚æœä½ çš„Appåªæä¾›äº†é›†çº¦åŒ–çš„æ–¹å¼ï¼Œè€Œæ²¡æœ‰ç¦»æ•£æ–¹å¼çš„é€šé“ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ å†å°è£…ä¸€å±‚ï¼Œä¾¿äºä¸šåŠ¡æ–¹ä½¿ç”¨ç¦»æ•£çš„APIè°ƒç”¨æ–¹å¼æ¥æ”¾é£è¯·æ±‚ã€‚</p></blockquote><p>å¤§å‹Appå¯ä»¥ä½¿ç”¨å°è£…AFNçš„YTKNetworkï¼Œè€Œå°å‹Appç”±äºAPIå°‘ï¼Œå‚æ•°ä¸å¤æ‚ï¼Œå¾ˆå¤šå°±ç›´æ¥ä½¿ç”¨ä¸€ä¸ªç±»ï¼Œæš´éœ²Getå’ŒPostæ¥å£å°±å¯ä»¥äº†ã€‚</p><p><strong>ä¸‹å±‚ï¼šç»Ÿä¸€æ¥å£ï¼Œä»¥ç¦»æ•£å‹å°è£…AFNetworking</strong><br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> *YAServerInterfaceName;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¦–é¡µFeedæ¥å£</span></span><br><span class="line"><span class="keyword">extern</span> YAServerInterfaceName <span class="keyword">const</span> kYAServerInterfaceFeed;</span><br><span class="line"><span class="comment">// æœç´¢æ¥å£</span></span><br><span class="line"><span class="keyword">extern</span> YAServerInterfaceName <span class="keyword">const</span> kYAServerInterfaceSearch;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YANetworkManager</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)manager;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)requestWithInterfaceName:(YAServerInterfaceName)interfaceName</span><br><span class="line">                                        parameters:(<span class="built_in">NSDictionary</span> *)parameters</span><br><span class="line">                                          progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *))downloadProgress</span><br><span class="line">                                           success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="keyword">id</span>))success</span><br><span class="line">                                           failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="built_in">NSError</span> *))failure;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>æŠŠæ¥å£ä»¥åŠå…¬å…±å‚æ•°è¿›è¡Œå°è£…ï¼Œé¿å…æ•£è½ä¸€åœ°ã€‚ä½¿ç”¨æ—¶åªéœ€è¦ä¼ å…¥InterfaceNameå³å¯ã€‚æ¯ä¸ªä¸šåŠ¡éƒ½å¯ä»¥æœ‰è‡ªå·±çš„managerï¼ŒæˆåŠŸæˆ–è€…å¤±è´¥å›è°ƒä»¥blockçš„å½¢å¼å›ä¼ ï¼Œä¾›å„ä¸ªä¸šåŠ¡è‡ªå·±å‘æŒ¥ã€‚</p><p><strong>ä¸Šå±‚ï¼šç»Ÿä¸€APIManagerï¼Œä»¥é›†çº¦å‹çš„delegateè¿›è¡Œå›è°ƒ</strong><br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// API managerçš„åŸºç±»</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">YABaseAPIManager </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) BOOL noMoreData;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">fetchNetworkDataWithParameters</span><span class="selector-pseudo">:(NSDictionary</span> *)<span class="selector-tag">parameters</span>;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">cancelPreviousRequest</span>;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure></p><p>BaseAPIManagerè´Ÿè´£æ´¾ç”Ÿå„ä¸ªä¸šåŠ¡çš„APIManagerï¼Œæä¾›æ•°æ®è¯·æ±‚åŠå–æ¶ˆæ•°æ®è¯·æ±‚æ¥å£ã€‚BaseAPIManagerè¿˜çº¦å®šäº†å­ç±»éœ€è¦å®ç°çš„æ–¹æ³•ï¼šæˆåŠŸå›è°ƒã€å¤±è´¥å›è°ƒã€ä»¥åŠæ¥å£åç§°ã€‚å…·ä½“è¯·æ±‚çš„å‚æ•°æ€ä¹ˆé…ç½®ã€æˆåŠŸå›è°ƒæ€ä¹ˆå¤„ç†ã€å¤±è´¥å›è°ƒæ€ä¹ˆå¤„ç†éƒ½ç”±å­ç±»å†³å®šã€‚</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@protocol</span> YABaseAPIManagerChildProtocol &lt;NSObject&gt;</span><br><span class="line"><span class="variable">@required</span></span><br><span class="line">- (YAServerInterfaceName)interfaceName;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">APIManager</span><span class="selector-pseudo">:(YABaseAPIManager</span> *)<span class="selector-tag">manager</span> <span class="selector-tag">finishedWithFailedError</span><span class="selector-pseudo">:(NSError</span> *)<span class="selector-tag">error</span>;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">APIManager</span><span class="selector-pseudo">:(YABaseAPIManager</span> *)<span class="selector-tag">manager</span> <span class="selector-tag">finishedWithSuccessResult</span><span class="selector-pseudo">:(id)result</span>;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><h2 id="4ï¼Œä»MVCã€MVVMåˆ°å»ModelåŒ–"><a href="#4ï¼Œä»MVCã€MVVMåˆ°å»ModelåŒ–" class="headerlink" title="4ï¼Œä»MVCã€MVVMåˆ°å»ModelåŒ–"></a>4ï¼Œä»MVCã€MVVMåˆ°å»ModelåŒ–</h2><p><strong>MVC</strong><br>Måº”è¯¥åšçš„äº‹ï¼š<br>ç»™ViewControlleræä¾›æ•°æ®ï¼›<br>ç»™ViewControllerå­˜å‚¨æ•°æ®æä¾›æ¥å£ï¼›<br>æä¾›ç»è¿‡æŠ½è±¡çš„ä¸šåŠ¡åŸºæœ¬ç»„ä»¶ï¼Œä¾›Controllerè°ƒåº¦ï¼›</p><p>Cåº”è¯¥åšçš„äº‹ï¼š<br>ç®¡ç†View Containerçš„ç”Ÿå‘½å‘¨æœŸï¼›<br>è´Ÿè´£ç”Ÿæˆæ‰€æœ‰çš„Viewå®ä¾‹ï¼Œå¹¶æ”¾å…¥View Containerï¼›<br>ç›‘å¬æ¥è‡ªViewä¸ä¸šåŠ¡æœ‰å…³çš„äº‹ä»¶ï¼Œé€šè¿‡ä¸Modelçš„åˆä½œï¼Œæ¥å®Œæˆå¯¹åº”äº‹ä»¶çš„ä¸šåŠ¡ï¼›</p><p>Våº”è¯¥åšçš„äº‹ï¼š<br>å“åº”ä¸ä¸šåŠ¡æ— å…³çš„äº‹ä»¶ï¼Œå¹¶å› æ­¤å¼•å‘åŠ¨ç”»æ•ˆæœï¼Œç‚¹å‡»åé¦ˆï¼ˆå¦‚æœåˆé€‚çš„è¯ï¼Œå°½é‡è¿˜æ˜¯æ”¾åœ¨Viewå»åšï¼‰ç­‰ï¼›<br>ç•Œé¢å…ƒç´ è¡¨è¾¾</p><p><strong>MVVM</strong><br>åœ¨MVCçš„åŸºç¡€ä¸Šï¼ŒæŠŠCæ‹†å‡ºä¸€ä¸ªViewModelä¸“é—¨è´Ÿè´£æ•°æ®å¤„ç†çš„äº‹æƒ…ï¼Œå°±æ˜¯MVVMã€‚ç„¶åï¼Œä¸ºäº†è®©Viewå’ŒViewModelä¹‹é—´èƒ½å¤Ÿæœ‰æ¯”è¾ƒæ¾æ•£çš„ç»‘å®šå…³ç³»ï¼Œäºæ˜¯æˆ‘ä»¬ä½¿ç”¨ReactiveCocoaï¼Œå› ä¸ºè‹¹æœæœ¬èº«å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªæ¯”è¾ƒé€‚åˆè¿™ç§æƒ…å†µçš„ç»‘å®šæ–¹æ³•ã€‚iOSé¢†åŸŸé‡ŒKVOï¼ŒNotificationï¼Œblockï¼Œdelegateå’Œtarget-actionéƒ½å¯ä»¥ç”¨æ¥åšæ•°æ®é€šä¿¡ï¼Œä»è€Œæ¥å®ç°ç»‘å®šï¼Œä½†éƒ½ä¸å¦‚ReactiveCocoaæä¾›çš„RACSignalæ¥çš„ä¼˜é›…ï¼Œå¦‚æœä¸ç”¨ReactiveCocoaï¼Œç»‘å®šå…³ç³»å¯èƒ½å°±åšä¸åˆ°é‚£ä¹ˆæ¾æ•£é‚£ä¹ˆå¥½ï¼Œä½†å¹¶ä¸å½±å“å®ƒè¿˜æ˜¯MVVMã€‚</p><p><strong>å»ModelåŒ–</strong><br>ä¿ç•™åŸå§‹æ•°æ®ï¼Œå®šä¹‰reformåè®®ï¼Œéµå®ˆè¯¥åè®®çš„å¯¹è±¡æ¥å¤„ç†managerçš„åŸå§‹æ•°æ®ï¼Œå¤„ç†åçš„æ•°æ®ä¾ç„¶æ˜¯å­—å…¸æˆ–è€…æ•°ç»„ã€‚</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@protocol</span> YAFeedReformerProtocol &lt;NSObject&gt;</span><br><span class="line">- (NSArray *)<span class="attribute">reformData</span>:(id)data <span class="attribute">manager</span>:(YAFeedAPIManager *)manager;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>æ¯ç±»æ•°æ®å¯¹åº”ä¸€ä¸ªReformerï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kPropertyListDataKeyFeedID;             <span class="comment">///&lt; id</span></span><br><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kPropertyListDataKeyFeedThumbUrl;       <span class="comment">///&lt; æ‹‡æŒ‡å›¾url</span></span><br><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kPropertyListDataKeyFeedSmallUrl;       <span class="comment">///&lt; å°å›¾url</span></span><br><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kPropertyListDataKeyFeedRegularUrl;     <span class="comment">///&lt; å¸¸è§„å›¾url</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAFeedReformer</span> : <span class="title">NSObject</span> &lt;<span class="title">YAFeedReformerProtocol</span>&gt;</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>æ ¹æ®å­—å…¸çš„keyå¯ä»¥ç›´æ¥ä½¿ç”¨:<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setPhotoInfo:(<span class="built_in">NSDictionary</span> *)photoInfo &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (YASettingManager.columnCount &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">        url = [<span class="built_in">NSURL</span> URLWithString:photoInfo[kPropertyListDataKeyFeedRegularUrl]];</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="5ï¼Œç½‘ç»œä¼˜åŒ–"><a href="#5ï¼Œç½‘ç»œä¼˜åŒ–" class="headerlink" title="5ï¼Œç½‘ç»œä¼˜åŒ–"></a>5ï¼Œç½‘ç»œä¼˜åŒ–</h2><p><strong>é’ˆå¯¹é“¾æ¥å»ºç«‹ç¯èŠ‚çš„ä¼˜åŒ–</strong></p><ul><li>ä½¿ç”¨ç¼“å­˜æ‰‹æ®µå‡å°‘è¯·æ±‚çš„å‘èµ·æ¬¡æ•°ï¼ˆAPIåå­—å’Œå‚æ•°æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ç„¶åå–MD5ä½œä¸ºkeyï¼Œå­˜å‚¨å¯¹åº”è¿”å›çš„æ•°æ®ï¼‰</li><li>ä½¿ç”¨ç­–ç•¥æ¥å‡å°‘è¯·æ±‚çš„å‘èµ·æ¬¡æ•°ï¼ˆä¸‹æ‹‰åˆ·æ–°ã€æ¡ä»¶ç­›é€‰å–æ¶ˆåŸå…ˆå­˜åœ¨çš„è¯·æ±‚ï¼Œç”¨æˆ·æ—¥å¿—æ»¡è¶³ä¸€å®šæ•°é‡å†ä¸Šä¼ ï¼‰</li></ul><p><strong>é’ˆå¯¹DNSåŸŸåè§£æåšçš„ä¼˜åŒ–</strong><br>åŸå› ï¼šAPIè¯·æ±‚åœ¨DNSè§£æé˜¶æ®µçš„è€—æ—¶ä¼šå¾ˆå¤šï¼ˆç½‘ç»œä¿¡å·æºä¼šç»å¸¸å˜æ¢ã€è‡ªå·±çš„Appæ‰€åšçš„DNSç¼“å­˜ä¼šè¢«åˆ«çš„DNSç¼“å­˜ç»™æŒ¤å‡ºå»è¢«æ¸…ç†æ‰ã€å¢™ è¿™ä¸‰ä¸ªåŸå› é€ æˆé“¾è·¯çš„DNSç¼“å­˜å¾ˆå¿«å¤±æ•ˆç›¸å½“äºæ²¡æœ‰ï¼Œäºæ˜¯ç›´æ¥èµ°IPè¯·æ±‚ï¼Œç»•è¿‡DNSæœåŠ¡çš„è€—æ—¶ï¼‰<br>æ–¹æ¡ˆï¼šæœ¬åœ°æœ‰ä¸€ä»½IPåˆ—è¡¨ï¼Œè¿™äº›IPæ˜¯æ‰€æœ‰æä¾›APIçš„æœåŠ¡å™¨çš„IPï¼Œæ¯æ¬¡åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œé’ˆå¯¹è¿™ä¸ªåˆ—è¡¨é‡Œçš„æ‰€æœ‰IPå–pingå»¶æ—¶æ—¶é—´ï¼Œç„¶åå–å»¶æ—¶æ—¶é—´æœ€å°çš„é‚£ä¸ªIPä½œä¸ºä»Šåå‘èµ·è¯·æ±‚çš„IPåœ°å€ã€‚ä¸€èˆ¬éƒ½æ˜¯åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™è·å¾—æœ¬åœ°åˆ—è¡¨ä¸­æ‰€æœ‰IPçš„pingå€¼ï¼Œç„¶åé€šè¿‡NSURLProtocolçš„æ‰‹æ®µå°†URLä¸­çš„HOSTä¿®æ”¹ä¸ºæˆ‘ä»¬æ‰¾åˆ°çš„æœ€å¿«çš„IPã€‚å¦å¤–ï¼Œè¿™ä¸ªæœ¬åœ°IPåˆ—è¡¨ä¹Ÿä¼šéœ€è¦é€šè¿‡ä¸€ä¸ªAPIæ¥ç»´æŠ¤ï¼Œä¸€èˆ¬æ˜¯æ¯å¤©ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™è¯»ä¸€æ¬¡APIï¼Œç„¶åæ›´æ–°åˆ°æœ¬åœ°ã€‚</p><p><strong>é’ˆå¯¹é“¾æ¥ä¼ è¾“æ•°æ®é‡çš„ä¼˜åŒ–</strong><br>å‹ç¼©ã€‚</p><p><strong>é’ˆå¯¹é“¾æ¥å¤ç”¨çš„ä¼˜åŒ–</strong><br>HTTP/2.0ã€‚</p><p><strong>åˆ¤æ–­APIçš„è°ƒç”¨è¯·æ±‚æ˜¯æ¥è‡ªäºç»è¿‡æˆæƒçš„APPï¼Ÿ</strong><br>è®¾è®¡ç­¾å<br>æœåŠ¡ç«¯éœ€è¦ç»™ä½ ä¸€ä¸ªå¯†é’¥ï¼Œæ¯æ¬¡è°ƒç”¨APIæ—¶ï¼Œä½ ä½¿ç”¨è¿™ä¸ªå¯†é’¥å†åŠ ä¸ŠAPIåå­—å’ŒAPIè¯·æ±‚å‚æ•°ç®—ä¸€ä¸ªhashå‡ºæ¥ï¼Œç„¶åè¯·æ±‚çš„æ—¶å€™å¸¦ä¸Šè¿™ä¸ªhashã€‚æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ä¹‹åï¼ŒæŒ‰ç…§åŒæ ·çš„å¯†é’¥åŒæ ·çš„ç®—æ³•ä¹Ÿç®—ä¸€ä¸ªhashå‡ºæ¥ï¼Œç„¶åè·Ÿè¯·æ±‚å¸¦æ¥çš„hashåšä¸€ä¸ªæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºè¿™ä¸ªAPIçš„è°ƒç”¨è€…ç¡®å®æ˜¯ä½ çš„APPã€‚ä¸ºäº†ä¸è®©åˆ«äººä¹Ÿè·å–åˆ°è¿™ä¸ªå¯†é’¥ï¼Œä½ æœ€å¥½ä¸è¦æŠŠè¿™ä¸ªå¯†é’¥å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç›´æ¥å†™æ­»åœ¨ä»£ç é‡Œé¢å°±å¥½äº†ã€‚å¦å¤–é€‚å½“å¢åŠ ä¸€ä¸‹æ±‚Hashçš„ç®—æ³•çš„å¤æ‚åº¦ï¼Œé‚£å°±æ˜¯å„ç§Hashç®—æ³•ï¼ˆæ¯”å¦‚MD5ï¼‰åŠ ç‚¹ç›ï¼Œå†å›ç‚‰è·‘ä¸€æ¬¡Hashå•¥çš„ã€‚è¿™æ ·å°±èƒ½è§£å†³ç¬¬ä¸€ä¸ªç›®çš„äº†ï¼šç¡®ä¿ä½ çš„APIæ˜¯æ¥è‡ªäºä½ è‡ªå·±çš„Appã€‚</p><p>ç½‘ç»œä¼˜åŒ–åœ¨Splashä¸Šçš„å®è·µä¸»è¦æ˜¯<strong>ipç›´è¿</strong>ã€‚Casaå‰è¾ˆç»™å‡ºäº†NSEtcHostsï¼Œä½†æ˜¯å®ƒå¤„ç†NSURLConnectionï¼Œè¿‡æ—¶äº†ï¼Œæˆ‘å­¦ä¹ å€Ÿé‰´å†™äº†ä¸ªNSURLSessionç‰ˆæœ¬çš„ã€‚å½“ç„¶ï¼Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè‡ªå®šä¹‰NSURLProtocolã€‚å¢åŠ äº†ä¸€ç‚¹ç‚¹åŠŸèƒ½ï¼š</p><ul><li>æ”¯æŒHTTPS</li><li>ç›´è¿ipå¤±è´¥åè‡ªåŠ¨åˆ‡å›host</li><li>æ”¯æŒAFN</li></ul><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">YAHostsConfiguration</span></span></span><br><span class="line"><span class="comment">// é…ç½®hostä¸IPçš„æ˜ å°„</span></span><br><span class="line">- (<span class="keyword">void</span>)resolveHostName:(<span class="built_in">NSString</span> *)hostName</span><br><span class="line">           mapIPAddress:(<span class="built_in">NSString</span> *)IPAddress;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YADomainURLProtocol</span> : <span class="title">NSURLProtocol</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)configureHostsWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;YAHostsConfiguration&gt; configuration))block;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAHostsConfiguration</span> : <span class="title">NSObject</span> &lt;<span class="title">YAHostsConfiguration</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableIPAddressesByHostName;</span><br><span class="line">- (<span class="built_in">NSString</span> *)IPAddressForHostName:(<span class="built_in">NSString</span> *)hostName;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAHostsConfiguration</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _mutableIPAddressesByHostName = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)IPAddressForHostName:(<span class="built_in">NSString</span> *)hostName &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.mutableIPAddressesByHostName[hostName.lowercaseString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)resolveHostName:(<span class="built_in">NSString</span> *)hostName mapIPAddress:(<span class="built_in">NSString</span> *)IPAddress &#123;</span><br><span class="line">    <span class="keyword">self</span>.mutableIPAddressesByHostName[hostName.lowercaseString] = IPAddress;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kURLProtocolHostModifiedKey = <span class="string">@"kURLProtocolHostModifiedKey"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YADomainURLProtocol</span> () &lt;<span class="title">NSURLSessionTaskDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (atomic, <span class="keyword">strong</span>, <span class="keyword">readwrite</span>) <span class="built_in">NSURLSession</span> *session;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YADomainURLProtocol</span></span></span><br><span class="line">+ (YAHostsConfiguration *)sharedConfiguration &#123;</span><br><span class="line">    <span class="keyword">static</span> YAHostsConfiguration * sharedConfiguration = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        sharedConfiguration = [YAHostsConfiguration new];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sharedConfiguration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)configureHostsWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;YAHostsConfiguration&gt; configuration))block &#123;</span><br><span class="line">    <span class="keyword">if</span> (block) block([<span class="keyword">self</span> sharedConfiguration]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)canInitWithRequest:(<span class="built_in">NSURLRequest</span> *)request &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isHttp = [request.URL.scheme caseInsensitiveCompare:<span class="string">@"http"</span>] == <span class="built_in">NSOrderedSame</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> isHttps = [request.URL.scheme caseInsensitiveCompare:<span class="string">@"https"</span>] == <span class="built_in">NSOrderedSame</span>;</span><br><span class="line">    <span class="keyword">if</span> (isHttp || isHttps) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å¤„ç†è¿‡ä¸”æœ‰æ˜ å°„</span></span><br><span class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span> propertyForKey:kURLProtocolHostModifiedKey inRequest:request] &amp;&amp; [[<span class="keyword">self</span> sharedConfiguration] IPAddressForHostName:request.URL.host]) &#123;</span><br><span class="line">            YALog(<span class="string">@"å‘½ä¸­ipç›´è¿"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSURLRequest</span> *)canonicalRequestForRequest:(<span class="built_in">NSURLRequest</span> *)request &#123;</span><br><span class="line">    <span class="comment">// å®¹é”™</span></span><br><span class="line">    <span class="keyword">if</span> (request.URL.host.length == <span class="number">0</span>) <span class="keyword">return</span> request;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line">    <span class="built_in">NSURLComponents</span> *URLComponents = [<span class="built_in">NSURLComponents</span> componentsWithString:mutableRequest.URL.absoluteString];</span><br><span class="line">    URLComponents.scheme = <span class="string">@"https"</span>;</span><br><span class="line">    URLComponents.host = [[<span class="keyword">self</span> sharedConfiguration] IPAddressForHostName:URLComponents.host];</span><br><span class="line">    mutableRequest.URL = [URLComponents URL];</span><br><span class="line">    [<span class="keyword">self</span> setProperty:@(<span class="literal">YES</span>) forKey:kURLProtocolHostModifiedKey inRequest:mutableRequest];</span><br><span class="line">    <span class="comment">// è®¾ç½®åŸå…ˆçš„host</span></span><br><span class="line">    [mutableRequest setValue:request.URL.host forHTTPHeaderField:<span class="string">@"host"</span>];</span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startLoading &#123;</span><br><span class="line">    <span class="keyword">self</span>.session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> ephemeralSessionConfiguration] delegate:<span class="keyword">self</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> new]];</span><br><span class="line">    [[<span class="keyword">self</span>.session dataTaskWithRequest:<span class="keyword">self</span>.request] resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopLoading &#123;</span><br><span class="line">    [<span class="keyword">self</span>.session finishTasksAndInvalidate];</span><br><span class="line">    <span class="keyword">self</span>.session = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSURLSessionDataDelegate</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½å®Œæˆ: errorå›è°ƒ</span></span><br><span class="line">        [<span class="keyword">self</span>.client URLProtocol:<span class="keyword">self</span> didFailWithError:error];</span><br><span class="line">        <span class="comment">// å‡ºé”™: å–æ¶ˆipç›´è¿</span></span><br><span class="line">        <span class="built_in">NSString</span> *host = [<span class="keyword">self</span>.request valueForHTTPHeaderField:<span class="string">@"host"</span>];</span><br><span class="line">        [YADomainURLProtocol sharedConfiguration].mutableIPAddressesByHostName[host.lowercaseString] = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½å®Œæˆ: successå›è°ƒ</span></span><br><span class="line">        [<span class="keyword">self</span>.client URLProtocolDidFinishLoading:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span>))completionHandler &#123;</span><br><span class="line">    <span class="comment">// æ¥æ”¶responseå›è°ƒ</span></span><br><span class="line">    [<span class="keyword">self</span>.client URLProtocol:<span class="keyword">self</span> didReceiveResponse:response cacheStoragePolicy:<span class="built_in">NSURLCacheStorageNotAllowed</span>];</span><br><span class="line">    completionHandler(<span class="built_in">NSURLSessionResponseAllow</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data &#123;</span><br><span class="line">    <span class="comment">// æ¥æ”¶æ•°æ®å›è°ƒ</span></span><br><span class="line">    [<span class="keyword">self</span>.client URLProtocol:<span class="keyword">self</span> didLoadData:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - è¯ä¹¦</span></span><br><span class="line"><span class="comment">// https: è¯ä¹¦</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span>, <span class="built_in">NSURLCredential</span> *))completionHandler &#123;</span><br><span class="line">    <span class="keyword">if</span> (!challenge) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *host = [<span class="keyword">self</span>.request.allHTTPHeaderFields objectForKey:<span class="string">@"host"</span>];</span><br><span class="line">    <span class="keyword">if</span> (!host) host = <span class="keyword">self</span>.request.URL.host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>] &amp;&amp; [<span class="keyword">self</span> createServerTrust:challenge.protectionSpace.serverTrust forDomain:host]) &#123;</span><br><span class="line">        disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">        credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    completionHandler(disposition, credential);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè¯ä¹¦æ ¡éªŒç­–ç•¥</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)createServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">if</span> (domain) &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»‘å®šæ ¡éªŒç­–ç•¥åˆ°æœåŠ¡ç«¯çš„è¯ä¹¦ä¸Š</span></span><br><span class="line">    SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line">    <span class="built_in">CFErrorRef</span> error;</span><br><span class="line">    SecTrustEvaluate(serverTrust, &amp;result);</span><br><span class="line">    <span class="keyword">return</span> (result == kSecTrustResultUnspecified || result == kSecTrustResultProceed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>åªéœ€è¦è¿™ä¹ˆä½¿ç”¨ï¼š<br><figure class="highlight scheme"><table><tr><td class="code"><pre><span class="line">[<span class="name">NSURLProtocol</span> registerClass:YADomainURLProtocol.class]<span class="comment">;</span></span><br><span class="line">[<span class="name">YADomainURLProtocol</span> configureHostsWithBlock:^(<span class="name">id&lt;YAHostsConfiguration&gt;</span> configuration) &#123;</span><br><span class="line">    [<span class="name">configuration</span> resolveHostName:@<span class="string">"www.baidu.com"</span> mapIPAddress:@<span class="string">"220.181.38.150"</span>]<span class="comment">;</span></span><br><span class="line">&#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>å¯¹äºAFNï¼Œé…ç½®configurationå³å¯<br><figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line">NSURLSessionConfiguration *configuration = <span class="comment">[NSURLSessionConfiguration defaultSessionConfiguration]</span>;</span><br><span class="line">configuration.protocolClasses = @<span class="comment">[YADomainURLProtocol.class]</span>;</span><br><span class="line">AFHTTPSessionManager *sessionManager = <span class="comment">[<span class="comment">[AFHTTPSessionManager alloc]</span> initWithSessionConfiguration:configuration]</span>;</span><br></pre></td></tr></table></figure></p><h2 id="6ï¼ŒæŒä¹…åŒ–"><a href="#6ï¼ŒæŒä¹…åŒ–" class="headerlink" title="6ï¼ŒæŒä¹…åŒ–"></a>6ï¼ŒæŒä¹…åŒ–</h2><p><strong>æŒä¹…åŒ–æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</strong></p><ul><li>NSUserDefaultï¼š å°è§„æ¨¡æ•°æ®ï¼Œå¼±ä¸šåŠ¡ç›¸å…³æ•°æ®ï¼Œéƒ½å¯ä»¥æ”¾åˆ°NSUserDefaulté‡Œé¢ï¼Œå†…å®¹æ¯”è¾ƒå¤šçš„æ•°æ®ï¼Œå¼ºä¸šåŠ¡ç›¸å…³çš„æ•°æ®å°±ä¸å¤ªé€‚åˆNSUserDefaultäº†ã€‚</li><li>Keychain ï¼š Keychainæ˜¯è‹¹æœæä¾›çš„å¸¦æœ‰å¯é€†åŠ å¯†çš„å­˜å‚¨æœºåˆ¶ï¼Œæ™®éç”¨åœ¨å„ç§å­˜å¯†ç çš„éœ€æ±‚ä¸Šã€‚å¦å¤–ï¼Œç”±äºAppå¸è½½åªè¦ç³»ç»Ÿä¸é‡è£…ï¼ŒKeychainä¸­çš„æ•°æ®ä¾æ—§èƒ½å¤Ÿå¾—åˆ°ä¿ç•™ï¼Œä»¥åŠå¯è¢«iCloudåŒæ­¥çš„ç‰¹æ€§ï¼Œå¤§å®¶éƒ½ä¼šåœ¨è¿™é‡Œå­˜å‚¨ç”¨æˆ·å”¯ä¸€æ ‡è¯†ä¸²ã€‚æ‰€ä»¥æœ‰éœ€è¦åŠ å¯†ã€éœ€è¦å­˜iCloudçš„æ•æ„Ÿå°æ•°æ®ï¼Œä¸€èˆ¬éƒ½ä¼šæ”¾åœ¨Keychainã€‚</li><li>æ–‡ä»¶å­˜å‚¨ï¼šæ–‡ä»¶å­˜å‚¨åŒ…æ‹¬äº†Plistã€archiveã€Streamç­‰æ–¹å¼ï¼Œä¸€èˆ¬ç»“æ„åŒ–çš„æ•°æ®æˆ–è€…éœ€è¦æ–¹ä¾¿æŸ¥è¯¢çš„æ•°æ®ï¼Œéƒ½ä¼šä»¥Plistçš„æ–¹å¼å»æŒä¹…åŒ–ã€‚Archiveæ–¹å¼é€‚åˆå­˜å‚¨å¹³æ—¶ä¸å¤ªç»å¸¸ä½¿ç”¨ä½†å¾ˆå¤§é‡çš„æ•°æ®ï¼Œæˆ–è€…è¯»å–ä¹‹åå¸Œæœ›ç›´æ¥å¯¹è±¡åŒ–çš„æ•°æ®ï¼Œå› ä¸ºArchiveä¼šå°†å¯¹è±¡åŠå…¶å¯¹è±¡å…³ç³»åºåˆ—åŒ–ï¼Œä»¥è‡³äºè¯»å–æ•°æ®çš„æ—¶å€™éœ€è¦Decodeå¾ˆèŠ±æ—¶é—´ï¼ŒDecodeçš„è¿‡ç¨‹å¯ä»¥æ˜¯è§£å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡åŒ–ï¼Œè¿™ä¸ªå¯ä»¥æ ¹æ®å…·ä½“<nscoding>ä¸­çš„å®ç°æ¥å†³å®šã€‚Streamå°±æ˜¯ä¸€èˆ¬çš„æ–‡ä»¶å­˜å‚¨äº†ï¼Œä¸€èˆ¬ç”¨æ¥å­˜å­˜å›¾ç‰‡å•Šå•¥çš„ï¼Œé€‚ç”¨äºæ¯”è¾ƒç»å¸¸ä½¿ç”¨ï¼Œç„¶è€Œæ•°æ®é‡åˆä¸ç®—éå¸¸å¤§çš„é‚£ç§ã€‚</nscoding></li><li>æ•°æ®åº“å­˜å‚¨ï¼šè‹¹æœè‡ªå¸¦äº†ä¸€ä¸ªCore Dataï¼Œå…¶ä»–è¿˜æœ‰FMDBã€‚æ•°æ®åº“æ–¹æ¡ˆä¸»è¦æ˜¯ä¸ºäº†ä¾¿äºå¢åˆ æ”¹æŸ¥ï¼Œå½“æ•°æ®æœ‰çŠ¶æ€å’Œç±»åˆ«çš„æ—¶å€™æœ€å¥½è¿˜æ˜¯é‡‡ç”¨æ•°æ®åº“æ–¹æ¡ˆæ¯”è¾ƒå¥½ã€‚å› ä¸ºä½ ä¸å¯èƒ½é€šè¿‡æ–‡ä»¶ç³»ç»Ÿéå†æ–‡ä»¶å»ç”„åˆ«ä½ éœ€è¦è·å–çš„å±äºæŸä¸ªçŠ¶æ€æˆ–ç±»åˆ«çš„æ•°æ®ï¼Œè¿™ä¹ˆåšæˆæœ¬å°±å¤ªå¤§äº†ã€‚å½“ç„¶ï¼Œç‰¹åˆ«å¤§é‡çš„æ•°æ®ä¹Ÿä¸é€‚åˆç›´æ¥å­˜å‚¨æ•°æ®åº“ï¼Œæ¯”å¦‚å›¾ç‰‡æˆ–è€…æ–‡ç« è¿™æ ·çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œéƒ½æ˜¯æ•°æ®åº“å­˜ä¸€ä¸ªæ–‡ä»¶åï¼Œç„¶åè¿™ä¸ªæ–‡ä»¶åæŒ‡å‘çš„æ˜¯æŸä¸ªå›¾ç‰‡æˆ–è€…æ–‡ç« çš„æ–‡ä»¶ã€‚å¦‚æœçœŸçš„è¦åšå…¨æ–‡ç´¢å¼•è¿™ç§éœ€æ±‚ï¼Œå»ºè®®æœ€å¥½è¿˜æ˜¯æŒ‚ä¸ªAPIä¸¢åˆ°æœåŠ¡ç«¯å»åšã€‚</li></ul><p>ä¸Šé¢æ˜¯å‰è¾ˆæ€»ç»“çš„é¢è¯•é¢˜ç­”æ¡ˆğŸ˜‚</p><p>æ¥ä¸‹æ¥æ˜¯æŒä¹…åŒ–çš„å®è·µï¼š<br>ä¸ä»¥å¾€ä¸åŒçš„æ˜¯ï¼Œä¹‹å‰é‡‡ç”¨MVCæˆ–è€…MVVMæ¨¡å¼ï¼Œå­˜åœ¨æ•°æ®åº“çš„æ˜¯Modelï¼Œè€Œç°åœ¨å»ModelåŒ–äº†ï¼Œå­˜åŸå§‹æ•°æ®å‘¢ï¼Œè¿˜æ˜¯å­˜Reformä¹‹åçš„æ•°æ®ã€‚æˆ‘é€‰æ‹©å­˜å‚¨åŸå§‹æ•°æ®ï¼ŒåŸå› æœ‰äºŒï¼š<br>1ï¼ŒReformeræœ‰å¤šä¸ªï¼Œä½†æ˜¯åŸå§‹æ•°æ®åªæœ‰ä¸€ä»½ï¼Œåªå­˜å‚¨ä¸€ä»½åŸå§‹æ•°æ®é¿å…å†—ä½™ã€‚<br>2ï¼Œå¦‚æœå­˜å‚¨åŸå§‹æ•°æ®ï¼Œé‚£ä»æ•°æ®åº“å–å‡ºçš„æ•°æ®å’Œä»ç½‘ç»œè·å–çš„æ•°æ®ï¼Œæ ¼å¼å°†ä¼šæ˜¯ä¸€æ ·çš„ï¼Œåªéœ€è¦ä¸€ç§å¤„ç†æ–¹å¼ã€‚</p><p>æ€ä¹ˆå­˜å‚¨ï¼Ÿæ¯æ¡photoä¿¡æ¯ä¸­çš„photo_idä½œä¸ºä¸»é”®ï¼Œå†åŠ ä¸Šæ—¶é—´æˆ³ç”¨äºç­›é€‰ï¼Œphoto_contentè‡ªç„¶å°±æ˜¯å­˜å‚¨çš„åŸå§‹ä¿¡æ¯äº†ï¼š<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">"t_photoList"</span> (</span><br><span class="line"><span class="string">"photo_id"</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">"photo_content"</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">"photo_date"</span> <span class="built_in">INTEGER</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span>(<span class="string">"photo_id"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·èŒè´£æ›´æ¸…æ™°äº†ï¼šAPIManagerè´Ÿè´£ä»ç½‘ç»œæˆ–è€…æ•°æ®åº“å–æ•°æ®ä»¥åŠæŒä¹…åŒ–æ•°æ®ï¼ŒReformeråªè´Ÿè´£æ ¼å¼åŒ–APIManagerçš„æ•°æ®ã€‚å¯¹äºæ§åˆ¶å™¨æ¥è¯´ï¼Œå®ƒåšçš„ä¹Ÿå¾ˆç®€å•äº†ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)feedAPIDidSuccessWithManager:(YAFeedAPIManager *)manager</span><br><span class="line">                           isNewData:(<span class="built_in">BOOL</span>)isNewData &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> &lt;<span class="built_in">NSDictionary</span> *&gt; *array = [manager fetchDataWithReformer:<span class="keyword">self</span>.feedReformer];</span><br><span class="line">    <span class="keyword">if</span> (isNewData) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.photoArray removeAllObjects];</span><br><span class="line">        [<span class="keyword">self</span>.refreshHeader endRefreshing];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span>.photoArray addObjectsFromArray:array];</span><br><span class="line">    <span class="keyword">if</span> (manager.noMoreData) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰æ›´å¤šæ•°æ®</span></span><br><span class="line">        [<span class="keyword">self</span>.refreshFooter endRefreshingWithNoMoreData];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.refreshFooter endRefreshing];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span>.feedCollectionView reloadData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="7ï¼ŒåŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ"><a href="#7ï¼ŒåŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="7ï¼ŒåŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ"></a>7ï¼ŒåŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ</h2><p>ï¼ˆ1ï¼‰Web App<br>å…¶å®æ‰€è°“çš„web appï¼Œå°±æ˜¯é€šè¿‡æ‰‹æœºä¸Šçš„æµè§ˆå™¨è¿›è¡Œè®¿é—®çš„H5é¡µé¢ã€‚è¿™ä¸ªH5é¡µé¢æ˜¯é’ˆå¯¹ç§»åŠ¨åœºæ™¯ç‰¹åˆ«ä¼˜åŒ–çš„ï¼Œæ¯”å¦‚UIäº¤äº’ç­‰ã€‚</p><ul><li>ä¼˜ç‚¹<br>æ— éœ€èµ°è‹¹æœæµç¨‹ï¼Œæ‰€æœ‰è‹¹æœæµç¨‹å¸¦æ¥çš„æˆæœ¬éƒ½èƒ½é¿å…ï¼ŒåŒ…æ‹¬å®¡æ ¸å‘¨æœŸã€è¯ä¹¦æˆæœ¬ç­‰ã€‚<br>ç‰ˆæœ¬æ›´æ–°è·Ÿç½‘é¡µä¸€æ ·ï¼Œéšæ—¶ç”Ÿæ•ˆã€‚<br>ä¸éœ€è¦Native Appå·¥ç¨‹å¸ˆçš„å‚ä¸ï¼Œè€Œä¸”å¸‚é¢ä¸Šå·²ç»æœ‰å¾ˆå¤šé’ˆå¯¹è¿™ç§åœºæ™¯çš„æ¡†æ¶ã€‚</li><li>ç¼ºç‚¹<br>é‡åº¦ä¾èµ–ç½‘ç»œç¯å¢ƒã€æµç•…åº¦ä¸å¦‚Nativeã€å¾ˆéš¾åšå¥½æœ¬åœ°æŒä¹…åŒ–ï¼ˆåªèƒ½æä¾›è´¦æˆ·ä½“ç³»ï¼Œå¯¹åº”è´¦æˆ·çš„æŒä¹…åŒ–æ•°æ®å…¨éƒ¨å­˜åœ¨æœåŠ¡ç«¯ï¼‰ã€å³æ—¶å“åº”æ–¹æ¡ˆã€è¿œç¨‹é€šçŸ¥å®ç°æ–¹æ¡ˆã€ç§»åŠ¨ç«¯ä¼ æ„Ÿå™¨çš„ä½¿ç”¨æ–¹æ¡ˆå¤æ‚ï¼Œç»´æŠ¤éš¾åº¦å¤§ã€‚<br>å®‰å…¨é—®é¢˜ï¼ŒH5é¡µé¢ç­‰äºæ˜¯æ‰€æœ‰ä¸œè¥¿éƒ½æš´éœ²ç»™äº†ç”¨æˆ·ï¼Œå¦‚æœå¯¹å®‰å…¨è¦æ±‚æ¯”è¾ƒé«˜çš„ï¼Œå¾ˆå¤šé¢å¤–çš„å®‰å…¨æœºåˆ¶éƒ½éœ€è¦åœ¨æœåŠ¡ç«¯å®ç°ã€‚</li><li>æ€»ç»“<br>web appä¸€èˆ¬æ˜¯åˆ›ä¸šåˆæœŸä¼šé‡ç‚¹è€ƒè™‘çš„æ–¹æ¡ˆï¼Œå› ä¸ºè¿­ä»£éå¸¸å¿«ï¼Œè€Œä¸”åˆ›ä¸šåˆæœŸçš„ä¸»è¦ç›®æ ‡æ˜¯éœ€è¦éªŒè¯æ¨¡å¼çš„æ­£ç¡®æ€§ï¼Œå¹¶ä¸åœ¨äºæä¾›éå¸¸å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œåªéœ€è¦å®Œæˆé—­ç¯å³å¯ã€‚</li></ul><p>ï¼ˆ2ï¼‰Hybrid App<br>é€šè¿‡å¸‚é¢ä¸Šå„ç§Hybridæ¡†æ¶ï¼Œæ¥åšH5å’ŒNativeçš„æ··åˆåº”ç”¨ï¼Œæˆ–è€…é€šè¿‡JS Bridgeæ¥åšåˆ°H5å’ŒNativeä¹‹é—´çš„æ•°æ®äº’é€šã€‚</p><ul><li>ä¼˜ç‚¹<br>é™¤äº†è¦æ‰¿æ‹…è‹¹æœæµç¨‹å¯¼è‡´çš„æˆæœ¬ä»¥å¤–ï¼Œå…·å¤‡æ‰€æœ‰web appçš„ä¼˜åŠ¿ã€èƒ½å¤Ÿè®¿é—®æœ¬åœ°æ•°æ®ã€è®¾å¤‡ä¼ æ„Ÿå™¨ç­‰</li><li>ç¼ºç‚¹<br>è·Ÿweb appä¸€æ ·å­˜åœ¨è¿‡åº¦ä¾èµ–ç½‘ç»œç¯å¢ƒçš„é—®é¢˜ã€ç”¨æˆ·ä½“éªŒä¹Ÿå¾ˆéš¾åšåˆ°å¾ˆå¥½ã€å®‰å…¨æ€§é—®é¢˜ä¾æ—§å­˜åœ¨ã€å¤§è§„æ¨¡çš„æ•°æ®äº¤äº’å¾ˆéš¾å®ç°ï¼Œä¾‹å¦‚å›¾ç‰‡åœ¨æœ¬åœ°å¤„ç†åï¼Œå°†å›¾ç‰‡ä¼ é€’ç»™H5</li><li>æ€»ç»“<br>Hybridæ–¹æ¡ˆæ›´åŠ é€‚åˆè·Ÿæœ¬åœ°èµ„æºäº¤äº’ä¸æ˜¯å¾ˆå¤šï¼Œç„¶åä¸»è¦ä»¥å†…å®¹å±•ç¤ºä¸ºä¸»çš„Appã€‚åœ¨å¤©çŒ«Appä¸­ï¼Œå¤§é‡åœ°é‡‡ç”¨äº†JS Bridgeçš„æ–¹å¼æ¥è®©H5è·ŸNativeåšäº¤äº’ï¼Œå› ä¸ºå¤©çŒ«Appæ˜¯ä¸€ä¸ªä»¥å†…å®¹å±•ç¤ºä¸ºä¸»çš„Appï¼Œä¸”è¥é”€æ´»åŠ¨å¤šï¼Œå‘¨æœŸçŸ­ï¼Œæ¯”è¾ƒé€‚åˆHybridã€‚</li></ul><p>ï¼ˆ3ï¼‰React-Native</p><ul><li>ä¼˜ç‚¹<br>å“åº”é€Ÿåº¦å¾ˆå¿«ï¼Œåªæ¯”Nativeæ…¢ä¸€ç‚¹ï¼Œæ¯”webviewå¿«å¾ˆå¤šã€‚<br>èƒ½å¤Ÿåšåˆ°ä¸€å®šç¨‹åº¦ä¸Šçš„åŠ¨æ€éƒ¨ç½²</li><li>ç¼ºç‚¹<br>ç»„è£…é¡µé¢çš„å…ƒç´ éœ€è¦Nativeæä¾›æ”¯æŒï¼Œä¸€å®šç¨‹åº¦ä¸Šé™åˆ¶äº†åŠ¨æ€éƒ¨ç½²çš„çµæ´»æ€§ã€‚</li><li>æ€»ç»“<br>ç”±äºViewçš„å±•ç¤ºå’ŒViewçš„äº‹ä»¶å“åº”åˆ†å±äºä¸åŒçš„ç«¯ï¼Œå±•ç¤ºéƒ¨åˆ†çš„æè¿°åœ¨JSç«¯ï¼Œå“åº”äº‹ä»¶çš„ç›‘å¬å’Œæè¿°éƒ½åœ¨Nativeç«¯ï¼Œé€šè¿‡Nativeè½¬å‘ç»™JSç«¯ã€‚æ‰€ä»¥ï¼Œä»åšåŠ¨æ€éƒ¨ç½²çš„è§’åº¦ä¸Šè®²ï¼ŒReact-Nativeåªèƒ½åŠ¨æ€éƒ¨ç½²æ–°Viewï¼Œä¸èƒ½åŠ¨æ€éƒ¨ç½²æ–°Viewå¯¹åº”çš„äº‹ä»¶ã€‚<br>Viewçš„åŸå‹éœ€è¦ä»Nativeä¸­å–ï¼Œä»¥åæŸä¸ªé¡µé¢éœ€è¦æ·»åŠ æŸä¸ªå¤æ‚çš„viewçš„æ—¶å€™ï¼Œéœ€è¦ä»ç°æœ‰çš„ç»„ä»¶ä¸­æ‹¼è£…ã€‚<br>å®ƒè§£å†³çš„æ˜¯å¦‚ä½•ä¸ä½¿ç”¨Objc/Swiftæ¥å†™iOS Appçš„Viewçš„é—®é¢˜ï¼Œå¯¹äºå¦‚ä½•é€šè¿‡ä¸å‘ç‰ˆæ¥ç»™å·²å‘ç‰ˆçš„Appæ›´æ–°åŠŸèƒ½è¿™æ ·çš„é—®é¢˜ï¼Œå¸®åŠ©æœ‰é™ã€‚</li></ul><p>ï¼ˆ4ï¼‰Lua Patch<br>waxPatchçš„ä¸»è¦åŸç†æ˜¯é€šè¿‡luaæ¥é’ˆå¯¹objcçš„æ–¹æ³•è¿›è¡Œæ›¿æ¢ï¼Œç”±äºluaæœ¬èº«æ˜¯è§£é‡Šå‹è¯­è¨€ï¼Œå¯ä»¥é€šè¿‡åŠ¨æ€ä¸‹è½½å¾—åˆ°ï¼Œå› æ­¤å…·å¤‡äº†ä¸€å®šçš„åŠ¨æ€éƒ¨ç½²èƒ½åŠ›ã€‚ç„¶è€ŒiOSç³»ç»ŸåŸç”Ÿå¹¶ä¸æä¾›luaçš„è§£é‡Šåº“ï¼Œæ‰€ä»¥éœ€è¦åœ¨æ‰“åŒ…æ—¶æŠŠluaçš„è§£é‡Šåº“ç¼–è¯‘è¿›appã€‚</p><ul><li>ä¼˜ç‚¹<br>èƒ½å¤Ÿé€šè¿‡ä¸‹è½½è„šæœ¬æ›¿æ¢æ–¹æ³•çš„æ–¹å¼ï¼Œä¿®æ”¹æœ¬åœ°Appçš„è¡Œä¸ºã€‚<br>æ‰§è¡Œæ•ˆç‡è¾ƒé«˜</li><li>ç¼ºç‚¹<br>å¯¹äºæ›¿æ¢åŠŸèƒ½æ¥è¯´ï¼Œluaæ˜¯å¾ˆä¸é”™çš„é€‰æ‹©ã€‚ä½†å¦‚æœè¦æ·»åŠ æ–°å†…å®¹ï¼Œå®é™…æ“ä½œä¼šå¾ˆå¤æ‚ï¼Œå¾ˆå®¹æ˜“æ”¹é”™ï¼Œå°é—®é¢˜å˜æˆå¤§é—®é¢˜</li><li>æ€»ç»“<br>luaçš„è§£å†³æ–¹æ¡ˆåœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†åŠ¨æ€éƒ¨ç½²çš„é—®é¢˜ã€‚å®é™…æ“ä½œæ—¶ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨å®ƒæ¥åšæ–°åŠŸèƒ½çš„åŠ¨æ€éƒ¨ç½²ï¼Œä¸»è¦è¿˜æ˜¯ç”¨äºä¿®å¤bugæ—¶ä»£ç çš„åŠ¨æ€éƒ¨ç½²ã€‚</li></ul><p>ï¼ˆ5ï¼‰Javascript Patch<br>è¿™ä¸ªå·¥ä½œåŸç†å…¶å®è·Ÿä¸Šé¢è¯´çš„luaé‚£å¥—æ–¹æ¡ˆçš„å·¥ä½œåŸç†ä¸€æ ·ï¼Œåªä¸è¿‡æ˜¯ç”¨javascriptå®ç°ã€‚</p><ul><li>ä¼˜ç‚¹<br>æ‰“åŒ…æ—¶ä¸ç”¨å°†è§£é‡Šå™¨ä¹Ÿç¼–è¯‘è¿›å»ï¼ŒiOSè‡ªå¸¦JavaScriptçš„è§£é‡Šå™¨ã€‚</li><li>ç¼ºç‚¹<br>åŒLuaæ–¹æ¡ˆçš„ç¼ºç‚¹</li><li>æ€»ç»“<br>åœ¨å¯¹appæ‰“è¡¥ä¸çš„æ–¹æ¡ˆä¸­ï¼Œç›®å‰æˆ‘æ›´å€¾å‘äºä½¿ç”¨JSPatchçš„æ–¹æ¡ˆï¼Œåœ¨èƒ½å¤Ÿå®ŒæˆLuaåšåˆ°çš„æ‰€æœ‰äº‹æƒ…çš„åŒæ—¶ï¼Œè¿˜ä¸ç”¨ç¼–ä¸€ä¸ªJSè§£é‡Šå™¨è¿›å»ï¼Œè€Œä¸”ä¼šjavascriptçš„äººæ¯”ä¼šluaçš„äººå¤šï¼ŒæŠ€æœ¯å‚¨å¤‡æ¯”è¾ƒå¥½åšã€‚</li></ul><p>ï¼ˆ6ï¼‰JSON Descripted View<br>ä½¿ç”¨JSONæ¥æè¿°ä¸€ä¸ªViewåº”è¯¥æœ‰å“ªäº›å…ƒç´ ï¼Œä»¥åŠå…ƒç´ çš„ä½ç½®ï¼Œä»¥åŠç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚èƒŒæ™¯è‰²ï¼Œåœ†è§’ç­‰ç­‰ã€‚ç„¶åæœ¬åœ°æœ‰ä¸€ä¸ªè§£é‡Šå™¨æ¥æŠŠJSONæè¿°çš„Viewç”Ÿæˆå‡ºæ¥ã€‚<br>è¿™è·ŸReact-Nativeæœ‰ç‚¹å„¿åƒï¼Œä¸€ä¸ªæ˜¯JSè½¬Nativeï¼Œä¸€ä¸ªæ˜¯JSONè½¬Nativeã€‚ä½†æ˜¯åŒæ ·æœ‰çš„é—®é¢˜å°±æ˜¯äº‹ä»¶å¤„ç†çš„é—®é¢˜ï¼Œåœ¨äº‹ä»¶å¤„ç†ä¸Šï¼ŒReact-Nativeåšå¾—ç›¸å¯¹æ›´å¥½ã€‚å› ä¸ºJSONä¸èƒ½å¤Ÿæè¿°äº‹ä»¶é€»è¾‘ï¼Œæ‰€ä»¥JSONç”Ÿæˆçš„Viewæ‰€éœ€è¦çš„äº‹ä»¶å¤„ç†éƒ½å¿…é¡»è¦æœ¬åœ°äº‹å…ˆæŒ‚å¥½ã€‚</p><ul><li>ä¼˜ç‚¹<br>èƒ½å¤Ÿè‡ªç”±ç”ŸæˆViewå¹¶åŠ¨æ€éƒ¨ç½²</li><li>ç¼ºç‚¹<br>å¤©çŒ«å®é™…ä½¿ç”¨ä¸‹æ¥ï¼Œå‘ç°è¿˜æ˜¯å­˜åœ¨ä¸€å®šçš„æ€§èƒ½é—®é¢˜ï¼Œä¸å¤Ÿå¿«<br>äº‹ä»¶éœ€è¦æœ¬åœ°äº‹å…ˆå†™å¥½ï¼Œæ— æ³•åŠ¨æ€éƒ¨ç½²äº‹ä»¶</li><li>æ€»ç»“<br>å…¶å®JSONæè¿°çš„Viewæ¯”React-Nativeçš„Viewæœ‰ä¸ªå¥½å¤„å°±åœ¨äºå¯¹äºè¿™ä¸ªViewè€Œè¨€ï¼Œä¸éœ€è¦æœ¬åœ°ä¹Ÿæœ‰ä¸€å¥—å¯¹åº”çš„Viewï¼Œå®ƒå¯ä»¥ä¾æ®JSONçš„æè¿°æ¥è‡ªå·±ç”Ÿæˆã€‚ç„¶è€Œå¯¹äºäº‹ä»¶çš„å¤„ç†æ˜¯å®ƒçš„ç¡¬ä¼¤ï¼Œæ‰€ä»¥JSONæè¿°Viewçš„æ–¹æ¡ˆï¼Œä¸€èˆ¬æ¯”è¾ƒé€‚ç”¨äºæ¢è‚¤ï¼Œæˆ–è€…å›ºå®šäº‹ä»¶ä¸åŒæ ·å¼çš„Viewï¼Œæ¯”å¦‚è´´çº¸ã€‚</li></ul><p>ä½œè€…æ€»ç»“åœ°å®åœ¨æ˜¯å¤ªå…¨é¢å¤ªå¥½äº†ï¼ˆå´‡æ‹œè„¸ğŸ˜ï¼‰ã€‚<br>ç›®å‰æ¥çœ‹ï¼Œä½¿ç”¨æ¯”è¾ƒå¹¿æ³›çš„æ˜¯JS Patchã€‚æ‰‹ç™¾å‚è€ƒäº†ä¸€ä¸‹å®ƒçš„åŸç†ï¼Œè‡ªå·±åˆå†™äº†ä¸€ä¸ªï¼Œç”¨äºçƒ­ä¿®å¤ï¼Œä¹‹å‰è€æ¿è®©è°ƒç ”è¿‡ï¼Œæœ€è¿‘ç”¨äº†å‡ æ¬¡ã€‚</p><p>åœ¨Splashä¸­ç›®å‰è¿˜æ²¡æœ‰å®è·µçƒ­æ›´æ–°æ–¹æ¡ˆã€‚</p><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>1.0.0ç‰ˆæœ¬å·²ç»å‘å¸ƒäº†ï¼Œä½†æ˜¯æœ€è¿‘å¼€å‘äººå‘˜æ³¨å†Œå¥½åƒå‡ºäº†ç‚¹é—®é¢˜ï¼Œä»˜æ¬¾è€æ˜¯å¤±è´¥ï¼Œç„¶åå°±æ²¡ä¸Šçº¿ã€‚</p><p>githubæ”¾è¿™äº†ï¼š<a href="https://github.com/chenYalun/Splash" target="_blank" rel="noopener">https://github.com/chenYalun/Splash</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å®è·µä¸€äº›æƒ³æ³•ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="å¼€æºé¡¹ç›®" scheme="http://blog.chenyalun.com/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹ä¸Runloopæ‹¾é—</title>
    <link href="http://blog.chenyalun.com/2019/09/30/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8ERunloop%E6%8B%BE%E9%81%97/"/>
    <id>http://blog.chenyalun.com/2019/09/30/å¤šçº¿ç¨‹ä¸Runloopæ‹¾é—/</id>
    <published>2019-09-30T10:36:38.000Z</published>
    <updated>2019-12-09T08:15:11.430Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> å›é¡¾äº†å¤šçº¿ç¨‹ã€Runloopç›¸å…³çš„é‡ç‚¹çŸ¥è¯†ã€‚ </p><a id="more"></a><p>æ¯”è¾ƒé›¶ç¢ã€‚</p><h1 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h1><h2 id="åŸºæœ¬"><a href="#åŸºæœ¬" class="headerlink" title="åŸºæœ¬"></a>åŸºæœ¬</h2><p>é¦–å…ˆç®€å•å›é¡¾å‡ ä¸ªå¸¸è§çš„æœ¯è¯­ï¼š<br>åŒæ­¥ï¼šåªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚åœ¨é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡å®Œæˆä¹‹å‰ä¼šä¸€ç›´ç­‰å¾…ã€‚<br>å¼‚æ­¥ï¼šå¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚å®ƒä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚<br>ä¸²è¡Œï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚<br>å¹¶å‘ï¼šå¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼Œå¹¶å‘é˜Ÿåˆ—çš„å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥å‡½æ•°ä¸‹æ‰æœ‰æ•ˆã€‚</p><p>è‡ªå·±åˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆéä¸»é˜Ÿåˆ—ï¼‰ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Œä¼šå¼€å¯æ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚<br>å¹¶å‘é˜Ÿåˆ—ä¸‹çš„å¼‚æ­¥æ–¹å¼ï¼Œä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚</p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><h3 id="dispatch-syncç±»å‹"><a href="#dispatch-syncç±»å‹" class="headerlink" title="dispatch_syncç±»å‹"></a>dispatch_syncç±»å‹</h3><p>ä¸»é˜Ÿåˆ—ä¸‹çš„åŒæ­¥æ‰§è¡Œï¼Œä¼šäº§ç”Ÿæ­»é”ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œtaskæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)task &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"aä»»åŠ¡"</span>);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­æŒ‰ç…§é¡ºåºæ‰§è¡Œ</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"bä»»åŠ¡"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"cä»»åŠ¡"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ‰€ä»¥cä»»åŠ¡éœ€è¦ç­‰å¾…bä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰å¯ä»¥æ‰§è¡Œï¼›åˆå› ä¸ºæ˜¯ä¸»é˜Ÿåˆ—ä¸”aä»»åŠ¡å’Œcä»»åŠ¡éƒ½è¦åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥bä»»åŠ¡éœ€è¦ç­‰å¾…ï¼ˆaä»»åŠ¡å’Œï¼‰cä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰å¯ä»¥æ‰§è¡Œï¼›è¿™æ ·aä»»åŠ¡ä¸cä»»åŠ¡äº’ç›¸ç­‰å¾…äº§ç”Ÿäº†æ­»é”ã€‚</p><p>å†æ¯”å¦‚<a href="http://southpeak.github.io/2016/09/20/ios-techset-8/" target="_blank" rel="noopener">çŸ¥è¯†å°é›†</a>ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_queue_create(<span class="string">"com.app.test"</span>, NULL)<span class="comment">;</span></span><br><span class="line">dispatch_async(<span class="name">queue</span>, ^&#123; </span><br><span class="line">    dispatch_sync(<span class="name">queue</span>, ^&#123;</span><br><span class="line">        // å‘ä¸²è¡Œé˜Ÿåˆ—queueä¸­è¿½åŠ ä»»åŠ¡B</span><br><span class="line">        NSLog(@<span class="string">"Bä»»åŠ¡"</span>)<span class="comment">;</span></span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">    NSLog(@<span class="string">"Aä»»åŠ¡"</span>)<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>å‘ä¸²è¡Œé˜Ÿåˆ—queueä¸­è¿½åŠ ä»»åŠ¡Bï¼ŒBä»»åŠ¡éœ€è¦ç­‰å¾…Aä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ‰§è¡Œï¼Œç”±äºæ˜¯ä¸²è¡Œé˜Ÿåˆ—ä¸‹çš„åŒæ­¥æ‰§è¡Œï¼ŒAä»»åŠ¡éœ€è¦ç­‰å¾…Bä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ‰§è¡Œï¼ŒäºŒè€…äº’ç›¸ç­‰å¾…äº§ç”Ÿæ­»é”ã€‚</p><p>å¯ä»¥æ€»ç»“ï¼Œ<strong>ä½¿ç”¨syncå‡½æ•°å‘å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¼šå¡ä½å½“å‰çš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆäº§ç”Ÿæ­»é”ï¼‰</strong>ã€‚</p><h3 id="dispatch-onceç±»å‹"><a href="#dispatch-onceç±»å‹" class="headerlink" title="dispatch_onceç±»å‹"></a>dispatch_onceç±»å‹</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">void test() &#123;</span><br><span class="line">    static <span class="keyword">dispatch_once_t </span>onceToken<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dispatch_once(&amp;onceToken, </span>^&#123;</span><br><span class="line">        test()<span class="comment">;</span></span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">    printf(<span class="string">"This is a test"</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatch_onceçš„<a href="http://southpeak.github.io/2016/08/31/ios-techset-7/" target="_blank" rel="noopener">é€’å½’è°ƒç”¨</a>ä¹Ÿä¼šäº§ç”Ÿæ­»é”ã€‚</p><blockquote><p>onceTokenåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œblockä¹‹å‰ï¼Œå…¶å€¼å°†ç”±NULLå˜ä¸ºæŒ‡å‘ç¬¬ä¸€ä¸ªè°ƒç”¨è€…çš„æŒ‡é’ˆ(&amp;dow)ã€‚å¦‚æœåœ¨blockå®Œæˆä¹‹å‰ï¼Œæœ‰å…¶å®ƒçš„è°ƒç”¨è€…è¿›æ¥ï¼Œåˆ™ä¼šæŠŠè¿™äº›è°ƒç”¨è€…æ”¾åˆ°ä¸€ä¸ªwaiteré“¾è¡¨ä¸­(èµ°elseåˆ†æ”¯)ï¼Œç›´åˆ°blockæ‰§è¡Œå®Œæˆã€‚waiteré“¾ä¸­çš„æ¯ä¸ªè°ƒç”¨è€…éƒ½ä¼šç­‰å¾…ä¸€ä¸ªä¿¡å·é‡(dow.dow_sema)ã€‚åœ¨blockæ‰§è¡Œå®Œæˆåï¼Œé™¤äº†å°†onceTokenç½®ä¸ºDISPATCH_ONCE_DONEå¤–ï¼Œè¿˜ä¼šå»éå†waiteré“¾ä¸­çš„æ‰€æœ‰waiterï¼ŒæŠ›å‡ºç›¸åº”çš„ä¿¡å·é‡ï¼Œä»¥å‘ŠçŸ¥waiterä»¬è°ƒç”¨ç»“æŸã€‚<br>é€’å½’è°ƒç”¨test()æ—¶ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨ä½œä¸ºä¸€ä¸ªwaiterï¼Œåœ¨ç­‰å¾…blockå®Œæˆï¼Œè€Œblockçš„å®Œæˆä¾èµ–äºtest()çš„æ‰§è¡Œå®Œæˆï¼Œè¿™å°±æˆäº†ä¸€ä¸ªæ­»é”ã€‚</p></blockquote><p>ä¸‹ä¸€ç¯‡æ–‡ç« çœ‹ä¸€ä¸‹GCDæºç å§ã€‚ã€‚</p><h3 id="dispatch-apply"><a href="#dispatch-apply" class="headerlink" title="dispatch_apply"></a>dispatch_apply</h3><p>tutugeä»‹ç»äº†ä¸€ä¸ª<a href="http://tutuge.me/2015/04/03/something-about-gcd/" target="_blank" rel="noopener">ä¾‹å­</a>ï¼š</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_queue_create(<span class="string">"com.app.test"</span>, DISPATCH_QUEUE_SERIAL)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_apply(<span class="number">3</span>, queue, ^(<span class="name">size_t</span> i) &#123;</span><br><span class="line">    NSLog(@<span class="string">"apply loop outside %zu"</span>, j)<span class="comment">;</span></span><br><span class="line">    // æ­»é”</span><br><span class="line">    dispatch_apply(<span class="number">3</span>, queue, ^(<span class="name">size_t</span> j) &#123;</span><br><span class="line">        NSLog(@<span class="string">"apply loop inside %zu"</span>, j)<span class="comment">;</span></span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>dispatch_applyæ˜¯å°†blockè¿½åŠ åˆ°æŒ‡å®šçš„Queueä¸­æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°ï¼Œå¹¶ç­‰å¾…å…¨éƒ¨blockæ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå³å®ƒç”¨çš„æ˜¯dispatch_syncã€‚è¿™è‡ªç„¶è§£é‡Šäº†ä¸ºå•¥ä¼šæ­»é”äº†ã€‚å®˜æ–¹æ–‡æ¡£ä¸Šè‹¹æœæ¨èçš„ä½¿ç”¨æ–¹å¼æ˜¯é…åˆdispatch_get_global_queueå…¨å±€é˜Ÿåˆ—ã€‚</p><h2 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a>çº¿ç¨‹åŒæ­¥</h2><p>iOSä¸­çš„çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼š</p><ul><li>OSSpinLockï¼ˆè‡ªæ—‹é”ï¼Œå¿™ç­‰ï¼‰</li><li>os_unfair_lockï¼ˆä¼‘çœ ï¼ŒiOS10+ï¼‰</li><li>pthread_mutexï¼ˆäº’æ–¥é”ï¼Œå¯é€’å½’ï¼Œå¯æ¡ä»¶ï¼Œä¼‘çœ ï¼‰</li><li>dispatch_semaphoreï¼ˆä¿¡å·é‡ï¼‰</li><li>dispatch_queue(DISPATCH_QUEUE_SERIAL)ï¼ˆä¸²è¡ŒåŒæ­¥ï¼‰</li><li>NSLockï¼ˆå°è£…mutexï¼‰</li><li>NSRecursiveLockï¼ˆå°è£…mutexé€’å½’é”ï¼‰</li><li>NSConditionï¼ˆå°è£…mutexæ¡ä»¶é”ï¼‰</li><li>NSConditionLockï¼ˆå°è£…NSConditionï¼Œå¯è®¾ç½®æ¡ä»¶å€¼ï¼‰</li><li>@synchronizedï¼ˆå°è£…mutexé€’å½’é”ï¼Œè¯­æ³•ç®€å•ï¼‰</li></ul><p>ibiremeåœ¨<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">ã€Šä¸å†å®‰å…¨çš„OSSpinLockã€‹</a>ä¸­ä»‹ç»äº†è‡ªæ—‹é”ï¼ˆæ¯”å¦‚OSSpinLockï¼‰ä¼˜å…ˆçº§ç¿»è½¬çš„é—®é¢˜ï¼š<br>å‡å®šæœ‰ä¼˜å…ˆçº§è¾ƒé«˜çš„çº¿ç¨‹aï¼Œä¼˜å…ˆçº§è¾ƒä½çš„çº¿ç¨‹bï¼Œä¸€å¼€å§‹ç”±çº¿ç¨‹bæ‰§è¡Œä»»åŠ¡ï¼Œåˆ™åŠ é”ï¼Œçº¿ç¨‹aå¤„äºå¿™ç­‰çŠ¶æ€ã€‚ä½†æ˜¯ç”±äºçº¿ç¨‹açš„ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œè·å¾—çš„æ—¶é—´ç‰‡ä¹Ÿè¾ƒå¤šï¼Œé‚£ä¹ˆçº¿ç¨‹bçš„æ—¶é—´ç‰‡æ¯”è¾ƒå°‘ï¼Œå¯èƒ½ä¸€ç›´æ— æ³•å¾€ä¸‹æ‰§è¡Œï¼Œæ— æ³•é‡Šæ”¾é”ã€‚äºæ˜¯é€ æˆçº¿ç¨‹aä¸€ç›´å¤„äºå¿™ç­‰çŠ¶æ€ï¼Œè€Œä¼˜å…ˆçº§è¾ƒä½çš„çº¿ç¨‹bå´åœ¨ä¸€ç›´æ‰§è¡Œä»»åŠ¡ï¼Œä¾¿å‡ºç°äº†ä¼˜å…ˆçº§åè½¬ã€‚<br>å½“ä½¿ç”¨äº’æ–¥é”æ—¶å°±ä¸ä¼šæœ‰è¿™ç§é—®é¢˜ï¼šçº¿ç¨‹aä¸ä¼šå¿™ç­‰ï¼Œè€Œæ˜¯ä¼‘çœ ï¼Œä¹Ÿå³ä¸ä¼šå ç”¨CPUèµ„æºï¼Œè¿™æ ·çº¿ç¨‹bçš„ä»»åŠ¡å¾ˆå¿«æ‰§è¡Œå®Œæ¯•å¹¶é‡Šæ”¾é”ï¼Œçº¿ç¨‹açš„ä»»åŠ¡å°±å¾—åˆ°æ‰§è¡Œäº†ã€‚</p><p>ä»€ä¹ˆæƒ…å†µä½¿ç”¨è‡ªæ—‹é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´å¾ˆçŸ­</li><li>åŠ é”çš„ä»£ç ï¼ˆä¸´ç•ŒåŒºï¼‰ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰æƒ…å†µå¾ˆå°‘å‘ç”Ÿ</li><li>CPUèµ„æºä¸ç´§å¼ </li><li>å¤šæ ¸å¤„ç†å™¨</li></ul><p>ä»€ä¹ˆæƒ…å†µä½¿ç”¨äº’æ–¥é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´è¾ƒé•¿</li><li>å•æ ¸å¤„ç†å™¨</li><li>ä¸´ç•ŒåŒºæœ‰IOæ“ä½œ</li><li>ä¸´ç•ŒåŒºä»£ç å¤æ‚æˆ–è€…å¾ªç¯é‡å¤§</li><li>ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆ</li></ul><p>åœ¨å¼€å‘ä¸­å¸¸ç”¨çš„æ˜¯ä¿¡å·é‡ï¼Œæ€§èƒ½è¾ƒé«˜ï¼ˆæ¬¡äºOSSpinLockå’Œos_unfair_lockï¼‰ä¸”æ–¹ä¾¿ã€‚</p><h2 id="å­˜å–æ–¹æ³•åŠ é”"><a href="#å­˜å–æ–¹æ³•åŠ é”" class="headerlink" title="å­˜å–æ–¹æ³•åŠ é”"></a>å­˜å–æ–¹æ³•åŠ é”</h2><p>nonatomicä¸atomicæ˜¯å¾ˆå¸¸è§çš„è¯é¢˜ã€‚atomicä¿è¯äº†getterå’Œsetterçš„åŸå­æ€§ï¼Œæ–¹æ³•å†…éƒ¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯ä½¿ç”¨å±æ€§è¿‡ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨ã€‚è€Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéœ€è¦ä¿è¯â€œä½¿ç”¨å±æ€§è¿‡ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨â€ã€‚æ‰€ä»¥ï¼Œè¿™å°±é€ æˆæˆ‘ä»¬ç»å¸¸é€‰æ‹©nonatomicï¼š<br>1ï¼Œ é¡¹ç›®ä¸­æœ‰å¤ªå¤šçš„å±æ€§è®¾ç½®å–å€¼æ“ä½œï¼Œæ¯æ¬¡éƒ½åŠ é”ï¼Œæ¶ˆè€—æ€§èƒ½ï¼›<br>2ï¼Œ å¹¶ä¸æ˜¯æ¯ä¸ªå±æ€§å–å€¼è®¾å€¼æ“ä½œéƒ½éœ€è¦åŠ é”çš„ï¼Œå®Œå…¨å¯ä»¥åœ¨çœŸæ­£éœ€è¦çš„åœ°æ–¹è‡ªå·±åŠ é”ï¼›</p><p>å¯¹äºå±æ€§æ¥è¯´ï¼Œæœ€ç†æƒ³çš„è‡ªç„¶æ˜¯è¯»æ“ä½œï¼Œå…è®¸å¤šæ¡çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œå†™æ“ä½œï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½ä¸€æ¡çº¿ç¨‹æ‰§è¡Œã€‚å®ç°æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œè¯»å†™é”pthread_rwlockæˆ–è€…GCDä¸­çš„dispatch_barrier_asyncã€‚ä¸ªäººå–œæ¬¢ç¬¬äºŒç§ã€‚<br><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">@synthesize <span class="built_in">name</span> = <span class="variable">_name</span>;</span><br><span class="line">- (void)<span class="built_in">setName</span>:(NSString *)<span class="built_in">name</span> &#123;</span><br><span class="line">    dispatch_barrier_sync(self.propertyQueue, ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">name</span> != <span class="variable">_name</span>) &#123;</span><br><span class="line">            <span class="variable">_name</span> = <span class="built_in">name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)<span class="built_in">name</span> &#123;</span><br><span class="line">    <span class="variable">__block</span> NSString *<span class="built_in">name</span> = <span class="literal">nil</span>;</span><br><span class="line">    dispatch_sync(self.propertyQueue, ^&#123;</span><br><span class="line">        <span class="built_in">name</span> = <span class="variable">_name</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    return <span class="built_in">name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="Runloop"><a href="#Runloop" class="headerlink" title="Runloop"></a>Runloop</h1><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><strong>Runloopä¸çº¿ç¨‹</strong><br>æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopå¯¹è±¡ï¼ŒRunLoopä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„Dictionaryé‡Œï¼Œçº¿ç¨‹ä½œä¸ºkeyï¼ŒRunLoopä½œä¸ºvalueã€‚çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰RunLoopå¯¹è±¡ï¼ŒRunLoopä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–å®ƒæ—¶åˆ›å»ºï¼Œ<br>ä¼šåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯ã€‚ä¸»çº¿ç¨‹çš„RunLoopå·²ç»è‡ªåŠ¨è·å–ï¼ˆåˆ›å»ºï¼‰ï¼Œå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰å¼€å¯RunLoopã€‚</p><p><strong>Runloopçš„Mode</strong><br>CFRunLoopModeRefä»£è¡¨RunLoopçš„è¿è¡Œæ¨¡å¼ã€‚ä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªModeï¼Œæ¯ä¸ªModeåˆåŒ…å«è‹¥å¹²ä¸ªSource0/Source1/Timer/Observerã€‚RunLoopå¯åŠ¨æ—¶åªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ä¸ªModeï¼Œä½œä¸ºcurrentMode<br>å¦‚æœéœ€è¦åˆ‡æ¢Modeï¼Œåªèƒ½é€€å‡ºå½“å‰Loopï¼Œå†é‡æ–°é€‰æ‹©ä¸€ä¸ªModeè¿›å…¥ï¼ˆè¿™æ ·åšå¯ä»¥ä¿è¯ä¸“å¿ƒå¤„ç†ä¸€ä¸ªModeä¸‹çš„äº‹ä»¶ï¼‰ã€‚ä¸åŒç»„çš„Source0/Source1/Timer/Observerèƒ½åˆ†éš”å¼€æ¥ï¼Œäº’ä¸å½±å“ã€‚å¦‚æœModeé‡Œæ²¡æœ‰ä»»ä½•Source0/Source1/Timer/Observerï¼ŒRunLoopä¼šç«‹é©¬é€€å‡ºã€‚</p><p>kCFRunLoopDefaultModeæ˜¯Appçš„é»˜è®¤Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œã€‚UITrackingRunLoopModeæ˜¯ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äºScrollViewè¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ã€‚</p><p><strong>Modeä¸‹çš„Source0/Source1/Timer/Observer</strong><br>Source0</p><ul><li>è§¦æ‘¸äº‹ä»¶å¤„ç†</li><li>performSelector:onThread:</li></ul><p>Source1</p><ul><li>åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡ï¼ˆæ¯”å¦‚<a href="https://blog.chenyalun.com/2019/01/28/NSNotificationCenteræ¢ç´¢/#ä¸‰ã€å­çº¿ç¨‹é€šçŸ¥">ä¸åŒçº¿ç¨‹é—´çš„Notification</a>ï¼‰</li><li>ç³»ç»Ÿäº‹ä»¶æ•æ‰</li></ul><p>Timers</p><ul><li>NSTimer</li><li>performSelector:withObject:afterDelay:ï¼ˆå†…éƒ¨ä¹Ÿæ˜¯å®šæ—¶å™¨ï¼‰</li></ul><p>Observers</p><ul><li>ç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</li><li>UIåˆ·æ–°ï¼ˆBeforeWaitingï¼‰</li><li>Autorelease poolï¼ˆBeforeWaitingï¼‰</li></ul><p><strong>Runloopçš„å†…éƒ¨é€»è¾‘</strong><br>01ã€é€šçŸ¥Observersï¼šè¿›å…¥Loop<br>02ã€é€šçŸ¥Observersï¼šå³å°†å¤„ç†Timers<br>03ã€é€šçŸ¥Observersï¼šå³å°†å¤„ç†Sources<br>04ã€å¤„ç†Blocks<br>05ã€å¤„ç†Source0ï¼ˆå¯èƒ½ä¼šå†æ¬¡å¤„ç†Blocksï¼‰<br>06ã€å¦‚æœå­˜åœ¨Source1ï¼Œå°±è·³è½¬åˆ°ç¬¬8æ­¥<br>07ã€é€šçŸ¥Observersï¼šå¼€å§‹ä¼‘çœ ï¼ˆç­‰å¾…æ¶ˆæ¯å”¤é†’ï¼‰<br>08ã€é€šçŸ¥Observersï¼šç»“æŸä¼‘çœ ï¼ˆè¢«æŸä¸ªæ¶ˆæ¯å”¤é†’ï¼‰<br>    ï¼ˆ01ï¼‰&gt; å¤„ç†Timer<br>    ï¼ˆ02ï¼‰&gt; å¤„ç†GCD Async To Main Queue<br>    ï¼ˆ03ï¼‰&gt; å¤„ç†Source1<br>09ã€å¤„ç†Blocks<br>10ã€æ ¹æ®å‰é¢çš„æ‰§è¡Œç»“æœï¼Œå†³å®šå¦‚ä½•æ“ä½œ<br>    ï¼ˆ01ï¼‰&gt; å›åˆ°ç¬¬02æ­¥<br>    ï¼ˆ02ï¼‰&gt; é€€å‡ºLoop<br>11ã€é€šçŸ¥Observersï¼šé€€å‡ºLoop</p><p><strong>RunloopçŠ¶æ€ç›‘å¬</strong><br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// åˆ›å»ºObserver</span></span><br><span class="line"><span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(kCFAllocatorDefault, kCFRunLoopAllActivities, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">   <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">       <span class="keyword">case</span> kCFRunLoopEntry: &#123;</span><br><span class="line">           <span class="built_in">CFRunLoopMode</span> mode = <span class="built_in">CFRunLoopCopyCurrentMode</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">           <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopEntry - %@"</span>, mode);</span><br><span class="line">           <span class="built_in">CFRelease</span>(mode);</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">           </span><br><span class="line">       <span class="keyword">case</span> kCFRunLoopExit: &#123;</span><br><span class="line">           <span class="built_in">CFRunLoopMode</span> mode = <span class="built_in">CFRunLoopCopyCurrentMode</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">           <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopExit - %@"</span>, mode);</span><br><span class="line">           <span class="built_in">CFRelease</span>(mode);</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">           </span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ Observeråˆ°RunLoopä¸­</span></span><br><span class="line"><span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetMain</span>(), observer, kCFRunLoopCommonModes);</span><br><span class="line"><span class="comment">// é‡Šæ”¾</span></span><br><span class="line"><span class="built_in">CFRelease</span>(observer);</span><br></pre></td></tr></table></figure></p><p><strong>ä¼‘çœ çš„å®ç°åŸç†</strong><br>ä¾é mach_msg()å‡½æ•°ï¼Œåšåˆ°ç”¨æˆ·æ€å¤„ç†æ¶ˆæ¯ï¼Œå†…æ ¸æ€ç­‰å¾…æ¶ˆæ¯ï¼Œæ²¡æœ‰æ¶ˆæ¯å°±è®©çº¿ç¨‹ä¼‘çœ ã€‚</p><h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><h3 id="1ï¼Œæ§åˆ¶çº¿ç¨‹å‘¨æœŸ"><a href="#1ï¼Œæ§åˆ¶çº¿ç¨‹å‘¨æœŸ" class="headerlink" title="1ï¼Œæ§åˆ¶çº¿ç¨‹å‘¨æœŸ"></a>1ï¼Œæ§åˆ¶çº¿ç¨‹å‘¨æœŸ</h3><p>å€ŸåŠ©Runloopå®ç°çº¿ç¨‹ä¿æ´»ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAPermenantThread</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *innerThread;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAPermenantThread</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _innerThread = [[<span class="built_in">NSThread</span> alloc] initWithBlock:^&#123;</span><br><span class="line">            <span class="built_in">CFRunLoopSourceContext</span> context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">CFRunLoopSourceRef</span> source = <span class="built_in">CFRunLoopSourceCreate</span>(kCFAllocatorDefault, <span class="number">0</span>, &amp;context);</span><br><span class="line">            <span class="built_in">CFRelease</span>(source);</span><br><span class="line">            <span class="comment">// ç¬¬3ä¸ªå‚æ•°ï¼šreturnAfterSourceHandledï¼Œè®¾ç½®ä¸ºtrueï¼Œä»£è¡¨æ‰§è¡Œå®Œsourceåå°±ä¼šé€€å‡ºå½“å‰loop</span></span><br><span class="line">            <span class="built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">        [_innerThread start];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span> stop];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)executeTask:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))task &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.innerThread || !task) <span class="keyword">return</span>;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(executeInnerTask:) onThread:<span class="keyword">self</span>.innerThread withObject:task waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stop &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.innerThread) <span class="keyword">return</span>;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(stopThread) onThread:<span class="keyword">self</span>.innerThread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - private methods</span></span><br><span class="line">- (<span class="keyword">void</span>)stopThread &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopStop</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">    <span class="keyword">self</span>.innerThread = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)executeInnerTask:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))task &#123;</span><br><span class="line">    <span class="keyword">if</span> (task) task();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><h3 id="2ï¼Œè§£å†³NSTimeråœ¨UIScrollViewæ»‘åŠ¨æ—¶åœæ­¢å·¥ä½œ"><a href="#2ï¼Œè§£å†³NSTimeråœ¨UIScrollViewæ»‘åŠ¨æ—¶åœæ­¢å·¥ä½œ" class="headerlink" title="2ï¼Œè§£å†³NSTimeråœ¨UIScrollViewæ»‘åŠ¨æ—¶åœæ­¢å·¥ä½œ"></a>2ï¼Œè§£å†³NSTimeråœ¨UIScrollViewæ»‘åŠ¨æ—¶åœæ­¢å·¥ä½œ</h3><p>ä¿®æ”¹Runloopçš„Modeå³å¯ã€‚</p><h3 id="3ï¼Œç›‘æ§åº”ç”¨å¡é¡¿"><a href="#3ï¼Œç›‘æ§åº”ç”¨å¡é¡¿" class="headerlink" title="3ï¼Œç›‘æ§åº”ç”¨å¡é¡¿"></a>3ï¼Œç›‘æ§åº”ç”¨å¡é¡¿</h3><p>å¸¸è§åŸå› ï¼š<br>æ­»é”ï¼šä¸»çº¿ç¨‹æ‹¿åˆ°é” Aï¼Œéœ€è¦è·å¾—é” Bï¼Œè€ŒåŒæ—¶æŸä¸ªå­çº¿ç¨‹æ‹¿äº†é” Bï¼Œéœ€è¦é” Aï¼Œè¿™æ ·ç›¸äº’ç­‰å¾…å°±æ­»é”äº†ã€‚<br>æŠ¢é”ï¼šä¸»çº¿ç¨‹éœ€è¦è®¿é—® DBï¼Œè€Œæ­¤æ—¶æŸä¸ªå­çº¿ç¨‹å¾€ DB æ’å…¥å¤§é‡æ•°æ®ã€‚é€šå¸¸æŠ¢é”çš„ä½“éªŒæ˜¯å¶å°”å¡ä¸€é˜µå­ï¼Œè¿‡ä¼šå°±æ¢å¤äº†ã€‚<br>ä¸»çº¿ç¨‹å¤§é‡ IOï¼šä¸»çº¿ç¨‹ä¸ºäº†æ–¹ä¾¿ç›´æ¥å†™å…¥å¤§é‡æ•°æ®ï¼Œä¼šå¯¼è‡´ç•Œé¢å¡é¡¿ã€‚<br>ä¸»çº¿ç¨‹å¤§é‡è®¡ç®—ï¼šç®—æ³•ä¸åˆç†ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹æŸä¸ªå‡½æ•°å ç”¨å¤§é‡ CPUã€‚<br>å¤§é‡çš„ UI ç»˜åˆ¶ï¼šå¤æ‚çš„ UIã€å›¾æ–‡æ··æ’ç­‰ï¼Œå¸¦æ¥å¤§é‡çš„ UI ç»˜åˆ¶ã€‚</p><blockquote><p>ä¸»çº¿ç¨‹ç»å¤§éƒ¨åˆ†è®¡ç®—æˆ–è€…ç»˜åˆ¶ä»»åŠ¡éƒ½æ˜¯ä»¥Runloopä¸ºå•ä½å‘ç”Ÿã€‚å•æ¬¡Runloopå¦‚æœæ—¶é•¿è¶…è¿‡16msï¼Œå°±ä¼šå¯¼è‡´UIä½“éªŒçš„å¡é¡¿ã€‚    â€”â€”by mrpeakå‰è¾ˆ</p></blockquote><h4 id="æ–¹æ¡ˆä¸€"><a href="#æ–¹æ¡ˆä¸€" class="headerlink" title="æ–¹æ¡ˆä¸€"></a>æ–¹æ¡ˆä¸€</h4><p>åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹ï¼Œç›‘æ§ä¸»çº¿ç¨‹çš„æ´»åŠ¨æƒ…å†µï¼Œå¦‚æœå‘ç°æœ‰å¡é¡¿ï¼Œå°±å°†å †æ ˆdumpä¸‹æ¥ã€‚å¦‚ä½•ç›‘æ§ï¼Ÿä¸»è¦åˆ©ç”¨RunloopçŠ¶æ€ç›‘å¬ï¼ŒkCFRunLoopExitçš„æ—¶é—´ï¼Œå‡å»kCFRunLoopEntryçš„æ—¶é—´ï¼Œè·å¾—ä¸€æ¬¡Runloopæ‰€è€—è´¹çš„æ—¶é—´ã€‚<br>å®é™…ä¸Šï¼Œä¸»çº¿ç¨‹çš„RunLoopæ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å¯çš„ï¼Œä¸»çº¿ç¨‹ä¸­çš„blockã€äº¤äº’äº‹ä»¶ã€ä»¥åŠå…¶ä»–ä»»åŠ¡éƒ½æ˜¯åœ¨kCFRunLoopBeforeSourcesåˆ°kCFRunLoopBeforeWaitingä¹‹é—´æ‰§è¡Œï¼Œæ‰€ä»¥å¯ä»¥åœ¨å³å°†å¼€å§‹æ‰§è¡ŒSourcesæ—¶ï¼Œè®°å½•ä¸€ä¸‹èµ·å§‹æ—¶é—´ï¼Œå¹¶æ ‡è®°ä»»åŠ¡çŠ¶æ€ä¸ºYESï¼Œå°†è¦è¿›å…¥ç¡çœ çŠ¶æ€æ—¶ï¼Œæ ‡è®°ç½®ä¸ºNOã€‚</p><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè®¾å®šä¸º2ç§’ä¸€æ¬¡å›è°ƒï¼Œä¹Ÿå³æ¯éš”2ç§’è®¡ç®—ä¸€ä¸‹æ—¶é—´å·®çœ‹æ˜¯å¦ä¼šæœ‰å¡é¡¿å‘ç”Ÿã€‚æœ‰åŒå­¦å·²ç»ç»™å‡ºäº†<a href="http://hl1987.com/2018/04/27/RunLoopæ€»ç»“ï¼šRunLoopçš„åº”ç”¨åœºæ™¯ï¼ˆå››ï¼‰Appå¡é¡¿ç›‘æµ‹/" target="_blank" rel="noopener">æ–¹æ³•</a>ã€‚</p><p>æ¯æ¬¡å®šæ—¶å™¨å›è°ƒæ—¶ï¼Œè‹¥ä»»åŠ¡çŠ¶æ€ä»ç„¶ä¸ºYESï¼ˆè¯´æ˜Runloopåœ¨kCFRunLoopBeforeSourceså’ŒkCFRunLoopBeforeWaitingä¹‹é—´ï¼‰ï¼Œåˆ™åˆ¤æ–­æ—¶é—´æœ‰æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> RunLoopTimerCallBack(<span class="built_in">CFRunLoopTimerRef</span> timer, <span class="keyword">void</span> *info) &#123;</span><br><span class="line">     YAFluencyMonitorManager *manager = (__bridge YAFluencyMonitorManager *)info;</span><br><span class="line">     <span class="keyword">if</span> (!manager.excuting) <span class="keyword">return</span>;</span><br><span class="line">     <span class="built_in">NSTimeInterval</span> excuteTime = [<span class="built_in">NSDate</span>.date timeIntervalSinceDate:manager.startDate];</span><br><span class="line">     <span class="keyword">if</span> (excuteTime &gt;= manager.fault) &#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹å¡é¡¿äº†%fç§’"</span>, excuteTime);</span><br><span class="line">         [manager handleStackInfo];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼Œæˆ‘ä»æ•°æ®åº“ä¸­è¯»å‡º1000æ¡æ•°æ®ï¼Œå†æŠŠè¿™1000æ¡æ•°æ®å†™åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™äº›æ“ä½œéƒ½åœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼Œåˆ©ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶CrashReporterå¯ä»¥çœ‹åˆ°å‡½æ•°è°ƒç”¨æ ˆï¼š</p><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">Thread <span class="number">0</span>:</span><br><span class="line"><span class="number">0</span>   libsystem_kernel.dylib              <span class="number">0x00000001874cb42c</span> fsync + <span class="number">8</span></span><br><span class="line"><span class="number">1</span>   libsqlite3.dylib                    <span class="number">0x00000001893549ec</span> sqlite3_randomness + <span class="number">2520</span></span><br><span class="line"><span class="number">2</span>   libsqlite3.dylib                    <span class="number">0x000000018934a780</span> sqlite3_free_table + <span class="number">62008</span></span><br><span class="line"><span class="number">3</span>   libsqlite3.dylib                    <span class="number">0x0000000189335d0c</span> sqlite3_value_text + <span class="number">23504</span></span><br><span class="line"><span class="number">4</span>   libsqlite3.dylib                    <span class="number">0x0000000189301f44</span> sqlite3_finalize + <span class="number">3608</span></span><br><span class="line"><span class="number">5</span>   libsqlite3.dylib                    <span class="number">0x000000018932e774</span> sqlite3_step + <span class="number">60828</span></span><br><span class="line"><span class="number">6</span>   libsqlite3.dylib                    <span class="number">0x000000018931fb5c</span> sqlite3_step + <span class="number">388</span></span><br><span class="line"><span class="number">7</span>   FMDB                                <span class="number">0x00000001051b39d0</span> -[FMDatabase executeUpdate:error:withArgumentsInArray:orDictionary:orVAList:] + <span class="number">3152</span></span><br><span class="line"><span class="number">8</span>   FMDB                                <span class="number">0x00000001051b4038</span> -[FMDatabase executeUpdate:] + <span class="number">96</span></span><br><span class="line"><span class="number">9</span>   FMDB                                <span class="number">0x00000001051b4ab8</span> -[FMDatabase commit] + <span class="number">48</span></span><br><span class="line"><span class="number">10</span>  FMDB                                <span class="number">0x00000001051bb270</span> __46-[FMDatabaseQueue beginTransaction:withBlock:]_block_invoke + <span class="number">592</span></span><br><span class="line"><span class="number">11</span>  libdispatch.dylib                   <span class="number">0x00000001053d2bd8</span> _dispatch_client_callout + <span class="number">16</span></span><br><span class="line"><span class="number">12</span>  libdispatch.dylib                   <span class="number">0x00000001053e1858</span> _dispatch_lane_barrier_sync_invoke_and_complete + <span class="number">124</span></span><br><span class="line"><span class="number">13</span>  FMDB                                <span class="number">0x00000001051bafd8</span> -[FMDatabaseQueue beginTransaction:withBlock:] + <span class="number">176</span></span><br><span class="line"><span class="number">14</span>  FMDB                                <span class="number">0x00000001051bb2dc</span> -[FMDatabaseQueue inTransaction:] + <span class="number">80</span></span><br><span class="line"><span class="number">15</span>  Splash                              <span class="number">0x0000000104cb0be4</span> +[YAFeedPhotoDBManager savePhotoListToDataBase:] + <span class="number">388</span></span><br><span class="line"><span class="number">16</span>  Splash                              <span class="number">0x0000000104c9f380</span> __65-[YAFeedAPIManager parseAPIManager:successResult:isFromDataBase:]_block_invoke + <span class="number">80</span></span><br><span class="line"><span class="number">17</span>  Splash                              <span class="number">0x0000000104cb09d8</span> __73+[YAFeedPhotoDBManager loadPhotoListWithStartTime:limitCount:completion:]_block_invoke + <span class="number">60</span></span><br><span class="line"><span class="number">18</span>  libdispatch.dylib                   <span class="number">0x00000001053d17fc</span> _dispatch_call_block_and_release + <span class="number">24</span></span><br><span class="line"><span class="number">19</span>  libdispatch.dylib                   <span class="number">0x00000001053d2bd8</span> _dispatch_client_callout + <span class="number">16</span></span><br><span class="line"><span class="number">20</span>  libdispatch.dylib                   <span class="number">0x00000001053e0c34</span> _dispatch_main_queue_callback_4CF + <span class="number">1316</span></span><br><span class="line"><span class="number">21</span>  CoreFoundation                      <span class="number">0x000000018764f3a8</span> &lt;redacted&gt; + <span class="number">12</span></span><br><span class="line"><span class="number">22</span>  CoreFoundation                      <span class="number">0x000000018764a39c</span> &lt;redacted&gt; + <span class="number">2004</span></span><br><span class="line"><span class="number">23</span>  CoreFoundation                      <span class="number">0x00000001876498a0</span> CFRunLoopRunSpecific + <span class="number">464</span></span><br><span class="line"><span class="number">24</span>  GraphicsServices                    <span class="number">0x00000001915a1328</span> GSEventRunModal + <span class="number">104</span></span><br><span class="line"><span class="number">25</span>  UIKitCore                           <span class="number">0x000000018b73a740</span> UIApplicationMain + <span class="number">1936</span></span><br><span class="line"><span class="number">26</span>  Splash                              <span class="number">0x0000000104cac944</span> main + <span class="number">120</span></span><br><span class="line"><span class="number">27</span>  libdyld.dylib                       <span class="number">0x00000001874d4360</span> &lt;redacted&gt; + <span class="number">4</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé—®é¢˜å°±åœ¨<code>+[YAFeedPhotoDBManager savePhotoListToDataBase:]</code>è¿™è¡Œä»£ç äº†ã€‚</p><h4 id="æ–¹æ¡ˆäºŒ"><a href="#æ–¹æ¡ˆäºŒ" class="headerlink" title="æ–¹æ¡ˆäºŒ"></a>æ–¹æ¡ˆäºŒ</h4><p>ç¬¬äºŒç§æ–¹å¼ä¸»è¦æ˜¯å¯¹æ£€æµ‹ç²’åº¦çš„æ”¹è¿›ã€‚æ¯”å¦‚ï¼Œå¡é¡¿é˜ˆå€¼T=500msã€å¡é¡¿æ¬¡æ•°N=1ï¼Œå¯ä»¥åˆ¤å®šä¸ºå•æ¬¡è€—æ—¶è¾ƒé•¿çš„ä¸€æ¬¡æœ‰æ•ˆå¡é¡¿ï¼›è€Œå¡é¡¿é˜ˆå€¼T=50msã€å¡é¡¿æ¬¡æ•°N=5ï¼Œå¯ä»¥åˆ¤å®šä¸ºé¢‘æ¬¡è¾ƒå¿«çš„ä¸€æ¬¡æœ‰æ•ˆå¡é¡¿ã€‚è¿™æ ·å°±éœ€è¦å¯¹æ¯æ¬¡Runloopæ—¶é—´æ®µåšå¤„ç†ã€‚<a href="https://juejin.im/post/5cacb2baf265da03904bf93b" target="_blank" rel="noopener">minjing_linlvåŒå­¦</a>æœ‰ç»™å‡ºDemoï¼Œä½œè€…æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨æ¥å®šæ—¶ç›‘æµ‹å¡é¡¿çŠ¶å†µï¼Œè€Œæ˜¯â€œå®æ—¶è®¡ç®—ä¸¤ä¸ªçŠ¶æ€åŒºåŸŸä¹‹é—´çš„è€—æ—¶æ˜¯å¦åˆ°è¾¾æŸä¸ªé˜€å€¼â€ã€‚</p><p>æŠŠä»£ç downä¸‹æ¥è¯•äº†ä¸€è¯•ï¼Œå‘ç°ä½œè€…æ˜¯æŠŠå¡é¡¿è€—æ—¶å’Œå¡é¡¿æ¬¡æ•°ä¸¤ä¸ªæ¡ä»¶ç»¼åˆèµ·æ¥åˆ¤æ–­çš„ï¼Œè€—æ—¶çš„å®ç°æ˜¯åˆ©ç”¨dispatch_semaphore_waitå‡½æ•°ï¼Œè®¾ç½®äº†è¶…æ—¶å‚æ•°ã€‚</p><p>ä¸è¿‡ä»£ç è¿™å—æœ‰å‡ ä¸ªåœ°æ–¹å€¼å¾—å•†æ¦·ï¼š<br>1ï¼Œå­çº¿ç¨‹å¡é¡¿ç›‘æ§æœ€å¥½å¼€ä¸€ä¸ªç‹¬ç«‹çš„å¸¸é©»çº¿ç¨‹ï¼Œè€Œä½œè€…å´ç”¨äº†ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ã€‚<br>2ï¼Œâ€œå‘ç”Ÿä¸€æ¬¡æœ‰æ•ˆçš„å¡é¡¿å›è°ƒå‡½æ•°â€ï¼Œè®¾ç½®è¿™ç§æ¥å£è€Œä¸”æš´éœ²ç»™å¤–ç•Œä¸çŸ¥é“æ„ä¹‰ä½•åœ¨ï¼Œå‘ç”Ÿå¡é¡¿éš¾é“ä¸æ˜¯è¿™ä¸ªå•ä¾‹è‡ªå·±å¤„ç†å¹¶ä¸ŠæŠ¥å—ï¼Ÿ<br>3ï¼Œåœ¨setteræ–¹æ³•ä¸­æ‰‹åŠ¨è°ƒç”¨willChangeValueForKeyå’ŒdidChangeValueForKeyï¼Œè²Œä¼¼æ˜¯ä¸ºäº†æ‰‹åŠ¨è§¦å‘KVOï¼Œä½†æ˜¯å´åˆä¸é‡å†™automaticallyNotifiesObserversForNameæ–¹æ³•ï¼Œé‚£è¿™ä¹ˆåšå›¾å•¥ï¼Ÿ</p><p>åªçœ‹ä½œè€…æ€è·¯ï¼Œè¿™ç§æ–¹å¼è¾ƒæ–¹æ¡ˆä¸€æ˜¾å¾—ç»†è…»ï¼Œè¿˜æ˜¯æŒºæ£’çš„ã€‚</p><h4 id="æ–¹æ¡ˆä¸‰"><a href="#æ–¹æ¡ˆä¸‰" class="headerlink" title="æ–¹æ¡ˆä¸‰"></a>æ–¹æ¡ˆä¸‰</h4><p>å…¶å®æœ€æ£’çš„è¿˜æ˜¯<a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=207890859&amp;idx=1&amp;sn=e98dd604cdb854e7a5808d2072c29162&amp;scene=4" target="_blank" rel="noopener">ã€Šå¾®ä¿¡iOSå¡é¡¿ç›‘æ§ç³»ç»Ÿã€‹</a>è¿™ç¯‡æ–‡ç« ä»‹ç»çš„ã€‚</p><p>æ€»ç»“ä¸€ä¸‹key pointï¼š<br>1ï¼ŒCPU å ç”¨è¶…è¿‡äº†100%å’Œä¸»çº¿ç¨‹ Runloop æ‰§è¡Œäº†è¶…è¿‡2ç§’ç»¼åˆèµ·æ¥åˆ¤æ–­æ˜¯ä¸€æ¬¡å¡é¡¿å‘ç”Ÿäº†ï¼ˆéœ€è¦åŒæ ¸iPhoneï¼‰ã€‚<br>2ï¼Œé‡åˆ°ç›¸åŒçš„å¡é¡¿å †æ ˆï¼ŒæŒ‰ç…§æ–æ³¢é‚£å¥‘æ•°åˆ—å°†æ£€æŸ¥æ—¶é—´é€’å¢ï¼Œé¿å…åŒä¸€ä¸ªå¡é¡¿å†™å…¥å¤šä¸ªæ–‡ä»¶ï¼Œä¹Ÿé¿å…æ£€æµ‹çº¿ç¨‹å›´ç€åŒä¸€ä¸ªå¡é¡¿ç©ºè½¬ã€‚<br>3ï¼Œä¸»è¦æ ¹æ®å †æ ˆçš„æœ€å†…å±‚å½’ç±»ï¼Œè¿™æ ·èƒ½å¤Ÿå°†åŒä¸€åŸå› çš„å¡é¡¿å½’ç±»èµ·æ¥ã€‚<br>4ï¼ŒæŠ½æ ·ä¸ŠæŠ¥ï¼Œå‡å°åå°å‹åŠ›ã€‚</p><h3 id="4ï¼Œåº”ç”¨èµ·æ­»å›ç”Ÿ"><a href="#4ï¼Œåº”ç”¨èµ·æ­»å›ç”Ÿ" class="headerlink" title="4ï¼Œåº”ç”¨èµ·æ­»å›ç”Ÿ"></a>4ï¼Œåº”ç”¨èµ·æ­»å›ç”Ÿ</h3><p>Appå‡ºç°å¼‚å¸¸åï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯é‡Œé¢è·‘Runloopçš„æ‰€æœ‰modeã€‚ä¸»è¦å°±æ˜¯ä¸‹é¢è¿™æ®µä»£ç ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å–å‡ºrunLoopæ‰€æœ‰è¿è¡Œçš„mode</span></span><br><span class="line"><span class="built_in">NSArray</span> *allModes = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFRunLoopCopyAllModes</span>(<span class="built_in">CFRunLoopGetCurrent</span>()));</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *mode <span class="keyword">in</span> allModes) &#123;</span><br><span class="line">    <span class="comment">//åœ¨æ¯ä¸ª mode ä¸­è½®æµè¿è¡Œè‡³å°‘0.001 ç§’</span></span><br><span class="line">        <span class="built_in">CFRunLoopRunInMode</span>((<span class="built_in">CFStringRef</span>)mode, <span class="number">0.001</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯ï¼Œå¦‚æœåœ¨è‡ªå·±æ‰‹åŠ¨åˆ›å»ºçš„å¾ªç¯é‡Œé¢åˆä¸€æ¬¡å‡ºç°crashï¼Œé‚£ç¥ä»™ä¹Ÿæ²¡åŠæ³•äº†ã€‚</p><p>æ•´ç†ä¸€ä¸‹ï¼Œæ˜¯è¿™æ ·ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YACrashHandlerManager</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> shouldIgnore;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YACrashHandlerManager</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleException:(<span class="built_in">NSException</span> *)exception &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *message = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å´©æºƒåŸå› å¦‚ä¸‹:\n%@\n%@"</span>,</span><br><span class="line">                         [exception reason],</span><br><span class="line">                         [[exception userInfo]</span><br><span class="line">                          objectForKey:kCaughtExceptionStackInfoKey]];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,message);</span><br><span class="line">    <span class="comment">// å¼¹å‡ºå¼¹çª—, è®¾ç½®shouldIgnoreçš„å€¼</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *allModes = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFRunLoopCopyAllModes</span>(<span class="built_in">CFRunLoopGetCurrent</span>()));</span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">self</span>.shouldIgnore) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *mode <span class="keyword">in</span> allModes) &#123;</span><br><span class="line">            <span class="built_in">CFRunLoopRunInMode</span>((<span class="built_in">CFStringRef</span>)mode, <span class="number">0.001</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    configCatchExceptionHandler(<span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">if</span> ([[exception name] isEqual:kSignalExceptionName]) &#123;</span><br><span class="line">        kill(getpid(), [[[exception userInfo] objectForKey:kSignalKey] intValue]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [exception raise];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> *getBacktrace() &#123;</span><br><span class="line">    <span class="keyword">void</span> *callstack[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int</span> frames = backtrace(callstack, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">char</span> **strs = backtrace_symbols(callstack, frames);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *backtrace = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:frames];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; frames; i++) &#123;</span><br><span class="line">        [backtrace addObject:[<span class="built_in">NSString</span> stringWithUTF8String:strs[i]]];</span><br><span class="line">    &#125;</span><br><span class="line">    free(strs);</span><br><span class="line">    <span class="keyword">return</span> backtrace;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> configCatchExceptionHandler(<span class="built_in">BOOL</span> isNil) &#123;</span><br><span class="line">    <span class="keyword">void</span> (*handler)(<span class="keyword">int</span>) = SIG_DFL;</span><br><span class="line">    <span class="built_in">NSUncaughtExceptionHandler</span> *exc = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isNil) &#123;</span><br><span class="line">        handler = signalHandler;</span><br><span class="line">        exc = &amp;handleException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSSetUncaughtExceptionHandler</span>(exc);</span><br><span class="line">    signal(SIGABRT, handler);</span><br><span class="line">    signal(SIGILL, handler);</span><br><span class="line">    signal(SIGSEGV, handler);</span><br><span class="line">    signal(SIGFPE, handler);</span><br><span class="line">    signal(SIGBUS, handler);</span><br><span class="line">    signal(SIGPIPE, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> handleException(<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">    <span class="built_in">NSException</span> *customException = [<span class="built_in">NSException</span> exceptionWithName:[exception name] reason:[exception reason] userInfo:@&#123;kCaughtExceptionStackInfoKey: [exception callStackSymbols]&#125;];</span><br><span class="line">    [[YACrashHandlerManager sharedManager] performSelectorOnMainThread:<span class="keyword">@selector</span>(handleException:) withObject:customException waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> signalHandler(<span class="keyword">int</span> signal) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *stack = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>, getBacktrace()];</span><br><span class="line">    <span class="built_in">NSException</span> *customException = [<span class="built_in">NSException</span> exceptionWithName:kSignalExceptionName</span><br><span class="line">                                                           reason:[<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedString</span>(<span class="string">@"Signal %d was raised."</span>, <span class="literal">nil</span>), signal]</span><br><span class="line">                                                         userInfo:@&#123;kSignalKey:[<span class="built_in">NSNumber</span> numberWithInt:signal], kCaughtExceptionStackInfoKey: stack&#125;];</span><br><span class="line">    [[YACrashHandlerManager sharedManager] performSelectorOnMainThread:<span class="keyword">@selector</span>(handleException:) withObject:customException waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="è‡ªå®ç°"><a href="#è‡ªå®ç°" class="headerlink" title="è‡ªå®ç°"></a>è‡ªå®ç°</h2><p>è¿™ç¯‡æ–‡ç« æœ‰ç©ºå†™ä¸€ç‚¹ï¼Œç»“æœå‘å‡ºæ¥éƒ½12æœˆä»½äº†ã€‚å¤ªå¿™äº†ï¼Œholdä¸ä½ã€‚ã€‚ã€‚ç«‹ä¸ªflagï¼Œ2020å¹´Q1è‡ªå®ç°ä¸€ä¸ªRunloopã€‚</p><blockquote><p>ç½‘ä¸Šæœäº†å‡ ç¯‡å¾ˆæ£’çš„æ–‡ç« ï¼š<br><a href="http://blog.leichunfeng.com/blog/2015/07/29/ios-concurrency-programming-operation-queues/" target="_blank" rel="noopener">iOS å¹¶å‘ç¼–ç¨‹ä¹‹ Operation Queues</a><br><a href="http://dnduuhn.com/2018/12/02/iOS-å¤šçº¿ç¨‹ç¼–ç¨‹çŸ¥è¯†æ•´ç†/" target="_blank" rel="noopener">iOS å¤šçº¿ç¨‹ç¼–ç¨‹çŸ¥è¯†æ•´ç†</a><br><a href="http://dnduuhn.com/2018/12/11/iOS-å¤šçº¿ç¼–ç¨‹ä¹‹çº¿ç¨‹å®‰å…¨/" target="_blank" rel="noopener">iOS å¤šçº¿ç¼–ç¨‹ä¹‹çº¿ç¨‹å®‰å…¨</a><br><a href="http://zenonhuang.me/2018/03/08/technology/2018-03-01-LockForiOS/" target="_blank" rel="noopener">è°ˆ iOS çš„é”</a><br><a href="http://yulingtianxia.com/blog/2015/11/01/More-than-you-want-to-know-about-synchronized/" target="_blank" rel="noopener">@synchronizedï¼Œè¿™å„¿æ¯”ä½ æƒ³çŸ¥é“çš„è¿˜è¦å¤š</a><br><a href="http://yulingtianxia.com/blog/2017/09/17/Threading-Programming-Guide-2/" target="_blank" rel="noopener">Threading Programming Guide(2)</a><br><a href="http://zenonhuang.me/2018/04/17/technology/2018-04-17-Runloop/" target="_blank" rel="noopener">RunLoop æºç é˜…è¯»</a><br><a href="http://zhengtingi.cc/2017/02/20/RunLoop1/" target="_blank" rel="noopener">RunLoopæ·±å…¥å­¦ä¹ ç¬”è®°</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; å›é¡¾äº†å¤šçº¿ç¨‹ã€Runloopç›¸å…³çš„é‡ç‚¹çŸ¥è¯†ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>iOSä¸­çš„Crashé˜²æŠ¤</title>
    <link href="http://blog.chenyalun.com/2019/09/11/iOS%E4%B8%AD%E7%9A%84Crash%E9%98%B2%E6%8A%A4/"/>
    <id>http://blog.chenyalun.com/2019/09/11/iOSä¸­çš„Crashé˜²æŠ¤/</id>
    <published>2019-09-11T14:18:38.000Z</published>
    <updated>2019-10-27T08:13:47.446Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> é¿å…App crashã€‚ </p><a id="more"></a><p>Appçš„è´¨é‡è¯„æµ‹ä¸»è¦æœ‰ä¸¤ä¸ªå…³æ³¨ç‚¹ï¼Œä¸€ä¸ªæ˜¯Crashï¼Œå¦ä¸€ä¸ªæ˜¯å¡é¡¿ã€‚æ‰‹ç™¾å·²ç»å»ºç«‹äº†å¡é¡¿ç›‘æµ‹å¹³å°ï¼Œä¸»è¦æ˜¯é€šè¿‡ç›‘æµ‹ä¸»çº¿ç¨‹çš„Runloopçš„çŠ¶æ€åˆ‡æ¢è€—æ—¶å®ç°ã€‚å¯¹äºCrashåªåšäº†æ”¶é›†ï¼ŒåŠæ—¶æŠ¥å‘Šç»™ä¸ªä¸šåŠ¡æ–¹ï¼Œä½†å¹¶æ²¡æœ‰â€œé˜²æŠ¤â€å¹³å°ï¼ˆè²Œä¼¼ç”±äºç§ç§åŸå› ç›®å‰è¿˜æ²¡æœ‰å®Œæˆï¼‰ã€‚å‡å¦‚éœ€è¦åšä¸€ä¸ªç®€å•çš„crashé˜²æŠ¤æªæ–½ï¼Œè¯¥æ€ä¹ˆç€æ‰‹å‘¢ï¼Ÿ</p><p><a href="https://neyoufan.github.io/2017/01/13/ios/BayMax_HTSafetyGuard/" target="_blank" rel="noopener">ã€Šå¤§ç™½å¥åº·ç³»ç»Ÿâ€“iOS APPè¿è¡Œæ—¶Crashè‡ªåŠ¨ä¿®å¤ç³»ç»Ÿã€‹</a>è¿™ç¯‡æ–‡ç« æ€»ç»“åœ°å¾ˆä¸é”™äº†ï¼Œç½‘ä¸Šå¾ˆå¤šç»„ä»¶éƒ½æ˜¯æ ¹æ®è¿™ç¯‡æ–‡ç« å¼€å‘çš„ï¼ˆæ‰‹ç™¾å†…éƒ¨ä¹Ÿæœ‰å‚è€ƒï¼‰ã€‚æœ¬æ–‡åœ¨å‰è¾ˆä»¬çš„åŸºç¡€ä¸Šï¼Œç®€å•å™è¿°ä¸‹è‡ªå·±çš„æƒ³æ³•ã€‚</p><h1 id="ä¸€ã€å¸¸è§Crashç±»å‹"><a href="#ä¸€ã€å¸¸è§Crashç±»å‹" class="headerlink" title="ä¸€ã€å¸¸è§Crashç±»å‹"></a>ä¸€ã€å¸¸è§Crashç±»å‹</h1><h2 id="1-unrecognized-selector-crash"><a href="#1-unrecognized-selector-crash" class="headerlink" title="1. unrecognized selector crash"></a>1. unrecognized selector crash</h2><p><code>unrecognized selector sent to instance</code>ç±»å‹çš„crashæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼ŒåŸå› æ˜¯æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•çš„å®ç°ã€‚H5ä¸NAäº¤äº’æ—¶ï¼Œåˆ«äººéš¾å…ä¼šè°ƒé”™ï¼›é¡¹ç›®åœ¨åˆå¹¶åˆ†æ”¯ã€é‡æ„ç­‰å¤§æ”¹åŠ¨çš„æ—¶å€™ä¹Ÿéš¾å…ä¸å°å¿ƒæŠŠæ–¹æ³•çš„å®ç°åˆ æ‰äº†ï¼ˆè¿™ç§æƒ…å†µä¿ºé‡åˆ°å¥½å¤šæ¬¡äº†==ï¼‰ã€‚è¿™ç±»crashçš„é˜²æŠ¤æ˜¯æœ€æœ‰æ„ä¹‰çš„ï¼Œä¸€æ¥è§£å†³äº†ä½“éªŒé—®é¢˜ï¼ŒäºŒæ¥åªæ˜¯æ·»åŠ ä¸€ä¸ªå•çº¯çš„å®ç°ï¼Œä¸€èˆ¬ä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½å’Œæ•°æ®ã€‚</p><p>æ ¹æ®æ¶ˆæ¯æœºåˆ¶ï¼ŒresolveInstanceMethodéœ€è¦åœ¨ç±»ä¸­æå‰åŠ ä¸Šï¼Œç•¥æ˜¾å†—ä½™ï¼›forwardInvocationéœ€è¦åˆ›å»ºNSInvocationï¼Œå¼€é”€è¾ƒå¤§ä¸”å¸¸è¢«å¤–ç•Œé‡å†™ä»¥è½¬å‘æ¶ˆæ¯ã€‚<a href="https://neyoufan.github.io/2017/01/13/ios/BayMax_HTSafetyGuard/" target="_blank" rel="noopener">æœ€é€‚åˆçš„è¿˜æ˜¯forwardingTargetForSelector</a>ã€‚</p><p>éœ€è¦è€ƒè™‘çš„æœ‰ï¼š</p><ol><li>é˜²æŠ¤å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚</li><li>é˜²æŠ¤çš„æ–¹æ³•è¦å¯ä¾›é€‰æ‹©ï¼Œå¦‚ç™½åå•ï¼Œæˆ–è€…å‰ç¼€ç­‰ï¼ˆé¿å…å½±å“å…¶ä»–ä¸šåŠ¡æ–¹ï¼‰ã€‚</li><li>è·å–crashçš„å‡½æ•°è°ƒç”¨æ ˆä»¥ä¾›è¿½è¸ªã€‚</li><li>ä¸èƒ½å½±å“å·²é‡å†™äº†<code>forwardInvocation:</code>æ–¹æ³•ï¼ˆå«å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ï¼‰çš„ç±»ã€‚</li></ol><p>ç¬¬ä¸€æ¡ï¼Œæ–¹æ³•äº¤æ¢æ—¶ä¼ å…¥ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡å³å¯ï¼›<br>ç¬¬äºŒæ¡ï¼Œå¯ä»¥è·å–å½“å‰çš„classStringè¿›è¡Œå®šåˆ¶åŒ–åˆ¤æ–­ï¼›<br>ç¬¬ä¸‰æ¡ï¼Œ<code>[NSThread callStackSymbols]</code>å¯ä»¥è·å–è°ƒç”¨æ ˆï¼›<br>ç¬¬å››æ¡ï¼Œå¯ä»¥å‚è€ƒKVOä¸­åˆ¤æ–­<code>willChangeValueForKey:</code>æ˜¯å¦å·²è¢«é‡å†™çš„é€»è¾‘â€”<a href="https://blog.chenyalun.com/2019/05/31/Key-Value%20Observingæºç åˆæ¢/">æ¯”è¾ƒIMPæ˜¯å¦ä¸€è‡´</a>ã€‚ä¹Ÿå³æ¯”è¾ƒNSObjectå’Œå½“å‰ç±»ä¸­çš„<code>forwardInvocation:</code>æ–¹æ³•çš„IMPæ˜¯å¦ä¸€è‡´ï¼›å½“ç„¶ï¼Œéœ€è¦å¯¹<code>-forwardInvocation:</code>å’Œ<code>+forwardInvocation:</code>åŒºåˆ†ï¼›</p><p>è¿™æ ·ï¼Œé¦–å…ˆæ·»åŠ ä¸€ä¸ªç»§æ‰¿è‡ªNSObjectçš„targetï¼Œé‡å†™resolveInstanceMethodå’ŒresolveClassMethodä»¥æ·»åŠ ç©ºç™½çš„æ–¹æ³•å®ç°ï¼š<code>forwardingTargetDynamicMethod</code>ã€‚è¿™é‡Œä¹Ÿæ˜¯è·å–è°ƒç”¨æ ˆçš„å¥½æ—¶æœºï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#define kYACurrentCallStackSymbols [NSString stringWithFormat:@<span class="meta-string">"%@"</span>,[NSThread callStackSymbols]]</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAForwardingTarget</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAForwardingTarget</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> forwardingTargetDynamicMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;&#125;</span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    class_addMethod(<span class="keyword">self</span>.class, sel, (IMP)forwardingTargetDynamicMethod, <span class="string">"v@:"</span>);</span><br><span class="line">    [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Unrecognized instance Method: %@\nè°ƒç”¨æ ˆæ˜¯:%@"</span>, <span class="built_in">NSStringFromSelector</span>(sel), kYACurrentCallStackSymbols);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel &#123;</span><br><span class="line">    class_addMethod(object_getClass(<span class="keyword">self</span>), sel, (IMP)forwardingTargetDynamicMethod, <span class="string">"v@:"</span>);</span><br><span class="line">    [class_getSuperclass(<span class="keyword">self</span>) resolveClassMethod:sel];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Unrecognized class Method: %@\nè°ƒç”¨æ ˆæ˜¯:%@"</span>, <span class="built_in">NSStringFromSelector</span>(sel), kYACurrentCallStackSymbols);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>åˆ©ç”¨æ–¹æ³•äº¤æ¢ï¼Œåœ¨NSObjectçš„åˆ†ç±»ä¸­hook <code>forwardingTargetForSelector:</code>æ–¹æ³•å¤„ç†è½¬å‘é€»è¾‘ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">YAResolveUnrecognizedSelector</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">YAResolveUnrecognizedSelector</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        ya_methodSwizzle(<span class="keyword">self</span>.class, <span class="keyword">@selector</span>(forwardingTargetForSelector:), <span class="keyword">@selector</span>(swizzleForwardingTargetForSelector:));</span><br><span class="line">        ya_methodSwizzle(object_getClass(<span class="keyword">self</span>), <span class="keyword">@selector</span>(forwardingTargetForSelector:), <span class="keyword">@selector</span>(swizzleForwardingTargetForSelector:));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#define swizzleForwardingTargetForSelector(arg) \</span></span><br><span class="line">arg (<span class="keyword">id</span>)swizzleForwardingTargetForSelector:(SEL)aSelector &#123; \</span><br><span class="line">    <span class="keyword">id</span> result = [<span class="keyword">self</span> swizzleForwardingTargetForSelector:aSelector]; \</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result; \</span><br><span class="line">    <span class="built_in">NSString</span> *classString = <span class="built_in">NSStringFromClass</span>(object_getClass(<span class="keyword">self</span>)); \</span><br><span class="line">    <span class="built_in">BOOL</span> isClsMethod = [@<span class="meta">#arg isEqualToString:@<span class="meta-string">"+"</span>]; /* åŒºåˆ†ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³• */\</span></span><br><span class="line">    Class currCls = isClsMethod ? object_getClass(<span class="keyword">self</span>) : <span class="keyword">self</span>.class;\</span><br><span class="line">    Class oriCls = isClsMethod ? object_getClass(<span class="built_in">NSObject</span>.class) : <span class="built_in">NSObject</span>.class;\</span><br><span class="line">    IMP currentImp = class_getMethodImplementation_stret(currCls, <span class="keyword">@selector</span>(forwardInvocation:));\</span><br><span class="line">    IMP originImp = class_getMethodImplementation_stret(oriCls, <span class="keyword">@selector</span>(forwardInvocation:));\</span><br><span class="line">    <span class="comment">/* ä¹Ÿå¯ä»¥æ·»åŠ ç™½åå•. */</span> \</span><br><span class="line">    <span class="keyword">if</span> ([classString hasPrefix:<span class="string">@"YA"</span>] &amp;&amp; currentImp == originImp) &#123; \</span><br><span class="line">        <span class="comment">/* é¿å…crash. */</span>\</span><br><span class="line">        <span class="keyword">return</span> isClsMethod ? YAForwardingTarget.class : [YAForwardingTarget new]; \</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; \</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">/* æŠ›å‡ºå¼‚å¸¸. */</span> \</span><br><span class="line">    &#125; \</span><br><span class="line">&#125; \</span><br><span class="line"></span><br><span class="line"><span class="comment">// Class method and instance method.</span></span><br><span class="line">swizzleForwardingTargetForSelector(+)</span><br><span class="line">swizzleForwardingTargetForSelector(-)</span><br><span class="line"><span class="meta">#undef swizzleForwardingTargetForSelector</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>åœ¨è·å–åˆ°classStringæ—¶ï¼Œå¯ä»¥æ ¹æ®ä¸‹å‘çš„ç™½åå•åˆ¤æ–­æ˜¯å¦éœ€è¦é˜²æŠ¤ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åˆ¤æ–­å‰ç¼€ï¼Œåªé˜²æŠ¤è‡ªå·±ä¸šåŠ¡çš„æ–¹æ³•ã€‚</p><h2 id="2-å®¹å™¨-crash"><a href="#2-å®¹å™¨-crash" class="headerlink" title="2. å®¹å™¨ crash"></a>2. å®¹å™¨ crash</h2><p>å†ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„å°±æ˜¯å®¹å™¨crashï¼Œæ¯”å¦‚å‘NSMutableArrayä¸­æ·»åŠ ç©ºå…ƒç´ æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ç§crashçœ‹ä¼¼å¾ˆä½çº§ï¼Œä½†å´é˜²ä¸èƒœé˜²ã€‚å½“å‘ä¸€ä¸ªæ•°ç»„ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œéœ€è¦ç”±å¼€å‘è€…è€ƒè™‘è¿™ä¸ªå…ƒç´ æœ‰æ²¡æœ‰å¯èƒ½ä¸ºç©ºï¼Œå¦‚æœæœ‰ï¼Œåšç©ºå€¼åˆ¤æ–­ï¼›å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥æ·»åŠ å³å¯ã€‚ä½†æ˜¯è¿™ç§â€œè€ƒè™‘â€å¾€å¾€ä¸æ˜¯ç™¾åˆ†ç™¾å¯é çš„ã€‚æœ€ä¿é™©çš„åŠæ³•æ˜¯å¯¹æ‰€æœ‰è¢«æ·»åŠ çš„å…ƒç´ éƒ½åšç©ºå€¼åˆ¤æ–­ï¼Œå¯æ˜¯é¡¹ç›®ä¸­çš„å®¹å™¨ä½•å…¶å¤šï¼Œæ¯æ¬¡éƒ½è¦ifåˆ¤æ–­ï¼Œæ˜¯å¦æœ‰æ€§èƒ½æ–¹é¢çš„å½±å“å‘¢ï¼Ÿè¿™å°±æ˜¯å¦ä¸€ç§æƒè¡¡äº†ã€‚</p><p>ç°åœ¨ä¸è€ƒè™‘é‚£ä¹ˆå¤šï¼Œå‡å®šéœ€è¦å¯¹NSMutableArrayçš„addObjectåšé˜²æŠ¤ï¼Œæœ€ç®€å•çš„æ˜¯æ·»åŠ ä¸€ä¸ªsafeæ–¹æ³•ï¼š<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@implementation</span> NSMutableArray (YAResolveNilObject)</span><br><span class="line">- (void)<span class="attribute">ya_addObject</span>:(id)anObject &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (anObject) &#123;</span><br><span class="line">        <span class="selector-attr">[self addObject:anObject]</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p><p>ä¹‹åä½¿ç”¨æ—¶åªéœ€è¦ä½¿ç”¨<code>ya_addObject:</code>å°±è¡Œäº†ã€‚å½“ç„¶æœ€ä¼˜é›…çš„è¿˜æ˜¯è¿›è¡Œhookï¼Œè®©å¤–ç•Œç»§ç»­ä½¿ç”¨åŸç”Ÿæ–¹æ³•ï¼š<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@implementation</span> NSMutableArray (YAResolveNilObject)</span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    <span class="selector-tag">static</span> <span class="selector-tag">dispatch_once_t</span> <span class="selector-tag">onceToken</span>;</span><br><span class="line">    <span class="selector-tag">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="selector-tag">ya_methodSwizzle</span>(NSClassFromString(@<span class="string">"__NSArrayM"</span>), <span class="variable">@selector</span>(<span class="attribute">addObject</span>:), <span class="variable">@selector</span>(<span class="attribute">ya_addObject</span>:));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">ya_addObject</span><span class="selector-pseudo">:(id)anObject</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (anObject) &#123;</span><br><span class="line">        <span class="selector-attr">[self ya_addObject:anObject]</span>;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="selector-tag">NSLog</span>(@<span class="string">"é˜²æŠ¤äº†"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure></p><p>éœ€è¦æ³¨æ„çš„æ˜¯Arrayç³»åˆ—æ˜¯ç±»ç°‡ï¼Œç›´æ¥hook NSMutableArrayæ˜¯æ— æ³•æˆåŠŸçš„ï¼Œéœ€è¦hookå¯¹å¤–éšè—çš„å®é™…èµ·ä½œç”¨çš„ç±»ï¼š<code>__NSArrayM</code>ã€‚è¿˜æœ‰å°±æ˜¯å¦‚æœè¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„è¯ï¼Œè‡ªå·±å†é€šè¿‡åŠ é”æ¥ä¿è¯ï¼ˆè¿™ç§caseè¾ƒå°‘ï¼Œå»ºè®®å•ç‹¬å†™ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„addObjectï¼Œä¸€è‚¡è„‘å…¨éƒ½åŠ é”å®åœ¨æ²¡æœ‰å¿…è¦ï¼‰ã€‚ä¸ç„¶ <code>if (anObject)</code>åˆ¤æ–­æ—¶å‘ç°ä¸º<code>YES</code>ï¼Œè€Œåˆ°<code>addObject:</code>æ—¶ï¼ŒanObjectåˆä¸ºç©ºäº†ï¼Œååˆ†å°´å°¬ã€‚</p><p>é™¤äº†addObjectæ—¶çš„åˆ¤ç©ºï¼Œè¿˜æœ‰objectAtIndexæ—¶çš„rangeåˆ¤æ–­ï¼Œä¹Ÿéœ€è¦å¤„ç†ã€‚</p><p>NSMutableArrayæ˜¯è¿™æ ·ï¼Œé‚£NSMutableSetã€NSMutableDictionaryã€NSCacheç­‰ç±»ä¹Ÿå¥½è¯´äº†ã€‚</p><h2 id="3-KVO-crash"><a href="#3-KVO-crash" class="headerlink" title="3. KVO crash"></a>3. KVO crash</h2><p>KVOå¼•èµ·crashæœ‰ä¸¤ç§åœºæ™¯ï¼š<br>1ï¼Œobserverå·²ç»é”€æ¯ï¼Œä½†æ˜¯æœªåŠæ—¶ç§»é™¤ç›‘å¬ï¼›<br>2ï¼ŒaddObserverä¸removeObserverä¸åŒ¹é…ï¼ˆé‡å¤æ·»åŠ æˆ–ç§»é™¤ã€æ²¡æœ‰æ·»åŠ å´ç§»é™¤ç­‰ï¼‰ï¼›</p><h3 id="é¢„é˜²"><a href="#é¢„é˜²" class="headerlink" title="é¢„é˜²"></a>é¢„é˜²</h3><p>ä»â€œé¢„é˜²â€å±‚é¢è®²ï¼Œå¯ä»¥ä½¿ç”¨KVOçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼š<a href="https://github.com/facebook/KVOController" target="_blank" rel="noopener">KVOController</a>ã€‚<br>1ï¼Œä½¿ç”¨å•ä¾‹æ¥ç®¡äº†ç³»ç»Ÿçš„observeValueForKeyPathæ–¹æ³•ï¼Œé€šè¿‡å®ƒå†æ¥åˆ†å‘è°ƒç”¨ã€‚å¦‚æœobserverå·²ç»é”€æ¯ï¼Œåˆ™ä¸å†å›è°ƒï¼ˆblockï¼‰ï¼Œè§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼›<br>2ï¼Œåªæœ‰addObserveræ¥å£ï¼Œå…¶å†…éƒ¨ä¾èµ–å®¹å™¨é¿å…å¤–ç•Œé‡å¤addObserverï¼Œæ²¡æœ‰æš´éœ²removeObserveræ¥å£ï¼Œè§£å†³äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼›</p><p>è€Œä¸”KVOControlleræå…¶ä¼˜é›…ï¼Œåªè°ƒç”¨ä¸€ä¸ªæ–¹æ³•å°±å¯ä»¥å®Œæˆä¸€ä¸ªå¯¹è±¡çš„é”®å€¼è§‚æµ‹ã€‚æ›´å¤šä»‹ç»å¯ä»¥æŸ¥çœ‹dravenesså¤§ç¥çš„æ–‡ç« ï¼š<a href="https://draveness.me/kvocontroller" target="_blank" rel="noopener">ã€Šå¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨ KVOã€‹</a>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç®€å•å‚è€ƒä¸‹ä¿ºå†™çš„æ°´æ–‡<a href="https://blog.chenyalun.com/2019/01/12/ã€ŒKVOControllerã€çš„å°è£…/">ã€Šã€ŒKVOControllerã€çš„å°è£…ã€‹</a>ã€‚</p><h3 id="é˜²æŠ¤"><a href="#é˜²æŠ¤" class="headerlink" title="é˜²æŠ¤"></a>é˜²æŠ¤</h3><p>å¥½äº†ï¼Œé¢„é˜²å±‚é¢æœ‰åŠæ³•è§£å†³äº†ï¼Œé‚£é˜²æŠ¤å±‚é¢å‘¢ï¼Ÿâ€œobserverå·²ç»é”€æ¯ï¼Œä½†æ˜¯æœªåŠæ—¶ç§»é™¤ç›‘å¬â€ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜å¾ˆè‡ªç„¶åœ°æƒ³åˆ°åœ¨observerçš„deallocæ–¹æ³•ä¸­åšç§»é™¤ç›‘å¬æ“ä½œã€‚è¿™ç§åšæ³•çš„æ€è·¯æ˜¯ï¼š<br>1ï¼Œ hook addObserveræ–¹æ³•ï¼Œobjectä¸ºkeyï¼ŒkeyPathæ•°ç»„ä½œä¸ºvalueï¼Œä¸observerå»ºç«‹å…³ç³»ï¼Œå¤§è‡´æ˜¯è¿™ç§ç»“æ„ï¼š<br><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">observer1:</span> &#123;</span><br><span class="line"><span class="symbol">    object1:</span> [<span class="string">"keyPath1"</span>, <span class="string">"keyPath2"</span>], </span><br><span class="line"><span class="symbol">    object2:</span> [<span class="string">"keyPath3"</span>, <span class="string">"keyPath4"</span>],</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="symbol">observer2:</span> &#123;</span><br><span class="line"><span class="symbol">    object3:</span> [<span class="string">"keyPath5"</span>, <span class="string">"keyPath6"</span>], </span><br><span class="line"><span class="symbol">    object4:</span> [<span class="string">"keyPath7"</span>, <span class="string">"keyPath8"</span>],</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2ï¼Œ hook observerçš„deallocæ–¹æ³•ï¼Œåœ¨è¿™é‡Œé¢é€ä¸ªç§»é™¤objectçš„keyPathç›‘å¬ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// observer1</span></span><br><span class="line">[object1 <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>keyPath1];</span><br><span class="line">[object1 <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>keyPath2];</span><br><span class="line">[object2 <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>keyPath3];</span><br><span class="line">[object2 <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>keyPath4];</span><br><span class="line"></span><br><span class="line"><span class="comment">// observer2</span></span><br><span class="line"><span class="comment">/// ...</span></span><br></pre></td></tr></table></figure></p><p>å…·ä½“ä»£ç å®ç°å±‚é¢ï¼ŒNSMapTableå¯ä»¥æ”¯æŒç›´æ¥ä½¿ç”¨å¯¹è±¡ï¼ˆobjectï¼‰ä½œä¸ºkeyï¼›keyPathçš„é‡å¤è¿‡æ»¤å¯ä»¥ä½¿ç”¨NSMutableSetï¼›å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—ä½åˆ¤æ–­æ˜¯å¦é‡å¤æ·»åŠ æˆ–è€…ç§»é™¤ï¼›</p><p>hookåçš„addObserveræ–¹æ³•ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_addObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">context:</span>(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    BOOL shouldAddObserver = YES;</span><br><span class="line">    NSString *observerKey = [NSString <span class="string">stringWithFormat:</span>@<span class="string">"%p"</span>, observer];</span><br><span class="line">    <span class="keyword">if</span> (!mainMap) &#123;</span><br><span class="line">        mainMap = [NSMutableDictionary dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSMapTable *subMap = [mainMap <span class="string">objectForKey:</span>observerKey];</span><br><span class="line">    <span class="keyword">if</span> (!subMap) &#123;</span><br><span class="line">        subMap = [NSMapTable strongToStrongObjectsMapTable];</span><br><span class="line">        NSMutableSet *set = [NSMutableSet <span class="string">setWithObject:</span>keyPath];</span><br><span class="line">        [subMap <span class="string">setObject:</span>set <span class="string">forKey:</span>self];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        NSMutableSet *set = [subMap <span class="string">objectForKey:</span>self];</span><br><span class="line">        <span class="keyword">if</span> ([set <span class="string">containsObject:</span>keyPath]) &#123;</span><br><span class="line">            <span class="comment">// é‡å¤addObserver</span></span><br><span class="line">            shouldAddObserver = NO;</span><br><span class="line">        &#125;</span><br><span class="line">        [set <span class="string">addObject:</span>keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">    [mainMap <span class="string">setObject:</span>subMap <span class="string">forKey:</span>observerKey];</span><br><span class="line">    <span class="keyword">if</span> (shouldAddObserver) &#123;</span><br><span class="line">        [self <span class="string">ya_addObserver:</span>observer <span class="string">forKeyPath:</span>keyPath <span class="string">options:</span>options <span class="string">context:</span>context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åŒç†ï¼ŒremoveObserveråŸç†å¤§è‡´ç›¸åŒï¼Œå°±ä¸å†å¤è¿°äº†ã€‚</p><p>hookåçš„deallocæ–¹æ³•ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_dealloc &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selfKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p"</span>, <span class="keyword">self</span>];</span><br><span class="line">    <span class="built_in">NSMapTable</span> *subMap = [mainMap objectForKey:selfKey];</span><br><span class="line">    <span class="keyword">if</span> (subMap) &#123;</span><br><span class="line">        [[[subMap keyEnumerator] allObjects] enumerateObjectsUsingBlock:^(<span class="keyword">id</span> object, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">          <span class="built_in">NSSet</span> *set = [subMap objectForKey:object];</span><br><span class="line">          [set enumerateObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">              [object removeObserver:<span class="keyword">self</span> forKeyPath:key];</span><br><span class="line">          &#125;];</span><br><span class="line">          <span class="comment">// ç§»é™¤keyPath</span></span><br><span class="line">          [subMap removeObjectForKey:object];</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="comment">// ç§»é™¤subMap</span></span><br><span class="line">        [mainMap removeObjectForKey:selfKey];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> ya_dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯è¿™ç§æ–¹å¼æœ‰ä¸ªé—®é¢˜ï¼šhook deallocæ–¹æ³•é£é™©æå¤§ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å…³ä¹Appä¸­æ‰€æœ‰å¯¹è±¡çš„é‡Šæ”¾ï¼Œä»£ç ä¸€æ—¦æœ‰ç‘•ç–µï¼Œåæœä¸å ªè®¾æƒ³ã€‚å­çº¿ç¨‹è°ƒç”¨ã€hookæ–¹å¼æ­£ç¡®ä¸å¦éƒ½ä¼šäº§ç”Ÿ<a href="https://www.valiantcat.cn/index.php/2017/11/03/53.html" target="_blank" rel="noopener">æ½œåœ¨çš„é£é™©</a>ï¼Œåº”è¯¥å°½é‡é¿å…è¿™ç§é£é™©æå¤§çš„æ“ä½œã€‚é‚£è¿˜æœ‰å…¶ä»–æ–¹å¼èƒ½åœ¨å¯¹è±¡é”€æ¯ä¹‹å‰åšç‚¹äº‹å—ï¼Ÿæœ‰çš„ã€‚å…³è”å¯¹è±¡ã€‚<br>ä¸€ä¸ªå¯¹è±¡åœ¨deallocä¹‹å‰ä¼šç§»é™¤è‡ªå·±çš„æ‰€æœ‰å…³è”å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶ä½œä¸ºNSObjectçš„å…³è”å¯¹è±¡ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªè‡ªå®šä¹‰å¯¹è±¡çš„deallocæ–¹æ³•ä¸­åšä¸Šé¢çš„æ“ä½œã€‚ä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨ï¼Œè‡ªå®šä¹‰çš„å¯¹è±¡ä¸èƒ½å¼ºå¼•ç”¨NSObjectï¼Œä½†æ˜¯ä½¿ç”¨weakçš„è¯ï¼Œåœ¨å®è·µä¸­ä¼šå‘ç°è¢«å…³è”çš„NSObjectå·²ç»é”€æ¯äº†ï¼Œæ ¹æœ¬è·å–ä¸åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>unsafe_unretained</code>ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// è¢«å…³è”çš„å¯¹è±¡</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKVOInfoObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">// æ³¨æ„ä½¿ç”¨unsafe_unretainedä¿®é¥°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">unsafe_unretained</span>) <span class="keyword">id</span> object;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKVOInfoObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">id</span> observer = <span class="keyword">self</span>.object;</span><br><span class="line">        <span class="built_in">NSString</span> *observerKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p"</span>, observer];</span><br><span class="line">        <span class="built_in">NSMapTable</span> *subMap = [mainMap objectForKey:observerKey];</span><br><span class="line">        <span class="keyword">if</span> (subMap) &#123;</span><br><span class="line">          [[[subMap keyEnumerator] allObjects] enumerateObjectsUsingBlock:^(<span class="keyword">id</span> object, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="built_in">NSSet</span> *set = [subMap objectForKey:object];</span><br><span class="line">            [set enumerateObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">                [object removeObserver:observer forKeyPath:key];</span><br><span class="line">            &#125;];</span><br><span class="line">            <span class="comment">// ç§»é™¤keyPath</span></span><br><span class="line">            [subMap removeObjectForKey:object];</span><br><span class="line">          &#125;];</span><br><span class="line">          <span class="comment">// ç§»é™¤subMap</span></span><br><span class="line">          [mainMap removeObjectForKey:observerKey];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// åˆ†ç±»ï¼Œç”¨äºè®¾ç½®å…³è”å¯¹è±¡</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">YAKVOInfoObject</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)ya_setKVOInfoObject:(YAKVOInfoObject *)object &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="string">"ya_kVOInfoObject"</span>, object, OBJC_ASSOCIATION_RETAIN);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>è¿™æ ·ä¸€æ¥ä¼¼ä¹æ›´ä½“é¢ä¸€ç‚¹äº†ï¼Œè®¾ç½®å…³è”å¯¹è±¡çš„æ—¶æœºè‡ªç„¶æ˜¯åœ¨æˆåŠŸaddObserverçš„æ—¶å€™ï¼Œè€Œä¸”æ¯ä¸ªå¯¹è±¡åªéœ€è¦è®¾ç½®ä¸€æ¬¡å³å¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºéœ€è¦ä¸¥æ ¼ä¾èµ–observerçš„deallocæ–¹æ³•ï¼Œå¦‚æœç³»ç»Ÿçš„è‡ªåŠ¨é‡Šæ”¾æ± å‡ºç°äº†å»¶æ—¶é‡Šæ”¾ï¼Œä¼šå¯¼è‡´observerè¢«é”€æ¯ä¹‹åè¿‡ä¸€æ®µæ—¶é—´å…³è”å¯¹è±¡æ‰ä¼šé‡Šæ”¾ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>unsafe_unretained</code>è®¿é—®çš„å°±æ˜¯éæ³•åœ°å€ã€‚æ‰€ä»¥éœ€è¦åœ¨å…³è”å¯¹è±¡çš„deallocæ–¹æ³•ä¸­æ·»åŠ ä¸Šè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸€ç‚¹æˆ‘ç¡®å®æ²¡æœ‰æƒ³åˆ°ï¼Œè¯·å‚è€ƒ<a href="https://www.valiantcat.cn/index.php/2017/11/03/53.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p><p>åˆ°è¿™é‡Œï¼ŒremoveObserverçš„æ—¶æœºå·²ç»æå®šäº†ï¼Œè‡³äºå¯¹è¿™äº›keyPathå’Œobjectçš„ä¿å­˜ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢çš„ä»£ç ä½¿ç”¨å…¨å±€çš„å®¹å™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨å…³è”å¯¹è±¡YAKVOInfoObjectä¸­å­˜å‚¨ã€‚è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œæ˜¯ä½¿ç”¨ä»£ç†ï¼Œä¸è¿‡æˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œè¦æ˜¯ä½¿ç”¨ä»£ç†ï¼Œé¦–å…ˆè¦è®¾ç½®observerçš„delegateä¸ºobjectï¼Œç„¶åè¿˜è¦åœ¨observeré”€æ¯çš„æ—¶å€™ç§»é™¤delegateï¼ˆä¹Ÿå°±æ˜¯objectï¼‰çš„keyPathç›‘å¬ï¼Œä½†æ˜¯keyPathéœ€è¦ä¿å­˜ï¼Œobserveré”€æ¯çš„æ—¶æœºåŒæ ·éœ€è¦hookï¼Œä¼¼ä¹observerä¸objectåªæ˜¯å¤šäº†ä¸€å±‚ç›´æ¥è”ç³»ï¼Œå¹¶ä¸”æŠŠç»“æ„æå¾—æ›´åŠ å¤æ‚äº†ã€‚ã€‚ã€‚</p><p>è‡³äºæœªåŠæ—¶ç§»é™¤NSNotificationCenterçš„ç›‘å¬äº§ç”Ÿçš„crashåœ¨iOS9ä¹‹åå·²ç»ä¸å­˜åœ¨äº†ï¼Œè€Œä¸”æˆ‘åœ¨<a href="https://blog.chenyalun.com/2019/01/28/NSNotificationCenteræ¢ç´¢/">ã€ŠNSNotificationCenteræ¢ç´¢ã€‹</a>è¿™ç¯‡æ–‡ç« ä¸­è¿˜åˆ©ç”¨å¼±å¼•ç”¨å®¹å™¨ç®€å•å®ç°äº†ä¸ªdemoï¼Œå³ä¾¿ä¸ç§»é™¤ä¹Ÿä¸ä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œä½œä¸ºç»ƒä¹ ä¹‹ç”¨ã€‚ç›®å‰Appçš„æœ€ä½ç‰ˆæœ¬å·²ç»æ˜¯iOS9äº†ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®addObserveråèƒ½æœ‰å¯¹åº”çš„removeObserverï¼Œæœ‰å¤´æœ‰å°¾ï¼Œä¸¥è°¨ä¸€äº›ã€‚å½“ç„¶ï¼Œè¦æ˜¯é“äº†å¿ƒéè¦å¯¹å®ƒåŠ ä¸Šé˜²æŠ¤ï¼ŒåŸç†ä¸KVOè¿™ä¸ªç±»ä¼¼ï¼Œæˆ–è€…è¯´æ›´ç®€å•äº†ï¼Œæ¯•ç«Ÿä¸éœ€è¦ä¿å­˜keyPathã€objectä¹‹ç±»çš„ã€‚</p><h2 id="4-NSTimer-crash"><a href="#4-NSTimer-crash" class="headerlink" title="4. NSTimer crash"></a>4. NSTimer crash</h2><p>NSTimerä¼šå¼ºå¼•ç”¨ç€targetï¼Œtargetå¾€å¾€ä¹Ÿéœ€è¦å¼ºå¼•ç”¨ç€NSTimerï¼Œå®¹æ˜“äº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Œå¼•å‘å†…å­˜æ³„æ¼è¿›è€Œå¯èƒ½äº§ç”Ÿcrashé—®é¢˜ï¼ˆpsï¼šCADisplayLinkåŒç†ï¼Œæ¨èä½¿ç”¨ä¸ä¾èµ–Runloopæ›´å‡†æ—¶çš„dispatch_source_tï¼‰ã€‚</p><p>å¯ä»¥ä¸¾ä¸ªå¾ªç¯å¼•ç”¨çš„ä¾‹å­ï¼šæ§åˆ¶å™¨å¼ºå¼•ç”¨ç€YASingerå¯¹è±¡ï¼ŒYASingerå¯¹è±¡å¼ºå¼•ç”¨ç€NSTimerã€‚å½“æ§åˆ¶å™¨è°ƒç”¨<code>self.singer = nil;</code>çš„æ—¶å€™ï¼Œä¼šå‘ç°singæ–¹æ³•ä¾ç„¶åœ¨ä¸åœè°ƒç”¨ã€‚å¯è§ï¼ŒNSTimerå†…éƒ¨åˆå¼ºå¼•ç”¨ç€YASingerå¯¹è±¡ï¼ŒäºŒè€…æ˜¯å¾ªç¯å¼•ç”¨ï¼Œæ§åˆ¶å™¨æŠŠYASingerå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡1å¹¶ä¸èƒ½ä½¿å¾—å®ƒåŠæ—¶é”€æ¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YASinger</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YASinger</span></span></span><br><span class="line">- (<span class="keyword">void</span>)sing &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"YASinger  show"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span>.timer invalidate];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startTask &#123;</span><br><span class="line">    YASinger *singer = [YASinger new];</span><br><span class="line">    singer.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1</span> target:singer selector:<span class="keyword">@selector</span>(sing) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    <span class="keyword">self</span>.singer = singer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸€èˆ¬è§£å†³NSTimerçš„å¾ªç¯å¼•ç”¨é—®é¢˜æœ‰ä¸‰ç§æ–¹æ³•ã€‚</strong></p><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><p><strong>ä½¿ç”¨blockä½œä¸ºä¸­é—´ä»¶ï¼Œå¯ä»¥å‚è€ƒBlocksKit2.2.5çš„å®ç°ï¼š</strong><br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSTimer</span> (<span class="title">BlocksKit</span>)</span></span><br><span class="line">+ (<span class="keyword">id</span>)bk_scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)inTimeInterval block:(<span class="keyword">void</span> (^)(<span class="built_in">NSTimer</span> *timer))block repeats:(<span class="built_in">BOOL</span>)inRepeats</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NSParameterAssert</span>(block != <span class="literal">nil</span>);</span><br><span class="line"><span class="keyword">return</span> [<span class="keyword">self</span> scheduledTimerWithTimeInterval:inTimeInterval target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(bk_executeBlockFromTimer:) userInfo:[block <span class="keyword">copy</span>] repeats:inRepeats];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)bk_timerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)inTimeInterval block:(<span class="keyword">void</span> (^)(<span class="built_in">NSTimer</span> *timer))block repeats:(<span class="built_in">BOOL</span>)inRepeats</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NSParameterAssert</span>(block != <span class="literal">nil</span>);</span><br><span class="line"><span class="keyword">return</span> [<span class="keyword">self</span> timerWithTimeInterval:inTimeInterval target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(bk_executeBlockFromTimer:) userInfo:[block <span class="keyword">copy</span>] repeats:inRepeats];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)bk_executeBlockFromTimer:(<span class="built_in">NSTimer</span> *)aTimer &#123;</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="built_in">NSTimer</span> *) = [aTimer userInfo];</span><br><span class="line"><span class="keyword">if</span> (block) block(aTimer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>NSTimerå®ä¾‹å¯¹è±¡ç›´æ¥å¼ºå¼•ç”¨ç€NSTimerçš„ç±»å¯¹è±¡ï¼ˆå•ä¾‹ï¼‰ï¼Œé€šè¿‡æŒæœ‰blockå†é—´æ¥æŒæœ‰å¤–ç•Œçš„targetã€‚è¿™æ ·NSTimerä¸targetçš„å¼•ç”¨é—®é¢˜å°±è½¬åŒ–ä¸ºNSTimerçš„blockä¸targetçš„å¼•ç”¨é—®é¢˜ã€‚è€Œè¿™ç±»é—®é¢˜æ˜¯æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ï¼Œå¯ä»¥é€šè¿‡weakSelf-strongSelfè§£å†³ï¼š<br><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">- (void)startTask &#123;</span><br><span class="line">    YASinger *singer = [YASinger new]<span class="comment">;</span></span><br><span class="line">    self.singer = singer<span class="comment">;</span></span><br><span class="line">    __weak YASinger *weakSinger = singer<span class="comment">;</span></span><br><span class="line">    singer.timer = [NSTimer <span class="keyword">bk_scheduledTimerWithTimeInterval:1 </span><span class="keyword">block:^(NSTimer </span>*timer) &#123;</span><br><span class="line">        __strong YASinger *singer = weakSinger<span class="comment">;</span></span><br><span class="line">        [singer sing]<span class="comment">;</span></span><br><span class="line">    &#125; repeats:YES]<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><p><strong>ä½¿ç”¨ç»§æ‰¿è‡ªNSObjectçš„å¯¹è±¡ä½œä¸ºä¸­é—´ä»¶ï¼Œå¼±å¼•ç”¨ç€targetï¼š</strong><br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAWeakTarget </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, weak)   id target;</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) SEL selector;</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) NSTimer *timer;;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YAWeakTarget</span><br><span class="line">- (void)<span class="attribute">timerTask</span>:(NSTimer *)timer &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (self.target) &#123;</span><br><span class="line">        <span class="selector-attr">[self.target performSelector:self.selector withObject:timer.userInfo]</span>;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="selector-attr">[self.timer invalidate]</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p><p>ç”±YAWeakTargetä¿å­˜ç€targetã€selectorå’Œtimerï¼Œå¹¶è´Ÿè´£é—´æ¥è°ƒç”¨targetçš„selectoræ–¹æ³•ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œç»Ÿä¸€è°ƒç”¨YAWeakTargetçš„<code>timerTask:</code>æ–¹æ³•ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startTask &#123;</span><br><span class="line">    YASinger *singer = [YASinger <span class="keyword">new</span>];</span><br><span class="line">    self.singer = singer;</span><br><span class="line">    YAWeakTarget *weakTarget = [YAWeakTarget <span class="keyword">new</span>];</span><br><span class="line">    weakTarget.target = singer;</span><br><span class="line">    weakTarget.selector = <span class="meta">@selector</span>(sing);</span><br><span class="line">    weakTarget.timer = [NSTimer <span class="string">scheduledTimerWithTimeInterval:</span><span class="number">1</span> <span class="string">target:</span>weakTarget <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">timerTask:</span>) <span class="string">userInfo:</span>@&#123;&#125; <span class="string">repeats:</span>YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸€å›¾èƒœåƒè¨€ï¼š<br><img src="https://image.chenyalun.com/2019/09/11/001.png" style="zoom:40%"></p><p>æ‰“ç ´å¾ªç¯å¼•ç”¨çš„æ ¹æœ¬åŸå› æ˜¯NSTimerçš„invalidateæ–¹æ³•å¾—åˆ°æ‰§è¡Œã€‚NSTimeråœ¨å…¶invalidateæ–¹æ³•è°ƒç”¨åï¼ŒRunloopä¼šè‡ªåŠ¨ç§»é™¤å¯¹å®ƒçš„å¼•ç”¨ï¼Œå®ƒä¹Ÿä¼šç§»é™¤å¯¹targetå’ŒuserInfoçš„å¼ºå¼•ç”¨ã€‚</p><p>weakTargetä¸€æ—¦å‘ç°YASingerä¸ºnilï¼Œå°±ä¼šè°ƒç”¨å®šæ—¶å™¨çš„invalidateæ–¹æ³•ã€‚å› æ­¤ï¼ŒweakTargetå¼ºå¼•ç”¨ç€timerä¹Ÿæ˜¯æ²¡å…³ç³»çš„ï¼ˆä¹Ÿå°±æ˜¯å›¾ä¸­çš„è“çº¿ï¼‰ã€‚</p><h3 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h3><p><strong>ä½¿ç”¨ç»§æ‰¿è‡ªNSProxyçš„å¯¹è±¡ä½œæ¶ˆæ¯è½¬å‘ï¼š</strong><br><code>forwardInvocation:</code>å’Œ<code>methodSignatureForSelector:</code>ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•å¿…é¡»å®ç°ã€‚åœ¨è¿™åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šè‡ªå·±éœ€è¦çš„ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAProxy</span> : <span class="title">NSProxy</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAProxy</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target &#123;</span><br><span class="line">    _target = target;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.target respondsToSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation&#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.target respondsToSelector:invocation.selector]) &#123;</span><br><span class="line">        [invocation invokeWithTarget:<span class="keyword">self</span>.target];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.target methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™ä¹ˆåšå°±è¡Œäº†ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startTask &#123;</span><br><span class="line">    YASinger *singer = [YASinger <span class="keyword">new</span>];</span><br><span class="line">    self.singer = singer;</span><br><span class="line">    singer.timer = [NSTimer <span class="string">scheduledTimerWithTimeInterval:</span><span class="number">1</span> <span class="string">target:</span>[[YAProxy alloc] <span class="string">initWithTarget:</span>singer] <span class="string">selector:</span><span class="meta">@selector</span>(sing) <span class="string">userInfo:</span>@&#123;&#125; <span class="string">repeats:</span>YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸‰ç§æ–¹æ³•å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘æ›´å–œæ¬¢æ–¹æ³•ä¸‰ã€‚æ–¹æ³•ä¸€éœ€è¦æ—¶åˆ»ç‰¢è®°weak-strongï¼Œå½±å“ä»£ç ç¾è§‚ï¼›æ–¹æ³•äºŒä¸ä¼˜é›…ï¼Œè¿˜è¦å¼•å…¥ä¸­é—´ä»¶ã€‚æ–¹æ³•ä¸‰ä¸­çš„Proxyä¸“é—¨åšæ¶ˆæ¯è½¬å‘ï¼Œè€Œä¸”å¤ç”¨æ€§å¼ºï¼Œå¹¶ä¸å•å•é’ˆå¯¹NSTimerçš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>å¦‚æ­¤ï¼Œæ ¹æœ¬æ–¹æ³•æœ‰äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯åšç›¸å…³æ–¹æ³•çš„hookå·¥ä½œäº†ï¼Œä¸å†èµ˜è¿°ã€‚</p><h2 id="5-Bad-Access-crash"><a href="#5-Bad-Access-crash" class="headerlink" title="5. Bad Access crash"></a>5. Bad Access crash</h2><p>è¿™ç§crashäº§ç”Ÿçš„åŸå› æ˜¯å‘å·²ç»é”€æ¯çš„å¯¹è±¡å‘é€æ¶ˆæ¯ã€‚ç±»å‹å¾ˆå¸¸è§ï¼Œä½†æ˜¯å´åˆæ¯”è¾ƒéš¾æ’æŸ¥ã€‚é˜²æŠ¤å±‚é¢ä¹Ÿæ˜¯æœ‰åŠæ³•çš„ï¼ŒåŸç†æ˜¯hook éœ€è¦ç›‘æµ‹çš„å¯¹è±¡çš„deallocæ–¹æ³•ï¼Œä¸è®©å®ƒé‡Šæ”¾å†…å­˜ï¼ˆé¿å…è°ƒç”¨deallocæ–¹æ³•ï¼‰ï¼Œå¹¶ä¿®æ”¹å®ƒçš„isaæŒ‡é’ˆä»è€ŒæŠŠä¹‹åçš„æ¶ˆæ¯è½¬å‘ç»™å›ºå®šçš„å¯¹è±¡ã€‚</p><p>å‡å®šéœ€è¦ç›‘æµ‹â€œYAâ€æ‰“å¤´çš„æ‰€æœ‰å¯¹è±¡ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">YAResolveZombie</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        ya_methodSwizzle(<span class="built_in">NSObject</span>.class, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"dealloc"</span>), <span class="keyword">@selector</span>(ya_dealloc));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_dealloc &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *clsName = <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class);</span><br><span class="line">    <span class="keyword">if</span> ([clsName hasPrefix:<span class="string">@"YA"</span>]) &#123;</span><br><span class="line">        <span class="comment">// ä¿®æ”¹isaæŒ‡é’ˆ</span></span><br><span class="line">        object_setClass(<span class="keyword">self</span>, YAZombieInfoObject.class);</span><br><span class="line">        <span class="comment">// è®°å½•ç±»ä¿¡æ¯</span></span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, <span class="string">"ya_className"</span>, clsName, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…¶ä»–å¯¹è±¡æ­£å¸¸è°ƒç”¨dealloc</span></span><br><span class="line">        [<span class="keyword">self</span> ya_dealloc];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>è€Œè¿™ä¸ªYAZombieInfoObjectå¯¹è±¡æ˜¯ç°æˆçš„ï¼ˆæˆ‘çœ‹æœ‰æ–‡ç« ä½¿ç”¨åŠ¨æ€ç”Ÿæˆclassï¼Œç¡®å®æ²¡æœ‰å¿…è¦ï¼‰ï¼Œç±»ä¼¼unrecognized selector crashçš„é˜²æŠ¤ï¼Œè®°å½•ç±»åã€æ–¹æ³•åã€è°ƒç”¨æ ˆç­‰ä¿¡æ¯å³å¯ã€‚ç”±äºç±»å¯¹è±¡æ˜¯å•ä¾‹ï¼Œæ‰€ä»¥åªéœ€è¦é˜²æŠ¤å®ä¾‹å¯¹è±¡ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰å°±è¡Œäº†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAZombieInfoObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAZombieInfoObject</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> forwardingTargetDynamicMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *clsName = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="string">"ya_className"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Class name is %@, zombie instance Method is %@, \nè°ƒç”¨æ ˆæ˜¯:%@"</span>,clsName,  <span class="built_in">NSStringFromSelector</span>(_cmd), kYACurrentCallStackSymbols);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    class_addMethod(<span class="keyword">self</span>.class, sel, (IMP)forwardingTargetDynamicMethod, <span class="string">"v@:"</span>);</span><br><span class="line">    [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç‚¹éœ€è¦è€ƒè™‘ï¼š<br>1ï¼Œè¢«ç›‘æµ‹å¯¹è±¡çš„èŒƒå›´æ€ä¹ˆè¡¡é‡ï¼Œæ˜¯æ‰€æœ‰è‡ªå®šä¹‰çš„ç±»å—ï¼Ÿ<br>2ï¼Œè¢«ç›‘æµ‹å¯¹è±¡å»¶è¿Ÿé‡Šæ”¾ä¼šå ç”¨å†…å­˜ï¼Œå†…å­˜é™åˆ¶å¤šå°‘åˆé€‚ï¼Ÿ<br>3ï¼Œè¢«ç›‘æµ‹å¯¹è±¡æœ€ç»ˆè¿˜æ˜¯è°ƒè¦deallocçš„ï¼Œä»€ä¹ˆæ—¶æœºæ¯”è¾ƒåˆé€‚ï¼Ÿ<br>4ï¼Œè¿™ç§æ–¹æ³•hookäº†deallocæ–¹æ³•ï¼Œä¼šä¸ä¼šæœ‰æ½œåœ¨çš„å±é™©ï¼Ÿ</p><p>é¢„é˜²ä¸ºä¸»ï¼Œä¸‹é¢ç®€å•åˆ—ä¸¾å‡ ä¸ªè¿™ç§ç±»å‹çš„ä¾‹å­å§ã€‚</p><h3 id="blockä¸ºnil"><a href="#blockä¸ºnil" class="headerlink" title="blockä¸ºnil"></a>blockä¸ºnil</h3><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">void (^block)() = <span class="literal">nil</span><span class="comment">;</span></span><br><span class="line">block()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ˜¯æ–°äººæ‰çŠ¯è¿™ç§é”™è¯¯ã€‚blockåœ¨æ‰§è¡Œä¹‹å‰ä¸€å®šè¦åˆ¤ç©ºï¼Œä¸ç„¶ä¼šé€ æˆç¨‹åºè¯»å–å†…å­˜åœ°å€æ—¶å‡ºé”™ã€‚</p><p>ä½¿ç”¨æ¡ä»¶è¿ç®—ç¬¦å¯ä»¥ä½¿é£æ ¼æ›´åŠ <a href="http://southpeak.github.io/2016/09/20/ios-techset-8/" target="_blank" rel="noopener">ä¼˜é›…</a>ï¼š<br><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">!<span class="built_in">block</span> ?: <span class="built_in">block</span>();</span><br></pre></td></tr></table></figure></p><h3 id="æŒ‡é’ˆä¼ é€’æœªåˆ¤ç©º"><a href="#æŒ‡é’ˆä¼ é€’æœªåˆ¤ç©º" class="headerlink" title="æŒ‡é’ˆä¼ é€’æœªåˆ¤ç©º"></a>æŒ‡é’ˆä¼ é€’æœªåˆ¤ç©º</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> saveText(<span class="built_in">NSString</span> *text, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜æ–‡æœ¬å´å¤±è´¥äº†</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¼ é€’error</span></span><br><span class="line">    *error = [<span class="built_in">NSError</span> errorWithDomain:<span class="string">@"error"</span> code:<span class="number">-1</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">saveText(<span class="string">@"test"</span>, <span class="literal">nil</span>);</span><br></pre></td></tr></table></figure><p>åŒæ ·åœ°ï¼ŒæŒ‡é’ˆä¸åšåˆ¤ç©ºä¹Ÿæ˜¯ä¼šå‡ºé—®é¢˜ã€‚</p><h3 id="assginä¿®é¥°å¯¹è±¡"><a href="#assginä¿®é¥°å¯¹è±¡" class="headerlink" title="assginä¿®é¥°å¯¹è±¡"></a>assginä¿®é¥°å¯¹è±¡</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSString</span> *cuid;</span><br></pre></td></tr></table></figure><p>è¿™ç§é”™è¯¯ä¸€èˆ¬æ˜¯åœ¨å¤åˆ¶ã€ç²˜è´´çš„æ—¶å€™æ²¡ä»”ç»†reviewé€ æˆçš„ï¼Œä¸€æ—¦å‡ºé—®é¢˜ä¹Ÿå¾ˆä¸¥é‡ï¼Œè€Œä¸”æ’æŸ¥èµ·æ¥æå…¶è›‹ç–¼ã€‚ã€‚ã€‚</p><h3 id="selfæå‰é‡Šæ”¾"><a href="#selfæå‰é‡Šæ”¾" class="headerlink" title="selfæå‰é‡Šæ”¾"></a>selfæå‰é‡Šæ”¾</h3><p>ä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œ<code>self</code>çš„ä¿®é¥°æ˜¯<code>__unsafe_unretained</code>è€Œä¸æ˜¯<code>strong</code>ï¼ˆ<strong>ä¸€èˆ¬æƒ…å†µä¸‹</strong>è°ƒç”¨æ–¹éƒ½ä¸ä¼šåœ¨æ–¹æ³•æ‰§è¡Œæ—¶æŠŠè¿™ä¸ªå¯¹è±¡é‡Šæ”¾æ‰€ä»¥ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼‰ã€‚è¿™å°±æœ‰å¯èƒ½é€ æˆæ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œè€Œè‡ªå·±ï¼ˆselfï¼‰è¢«é‡Šæ”¾æ‰ï¼Œä»è€Œäº§ç”Ÿåå†…å­˜è®¿é—®ã€‚</p><p>æ¯”å¦‚<a href="https://blog.sunnyxx.com/2015/01/17/self-in-arc/" target="_blank" rel="noopener">å­™æºå¤§ç¥æ–‡ç« ä¸­çš„ä¾‹å­</a></p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@class</span> YARequest;</span><br><span class="line"><span class="variable">@protocol</span> YARequestDelegate &lt;NSObject&gt;</span><br><span class="line">- (void)requestFinished;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">YARequest </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, weak) id &lt;YARequestDelegate&gt; delegate;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YARequest</span><br><span class="line">- (void)start &#123;</span><br><span class="line">    <span class="selector-attr">[self.delegate requestFinished]</span>;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%@"</span>, self); <span class="comment">// EXC_BAD_ACCESS</span></span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><p>æ§åˆ¶å™¨ä¸­çš„æ–¹æ³•ï¼š<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> YARequest *gRequest;</span><br><span class="line"><span class="comment">// å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">- (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    gRequest = [YARequest <span class="keyword">new</span>];</span><br><span class="line">    gRequest.<span class="keyword">delegate</span> = self;</span><br><span class="line">    [<span class="meta">gRequest start</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»£ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)requestFinished &#123;</span><br><span class="line">    gRequest = nil;</span><br><span class="line">    NSLog(<span class="string">@"è¯·æ±‚æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¾ˆå®¹æ˜“å°±å‘ç°EXC_BAD_ACCESSäº†ã€‚åŸå› æ˜¯åœ¨YARequestçš„ä»£ç†æ–¹æ³•ä¸­ï¼Œæ§åˆ¶å™¨æŠŠYARequestç½®ä¸ºniläº†ã€‚è¿™å°±é€ æˆç»§ç»­åœ¨startæ–¹æ³•ä¸­è®¿é—®<code>self</code>äº§ç”Ÿäº†é—®é¢˜ã€‚</p><p>æ³¨æ„ï¼šè¿™é‡Œçš„gRequestå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨äº†å…¨å±€å˜é‡è€Œä¸æ˜¯å±æ€§ã€‚å¦‚æœä½¿ç”¨å±æ€§çš„getterå–å€¼ï¼Œå¯¹è±¡ä½œä¸ºè¿”å›å€¼ä¼šè‡ªåŠ¨è¢«auto releaseï¼Œå¼•ç”¨è®¡æ•°ä¼šè¢«å¹²æ‰°ï¼Œå°±æ²¡åŠæ³•å¤ç°äº†ã€‚</p><p>è¿™ä¸ªcaseå‡ºç°çš„å¯èƒ½æ€§æ¯”è¾ƒä½ï¼Œä½†æ˜¯ä¹Ÿå€¼å¾—æ³¨æ„çš„ã€‚</p><h3 id="å¿«é€Ÿéå†ä¸‹çš„-autoreleasing"><a href="#å¿«é€Ÿéå†ä¸‹çš„-autoreleasing" class="headerlink" title="å¿«é€Ÿéå†ä¸‹çš„__autoreleasing"></a>å¿«é€Ÿéå†ä¸‹çš„<code>__autoreleasing</code></h3><p>æŒ‡å‘å¼•ç”¨ç±»å‹æŒ‡é’ˆçš„æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œæ˜¯ä½¿ç”¨<code>__autoreleasing</code>ä¿®é¥°çš„ã€‚æ¯”å¦‚NSFileManagerä¸­çš„åˆ é™¤æ–‡ä»¶æ–¹æ³•ï¼š<code>removeItemAtURL:(NSURL *)url error:(NSError *__autoreleasing  *)error;</code><br>å½“è¿™ç§æŒ‡é’ˆé‡è§<code>enumerateObjectsUsingBlock</code>æ—¶ï¼Œé‡‘é£ç‰éœ²ä¸€ç›¸é€¢ï¼Œå°±è¯¥å‡ºé—®é¢˜äº†ã€‚æ¯”å¦‚è¿™ä¸ª<a href="http://tutuge.me/2016/04/30/autoreleasing-meet-autoreleasepool/" target="_blank" rel="noopener">ä¾‹å­</a>ï¼Œçœ‹ç€æ²¡æ¯›ç—…ï¼Œå…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è§£å†³æ–¹æ³•: void enumerateArray(__strong NSError **error) &#123;</span></span><br><span class="line"><span class="keyword">void</span> enumerateArray(<span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *array = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, @<span class="number">4</span>, @<span class="number">5</span>];</span><br><span class="line">    [array enumerateObjectsUsingBlock:^(<span class="built_in">NSNumber</span> *obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj);</span><br><span class="line">        <span class="keyword">if</span> (idx == <span class="number">0</span> &amp;&amp; error) &#123;</span><br><span class="line">            *error = [<span class="built_in">NSError</span> errorWithDomain:<span class="string">@"error"</span> code:<span class="number">-1</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    enumerateArray(&amp;error);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šè­¦å‘Šçš„ï¼šBlock captures an autoreleasing out-parameter, which may result in use-after-free bugsã€‚</p><p><code>__autoreleasing</code>ä¿®é¥°æ—¶ï¼Œä¼šæŠŠå¤–ç•Œçš„è¿™ä¸ªå¯¹è±¡æ”¾åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œå¯æ˜¯enumerateObjectsUsingBlockæ°æ°æ˜¯ä¼šè‡ªå·±åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± çš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ<code>*error</code>è¢«åˆ›å»ºä¹‹ååœ¨ä¸‹æ¬¡è¿­ä»£ä¹‹å‰å°±å·²ç»é”€æ¯äº†ã€‚äºæ˜¯å¤–ç•Œè®¿é—®å·²ç»é‡Šæ”¾çš„<code>*error</code>è‡ªç„¶ä¼šå‡ºé”™äº†ã€‚è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œæ”¹ä¸º<code>__strong</code>ä¿®é¥°å³å¯ã€‚</p><p>ä¸¤ä¸ªå°ç‚¹ï¼š<br>1ã€enumerateObjectsUsingBlockå†…éƒ¨ä¼šè‡ªå·±åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œ<code>forå¾ªç¯</code>ã€<code>for inå¾ªç¯</code>æ˜¯æ²¡æœ‰è¿™ä¸ªèƒ½åŠ›çš„ã€‚å› ä¸ºè¿™æ˜¯å±äºCè¯­è¨€çš„è¯­æ³•ï¼Œè‡ªç„¶ä¸å­˜åœ¨è‡ªåŠ¨é‡Šæ”¾æ± çš„æ¦‚å¿µã€‚ä¸è¿‡è¦æ˜¯è‡ªå·±æ‰‹åŠ¨æ·»åŠ <code>@autoreleasepool{}</code>ï¼Œé‚£å°±åˆå¦è¯´äº†ã€‚<br>2ã€å…³äºä¸ºå•¥æŒ‡å‘å¼•ç”¨ç±»å‹çš„æŒ‡é’ˆçš„æŒ‡é’ˆé»˜è®¤æ˜¯ä½¿ç”¨<code>__autoreleasing</code>ä¿®é¥°çš„ï¼Œè¿™ä¸ªæˆ‘è§‰å¾—å’Œå¼•ç”¨ç±»å‹çš„è¿”å›å€¼éœ€è¦è¢«æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­æ˜¯åŒæ ·çš„é“ç†ï¼šæœ¬æ¥è‡ªå·±ä½œç”¨åŸŸå†…retainçš„å¯¹è±¡å°±åº”è¯¥è‡ªå·±æŠŠå®ƒreleaseï¼Œä½†æ˜¯ååè¿™ä¸ªå¯¹è±¡è¦å»¶é•¿å®ƒçš„ç”Ÿå‘½å‘¨æœŸä»¥ä¾›å¤–ç•Œä½¿ç”¨ï¼Œæ‰€ä»¥å°±éœ€è¦è¢«æ·»åŠ åˆ°autoreleasepoolä¸­å»¶è¿Ÿreleaseäº†ã€‚</p><h3 id="IMPè°ƒç”¨"><a href="#IMPè°ƒç”¨" class="headerlink" title="IMPè°ƒç”¨"></a>IMPè°ƒç”¨</h3><p>åå†…å­˜ï¼š<br><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">SEL</span> sel = @selector(showText:);</span><br><span class="line"><span class="type">IMP</span> imp = [<span class="keyword">self</span>.target methodForSelector:sel]; <span class="comment">// self.targetä¸ºnil</span></span><br><span class="line">id (*<span class="function"><span class="keyword">func</span>)<span class="params">(id, SEL, id)</span></span> = (void *)imp;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">self</span>, sel, @<span class="string">"text"</span>)</span></span>;</span><br></pre></td></tr></table></figure></p><p>æ­£å¸¸ï¼š<br><figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">SEL sel = <span class="symbol">@selector</span>(showText:)<span class="comment">;</span></span><br><span class="line">IMP imp = [self.target methodForSelector:sel]<span class="comment">;</span></span><br><span class="line">id (*<span class="function"><span class="keyword">func</span>)<span class="params">(id, SEL, id)</span> = <span class="params">(void *)</span><span class="title">imp</span>;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="function"><span class="keyword">func</span>) <span class="title">func</span><span class="params">(self, sel, @<span class="string">"text"</span>)</span>;</span></span><br></pre></td></tr></table></figure></p><p>å½“ç›´æ¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨æ–¹æ³•æ—¶ï¼Œå€˜è‹¥è·å–çš„impä¸ºnilè€Œç›´æ¥è°ƒç”¨ä¹Ÿä¼šäº§ç”Ÿå¼‚å¸¸ã€‚æ¯”å¦‚å½“<code>self.target</code>è¿”å›nilæ—¶ï¼Œå°±ä¼šé€ æˆimpä¹Ÿä¸ºnilã€‚è¿™æ—¶å€™åšä¸€ä¸ªåˆ¤ç©ºå†å¥½ä¸è¿‡äº†ã€‚</p><h2 id="6-å…¶ä»–ç±»å‹çš„crash"><a href="#6-å…¶ä»–ç±»å‹çš„crash" class="headerlink" title="6. å…¶ä»–ç±»å‹çš„crash"></a>6. å…¶ä»–ç±»å‹çš„crash</h2><p>è¿˜æœ‰å‡ ä¸ªæˆ‘è§è¿‡çš„crashï¼Œä¸€å¹¶åˆ†äº«ä¸€ä¸‹ï¼Œä»¥åæ…¢æ…¢è¡¥å……ï¼š</p><p><strong>éå†æ•°ç»„çš„åŒæ—¶ç§»é™¤æ•°ç»„å…ƒç´ </strong><br><figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">NSMutableArray *array = [NSMutableArray arrayWithArray:<span class="symbol">@[</span><span class="symbol">@1</span>, <span class="symbol">@2</span>, <span class="symbol">@3</span>, <span class="symbol">@4</span>, <span class="symbol">@5]]</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">for</span> (NSNumber *num <span class="keyword">in</span> array) &#123;</span><br><span class="line">   <span class="keyword">if</span> ([num isEqualToNumber:<span class="symbol">@1]</span>) &#123;</span><br><span class="line">       [array removeObject:num]<span class="comment">;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨é€†åºéå†å¯ä»¥è§£å†³ï¼š<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">for</span> (NSNumber *num in array.reverseObjectEnumerator) &#123;</span><br><span class="line">   <span class="selector-tag">if</span> ([num <span class="attribute">isEqualToNumber</span>:<span class="variable">@1</span>]) &#123;</span><br><span class="line">       <span class="selector-attr">[array removeObject:num]</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ºå•¥ä½¿ç”¨é€†åºéå†å°±èƒ½è§£å†³é—®é¢˜å‘¢ï¼Ÿå› ä¸ºæ­£åºéå†æ—¶ï¼Œç§»é™¤å…ƒç´ ä¼šé€ æˆæ²¡æœ‰éå†çš„å…ƒç´ çš„ç´¢å¼•å‘ç”Ÿå¼‚å¸¸ï¼Œè€Œé€†åºéå†æ—¶ï¼Œç´¢å¼•æ”¹å˜çš„æ˜¯éå†è¿‡çš„å…ƒç´ ï¼Œè€Œæ²¡æœ‰éå†åˆ°çš„å…ƒç´ ç´¢å¼•å´æ²¡æœ‰æ”¹å˜ï¼Œè‡ªç„¶ç´¢å¼•ä¹Ÿä¸ä¼šè¶Šç•Œäº†ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹ï¼Œè¿™ä¸ªreverseObjectEnumeratorç›®å‰è¿˜æ˜¯å¥½ä½¿çš„ï¼Œå¾€åå¥½ä¸å¥½ä½¿ä¸å¥½è¯´çš„ï¼š</p><blockquote><p>In Objective-C, it is not safe to modify a mutable collection while enumerating through it. Some enumerators may currently allow enumeration of a collection that is modified, but this behavior is not guaranteed to be supported in the future.</p></blockquote><p><strong>éæ³•æ•°å€¼</strong><br><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">CGFloat <span class="built_in">width</span> = <span class="number">100.0</span>;</span><br><span class="line">CGFloat <span class="built_in">height</span> = <span class="number">0.0</span>;</span><br><span class="line">CGFloat <span class="built_in">scale</span> = <span class="built_in">width</span> / <span class="built_in">height</span>;</span><br><span class="line">UIView *<span class="built_in">view</span> = [[UIView alloc] initWithFrame:CGRectMake(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">width</span>, <span class="built_in">height</span> * <span class="built_in">scale</span>)];</span><br></pre></td></tr></table></figure></p><p>ä¸€ä¸ªéæ³•çš„æ•°å€¼åœ¨ä¼ æ¥ä¼ å»ä¼ åˆ°UIViewçš„frameä¸Šçš„æ—¶å€™ï¼Œå°±è¯¥å‡ºé—®é¢˜äº†ï¼š<code>&#39;CALayer bounds contains NaN: [0 0; 100 nan].</code>ã€‚åˆ¤æ–­æ•°å€¼çš„åˆæ³•æ€§å¯ä»¥ä½¿ç”¨isnan()å‡½æ•°å’Œisinf()å‡½æ•°ã€‚é‡åˆ°é™¤æ³•çš„æ—¶å€™ï¼Œä¸€å®šè¦åšä¸ªåˆ¤æ–­ã€‚</p><h1 id="äºŒã€å°ç»“"><a href="#äºŒã€å°ç»“" class="headerlink" title="äºŒã€å°ç»“"></a>äºŒã€å°ç»“</h1><p>è¿™ç¯‡æ–‡ç« å†™å¾—å¾ˆæ˜¯éšæ„ï¼Œç®€å•æè¿°äº†è‡ªå·±çš„æƒ³æ³•å´æ²¡æœ‰ç»™å‡ºå®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚Crashé˜²æŠ¤åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ˜¯æœ‰æ„ä¹‰çš„ï¼Œèƒ½å¢å¼ºç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯è¿˜æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘çš„ï¼š</p><ol><li>Crashé˜²æŠ¤åŸç†å¤§å¤šæ˜¯hookç³»ç»Ÿæ–¹æ³•ï¼Œé‚£æ˜¯å¦ä¼šå¯¹Appäº§ç”Ÿæ€§èƒ½æˆ–è€…é€Ÿåº¦æ–¹é¢çš„å½±å“ï¼Œå°¤å…¶æ˜¯äº¿ä¸‡çº§åˆ«çš„Appï¼Ÿæ¯”å¦‚æ˜¯åšé€Ÿåº¦ä¼˜åŒ–çš„æ ¸å¿ƒæ–¹æ³•ï¼Ÿ</li><li>å‘ç”ŸCrashä¸€å®šæ˜¯Appå‡ºç°å¼‚å¸¸æƒ…å†µäº†ï¼Œç³»ç»ŸæŠŠå®ƒæ€æ­»ä¹Ÿæ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚å€˜è‹¥æ‰§æ„è®©Appç»§ç»­è¿è¡Œï¼Œä¼šä¸ä¼šé€ æˆæ•°æ®å¼‚å¸¸ã€ç•Œé¢å¼‚å¸¸ï¼Ÿ</li></ol><p>Crashé˜²æŠ¤åªèƒ½ç®—ä½œä¸€ä¸ªå…œåº•ç­–ç•¥ï¼Œç›®å‰æ¥è¯´ï¼Œå¾ˆå¤šé—®é¢˜å¯ä»¥é€šè¿‡çƒ­ä¿®å¤è§£å†³ï¼Œæ›´æœ‰é’ˆå¯¹æ€§ã€‚å½“ç„¶ï¼Œæœ€æ ¸å¿ƒæœ€é‡è¦çš„æ˜¯å°ä¼™ä¼´ä»¬éƒ½æœ‰è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œä»”ç»†reviewã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; é¿å…App crashã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.chenyalun.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>Objective-Cè®¾è®¡æŒ‡åŒ—</title>
    <link href="http://blog.chenyalun.com/2019/08/22/Objective-C%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8C%97/"/>
    <id>http://blog.chenyalun.com/2019/08/22/Objective-Cè®¾è®¡æŒ‡åŒ—/</id>
    <published>2019-08-22T11:32:37.000Z</published>
    <updated>2019-10-28T09:09:11.329Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> å°è¯•å›ç­”â€œç»™ä½  C è¯­è¨€ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ª Objective-Câ€ã€‚ </p><a id="more"></a><p>å­™æºå¤§ç¥åœ¨ä»–çš„æ–‡ç« ä¸­ç•™ä¸‹äº†è¿™æ ·ä¸€é“é—®é¢˜ï¼š<a href="https://blog.sunnyxx.com/2016/08/13/reunderstanding-runtime-0/" target="_blank" rel="noopener">å‡å¦‚éè¦è®©æˆ‘è€ƒä¸€é“ Runtime çš„é¢˜ï¼Œå¯èƒ½æ˜¯â€œç»™ä½  C è¯­è¨€ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ª Objective-Cï¼Ÿ</a>â€ï¼Œç­”åˆ°å“ªå„¿ç®—å“ªå„¿ã€‚</p><p>è¿™ç¯‡æ–‡ç« å°è¯•åšä¸€ç‚¹è§£ç­”ï¼Œä¹Ÿæ•´ä½“å¤ä¹ ä¸€ä¸‹Objective-Cã€‚</p><h1 id="ä¸€ã€ç±»ä¸å¯¹è±¡"><a href="#ä¸€ã€ç±»ä¸å¯¹è±¡" class="headerlink" title="ä¸€ã€ç±»ä¸å¯¹è±¡"></a>ä¸€ã€ç±»ä¸å¯¹è±¡</h1><h2 id="å¯¹è±¡"><a href="#å¯¹è±¡" class="headerlink" title="å¯¹è±¡"></a>å¯¹è±¡</h2><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">/// Represents an<span class="built_in"> instance </span>of a class.</span><br><span class="line">struct objc_object &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Objective-Cå®ä¾‹å¯¹è±¡çš„æœ¬è´¨æ˜¯ç»“æ„ä½“ï¼Œæ··æ²Œåˆå¼€çš„æ—¶å€™ï¼Œå…¶å†…éƒ¨æœ‰ä¸”åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼šClassç±»å‹çš„isaã€‚isaæ˜¯ä¸€ä¸ªæŒ‡å‘objc_classç»“æ„ä½“çš„æŒ‡é’ˆï¼Œåœ¨arm64ä¸Šå ç”¨8ä¸ªå­—èŠ‚ï¼Œåœ¨armv7ä¸Šå ç”¨4ä¸ªå­—èŠ‚ï¼ˆæœ¬æ–‡éƒ½æŒ‰ç…§64ä½å¹³å°æ¥è¯´çš„ï¼‰ã€‚ä¸€ä¸ªNSObjectå¯¹è±¡åªæœ‰è¿™ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œç†è®ºä¸Šä¹Ÿåªéœ€è¦8ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯é€šè¿‡memory readå¯ä»¥çŸ¥é“ç³»ç»Ÿç»™å®ƒåˆ†é…äº†16ä¸ªå­—èŠ‚ã€‚æŸ¥çœ‹æºç å‘ç°allocWithZoneæœ€ç»ˆè°ƒç”¨åˆ°instanceSize()å‡½æ•°æ—¶ï¼Œä¸ºäº†å†…å­˜å¯¹é½ï¼Œé™åˆ¶äº†ä¸€ä¸ªå¯¹è±¡çš„æœ€å°å ç”¨å†…å­˜ä¸º16ä¸ªå­—èŠ‚ã€‚åŒæ—¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†å‘¼åº”â€œæ“ä½œç³»ç»Ÿçš„å†…å­˜å¯¹é½â€ï¼šç»™ä¸€ä¸ªå¯¹è±¡åˆ†é…çš„å­—èŠ‚æ•°é‡ä¸º16çš„å€æ•°ã€‚</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">size_t instanceSize(size_t extraBytes) &#123;</span><br><span class="line">    <span class="comment">// å†…å­˜å¯¹é½ä¹‹åçš„å¤§å°</span></span><br><span class="line">   size_t <span class="built_in">size</span> = alignedInstanceSize() + extraBytes;</span><br><span class="line">   <span class="comment">// CF requires all objects be at least 16 bytes.</span></span><br><span class="line">   <span class="built_in">if</span> (<span class="built_in">size</span> &lt; <span class="number">16</span>) <span class="built_in">size</span> = <span class="number">16</span>;</span><br><span class="line">   <span class="built_in">return</span> <span class="built_in">size</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨arm64æ¶æ„ä¹‹å‰ï¼Œisaæ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‡é’ˆï¼Œç›´æ¥æŒ‡å‘ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚ä»arm64æ¶æ„å¼€å§‹ï¼Œisaè¢«ä¼˜åŒ–ä¸ºä¸€ä¸ªå…±ç”¨ä½“ï¼Œä½¿ç”¨ä½åŸŸæŠŠè¯¸å¤šä¿¡æ¯å­˜å‚¨åœ¨8ä¸ªå­—èŠ‚çš„æ–¹å¯¸ä¹‹é—´ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">isa_t</span> &#123;</span><br><span class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;  <span class="comment">// 1è¡¨ç¤ºä¼˜åŒ–è¿‡çš„isaæŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦æœ‰C++çš„ææ„å‡½æ•°</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">// ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡åœ°å€</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;  <span class="comment">// æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦æœ‰å¼±å¼•ç”¨æŒ‡å‘è¿‡</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦æ­£åœ¨dealloc</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°æ˜¯å¦è¿‡å¤§ä½¿å¾—æ— æ³•å­˜å‚¨åœ¨isaä¸­ï¼Œ</span></span><br><span class="line">                                          <span class="comment">// å¦‚æœæ˜¯åˆ™å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨SideTableä¸­</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">19</span>; <span class="comment">// é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å‡å»1</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ä½¿ç”¨æ©ç è¿›è¡ŒæŒ‰ä½ä¸è¿ç®—å°±å¯ä»¥è®¡ç®—å‡ºå®ƒçš„ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„åœ°å€ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">if</span> __arm64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">elif</span> __x86_64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x00007ffffffffff8ULL</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">NSObject *obj = [NSObject <span class="keyword">new</span>];</span><br><span class="line"><span class="comment">// (lldb) p/x (long)obj-&gt;isa</span></span><br><span class="line"><span class="comment">// (long) $3 = 0x001dffff9da71141</span></span><br><span class="line">    </span><br><span class="line">Class cls = [NSObject class];</span><br><span class="line"><span class="comment">// (lldb) p/x (long)obj.class</span></span><br><span class="line"><span class="comment">// (long) $5 = 0x00007fff9da71140</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// (lldb) p/x (0x001dffff9da71141 &amp; 0x00007ffffffffff8ULL)</span></span><br><span class="line"><span class="comment">// (unsigned long long) $7 = 0x00007fff9da71140</span></span><br></pre></td></tr></table></figure></p><p>æ¯ä¸ªå®ä¾‹å¯¹è±¡ç”Ÿè€Œä¸åŒï¼Œè‡ªå·±çš„æˆå‘˜å˜é‡ç†æ‰€åº”å½“åœ°å­˜å‚¨åœ¨æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ä¸­ï¼Œè€Œæ–¹æ³•å…·æœ‰å”¯ä¸€æ€§ï¼ŒåŒä¸€ä¸ªç±»å®ä¾‹åŒ–çš„æ‰€æœ‰çš„å¯¹è±¡åº”å½“å…±äº«ä¸€ä»½å¯¹è±¡æ–¹æ³•ã€‚è‡ªç„¶ï¼Œå¯¹è±¡æ–¹æ³•åº”è¯¥å­˜å‚¨åœ¨â€œç±»â€ä¸­ï¼Œè¿™ä¸ªâ€œç±»â€ï¼Œå°±æ˜¯ç±»å¯¹è±¡ã€‚é™¤äº†å¯¹è±¡æ–¹æ³•ä¹‹å¤–è¿˜æœ‰ç±»æ–¹æ³•ï¼Œå°±åƒå…¨å±€å‡½æ•°ï¼Œç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ã€‚</p><h2 id="æˆå‘˜å˜é‡ä¸å±æ€§"><a href="#æˆå‘˜å˜é‡ä¸å±æ€§" class="headerlink" title="æˆå‘˜å˜é‡ä¸å±æ€§"></a>æˆå‘˜å˜é‡ä¸å±æ€§</h2><p>å£°æ˜ä¸€ä¸ªYAPersonç±»ï¼Œå¹¶å¡«å……ä¸€äº›æˆå‘˜å˜é‡ã€å±æ€§ã€å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAPerson</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@public</span></span><br><span class="line">    uint age;</span><br><span class="line">    <span class="built_in">NSString</span> *nickname;</span><br><span class="line">    <span class="keyword">@private</span></span><br><span class="line">    <span class="built_in">BOOL</span> isRich;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isMale;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAPerson</span></span></span><br><span class="line">- (<span class="keyword">void</span>)singWithSongName:(<span class="built_in">NSString</span> *)songName &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"I'm singing a song named %@"</span>, songName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)canWork &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>åˆ›å»ºä¸€ä¸ªYAPersonå®ä¾‹ï¼Œå®ƒåŒ…å«äº†ç»§æ‰¿è‡ªNSObjectçš„æˆå‘˜å˜é‡isaå’Œè‡ªæœ‰çš„æˆå‘˜å˜é‡ã€‚å®ƒçš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">struct YAPerson_IMPL &#123;</span><br><span class="line">    struct NSObject_IMPL NSObject_IVARS<span class="comment">; // Class isa;</span></span><br><span class="line">    uint age<span class="comment">;</span></span><br><span class="line">    NSString *nickname<span class="comment">;</span></span><br><span class="line">    <span class="keyword">BOOL </span>isRich<span class="comment">;</span></span><br><span class="line">    <span class="keyword">BOOL </span>_isMale<span class="comment">;</span></span><br><span class="line">    NSString *_name<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>è¿«äºç»“æ„ä½“å†…å­˜å¯¹é½ã€ç³»ç»Ÿå†…å­˜å¯¹é½ä»¥åŠä¸€ä¸ªå¯¹è±¡æœ€å°16ä¸ªå­—èŠ‚çš„é™åˆ¶ï¼ŒYAPersonå®ä¾‹å ç”¨48ä¸ªå­—èŠ‚ã€‚</p><p>å½“åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡æ—¶ï¼Œç”±äºæ¶ˆæ¯æœºåˆ¶ï¼Œç±»æ–¹æ³•â€œnewâ€çš„è°ƒç”¨å®é™…ä¸Šæ˜¯è¢«è½¬æ¢ä¸ºobjc_msgSend()å‡½æ•°è°ƒç”¨ï¼Œæ¶ˆæ¯æ¥æ”¶è€…æ˜¯ç±»å¯¹è±¡ã€‚è€Œè°ƒç”¨å®ä¾‹æ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡objc_msgSend()å‡½æ•°ï¼Œåªä¸è¿‡ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å…·ä½“çš„å®ä¾‹å¯¹è±¡ã€‚è¿™é‡Œçš„å­—ç¬¦ä¸²<code>@&quot;Love&quot;</code>ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºå¸¸é‡å­—ç¬¦ä¸²ï¼Œç›´æ¥å–åœ°å€ä½¿ç”¨äº†ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">jack </span>singWithSongName:@<span class="string">"Love"</span>]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">objc_msgSend(<span class="keyword">jack, </span>sel_registerName(<span class="string">"singWithSongName:"</span>), (NSString *)&amp;__NSConstantStringImpl__var_xxxxxx)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å½“å¯¹å®ä¾‹å¯¹è±¡çš„å±æ€§è¿›è¡Œèµ‹å€¼æ—¶ï¼Œç‚¹è¯­æ³•ä¼šè¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸ºsetteræ–¹æ³•ï¼Œæœ€åè¿˜æ˜¯è°ƒç”¨objc_msgSend()å‡½æ•°ï¼š<br><code>objc_msgSend(jack, sel_registerName(&quot;setName:&quot;), (NSString *)&amp;__NSConstantStringImpl__var_xxxxxxxxx);</code></p><p>å½“å¯¹å®ä¾‹å¯¹è±¡çš„æˆå‘˜å˜é‡èµ‹å€¼æ—¶å°±æ¯”è¾ƒæœ‰è¶£äº†ï¼Œ<code>jack-&gt;age = 23;</code>ï¼Œå¤§è‡´æ˜¯è¿™ç§æ•ˆæœï¼š<br><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">#define __OFFSETOFIVAR__(<span class="name">TYPE</span>, MEMBER) ((<span class="name">long</span> long) &amp;((<span class="name">TYPE</span> *)0)-&gt;MEMBER)</span><br><span class="line">unsigned long int OBJC_IVAR_$_YAPerson$age = __OFFSETOFIVAR__(struct YAPerson, age);</span><br><span class="line">uint *ageOffset = (<span class="name">uint</span> *)((char *)jack + OBJC_IVAR_$_YAPerson$age)<span class="comment">;</span></span><br><span class="line">(<span class="name">*ageOffset</span>) = <span class="number">23</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>é¦–å…ˆé€šè¿‡<code>__OFFSETOFIVAR__</code>å®ï¼Œè·å–æˆå‘˜å˜é‡ageåœ¨<code>YAPerson_IMPL</code>ç»“æ„ä½“ä¸­çš„åç§»é‡ï¼š8ä¸ªå­—èŠ‚ï¼ˆisaå ç”¨8ä¸ªå­—èŠ‚ï¼‰ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨ä¸º<strong>å…¨å±€çš„å¸¸é‡</strong>ï¼Œæ¥ç€æ ¹æ®å®ä¾‹å¯¹è±¡jackçš„åœ°å€åŠ ä¸Šæˆå‘˜å˜é‡ageçš„åç§»é‡è·å–ageçš„åœ°å€ï¼Œæœ€åå¯¹ageè¿›è¡Œèµ‹å€¼ã€‚è¿™äº›åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±å·²ç»ç¡®å®šäº†ï¼Œä¹Ÿå³æ ¹æœ¬ä¸éœ€è¦é€šè¿‡<code>jack-&gt;age = 23;</code>è¿™æ ·çš„æŒ‡é’ˆè°ƒç”¨ã€‚ä¸€ä¸ªæˆå‘˜å˜é‡çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ivar_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">int32_t</span> *offset;  <span class="comment">// pointer to ivar offset location</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *type;</span><br><span class="line">    <span class="keyword">uint32_t</span> alignment_raw; <span class="comment">// alignment is sometimes -1; use alignment() instead</span></span><br><span class="line">    <span class="keyword">uint32_t</span> <span class="keyword">int</span> size; <span class="comment">// å ç”¨å­—èŠ‚</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alignment() <span class="keyword">const</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> WORD_SHIFT 3UL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> WORD_SHIFT 2UL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (alignment_raw == ~(<span class="keyword">uint32_t</span>)<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1U</span> &lt;&lt; WORD_SHIFT;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; alignment_raw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; ageIvar = &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$age, <span class="string">"age"</span>, <span class="string">"I"</span>, <span class="number">2</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure><p>ç”±äºåç§»é‡æ˜¯å…¨å±€çš„å¸¸é‡ï¼Œæ‰€ä»¥ä½¿ç”¨<code>int32_t *</code>ç±»å‹çš„offsetå­˜å‚¨è¿™ä¸ªåç§»é‡çš„åœ°å€ï¼Œè€Œä¸æ˜¯ä½¿ç”¨<code>int32_t</code>å­˜å‚¨è¿™ä¸ªåç§»é‡çš„å€¼ã€‚nameå’Œtypeæè¿°äº†æˆå‘˜å˜é‡çš„åç§°ä¸ç±»å‹ï¼Œalignmentçš„å€¼å–å†³äº<a href="https://developer.apple.com/documentation/objectivec/1418756-class_addivar?language=objc" target="_blank" rel="noopener">æˆå‘˜å˜é‡ç±»å‹å’Œæœºå™¨æ¶æ„</a>ï¼Œå®ƒçš„æœ€å°å€¼ä¸º2çš„næ¬¡æ–¹ã€‚sizeæ˜¯è¯¥ç±»å‹å˜é‡å ç”¨å­—èŠ‚ã€‚</p><p>ç¼–è¯‘æ—¶ç¡®å®šåç§»é‡çš„åŸå› <a href="http://zhengtingi.cc/2017/03/08/runtime1-ivar/" target="_blank" rel="noopener">æ˜¯è¿™æ ·</a>ï¼š</p><blockquote><p>In the modern runtime, if you change the layout of instance variables in a class, you do not have to recompile classes that inherit from it.<br>åœ¨ç¨‹åºå¯åŠ¨åï¼ŒruntimeåŠ è½½ç±»çš„æ—¶å€™ï¼Œé€šè¿‡è®¡ç®—åŸºç±»çš„å¤§å°ï¼ŒruntimeåŠ¨æ€è°ƒæ•´äº†ç±»æˆå‘˜å˜é‡å¸ƒå±€ã€‚äºæ˜¯æˆ‘ä»¬çš„ç¨‹åºæ— éœ€ç¼–è¯‘ï¼Œå°±èƒ½åœ¨æ–°ç‰ˆæœ¬ç³»ç»Ÿä¸Šè¿è¡Œã€‚<br>å˜é‡åœ°å€ = å¯¹è±¡åœ°å€ + ivar.offset<br>ivar.offset = åŸºç±»åœ°å€(åŠ¨æ€) + ivaråœ¨æœ¬ç±»ä¸­çš„åç§»é‡(ç¼–è¯‘æ—¶å›ºå®š)</p></blockquote><p>åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼Œæ·»åŠ æˆå‘˜å˜é‡çš„æ—¶å€™æˆ‘ä»¬ä¼šç”¨åˆ°è¿™äº›ä¿¡æ¯ï¼š<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">class_addIvar</span>(myClass, <span class="string">"someIvar"</span>, sizeof(int), log2(_Alignof(int)), <span class="variable">@encode</span>(int))</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªå‡½æ•°åªèƒ½ç”¨åœ¨åŠ¨æ€åˆ›å»ºç±»çš„æ—¶å€™ã€‚ç±»ä¸€æ—¦å®šä¹‰å®Œæ¯•å°±æ— æ³•å†ï¼ˆåœ¨åˆ†ç±»ä¸­ï¼‰æ·»åŠ æˆå‘˜å˜é‡ï¼Œå› ä¸ºâ€œç±»ä¸­æˆå‘˜å˜é‡çš„åç§»é‡æ˜¯ç”±åŸºç±»å¤§å°å’Œæœ¬ç±»ä¸­æˆå‘˜å˜é‡å…±åŒå†³å®šçš„ï¼Œå¦‚æœä¸€ä¸ªç±»æ·»åŠ äº†æˆå‘˜å˜é‡ï¼Œsizeå‘ç”Ÿäº†å˜åŒ–ï¼Œä¼šå¯¼è‡´å­ç±»æ— æ³•å·¥ä½œâ€ã€‚</p><p>ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡ä¿¡æ¯æ±‡èšåœ¨ä¸€èµ·å°±æˆä¸ºäº†æˆå‘˜å˜é‡åˆ—è¡¨<code>struct ivar_list_t</code>ï¼Œå®ƒåœ¨å†…å­˜ä¸­åªéœ€è¦ä¸€ä»½ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count; <span class="comment">// æ•°é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivar_t</span> <span class="title">ivar_list</span>[6];</span> <span class="comment">// æˆå‘˜å˜é‡æ•°ç»„</span></span><br><span class="line">&#125; _OBJC_$_INSTANCE_VARIABLES_YAPerson = &#123;</span><br><span class="line">    <span class="keyword">sizeof</span>(<span class="keyword">ivar_t</span>),</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">    &#123;&#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$age, <span class="string">"age"</span>, <span class="string">"I"</span>, <span class="number">2</span>, <span class="number">4</span>&#125;,</span><br><span class="line">    &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$nickname, <span class="string">"nickname"</span>, <span class="string">"@\"NSString\""</span>, <span class="number">3</span>, <span class="number">8</span>&#125;,</span><br><span class="line">    &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$isRich, <span class="string">"isRich"</span>, <span class="string">"B"</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$_isMale, <span class="string">"_isMale"</span>, <span class="string">"B"</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$_name, <span class="string">"_name"</span>, <span class="string">"@\"NSString\""</span>, <span class="number">3</span>, <span class="number">8</span>&#125;,</span><br><span class="line">    &#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_YAPerson$_block, <span class="string">"_block"</span>, <span class="string">"@?"</span>, <span class="number">3</span>, <span class="number">8</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><code>_OBJC_$_INSTANCE_VARIABLES_YAPerson</code>æ˜¯YAPersonç±»çš„å…¨å±€çš„æˆå‘˜å˜é‡åˆ—è¡¨ã€‚</p><p>å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼ŒObjective-Cä¸­çš„å±æ€§æŒ‡çš„å°±æ˜¯æˆå‘˜å˜é‡ä¸å­˜å–å™¨æ–¹æ³•ã€‚ä¸€èˆ¬åœ°ï¼Œå£°æ˜ä¸€ä¸ªå±æ€§çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªä¸‹åˆ’çº¿æ‰“å¤´çš„æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚<code>@property (nonatomic, copy) NSString *name;</code>ä¼šç”Ÿæˆæˆå‘˜å˜é‡ï¼š<code>NSString *_name;</code>ã€‚</p><p>åœ¨è¯­è¨€å±‚é¢ï¼Œå±æ€§æŒ‡çš„æ˜¯å±æ€§çš„åç§°ä¸å¯¹å±æ€§çš„ä¿®é¥°ï¼ˆç±»å‹ã€åŸå­æ€§ã€å†…å­˜ç­–ç•¥ç­‰ï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *attributes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>nameæ˜¯å±æ€§çš„åç§°ï¼ŒattributesåŒ…å«çš„ä¿¡æ¯å°±æ¯”è¾ƒå¤šäº†ï¼Œå¯ä»¥é€šè¿‡property_getAttributes()è·å–ï¼Œæ¯”å¦‚YAPersonçš„nameå±æ€§ï¼Œå¾—åˆ°çš„æ˜¯<code>&quot;T@\&quot;NSString\&quot;,C,N,V_name&quot;</code>ï¼Œâ€œCâ€è¡¨ç¤ºcopyï¼Œâ€œNâ€è¡¨ç¤ºnonatomicï¼Œå…·ä½“å«ä¹‰<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>è¯´çš„å¾ˆè¯¦ç»†ã€‚</p><p>å½“ç„¶ï¼Œå±æ€§åˆ—è¡¨æ˜¯æ‰€æœ‰å±æ€§çš„é›†åˆï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count_of_properties;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_t</span> <span class="title">prop_list</span>[3];</span></span><br><span class="line">&#125; _OBJC_$_PROP_LIST_YAPerson = &#123;</span><br><span class="line">    <span class="keyword">sizeof</span>(<span class="keyword">property_t</span>),</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    &#123;&#123;<span class="string">"name"</span>,<span class="string">"T@\"NSString\",C,N,V_name"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"isMale"</span>,<span class="string">"TB,R,N,V_isMale"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"block"</span>,<span class="string">"T@?,C,N,V_block"</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><code>_OBJC_$_PROP_LIST_YAPerson</code>æ˜¯YAPersonç±»çš„å…¨å±€çš„å±æ€§åˆ—è¡¨ã€‚</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><p>è®¾è®¡ä¸€ä¸ªæ–¹æ³•éœ€è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼šæ–¹æ³•åã€æ–¹æ³•å®ç°ä»¥åŠæ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ã€‚</p><h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><p>è¡¨å¾æ–¹æ³•åçš„selectoræ˜¯SELç±»å‹ï¼š<code>typedef struct objc_selector *SEL;</code>ï¼Œä¹Ÿå³â€œDefines an opaque type that represents a method selectorâ€ã€‚å…³äºå®ƒçš„è§£é‡Šç›®å‰ä¸»è¦æœ‰ä¸¤ç§çœ‹æ³•ï¼š<br>ä¸€ã€æœ‰äººæ ¹æ®Runtimeæºç ä¸­çš„å®šä¹‰å’Œå®˜æ–¹æ–‡æ¡£è®¤ä¸ºå®ƒæ˜¯æŒ‡å‘objc_selectorç»“æ„ä½“çš„æŒ‡é’ˆï¼Œä½†æ˜¯objc_selectorç»“æ„ä½“çš„å…·ä½“å®ç°å¹¶æ²¡æœ‰å¼€æºã€‚<br>äºŒã€æœ‰äººè¯´å®ƒå°±æ˜¯Cè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡<code>const char *</code>ç±»å‹ï¼Œç†ç”±æ˜¯Runtimeæºç ä¸­sel_getName()çš„å‡½æ•°å®ç°è¡¨æ˜äº†<code>SEL</code>ç±»å‹å¯ä»¥ç›´æ¥è½¬æ¢ä¸º<code>const char *</code>ç±»å‹ï¼Œè€Œä¸”â€œå¯¹äºå­—ç¬¦ä¸²çš„æ¯”è¾ƒä»…ä»…éœ€è¦æ¯”è¾ƒä»–ä»¬çš„åœ°å€å°±å¯ä»¥â€ï¼Œåœ¨å„ç§æŸ¥æ‰¾ä¸­é€Ÿåº¦æ›´å¿«ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">sel_getName</span><span class="params">(SEL sel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) <span class="keyword">return</span> <span class="string">"&lt;null selector&gt;"</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">const</span> <span class="keyword">char</span> *)(<span class="keyword">const</span> <span class="keyword">void</span>*)sel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘è§‰å¾—è¿™ä¸¤ç§çœ‹æ³•å¯ä»¥ç»“åˆä¸€ä¸‹ï¼ŒSELæ˜¯æŒ‡å‘objc_selectorç»“æ„ä½“çš„æŒ‡é’ˆï¼Œobjc_selectorçš„å®ç°åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[];</span><br><span class="line">    <span class="comment">// æ„é€ </span></span><br><span class="line">    objc_selector(<span class="keyword">char</span> name[]) &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(<span class="keyword">this</span>-&gt;name, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>1.ä»ç»“æœä¸Šçœ‹ï¼Œå¯ä»¥æ»¡è¶³ç›´æ¥è½¬æ¢ä¸º<code>const char *</code>ç±»å‹ï¼šstrçš„å€¼å°±æ˜¯â€œnewâ€ã€‚ä»æœ¬è´¨ä¸Šçœ‹ï¼ŒæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆå°±æ˜¯æŒ‡å‘ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆnameæ•°ç»„ï¼‰çš„æŒ‡é’ˆã€‚<br><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºç»“æ„ä½“</span></span><br><span class="line">objc_selector selector = &#123;<span class="string">"new"</span>&#125;;</span><br><span class="line"><span class="comment">// pä¸ºæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆ</span></span><br><span class="line">objc_selector *p = &amp;selector;</span><br><span class="line"><span class="comment">// å°† p å¼ºåˆ¶è½¬åŒ–ä¸º const char * ç±»å‹</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">char</span> *<span class="built_in">str</span> = (<span class="keyword">const</span> <span class="built_in">char</span> *)p;</span><br><span class="line"><span class="comment">// å®é™…ä¸Šsträ¸ç»“æ„ä½“ä¸­çš„nameæ˜¯ç­‰ä»·çš„</span></span><br><span class="line"><span class="built_in">bool</span> res = (<span class="built_in">str</span> == p-&gt;name);</span><br></pre></td></tr></table></figure></p><p>2.ä¸SELçš„å†…å­˜è¡¨ç°æ˜¯ä¸€è‡´çš„ã€‚éœ€è¦æ ¹æ®æ–¹æ³•åçš„é•¿åº¦ï¼Œåˆ›å»ºç›¸åº”é•¿åº¦çš„nameæ•°ç»„ã€‚æ¯”å¦‚â€œnewâ€æ–¹æ³•ï¼Œå ç”¨4ä¸ªå­—èŠ‚ï¼š<code>6e 65 77 00</code>ã€‚</p><figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">objc_selector selector = &#123;"new"&#125;;</span><br><span class="line">objc_selector *p = &amp;selector;</span><br><span class="line">SEL sel = @selector(new);</span><br><span class="line">   </span><br><span class="line">(lldb) x p</span><br><span class="line">0x16f825c78: 6e<span class="number"> 65 </span>77<span class="number"> 00 </span>01<span class="number"> 00 </span>00<span class="number"> 00 </span>a0<span class="number"> 85 </span>c0<span class="number"> 00 </span>01<span class="number"> 00 </span>00<span class="number"> 00 </span> new.............</span><br><span class="line">(lldb) x sel</span><br><span class="line">0x1fc67fc8f: 6e<span class="number"> 65 </span>77<span class="number"> 00 </span>69<span class="number"> 73 </span>61<span class="number"> 00 </span>63 6f 6e<span class="number"> 66 </span>6f<span class="number"> 72 </span>6d<span class="number"> 73 </span> new.isa.conforms</span><br></pre></td></tr></table></figure><p>çœ‹æºç ä¸éš¾å¾—çŸ¥ï¼Œç›¸åŒåç§°å¯¹åº”çš„selectoråœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªï¼Œå­˜å‚¨åœ¨NXMapTableä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´é€šè¿‡<code>@selector()</code>è¯­æ³•ç³–ã€<code>sel_registerName()</code>å‡½æ•°ã€<code>NSSelectorFromString()</code>å‡½æ•°ï¼Œéƒ½æ˜¯ä»NXMapTableä¸­å–å‡ºselectorã€‚å¦‚æœè¿™ä¸ªåç§°å¯¹åº”çš„selectorå·²ç»æ³¨å†Œåœ¨Runtimeï¼ˆå­˜å‚¨åœ¨NXMapTableï¼‰ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æ³¨å†Œï¼Œæ‰ä¼šè¿›è¡Œåˆ›å»ºã€‚ä¸åŒæŒ‡é’ˆå˜é‡æŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºå•¥å¯ä»¥ä½¿ç”¨<code>==</code>è¿ç®—ç¬¦æ¯”è¾ƒã€‚</p><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¡¨å¾æ–¹æ³•åçš„selectorè¦è®¾è®¡æˆç»“æ„ä½“è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨<code>const char *</code>ï¼Ÿ</p><blockquote><p>When using selectors, you must use the value returned from sel_registerName or the Objective-C compiler directive @selector(). You cannot simply cast a C string to SEL.</p></blockquote><p>è‹¹æœå¸Œæœ›æˆ‘ä»¬ä½¿ç”¨è¯¸å¦‚sel_registerName()è¿™äº›è½¬åŒ–å‡½æ•°ï¼Œå°±æ˜¯æƒ³è®©æ–¹æ³•åä¸selectorå»ºç«‹æ˜ å°„ï¼ŒåŒæ—¶æŠŠselectorçº³å…¥ç®¡ç†ã€‚è€Œä¸æ˜¯åƒè¿™æ ·ï¼š</p><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SEL </span><span class="keyword">sel </span>= (<span class="keyword">SEL)"show";</span></span><br><span class="line"><span class="keyword">[view </span>performSelector:<span class="keyword">sel];</span></span><br></pre></td></tr></table></figure><h3 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h3><p>å¯¹äºä¸€èˆ¬çš„å‡½æ•°æ¥è¯´ï¼Œå‡½æ•°åä¹Ÿæ˜¯æŒ‡å‘å‡½æ•°å®ç°çš„æŒ‡é’ˆã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºfuncå‡½æ•°ï¼Œ<code>func()</code>æ˜¯é€šè¿‡å‡½æ•°åè°ƒç”¨ï¼Œ<code>(*func)()</code>æ˜¯é€šè¿‡æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆè°ƒç”¨ã€‚åœ¨Objective-Cä¸­ï¼ŒIMPå°±æ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆã€‚</p><p>æ ‡å‡†çš„IMPå®šä¹‰æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">typedef id (*<span class="type">IMP</span>)(id, <span class="type">SEL</span>, ...);</span><br></pre></td></tr></table></figure></p><p>åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„å‚æ•°ã€è¿”å›å€¼é‡æ–°å®šä¹‰ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> *(*_IMP)(<span class="keyword">id</span> ,SEL, ...);</span><br><span class="line">SEL sel = <span class="keyword">@selector</span>(description);</span><br><span class="line"><span class="built_in">NSObject</span> *obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">_IMP imp = (_IMP)class_getMethodImplementation(obj.class, sel);</span><br><span class="line"><span class="keyword">if</span> (imp) &#123;</span><br><span class="line">    <span class="comment">// å‡½æ•°åè°ƒç”¨</span></span><br><span class="line">    <span class="built_in">NSString</span> *desc1 = imp(obj, sel);</span><br><span class="line">    <span class="comment">// å‡½æ•°æŒ‡é’ˆè°ƒç”¨</span></span><br><span class="line">    <span class="built_in">NSString</span> *desc2 = (*imp)(obj, sel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>ä¸ºäº†ç®€ä¾¿åœ°æè¿°ç±»å‹ã€ä¿®é¥°ç¬¦ï¼Œå­—ç¬¦ä¸²å½¢å¼çš„<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1" target="_blank" rel="noopener">ç±»å‹ç¼–ç </a>äº§ç”Ÿäº†ã€‚<code>const char *type = @encode(int)</code>åœ¨ç¼–è¯‘æ—¶ä¾¿è¿”å›äº†å­—ç¬¦ä¸²å¸¸é‡â€œiâ€ï¼Œç”¨æ¥è¡¨æ˜è¿™æ˜¯intç±»å‹ã€‚ä½†æ˜¯æœ‰ä¸€äº›åƒ<code>const</code>ã€<code>inout</code>ç­‰æ–¹æ³•å‚æ•°çš„ä¿®é¥°ç¬¦æ— æ³•é€šè¿‡@encode()è·å–ã€‚å¯¹äºæ–¹æ³•æ¥è¯´ï¼Œ<code>const char *method_getTypeEncoding(Method m)</code>å‡½æ•°å¯ä»¥ç›´æ¥è¿”å›æ–¹æ³•å®Œæ•´çš„Type Encodeã€‚è¿™é‡Œçš„Methodæ˜¯é›†æˆäº†æ–¹æ³•åSELã€å‡½æ•°æŒ‡é’ˆã€ç±»å‹ç¼–ç çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">typedef struct method_t *<span class="function"><span class="keyword">Method</span>;</span></span><br><span class="line">struct method_t <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    SEL name;</span></span><br><span class="line"><span class="comment">    const char *types;</span></span><br><span class="line"><span class="comment">    IMP imp;</span></span><br><span class="line"><span class="comment">&#125;</span>;</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ–¹æ³•å­˜æ”¾åœ¨ç±»å¯¹è±¡ä¹‹ä¸­ï¼Œè¿™æ ·ï¼Œç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨å°±äº§ç”Ÿäº†ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">    <span class="keyword">struct</span> method_t method_list[<span class="number">6</span>];</span><br><span class="line">&#125; _OBJC_$_INSTANCE_METHODS_YAPerson = &#123;</span><br><span class="line">    <span class="keyword">sizeof</span>(method_t),</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">    &#123;&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"singWithSongName:"</span>, <span class="string">"v24@0:8@16"</span>, (<span class="keyword">void</span> *)_I_YAPerson_singWithSongName_&#125;,</span><br><span class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"name"</span>, <span class="string">"@16@0:8"</span>, (<span class="keyword">void</span> *)_I_YAPerson_name&#125;,</span><br><span class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"setName:"</span>, <span class="string">"v24@0:8@16"</span>, (<span class="keyword">void</span> *)_I_YAPerson_setName_&#125;,</span><br><span class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"isMale"</span>, <span class="string">"B16@0:8"</span>, (<span class="keyword">void</span> *)_I_YAPerson_isMale&#125;,</span><br><span class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"block"</span>, <span class="string">"@?16@0:8"</span>, (<span class="keyword">void</span> *)_I_YAPerson_block&#125;,</span><br><span class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"setBlock:"</span>, <span class="string">"v24@0:8@?16"</span>, (<span class="keyword">void</span> *)_I_YAPerson_setBlock_&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ç±»æ–¹æ³•ä¿å­˜åœ¨å…ƒç±»å¯¹è±¡ä¹‹ä¸­ï¼Œå¯¹äºYAPersonï¼Œåªæœ‰ä¸€ä¸ªç±»æ–¹æ³•<code>canWork</code>ï¼Œå…¶æ–¹æ³•åˆ—è¡¨æ˜¯è¿™æ ·ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span>  &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">method_t</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_CLASS_METHODS_YAPerson = &#123;</span><br><span class="line">    <span class="keyword">sizeof</span>(<span class="keyword">method_t</span>),</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    &#123;&#123;(struct objc_selector *)<span class="string">"canWork"</span>, <span class="string">"B16@0:8"</span>, (<span class="keyword">void</span> *)_C_YAPerson_canWork&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>æˆå‘˜å˜é‡åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€å®ä¾‹æ–¹æ³•åˆ—è¡¨ã€ç±»æ–¹æ³•åˆ—è¡¨éƒ½å·²ç»æœ‰äº†ï¼Œé‚£ä¹ˆä¸€ä¸ªç±»çš„ç»“æ„ä¹Ÿå°±å‡ºæ¥äº†ã€‚</p><h2 id="ç±»"><a href="#ç±»" class="headerlink" title="ç±»"></a>ç±»</h2><p>classã€meta-classã€root meta-classçš„æœ¬è´¨éƒ½æ˜¯objc_classç»“æ„ä½“ï¼Œä¸”éƒ½æ˜¯ä»¥å•ä¾‹çš„å½¢å¼è¡¨ç°åœ¨å†…å­˜ä¸­ã€‚objc_classç»§æ‰¿è‡ªobjc_objectï¼Œå®ƒçš„cacheå­˜å‚¨ç€ç¼“å­˜çš„æ–¹æ³•åˆ—è¡¨ï¼Œbitsä¸­çš„ä¸€äº›ä½å­˜å‚¨ç€æŒ‡å‘class_rw_tçš„æŒ‡é’ˆã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceSize;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * ivarLayout;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    <span class="comment">//  baseMethodListã€baseProtocolsã€ivarsã€basePropertiesæ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ˜¯åªè¯»çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹</span></span><br><span class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</span><br><span class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * weakIvarLayout;</span><br><span class="line">    <span class="keyword">property_list_t</span> *baseProperties;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</span><br><span class="line">    <span class="comment">// methodsã€propertiesã€protocolsæ˜¯äºŒç»´æ•°ç»„ï¼Œæ˜¯å¯è¯»å¯å†™çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ã€åˆ†ç±»çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">method_array_t</span> methods;</span><br><span class="line">    <span class="keyword">property_array_t</span> properties;</span><br><span class="line">    <span class="keyword">protocol_array_t</span> protocols;</span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line">    <span class="keyword">char</span> *demangledName;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">isa_t</span> isa;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// bits &amp; FAST_DATA_MASKå¯ä»¥è·å–class_rw_t</span></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>YAPersonç±»å¯¹è±¡çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceSize;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * ivarLayout;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    <span class="comment">//  baseMethodListã€baseProtocolsã€ivarsã€basePropertiesæ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ˜¯åªè¯»çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹</span></span><br><span class="line">    <span class="keyword">method_list_t</span> * baseMethodList; <span class="comment">// æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols; <span class="comment">// åè®®åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars; <span class="comment">// æˆå‘˜å˜é‡åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * weakIvarLayout; </span><br><span class="line">    <span class="keyword">property_list_t</span> *baseProperties; <span class="comment">// å±æ€§åˆ—è¡¨</span></span><br><span class="line">&#125; _OBJC_CLASS_RO_$_YAPerson = &#123;</span><br><span class="line">    <span class="number">0</span>, </span><br><span class="line">    <span class="comment">// è®¡ç®— YAPerson ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡åœ¨ç»“æ„ä½“ä¸­çš„åç§»é‡</span></span><br><span class="line">    __OFFSETOFIVAR__(struct YAPerson, age),</span><br><span class="line">    <span class="keyword">sizeof</span>(struct YAPerson_IMPL),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="string">"YAPerson"</span>,</span><br><span class="line">    (<span class="keyword">method_list_t</span> *)&amp;_OBJC_$_INSTANCE_METHODS_YAPerson,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">ivar_list_t</span> *)&amp;_OBJC_$_INSTANCE_VARIABLES_YAPerson,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (<span class="keyword">property_list_t</span> *)&amp;_OBJC_$_PROP_LIST_YAPerson,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…ƒç±»å¯¹è±¡ä¸ç±»å¯¹è±¡çš„ç»“æ„æ˜¯ç›¸åŒçš„ï¼Œå°±YAPersonè€Œè¨€ï¼Œä¸»è¦å­˜å‚¨äº†ç±»æ–¹æ³•åˆ—è¡¨ï¼Œå†…å®¹æ˜¯è¿™æ ·ï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span></span> _OBJC_METACLASS_RO_$_YAPerson = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">class_t</span></span>), <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">class_t</span></span>),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="string">"YAPerson"</span>,</span><br><span class="line">    (<span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span></span> *)&amp;_OBJC_$_CLASS_METHODS_YAPerson,</span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="äºŒã€åè®®"><a href="#äºŒã€åè®®" class="headerlink" title="äºŒã€åè®®"></a>äºŒã€åè®®</h1><p>åè®®è§„å®šäº†åè®®éµå®ˆè€…éœ€è¦å®ç°çš„æ–¹æ³•ã€‚å¦‚æœåœ¨åè®®ä¸­å£°æ˜ä¸€ä¸ªå±æ€§ï¼Œå®é™…ä¸Šç›¸å½“äºåœ¨åè®®ä¸­æ·»åŠ äº†è¯¥å±æ€§å¯¹åº”çš„å­˜å–å™¨æ–¹æ³•å£°æ˜ã€‚å¯¹äºåè®®éµå®ˆè€…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œéœ€è¦åˆæˆè¯¥å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡ï¼š<code>@synthesize å±æ€§å;</code>ã€‚<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@class</span> YAStudent;</span><br><span class="line"><span class="variable">@protocol</span> YAStudentProtocol &lt;NSObject&gt;</span><br><span class="line"><span class="variable">@required</span></span><br><span class="line"><span class="comment">// å®ä¾‹å±æ€§</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) BOOL isExcellent;</span><br><span class="line"><span class="comment">// ç±»å±æ€§</span></span><br><span class="line"><span class="variable">@property</span> (class, nonatomic, copy) NSString *protocolName;</span><br><span class="line"><span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isSame</span><span class="selector-pseudo">:(YAStudent</span> *)<span class="selector-tag">person</span>;</span><br><span class="line"><span class="comment">// ç±»æ–¹æ³•</span></span><br><span class="line">+ (NSString *)<span class="selector-tag">description</span>;</span><br><span class="line">@<span class="selector-tag">optional</span></span><br><span class="line"><span class="comment">// å¯é€‰çš„å®ä¾‹å±æ€§</span></span><br><span class="line">@<span class="selector-tag">property</span> (readonly, copy) <span class="selector-tag">NSString</span> *<span class="selector-tag">debugDescription</span>;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢å£°æ˜çš„åè®®çš„å¯¹åº”çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">protocol_t</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span> <span class="comment">// åè®®åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *instanceMethods; <span class="comment">// å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *classMethods; <span class="comment">// ç±»æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalInstanceMethods; <span class="comment">// å¯é€‰çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalClassMethods; <span class="comment">// å¯é€‰çš„ç±»æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">property_list_t</span> *instanceProperties; <span class="comment">// å®ä¾‹å±æ€§åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **_extendedMethodTypes;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *_demangledName;</span><br><span class="line">    <span class="keyword">property_list_t</span> *_classProperties; <span class="comment">// ç±»å±æ€§åˆ—è¡¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬ä¸ºC++å</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">protocol_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * isa;  <span class="comment">// NULL</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *protocol_name; <span class="comment">// åè®®å</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">protocol_list_t</span> * <span class="title">protocol_list</span>;</span> <span class="comment">// super protocols</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">instance_methods</span>;</span> <span class="comment">// å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">class_methods</span>;</span> <span class="comment">//ç±»æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">optionalInstanceMethods</span>;</span> <span class="comment">// å¯é€‰çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">optionalClassMethods</span>;</span> <span class="comment">// å¯é€‰çš„ç±»æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> * <span class="title">properties</span>;</span> <span class="comment">// å±æ€§åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> size;  <span class="comment">// sizeof(struct _protocol_t)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;  <span class="comment">// = 0</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> ** extendedMethodTypes; <span class="comment">// æ–¹æ³•type</span></span><br><span class="line">&#125; = &#123;</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="string">"YAStudentProtocol"</span>,</span><br><span class="line">    (<span class="keyword">const</span> struct <span class="keyword">_protocol_list_t</span> *)&amp;_OBJC_PROTOCOL_REFS_YAStudentProtocol,</span><br><span class="line">    (<span class="keyword">const</span> struct <span class="keyword">method_list_t</span> *)&amp;_OBJC_PROTOCOL_INSTANCE_METHODS_YAStudentProtocol,</span><br><span class="line">    (<span class="keyword">const</span> struct <span class="keyword">method_list_t</span> *)&amp;_OBJC_PROTOCOL_CLASS_METHODS_YAStudentProtocol,</span><br><span class="line">    (<span class="keyword">const</span> struct <span class="keyword">method_list_t</span> *)&amp;_OBJC_PROTOCOL_OPT_INSTANCE_METHODS_YAStudentProtocol,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (<span class="keyword">const</span> struct <span class="keyword">_prop_list_t</span> *)&amp;_OBJC_PROTOCOL_PROPERTIES_YAStudentProtocol,</span><br><span class="line">    <span class="keyword">sizeof</span>(<span class="keyword">_protocol_t</span>),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">char</span> **)&amp;_OBJC_PROTOCOL_METHOD_TYPES_YAStudentProtocol</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåè®®ä¸»è¦å­˜å‚¨äº†æ–¹æ³•ã€‚åè®®çš„æ–¹æ³•åˆ—è¡¨å’Œç±»å¯¹è±¡ä¸­çš„æ–¹æ³•åˆ—è¡¨ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹ï¼Œåè®®æ–¹æ³•åˆ—è¡¨ä¸­çš„æ–¹æ³•Methodæ²¡æœ‰å…·ä½“å®ç°IMPã€‚ä¹Ÿå®¹æ˜“ç†è§£ï¼Œæ¯•ç«Ÿåè®®åªèƒ½æä¾›æ–¹æ³•åã€æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½ä¸ºåè®®æ·»åŠ æ–¹æ³•å®ç°å‘¢ï¼Ÿæœ‰ã€‚å› ä¸ºï¼Œåè®®ç»§æ‰¿è‡ªobjc_objectï¼Œæ‰€ä»¥åè®®ä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚å½“è·å–å®ƒçš„superclassæ—¶ï¼Œå‘ç°å°±æ˜¯NSObjectã€‚<br><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">Protocol *<span class="keyword">pro</span> = objc_getProtocol(<span class="string">"YAStudentProtocol"</span>);</span><br><span class="line"></span><br><span class="line">(lldb) po [<span class="keyword">pro</span> <span class="keyword">class</span>]</span><br><span class="line">Protocol</span><br><span class="line">(lldb) po [<span class="keyword">pro</span> superclass]</span><br><span class="line">NSObject</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆï¼ŒæŠŠå®ƒå½“åšä¸€ä¸ªæ™®é€šå¯¹è±¡å³å¯ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">Method me = class_getInstanceMethod(YAStudent.class, <span class="keyword">@selector</span>(show));</span><br><span class="line">IMP imp = method_getImplementation(me);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *type = method_getTypeEncoding(me);</span><br><span class="line"><span class="built_in">BOOL</span> success = class_addMethod(<span class="built_in">NSClassFromString</span>(<span class="string">@"Protocol"</span>), <span class="keyword">@selector</span>(show), imp, type);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line">   <span class="comment">// "åˆ›å»º"ä¸€ä¸ªå«"YAStudentProtocol"çš„åè®®å¯¹è±¡, å®ƒçš„classæ˜¯Protocol, å®ƒçš„superclassæ˜¯NSObject</span></span><br><span class="line">   Protocol *pro = objc_getProtocol(<span class="string">"YAStudentProtocol"</span>);</span><br><span class="line">   <span class="comment">// è°ƒç”¨åè®®å¯¹è±¡çš„showæ–¹æ³•</span></span><br><span class="line">   <span class="built_in">NSString</span> *result = [(<span class="keyword">id</span>)pro performSelector:<span class="keyword">@selector</span>(show)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è™½ç„¶è¿™ä¹ˆåšæ„ä¹‰å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯è„‘æ´å†å¤§ä¸€ç‚¹ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åªè¦éµå®ˆä¸€ä¸ªåè®®ï¼Œé‚£ä¹ˆå°±æ‹¥æœ‰äº†åè®®ä¸­çš„æ–¹æ³•å£°æ˜å’Œæ–¹æ³•å®ç°å‘¢ï¼Ÿæœ‰ã€‚ProtocolKitè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="ä¸‰ã€ç±»æ‰©å±•ä¸åˆ†ç±»"><a href="#ä¸‰ã€ç±»æ‰©å±•ä¸åˆ†ç±»" class="headerlink" title="ä¸‰ã€ç±»æ‰©å±•ä¸åˆ†ç±»"></a>ä¸‰ã€ç±»æ‰©å±•ä¸åˆ†ç±»</h1><p>ç±»æ‰©å±•å’Œåˆ†ç±»éƒ½å¯ä»¥ç»™å·²æœ‰çš„ç±»æ·»åŠ åŠŸèƒ½ï¼Œä¸åŒçš„æ˜¯ç±»æ‰©å±•æ˜¯ç¼–è¯‘æ—¶åˆå¹¶åˆ°ç±»ä¸­ï¼Œåˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶åˆå¹¶åˆ°ç±»ä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">category_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">// ä¸»ç±»çš„åç§°</span></span><br><span class="line">    <span class="keyword">classref_t</span> cls; <span class="comment">// ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">instanceMethods</span>;</span> <span class="comment">// å®ä¾‹æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">classMethods</span>;</span> <span class="comment">// ç±»æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span> <span class="comment">// åè®®åˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *<span class="title">instanceProperties</span>;</span> <span class="comment">// å®ä¾‹å±æ€§åˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *_<span class="title">classProperties</span>;</span> <span class="comment">// ç±»å±æ€§åˆ—è¡¨</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯åˆ›å»ºä¸€ä¸ªåˆ†ç±»æ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ª_category_tç»“æ„ä½“ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">category_t</span> _<span class="title">OBJC_</span>$_<span class="title">CATEGORY_YAStudent_</span>$_<span class="title">HighSchoolStudent</span>;</span></span><br></pre></td></tr></table></figure></p><p>æ ¹æ®æºç ï¼Œåˆ†ç±»ä¸­çš„å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰ä¿¡æ¯ï¼Œåˆå¹¶åˆ°ä¸»ç±»ä¸­çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Attach method lists and properties and protocols from categories to a class.</span></span><br><span class="line"><span class="comment">// Assumes the categories in cats are all loaded and sorted by load order, </span></span><br><span class="line"><span class="comment">// oldest categories first.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attachCategories</span><span class="params">(Class cls, category_list *cats, <span class="keyword">bool</span> flush_caches)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿è¯ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (!cats) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// "log methods replaced by category implementations"</span></span><br><span class="line">    <span class="keyword">if</span> (PrintReplacedMethods) printReplacements(cls, cats);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯å…ƒç±»å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨ç©ºé—´åˆ†é… fixme rearrange to remove these intermediate allocations</span></span><br><span class="line">    <span class="keyword">method_list_t</span> **mlists = (<span class="keyword">method_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*mlists));</span><br><span class="line">    <span class="keyword">property_list_t</span> **proplists = (<span class="keyword">property_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*proplists));</span><br><span class="line">    <span class="keyword">protocol_list_t</span> **protolists = (<span class="keyword">protocol_list_t</span> **)</span><br><span class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*protolists));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count backwards through cats to get newest categories first</span></span><br><span class="line">    <span class="keyword">int</span> mcount = <span class="number">0</span>; <span class="comment">// æ–¹æ³•æ•°é‡</span></span><br><span class="line">    <span class="keyword">int</span> propcount = <span class="number">0</span>; <span class="comment">// å±æ€§æ•°é‡</span></span><br><span class="line">    <span class="keyword">int</span> protocount = <span class="number">0</span>; <span class="comment">// åè®®æ•°é‡</span></span><br><span class="line">    <span class="keyword">int</span> i = cats-&gt;count; <span class="comment">// åˆ†ç±»æ•°é‡</span></span><br><span class="line">    <span class="keyword">bool</span> fromBundle = NO;</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="comment">// å–å‡ºåˆ†ç±»åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªåˆ†ç±»</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; entry = cats-&gt;<span class="built_in">list</span>[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">method_list_t</span> *mlist = entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        <span class="keyword">if</span> (mlist) &#123;</span><br><span class="line">            mlists[mcount++] = mlist;</span><br><span class="line">            fromBundle |= entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å±æ€§åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">property_list_t</span> *proplist = </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">            proplists[propcount++] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–åè®®åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">protocol_list_t</span> *protolist = entry.cat-&gt;protocols;</span><br><span class="line">        <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">            protolists[protocount++] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> rw = cls-&gt;data();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™„åŠ </span></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">    <span class="built_in">free</span>(mlists);</span><br><span class="line">    <span class="keyword">if</span> (flush_caches &amp;&amp; mcount &gt; <span class="number">0</span>) flushCaches(cls);</span><br><span class="line"></span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    <span class="built_in">free</span>(proplists);</span><br><span class="line"></span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    <span class="built_in">free</span>(protolists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ†ç±»ä¿¡æ¯æ˜¯æŒ‰ç…§åˆ†ç±»åˆ—è¡¨çš„é€†åºé€ä¸ªè¿›è¡Œåˆå¹¶ï¼Œåˆ†ç±»åˆ—è¡¨çš„é¡ºåºæ˜¯ç”±åŠ è½½é¡ºåºç¡®å®šçš„ã€‚æ–¹æ³•ã€å±æ€§ã€åè®®æ•°ç»„ç­‰ï¼Œéƒ½æ˜¯äºŒç»´æ•°ç»„ï¼Œä¸€ç»´å¯¹åº”ç€åˆ†ç±»ï¼ŒäºŒç»´å¯¹åº”ç€æ¯æ¡ä¿¡æ¯ã€‚</p><p>é™„åŠ è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachLists</span><span class="params">(List* <span class="keyword">const</span> * addedLists, <span class="keyword">uint32_t</span> addedCount)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (addedCount == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> (hasArray()) &#123;</span><br><span class="line">       <span class="comment">// many lists -&gt; many lists</span></span><br><span class="line">       <span class="keyword">uint32_t</span> oldCount = <span class="built_in">array</span>()-&gt;count;</span><br><span class="line">       <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">       <span class="comment">// é‡æ–°åˆ†é…newCountçš„å†…å­˜</span></span><br><span class="line">       setArray((<span class="keyword">array_t</span> *)<span class="built_in">realloc</span>(<span class="built_in">array</span>(), <span class="keyword">array_t</span>::byteSize(newCount)));</span><br><span class="line">       <span class="built_in">array</span>()-&gt;count = newCount;</span><br><span class="line">       <span class="comment">// æŠŠaddedListsæ”¾åˆ°è€æ•°æ®çš„å‰é¢, å½¢æˆæ–°çš„array()-&gt;lists</span></span><br><span class="line">       memmove(<span class="built_in">array</span>()-&gt;lists + addedCount, <span class="built_in">array</span>()-&gt;lists, </span><br><span class="line">               oldCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">       <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </span><br><span class="line">              addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">list</span>  &amp;&amp;  addedCount == <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="comment">// 0 lists -&gt; 1 list</span></span><br><span class="line">       <span class="built_in">list</span> = addedLists[<span class="number">0</span>];</span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// 1 list -&gt; many lists</span></span><br><span class="line">       List* oldList = <span class="built_in">list</span>;</span><br><span class="line">       <span class="keyword">uint32_t</span> oldCount = oldList ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">       setArray((<span class="keyword">array_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">array_t</span>::byteSize(newCount)));</span><br><span class="line">       <span class="built_in">array</span>()-&gt;count = newCount;</span><br><span class="line">       <span class="comment">// æŠŠoldListæ”¾åˆ°addedListsçš„åé¢</span></span><br><span class="line">       <span class="keyword">if</span> (oldList) <span class="built_in">array</span>()-&gt;lists[addedCount] = oldList;</span><br><span class="line">       <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </span><br><span class="line">              addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å„ç§æƒ…å†µéƒ½æœ‰è€ƒè™‘ï¼Œä½†æ˜¯ç›®çš„åªæœ‰ä¸€ä¸ªï¼šæŠŠaddedListsæ’å…¥åˆ°åŸæœ‰æ•°æ®çš„å‰é¢ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåˆ†ç±»ä¸­çš„æ–¹æ³•ä¸ä¸»ç±»ä¸­çš„æ–¹æ³•åŒåæ—¶ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨åˆ†ç±»çš„ã€‚è¡¨é¢ä¸Šçœ‹æ˜¯â€œè¦†ç›–â€ï¼Œå®é™…ä¸Šæ–¹æ³•éƒ½æ˜¯å­˜åœ¨çš„ï¼Œåªä¸è¿‡ä¸€æ—¦åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ°éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œå°±ä¸å†å¾€ä¸‹æ‰¾äº†ã€‚</p><h1 id="å››ã€å…³è”å¯¹è±¡"><a href="#å››ã€å…³è”å¯¹è±¡" class="headerlink" title="å››ã€å…³è”å¯¹è±¡"></a>å››ã€å…³è”å¯¹è±¡</h1><p>ç”±äºå†…å­˜å¸ƒå±€åœ¨ç±»å®šä¹‰åå°±å·²ç»å›ºå®šï¼Œæ‰€æœ‰æ²¡æœ‰åŠæ³•åœ¨åˆ†ç±»ä¸­æ·»åŠ æˆå‘˜å˜é‡ï¼Œä½†æ˜¯ç›¸ä¼¼çš„åœºæ™¯è¿˜æ˜¯æœ‰çš„ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°å…³è”å¯¹è±¡ã€‚</p><p>è®¾ç½®å…³è”å¯¹è±¡çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="number">_</span><span class="keyword">object</span><span class="number">_</span>set<span class="number">_</span>associative<span class="number">_</span>reference(id <span class="keyword">object</span>, <span class="keyword">void</span> *key, id <span class="keyword">value</span>, uintptr<span class="number">_</span>t policy) &#123;</span><br><span class="line">    <span class="comment">// retain the new value (if any) outside the lock.</span></span><br><span class="line">    ObjcAssociation old<span class="number">_</span>association(<span class="number">0</span>, nil);</span><br><span class="line">    <span class="comment">// å¦‚æœä¿®é¥°ç­–ç•¥æ˜¯OBJC_ASSOCIATION_SETTER_RETAIN, åˆ™new_value = [value retain]</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¿®é¥°ç­–ç•¥æ˜¯OBJC_ASSOCIATION_SETTER_COPY, åˆ™new_value = [value copy]</span></span><br><span class="line">    id <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span> = <span class="keyword">value</span> ? acquireValue(<span class="keyword">value</span>, policy) : nil;</span><br><span class="line"></span><br><span class="line">    AssociationsManager manager;</span><br><span class="line">    <span class="comment">// è·å–å“ˆå¸Œè¡¨(AssociationsHashMap)çš„å¼•ç”¨: associations</span></span><br><span class="line">    AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">    <span class="comment">// è·å–objectçš„"æŒ‰ä½å–åå€¼"</span></span><br><span class="line">    unsigned long disguised<span class="number">_</span><span class="keyword">object</span> = DISGUISE(<span class="keyword">object</span>); <span class="comment">// ~(unsigned long)(object)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®objectçš„"æŒ‰ä½å–åå€¼"ä½œä¸ºkey, æŸ¥æ‰¾å¯¹åº”çš„iterator, å¦‚æœªæŸ¥æ‰¾åˆ°ï¼Œè¿”å›end()</span></span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised<span class="number">_</span><span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123; <span class="comment">// objectå·²ç»è®¾ç½®è¿‡å…³è”å¯¹è±¡, åˆ™éœ€è¦æ›´æ–°keyå¯¹åº”çš„å¯¹è±¡</span></span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs-&gt;end()) &#123; <span class="comment">// æ‰¾åˆ°keyå¯¹åº”çš„å¯¹è±¡, è·å–æ—§çš„å¯¹è±¡, è®¾ç½®æ–°çš„å¯¹è±¡</span></span><br><span class="line">                old<span class="number">_</span>association = j-&gt;second;</span><br><span class="line">                j-&gt;second = ObjcAssociation(policy, <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ²¡æœ‰æ‰¾åˆ°keyå¯¹åº”çš„å¯¹è±¡, è¿™æ˜¯ä¸€ä¸ªæ–°çš„key</span></span><br><span class="line">                (*refs)[key] = ObjcAssociation(policy, <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// è¯´æ˜åœ¨AssociationsHashMapä¸­, objectç›®å‰è¿˜æ²¡æœ‰å¯¹åº”çš„ObjectAssociationMap, ä¹Ÿå³æ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®å…³è”å¯¹è±¡, åˆ™åˆ›å»ºObjectAssociationMap</span></span><br><span class="line">            ObjectAssociationMap *refs = <span class="keyword">new</span> ObjectAssociationMap;</span><br><span class="line">            <span class="comment">// å­˜å‚¨refs</span></span><br><span class="line">            associations[disguised<span class="number">_</span><span class="keyword">object</span>] = refs;</span><br><span class="line">            <span class="comment">// åœ¨refä¸­å­˜å‚¨å…³è”ç­–ç•¥å’Œnew_value</span></span><br><span class="line">            (*refs)[key] = ObjcAssociation(policy, <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>);</span><br><span class="line">            <span class="comment">// æ ‡æ˜å½“å‰ç±»å…·æœ‰å…³è”ç±», å®ƒä¼šå°†isaä¸­çš„has_assocæ ‡è®°ä¸ºtrue</span></span><br><span class="line">            <span class="keyword">object</span>-&gt;setHasAssociatedObjects();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// valueä¸ºç©º, è¯´æ˜æ˜¯è¦åˆ é™¤åŸå…ˆçš„å…³è”å¼•ç”¨(ä¸€èˆ¬ä¹Ÿæ˜¯è¿™ä¹ˆç”¨çš„, è€Œä¸æ˜¯ä½¿ç”¨remove)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾å¯¹åº”çš„iterator</span></span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised<span class="number">_</span><span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">if</span> (i !=  associations.end()) &#123; <span class="comment">// è¯´æ˜æ˜¯æœ‰å€¼çš„</span></span><br><span class="line">            <span class="comment">// è·å–å€¼(firstæ˜¯é”®, secondæ˜¯å€¼): ObjectAssociationMap</span></span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            <span class="comment">// æ ¹æ®å‚æ•°key, è·å–åœ¨refsä¸­å¯¹åº”çš„iterator</span></span><br><span class="line">            ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">                <span class="comment">// è·å–æ—§å€¼</span></span><br><span class="line">                old<span class="number">_</span>association = j-&gt;second;</span><br><span class="line">                <span class="comment">// æŠŠå‚æ•°keyå¯¹åº”çš„å¯¹è±¡æ“¦é™¤</span></span><br><span class="line">                refs-&gt;erase(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ—§çš„å…³è”å¯¹è±¡ä¸ä¸ºç©º, å°±æŠŠå®ƒrelease.  release the old value (outside of the lock).</span></span><br><span class="line">    <span class="keyword">if</span> (old<span class="number">_</span>association.hasValue()) ReleaseValue()(old<span class="number">_</span>association);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è·å–å…³è”å¯¹è±¡çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id _object_get_associative_reference(<span class="name">id</span> object, void *key) &#123;</span><br><span class="line">    id value = nil;</span><br><span class="line">    uintptr_t policy = OBJC_ASSOCIATION_ASSIGN;</span><br><span class="line">    AssociationsManager manager;</span><br><span class="line">    // è·å–AssociationsHashMap</span><br><span class="line">    AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">    disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line">    AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">    if (i != associations.end()) &#123;</span><br><span class="line">        // æ‰¾åˆ°ObjectAssociationMap</span><br><span class="line">        ObjectAssociationMap *refs = i-&gt;second<span class="comment">;</span></span><br><span class="line">        ObjectAssociationMap:<span class="symbol">:iterator</span> j = refs-&gt;find(<span class="name">key</span>)<span class="comment">;</span></span><br><span class="line">        if (<span class="name">j</span> != refs-&gt;end()) &#123;</span><br><span class="line">            // å†æ‰¾åˆ°ObjcAssociation</span><br><span class="line">            ObjcAssociation <span class="symbol">&amp;entry</span> = j-&gt;second<span class="comment">;</span></span><br><span class="line">            // å–å‡ºå…³è”å¯¹è±¡å’Œå…³è”ç­–ç•¥</span><br><span class="line">            value = entry.value()<span class="comment">;</span></span><br><span class="line">            policy = entry.policy()<span class="comment">;</span></span><br><span class="line">            // ç­–ç•¥æ˜¯retainçš„è¯, è·å–[value retain]</span><br><span class="line">            if (<span class="name">policy</span> &amp; OBJC_ASSOCIATION_GETTER_RETAIN) ((<span class="name">id</span>(<span class="name">*</span>)(<span class="name">id</span>, SEL))objc_msgSend)(<span class="name">value</span>, SEL_retain)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (<span class="name">value</span> <span class="symbol">&amp;&amp;</span> (<span class="name">policy</span> &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) &#123;</span><br><span class="line">        // ç­–ç•¥æ˜¯autoreleaseçš„è¯, è·å–[value autorelease]</span><br><span class="line">        ((<span class="name">id</span>(<span class="name">*</span>)(<span class="name">id</span>, SEL))objc_msgSend)(<span class="name">value</span>, SEL_autorelease)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    return value<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ•´ä½“æ¥çœ‹æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæœ‰åŒå­¦ç”»äº†<a href="https://www.neroxie.com/2019/07/23/ä»æºç ç†è§£å…³è”å±æ€§/" target="_blank" rel="noopener">ä¸€å¹…å›¾</a>ï¼Œå¾ˆæ¸…æ™°åœ°è¯´æ˜äº†å­˜å‚¨å±‚æ¬¡ï¼š<br><img src="https://image.chenyalun.com/2019/01/28/001.png" style="zoom:80%"></p><p>å…³è”å¯¹è±¡çš„å­˜å‚¨ä¸ç±»çš„å­˜å‚¨æ²¡æœ‰å…³ç³»ã€‚å…¨å±€çš„AssociationsHashMapå­˜å‚¨ç€æ‰€æœ‰å¯¹è±¡ä¸å…³è”å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼Œå¹¶ç”±AssociationsManagerç®¡ç†ã€‚åœ¨AssociationsHashMapä¸­ï¼Œæ¯ä¸ªå¯¹è±¡çš„â€œæŒ‰ä½å–åå€¼â€ä½œä¸ºé”®ï¼Œæ¯ä¸ªå¯¹è±¡å¯¹åº”çš„ObjectAssociationMapä½œä¸ºå€¼ã€‚åœ¨ObjectAssociationMapä¸­ï¼Œå‚æ•°keyä½œä¸ºé”®ï¼Œå…³è”çš„å¯¹è±¡è¢«åŒ…è£…æˆObjcAssociationå¹¶ä½œä¸ºå€¼å­˜å‚¨ã€‚</p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬æŠŠgetteræ–¹æ³•çš„selectorä½œä¸ºkeyï¼Œé¿å…äº†æ–°å˜é‡çš„äº§ç”Ÿï¼›åœ¨ç§»é™¤å…³è”å¯¹è±¡æ—¶ï¼Œå¸¸å¸¸ä½¿ç”¨objc_setAssociatedObject()å‡½æ•°ï¼Œä¼ å…¥ç©ºçš„objectï¼Œè€Œä¸æ˜¯ä½¿ç”¨objc_removeAssociatedObjects()å‡½æ•°ç›´æ¥æŠŠæ‰€æœ‰çš„å…³è”å¯¹è±¡éƒ½ç»™ç§»é™¤ã€‚</p><p>ä¸€ä¸ªå¯¹è±¡åœ¨é”€æ¯ä¹‹å‰ï¼Œä¼šè‡ªåŠ¨ç§»é™¤å®ƒæ‰€æœ‰çš„å…³è”å¯¹è±¡ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå¯ä»¥å®ç°ä¸hook deallocæ–¹æ³•è€Œåœ¨<a href="http://www.tanhao.me/pieces/160626.html/" target="_blank" rel="noopener">ä¸€ä¸ªå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç»“æŸçš„æ—¶å€™è§¦å‘ä¸€ä¸ªæ“ä½œ</a>ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åˆ©ç”¨ä¸€ä¸ªä¸­é—´å¯¹è±¡ï¼Œè®©å®ƒä¿å­˜éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œåœ¨å…¶deallocæ—¶æ‰§è¡Œæ“ä½œã€‚è€ŒæŠŠè¿™ä¸ªä¸­é—´å¯¹è±¡ï¼ˆæˆ–è€…ä¿å­˜ä¸­é—´å¯¹è±¡çš„æ•°ç»„ï¼Œäº¦æˆ–è€…æ˜¯blockï¼‰ä½œä¸ºåˆ†ç±»çš„å…³è”å±æ€§ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§æ€è·¯å§ã€‚</p><p>æœ€åå°±æ˜¯å¾ˆæœ‰æ„æ€çš„weakå…³è”å±æ€§ï¼Œè¿™ä¸ªåœ¨<a href="https://blog.chenyalun.com/2019/01/20/Weak%20Associated%20Object/">ã€ŠWeak Associated Objectã€‹</a>ä¸€æ–‡ä¸­ä¸“é—¨åšäº†æ€è€ƒä¸è¯´æ˜ï¼Œå·§å¦™åœ°åˆ©ç”¨ç°æˆçš„weakå…³é”®å­—å’Œblockå³å¯è½»æ¾å®ç°ã€‚</p><h1 id="äº”ã€æ¶ˆæ¯æœºåˆ¶"><a href="#äº”ã€æ¶ˆæ¯æœºåˆ¶" class="headerlink" title="äº”ã€æ¶ˆæ¯æœºåˆ¶"></a>äº”ã€æ¶ˆæ¯æœºåˆ¶</h1><p>Objective-Cä¸­çš„å®ä¾‹æ–¹æ³•è°ƒç”¨å’Œç±»æ–¹æ³•è°ƒç”¨éƒ½æ˜¯åŸºäºæ¶ˆæ¯æœºåˆ¶çš„ï¼Œé€šè¿‡å‘é€æ¶ˆæ¯è€Œä¸æ˜¯ç›´æ¥çš„å‡½æ•°è°ƒç”¨ä½¿å¾—è¿™ä¸ªè¯­è¨€éå¸¸å…·æœ‰åŠ¨æ€æ€§ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</p><p>å‡å®šYAStudentç»§æ‰¿è‡ªYAPersonï¼ŒYAPersonç»§æ‰¿è‡ªNSObjectã€‚</p><p>ä»¥YAStudentä¸ºæ¨¡æ¿åˆ›å»ºå‡ºä¸€ä¸ªstudentå®ä¾‹ï¼Œå®ƒçš„å®ä¾‹æ–¹æ³•å¤§è‡´æ˜¯è¿™ä¹ˆè°ƒç”¨çš„ï¼šé¦–å…ˆä¼šå…ˆé€šè¿‡isaæ‰¾åˆ°YAStudentçš„ç±»å¯¹è±¡ï¼Œåœ¨ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨æ‰¾åˆ°ç›®æ ‡æ–¹æ³•ï¼Œæ²¡æœ‰æ‰¾åˆ°çš„è¯å†é€šè¿‡superclassæ‰¾åˆ°YAPersonçš„ç±»å¯¹è±¡ï¼Œå†åœ¨å…¶æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œæ²¡æœ‰æ‰¾åˆ°çš„è¯å†é€šè¿‡superclassæ‰¾åˆ°NSObjectçš„ç±»å¯¹è±¡ï¼Œçœ‹æ˜¯å¦èƒ½åœ¨å…¶æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ°å¹¶è°ƒç”¨ã€‚</p><p>YAStudentçš„ç±»æ–¹æ³•å¤§è‡´æ˜¯è¿™ä¹ˆè°ƒç”¨çš„ï¼šä¼šå…ˆé€šè¿‡isaæ‰¾åˆ°YAStudentçš„å…ƒç±»å¯¹è±¡ï¼Œåœ¨å…¶æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ç›®æ ‡æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å†é€šè¿‡superclassæ‰¾åˆ°YAPersonçš„å…ƒç±»å¯¹è±¡ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°å°±å†é€šè¿‡superclassæ‰¾åˆ°NSObjectçš„å…ƒç±»å¯¹è±¡ï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°çš„è¯<strong>æœ€åå†é€šè¿‡isaæ‰¾åˆ°NSObjectç±»å¯¹è±¡</strong>ï¼Œçœ‹æ˜¯å¦èƒ½åœ¨å…¶æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ°å¹¶è°ƒç”¨ã€‚</p><p>å®ä¾‹å¯¹è±¡çš„isaæŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡çš„isaæŒ‡å‘æ ¹å…ƒç±»ï¼Œæ ¹å…ƒç±»çš„isaæŒ‡å‘å®ƒè‡ªå·±ã€‚ç±»å¯¹è±¡çš„superclassæŒ‡é’ˆæŒ‡å‘çˆ¶ç±»çš„ç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡çš„superclassæŒ‡é’ˆæŒ‡å‘çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡ï¼Œ<strong>æ ¹å…ƒç±»çš„superclassæŒ‡é’ˆæŒ‡å‘æ ¹ç±»ï¼ˆNSObjectï¼‰</strong>ã€‚</p><p>ç”±äºæ ¹å…ƒç±»çš„superclassæŒ‡é’ˆæŒ‡å‘æ ¹ç±»ï¼Œè¿™å°±è§£é‡Šäº†<code>[NSObject show];</code>è¿™æ ·æ˜æ˜æ˜¯ç±»æ–¹æ³•è°ƒç”¨å´æˆåŠŸå˜æˆäº†è°ƒç”¨NSObjectçš„showå®ä¾‹æ–¹æ³•ã€‚<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> NSObject (YAShow)</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> NSObject (YAShow)</span><br><span class="line">- (void)show &#123;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"- (void)show"</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure></p><h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h2><p>ç¼–è¯‘å™¨ä¼šå°†æ–¹æ³•çš„è°ƒç”¨è½¬æ¢ä¸ºobjc_msgSendã€objc_msgSend_stretã€objc_msgSendSuperå’Œobjc_msgSendSuper_stretã€‚</p><blockquote><p>å‘é€ç»™å¯¹è±¡çš„çˆ¶ç±»çš„æ¶ˆæ¯ä¼šä½¿ç”¨ objc_msgSendSuper;<br>æœ‰æ•°æ®ç»“æ„ä½œä¸ºè¿”å›å€¼çš„æ–¹æ³•ä¼šä½¿ç”¨ objc_msgSendSuper_stret æˆ– objc_msgSend_stret;<br>å…¶å®ƒçš„æ¶ˆæ¯éƒ½æ˜¯ä½¿ç”¨ objc_msgSend å‘é€çš„ã€‚</p></blockquote><p>objc_msgSendçš„å…·ä½“å®ç°ç”±æ±‡ç¼–è¯­è¨€ç¼–å†™è€Œæˆï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š</p><ol><li><p>ä¸€ä¸ªC++å‡½æ•°ä¸å¯èƒ½è°ƒç”¨ä»»æ„çš„å‡½æ•°æŒ‡é’ˆï¼Œå®ƒå¯ä»¥é‡è½½ã€æœ‰å¯å˜å‚æ•°ï¼Œä½†æ˜¯ä¸å¯èƒ½æœ‰å¯å˜çš„è¿”å›å€¼ã€‚</p></li><li><p>é€šè¿‡ä½¿ç”¨æ±‡ç¼–ï¼Œå¯ä»¥å…å»å¤§é‡å±€éƒ¨å˜é‡æ‹·è´çš„æ“ä½œï¼Œå‚æ•°ä¼šç›´æ¥è¢«å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œå½“æ‰¾åˆ°IMPæ—¶ï¼Œå‚æ•°å·²ç»ä¿å­˜åœ¨äº†å¯„å­˜å™¨ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé€Ÿåº¦æ›´å¿«ã€‚</p></li></ol><p>ç¬¬ä¸€æ¡çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼Œå‡å®šobjc_msgSendæ˜¯ä½¿ç”¨C++å®ç°ï¼Œé‚£ä¹ˆä»è¯­æ³•å±‚é¢å®ƒéœ€è¦åšåˆ°èƒ½æ¥æ”¶å¯å˜å‚æ•°ã€è¿”å›å€¼ç±»å‹å¯ä»¥ä»»æ„ã€‚æ¯”å¦‚è¿”å›å€¼ç±»å‹å¯ä»¥æ˜¯<code>NSUInteger</code>ä¹Ÿå¯ä»¥æ˜¯<code>id</code>ï¼š</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">NSUInteger n = [<span class="keyword">array</span> count];</span><br><span class="line">id obj = [<span class="keyword">array</span> objectAtIndex:<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬åŒ–å</span></span><br><span class="line">NSUInteger n = (NSUInteger <span class="comment">(*)(id, SEL))objc_msgSend(array,  @selector(count));</span></span><br><span class="line"><span class="comment">id obj = (id (*)</span>(id, SEL, NSUInteger))objc_msgSend(<span class="keyword">array</span>, @<span class="keyword">selector</span>(objectAtIndex:), <span class="number">6</span>);</span><br></pre></td></tr></table></figure><p>å¯å˜å‚æ•°å¯ä»¥åšåˆ°ï¼Œä»»æ„è¿”å›å€¼ç±»å‹è²Œä¼¼å¯ä»¥åˆ©ç”¨é‡è½½ï¼Œä½†æ˜¯ä»…ä»…è¿”å›å€¼ç±»å‹ä¸åŒæ— æ³•æ„æˆé‡è½½ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘é€šä¸è¿‡</span></span><br><span class="line"><span class="built_in">NSUInteger</span> objc_msgSend(<span class="keyword">id</span>, SEL, ...) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span> objc_msgSend(<span class="keyword">id</span>, SEL, ...) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è€Œä¸”å°±ç®—è¿™ä¸¤æ¡éƒ½åšåˆ°äº†ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•æ”¯æ’‘æ— ç©·æ— å°½çš„ä»»æ„å‡½æ•°æŒ‡é’ˆâ€”ä¸å¯èƒ½æŠŠæ‰€æœ‰å‡½æ•°æŒ‡é’ˆä¸€ä¸€ç©·ä¸¾ã€‚</p><blockquote><p>objc_msgSendçš„è§£å†³åŠæ³•ï¼Œä¸»è¦ä¾æ®çš„æ˜¯ï¼šå½“objc_msgSendè¢«è°ƒç”¨æ—¶ï¼Œæ‰€æœ‰çš„å‚æ•°å·²ç»è¢«è®¾ç½®å¥½äº†ã€‚<br>æ¢ä¸€ç§æ–¹å¼æ¥è¯´ï¼Œå°±æ˜¯ï¼šåœ¨objc_msgSendå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ ˆå¸§ï¼ˆstack frameï¼‰çš„çŠ¶æ€ã€æ•°æ®ï¼Œå’Œå„ä¸ªå¯„å­˜å™¨çš„ç»„åˆå½¢å¼ã€æ•°æ®ï¼Œè·Ÿè°ƒç”¨å…·ä½“çš„å‡½æ•°æŒ‡é’ˆï¼ˆIMPï¼‰æ—¶æ‰€éœ€çš„çŠ¶æ€ã€æ•°æ®ï¼Œæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼</p></blockquote><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">ENTRY _objc_msgSend</span><br><span class="line">UNWIND _objc_msgSend, NoFrame</span><br><span class="line">MESSENGER_START</span><br><span class="line"></span><br><span class="line">cmp<span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#0</span>// æ¶ˆæ¯æ¥æ”¶è€…ä¸ºç©ºï¼Œè¿”å›<span class="number">0</span></span><br><span class="line">b.leLNilOrTagged//  (MSB tagged pointer looks negative)</span><br><span class="line">ldr<span class="keyword">x</span><span class="number">13</span>, [<span class="keyword">x</span><span class="number">0</span>]// <span class="keyword">x</span><span class="number">13</span> = isa</span><br><span class="line"><span class="keyword">and</span><span class="keyword">x</span><span class="number">16</span>, <span class="keyword">x</span><span class="number">13</span>, #ISA_MASK// <span class="keyword">x</span><span class="number">16</span> = class</span><br><span class="line">LGetIsaDone:</span><br><span class="line">CacheLookup NORMAL// calls imp <span class="keyword">or</span> objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">LNilOrTagged:</span><br><span class="line">b.<span class="keyword">eq</span>LReturnZero// nil check</span><br><span class="line"></span><br><span class="line">// tagged</span><br><span class="line">mov<span class="keyword">x</span><span class="number">10</span>, <span class="symbol">#0</span>xf<span class="number">000000000000000</span></span><br><span class="line">cmp<span class="keyword">x</span><span class="number">0</span>, <span class="keyword">x</span><span class="number">10</span></span><br><span class="line">b.hsLExtTag</span><br><span class="line">adrp<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGE</span></span><br><span class="line"><span class="keyword">add</span><span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGEOFF</span></span><br><span class="line">ubfx<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#60</span>, <span class="symbol">#4</span></span><br><span class="line">ldr<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</span><br><span class="line">bLGetIsaDone</span><br><span class="line"></span><br><span class="line">LExtTag:</span><br><span class="line">// ext tagged</span><br><span class="line">adrp<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGE</span></span><br><span class="line"><span class="keyword">add</span><span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGEOFF</span></span><br><span class="line">ubfx<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#52</span>, <span class="symbol">#8</span></span><br><span class="line">ldr<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</span><br><span class="line">bLGetIsaDone</span><br><span class="line"></span><br><span class="line">LReturnZero:</span><br><span class="line">// <span class="keyword">x</span><span class="number">0</span> is already zero</span><br><span class="line">mov<span class="keyword">x</span><span class="number">1</span>, <span class="symbol">#0</span></span><br><span class="line">movid<span class="number">0</span>, <span class="symbol">#0</span></span><br><span class="line">movid<span class="number">1</span>, <span class="symbol">#0</span></span><br><span class="line">movid<span class="number">2</span>, <span class="symbol">#0</span></span><br><span class="line">movid<span class="number">3</span>, <span class="symbol">#0</span></span><br><span class="line">MESSENGER_END_NIL</span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">END_ENTRY _objc_msgSend</span><br></pre></td></tr></table></figure><h2 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h2><p>å½“ä¸€ä¸ªæ–¹æ³•æ²¡æœ‰ç›¸åº”çš„å®ç°æ—¶ï¼Œå°±ä¼šè¿›å…¥æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œåœ¨è¿™å¥—æµç¨‹ä¸­ï¼Œå¯ä»¥åŠ¨æ€å¢åŠ æ–¹æ³•å®ç°ã€‚</p><h3 id="ç¬¬ä¸€é˜¶æ®µ"><a href="#ç¬¬ä¸€é˜¶æ®µ" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ"></a>ç¬¬ä¸€é˜¶æ®µ</h3><p><strong>åœ¨åŠ¨æ€æ–¹æ³•è§£æä¸­å¯ä»¥ç›´æ¥æ·»åŠ ä¸Šå‡½æ•°å®ç°ã€‚</strong><br>æ¯”å¦‚è°ƒç”¨YAPersonçš„instanceShowå®ä¾‹æ–¹æ³•ï¼Œå½“åˆ¤æ–­å‡ºè¿™ä¸ªselectoræ˜¯<code>instanceShow</code>çš„æ—¶å€™ï¼Œåœ¨<code>resolveInstanceMethod</code>æ–¹æ³•ä¸­ä¸º<code>instanceShow</code>å®ä¾‹æ–¹æ³•æ·»åŠ ä¸Šå‡½æ•°å®ç°<code>instanceFunc</code>ã€‚è€Œå¯¹äºclassShowç±»æ–¹æ³•ï¼Œåœ¨<code>resolveClassMethod</code>æ–¹æ³•ä¸­ä¸ºclassShowæ–¹æ³•æ·»åŠ ä¸Šå‡½æ•°å®ç°<code>classFunc</code>ã€‚</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">instanceFunc</span>(id self, SEL _cmd) &#123;</span><br><span class="line">   <span class="selector-tag">NSLog</span>(@<span class="string">"%@, %p"</span>, self, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (sel_isEqual(sel, <span class="variable">@selector</span>(instanceShow))) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ å…³äºç±»å¯¹è±¡çš„selå®ç°</span></span><br><span class="line">        <span class="selector-tag">class_addMethod</span>(self.class, sel, (IMP)instanceFunc, <span class="string">"@:"</span>);</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super resolveInstanceMethod:sel]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»æ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">classFunc</span>(id self, SEL _cmd) &#123;</span><br><span class="line">   <span class="selector-tag">NSLog</span>(@<span class="string">"%@, %p"</span>, self, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)<span class="selector-tag">resolveClassMethod</span><span class="selector-pseudo">:(SEL)sel</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (sel_isEqual(sel, <span class="variable">@selector</span>(classShow))) &#123;</span><br><span class="line">         <span class="comment">// æ·»åŠ å…³äºå…ƒç±»å¯¹è±¡çš„selå®ç°</span></span><br><span class="line">         <span class="selector-tag">class_addMethod</span>(object_getClass(self), sel, (IMP)classFunc, <span class="string">"@:"</span>);</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super resolveClassMethod:sel]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢„å…ˆæŠŠå‡½æ•°å®ç°éƒ½å†™å¥½äº†ï¼Œå†é€šè¿‡class_addMethod()æŠŠå®ç°æ·»åŠ åˆ°æ–¹æ³•ä¸­ï¼Œé‚£ä½•ä¸å¦‚ç›´æ¥å®Œæ•´åœ°æŠŠæ–¹æ³•å®ç°å†™äº†ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œç›´æ¥æŠŠinstanceShowå®ä¾‹æ–¹æ³•å’ŒclassShowç±»æ–¹æ³•å®Œæ•´åœ°å†™å‡ºæ¥ä¸å°±è¡Œäº†ï¼Ÿä½•å¿…å¤šæ­¤ä¸€ä¸¾ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™ä¸€é˜¶æ®µå¸¸æ˜¯é…åˆ<code>@dynamic</code>æ¥ä½¿ç”¨ã€‚<a href="http://www.peerassembly.com/blog/using-dynamic-properties-to-access-nsuserdefaults.html" target="_blank" rel="noopener">peerassembly</a>ä¸¾äº†ä¸€ä¸ªè¿˜ä¸é”™çš„ä¾‹å­ï¼š<br>å‡å®šéœ€è¦é€šè¿‡Preferencesæ¥ç®¡NSUserDefaultsï¼Œç”±å®ƒæä¾›å„ä¸ªkeyçš„å­˜å–æ¥å£ï¼Œé‚£ä¸€èˆ¬éœ€è¦è¿™ä¹ˆåšï¼š<br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">Preferences </span>: NSObject &#123;</span><br><span class="line">    <span class="selector-tag">NSUserDefaults</span> *<span class="selector-tag">_defaults</span>;</span><br><span class="line">&#125;</span><br><span class="line">+ (Preferences *)<span class="selector-tag">sharedInstance</span>;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">property</span> (nonatomic, assign) <span class="selector-tag">BOOL</span> <span class="selector-tag">autoStartBreak</span>;</span><br><span class="line"><span class="comment">// ... è¿˜æœ‰å¥½å¤šå±æ€§</span></span><br><span class="line">@<span class="selector-tag">end</span></span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Preferences</span></span><br><span class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">autoStartBreak</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[_defaults boolForKey:@"autoStartBreak"]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">setAutoStartBreak</span><span class="selector-pseudo">:(BOOL)autoStartBreak</span> &#123;</span><br><span class="line">    <span class="selector-attr">[_defaults setBool:autoStartBreak forKey:@"autoStartBreak"]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... å†™å¥½å¤šå¥½å¤š</span></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p><p>éœ€è¦å¯¹æ¯ä¸€ä¸ªå±æ€§éƒ½å†™ä¸Šå­˜å–æ–¹æ³•çš„å®ç°ï¼Œå¦‚æœæœ‰20ä¸ªå±æ€§ï¼Œå²‚ä¸æ˜¯è¦å†™40ä¸ªæ–¹æ³•ï¼Ÿ</p><p>è¦æ˜¯å€ŸåŠ©<code>resolveInstanceMethod()</code>ï¼Œå°±å¯ä»¥è¿™ä¹ˆåŠï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Preferences</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> autoStartBreak;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> iaFromSmartApp;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> isDarkMode;</span><br><span class="line"><span class="comment">// ... è¿˜æœ‰å¥½å¤šå±æ€§</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *_dynamicProperties;</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Preferences</span></span></span><br><span class="line"><span class="keyword">@dynamic</span> autoStartBreak, iaFromSmartApp, isDarkMode;</span><br><span class="line"><span class="built_in">BOOL</span> paprefBoolGetter(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(_cmd);</span><br><span class="line">    PAPropertyDescriptor *propertyDescriptor = _dynamicProperties[selectorString];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSUserDefaults</span>.standardUserDefaults boolForKey:propertyDescriptor.name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> paprefBoolSetter(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">BOOL</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(_cmd);</span><br><span class="line">    PAPropertyDescriptor *propertyDescriptor = _dynamicProperties[selectorString];</span><br><span class="line">    [<span class="built_in">NSUserDefaults</span>.standardUserDefaults setBool:value forKey:propertyDescriptor.name];</span><br><span class="line">    [<span class="built_in">NSUserDefaults</span>.standardUserDefaults synchronize];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">    PAPropertyDescriptor *propertyDescriptor = [PAPropertyDescriptor new];</span><br><span class="line">    <span class="keyword">if</span> ([selectorString hasPrefix:<span class="string">@"set"</span>]) &#123; <span class="comment">// setAutoStartBreak --&gt;autoStartBreak</span></span><br><span class="line">        <span class="built_in">NSString</span> *first = [selectorString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">3</span>, <span class="number">1</span>)];</span><br><span class="line">        <span class="built_in">NSString</span> *prop = [selectorString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, selectorString.length - <span class="number">5</span>)];</span><br><span class="line">        propertyDescriptor.name = [first.lowercaseString stringByAppendingString:prop];</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>.class, sel, (IMP)paprefBoolSetter, <span class="string">"v@:B"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        propertyDescriptor.name = selectorString;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>.class, sel, (IMP)paprefBoolGetter, <span class="string">"B@:"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!_dynamicProperties[selectorString]) &#123;</span><br><span class="line">        _dynamicProperties[selectorString] = propertyDescriptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>é€šè¿‡å»ºç«‹æ˜ å°„ï¼ŒæŠŠæ‰€ä»¥å­˜å–å™¨éƒ½ç»Ÿä¸€çº³å…¥ç®¡ç†ï¼Œæ›´æ¸…æ™°é«˜æ•ˆã€‚ä¸Šé¢çš„åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œè¿˜è¦è€ƒè™‘è®¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚æ”¯æŒä¸åŒç±»å‹çš„å±æ€§ã€æ›¿æ¢é»˜è®¤çš„æ–¹æ³•å®ç°ç­‰ï¼Œè¿™ä¸ªä½œè€…å·²ç»å†™äº†ä¸€ä¸ªå®Œæ•´çš„ç»„ä»¶ï¼Œå¯å‚è€ƒ<a href="https://github.com/dhennessy/PAPreferences/blob/master/PAPreferences/PAPreferences.m" target="_blank" rel="noopener">PAPreferences</a>ã€‚</p><h3 id="ç¬¬äºŒé˜¶æ®µ"><a href="#ç¬¬äºŒé˜¶æ®µ" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ"></a>ç¬¬äºŒé˜¶æ®µ</h3><p><strong>å°†æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–targetã€‚</strong><br>ç¬¬ä¸€é˜¶æ®µä¸­æ— æ³•åŠæ—¶æ·»åŠ ä¸Šç›¸åº”çš„æ–¹æ³•å®ç°ï¼Œå°±ä¼šè¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡ŒæŠŠæ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡å¤„ç†ã€‚å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼Œéœ€è¦å®ç°<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>ï¼Œå¦‚æœæ˜¯ç±»æ–¹æ³•ï¼Œåˆ™éœ€è¦å®ç°<code>+ (id)forwardingTargetForSelector:(SEL)aSelector</code>ã€‚</p><p>å‡å®šYAPersonçš„instanceShowå®ä¾‹æ–¹æ³•æ²¡æœ‰å…·ä½“çš„å®ç°ï¼Œè€ŒYASingerå´æ˜¯æœ‰çš„ï¼Œé‚£å¯ä»¥æŠŠæ¶ˆæ¯è½¬å‘ç»™YASingerå®ä¾‹å¯¹è±¡ï¼Œäº¤ç”±å®ƒå¤„ç†ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [YASinger <span class="keyword">new</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å‡å®šYADanceræœ‰classShowç±»æ–¹æ³•çš„å®ç°ï¼Œé‚£å¯ä»¥æŠŠæ¶ˆæ¯è½¬å‘ç»™YADancerç±»å¯¹è±¡ï¼š<br><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line"><span class="built_in">    return</span> YADancer.<span class="built_in">class</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Šï¼ŒæŠŠYAPersonçš„æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡ï¼ˆå®ä¾‹å¯¹è±¡æˆ–è€…ç±»å¯¹è±¡ï¼‰ä¹‹åï¼Œå…¶ä»–å¯¹è±¡å°±ä¼šå¼€å¯æ–°ä¸€è½®çš„æ¶ˆæ¯è§£æï¼Œå®ƒå¦‚æœæ²¡æœ‰å¯¹åº”çš„æ–¹æ³•å®ç°ï¼ŒåŒæ ·ä¼šå¼€å¯è¿™ä¸‰ä¸ªé˜¶æ®µã€‚å› æ­¤ï¼Œå…¶ä»–å¯¹è±¡ä¸ä¸€å®šè¦å®Œå®Œæ•´æ•´åœ°å…·å¤‡YAPersonæ‰€ç¼ºçœçš„æ–¹æ³•å®ç°ã€‚</p><h3 id="ç¬¬ä¸‰é˜¶æ®µ"><a href="#ç¬¬ä¸‰é˜¶æ®µ" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µ"></a>ç¬¬ä¸‰é˜¶æ®µ</h3><p><strong>å®Œæ•´çš„æ¶ˆæ¯è½¬å‘ã€‚</strong><br>å¦‚è‹¥å‰ä¸¤ä¸ªé˜¶æ®µéƒ½æ²¡åŠæ³•å¦¥å–„åœ°å¤„ç†ï¼Œå°±ä¼šè¿›å…¥æ¶ˆæ¯è§£æçš„ç¬¬ä¸‰é˜¶æ®µã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œä½¿ç”¨<code>forwardInvocation</code>é…åˆ<code>methodSignatureForSelector</code>å¯¹æ¶ˆæ¯åšæœ€åä¸€æ­¥çš„å¤„ç†ã€‚</p><p>é¦–å…ˆä¼šè§£æmethodSignatureForSelectorï¼Œåªæœ‰å½“å®ƒè¿”å›çš„æ–¹æ³•ç­¾åä¸ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šè¿›å…¥forwardInvocationæµç¨‹ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯¹è¯¥æ–¹æ³•é‡å†™å¹¶è¿”å›ä¸€ä¸ªä¸ä¸ºç©ºçš„signatureã€‚<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    NSMethodSignature *signature = [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>aSelector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([YAMethodHelper <span class="string">instancesRespondToSelector:</span>aSelector]) &#123;</span><br><span class="line">            signature = [YAMethodHelper <span class="string">instanceMethodSignatureForSelector:</span>aSelector];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¥ç€åœ¨forwardInvocationä¸­è·å–åˆ›å»ºçš„NSInvocationå¯¹è±¡ï¼Œè°ƒç”¨selectorå³å¯ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([YAMethodHelper <span class="string">instancesRespondToSelector:</span>anInvocation.selector]) &#123;</span><br><span class="line">        [anInvocation <span class="string">invokeWithTarget:</span>_helper];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ˜¯å¾ˆä¼ ç»Ÿçš„å¤„ç†æ­¥éª¤ï¼Œå®é™…ä¸Šåªè¦ä¿è¯methodSignatureForSelectorè¿”å›ä¸€ä¸ªä¸ä¸ºç©ºçš„æ–¹æ³•ç­¾åï¼Œå¯ä»¥åœ¨forwardInvocationä¸­å¯¹NSInvocationå¯¹è±¡åšè‚†æ„æ›´æ”¹ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *signature = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">      <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">           signature = [<span class="built_in">NSObject</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(<span class="keyword">class</span>)];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨NSObjectå¯¹è±¡çš„descriptionæ–¹æ³•</span></span><br><span class="line">    anInvocation.selector = <span class="keyword">@selector</span>(description);</span><br><span class="line">    [anInvocation invokeWithTarget:[<span class="built_in">NSObject</span> new]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå‰ææ˜¯è¿™ä¹ˆåšæœ‰æ„ä¹‰ã€‚</p><p>å…¶å®åœ¨è¿™ä¸€é˜¶æ®µè¿˜å¯ä»¥å®ç°<a href="http://kittenyang.com/forwardinvocation/" target="_blank" rel="noopener">ä¼ªå¤šç»§æ‰¿</a>ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector&#123;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *first = [(<span class="built_in">NSObject</span> *)<span class="keyword">self</span>.firstDelegate methodSignatureForSelector:aSelector];</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *second = [(<span class="built_in">NSObject</span> *)<span class="keyword">self</span>.secondDelegate methodSignatureForSelector:aSelector];</span><br><span class="line">    <span class="keyword">if</span> (first)&#123;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(second) &#123;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation&#123;</span><br><span class="line">    SEL aSelector = [anInvocation selector];</span><br><span class="line">    <span class="keyword">if</span>([<span class="keyword">self</span>.firstDelegate respondsToSelector:aSelector])&#123;</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.firstDelegate];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>([<span class="keyword">self</span>.secondDelegate respondsToSelector:aSelector])&#123;</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.secondDelegate];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector&#123;</span><br><span class="line">    <span class="keyword">if</span>([<span class="keyword">self</span>.firstDelegate respondsToSelector:aSelector] || [<span class="keyword">self</span>.secondDelegate respondsToSelector:aSelector])&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>NSObjectçš„forwardInvocation:æ–¹æ³•å®ç°åªæ˜¯ç®€å•è°ƒç”¨äº†doesNotRecognizeSelector:æ–¹æ³•ï¼Œå®ƒä¸ä¼šè½¬å‘ä»»ä½•æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œå¦‚æœä¸åœ¨ä»¥ä¸Šæ‰€è¿°çš„ä¸‰ä¸ªæ­¥éª¤ä¸­å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ã€‚</p></blockquote><h2 id="æ–¹æ³•ç¼“å­˜"><a href="#æ–¹æ³•ç¼“å­˜" class="headerlink" title="æ–¹æ³•ç¼“å­˜"></a>æ–¹æ³•ç¼“å­˜</h2><p>ä¸ºäº†åŠ å¿«æ–¹æ³•æŸ¥æ‰¾é€Ÿåº¦ï¼Œæ–¹æ³•ç¼“å­˜äº§ç”Ÿäº†ã€‚è°ƒç”¨è¿‡çš„æ–¹æ³•ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œå¦‚æœæ–¹æ³•æ˜¯å±äºçˆ¶ç±»çš„ï¼Œä¹Ÿä¼šæŠŠæ–¹æ³•ç¼“å­˜åœ¨è‡ªå·±çš„cacheä¸­ã€‚</p><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> cache_t &#123;</span><br><span class="line">    <span class="keyword">struct</span> bucket_t *_buckets; <span class="comment">// æ•£åˆ—è¡¨ï¼ŒæŒ‡å‘bucket_tç»“æ„ä½“æ•°ç»„çš„æŒ‡é’ˆ</span></span><br><span class="line">    mask_t _mask; <span class="comment">// æ•£åˆ—è¡¨é•¿åº¦å‡1</span></span><br><span class="line">    mask_t _occupied; <span class="comment">// å·²ç»ç¼“å­˜çš„æ–¹æ³•æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> bucket_t *buckets();</span><br><span class="line">    <span class="function">mask_t <span class="title">mask</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function">mask_t <span class="title">occupied</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">incrementOccupied</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBucketsAndMask</span>(<span class="params"><span class="keyword">struct</span> bucket_t *newBuckets, mask_t newMask</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initializeToEmpty</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">mask_t <span class="title">capacity</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isConstantEmptyCache</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">canBeFreed</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> size_t <span class="title">bytesForCapacity</span>(<span class="params">uint32_t cap</span>)</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">struct</span> bucket_t * endMarker(<span class="keyword">struct</span> bucket_t *b, uint32_t cap);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">expand</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reallocate</span>(<span class="params">mask_t oldCapacity, mask_t newCapacity</span>)</span>;</span><br><span class="line">    <span class="keyword">struct</span> bucket_t * find(cache_key_t key, id receiver);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bad_cache</span>(<span class="params">id receiver, SEL sel, Class isa</span>) __<span class="title">attribute__</span>(<span class="params">(noreturn</span>))</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">cache_key_t</span> _key;</span><br><span class="line">    IMP _imp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> cache_key_t <span class="title">key</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> IMP <span class="title">imp</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (IMP)_imp; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(<span class="keyword">cache_key_t</span> newKey)</span> </span>&#123; _key = newKey; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setImp</span><span class="params">(IMP newImp)</span> </span>&#123; _imp = newImp; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">cache_key_t</span> newKey, IMP newImp)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•æŸ¥æ‰¾è¿‡ç¨‹ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Selectorè½¬æ¢ä¸ºcache_key_tï¼ˆunsigned longç±»å‹ï¼‰</span></span><br><span class="line"><span class="keyword">cache_key_t</span> getKey(SEL sel) &#123;</span><br><span class="line">    assert(sel);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">cache_key_t</span>)sel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bucket_t</span> *<span class="keyword">cache_t</span>::find(<span class="keyword">cache_key_t</span> k, id receiver) &#123;</span><br><span class="line">    assert(k != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bucket_t</span> *b = _buckets;</span><br><span class="line">    <span class="keyword">mask_t</span> m = _mask;</span><br><span class="line">    <span class="keyword">mask_t</span> begin = (<span class="keyword">mask_t</span>)(k &amp; m);</span><br><span class="line">    <span class="keyword">mask_t</span> i = begin;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[i].key() == <span class="number">0</span>  ||  b[i].key() == k) &#123;</span><br><span class="line">            <span class="keyword">return</span> &amp;b[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((i = ((i+<span class="number">1</span>) &amp; m)) != begin);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hack</span></span><br><span class="line">    Class cls = (Class)((<span class="keyword">uintptr_t</span>)<span class="keyword">this</span> - offsetof(objc_class, cache));</span><br><span class="line">    <span class="keyword">cache_t</span>::bad_cache(receiver, (SEL)k, cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ•£åˆ—è¡¨çš„ç´¢å¼•é€šè¿‡<code>index = selector &amp; _mask</code>è·å¾—ã€‚</p><h1 id="å…­ã€block"><a href="#å…­ã€block" class="headerlink" title="å…­ã€block"></a>å…­ã€block</h1><h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>blockçš„æœ¬è´¨æ˜¯<code>__main_block_impl_0</code>ç»“æ„ä½“ï¼Œå®ƒæ‹¥æœ‰isaæŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ªå°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„Objective-Cå¯¹è±¡ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°å®ç°ä»¥åŠisa</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    <span class="keyword">int</span> Flags;</span><br><span class="line">    <span class="keyword">int</span> Reserved;</span><br><span class="line">    <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€äº›æè¿°ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">    <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">size_t</span> reserved; </span><br><span class="line">    <span class="comment">// blockå¤§å°</span></span><br><span class="line">    <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæ•´å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">        impl.Flags = flags;</span><br><span class="line">        impl.FuncPtr = fp;</span><br><span class="line">        Desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å®šä¹‰ä¸€ä¸ªblockæ—¶ï¼Œä¼šè°ƒç”¨<code>__main_block_impl_0</code>çš„æ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯æŠŠéœ€è¦æ‰§è¡Œçš„å‡½æ•°åœ°å€èµ‹å€¼ç»™FuncPtræŒ‡é’ˆã€‚</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘blockè‡ªå·±çš„æŒ‡é’ˆï¼Œä¹‹åçš„æ‰æ˜¯è‡ªå®šä¹‰çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself, <span class="keyword">int</span> age, <span class="keyword">double</span> <span class="built_in">height</span>) &#123;</span><br><span class="line">    <span class="comment">// blockåšçš„äº‹æƒ…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨blockä¹Ÿå³æ‰§è¡ŒFuncPtrå‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªintå‹å‚æ•°ã€ä¸€ä¸ªdoubleå‹å‚æ•°</span></span><br><span class="line"><span class="keyword">void</span> (*myBlock)(<span class="keyword">int</span>, <span class="keyword">double</span>) = &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line">myBlock-&gt;FuncPtr(myBlock, <span class="number">22</span>, <span class="number">175.3</span>);</span><br></pre></td></tr></table></figure><h2 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h2><p>ä»ä»£ç æ®µï¼ˆtextåŒºï¼‰ã€æ•°æ®æ®µï¼ˆdataåŒºï¼‰ã€å †åŒºå†åˆ°æ ˆåŒºï¼Œå†…å­˜åœ°å€é€æ¸å¢é«˜ã€‚blockæœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«åˆ†å¸ƒåœ¨æ•°æ®æ®µã€æ ˆåŒºå’Œå †åŒºã€‚</p><p>æ²¡æœ‰è®¿é—®autoå˜é‡çš„blockæ˜¯Globalç±»å‹ï¼Œç»§æ‰¿å…³ç³»é“¾ä¸ºï¼š<code>__NSGlobalBlock__</code>ï¼Œ<code>__NSGlobalBlock</code>ï¼Œ<code>NSBlock</code>ï¼Œ<code>NSObject</code>ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="built_in">void</span> (^<span class="keyword">block</span>)(<span class="built_in">void</span>) = ^(<span class="built_in">void</span>) &#123; &#125;;</span><br></pre></td></tr></table></figure></p><p>è®¿é—®äº†autoå˜é‡çš„blockæ˜¯Stackç±»å‹ï¼Œç»§æ‰¿å…³ç³»é“¾ä¸ºï¼š<code>__NSStackBlock__</code>ï¼Œ<code>__NSStackBlock</code>ï¼Œ<code>NSBlock</code>ï¼Œ<code>NSObject</code>ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="built_in">void</span> (^<span class="keyword">block</span>)(<span class="built_in">void</span>) = ^(<span class="built_in">void</span>) &#123;</span><br><span class="line">   <span class="type">NSLog</span>(@<span class="string">"åå­—æ˜¯:%d"</span>, age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å½“<code>__main_block_impl_0</code>çš„æ„é€ å‡½æ•°è°ƒç”¨å®Œæ¯•ï¼Œæ ˆä¸Šçš„è¯¥ç»“æ„ä½“å˜é‡é”€æ¯ï¼Œé‚£å–å‡ºè¯¥ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå†è®¿é—®æ•°æ®å°±ä¸ä¼šæ˜¯æ­£ç¡®çš„æ•°æ®äº†ã€‚è¿™æ—¶å€™ä¸ºäº†ä¿è¯è®¿é—®æ•°æ®çš„æ­£ç¡®æ€§ï¼Œéœ€è¦æŠŠblockæ”¾åˆ°å †ç©ºé—´ï¼Œæ‰‹åŠ¨ç®¡ç†è¯¥ç»“æ„ä½“å˜é‡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>Globalç±»å‹çš„blockè°ƒç”¨copyæ–¹æ³•åï¼Œå®ƒä¾ç„¶æ˜¯Globalç±»å‹ã€‚Stackç±»å‹çš„blockè°ƒç”¨copyæ–¹æ³•åï¼Œå°±æˆä¸ºMallocç±»å‹ï¼Œç»§æ‰¿å…³ç³»é“¾ä¸ºï¼š<code>__NSMallocBlock__</code>ï¼Œ<code>__NSMallocBlock</code>ï¼Œ<code>NSBlock</code>ï¼Œ<code>NSObject</code>ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = [^(<span class="keyword">void</span>) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"åå­—æ˜¯:%d"</span>, age);</span><br><span class="line">&#125; <span class="keyword">copy</span>];</span><br></pre></td></tr></table></figure></p><p>è€ŒMallocç±»å‹çš„blockè°ƒç”¨copyæ–¹æ³•åï¼Œå¼•ç”¨è®¡æ•°å¢åŠ 1ã€‚</p><p>åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µï¼Œblockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶ã€å°†blockèµ‹å€¼ç»™<code>__strong</code>æŒ‡é’ˆæ—¶ã€blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶ã€blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶ã€‚</p><h2 id="æ•è·å˜é‡"><a href="#æ•è·å˜é‡" class="headerlink" title="æ•è·å˜é‡"></a>æ•è·å˜é‡</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“blockæ•è·å¤–ç•Œçš„autoå˜é‡æ—¶ï¼Œè¯¥å˜é‡ä¼šä½œä¸ºblockå¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜å˜é‡å­˜å‚¨ï¼Œæ˜¯å€¼ä¼ é€’ï¼›<br>å½“blockæ•è·å¤–ç•Œçš„staticå˜é‡ï¼ˆéå…¨å±€å˜é‡ï¼‰æ—¶ï¼Œblockå¯¹è±¡ä¼šå¢åŠ ä¸€ä¸ªå­˜å‚¨è¯¥staticå˜é‡çš„æŒ‡é’ˆçš„æˆå‘˜å˜é‡ï¼Œæ˜¯æŒ‡é’ˆä¼ é€’ï¼›<br>å¯¹äºå…¨å±€å˜é‡ï¼ˆæ— è®ºæ˜¯å¦staticä¿®é¥°ï¼‰ï¼Œblockä¼šç›´æ¥è®¿é—®ï¼Œä¸è¿›è¡Œæ•è·ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€å˜é‡</span></span><br><span class="line"><span class="built_in">NSString</span> *globalName = <span class="string">@"globalName"</span>;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">// é™æ€å˜é‡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *staticName = <span class="string">@"staticName"</span>;</span><br><span class="line">    <span class="comment">// å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="built_in">NSString</span> *autoName = <span class="string">@"autoName"</span>;</span><br><span class="line">    <span class="keyword">void</span> (^myBlock)(<span class="keyword">int</span>, <span class="keyword">double</span>) = ^(<span class="keyword">int</span> age, <span class="keyword">double</span> height) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"globalName: %@, staticName: %@, autoName: %@,"</span>, globalName, staticName, autoName);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å¹´é¾„æ˜¯:%d, èº«é«˜æ˜¯:%f"</span>, age, height);</span><br><span class="line">    &#125;;</span><br><span class="line">    myBlock(<span class="number">22</span>, <span class="number">175.3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ç»“æ„å¦‚ä¸‹</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">    <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">    <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">    <span class="built_in">NSString</span> **staticName;</span><br><span class="line">    <span class="built_in">NSString</span> *autoName;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–åˆ—è¡¨ä¸­å¯¹autoNameå’ŒstaticNameèµ‹å€¼</span></span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="built_in">NSString</span> **_staticName, <span class="built_in">NSString</span> *_autoName, <span class="keyword">int</span> flags=<span class="number">0</span>) : staticName(_staticName), autoName(_autoName) &#123;</span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">        impl.Flags = flags;</span><br><span class="line">        impl.FuncPtr = fp;</span><br><span class="line">        Desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç‰¹æ®Šåœ°ï¼Œselfä½œä¸ºéšå¼å‚æ•°ï¼Œæ˜¯<strong>å±€éƒ¨å˜é‡</strong>ï¼Œæ‰€ä»¥blockè®¿é—®æ—¶ä¼šè¿›è¡Œæ•è·ã€‚è€Œå¯¹äºç›´æ¥è®¿é—®æŸä¸ªå¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="built_in">void</span> (^<span class="keyword">block</span>)(<span class="built_in">void</span>) = ^(<span class="built_in">void</span>) &#123; <span class="type">NSLog</span>(@<span class="string">"åå­—æ˜¯:%@"</span>, _name); &#125;;</span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Šæ˜¯é¦–å…ˆè®¿é—®selfï¼Œæ¥ç€è®¿é—®selfçš„æˆå‘˜å˜é‡<code>_name</code>ï¼Œå› æ­¤ï¼Œä¹Ÿä¼šå¯¹selfè¿›è¡Œæ•è·ã€‚</p><p>å°¤å…¶éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¯¹äºä¸€èˆ¬çš„autoå˜é‡æ¥è¯´ï¼Œæ•è·åŸºæœ¬æ•°æ®ç±»å‹çš„è‡ªåŠ¨å˜é‡çš„æ–¹å¼æ˜¯const copyã€‚è€Œå½“blockå†…éƒ¨è®¿é—®äº†å¯¹è±¡ç±»å‹çš„autoå˜é‡æ—¶ï¼Œå¦‚æœblockæ˜¯åœ¨æ ˆä¸Šï¼Œå°†ä¸ä¼šå¯¹autoå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨ã€‚å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Šï¼Œä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°ï¼Œcopyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨<code>_Block_object_assign</code>å‡½æ•°ï¼Œ<code>_Block_object_assign</code>å‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦<code>ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰</code>åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨ã€‚å¦‚æœblockä»å †ä¸Šç§»é™¤ï¼Œä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°ï¼Œdisposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨<code>_Block_object_dispose</code>å‡½æ•°ï¼Œ<code>_Block_object_dispose</code>å‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡ï¼ˆreleaseï¼‰ã€‚</p><h2 id="block"><a href="#block" class="headerlink" title="__block"></a>__block</h2><p>å¯¹äº<code>__block</code>ä¿®é¥°çš„autoå˜é‡ï¼ˆå«åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡ç±»å‹ï¼‰ï¼Œblockæ•è·æ—¶ä¼šå°†è¯¥å˜é‡åŒ…è£…æˆæ–°çš„å¯¹è±¡ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> *obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">__block <span class="keyword">int</span> age = <span class="number">22</span>;</span><br><span class="line">__block <span class="built_in">NSObject</span> *strongObj = obj;</span><br><span class="line">__block __<span class="keyword">weak</span> <span class="built_in">NSObject</span> *weakObj = obj;</span><br><span class="line"><span class="keyword">void</span> (^myBlock)(<span class="keyword">void</span>) = ^(<span class="keyword">void</span>) &#123;</span><br><span class="line">   age = <span class="number">23</span>;</span><br><span class="line">   strongObj = <span class="literal">nil</span>;</span><br><span class="line">   weakObj = <span class="literal">nil</span>;</span><br><span class="line">&#125;;</span><br><span class="line">myBlock();</span><br><span class="line"><span class="comment">// å†æ¬¡è®¿é—®</span></span><br><span class="line">strongObj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">age = <span class="number">24</span>;</span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Šæ˜¯è¿™æ ·ï¼š</p><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŠŠageåŒ…è£…æˆæ–°çš„å¯¹è±¡</span></span><br><span class="line">struct <span class="variable">__Block_byref_age_0</span> &#123;</span><br><span class="line">    void *<span class="variable">__isa</span>;</span><br><span class="line">    <span class="variable">__Block_byref_age_0</span> *<span class="variable">__forwarding</span>;</span><br><span class="line">    int <span class="variable">__flags</span>;</span><br><span class="line">    int <span class="variable">__size</span>;</span><br><span class="line">    int age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠstrongä¿®é¥°çš„strongObjåŒ…è£…æˆæ–°çš„å¯¹è±¡</span></span><br><span class="line">struct <span class="variable">__Block_byref_strongObj_1</span> &#123;</span><br><span class="line">    void *<span class="variable">__isa</span>;</span><br><span class="line">    <span class="variable">__Block_byref_strongObj_1</span> *<span class="variable">__forwarding</span>;</span><br><span class="line">    int <span class="variable">__flags</span>;</span><br><span class="line">    int <span class="variable">__size</span>;</span><br><span class="line">    void (*<span class="variable">__Block_byref_id_object_copy</span>)(void*, void*);</span><br><span class="line">    void (*<span class="variable">__Block_byref_id_object_dispose</span>)(void*);</span><br><span class="line">    NSObject *<span class="variable">__strong</span> strongObj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠweakä¿®é¥°çš„weakObjåŒ…è£…æˆæ–°çš„å¯¹è±¡</span></span><br><span class="line">struct <span class="variable">__Block_byref_weakObj_2</span> &#123;</span><br><span class="line">    void *<span class="variable">__isa</span>;</span><br><span class="line">    <span class="variable">__Block_byref_weakObj_2</span> *<span class="variable">__forwarding</span>;</span><br><span class="line">    int <span class="variable">__flags</span>;</span><br><span class="line">    int <span class="variable">__size</span>;</span><br><span class="line">    void (*<span class="variable">__Block_byref_id_object_copy</span>)(void*, void*);</span><br><span class="line">    void (*<span class="variable">__Block_byref_id_object_dispose</span>)(void*);</span><br><span class="line">    NSObject *<span class="variable">__weak</span> weakObj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// blockçš„ç»“æ„</span></span><br><span class="line">struct <span class="variable">__main_block_impl_0</span> &#123;</span><br><span class="line">    struct <span class="variable">__block_impl</span> impl;</span><br><span class="line">    struct <span class="variable">__main_block_desc_0</span>* Desc;</span><br><span class="line">    <span class="variable">__Block_byref_age_0</span> *age; <span class="comment">// by ref</span></span><br><span class="line">    <span class="variable">__Block_byref_strongObj_1</span> *strongObj; <span class="comment">// by ref</span></span><br><span class="line">    <span class="variable">__Block_byref_weakObj_2</span> *weakObj; <span class="comment">// by ref</span></span><br><span class="line">    <span class="variable">__main_block_impl_0</span>(void *fp, </span><br><span class="line">        struct <span class="variable">__main_block_desc_0</span> *desc, </span><br><span class="line">        <span class="variable">__Block_byref_age_0</span> *<span class="variable">_age</span>, </span><br><span class="line">        <span class="variable">__Block_byref_strongObj_1</span> *<span class="variable">_strongObj</span>, </span><br><span class="line">        <span class="variable">__Block_byref_weakObj_2</span> *<span class="variable">_weakObj</span>, int flags=<span class="number">0</span>) </span><br><span class="line">        : age(<span class="variable">_age</span>-&gt;<span class="variable">__forwarding</span>), strongObj(<span class="variable">_strongObj</span>-&gt;<span class="variable">__forwarding</span>), weakObj(<span class="variable">_weakObj</span>-&gt;<span class="variable">__forwarding</span>) &#123; <span class="comment">// åˆå§‹åŒ–åˆ—è¡¨</span></span><br><span class="line">        impl.isa = &amp;<span class="variable">_NSConcreteStackBlock</span>;</span><br><span class="line">        impl.Flags = flags;</span><br><span class="line">        impl.FuncPtr = fp;</span><br><span class="line">        Desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œä»è¿™ä¸€åˆ»å¼€å§‹ï¼Œå†è®¿é—®è¯¥autoå˜é‡ï¼ˆageã€strongObjã€weakObjï¼‰ï¼Œå®è´¨ä¸Šæ˜¯è®¿é—®åŒ…è£…æˆæ–°çš„å¯¹è±¡å†…éƒ¨çš„åŒåå˜é‡ï¼ˆåŸå…ˆçš„å˜é‡å·²ç»ä¸å­˜åœ¨äº†ï¼‰ã€‚</p><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">__block <span class="keyword">int</span> age = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">void</span> (^myBlock)(<span class="keyword">void</span>) = ^(<span class="keyword">void</span>) &#123;</span><br><span class="line">   age = <span class="number">23</span>;</span><br><span class="line">&#125;;</span><br><span class="line">myBlock();</span><br><span class="line">age = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›è¡Œç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 *block_imp = (__bridge <span class="keyword">struct</span> __main_block_impl_0 *)(myBlock);</span><br><span class="line"><span class="keyword">struct</span> __Block_byref_age_0 *age_imp = block_imp-&gt;age;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°ç»“æœï¼š</span></span><br><span class="line">(lldb) p/x &amp;age</span><br><span class="line">(<span class="keyword">int</span> *) $<span class="number">3</span> = <span class="number">0x00000001006207d8</span></span><br><span class="line">(lldb) p/x &amp;(age_imp-&gt;age)</span><br><span class="line">(<span class="keyword">int</span> *) $<span class="number">2</span> = <span class="number">0x00000001006207d8</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç±»å‹è½¬æ¢ï¼Œæ‰“å°å˜é‡ageçš„åœ°å€ä¸ç»“æ„ä½“age_impä¸­çš„ageæˆå‘˜çš„åœ°å€ï¼Œå‘ç°æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°è¯äº†è¿™ä¸€ç‚¹ï¼š<code>__block</code>ä¿®é¥°çš„ageå°±æ˜¯â€œä¸å¯è§â€çš„æ–°ç»“æ„ä½“å†…éƒ¨çš„ageã€‚</p><p>è¿™ä¸ªâ€œè¢«åŒ…è£…çš„æ–°çš„å¯¹è±¡â€çš„å†…å­˜ç®¡ç†ä¹Ÿéœ€è¦è€ƒè™‘ï¼Œå½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šå¯¹è¿™ä¸ªâ€œæ–°çš„å¯¹è±¡â€äº§ç”Ÿå¼ºå¼•ç”¨ã€‚å½“blockè¢«copyåˆ°å †æ—¶ï¼Œä¼šå¯¹â€œæ–°çš„å¯¹è±¡â€äº§ç”Ÿå¼ºå¼•ç”¨ã€‚å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…å¹¶ä¸éœ€è¦èµ˜è¿°ï¼Œè€Œå¯¹äºå¯¹è±¡ç±»å‹çš„åŒ…è£…å€’å€¼å¾—ä¸€æã€‚â€œæ–°çš„å¯¹è±¡â€å†…éƒ¨çš„strongObjä»¥åŠweakObjçš„ä¿®é¥°ç­–ç•¥å¾ˆæ¸…æ™°åœ°è¡¨æ˜äº†å®ƒå¯¹åŸæ¥å¯¹è±¡å†…å­˜ç®¡ç†çš„ç«‹åœºï¼šåŸæ¥æ˜¯strongï¼ŒåŒ…è£…åä¾ç„¶æ˜¯strongï¼›åŸæ¥æ˜¯weakï¼ŒåŒ…è£…åä¾ç„¶æ˜¯weakã€‚</p><p>å¯¹äº<code>__block</code>ä¿®é¥°çš„å˜é‡è¿›è¡Œè£…ç®±ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œå€˜è‹¥è€ƒè™‘æŠŠè¢«ä¿®æ”¹çš„autoå˜é‡çš„æŒ‡é’ˆä¼ é€’ç»™blockï¼Œè¿™æ ·ä¼¼ä¹ä¹Ÿèƒ½è¾¾åˆ°ä¿®æ”¹å˜é‡çš„æ•ˆæœï¼Œä½†æ˜¯ä¸åº”è¯¥å¿˜è®°ï¼Œè¢«ä¿®æ”¹çš„autoå˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ç¡®å®šçš„ï¼Œå‡å¦‚è¿™ä¸ªå˜é‡å¾ˆå¿«å°±é”€æ¯ï¼Œè¿‡äº†å¾ˆä¹…blockæ‰å¾—åˆ°æ‰§è¡Œï¼Œè¿™æ—¶å†å»é€šè¿‡æŒ‡é’ˆæ˜¯æ— æ³•è®¿é—®åˆ°è¿™ä¸ªå˜é‡çš„ï¼Œè¿™ç§è®¿é—®æ–¹å¼ä¹Ÿå¾ˆå±é™©ã€‚è€ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„å¯¹è±¡åï¼Œè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå°±éšç€blockäº†ï¼Œblockæ— è®ºåœ¨æ ˆä¸Šè¿˜æ˜¯åœ¨å †ä¸Šï¼Œéƒ½æ²¡æœ‰å…³ç³»ã€‚</p><h2 id="å±æ€§ä¿®é¥°"><a href="#å±æ€§ä¿®é¥°" class="headerlink" title="å±æ€§ä¿®é¥°"></a>å±æ€§ä¿®é¥°</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œåªæœ‰å½“æ ˆä¸Šçš„blockä½œä¸ºæ–¹æ³•çš„å‚æ•°æ—¶ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨blockçš„copyæ–¹æ³•ï¼Œå°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œä»¥é¿å…åå†…å­˜é—®é¢˜ã€‚åœ¨ARCæ—¶ä»£ï¼Œå¦‚æœblockä½œä¸ºå±æ€§ï¼Œæ— è®ºæ˜¯copyä¿®é¥°è¿˜æ˜¯strongä¿®é¥°éƒ½æ˜¯å¯ä»¥çš„ã€‚å¯¹äºgetteræ–¹æ³•ï¼Œç”±äºblockæ˜¯ä½œä¸ºæ–¹æ³•çš„è¿”å›å€¼ï¼Œåˆ™å®ƒä¼šè‡ªåŠ¨è¢«copyåˆ°å †ç©ºé—´ï¼Œä¸éœ€è¦æˆ‘ä»¬å…³å¿ƒã€‚å¯¹äºsetteræ–¹æ³•ï¼Œblockæ˜¯ä½œä¸ºæ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæ˜¯copyä¿®é¥°ï¼Œæ ˆä¸Šçš„blockè‡ªç„¶ä¼šè¢«è°ƒç”¨copyæ–¹æ³•è€Œè¢«å¤åˆ¶åˆ°å †ç©ºé—´ã€‚å¦‚æœæ˜¯strongä¿®é¥°ï¼Œé‚£ä¹ˆå½“æŠŠæ ˆä¸Šçš„blockèµ‹å€¼ç»™ <code>__strong id</code>ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¼šè¢«è°ƒç”¨copyæ–¹æ³•å¤åˆ¶åˆ°å †ç©ºé—´çš„ã€‚<br>å³ä¾¿å¦‚æ­¤ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨copyä¿®é¥°ï¼Œè¿™æ ·èƒ½æ—¶åˆ»æé†’æˆ‘ä»¬è¿™ä¸ªblockå°†æ¥ä¼šè¢«å®‰å…¨åœ°copyåˆ°å †ç©ºé—´ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ä½¿ç”¨<code>weak</code>ã€<code>assign</code>ã€<code>unsafe_unretained</code>è¿™äº›å¦ç±»çš„ä¿®é¥°ç¬¦ä¿®é¥°blockï¼Œé‚£å¾ˆè½»è€Œæ˜“ä¸¾åœ°å°±ä¼šå‡ºé—®é¢˜äº†ã€‚</p><h1 id="ä¸ƒã€å°ç»“"><a href="#ä¸ƒã€å°ç»“" class="headerlink" title="ä¸ƒã€å°ç»“"></a>ä¸ƒã€å°ç»“</h1><p>halfroståŒå­¦æ¦‚æ‹¬äº†ä¸Runtimeæœ‰å…³çš„åº”ç”¨å¤§æ¦‚æ˜¯è¿™äº›ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒå…¨é¢äº†ã€‚</p><ol><li>å®ç°å¤šç»§æ‰¿ï¼ˆæ¶ˆæ¯è½¬å‘ï¼‰</li><li>Method Swizzling</li><li>Aspect Oriented Programmingï¼ˆæ¯”å¦‚æ‰“ç‚¹ï¼‰</li><li>Isa Swizzlingï¼ˆKVOçš„åŠ¨æ€æ´¾ç”Ÿï¼‰</li><li>Associated Objectå…³è”å¯¹è±¡</li><li>åŠ¨æ€åœ°å¢åŠ æ–¹æ³•</li><li>NSCodingçš„è‡ªåŠ¨å½’æ¡£å’Œè‡ªåŠ¨è§£æ¡£</li><li>å­—å…¸å’Œæ¨¡å‹äº’ç›¸è½¬æ¢ï¼ˆKVCä¹Ÿå¯ï¼Œåˆ©ç”¨IMPä¹Ÿè¡Œï¼‰</li></ol><p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†Objective-Câ€œå¯¹è±¡â€ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œæœ€åè¿˜æäº†ä¸€ä¸‹è¿™é—¨è¯­è¨€ç‰¹æœ‰çš„blockã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰æŠŠå¼€å¤´çš„é‚£é“é—®é¢˜å›ç­”å¥½ï¼ˆæ‚è„¸ï¼‰ï¼Œå†™äº†å¥½ä¹…ï¼Œä¼šç»å¸¸å›é¡¾å¹¶å®Œå–„ã€‚</p><blockquote><p>å‚è€ƒæ„Ÿè°¢ï¼š<br><a href="http://southpeak.github.io/2014/11/03/objective-c-runtime-3/" target="_blank" rel="noopener">ã€Šæ–¹æ³•ä¸æ¶ˆæ¯ã€‹</a><br><a href="https://lpd-ios.github.io/2017/12/19/ObjC-Message/" target="_blank" rel="noopener">ã€Šç”¨ä»£ç ç†è§£ ObjC ä¸­çš„å‘é€æ¶ˆæ¯å’Œæ¶ˆæ¯è½¬å‘ã€‹</a><br><a href="https://halfrost.com/how_to_use_runtime/" target="_blank" rel="noopener">ã€Šå¦‚ä½•æ­£ç¡®ä½¿ç”¨ Runtimeã€‹</a><br><a href="https://zhongwuzw.github.io/2018/04/21/iOSçŸ¥è¯†å°é›†ä¹‹ä¸ºä»€ä¹ˆobjc-msgSend-æ˜¯ç”¨æ±‡ç¼–å®ç°çš„/" target="_blank" rel="noopener">ã€Šä¸ºä»€ä¹ˆobjc_msgSend()æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ã€‹</a><br><a href="https://amywushu.github.io/2016/11/09/é€†å‘çŸ¥è¯†-é€šè¿‡æ±‡ç¼–è§£è¯»-objc_msgSend.html" target="_blank" rel="noopener">ã€Šé€šè¿‡æ±‡ç¼–è§£è¯»-objc_msgSendã€‹</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; å°è¯•å›ç­”â€œç»™ä½  C è¯­è¨€ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ª Objective-Câ€ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="Objective-C" scheme="http://blog.chenyalun.com/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>å¼€æºé¡¹ç›®ï¼šYAPageView</title>
    <link href="http://blog.chenyalun.com/2019/08/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%EF%BC%9AYAPageView/"/>
    <id>http://blog.chenyalun.com/2019/08/07/å¼€æºé¡¹ç›®ï¼šYAPageView/</id>
    <published>2019-08-07T01:45:09.000Z</published>
    <updated>2019-12-16T02:48:23.812Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> è½»é‡çº§ã€æ–°æ ·å¼è½®æ’­è§†å›¾ã€‚ </p><br><a id="more"></a><p></p><h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åœ¨æ‹œè¯»<a href="http://adad184.com/" target="_blank" rel="noopener">é‡Œè„Šä¸²çš„å¼€å‘éšç¬”</a>å¤§ç¥çš„åšå®¢æ—¶ï¼Œå‘ç°ä¸ªå¥½ç©çš„ä¸œè¥¿ï¼š<a href="http://adad184.com/2015/07/01/opensource-xxpagingscrollview/" target="_blank" rel="noopener">ã€Šå¼€æºé¡¹ç›®:XXPagingScrollViewã€‹</a>ã€‚è™½ç„¶æ˜¯å¾ˆå¸¸è§çš„è½®æ’­è§†å›¾ï¼Œä½†æ˜¯è¿™ç§æ–°æ ·å¼çš„å®ç°æ€è·¯æŒºæœ‰æ„æ€ã€‚è®°å¾—ä¸¤å¹´å‰åœ¨å†™æŸä¸ªé¡¹ç›®æ—¶ä¹Ÿé‡åˆ°è¿‡è¿™ä¸ªï¼Œä½†æ˜¯å½“ç„¶ç¡®å®æ²¡æœ‰æƒ³å‡ºæ¥å’‹å®ç°è¿™ç§éå…¨å±æœ‰é—´éš™çš„è½®æ’­æ§ä»¶ã€‚</p><p>è¯»å®Œå¤§ç¥çš„æ–‡ç« ï¼Œå¾ˆæ˜¯å…´å¥‹ï¼Œä¸€èˆ¬æ˜¯ä¸çˆ±é€ é‡å¤çš„è½®å­ï¼Œä½†æ˜¯ä½œè€…è¿™ä¸ªæ˜¯<a href="https://github.com/adad184/XXPagingScrollView/blob/master/Classes/XXPagingScrollView.swift" target="_blank" rel="noopener">Swiftç‰ˆæœ¬</a>çš„ï¼Œè€Œä¸”æ˜¯åŸºç¡€ç»„ä»¶ï¼Œå°‘äº†å¾ˆå¤šåŠŸèƒ½ï¼Œæ‰€ä»¥å¿ƒè¡€æ¥æ½®ï¼Œåœ¨å¤§ç¥åŸºç¡€ä¸Šå†è¿›ä¸€æ­¥ã€‚</p><p>ç›¸æ¯”è¾ƒæ¥è¯´æ›´åŠ å®Œå–„äº†ï¼š</p><ul><li>æ”¯æŒè®¾ç½®pagingWidth</li><li>æ”¯æŒè®¾ç½®pageInset</li><li>æ”¯æŒæ— é™å¾ªç¯è½®æ’­</li><li>æ”¯æŒæœ¬åœ°å›¾ç‰‡</li><li>æ”¯æŒç½‘ç»œå›¾ç‰‡</li><li>æ”¯æŒè‡ªåŠ¨è½®æ’­ã€è®¾ç½®è½®æ’­æ—¶é—´é—´éš”</li><li>æ”¯æŒç‚¹å‡»å›è°ƒ</li></ul><p>æ•´ä½“ä»£ç çº¦150è¡Œå·¦å³ï¼Œæ›´åŠ ç²¾ç®€ã€‚<br><img src="https://image.chenyalun.com/2019/08/07/003.gif"><br>é¡¹ç›®åœ°å€:<a href="https://github.com/ChenYalun/YAPageView" target="_blank" rel="noopener">https://github.com/ChenYalun/YAPageView</a></p><h1 id="äºŒã€æ€è·¯"><a href="#äºŒã€æ€è·¯" class="headerlink" title="äºŒã€æ€è·¯"></a>äºŒã€æ€è·¯</h1><p>å®é™…ä¸Šè½®æ’­è§†å›¾æ˜¯çƒ‚å¤§è¡—çš„ä¸œè¥¿äº†ï¼Œç½‘ä¸Šç°æˆä»£ç ç‰¹åˆ«å¤šã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå‡å®šéœ€è¦nä¸ªé¡µé¢ï¼Œå®ç°æ–¹å¼æœ‰ï¼š</p><ol><li>ä½¿ç”¨<code>UIScrollView</code>ï¼Œæ·»åŠ  n ä¸ª<code>UIImageView</code>ã€‚</li><li>ä½¿ç”¨<code>UIScrollView</code>ï¼Œæ·»åŠ ä¸¤ä¸ª<code>UIImageView</code>ï¼ŒåŠ¨æ€å¾ªç¯è°ƒæ•´ã€‚</li><li>ä½¿ç”¨<code>UICollectionView</code>ã€‚</li></ol><p>æ–¹æ³•1æ¯”è¾ƒåŸºç¡€ï¼Œæ›´é€‚åˆéå¾ªç¯ï¼›æ–¹æ³•3æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯<code>UICollectionView</code>è¿‡äºheavilyã€‚<br>æ–¹æ³•2ï¼Œå¾ˆç²¾ç®€è½»é‡ï¼Œå°±æ˜¯å¤„ç†èµ·æ¥æœ‰ç‚¹ç»•ã€‚ç„¶è€Œï¼Œç»•ä¸€æ¬¡ï¼Œæ¢æ¥æ°¸ä¹…çš„èˆ’é€‚ï¼Œå¾ˆå€¼å¾—ã€‚</p><p>å¦‚ä½•å®ç°è‡ªå®šä¹‰<code>Page width</code>çš„è§†å›¾ï¼Œä½œè€…ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ï¼š</p><blockquote><p>æ–¹æ¡ˆ1: ä¸ä½¿ç”¨<code>pagingEnabled</code>å±æ€§ è€Œæ˜¯æ‰‹åŠ¨çš„è®¡ç®—å¹¶è®¾ç½®æ»‘åŠ¨åç§»<br>æ–¹æ¡ˆ2: ä½¿ç”¨<code>pagingEnabled</code>å±æ€§ æ‰©å¤§<code>UIScrollview</code>çš„æ˜¾ç¤ºèŒƒå›´å³å¯</p></blockquote><p>å¾ˆæ˜æ˜¾ï¼Œæ–¹æ¡ˆ2æ›´å¥½ã€‚æ€è·¯æ˜¯ï¼Œæ‰©å¤§<code>UIScrollView</code>çš„å¯æ˜¾ç¤ºèŒƒå›´å¹¶è®©UIScrollViewå“åº”è¶…å‡ºå…¶æœ¬èº«èŒƒå›´çš„è§¦æ‘¸äº‹ä»¶ã€‚æ€è·¯çŸ¥é“äº†ï¼Œå®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå°±æ˜¯<code>clipsToBounds</code>å±æ€§å’Œ<code>pointInside</code>æ–¹æ³•ã€‚</p><h4 id="é—´è·å¤„ç†"><a href="#é—´è·å¤„ç†" class="headerlink" title="é—´è·å¤„ç†"></a>é—´è·å¤„ç†</h4><p>æ ¸å¿ƒæœ‰ä¸‰æ¡ï¼š</p><ol><li><code>UIScrollView</code>çš„å®½åº¦å°±æ˜¯<code>pageWidth + pageInset</code>ã€‚</li><li>ä¸ºäº†ä¿æŒå·¦å³æ˜¾ç¤ºåŒºåŸŸçš„å¯¹ç§°æ€§ï¼Œ<code>UIScrollView</code>çš„<code>x</code>æ˜¯<code>(superView.width - pageWidth) * 0.5</code>ã€‚</li><li>å­è§†å›¾çš„frameæ˜¯<code>CGRectMake(idx * (pageWidth + pageInset), 0, pageWidth, height)</code>ï¼Œä¹Ÿå³ï¼Œå­è§†å›¾çš„å®½åº¦ä¸<code>UIScrollView</code>çš„å®½åº¦ä¿æŒä¸€è‡´ã€‚</li></ol><h4 id="æ— é™å¾ªç¯å¤„ç†"><a href="#æ— é™å¾ªç¯å¤„ç†" class="headerlink" title="æ— é™å¾ªç¯å¤„ç†"></a>æ— é™å¾ªç¯å¤„ç†</h4><ol><li>è§†å›¾å¾ªç¯åˆ©ç”¨<br>ä½¿ç”¨ä¸‰ä¸ª<code>UIImageView</code>ï¼Œè®°ä¸ºå·¦ã€ä¸­ã€å³ï¼Œé‡å¤åˆ©ç”¨ã€‚é»˜è®¤æ˜¾ç¤ºä¸­é—´çš„imageViewã€‚</li><li>åˆ·æ–°é€»è¾‘<br>åœ¨<code>scrollViewDidScroll</code>å›è°ƒä¸­ï¼Œå½“<code>UIScrollView</code>å³å°†æ˜¾ç¤ºå‡ºä¸‹ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯å·¦ã€ä¹Ÿå¯èƒ½æ˜¯å³ï¼‰è§†å›¾æ—¶ï¼Œç«‹å³è°ƒç”¨åˆ·æ–°æ–¹æ³•ã€‚åˆ·æ–°çš„é€»è¾‘æ˜¯ï¼š</li></ol><ul><li><p>é‡æ–°è®¡ç®—leftã€currentIndexã€rightä¸‰ä¸ªç´¢å¼•</p>  <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kLeft (_currentIndex == 0 ? kCount - 1 : _currentIndex - 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kRight (_currentIndex == kCount - 1 ? 0 : _currentIndex + 1)</span></span><br></pre></td></tr></table></figure></li><li><p>å¯¹å·¦ã€ä¸­ã€å³ä¸‰ä¸ª<code>UIImageView</code>é‡æ–°è®¾ç½®é…å›¾</p>  <figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line">self.pageArray<span class="string">[0]</span>.image = self.imageArray<span class="string">[kLeft]</span>;</span><br><span class="line">self.pageArray<span class="string">[1]</span>.image = self.imageArray<span class="string">[_currentIndex]</span>;</span><br><span class="line">self.pageArray<span class="string">[2]</span>.image = self.imageArray<span class="string">[kRight]</span>;</span><br></pre></td></tr></table></figure></li><li><p>ä»¥éåŠ¨ç”»æ–¹å¼è®¾ç½®<code>UIScrollView</code>çš„åç§»é‡</p>  <figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGFloat</span> x = <span class="keyword">self</span>.scrollView.contentOffset.x;</span><br><span class="line"><span class="built_in">CGFloat</span> width = <span class="keyword">self</span>.pageWidth + <span class="keyword">self</span>.pageInset;</span><br><span class="line"><span class="keyword">if</span> (x == <span class="number">0</span>) &#123;</span><br><span class="line">   x = width;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   x += x &gt; width ? -width : width;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="keyword">self</span>.scrollView setContentOffset:<span class="built_in">CGPointMake</span>(x, <span class="number">0</span>)];</span><br></pre></td></tr></table></figure><p>  è¿™æ ·ä¾¿å®ç°äº†æ— é™å¾ªç¯ã€‚</p></li></ul><ol start="3"><li><p>åˆ·æ–°æ—¶æœºå¤„ç†<br><code>scrollViewDidScroll</code>ä¼šå›è°ƒå¾ˆå¤šæ¬¡ï¼Œæœ¬æ¥ä»¥ä¸ºä½¿ç”¨ä¸€ä¸ªæ ‡å¿—ä½å°±å¯ä»¥æ§åˆ¶åªåˆ·æ–°ä¸€æ¬¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®ç°ğŸ˜‚ æ‰€ä»¥ï¼Œé€€ä¸€æ­¥ï¼Œç”¨äº†ä¸¤ä¸ªæ ‡å¿—ä½ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> leftLock;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> rightLock;</span><br></pre></td></tr></table></figure><p>é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Turn left.</span></span><br><span class="line"><span class="keyword">if</span> (offsetX &gt; <span class="number">2</span> * (width - <span class="keyword">self</span>.pageInset)) <span class="keyword">self</span>.rightLock = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">self</span>.leftLock &amp;&amp; offsetX &lt; width - <span class="number">2</span> * <span class="keyword">self</span>.pageInset) &#123;</span><br><span class="line">    <span class="keyword">self</span>.leftLock = <span class="literal">YES</span>;</span><br><span class="line">    _currentIndex = kLeft;</span><br><span class="line">    [<span class="keyword">self</span> refresh];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Turn right.</span></span><br><span class="line"><span class="keyword">if</span> (offsetX &lt; <span class="number">2</span> * <span class="keyword">self</span>.pageInset) <span class="keyword">self</span>.leftLock = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">self</span>.rightLock &amp;&amp; offsetX &gt; width + <span class="number">2</span> * <span class="keyword">self</span>.pageInset) &#123;</span><br><span class="line">    <span class="keyword">self</span>.rightLock = <span class="literal">YES</span>;</span><br><span class="line">    _currentIndex = kRight;</span><br><span class="line">    [<span class="keyword">self</span> refresh];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¯·ç‰¢è®°<code>UIScrollView</code>çš„å®½åº¦widthæ˜¯<code>width=pageWidth+pageInset</code>ï¼Œè¿™é‡Œä»¥å³å°†æ˜¾ç¤ºå³è¾¹è§†å›¾ä¸ºä¾‹ï¼š<br> scrollViewçš„åˆå§‹åç§»é‡æ˜¯<code>width</code>ï¼Œé€æ¸åç§»ï¼Œç›´åˆ°è¶Šè¿‡ç©ºç™½é—´è·(pageInset)è¦æ˜¾ç¤ºä¸‹ä¸€ä¸ªè§†å›¾æ—¶ï¼Œæ­¤æ—¶offsetXä¸º<code>width + (pageWidth - pageInset)</code>ï¼Œä¹Ÿå³ä»£ç ä¸­çš„<code>2 * (width - pageInset)</code>ï¼Œç«‹å³å°†offsetXè¿˜åŸä¸º<code>2 * (width - pageInset) - (width)</code>ä¹Ÿå°±æ˜¯<code>pageWidth-pageInset</code>ï¼Œå¯¹leftLockåŠ é”ï¼Œæ›´æ–°å½“å‰ç´¢å¼•ã€‚</p></li></ol><h4 id="ç‚¹å‡»äº‹ä»¶å¤„ç†"><a href="#ç‚¹å‡»äº‹ä»¶å¤„ç†" class="headerlink" title="ç‚¹å‡»äº‹ä»¶å¤„ç†"></a>ç‚¹å‡»äº‹ä»¶å¤„ç†</h4><p>å¯¹<code>UIScrollView</code>æ·»åŠ ç‚¹å‡»æ‰‹åŠ¿ï¼Œè®¡ç®—å‡ºå½“å‰ç‚¹å‡»ä½ç½®åœ¨å›¾ç‰‡æ•°ç»„ä¸­çš„ç´¢å¼•å³å¯ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGFloat</span> pointX = [tap locationInView:tap.view].x;</span><br><span class="line"><span class="built_in">NSUInteger</span> idx = _currentIndex;</span><br><span class="line"><span class="keyword">if</span> (pointX &lt; <span class="keyword">self</span>.pageWidth + <span class="keyword">self</span>.pageInset) &#123;</span><br><span class="line">   idx = kLeft;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pointX &gt; <span class="number">2</span> * <span class="keyword">self</span>.pageWidth + <span class="keyword">self</span>.pageInset) &#123;</span><br><span class="line">   idx = kRight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="è‡ªåŠ¨è½®æ’­å¤„ç†"><a href="#è‡ªåŠ¨è½®æ’­å¤„ç†" class="headerlink" title="è‡ªåŠ¨è½®æ’­å¤„ç†"></a>è‡ªåŠ¨è½®æ’­å¤„ç†</h4><p>å½“è®¾ç½®<code>timeInterval</code>å±æ€§æ—¶ï¼Œè¯´æ˜éœ€è¦è‡ªåŠ¨è½®æ’­ï¼Œæ‡’åŠ è½½åˆ›å»ºå®šæ—¶å™¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">_timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:_timeInterval repeats:<span class="literal">YES</span> block:^(<span class="built_in">NSTimer</span> *timer) &#123;</span><br><span class="line">    [<span class="keyword">self</span>.scrollView setContentOffset:<span class="built_in">CGPointMake</span>(<span class="built_in">CGRectGetWidth</span>(<span class="keyword">self</span>.scrollView.frame) * <span class="number">2</span>, <span class="number">0</span>) animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>å¹¶æŠŠå®šæ—¶å™¨æ”¾åˆ°<code>currentRunLoop</code>ä¸­ï¼Œè®¾ç½®<code>NSRunLoopCommonModes</code>ã€‚å½“ç„¶ï¼Œéœ€è¦åœ¨ScrollViewçš„ä¸€äº›ä»£ç†ä¸­å¤„ç†ç”¨æˆ·æ‰‹åŠ¨æ»‘åŠ¨ä¸å®šæ—¶å™¨è®¾ç½®çš„æ»‘åŠ¨çš„å†²çªã€‚</p><h4 id="å®šæ—¶å™¨å¾ªç¯å¼•ç”¨å¤„ç†"><a href="#å®šæ—¶å™¨å¾ªç¯å¼•ç”¨å¤„ç†" class="headerlink" title="å®šæ—¶å™¨å¾ªç¯å¼•ç”¨å¤„ç†"></a>å®šæ—¶å™¨å¾ªç¯å¼•ç”¨å¤„ç†</h4><p>è§£å†³æ–¹å¼æ˜¯ï¼Œå½“PageViewä»çˆ¶è§†å›¾ä¸Šç§»é™¤æ—¶ï¼Œæ‰‹åŠ¨é”€æ¯å®šæ—¶å™¨ï¼š<br><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line">- (void)willMoveToSuperview:<span class="type"></span>(UIView *)<span class="keyword">new</span><span class="type">Superview</span> &#123;</span><br><span class="line">    [<span class="keyword">super</span> willMoveToSuperview:<span class="type">newSuperview</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">Superview</span> == nil) &#123; <span class="comment">// è§†å›¾ä»çˆ¶è§†å›¾ç§»é™¤æ—¶, é”€æ¯å®šæ—¶å™¨</span></span><br><span class="line">        [_timer invalidate];</span><br><span class="line">        _timer = nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="ç‚¹å‡»å›è°ƒå¾ªç¯å¼•ç”¨å¤„ç†"><a href="#ç‚¹å‡»å›è°ƒå¾ªç¯å¼•ç”¨å¤„ç†" class="headerlink" title="ç‚¹å‡»å›è°ƒå¾ªç¯å¼•ç”¨å¤„ç†"></a>ç‚¹å‡»å›è°ƒå¾ªç¯å¼•ç”¨å¤„ç†</h4><p>ç‚¹å‡»äº‹ä»¶ç»™å‡ºçš„æ¥å£æˆ‘é€‰æ‹©ä½¿ç”¨blockï¼Œï¼ˆä½¿ç”¨å¼±å¼•ç”¨çš„ä»£ç†å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜äº†ï¼Œä½†æ˜¯ä»£ç†ä¼šå¢åŠ è°ƒç”¨çš„å¤æ‚æ€§ï¼Œè®¾ç½®ä»£ç†ã€éµå®ˆåè®®ã€å®ç°æ–¹æ³•å·´æ‹‰å·´æ‹‰ã€‚ã€‚ã€‚ï¼‰</p><p>ç„¶è€Œï¼ŒåŒè®¸å¤šè§†å›¾çš„blockå›è°ƒä¸€æ ·ï¼Œä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œåªèƒ½è¿™æ ·ä½¿ç”¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">pageView.tapHandler = ^(<span class="built_in">NSUInteger</span> idx, <span class="built_in">UIImage</span> *img, <span class="built_in">NSURL</span> *url) &#123;</span><br><span class="line">   __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) <span class="keyword">self</span> = weakSelf;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"self = %@, index = %lu, url = %@"</span>, <span class="keyword">self</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)idx, url);</span><br><span class="line">   <span class="comment">/// ....</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‡ä¸€è°ƒç”¨æ–¹å¿˜äº†å‘¢ï¼Œé‚£å°±å†…å­˜æ³„æ¼äº†ã€‚</p><p>å¤§ç¥<a href="https://yulingtianxia.com/blog/2015/11/13/Summary-of-the-first-month-in-the-internship-of-Tencent/" target="_blank" rel="noopener">ç‰ä»¤å¤©ä¸‹</a>çš„æ–¹å¼æ˜¯ä½¿ç”¨å¼±å¼•ç”¨çš„å˜é‡æŒæœ‰å¤–ç•Œçš„è°ƒç”¨è€…ï¼Œç„¶ååœ¨é€‚å½“æ—¶æœºå°†ç»„ä»¶â€œè‡ªå·±â€ç½®ä¸ºç©ºã€‚ä¸è¿‡éœ€è¦ç»™è°ƒç”¨è€…å†™ä¸ªåˆ†ç±»ï¼ˆå±æ€§ï¼‰æŒæœ‰ç»„ä»¶ï¼Œè¿˜éœ€è¦æ˜ç¡®åˆ‡æ–­å¾ªç¯å¼•ç”¨çš„æ—¶æœºï¼Œå¯¹äºæˆ‘çš„è¿™ä¸ª100æ¥è¡Œçš„PageViewï¼Œå¯èƒ½æœ‰ç‚¹ä¸å¤ªåˆé€‚ã€‚</p><p>çªç„¶è„‘æ´ä¸€å¼€ï¼Œæƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¾å¼è®©ä½¿ç”¨æ–¹ä¼ è¿›æ¥è°ƒç”¨è€…ï¼Œé‡æ–°å®šä¹‰å¤–ç•Œçš„<code>self</code>ï¼Œå°†å…¶ä½œä¸ºä¸€ä¸ªå›è°ƒå‚æ•°ä¼ é€’ç»™ä½¿ç”¨æ–¹ï¼ˆPageViewå†…éƒ¨ä½¿ç”¨weakæŒæœ‰å¤–ç•Œçš„<code>self</code>ï¼‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span> (^tapHandler)(<span class="built_in">NSUInteger</span> idx, <span class="built_in">UIImage</span> *img, <span class="built_in">NSURL</span> *url, <span class="keyword">id</span> <span class="keyword">self</span>);</span><br></pre></td></tr></table></figure><p>å¤–ç•Œä½¿ç”¨çš„æ—¶å€™åƒè¿™æ ·ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">pageView.tapHandler = ^(<span class="built_in">NSUInteger</span> idx, <span class="built_in">UIImage</span> *img, <span class="built_in">NSURL</span> *url, <span class="built_in">UIViewController</span> *<span class="keyword">self</span>) &#123;</span><br><span class="line">   [<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¡®å®èƒ½è§£å†³å¾ªç¯å¼•ç”¨ï¼Œè€Œä¸”ä¸æ˜¯å¾ˆè´¹äº‹ã€‚ä½†æ˜¯ï¼Œå®é™…ä½¿ç”¨çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">pageView.tapHandler = ^(<span class="built_in">NSUInteger</span> idx, <span class="built_in">UIImage</span> *img, <span class="built_in">NSURL</span> *url, <span class="keyword">id</span> controller) &#123;</span><br><span class="line">   <span class="comment">// éœ€è¦æ‰‹åŠ¨æŠŠidç±»å‹æ”¹æˆå®é™…çš„ç±»å‹ï¼Œå¦‚UIViewControllerã€UIViewç­‰ç­‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸çŸ¥é“å¤–ç•Œçš„<code>self</code>æ˜¯å•¥ç±»å‹ï¼Œåªèƒ½ç”¨<code>id</code>ã€‚æˆ‘æ„Ÿè§‰ä¹Ÿä¸æ˜¯å¾ˆå·§å¦™ã€‚æ‰€ä»¥ï¼Œè¿˜æ˜¯ä½¿ç”¨è‹¹æœæ¨èçš„ä¸»æµçš„weak-strongå§ã€‚</p><h1 id="ä¸‰ã€ä½¿ç”¨"><a href="#ä¸‰ã€ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ä½¿ç”¨"></a>ä¸‰ã€ä½¿ç”¨</h1><h4 id="æœ¬åœ°å›¾ç‰‡"><a href="#æœ¬åœ°å›¾ç‰‡" class="headerlink" title="æœ¬åœ°å›¾ç‰‡"></a>æœ¬åœ°å›¾ç‰‡</h4><p>æœ¬åœ°å›¾ç‰‡ç›´æ¥ä¼ å…¥UIImageæ•°ç»„å³å¯ã€‚</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šæ„é€ å™¨ï¼Œè®¾å®špageWidthã€pageInsetç­‰</span></span><br><span class="line">YAPageView *pageView = [[YAPageView alloc] <span class="string">initWithFrame:</span>CGRectMake(<span class="number">0</span>, <span class="number">200</span>, kScreenWidth, <span class="number">200</span>) <span class="string">controller:</span>self <span class="string">pageWidth:</span><span class="number">300</span> <span class="string">pageInset:</span><span class="number">20</span>];</span><br><span class="line">pageView.imageArray = @[</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"1"</span>],</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"2"</span>],</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"3"</span>],</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"4"</span>],</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"5"</span>],</span><br><span class="line">    [UIImage <span class="string">imageNamed:</span>@<span class="string">"6"</span>],</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œå›¾ç‰‡"><a href="#ç½‘ç»œå›¾ç‰‡" class="headerlink" title="ç½‘ç»œå›¾ç‰‡"></a>ç½‘ç»œå›¾ç‰‡</h4><p>ç½‘ç»œå›¾ç‰‡ä¼ å…¥å›¾ç‰‡URLæ•°ç»„ï¼Œå¹¶è®¾ç½®å¤„ç†å›¾ç‰‡çš„blockã€‚è¿™ä¸ªblockæŒ‡çš„æ˜¯ç»™UIImageViewè®¾ç½®å›¾ç‰‡URLçš„æ–¹å¼ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœä½¿ç”¨SDWebImageï¼Œå¯ä»¥è¿™ä¹ˆè®¾ç½®</span></span><br><span class="line">pageView.configImageHandler = ^(<span class="built_in">UIImageView</span> *imageView, <span class="built_in">NSURL</span> *url) &#123;</span><br><span class="line">   [imageView sd_setImageWithURL:url];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pageView.imageURLArray = @[</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/230/350/200"</span>],</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/231/350/200"</span>],</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/232/350/200"</span>],</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/233/350/200"</span>],</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/234/350/200"</span>],</span><br><span class="line">    [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://picsum.photos/id/235/350/200"</span>]</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h4 id="è®¾ç½®è‡ªåŠ¨è½®æ’­æ—¶é—´"><a href="#è®¾ç½®è‡ªåŠ¨è½®æ’­æ—¶é—´" class="headerlink" title="è®¾ç½®è‡ªåŠ¨è½®æ’­æ—¶é—´"></a>è®¾ç½®è‡ªåŠ¨è½®æ’­æ—¶é—´</h4><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">pageView.timeInterval = <span class="number">3</span>.f<span class="comment">;</span></span><br></pre></td></tr></table></figure><h4 id="è®¾ç½®ç‚¹å‡»å›è°ƒ"><a href="#è®¾ç½®ç‚¹å‡»å›è°ƒ" class="headerlink" title="è®¾ç½®ç‚¹å‡»å›è°ƒ"></a>è®¾ç½®ç‚¹å‡»å›è°ƒ</h4><p>åˆ«å¿˜äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">pageView.tapHandler = ^(<span class="built_in">NSUInteger</span> idx, <span class="built_in">UIImage</span> *img, <span class="built_in">NSURL</span> *url) &#123;</span><br><span class="line">   __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) <span class="keyword">self</span> = weakSelf;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"self = %@, index = %lu, url = %@"</span>, <span class="keyword">self</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)idx, url);</span><br><span class="line">   [<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>æ•´ä½“è€Œè¨€ï¼Œæ²¡æœ‰å†—ä½™é€»è¾‘ï¼Œèƒ½ä¼˜åŒ–çš„ä¹Ÿä¼˜åŒ–äº†ï¼ˆæ¯”å¦‚ç´¢å¼•è®¡ç®—å¯¹å–æ¨¡çš„ä¼˜åŒ–ã€å®šæ—¶å™¨æ‡’åŠ è½½ã€åˆ·æ–°æ—¶æœºæ¬¡æ•°ç­‰ç­‰ï¼‰ï¼Œåº”è¯¥ç®—æ˜¯æ¯”è¾ƒè½»é‡äº†å§å“ˆå“ˆå“ˆå“ˆã€‚</p><p>å…·ä½“åº”ç”¨æ–¹é¢ï¼Œæ¯”å¦‚è…¾è®¯è§†é¢‘Appä¸­çš„é¦–é¡µTabã€ä¼šå‘˜Tabéƒ½æœ‰è¿™ç§custom widthçš„è½®æ’­å›¾ã€‚<br><img src="https://image.chenyalun.com/2019/08/07/002.gif" style="zoom:80%"></p><p>QQéŸ³ä¹ä¸­çš„å‘ç°Tabä¹Ÿæ˜¯è¿™ç§è½®æ’­å›¾ï¼Œä¸è¿‡ä¸èƒ½æ— é™å¾ªç¯ï¼ˆä¸èƒ½æ— é™å¾ªç¯å²‚ä¸æ˜¯æ›´ç®€å•ã€‚ã€‚ï¼‰ã€‚<br><img src="https://image.chenyalun.com/2019/08/07/001.gif" style="zoom:80%"></p><p>å¥½äº†ï¼ŒæŠŠä¸¤å¹´å‰çš„å‘å¡«ä¸Šäº†ã€‚</p><hr><p><strong>åè®°</strong><br>æœ‰å› å¿…æœ‰æœã€‚<br>2019å¹´11æœˆï¼Œå›¾æœè¿›è¡Œå¤§æ”¹ç‰ˆï¼Œpmæœ‰ä¸ªæ–°ç‰¹æ€§å¼•å¯¼çš„éœ€æ±‚ã€‚äºæ˜¯æˆ‘åœ¨è¿™ä¸ªä»£ç çš„åŸºç¡€ä¸Šä¿®ä¿®æ”¹æ”¹ï¼Œå¾ˆå¿«å°±å¼€å‘å®Œæ¯•äº†ï¼Œå¤§å¹…ç¼©çŸ­äº†è¿™å—éœ€æ±‚çš„å¼€å‘æ—¶é—´ğŸ˜ã€‚</p><p><img src="https://image.chenyalun.com/2019/08/07/010.png" style="zoom:30%"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; è½»é‡çº§ã€æ–°æ ·å¼è½®æ’­è§†å›¾ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="å¼€æºé¡¹ç›®" scheme="http://blog.chenyalun.com/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»“æ„çš„Swiftå®ç°</title>
    <link href="http://blog.chenyalun.com/2019/07/31/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84Swift%E5%AE%9E%E7%8E%B0/"/>
    <id>http://blog.chenyalun.com/2019/07/31/æ•°æ®ç»“æ„çš„Swiftå®ç°/</id>
    <published>2019-07-31T03:39:23.000Z</published>
    <updated>2019-08-15T06:28:17.052Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> ä½¿ç”¨Swiftå®ç°å¸¸è§çš„æ•°æ®ç»“æ„ã€‚ </p><br><a id="more"></a><p></p><h2 id="1-åŠ¨æ€æ•°ç»„"><a href="#1-åŠ¨æ€æ•°ç»„" class="headerlink" title="1.åŠ¨æ€æ•°ç»„"></a>1.åŠ¨æ€æ•°ç»„</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡(åªè¯»)</span></span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨nilä½œä¸ºå ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> elements: [<span class="type">T</span>?]</span><br><span class="line">    <span class="comment">// é»˜è®¤10ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">DEFAULT_CAPACITY</span> = <span class="number">10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨, åˆå§‹åŒ–å®¹é‡ä¸ºcapaticyçš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> capaticy: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> capaticy = capaticy &lt; <span class="type">DEFAULT_CAPACITY</span> ? <span class="type">DEFAULT_CAPACITY</span> : capaticy</span><br><span class="line">        elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: capaticy)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ’å…¥å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        ensureCapacity()</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> (index...<span class="built_in">count</span>).reversed() &#123;</span><br><span class="line">            elements[idx + <span class="number">1</span>] = elements[idx]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">        elements[index] = item</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿½åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        insert(item, <span class="built_in">count</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•æ‰€åœ¨å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">return</span> elements[index]!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        elements[index] = item</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> ele = <span class="keyword">get</span>(index)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> index..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            elements[idx] = elements[idx + <span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        elements[<span class="built_in">count</span> - <span class="number">1</span>] = <span class="literal">nil</span></span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            elements[idx] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">contains</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// item ä¸å¯èƒ½ä¸ºnil</span></span><br><span class="line">        <span class="keyword">return</span> indexOf(item) != <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æŸä¸ªå…ƒç´ å¯¹åº”çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">indexOf</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„itemä¸å¯èƒ½ä¸ºnil</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> elements[idx]! == item &#123;</span><br><span class="line">                <span class="keyword">return</span> idx</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">ensureCapacity</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> &gt; elements.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> elements = <span class="keyword">self</span>.elements</span><br><span class="line">            <span class="comment">// æ‰©å®¹1.5å€</span></span><br><span class="line">            <span class="keyword">let</span> newCapacity = elements.<span class="built_in">count</span> + elements.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">self</span>.elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: newCapacity)</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.elements[idx] = elements[idx]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">checkBounds</span><span class="params">(<span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è¿‡ç¨‹ä¸­å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹:</p><ol><li>åœ¨<code>indexOf()</code>å‡½æ•°ä¸­ï¼Œå…ƒç´ ä½¿ç”¨<code>==</code>åˆ¤ç­‰ï¼Œéœ€è¦éµå®ˆEquatableåè®®</li><li>æ•°ç»„çš„æ‰©å®¹ä¸­ï¼Œä½¿ç”¨ä½è¿ç®—ç¬¦å¯ä»¥é¿å…äº§ç”Ÿæµ®ç‚¹æ•°</li><li>ç”±äºSwiftä¸­å¯é€‰ç±»å‹çš„å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨nilæ¥å ä½ã€‚å½“ç„¶ï¼Œåœ¨<code>set()ã€append()</code>ç­‰å‡½æ•°ä¸­ï¼Œç”±äºç±»å‹ç¡®å®šä¹Ÿçœç•¥äº†å¤–ç•Œä¼ å‚æ—¶å¯¹ç©ºå€¼çš„åˆ¤æ–­</li></ol><h3 id="åŠ¨æ€æ•°ç»„ä¼˜åŒ–"><a href="#åŠ¨æ€æ•°ç»„ä¼˜åŒ–" class="headerlink" title="åŠ¨æ€æ•°ç»„ä¼˜åŒ–"></a>åŠ¨æ€æ•°ç»„ä¼˜åŒ–</h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OPArrayList</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡(åªè¯»)</span></span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨nilä½œä¸ºå ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> elements: [<span class="type">T</span>?]</span><br><span class="line">    <span class="comment">// é¦–ä½å…ƒç´ ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> frontIndex = <span class="number">0</span></span><br><span class="line">    <span class="comment">// é»˜è®¤10ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">DEFAULT_CAPACITY</span> = <span class="number">10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨, åˆå§‹åŒ–å®¹é‡ä¸ºcapaticyçš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> capaticy: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> capaticy = capaticy &lt; <span class="type">DEFAULT_CAPACITY</span> ? <span class="type">DEFAULT_CAPACITY</span> : capaticy</span><br><span class="line">        elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: capaticy)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ’å…¥å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        ensureCapacity()</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> (index..&lt;<span class="built_in">count</span>).reversed() &#123;</span><br><span class="line">            elements[actualIndex(idx + <span class="number">1</span>)] = elements[actualIndex(idx)]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">        elements[actualIndex(index)] = item</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿½åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        insert(item, <span class="built_in">count</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•æ‰€åœ¨å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">return</span> elements[actualIndex(index)]!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        elements[actualIndex(index)] = item</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> ele = elements[actualIndex(index)]!</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span> &#123;</span><br><span class="line">            elements[frontIndex] = <span class="literal">nil</span></span><br><span class="line">            frontIndex += <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> index..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">                elements[actualIndex(idx)] = elements[actualIndex(idx + <span class="number">1</span>)]</span><br><span class="line">            &#125;</span><br><span class="line">            elements[actualIndex(<span class="built_in">count</span> - <span class="number">1</span>)] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            elements[actualIndex(idx)] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">contains</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// item ä¸å¯èƒ½ä¸ºnil</span></span><br><span class="line">        <span class="keyword">return</span> indexOf(item) != <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æŸä¸ªå…ƒç´ å¯¹åº”çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">indexOf</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„itemä¸å¯èƒ½ä¸ºnil</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> elements[actualIndex(idx)]! == item &#123;</span><br><span class="line">                <span class="keyword">return</span> idx</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–çœŸå®ç´¢å¼•: (frontIndex + index) % elements.count</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">actualIndex</span><span class="params">(<span class="number">_</span> idx: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (frontIndex + idx) % elements.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">ensureCapacity</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> == elements.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> elements = <span class="keyword">self</span>.elements</span><br><span class="line">            <span class="comment">// æ‰©å®¹1.5å€</span></span><br><span class="line">            <span class="keyword">let</span> newCapacity = elements.<span class="built_in">count</span> + elements.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">self</span>.elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: newCapacity)</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> index = (frontIndex + idx) % elements.<span class="built_in">count</span></span><br><span class="line">                <span class="keyword">self</span>.elements[idx] = elements[index]</span><br><span class="line">            &#125;</span><br><span class="line">            frontIndex = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">checkBounds</span><span class="params">(<span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„å†…å®¹æ‰“å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> str = <span class="string">"["</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;elements.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> a = <span class="string">", "</span></span><br><span class="line">            <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">                a = <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> elements[idx] != <span class="literal">nil</span> &#123;</span><br><span class="line">                str += <span class="string">"<span class="subst">\(a)</span><span class="subst">\(elements[idx]!)</span>"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                str += <span class="string">"<span class="subst">\(a)</span>nil"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        str += <span class="string">"], frontIndex = <span class="subst">\(frontIndex)</span>, count = <span class="subst">\(<span class="built_in">count</span>)</span>"</span></span><br><span class="line">        <span class="built_in">print</span>(str)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-å•å‘é“¾è¡¨"><a href="#2-å•å‘é“¾è¡¨" class="headerlink" title="2.å•å‘é“¾è¡¨"></a>2.å•å‘é“¾è¡¨</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OneWayLinkedList</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ²¡æœ‰æ‰¾åˆ°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> first: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> firstEle: <span class="type">T</span>?) &#123;</span><br><span class="line">        <span class="keyword">if</span> firstEle == <span class="literal">nil</span> &#123;</span><br><span class="line">            first = <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            first = <span class="type">Node</span>(ele: firstEle!, next: <span class="literal">nil</span>)</span><br><span class="line">            <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¾¿åˆ©æ„é€ </span></span><br><span class="line">    <span class="keyword">convenience</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»“ç‚¹ç±»</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ele: <span class="type">T</span></span><br><span class="line">        <span class="keyword">var</span> next: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">init</span>(ele: <span class="type">T</span>, next: <span class="type">Node</span>?) &#123;</span><br><span class="line">            <span class="keyword">self</span>.ele = ele</span><br><span class="line">            <span class="keyword">self</span>.next = next</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•æ‰€åœ¨å…ƒç´ è·å–</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> node(index).ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨æŸç´¢å¼•å¤„æ’å…¥å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prev = first</span><br><span class="line">            <span class="keyword">let</span> newNode = <span class="type">Node</span>(ele: item, next: prev)</span><br><span class="line">            first = newNode</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prev = node(index - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">let</span> newNode = <span class="type">Node</span>(ele: item, next: prev.next)</span><br><span class="line">            prev.next = newNode</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿½åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        insert(item, <span class="built_in">count</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤æŸç´¢å¼•çš„å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(<span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span> &#123;</span><br><span class="line">            first = first?.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> noe = node(index - <span class="number">1</span>)</span><br><span class="line">            noe.next = noe.next?.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æŸå…ƒç´ æ‰€åœ¨ç´¢å¼•</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">indexOf</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> node = first</span><br><span class="line">        <span class="keyword">var</span> idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> node!.ele == item &#123;</span><br><span class="line">                <span class="keyword">return</span> idx</span><br><span class="line">            &#125;</span><br><span class="line">            node = node!.next</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.first = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> node = first</span><br><span class="line">        <span class="keyword">var</span> str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">                str += <span class="string">"first:<span class="subst">\(node!.ele)</span>,"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> node!.next != <span class="literal">nil</span> &#123;</span><br><span class="line">                str += <span class="string">" [<span class="subst">\(node!.ele)</span>, <span class="subst">\(node!.next!.ele)</span>]"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                str += <span class="string">" [<span class="subst">\(node!.ele)</span>, nil]"</span></span><br><span class="line">            &#125;</span><br><span class="line">            node = node!.next</span><br><span class="line">            <span class="keyword">if</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">                str += <span class="string">","</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(str)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•æ‰€åœ¨çš„ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">node</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">var</span> node = <span class="keyword">self</span>.first</span><br><span class="line">        <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;index &#123;</span><br><span class="line">            node = node?.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> node!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">checkBounds</span><span class="params">(<span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-å•å‘å¾ªç¯é“¾è¡¨"><a href="#3-å•å‘å¾ªç¯é“¾è¡¨" class="headerlink" title="3.å•å‘å¾ªç¯é“¾è¡¨"></a>3.å•å‘å¾ªç¯é“¾è¡¨</h2><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">class OneWayCircularLinkedList&lt;T: Equatable&gt;: OneWayLinkedList<span class="symbol">&lt;T&gt;</span> &#123;</span><br><span class="line">    override func <span class="keyword">insert</span>(_ item: T, _ <span class="built_in">index</span>: Int) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> &lt; <span class="number">0</span> || <span class="built_in">index</span> &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            // è¶Šç•Œ</span><br><span class="line">            fatalError(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">prev</span> = <span class="keyword">first</span></span><br><span class="line">            <span class="keyword">let</span> newNode = Node(ele: item, nex<span class="variable">t:</span> <span class="keyword">prev</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">prev</span> == nil &#123;</span><br><span class="line">                // åªæœ‰ä¸€ä¸ªå…ƒç´ </span><br><span class="line">                newNode.<span class="keyword">next</span> = newNode</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">first</span> = newNode</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">prev</span> = node(<span class="built_in">index</span> - <span class="number">1</span>)</span><br><span class="line">            // å¤„ç†æ·»åŠ åˆ°æœ€åä¸€ä¸ªä½ç½®</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">fir</span> = (<span class="built_in">index</span> == <span class="built_in">count</span>) ? <span class="keyword">first</span> : <span class="keyword">prev</span>.<span class="keyword">next</span></span><br><span class="line">            <span class="keyword">let</span> newNode = Node(ele: item, nex<span class="variable">t:</span> <span class="keyword">fir</span>)</span><br><span class="line">            <span class="keyword">prev</span>.<span class="keyword">next</span> = newNode</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func <span class="built_in">remove</span>(_ <span class="built_in">index</span>: Int) &#123;</span><br><span class="line">        checkBounds(<span class="built_in">index</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">last</span> = node(<span class="built_in">count</span> - <span class="number">1</span>)</span><br><span class="line">            // å¯¹æœ€åä¸€ä¸ªå…ƒç´ çš„å¤„ç†</span><br><span class="line">            <span class="keyword">first</span> = (<span class="built_in">count</span> - <span class="number">1</span> == <span class="built_in">index</span>) ? nil : <span class="keyword">first</span>?.<span class="keyword">next</span></span><br><span class="line">            <span class="keyword">last</span>.<span class="keyword">next</span> = <span class="keyword">first</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> noe = node(<span class="built_in">index</span> - <span class="number">1</span>)</span><br><span class="line">            noe.<span class="keyword">next</span> = noe.<span class="keyword">next</span>?.<span class="keyword">next</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func clear() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">last</span> = node(<span class="built_in">count</span> - <span class="number">1</span>)</span><br><span class="line">        // æ‰“ç ´å¾ªç¯å¼•ç”¨</span><br><span class="line">        <span class="keyword">last</span>.<span class="keyword">next</span> = nil</span><br><span class="line">        // è°ƒç”¨çˆ¶ç±»</span><br><span class="line">        super.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-åŒå‘é“¾è¡¨"><a href="#4-åŒå‘é“¾è¡¨" class="headerlink" title="4.åŒå‘é“¾è¡¨"></a>4.åŒå‘é“¾è¡¨</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TwoWayLinkedList</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ²¡æœ‰æ‰¾åˆ°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">fileprivate</span>(<span class="keyword">set</span>) <span class="keyword">var</span> first: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">    <span class="keyword">fileprivate</span>(<span class="keyword">set</span>) <span class="keyword">var</span> last: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">    <span class="keyword">fileprivate</span>(<span class="keyword">set</span>) <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> ele: <span class="type">T</span>?) &#123;</span><br><span class="line">        <span class="keyword">if</span> ele == <span class="literal">nil</span> &#123;</span><br><span class="line">            first = <span class="literal">nil</span></span><br><span class="line">            last = <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            first = <span class="type">Node</span>(ele: ele!, prev: <span class="literal">nil</span>, next: <span class="literal">nil</span>)</span><br><span class="line">            last = first</span><br><span class="line">            <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¾¿åˆ©æ„é€ </span></span><br><span class="line">    <span class="keyword">convenience</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»“ç‚¹ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ele: <span class="type">T</span></span><br><span class="line">        <span class="keyword">var</span> prev: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">var</span> next: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">init</span>(ele: <span class="type">T</span>, prev: <span class="type">Node</span>?, next: <span class="type">Node</span>?) &#123;</span><br><span class="line">            <span class="keyword">self</span>.ele = ele</span><br><span class="line">            <span class="keyword">self</span>.prev = prev</span><br><span class="line">            <span class="keyword">self</span>.next = next</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•æ‰€åœ¨å…ƒç´ è·å–</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">return</span> node(index).ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨æŸç´¢å¼•å¤„æ’å…¥å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> item: T, <span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> index == <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prev = last</span><br><span class="line">            <span class="keyword">let</span> newNode = <span class="type">Node</span>(ele: item, prev: prev, next: <span class="literal">nil</span>)</span><br><span class="line">            last = newNode</span><br><span class="line">            prev?.next = newNode</span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">0</span> &#123;</span><br><span class="line">                first = last</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> next = node(index)</span><br><span class="line">            <span class="keyword">let</span> prev = next.prev</span><br><span class="line">            <span class="keyword">let</span> newNode = <span class="type">Node</span>(ele: item, prev: prev, next: next)</span><br><span class="line">            next.prev = newNode</span><br><span class="line">            prev?.next = newNode</span><br><span class="line">            <span class="keyword">if</span> newNode.prev == <span class="literal">nil</span> &#123;</span><br><span class="line">                first = newNode</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿½åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        insert(item, <span class="built_in">count</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤æŸç´¢å¼•çš„å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">let</span> old = node(index)</span><br><span class="line">        <span class="keyword">let</span> prev = old.prev</span><br><span class="line">        <span class="keyword">let</span> next = old.next</span><br><span class="line">        <span class="keyword">if</span> next == <span class="literal">nil</span> &#123;</span><br><span class="line">            last = prev</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next?.prev = prev</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> prev == <span class="literal">nil</span> &#123;</span><br><span class="line">            first = next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev?.next = next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> old.ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æŸå…ƒç´ æ‰€åœ¨ç´¢å¼•</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">indexOf</span><span class="params">(<span class="number">_</span> item: T)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> node = first</span><br><span class="line">        <span class="keyword">var</span> idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> node!.ele == item &#123;</span><br><span class="line">                <span class="keyword">return</span> idx</span><br><span class="line">            &#125;</span><br><span class="line">            node = node!.next</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ELEMENT_NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ‰“ç ´å¾ªç¯å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">var</span> first = <span class="keyword">self</span>.first</span><br><span class="line">        <span class="keyword">while</span> first != <span class="literal">nil</span> &#123;</span><br><span class="line">            first?.prev = <span class="literal">nil</span></span><br><span class="line">            first = first?.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.first = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.last = <span class="literal">nil</span></span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> node = first</span><br><span class="line">        <span class="keyword">var</span> str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">                str += <span class="string">"first:<span class="subst">\(node!.ele)</span>,"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> node!.next != <span class="literal">nil</span> &#123;</span><br><span class="line">                str += <span class="string">" [<span class="subst">\(node!.ele)</span>, <span class="subst">\(node!.next!.ele)</span>]"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                str += <span class="string">" [<span class="subst">\(node!.ele)</span>, nil]"</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">                str += <span class="string">","</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> idx == <span class="built_in">count</span> - <span class="number">1</span> &#123;</span><br><span class="line">                str += <span class="string">" last:<span class="subst">\(node!.ele)</span>"</span></span><br><span class="line">            &#125;</span><br><span class="line">            node = node!.next</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(str)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•æ‰€åœ¨çš„ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">node</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">        checkBounds(index)</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="built_in">count</span> &gt;&gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// åœ¨å‰åŠéƒ¨åˆ†æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">var</span> node = <span class="keyword">self</span>.first</span><br><span class="line">            <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;index &#123;</span><br><span class="line">                node = node?.next</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> node!</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åœ¨ååŠéƒ¨åˆ†æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">var</span> node = <span class="keyword">self</span>.last</span><br><span class="line">            <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> (index + <span class="number">1</span>..&lt;<span class="built_in">count</span>).reversed() &#123;</span><br><span class="line">                node = node?.prev</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> node!</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">checkBounds</span><span class="params">(<span class="number">_</span> index: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="comment">// è¶Šç•Œ</span></span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-åŒå‘å¾ªç¯é“¾è¡¨"><a href="#5-åŒå‘å¾ªç¯é“¾è¡¨" class="headerlink" title="5.åŒå‘å¾ªç¯é“¾è¡¨"></a>5.åŒå‘å¾ªç¯é“¾è¡¨</h2><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">class TwoWayCircularLinkedList&lt;T: Equatable&gt;: TwoWayLinkedList<span class="symbol">&lt;T&gt;</span> &#123;</span><br><span class="line">    override func <span class="keyword">insert</span>(_ item: T, _ <span class="built_in">index</span>: Int) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> &lt; <span class="number">0</span> || <span class="built_in">index</span> &gt; <span class="built_in">count</span> &#123;</span><br><span class="line">            // è¶Šç•Œ</span><br><span class="line">            fatalError(<span class="string">"ç´¢å¼•æœ‰è¯¯, å·²ç»è¶Šç•Œ"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> == <span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">prev</span> = <span class="keyword">last</span></span><br><span class="line">            <span class="keyword">let</span> newNode = Node(ele: item, <span class="keyword">pre</span><span class="variable">v:</span> <span class="keyword">prev</span>, nex<span class="variable">t:</span> <span class="keyword">first</span>)</span><br><span class="line">            <span class="keyword">last</span> = newNode</span><br><span class="line">            <span class="keyword">prev</span>?.<span class="keyword">next</span> = newNode</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">first</span> = <span class="keyword">last</span></span><br><span class="line">                <span class="keyword">last</span>?.<span class="keyword">next</span> = newNode</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">first</span>?.<span class="keyword">prev</span> = newNode</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">next</span> = node(<span class="built_in">index</span>)</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">prev</span> = <span class="keyword">next</span>.<span class="keyword">prev</span></span><br><span class="line">            <span class="keyword">let</span> newNode = Node(ele: item, <span class="keyword">pre</span><span class="variable">v:</span> <span class="keyword">prev</span>, nex<span class="variable">t:</span> <span class="keyword">next</span>)</span><br><span class="line">            <span class="keyword">next</span>.<span class="keyword">prev</span> = newNode</span><br><span class="line">            <span class="keyword">prev</span>?.<span class="keyword">next</span> = newNode</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">                // é¦–ä½æ’å…¥å…ƒç´ </span><br><span class="line">                <span class="keyword">first</span> = newNode</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func <span class="built_in">remove</span>(_ <span class="built_in">index</span>: Int) -&gt; T &#123;</span><br><span class="line">        checkBounds(<span class="built_in">index</span>)</span><br><span class="line">        <span class="keyword">let</span> old: Node = node(<span class="built_in">index</span>)</span><br><span class="line">        var <span class="keyword">prev</span> = old.<span class="keyword">prev</span></span><br><span class="line">        var <span class="keyword">next</span> = old.<span class="keyword">next</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &amp;&amp; <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">            // åªæœ‰ä¸€ä¸ªå…ƒç´ </span><br><span class="line">            <span class="keyword">prev</span> = nil</span><br><span class="line">            <span class="keyword">next</span> = nil</span><br><span class="line">            old.<span class="keyword">next</span> = nil</span><br><span class="line">            old.<span class="keyword">prev</span> = nil</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">first</span> = <span class="keyword">next</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">index</span> == <span class="built_in">count</span> - <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">last</span> = <span class="keyword">prev</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">prev</span>?.<span class="keyword">next</span> = <span class="keyword">next</span></span><br><span class="line">        <span class="keyword">next</span>?.<span class="keyword">prev</span> = <span class="keyword">prev</span></span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> old.ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func clear() &#123;</span><br><span class="line">        // æ‰“ç ´å¾ªç¯å¼•ç”¨</span><br><span class="line">        var <span class="keyword">first</span> = self.<span class="keyword">first</span></span><br><span class="line">        <span class="keyword">for</span> idx in <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">first</span>?.<span class="keyword">prev</span> = nil</span><br><span class="line">            <span class="keyword">first</span> = <span class="keyword">first</span>?.<span class="keyword">next</span></span><br><span class="line">            <span class="keyword">if</span> idx == <span class="built_in">count</span> - <span class="number">1</span> &#123;</span><br><span class="line">                <span class="keyword">first</span>?.<span class="keyword">next</span> = nil</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self.<span class="keyword">first</span> = nil</span><br><span class="line">        self.<span class="keyword">last</span> = nil</span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-æ ˆ"><a href="#6-æ ˆ" class="headerlink" title="6.æ ˆ"></a>6.æ ˆ</h2><p>ä½¿ç”¨åŠ¨æ€æ•°ç»„å®ç°ã€‚</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®å®¹é‡é»˜è®¤ä¸º10, å¯è‡ªåŠ¨æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> list: <span class="type">ArrayList</span>&lt;<span class="type">T</span>&gt; = <span class="type">ArrayList</span>(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¥æ ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        list.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡ºæ ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.remove(size() - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ ˆé¡¶å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">top</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> size() == <span class="number">0</span> ? <span class="literal">nil</span> : list.<span class="keyword">get</span>(size() - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        list.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-é˜Ÿåˆ—"><a href="#7-é˜Ÿåˆ—" class="headerlink" title="7.é˜Ÿåˆ—"></a>7.é˜Ÿåˆ—</h2><p>å› ä¸ºé¢‘ç¹åœ°åœ¨å¼€å¤´æœ«å°¾æ·»åŠ åˆ é™¤å…ƒç´ æ‰€ä»¥ä½¿ç”¨é“¾è¡¨å®ç°<br>åˆå› ä¸ºåŒå‘é“¾è¡¨æœ‰å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆè€Œå•å‘é“¾è¡¨åªæœ‰å¤´æŒ‡é’ˆæ‰€ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨å®ç°(å‡å°‘éå†)</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> list: <span class="type">TwoWayLinkedList</span>&lt;<span class="type">T</span>&gt; = <span class="type">TwoWayLinkedList</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueue</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        list.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueue</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.remove(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> list.first?.ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        list.clear()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        list.desc()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨æ ˆå®ç°é˜Ÿåˆ—"><a href="#ä½¿ç”¨æ ˆå®ç°é˜Ÿåˆ—" class="headerlink" title="ä½¿ç”¨æ ˆå®ç°é˜Ÿåˆ—"></a>ä½¿ç”¨æ ˆå®ç°é˜Ÿåˆ—</h4><p>åŸç†:</p><ol><li>å…¥é˜Ÿæ—¶, æŠŠå…ƒç´ æ”¾å…¥inStackä¸­</li><li>å‡ºé˜Ÿæ—¶, å¦‚æœoutStackä¸ºç©º, åˆ™æŠŠinStackä¸­çš„å…¨éƒ¨æ ˆé¡¶å…ƒç´ ä¾æ¬¡æ”¾åˆ°outStackä¸­, è¿”å›outStackçš„æ ˆé¡¶å…ƒç´ , å¦åˆ™, ç›´æ¥è¿”å›outStackçš„æ ˆé¡¶å…ƒç´ <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue_UseStack</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ç»´æŠ¤ä¸¤ä¸ªæ ˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> inStack: <span class="type">Stack</span>&lt;<span class="type">T</span>&gt; = <span class="type">Stack</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> outStack: <span class="type">Stack</span>&lt;<span class="type">T</span>&gt; = <span class="type">Stack</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> inStack.size() + outStack.size()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size() == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueue</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        inStack.push(item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueue</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> outStack.isEmpty() &#123;</span><br><span class="line">            <span class="keyword">while</span> inStack.isEmpty() == <span class="literal">false</span> &#123;</span><br><span class="line">                outStack.push(inStack.pop())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> outStack.pop()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> outStack.isEmpty() &#123;</span><br><span class="line">            <span class="keyword">while</span> inStack.isEmpty() == <span class="literal">false</span> &#123;</span><br><span class="line">                outStack.push(inStack.pop())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> outStack.top()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        inStack.clear()</span><br><span class="line">        outStack.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="8-å¾ªç¯é˜Ÿåˆ—"><a href="#8-å¾ªç¯é˜Ÿåˆ—" class="headerlink" title="8.å¾ªç¯é˜Ÿåˆ—"></a>8.å¾ªç¯é˜Ÿåˆ—</h2><p>ä½¿ç”¨åŠ¨æ€æ•°ç»„å®ç°, ä¸”å„æ¥å£ä¼˜åŒ–åˆ°O(1)æ—¶é—´å¤æ‚åº¦<br>è¦ç‚¹:</p><ol><li>æœ‰ä¸€ä¸ªæŒ‡å‘é˜Ÿå¤´å…ƒç´ çš„ç´¢å¼•frontIndex, å¿…ä¸å¯å°‘</li><li>æ¥å£ç´¢å¼•ä¸çœŸå®ç´¢å¼•çš„äº’æ¢: çœŸå®ç´¢å¼• = (frontIndex + index) % elements.count</li><li>å…¥é˜Ÿ</li></ol><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleQueue</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘é˜Ÿå¤´çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> frontIndex: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨nilä½œä¸ºå ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> elements: [<span class="type">T</span>?]</span><br><span class="line">    <span class="comment">// é»˜è®¤10ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">DEFAULT_CAPACITY</span> = <span class="number">10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨, åˆå§‹åŒ–å®¹é‡ä¸ºcapaticyçš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> capaticy: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> capaticy = capaticy &lt; <span class="type">DEFAULT_CAPACITY</span> ? <span class="type">DEFAULT_CAPACITY</span> : capaticy</span><br><span class="line">        elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: capaticy)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueue</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        ensureCapacity(<span class="built_in">count</span> + <span class="number">1</span>)</span><br><span class="line">        elements[index(<span class="built_in">count</span>)] = item</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueue</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> ele = elements[frontIndex]</span><br><span class="line">        <span class="keyword">if</span> ele == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"é˜Ÿåˆ—ä¸ºç©º"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        elements[frontIndex] = <span class="literal">nil</span></span><br><span class="line">        <span class="comment">// ä¸æ˜¯frontIndex += 1, è¦è€ƒè™‘frontIndex == elements.countä½†æ˜¯elementsæœ‰ç©ºé—²ä½ç½®çš„æƒ…å†µ</span></span><br><span class="line">        <span class="comment">// è¿™æ—¶åº”è¯¥æ˜¯frontIndex = (frontIndex + 1) % elements.count, ä¹Ÿå°±æ˜¯index(1)</span></span><br><span class="line">        frontIndex = index(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ele!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> elements[frontIndex]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;elements.<span class="built_in">count</span> &#123;</span><br><span class="line">            elements[idx] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        frontIndex = <span class="number">0</span></span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">ensureCapacity</span><span class="params">(<span class="number">_</span> capacity: Int)</span></span> &#123;</span><br><span class="line">        <span class="comment">// ä¸éœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> elements.<span class="built_in">count</span> &gt;= capacity &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> elements = <span class="keyword">self</span>.elements</span><br><span class="line">        <span class="comment">// æ‰©å®¹1.5å€</span></span><br><span class="line">        <span class="keyword">let</span> newCapacity = elements.<span class="built_in">count</span> + elements.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> newElements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: newCapacity)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            newElements[idx] = elements[index(idx)]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.elements = newElements</span><br><span class="line">        frontIndex = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•å¯¹åº”çœŸå®ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">index</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (frontIndex + index) % elements.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"frontIndex: <span class="subst">\(frontIndex)</span>"</span> + <span class="string">" eles: <span class="subst">\(elements)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-åŒç«¯é˜Ÿåˆ—"><a href="#9-åŒç«¯é˜Ÿåˆ—" class="headerlink" title="9.åŒç«¯é˜Ÿåˆ—"></a>9.åŒç«¯é˜Ÿåˆ—</h2><p>ä¸¤ç«¯éƒ½å¯ä»¥å…¥é˜Ÿå’Œå‡ºé˜Ÿ</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubleEndedQueue</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> list: <span class="type">TwoWayLinkedList</span>&lt;<span class="type">T</span>&gt; = <span class="type">TwoWayLinkedList</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå¤´å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueueFront</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        list.insert(item, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå°¾å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueueRear</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        list.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå¤´å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueueFront</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.remove(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå°¾å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueueRear</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.remove(list.<span class="built_in">count</span> - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> list.first?.ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">rear</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> list.last?.ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        list.clear()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        list.desc()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-å¾ªç¯åŒç«¯é˜Ÿåˆ—"><a href="#10-å¾ªç¯åŒç«¯é˜Ÿåˆ—" class="headerlink" title="10.å¾ªç¯åŒç«¯é˜Ÿåˆ—"></a>10.å¾ªç¯åŒç«¯é˜Ÿåˆ—</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleDoubleEndedQueue</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘é˜Ÿå¤´çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> frontIndex: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨nilä½œä¸ºå ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> elements: [<span class="type">T</span>?]</span><br><span class="line">    <span class="comment">// é»˜è®¤10ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">DEFAULT_CAPACITY</span> = <span class="number">10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">ELEMENT_NOT_FOUND</span> = -<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨, åˆå§‹åŒ–å®¹é‡ä¸ºcapaticyçš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> capaticy: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> capaticy = capaticy &lt; <span class="type">DEFAULT_CAPACITY</span> ? <span class="type">DEFAULT_CAPACITY</span> : capaticy</span><br><span class="line">        elements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: capaticy)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå¤´å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueueFront</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        ensureCapacity(<span class="built_in">count</span> + <span class="number">1</span>)</span><br><span class="line">        frontIndex = index(-<span class="number">1</span>)</span><br><span class="line">        elements[frontIndex] = item</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå°¾å…¥é˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueueRear</span><span class="params">(<span class="number">_</span> item: T)</span></span> &#123;</span><br><span class="line">        ensureCapacity(<span class="built_in">count</span> + <span class="number">1</span>)</span><br><span class="line">        elements[index(<span class="built_in">count</span>)] = item</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå¤´å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueueFront</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"é˜Ÿåˆ—ä¸ºç©º"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> ele = elements[frontIndex]</span><br><span class="line">        elements[frontIndex] = <span class="literal">nil</span></span><br><span class="line">        frontIndex = index(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ele!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»é˜Ÿå°¾å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueueRear</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"é˜Ÿåˆ—ä¸ºç©º"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> ele = elements[index(<span class="built_in">count</span> - <span class="number">1</span>)]!</span><br><span class="line">        elements[index(<span class="built_in">count</span> - <span class="number">1</span>)] = <span class="literal">nil</span></span><br><span class="line">        <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> elements[frontIndex]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">rear</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> elements[index(<span class="built_in">count</span> - <span class="number">1</span>)]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;elements.<span class="built_in">count</span> &#123;</span><br><span class="line">            elements[idx] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        frontIndex = <span class="number">0</span></span><br><span class="line">        <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">ensureCapacity</span><span class="params">(<span class="number">_</span> capacity: Int)</span></span> &#123;</span><br><span class="line">        <span class="comment">// ä¸éœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> elements.<span class="built_in">count</span> &gt;= capacity &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> elements = <span class="keyword">self</span>.elements</span><br><span class="line">        <span class="comment">// æ‰©å®¹1.5å€</span></span><br><span class="line">        <span class="keyword">let</span> newCapacity = elements.<span class="built_in">count</span> + elements.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> newElements = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: newCapacity)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">            newElements[idx] = elements[index(idx)]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.elements = newElements</span><br><span class="line">        frontIndex = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç´¢å¼•å¯¹åº”çœŸå®ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">index</span><span class="params">(<span class="number">_</span> index: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> index = index</span><br><span class="line">        index += frontIndex</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> index + elements.<span class="built_in">count</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//        return index % elements.count</span></span><br><span class="line">        <span class="keyword">return</span> index - (index &gt;= elements.<span class="built_in">count</span> ? elements.<span class="built_in">count</span> : <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"frontIndex: <span class="subst">\(frontIndex)</span>"</span> + <span class="string">",eles: <span class="subst">\(elements)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="11-äºŒå‰æ ‘"><a href="#11-äºŒå‰æ ‘" class="headerlink" title="11. äºŒå‰æ ‘"></a>11. äºŒå‰æ ‘</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryTree</span>&lt;<span class="title">T</span>: <span class="title">Comparable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> nodeCount = <span class="number">0</span> <span class="comment">// ç»“ç‚¹æ•°é‡</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> root: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? <span class="comment">// æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äºŒå‰æ ‘æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nodeCount == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        root = <span class="literal">nil</span></span><br><span class="line">        nodeCount = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‰åºéå†(ä¸€èˆ¬æ˜¯æ ¹å·¦å³)</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">preorderTraversal</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯å‰åºéå†çš„é€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        preorderTraversal(root)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯å‰åºéå†çš„éé€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> results = [<span class="type">T</span>]()</span><br><span class="line">        <span class="keyword">let</span> stack = <span class="type">Stack</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        <span class="keyword">var</span> p = root</span><br><span class="line">        <span class="keyword">while</span> p != <span class="literal">nil</span> || stack.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// å…ˆè®¿é—® æ ¹</span></span><br><span class="line">                results.append(p!.ele)</span><br><span class="line">                stack.push(p!)</span><br><span class="line">                <span class="comment">// å†è®¿é—® å·¦ (æŒç»­éå†å·¦å­æ ‘)</span></span><br><span class="line">                p = p?.<span class="keyword">left</span></span><br><span class="line">            &#125;</span><br><span class="line">            p = stack.pop()</span><br><span class="line">            <span class="comment">// æœ€åè®¿é—® å³</span></span><br><span class="line">            p = p?.<span class="keyword">right</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(results)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">preorderTraversal</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(node!.ele)</span><br><span class="line">        preorderTraversal(node!.<span class="keyword">left</span>)</span><br><span class="line">        preorderTraversal(node!.<span class="keyword">right</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸­åºéå†(ä¸€èˆ¬æ˜¯å·¦æ ¹å³)</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">inorderTraversal</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯ä¸­åºéå†çš„é€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        inorderTraversal(root)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯ä¸­åºéå†çš„éé€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> results = [<span class="type">T</span>]()</span><br><span class="line">        <span class="keyword">let</span> stack = <span class="type">Stack</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        <span class="keyword">var</span> p = root</span><br><span class="line">        <span class="keyword">while</span> p != <span class="literal">nil</span> || stack.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// æŒç»­è®¿é—®å·¦å­æ ‘</span></span><br><span class="line">                stack.push(p!)</span><br><span class="line">                p = p?.<span class="keyword">left</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼¹å‡ºæ ˆé¡¶å…ƒç´ </span></span><br><span class="line">            p = stack.pop()</span><br><span class="line">            <span class="comment">// å…ˆè®¿é—®å·¦å­æ ‘</span></span><br><span class="line">            results.append(p!.ele)</span><br><span class="line">            p = p?.<span class="keyword">right</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(results)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">inorderTraversal</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        inorderTraversal(node!.<span class="keyword">left</span>)</span><br><span class="line">        <span class="built_in">print</span>(node!.ele)</span><br><span class="line">        inorderTraversal(node!.<span class="keyword">right</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ååºéå†(ä¸€èˆ¬æ˜¯å·¦å³æ ¹)</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">postorderTraversal</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯ååºéå†çš„é€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        postorderTraversal(root)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯ååºéå†çš„éé€’å½’æ–¹å¼ç»“æœ---------"</span>)</span><br><span class="line">        <span class="keyword">var</span> results = [<span class="type">T</span>]()</span><br><span class="line">        <span class="keyword">let</span> stack = <span class="type">Stack</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        <span class="keyword">var</span> p = root</span><br><span class="line">        <span class="keyword">var</span> last: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">while</span> p != <span class="literal">nil</span> || stack.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// æŒç»­è®¿é—®å·¦å­æ ‘</span></span><br><span class="line">                stack.push(p!)</span><br><span class="line">                p = p?.<span class="keyword">left</span></span><br><span class="line">            &#125;</span><br><span class="line">            p = stack.top()</span><br><span class="line">            <span class="keyword">if</span> p?.<span class="keyword">right</span> == <span class="literal">nil</span> || p?.<span class="keyword">right</span> == last &#123;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰å³å­æ ‘æˆ–è€…è®¿é—®è¿‡å³å­æ ‘</span></span><br><span class="line">                results.append(p!.ele)</span><br><span class="line">                <span class="number">_</span> = stack.pop()</span><br><span class="line">                last = p</span><br><span class="line">                p = <span class="literal">nil</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                p = p?.<span class="keyword">right</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(results)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">postorderTraversal</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        postorderTraversal(node!.<span class="keyword">left</span>)</span><br><span class="line">        postorderTraversal(node!.<span class="keyword">right</span>)</span><br><span class="line">        <span class="built_in">print</span>(node!.ele)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å±‚åºéå†--ä½¿ç”¨é˜Ÿåˆ—å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">levelOrderTranversal</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> queue = <span class="type">Queue</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> results = [<span class="type">T</span>]()</span><br><span class="line">        queue.enQueue(root!)</span><br><span class="line">        <span class="keyword">while</span> queue.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> r = queue.deQueue()</span><br><span class="line">            results.append(r.ele)</span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">left</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">left</span>!)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">right</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">right</span>!)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"---------ä»¥ä¸‹æ˜¯å±‚åºéå†çš„ç»“æœ---------"</span>)</span><br><span class="line">        <span class="built_in">print</span>(results)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯ä¸€é¢—å®Œå…¨äºŒå‰æ ‘</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isComplete</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// æ ‘ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> isAllLeaf = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">let</span> queue = <span class="type">Queue</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        queue.enQueue(root!)</span><br><span class="line">        <span class="keyword">while</span> queue.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> r = queue.deQueue()</span><br><span class="line">            <span class="keyword">if</span> isAllLeaf &amp;&amp; !r.isLeaf() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">left</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">left</span>!)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> r.<span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; r.<span class="keyword">right</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// å·¦å­æ ‘ä¸ºç©ºè€Œå³å­æ ‘ä¸ä¸ºç©º, ä¸æ˜¯å®Œå…¨äºŒå‰æ ‘</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">right</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">right</span>!)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å·¦ä¸ä¸ºç©ºå³ä¸ºç©º  æˆ–è€… å·¦å³éƒ½ä¸ºç©º, è¦æ±‚ä¹‹åçš„å¿…é¡»éƒ½æ˜¯å¶å­ç»“ç‚¹</span></span><br><span class="line">                isAllLeaf = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å‰é©±ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">precursor</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? &#123;</span><br><span class="line">        <span class="comment">// 1. ç©ºç»“ç‚¹, å…¶å‰é©±ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å‰é©±ç»“ç‚¹åœ¨å·¦ç»“ç‚¹çš„å³å­æ ‘ä¸Š, æ¯”å¦‚æ‰¾6çš„å‰é©±</span></span><br><span class="line">        <span class="keyword">var</span> p = node!.<span class="keyword">left</span></span><br><span class="line">        <span class="keyword">if</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> p!.<span class="keyword">right</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                p = p!.<span class="keyword">right</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å‰é©±ç»“ç‚¹åœ¨çˆ¶èŠ‚ç‚¹\ç¥–çˆ¶ç»“ç‚¹ä¸Š, æ¯”å¦‚æ‰¾9çš„å‰é©±</span></span><br><span class="line">        p = node</span><br><span class="line">        <span class="keyword">while</span> p!.parent != <span class="literal">nil</span> &amp;&amp; p == p!.parent?.<span class="keyword">left</span> &#123;</span><br><span class="line">            p = p!.parent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p!.parent</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾åç»§ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">successor</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? &#123;</span><br><span class="line">        <span class="comment">// 1. ç©ºç»“ç‚¹, å…¶åç»§ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åç»§ç»“ç‚¹åœ¨å³ç»“ç‚¹çš„å·¦å­æ ‘ä¸Š, æ¯”å¦‚æ‰¾7çš„åç»§</span></span><br><span class="line">        <span class="keyword">var</span> p = node!.<span class="keyword">right</span></span><br><span class="line">        <span class="keyword">if</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> p!.<span class="keyword">left</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                p = p!.<span class="keyword">left</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åç»§ç»“ç‚¹åœ¨çˆ¶èŠ‚ç‚¹\ç¥–çˆ¶ç»“ç‚¹ä¸Š, æ¯”å¦‚æ‰¾5çš„åç»§</span></span><br><span class="line">        p = node</span><br><span class="line">        <span class="keyword">while</span> p!.parent != <span class="literal">nil</span> &amp;&amp; p == p!.parent?.<span class="keyword">right</span> &#123;</span><br><span class="line">            p = p!.parent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p!.parent</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‘çš„é«˜åº¦--è¿­ä»£å†™æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">height</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="comment">// å±‚åºéå†æ³•</span></span><br><span class="line">        <span class="keyword">let</span> queue = <span class="type">Queue</span>&lt;<span class="type">Node</span>&lt;<span class="type">T</span>&gt;&gt;()</span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> level = <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> height = <span class="number">0</span></span><br><span class="line">        queue.enQueue(root!)</span><br><span class="line">        <span class="keyword">while</span> queue.size() != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> r = queue.deQueue()</span><br><span class="line">            level -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">left</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">left</span>!)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> r.<span class="keyword">right</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                queue.enQueue(r.<span class="keyword">right</span>!)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> level == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="comment">// è¿™ä¸€å±‚éå†ç»“æŸ</span></span><br><span class="line">                level = queue.size()</span><br><span class="line">                height += <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> height</span><br><span class="line">        <span class="comment">//return height(root)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‘çš„é«˜åº¦--é€’å½’å†™æ³•</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">height</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;?)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">max</span>(height(node!.<span class="keyword">left</span>), height(node!.<span class="keyword">right</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»“ç‚¹ç±»</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">T</span>: <span class="title">Equatable</span>&gt;: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ele: <span class="type">T</span></span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">var</span> parent: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;?</span><br><span class="line">        <span class="keyword">init</span>(<span class="number">_</span> ele: <span class="type">T</span>, <span class="number">_</span> parent: <span class="type">Node</span>?) &#123;</span><br><span class="line">            <span class="keyword">self</span>.ele = ele</span><br><span class="line">            <span class="keyword">self</span>.parent = parent</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¶å­ç»“ç‚¹, å·¦å³ç»“ç‚¹å‡ä¸ºç©º</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">isLeaf</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; <span class="keyword">right</span> == <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æœ‰ä¸¤ä¸ªç»“ç‚¹</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">hasTwoChildren</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> != <span class="literal">nil</span> &amp;&amp; <span class="keyword">right</span> != <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ˜¯å·¦å­ç»“ç‚¹</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">isLeftChild</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="comment">// æ¯”è¾ƒæŒ‡é’ˆæ˜¯å¦ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">return</span> parent != <span class="literal">nil</span> &amp;&amp; parent?.<span class="keyword">left</span> === <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ˜¯å³å­ç»“ç‚¹</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">isRightChild</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="comment">// æ¯”è¾ƒæŒ‡é’ˆæ˜¯å¦ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">return</span> parent != <span class="literal">nil</span> &amp;&amp; parent?.<span class="keyword">right</span> === <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹ç­‰æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: Node&lt;T&gt;, rhs: Node&lt;T&gt;)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> lhs.ele == rhs.ele</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="12-äºŒå‰æœç´¢æ ‘"><a href="#12-äºŒå‰æœç´¢æ ‘" class="headerlink" title="12.äºŒå‰æœç´¢æ ‘"></a>12.äºŒå‰æœç´¢æ ‘</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span>&lt;<span class="title">T</span>: <span class="title">Comparable</span>&gt;: <span class="title">BinaryTree</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">findNode</span><span class="params">(<span class="number">_</span> ele: T)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? &#123;</span><br><span class="line">        <span class="keyword">var</span> p = root</span><br><span class="line">        <span class="keyword">while</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ele == p!.ele &#123;</span><br><span class="line">                <span class="comment">// å…ƒç´ ç›¸ç­‰, ç›´æ¥æ›¿æ¢</span></span><br><span class="line">                <span class="keyword">return</span> p</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ele &lt; p!.ele &#123;</span><br><span class="line">                <span class="comment">// ä½äºå·¦å­æ ‘</span></span><br><span class="line">                p = p!.<span class="keyword">left</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ä½äºå³å­æ ‘</span></span><br><span class="line">                p = p!.<span class="keyword">right</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ ç»“ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addNode</span><span class="params">(<span class="number">_</span> ele: T)</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ çš„æ˜¯æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">            root = <span class="type">Node</span>(ele, <span class="literal">nil</span>)</span><br><span class="line">            nodeCount += <span class="number">1</span></span><br><span class="line">            afterAdd(root!)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">            <span class="comment">// æ·»åŠ çš„ä¸æ˜¯æ ¹ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> p = root</span><br><span class="line">            <span class="keyword">var</span> parent = root</span><br><span class="line">            <span class="keyword">while</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">                parent = p</span><br><span class="line">                <span class="keyword">if</span> ele == p!.ele &#123;</span><br><span class="line">                    <span class="comment">// å…ƒç´ ç›¸ç­‰, ç›´æ¥æ›¿æ¢</span></span><br><span class="line">                    p?.ele = ele</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ele &lt; p!.ele &#123;</span><br><span class="line">                    <span class="comment">// ä½äºå·¦å­æ ‘</span></span><br><span class="line">                    p = p!.<span class="keyword">left</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ä½äºå³å­æ ‘</span></span><br><span class="line">                    p = p!.<span class="keyword">right</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¾—åˆ°parentç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">let</span> newNode = <span class="type">Node</span>(ele, parent)</span><br><span class="line">            <span class="keyword">if</span> ele &gt; parent!.ele &#123;</span><br><span class="line">                parent?.<span class="keyword">right</span> = newNode</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent?.<span class="keyword">left</span> = newNode</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ€»ç»“ç‚¹æ•°é‡åŠ 1</span></span><br><span class="line">            nodeCount += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            afterAdd(newNode)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤ç»“ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(<span class="number">_</span> ele: T)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> node: <span class="type">Node</span>&lt;<span class="type">T</span>&gt;? = findNode(ele)</span><br><span class="line">        <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»“ç‚¹æ•°é‡å‡1</span></span><br><span class="line">        nodeCount -= <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åº¦ä¸º2çš„ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> node!.hasTwoChildren() &#123;</span><br><span class="line">            <span class="comment">// æ‰¾å®ƒçš„åç»§ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">let</span> p = successor(node)</span><br><span class="line">            <span class="comment">// ç”¨åç»§ç»“ç‚¹å†…å®¹æ›¿æ¢å¾…åˆ é™¤ç»“ç‚¹å†…å®¹</span></span><br><span class="line">            node!.ele = p!.ele</span><br><span class="line">            <span class="comment">// éœ€è¦åˆ çš„ç»“ç‚¹å°±æ˜¯nodeç»“ç‚¹äº†</span></span><br><span class="line">            node = p</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// nodeæ˜¯å¶å­ç»“ç‚¹è€Œä¸”ä¹Ÿæ˜¯æ ¹ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> node?.parent == <span class="literal">nil</span> &#123;</span><br><span class="line">            root = <span class="literal">nil</span></span><br><span class="line">            afterRemove(node!)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éœ€è¦æ›¿æ¢çš„ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">let</span> replace = node?.<span class="keyword">left</span> == <span class="literal">nil</span> ? node?.<span class="keyword">right</span> : node?.<span class="keyword">left</span></span><br><span class="line">        <span class="keyword">if</span> replace == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// nodeæ²¡æœ‰å·¦å­æ ‘ä¹Ÿæ²¡æœ‰å³å­æ ‘, è¯´æ˜nodeæ˜¯å¶å­ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> node?.parent?.<span class="keyword">left</span> == node &#123;</span><br><span class="line">                <span class="comment">// nodeæ˜¯çˆ¶ç»“ç‚¹çš„å·¦ç»“ç‚¹</span></span><br><span class="line">                node?.parent?.<span class="keyword">left</span> = <span class="literal">nil</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// nodeæ˜¯çˆ¶ç»“ç‚¹çš„å³ç»“ç‚¹</span></span><br><span class="line">                node?.parent?.<span class="keyword">right</span> = <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            afterRemove(node!)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> node?.parent == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// æ˜¯æ ¹ç»“ç‚¹</span></span><br><span class="line">                root = replace</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> node?.parent?.<span class="keyword">left</span> == node &#123;</span><br><span class="line">                <span class="comment">// æ˜¯å·¦ç»“ç‚¹</span></span><br><span class="line">                node?.parent?.<span class="keyword">left</span> = replace</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ˜¯å³ç»“ç‚¹</span></span><br><span class="line">                node?.parent?.<span class="keyword">right</span> = replace</span><br><span class="line">            &#125;</span><br><span class="line">            afterRemove(node!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">afterAdd</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;)</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">afterRemove</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;)</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="13-AVLTree"><a href="#13-AVLTree" class="headerlink" title="13.AVLTree"></a>13.AVLTree</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AVLTree</span>&lt;<span class="title">T</span>: <span class="title">Comparable</span>&gt;: <span class="title">BinarySearchTree</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">afterAdd</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"å·²ç»æ·»åŠ <span class="subst">\(node)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">afterRemove</span><span class="params">(<span class="number">_</span> node: Node&lt;T&gt;)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"å·²ç»ç§»é™¤<span class="subst">\(node)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ¨æœ‰å†™å®Œã€‚ã€‚ã€‚ã€‚</p><h2 id="14-çº¢é»‘æ ‘"><a href="#14-çº¢é»‘æ ‘" class="headerlink" title="14.çº¢é»‘æ ‘"></a>14.çº¢é»‘æ ‘</h2><h2 id="15-äºŒå‰å †"><a href="#15-äºŒå‰å †" class="headerlink" title="15.äºŒå‰å †"></a>15.äºŒå‰å †</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Heap</span>  </span>&#123;</span><br><span class="line">    associatedtype <span class="type">T</span></span><br><span class="line">    <span class="keyword">var</span> size: <span class="type">Int</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">// æ·»åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> ele: T)</span></span></span><br><span class="line">    <span class="comment">// è·å–å †é¡¶å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span></span> -&gt; <span class="type">T</span></span><br><span class="line">    <span class="comment">// åˆ é™¤å †é¡¶å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">()</span></span> -&gt; <span class="type">T</span></span><br><span class="line">    <span class="comment">// åˆ é™¤å †é¡¶å…ƒç´ çš„åŒæ—¶æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">replace</span><span class="params">(<span class="number">_</span> ele: T)</span></span> -&gt; <span class="type">T</span>?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryHeap</span>&lt;<span class="title">T</span>: <span class="title">Comparable</span>&gt;: <span class="title">Heap</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨nilä½œä¸ºå ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> list: [<span class="type">T</span>?]</span><br><span class="line">    <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> size = <span class="number">0</span></span><br><span class="line">    <span class="comment">// é»˜è®¤10ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">DEFAULT_CAPACITY</span> = <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> capaticy: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> capaticy = capaticy &lt; <span class="type">DEFAULT_CAPACITY</span> ? <span class="type">DEFAULT_CAPACITY</span> : capaticy</span><br><span class="line">        list = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: capaticy)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">ensureCapacity</span><span class="params">(<span class="number">_</span> <span class="built_in">count</span>: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> &gt; list.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> oldList = <span class="keyword">self</span>.list</span><br><span class="line">            <span class="comment">// æ‰©å®¹1.5å€</span></span><br><span class="line">            <span class="keyword">let</span> newCapacity = oldList.<span class="built_in">count</span> + oldList.<span class="built_in">count</span> &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">self</span>.list = [<span class="type">T</span>?](repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: newCapacity)</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;size &#123;</span><br><span class="line">                <span class="keyword">self</span>.list[idx] = oldList[idx]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;size &#123;</span><br><span class="line">            list[idx] = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> ele: T)</span></span> &#123;</span><br><span class="line">        ensureCapacity(size + <span class="number">1</span>)</span><br><span class="line">        list[size] = ele</span><br><span class="line">        size += <span class="number">1</span></span><br><span class="line">        siftUp(size - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å †é¡¶å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.isEmpty() &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"å †ä¸ºç©º, æ— æ³•åˆ é™¤"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list[<span class="number">0</span>]!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ é™¤å †é¡¶å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.isEmpty() &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"å †ä¸ºç©º, æ— æ³•åˆ é™¤"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        size -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> first = list[<span class="number">0</span>]!</span><br><span class="line">        list[<span class="number">0</span>] = list[size]</span><br><span class="line">        list[size] = <span class="literal">nil</span></span><br><span class="line">        siftDown(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> first</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ é™¤å †é¡¶å…ƒç´ çš„åŒæ—¶æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">replace</span><span class="params">(<span class="number">_</span> ele: T)</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.isEmpty() &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"å †ä¸ºç©º, æ— æ³•åˆ é™¤"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> root: <span class="type">T</span>?</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            list[<span class="number">0</span>] = ele</span><br><span class="line">            size += <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            root = list[<span class="number">0</span>];</span><br><span class="line">            list[<span class="number">0</span>] = ele;</span><br><span class="line">            siftDown(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å»ºå †</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">heapify</span><span class="params">(<span class="number">_</span> eles: [T])</span></span> &#123;</span><br><span class="line">        size = eles.<span class="built_in">count</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="number">0</span>..&lt;eles.<span class="built_in">count</span> &#123;</span><br><span class="line">            list[idx] = eles[idx]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªä¸Šè€Œä¸‹çš„ä¸Šæ»¤O(nlogn)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         for idx in 0..&lt;size &#123;</span></span><br><span class="line"><span class="comment">         siftUp(idx)</span></span><br><span class="line"><span class="comment">         &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è‡ªä¸‹è€Œä¸Šçš„ä¸Šæ»¤O(n)</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> (<span class="number">0</span>...size &gt;&gt; <span class="number">1</span>).reversed() &#123;</span><br><span class="line">            siftDown(idx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// indexä½ç½®çš„å…ƒç´ ä¸‹æ»¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">siftDown</span><span class="params">(<span class="number">_</span> idx: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> ele = list[idx]!</span><br><span class="line">        <span class="keyword">var</span> idx = idx</span><br><span class="line">        <span class="keyword">while</span> idx &lt; size &gt;&gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// å·¦ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">var</span> childIdx = idx &lt;&lt; <span class="number">1</span> + <span class="number">1</span></span><br><span class="line">            <span class="keyword">var</span> child = list[childIdx]!</span><br><span class="line">            <span class="comment">// å³ç»“ç‚¹ç´¢å¼•</span></span><br><span class="line">            <span class="keyword">let</span> rightIdx = childIdx + <span class="number">1</span></span><br><span class="line">            <span class="comment">// å¦‚æœå³ç»“ç‚¹å­˜åœ¨, åˆ™å–å‡ºå·¦å³ç»“ç‚¹ä¸­è¾ƒå¤§çš„ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">if</span> rightIdx &lt; size &amp;&amp; list[rightIdx]! &gt; child &#123;</span><br><span class="line">                childIdx = rightIdx</span><br><span class="line">                child = list[childIdx]!</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœè‡ªå·±ä¸å°äºè¾ƒå¤§å­ç»“ç‚¹, åœæ­¢ä¸‹æ»¤</span></span><br><span class="line">            <span class="keyword">if</span> ele &gt;= child &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// äº¤æ¢è‡ªå·±ä¸è¾ƒå¤§å­ç»“ç‚¹çš„ä½ç½®</span></span><br><span class="line">            list[idx] = child</span><br><span class="line">            idx = childIdx</span><br><span class="line">        &#125;</span><br><span class="line">        list[idx] = ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// indexä½ç½®çš„å…ƒç´ ä¸Šæ»¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">siftUp</span><span class="params">(<span class="number">_</span> idx: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> idx = idx</span><br><span class="line">        <span class="keyword">let</span> ele = list[idx]!</span><br><span class="line">        <span class="keyword">while</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> parentIdx = (idx - <span class="number">1</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">let</span> parent = list[parentIdx]!</span><br><span class="line">            <span class="keyword">if</span> parent &gt;= ele &#123;</span><br><span class="line">                <span class="comment">// çˆ¶ç»“ç‚¹ä¸å°äºè‡ªå·±, åœæ­¢ä¸Šæ»¤</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// äº¤æ¢è‡ªå·±ä¸çˆ¶ç»“ç‚¹çš„ä½ç½®</span></span><br><span class="line">            list[idx] = parent</span><br><span class="line">            idx = parentIdx</span><br><span class="line">        &#125;</span><br><span class="line">        list[idx] = ele</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">desc</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(list)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸Šæ»¤</strong><br>1ã€å½“æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ æ—¶ï¼Œæ”¾åœ¨æœ€æœ«å°¾ã€‚<br>2ã€è‹¥æœ‰çˆ¶èŠ‚ç‚¹ï¼Œå°†æ’å…¥èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœæ’å…¥èŠ‚ç‚¹å¤§äºçˆ¶èŠ‚ç‚¹ï¼Œäº¤æ¢ä½ç½®ã€‚<br>3ã€é‡å¤2ï¼Œç›´è‡³æ’å…¥èŠ‚ç‚¹ä¸å°äºçˆ¶èŠ‚ç‚¹æˆ–è€…æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œä¸Šæ»¤ç»“æŸã€‚</p><p><strong>ä¸‹æ»¤</strong><br>1ã€åˆ é™¤é¦–å…ƒç´ ï¼Œå°†æœ€åä¸€ä¸ªå…ƒç´ ç§»åˆ°é¦–èŠ‚ç‚¹ã€‚<br>2ã€è‹¥æœ‰å­©å­ï¼Œåˆ™æ¯”è¾ƒè¯¥èŠ‚ç‚¹å’Œæœ€å¤§å­©å­çš„å€¼ï¼Œè‹¥å°äºæœ€å¤§å­©å­çš„å€¼ï¼Œä¸æœ€å¤§çš„å­©å­äº’æ¢ä½ç½®ã€‚<br>3ã€é‡å¤2ï¼Œç›´è‡³è¯¥èŠ‚ç‚¹çš„å€¼å¤§äºæœ€å¤§å­©å­çš„å€¼æˆ–è€…æ²¡æœ‰å­©å­ï¼Œä¸‹æ»¤ç»“æŸï¼Œå †åºæ€§å¾—ä»¥æ»¡è¶³ã€‚</p><h2 id="16-ä¼˜å…ˆçº§é˜Ÿåˆ—"><a href="#16-ä¼˜å…ˆçº§é˜Ÿåˆ—" class="headerlink" title="16.ä¼˜å…ˆçº§é˜Ÿåˆ—"></a>16.ä¼˜å…ˆçº§é˜Ÿåˆ—</h2><p>ä½¿ç”¨äºŒå‰å †å®ç°ã€‚</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">T</span>: <span class="title">Comparable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> heap: <span class="type">BinaryHeap</span> = <span class="type">BinaryHeap</span>&lt;<span class="type">T</span>&gt;(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">size</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> heap.size</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> heap.isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        heap.clear()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">enQueue</span><span class="params">(<span class="number">_</span> ele: T)</span></span> &#123;</span><br><span class="line">        heap.add(ele)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deQueue</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> heap.remove()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">front</span><span class="params">()</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> heap.<span class="keyword">get</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; ä½¿ç”¨Swiftå®ç°å¸¸è§çš„æ•°æ®ç»“æ„ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="ç®—æ³•" scheme="http://blog.chenyalun.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Key-Value Observingæºç åˆæ¢</title>
    <link href="http://blog.chenyalun.com/2019/05/31/Key-Value%20Observing%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/"/>
    <id>http://blog.chenyalun.com/2019/05/31/Key-Value Observingæºç åˆæ¢/</id>
    <published>2019-05-31T11:37:45.000Z</published>
    <updated>2019-09-17T03:33:08.930Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> KVOæºç é˜…è¯»ã€‚ </p><a id="more"></a><p>å°è¯•å»è¯»ä¸€éKVOçš„æºç ï¼Œå‘ç°å®ƒæ¯”KVCå¤æ‚çš„å¤šï¼Œåªèƒ½æ˜ç™½ä¸ªå¤§æ¦‚ã€‚<br>æ–‡ç« æœ€åæŒ‰ç…§è‡ªå·±çš„ç†è§£ï¼Œå†ç»“åˆæºç çš„å®ç°æµç¨‹è‡ªå·±å†™äº†ä¸€ä¸ªKVOï¼Œé”»ç‚¼é”»ç‚¼ã€‚</p><h1 id="ä¸€ã€å¸¸ç”¨æ¥å£"><a href="#ä¸€ã€å¸¸ç”¨æ¥å£" class="headerlink" title="ä¸€ã€å¸¸ç”¨æ¥å£"></a>ä¸€ã€å¸¸ç”¨æ¥å£</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// KVOçš„å›è°ƒ</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueObserving</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ åŠç§»é™¤è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueObserverRegistration</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h1 id="äºŒã€æŠ€å·§å›é¡¾"><a href="#äºŒã€æŠ€å·§å›é¡¾" class="headerlink" title="äºŒã€æŠ€å·§å›é¡¾"></a>äºŒã€æŠ€å·§å›é¡¾</h1><h2 id="1-å¦‚ä½•ä½¿å¾—å±æ€§åœ¨æœªæ”¹å˜çš„æƒ…å†µä¸‹ä¸å‘é€é€šçŸ¥-æ‰‹åŠ¨æ§åˆ¶"><a href="#1-å¦‚ä½•ä½¿å¾—å±æ€§åœ¨æœªæ”¹å˜çš„æƒ…å†µä¸‹ä¸å‘é€é€šçŸ¥-æ‰‹åŠ¨æ§åˆ¶" class="headerlink" title="1.å¦‚ä½•ä½¿å¾—å±æ€§åœ¨æœªæ”¹å˜çš„æƒ…å†µä¸‹ä¸å‘é€é€šçŸ¥(æ‰‹åŠ¨æ§åˆ¶)?"></a>1.å¦‚ä½•ä½¿å¾—å±æ€§åœ¨æœªæ”¹å˜çš„æƒ…å†µä¸‹ä¸å‘é€é€šçŸ¥(æ‰‹åŠ¨æ§åˆ¶)?</h2><p>ç¤ºä¾‹å¦‚ä¸‹ï¼Œä¸»è¦æœ‰:</p><ol><li>é‡å†™<code>automaticallyNotifiesObserversForKey:</code>æ–¹æ³•</li><li>é‡å†™<code>setter</code>æ–¹æ³•</li></ol><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAObject</span></span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">if</span> (name != _name) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">        _name = name;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="2-å¦‚ä½•æ³¨å†Œä¾èµ–é”®-å¤šä¸ªå±æ€§å½±å“åˆ°æŸä¸€ä¸ªå±æ€§"><a href="#2-å¦‚ä½•æ³¨å†Œä¾èµ–é”®-å¤šä¸ªå±æ€§å½±å“åˆ°æŸä¸€ä¸ªå±æ€§" class="headerlink" title="2.å¦‚ä½•æ³¨å†Œä¾èµ–é”®(å¤šä¸ªå±æ€§å½±å“åˆ°æŸä¸€ä¸ªå±æ€§)?"></a>2.å¦‚ä½•æ³¨å†Œä¾èµ–é”®(å¤šä¸ªå±æ€§å½±å“åˆ°æŸä¸€ä¸ªå±æ€§)?</h2><ol><li>é‡å†™<code>getter</code>æ–¹æ³•ï¼Œå®šä¹‰ä¾èµ–å…³ç³»</li><li>é‡å†™<code>keyPathsForValuesAffectingValueForKey:</code>æ–¹æ³•ï¼Œæ·»åŠ ä¾èµ–çš„keyé›†åˆ</li></ol><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *firstName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *lastName;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAObject</span></span></span><br><span class="line">- (<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰ä¾èµ–å…³ç³»</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"firstName is %@ and lastName is %@"</span>, <span class="keyword">self</span>.firstName, <span class="keyword">self</span>.lastName];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSSet</span> *keyPaths = [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) &#123;</span><br><span class="line">        keyPaths = [keyPaths setByAddingObjectsFromArray:@[<span class="string">@"firstName"</span>, <span class="string">@"lastName"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyPaths;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> // ä¹Ÿå¯ä»¥å‘½åä¸ºkeyPathsForValuesAffecting&lt;Key&gt;çš„ç±»æ–¹æ³•æ¥è¾¾åˆ°åŒæ ·çš„ç›®çš„</span></span><br><span class="line"><span class="comment"> + (NSSet&lt;NSString *&gt; *)keyPathsForValuesAffectingName &#123;</span></span><br><span class="line"><span class="comment">     return [NSSet setWithObjects:@"firstName", @"lastName", nil];</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="3-å½“NSMutableArrayä¸­å…ƒç´ å¢åŠ å’Œå‡å°‘æ—¶å¦‚ä½•ç›‘å¬åˆ°"><a href="#3-å½“NSMutableArrayä¸­å…ƒç´ å¢åŠ å’Œå‡å°‘æ—¶å¦‚ä½•ç›‘å¬åˆ°" class="headerlink" title="3.å½“NSMutableArrayä¸­å…ƒç´ å¢åŠ å’Œå‡å°‘æ—¶å¦‚ä½•ç›‘å¬åˆ°?"></a>3.å½“NSMutableArrayä¸­å…ƒç´ å¢åŠ å’Œå‡å°‘æ—¶å¦‚ä½•ç›‘å¬åˆ°?</h2><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAObject </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) NSMutableArray *nameList;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YAObject</span><br><span class="line"><span class="comment">// å®ç°é›†åˆä»£ç†å¯¹è±¡: ä¸€èˆ¬å»ºè®®-countOf&lt;Key&gt;å’Œ-objectIn&lt;Key&gt;AtIndex:</span></span><br><span class="line">- (NSUInteger)countOfNameList &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[_nameList count]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (id)<span class="selector-tag">objectInNameListAtIndex</span><span class="selector-pseudo">:(NSUInteger)index</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[_nameList objectAtIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡³å°‘å®ç°ä¸€ä¸ªæ’å…¥æ–¹æ³•å’Œä¸€ä¸ªåˆ é™¤æ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">insertObject</span><span class="selector-pseudo">:(id)object</span> <span class="selector-tag">inNameListAtIndex</span><span class="selector-pseudo">:(NSUInteger)index</span> &#123;</span><br><span class="line">    <span class="selector-attr">[_nameList insertObject:object atIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="attribute">removeObjectFromNameListAtIndex</span>:(NSUInteger)index &#123;</span><br><span class="line">    <span class="selector-attr">[_nameList removeObjectAtIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨:</p><ol><li>åŠ¡å¿…ä½¿ç”¨<code>mutableArrayValueForKey</code>è·å–é›†åˆ</li><li>ä½¿ç”¨<code>insertObject</code>æ–¹æ³•æ·»åŠ å…ƒç´ </li></ol><p>æ¯”å¦‚:</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSMutableArray *nameList = [self.obj <span class="string">mutableArrayValueForKey:</span>@<span class="string">"nameList"</span>];</span><br><span class="line">[nameList <span class="string">insertObject:</span>obj <span class="string">atIndex:</span><span class="number">0</span>];</span><br></pre></td></tr></table></figure><h1 id="ä¸‰ã€å‡ ä¸ªé—®é¢˜"><a href="#ä¸‰ã€å‡ ä¸ªé—®é¢˜" class="headerlink" title="ä¸‰ã€å‡ ä¸ªé—®é¢˜"></a>ä¸‰ã€å‡ ä¸ªé—®é¢˜</h1><p>æ€»ç»“çš„å‡ ä¸ªé—®é¢˜ã€‚</p><h2 id="1-KVOçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ"><a href="#1-KVOçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ" class="headerlink" title="1.KVOçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ?"></a>1.KVOçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ?</h2><blockquote><p>Objective-Cä¾æ‰˜äºå¼ºå¤§çš„runtimeæœºåˆ¶æ¥å®ç°KVOã€‚å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è§‚å¯ŸæŸä¸ªå¯¹è±¡çš„å±æ€§æ—¶ï¼Œruntimeä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»§æ‰¿è‡ªè¿™ä¸ªå¯¹è±¡çš„classçš„subclass(å‰ç¼€æ˜¯<code>NSKVONotifying_</code>)ã€‚åœ¨è¿™ä¸ªæ–°çš„subclassä¸­ï¼Œå®ƒä¼šé‡å†™æ‰€æœ‰è¢«è§‚å¯Ÿçš„keyçš„setterï¼Œç„¶åå°†objectçš„isaæŒ‡é’ˆæŒ‡å‘æ–°åˆ›å»ºçš„class(è¿™ä¸ªæŒ‡é’ˆå‘Šè¯‰Objective-Cè¿è¡Œæ—¶æŸä¸ªobjectåˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹çš„)ã€‚æ‰€ä»¥objectç¥å¥‡åœ°å˜æˆäº†æ–°çš„å­ç±»çš„å®ä¾‹ã€‚</p></blockquote><p>â€”â€”æ‘˜è‡ªå—å³°å­çš„åšå®¢ã€‚</p><p>æ–°ç±»é‡å†™äº†<code>setter</code>æ–¹æ³•ã€<code>class</code>æ–¹æ³•ã€<code>dealloc</code>æ–¹æ³•å’Œ<code>_isKVOA</code>æ–¹æ³•ã€‚å¦‚æœè‡ªå·±ç”Ÿæˆé‡åçš„NSKVONotifying_XXç±»ï¼Œä¼šé€ æˆKVOå¤±æ•ˆã€‚ä»¥ç›‘å¬YAPersonå¯¹è±¡çš„ageå±æ€§ä¸ºä¾‹ï¼Œä¸»è¦é€»è¾‘çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAPerson </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) NSUInteger age;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YAPerson</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">NSKVONotifying_YAPerson </span>: YAPerson</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> NSKVONotifying_YAPerson</span><br><span class="line">- (void)<span class="attribute">setAge</span>:(NSUInteger)age &#123;</span><br><span class="line">    <span class="selector-tag">_NSSetUnsignedLongLongValueAndNotify</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">_NSSetUnsignedLongLongValueAndNotify</span>() &#123;</span><br><span class="line">    <span class="selector-attr">[self willChangeValueForKey:@"age"]</span>;</span><br><span class="line">    <span class="selector-attr">[super setAge:age]</span>;</span><br><span class="line">    <span class="selector-attr">[self didChangeValueForKey:@"age"]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="attribute">didChangeValueForKey</span>:(NSString *)key &#123;</span><br><span class="line">    <span class="selector-attr">[observer observeValueForKeyPath:@"age" ofObject:self change:change context:context]</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><h2 id="2-KVOæºç ä¸­æ·»åŠ è§‚å¯Ÿè€…æ—¶æ•´ä½“çš„å¤§è‡´æµç¨‹æ˜¯ä»€ä¹ˆ"><a href="#2-KVOæºç ä¸­æ·»åŠ è§‚å¯Ÿè€…æ—¶æ•´ä½“çš„å¤§è‡´æµç¨‹æ˜¯ä»€ä¹ˆ" class="headerlink" title="2.KVOæºç ä¸­æ·»åŠ è§‚å¯Ÿè€…æ—¶æ•´ä½“çš„å¤§è‡´æµç¨‹æ˜¯ä»€ä¹ˆ?"></a>2.KVOæºç ä¸­æ·»åŠ è§‚å¯Ÿè€…æ—¶æ•´ä½“çš„å¤§è‡´æµç¨‹æ˜¯ä»€ä¹ˆ?</h2><ol><li>å°†<code>keyPath</code>ã€<code>class</code>ç­‰ä¿¡æ¯å°è£…æˆ<code>NSKeyValueProperty</code>ï¼Œåˆ†åˆ«è§£æä¸€èˆ¬å±æ€§(<code>@&quot;aa&quot;</code>)ã€å¯è®¡ç®—å±æ€§(<code>@&quot;@aa&quot;</code>)ã€å±æ€§é“¾(<code>@&quot;aa.bb.@cc.dd&quot;</code>)ï¼Œè¿›è¡Œå­ç±»åŒ–ï¼Œç¼“å­˜åœ¨<code>CFMutableSet</code>ä¸­æ–¹ä¾¿ä¸‹æ¬¡å¿«é€Ÿå–å‡ºã€‚</li><li>å°†<code>NSKeyValueProperty</code>ã€<code>context</code>ã€<code>options</code>ã€<code>observer</code>ç­‰ä¿¡æ¯å°è£…æˆ<code>NSKeyValueObservance</code>ï¼Œç¼“å­˜åœ¨<code>NSHashTable</code>ä¸­ã€‚</li><li>å€˜è‹¥è®¾ç½®äº†<code>NSKeyValueObservingOptionInitial</code>é€‰é¡¹ï¼Œä¼šåœ¨æ³¨å†Œè§‚å¯ŸæœåŠ¡æ—¶è°ƒç”¨ä¸€æ¬¡è§¦å‘æ–¹æ³•ã€‚</li><li>åŠ¨æ€åˆ›å»ºåä¸º<code>NSKVONotifying_+åŸæ¥ç±»å</code>çš„æ–°ç±»ï¼Œé‡å†™å…¶<code>dealloc</code>ã€<code>_isKVOA</code>æ–¹æ³•ï¼Œå†é‡å†™<code>class</code>æ–¹æ³•ï¼Œåˆ©ç”¨<code>object_setClass()</code>å‡½æ•°å°†å…¶isaæŒ‡é’ˆæŒ‡å‘åŸå…ˆçš„ç±»ã€‚</li><li>é‡å†™<code>willChangeValueForKey:</code>å’Œ<code>didChangeValueForKey:</code>æ–¹æ³•ï¼Œé‡å†™è¢«è§‚å¯Ÿå±æ€§çš„<code>setter</code>æ–¹æ³•ï¼Œåœ¨<code>setter</code>ä¸­å…ˆè°ƒç”¨<code>willChangeValueForKey:</code>æ–¹æ³•ï¼Œç„¶åè°ƒç”¨çˆ¶ç±»çš„ <code>setter</code> æ–¹æ³•å¯¹æˆå‘˜å˜é‡èµ‹å€¼ï¼Œä¹‹åå†è°ƒç”¨ <code>didChangeValueForKey:</code> æ–¹æ³•ã€‚</li><li><code>didChangeValueForKey:</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>observeValueForKeyPath:ofObject:change:context:</code>æ–¹æ³•ã€‚</li></ol><h2 id="3-KVOä¸­æ‰€å°è£…ç»„ä»¶çš„å…³ç³»æ˜¯æ€æ ·çš„"><a href="#3-KVOä¸­æ‰€å°è£…ç»„ä»¶çš„å…³ç³»æ˜¯æ€æ ·çš„" class="headerlink" title="3.KVOä¸­æ‰€å°è£…ç»„ä»¶çš„å…³ç³»æ˜¯æ€æ ·çš„?"></a>3.KVOä¸­æ‰€å°è£…ç»„ä»¶çš„å…³ç³»æ˜¯æ€æ ·çš„?</h2><ol><li>å°†<code>keyPathã€class</code>ç­‰ä¿¡æ¯å°è£…æˆ<code>NSKeyValueProperty</code>ï¼Œä½¿ç”¨<code>CFMutableSet</code>ç¼“å­˜<code>NSKeyValueProperty</code>ã€‚</li><li>å°†<code>observerã€propertyã€optionsã€context ã€originalObservable</code>ç­‰ä¿¡æ¯å°è£…æˆ<code>NSKeyValueObservance</code>ï¼Œ<code>ä½¿ç”¨NSHashTable(NSKeyValueShareableObservationInfos)</code>ç¼“å­˜ã€‚</li><li><code>NSKeyValueObservationInfo</code>ä¸<code>NSKeyValueObservance</code>çš„å…³ç³»æ˜¯: <code>NSKeyValueObservationInfo</code>ä¸­æœ‰ä¸€ä¸ª<code>observances</code>æ•°ç»„ï¼Œæ•°ç»„é‡Œé¢æ˜¯<code>NSKeyValueObservance</code>å¯¹è±¡ã€‚</li><li>æ¯ä¸€ä¸ª<code>object</code>éƒ½æœ‰ä¸€ä¸ª<code>observationInfo</code>å±æ€§(<code>void *</code>ç±»å‹)ï¼Œå®ƒä¸<code>NSKeyValueObservationInfo</code>ä¼šç›¸äº’è½¬åŒ–ã€‚</li></ol><p><code>class</code>å’Œ<code>keyPath</code>å†³å®šäº†æ˜¯å¦æ˜¯åŒä¸€ä¸ª<code>NSKeyValueProperty</code>ã€‚<br><code>NSKeyValueProperty</code>ã€<code>Observer</code>ã€<code>options</code>ã€<code>context</code> å†³å®šäº†æ˜¯å¦æ˜¯åŒä¸€ä¸ª<code>NSKeyValueObservance</code>ã€‚</p><h2 id="4-KVOå¤šæ¬¡ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°è¿›è¡ŒaddObserveræ“ä½œï¼Œä¹Ÿä¼šå¾—åˆ°ç›¸åº”æ¬¡æ•°çš„å›è°ƒï¼Œå¦‚ä½•åšåˆ°"><a href="#4-KVOå¤šæ¬¡ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°è¿›è¡ŒaddObserveræ“ä½œï¼Œä¹Ÿä¼šå¾—åˆ°ç›¸åº”æ¬¡æ•°çš„å›è°ƒï¼Œå¦‚ä½•åšåˆ°" class="headerlink" title="4.KVOå¤šæ¬¡ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°è¿›è¡ŒaddObserveræ“ä½œï¼Œä¹Ÿä¼šå¾—åˆ°ç›¸åº”æ¬¡æ•°çš„å›è°ƒï¼Œå¦‚ä½•åšåˆ°?"></a>4.KVOå¤šæ¬¡ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°è¿›è¡ŒaddObserveræ“ä½œï¼Œä¹Ÿä¼šå¾—åˆ°ç›¸åº”æ¬¡æ•°çš„å›è°ƒï¼Œå¦‚ä½•åšåˆ°?</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢ä»£ç ï¼Œä¼šæœ‰å››æ¬¡å›è°ƒã€‚</p><p>åœ¨æ¯æ¬¡æ·»åŠ è§‚å¯Ÿè€…æ—¶ï¼Œéƒ½ä¼šè·å–<code>NSKeyValueObservance</code>å¯¹è±¡(å¯èƒ½ä»ç¼“å­˜ä¸­è·å–ä¹Ÿå¯èƒ½æ–°å»º)ï¼Œå¹¶æŠŠå®ƒè¿½åŠ åˆ°objectçš„<code>observances</code>æ•°ç»„ä¸­(å³ä½¿è¯¥æ•°ç»„ä¸­å·²ç»å­˜åœ¨å®Œå…¨ç›¸åŒï¼ˆæŒ‡é’ˆä¸€è‡´ï¼‰çš„<code>NSKeyValueObservance</code>å¯¹è±¡)ï¼Œç”±æ­¤ä¿è¯äº†å¤šæ¬¡<code>addObserver</code>æ“ä½œä¼šæœ‰å¤šæ¬¡å›è°ƒã€‚</p><p>é€šè¿‡æ‰“å°å¯ä»¥è¯æ˜ï¼š</p><p><img src="https://image.chenyalun.com/2019/05/30/001.png" style="zoom:50%"></p><h2 id="5-å¦‚ä½•æ‰‹åŠ¨è§¦å‘KVO"><a href="#5-å¦‚ä½•æ‰‹åŠ¨è§¦å‘KVO" class="headerlink" title="5.å¦‚ä½•æ‰‹åŠ¨è§¦å‘KVO?"></a>5.å¦‚ä½•æ‰‹åŠ¨è§¦å‘KVO?</h2><p>æ‰‹åŠ¨è°ƒç”¨<code>willChangeValueForKey:</code>å’Œ<code>didChangeValueForKey:</code>ã€‚ä¹Ÿå³ï¼š<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)invokeKVOForAge &#123;</span><br><span class="line">    [<span class="meta">self.person willChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br><span class="line">    [<span class="meta">self.person didChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åªæ‰‹åŠ¨è°ƒç”¨ä¸€ä¸ªè¿˜ä¸è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿç”±åŸç†å¯çŸ¥ï¼Œ<code>didChangeValueForKey:</code>ä¸­æ‰çœŸæ­£è°ƒç”¨äº†<code>observeValueForKeyPath:ofObject:change:context</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>didChangeValueForKey:</code>æ¯‹åº¸ç½®ç–‘ä¸å¯æˆ–ç¼ºã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦<code>willChangeValueForKey:</code>å‘¢ï¼Ÿ<br>æŸ¥çœ‹æ–‡æ¡£ï¼Œè‹¹æœä¸€å¦‚æ—¢å¾€åœ°å†·é…·ï¼š</p><blockquote><p>Calls to this method are always paired with a matching call to willChangeValueForKey:.</p></blockquote><p>æ„æ€æ˜¯ï¼Œè¿™ä¿©æ˜¯æˆå¯¹å­˜åœ¨çš„ï¼Œä½ åªç®¡è°ƒå°±æ˜¯äº†ã€‚å¥½å§ï¼Œè¿™å—æºç ç¡®å®æ²¡çœ‹æ˜ç™½ï¼Œå…ˆæŒ–ä¸ªå‘å§ã€‚</p><h2 id="6-é€šè¿‡KVCä¿®æ”¹å±æ€§ä¼šè§¦å‘KVOå—"><a href="#6-é€šè¿‡KVCä¿®æ”¹å±æ€§ä¼šè§¦å‘KVOå—" class="headerlink" title="6.é€šè¿‡KVCä¿®æ”¹å±æ€§ä¼šè§¦å‘KVOå—?"></a>6.é€šè¿‡KVCä¿®æ”¹å±æ€§ä¼šè§¦å‘KVOå—?</h2><p>å½“KVCæ˜¯é€šè¿‡setteræ–¹æ³•è®¾å€¼æ—¶ï¼Œæ— éœ€å¤šè¨€ï¼Œä¼šè§¦å‘KVOã€‚å½“KVCæ˜¯é€šè¿‡æˆå‘˜å˜é‡è®¾å€¼æ—¶ï¼Œä¹Ÿä¼šè§¦å‘KVOï¼Œä¸ºä»€ä¹ˆï¼Ÿ<br>é˜…è¯»æºç å¯çŸ¥ï¼Œç›´æ¥é€šè¿‡æˆå‘˜å˜é‡è®¾å€¼ï¼Œä¼šåˆ›å»ºNSKeyValueIvarSetterå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>_NSSetValueAndNotifyForKeyInIvar()</code>å‡½æ•°ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSSetValueAndNotifyForKeyInIvar(<span class="keyword">id</span> object, SEL selector, <span class="keyword">id</span> value, <span class="built_in">NSString</span> *key, Ivar ivar, IMP imp) &#123;</span><br><span class="line">    [object willChangeValueForKey:key];</span><br><span class="line">    </span><br><span class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="built_in">NSString</span> *, Ivar))imp)(object,<span class="literal">NULL</span>,value,key,ivar);</span><br><span class="line">    </span><br><span class="line">    [object didChangeValueForKey:key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>çœŸç›¸å¤§ç™½äº†ï¼Œå®ƒè°ƒç”¨äº†<code>willChangeValueForKey:</code>å’Œ<code>didChangeValueForKey:</code>æ–¹æ³•ï¼Œæ­£æ˜¯è¿™ä¸ªè§¦å‘äº†KVOã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>ç›´æ¥ä¿®æ”¹æˆå‘˜å˜é‡æ˜¯ä¸ä¼šè§¦å‘KVOçš„</strong>ã€‚</p><h1 id="å››ã€æ·»åŠ è§‚å¯Ÿè€…"><a href="#å››ã€æ·»åŠ è§‚å¯Ÿè€…" class="headerlink" title="å››ã€æ·»åŠ è§‚å¯Ÿè€…"></a>å››ã€æ·»åŠ è§‚å¯Ÿè€…</h1><p>è¿™ä¸€æ­¥éª¤ä¸­å°è£…å‡ºäº†è®¸å¤šçš„ç±»ï¼ŒåŒæ—¶ä¹ŸæŠŠäº§ç”Ÿçš„è®¸å¤šå¯¹è±¡åšäº†è¿›ä¸€æ­¥çš„ç¼“å­˜å¤„ç†ã€‚</p><h2 id="1-å°è£…"><a href="#1-å°è£…" class="headerlink" title="1.å°è£…"></a>1.å°è£…</h2><h3 id="1-1æ¥å£æ–¹æ³•"><a href="#1-1æ¥å£æ–¹æ³•" class="headerlink" title="1.1æ¥å£æ–¹æ³•"></a>1.1æ¥å£æ–¹æ³•</h3><p>åŠ é”ï¼Œæ¥å£æ–¹æ³•ä¸­ä½¿ç”¨<code>pthread</code>ä¸­çš„<code>pthread_mutex_lock()</code>å’Œ<code>pthread_mutex_unlock</code>å‡½æ•°ã€‚</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™æ˜¯ä¸ªæ¥å£æ–¹æ³•, æ·»åŠ è§‚å¯Ÿè€…åˆ†ä¸ºä¸¤ä¸ªæµç¨‹: 1ï¼Œæ ¹æ®classå’ŒkeyPathè·å–NSKeyValuePropertyå¯¹è±¡ã€‚2ï¼Œæ·»åŠ å¯¹propertyçš„è§‚å¯Ÿã€‚</span></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">d_addObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">context:</span>(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    pthread_mutex_lock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹pthread</span></span><br><span class="line">    _NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    <span class="comment">// æ ¹æ®classå’ŒkeyPathè·å–NSKeyValueProperty</span></span><br><span class="line">    NSKeyValueProperty *property = NSKeyValuePropertyForIsaAndKeyPath(object_getClass(self),keyPath);</span><br><span class="line">    <span class="comment">// æ·»åŠ å¯¹propertyçš„è§‚å¯Ÿ</span></span><br><span class="line">    [self <span class="string">_d_addObserver:</span>observer <span class="string">forProperty:</span>property <span class="string">options:</span>options <span class="string">context:</span>context];</span><br><span class="line">    <span class="comment">// è§£é”</span></span><br><span class="line">    pthread_mutex_unlock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-æ·»åŠ å¯¹NSKeyValuePropertyçš„è§‚å¯Ÿçš„å…·ä½“å®ç°"><a href="#1-2-æ·»åŠ å¯¹NSKeyValuePropertyçš„è§‚å¯Ÿçš„å…·ä½“å®ç°" class="headerlink" title="1.2.æ·»åŠ å¯¹NSKeyValuePropertyçš„è§‚å¯Ÿçš„å…·ä½“å®ç°"></a>1.2.æ·»åŠ å¯¹NSKeyValuePropertyçš„è§‚å¯Ÿçš„å…·ä½“å®ç°</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ è§‚å¯Ÿè€…è¿‡ç¨‹ä¸­, ä¸æ˜¯å•çº¯åœ°'è§‚å¯Ÿ'keyPath, è€Œæ˜¯è§‚å¯Ÿå¯¹keyPathå°è£…çš„NSKeyValueProperty</span></span><br><span class="line">- (<span class="keyword">void</span>)_addObserver:(<span class="keyword">id</span>)observer forProperty:(<span class="built_in">NSKeyValueProperty</span> *)property options:(<span class="keyword">int</span>)options context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span>(options &amp; <span class="built_in">NSKeyValueObservingOptionInitial</span>) &#123;</span><br><span class="line">        <span class="comment">// NSKeyValueObservingOptionInitial: è§‚å¯Ÿæœ€åˆçš„å€¼ï¼ˆåœ¨æ³¨å†Œè§‚å¯ŸæœåŠ¡æ—¶ä¼šè°ƒç”¨ä¸€æ¬¡è§¦å‘æ–¹æ³•ï¼‰</span></span><br><span class="line">        <span class="built_in">NSString</span> *keyPath = [property keyPath];</span><br><span class="line">        _NSKeyValueObserverRegistrationLockOwner = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        pthread_mutex_unlock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">            <span class="comment">// newValueå°±æ˜¯å½“å‰çš„å€¼</span></span><br><span class="line">            newValue = [<span class="keyword">self</span> valueForKeyPath:keyPath];</span><br><span class="line">            <span class="keyword">if</span> (!newValue) &#123;</span><br><span class="line">                newValue = [<span class="built_in">NSNull</span> null]; <span class="comment">// ä½¿ç”¨NSNullå¯¹è±¡</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSKeyValueChangeDictionary</span> *changeDictionary = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// åˆ›å»ºNSKeyValueChangeDetailsç»“æ„ä½“</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         typedef struct &#123;</span></span><br><span class="line"><span class="comment">             NSKeyValueChange kind;</span></span><br><span class="line"><span class="comment">             id oldValue;</span></span><br><span class="line"><span class="comment">             id newValue;</span></span><br><span class="line"><span class="comment">             NSIndexSet *indexes;</span></span><br><span class="line"><span class="comment">             id extraData;</span></span><br><span class="line"><span class="comment">         &#125; NSKeyValueChangeDetails;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">NSKeyValueChangeDetails</span> changeDetails = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        changeDetails.kind = <span class="built_in">NSKeyValueChangeSetting</span>;</span><br><span class="line">        changeDetails.oldValue = <span class="literal">nil</span>;</span><br><span class="line">        changeDetails.newValue = newValue;</span><br><span class="line">        changeDetails.indexes = <span class="literal">nil</span>;</span><br><span class="line">        changeDetails.extraData = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// å‡½æ•°1: é€šçŸ¥è§‚å¯Ÿè€…, ä¼ é€’ç»“æ„ä½“changeDetails</span></span><br><span class="line">        <span class="built_in">NSKeyValueNotifyObserver</span>(observer,keyPath, <span class="keyword">self</span>, context, <span class="literal">nil</span>, <span class="literal">NO</span>,changeDetails, &amp;changeDictionary);</span><br><span class="line">        </span><br><span class="line">        [changeDictionary release];</span><br><span class="line">        <span class="comment">// åŠ é”</span></span><br><span class="line">        pthread_mutex_lock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">        <span class="comment">// è·å–å½“å‰pthread</span></span><br><span class="line">        _NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡½æ•°2: è·å–oldObservationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *oldObservationInfo = _NSKeyValueRetainedObservationInfoForObject(<span class="keyword">self</span>,property.containerClass);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> cacheHit = <span class="literal">NO</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *addedObservance = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">id</span> originalObservable = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((options &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x01</span>) &#123;</span><br><span class="line">        <span class="comment">// _CFGetTSD: è·å–çº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// Get some thread specific data from a pre-assigned slot.</span></span><br><span class="line">        <span class="built_in">NSKeyValueObservingTSD</span> *TSD = _CFGetTSD(<span class="built_in">NSKeyValueObservingTSDKey</span>);</span><br><span class="line">        <span class="keyword">if</span> (TSD) &#123;</span><br><span class="line">            originalObservable = TSD-&gt;implicitObservanceAdditionInfo.originalObservable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‡½æ•°3: è·å–newObservationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *newObservationInfo = _NSKeyValueObservationInfoCreateByAdding(oldObservationInfo, observer, property, options, context, originalObservable,&amp;cacheHit,&amp;addedObservance);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡½æ•°4: å°†selfçš„observationInfoè®¾ç½®ä¸ºnewObservationInfo</span></span><br><span class="line">    _NSKeyValueReplaceObservationInfoForObject(<span class="keyword">self</span>,property.containerClass,oldObservationInfo,newObservationInfo);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// - (void)object:(id)object didAddObservance:(NSKeyValueObservance *)observance recurse:(BOOL)recurse &#123;&#125;</span></span><br><span class="line">    <span class="comment">// å®é™…ä¸Šè¿™ä¸ªæ–¹æ³•å•¥äº‹ä¹Ÿæ²¡åš</span></span><br><span class="line">    [property object:<span class="keyword">self</span> didAddObservance:addedObservance recurse:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒæ–¹æ³•: è·å–propertyä¸­å·²ç»ä¿®æ”¹è¿‡çš„class</span></span><br><span class="line">    Class isaForAutonotifying = [property isaForAutonotifying];</span><br><span class="line">    <span class="keyword">if</span>(isaForAutonotifying) &#123;</span><br><span class="line">        Class cls = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">if</span>(cls != isaForAutonotifying) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ object_setClass()ä¿®æ”¹isaæŒ‡é’ˆ, è®¾ç½®è‡ªå·±çš„classä¸ºpropertyçš„isaForAutonotifying</span></span><br><span class="line">            object_setClass(<span class="keyword">self</span>,isaForAutonotifying);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [newObservationInfo release];</span><br><span class="line">    [oldObservationInfo release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°1-è®¾ç½®changeDictionaryå¹¶è°ƒç”¨NSKVONotify-å‡½æ•°"><a href="#å‡½æ•°1-è®¾ç½®changeDictionaryå¹¶è°ƒç”¨NSKVONotify-å‡½æ•°" class="headerlink" title="å‡½æ•°1: è®¾ç½®changeDictionaryå¹¶è°ƒç”¨NSKVONotify()å‡½æ•°"></a>å‡½æ•°1: è®¾ç½®changeDictionaryå¹¶è°ƒç”¨NSKVONotify()å‡½æ•°</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="built_in">NSKeyValueNotifyObserver</span>(<span class="keyword">id</span> observer,<span class="built_in">NSString</span> * keyPath, <span class="keyword">id</span> object, <span class="keyword">void</span> *context, <span class="keyword">id</span> originalObservable, <span class="built_in">BOOL</span> isPriorNotification, <span class="built_in">NSKeyValueChangeDetails</span> changeDetails, <span class="built_in">NSKeyValueChangeDictionary</span> **changeDictionary) &#123;</span><br><span class="line">    <span class="keyword">if</span>(*changeDictionary) &#123;</span><br><span class="line">        [*changeDictionary setDetailsNoCopy:changeDetails originalObservable:originalObservable];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *changeDictionary =  [[<span class="built_in">NSKeyValueChangeDictionary</span> alloc] initWithDetailsNoCopy:changeDetails originalObservable:originalObservable isPriorNotification:isPriorNotification];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSUInteger</span> retainCountBefore = [*changeDictionary retainCount];</span><br><span class="line">    <span class="built_in">NSKVONotify</span>(observer, keyPath, object, *changeDictionary, context);</span><br><span class="line">    <span class="keyword">if</span>(retainCountBefore != (<span class="built_in">NSUInteger</span>)INTMAX_MAX &amp;&amp; retainCountBefore != [*changeDictionary retainCount]) &#123;</span><br><span class="line">        [*changeDictionary retainObjects];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKVONotify()å‡½æ•°å°±æ˜¯è°ƒç”¨observeValueForKeyPathæ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">NSKVONotify</span>(<span class="keyword">id</span> observer, <span class="built_in">NSString</span> *keyPath, <span class="keyword">id</span> object, <span class="built_in">NSDictionary</span> *changeDictionary, <span class="keyword">void</span> *context) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservingAssertRegistrationLockNotHeld</span>();</span><br><span class="line">    [observer observeValueForKeyPath:keyPath ofObject:object change:changeDictionary context:context];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°2-è·å–objectçš„observationInfoå¯¹è±¡"><a href="#å‡½æ•°2-è·å–objectçš„observationInfoå¯¹è±¡" class="headerlink" title="å‡½æ•°2: è·å–objectçš„observationInfoå¯¹è±¡"></a>å‡½æ•°2: è·å–objectçš„observationInfoå¯¹è±¡</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueRetainedObservationInfoForObject(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueContainerClass</span> *containerClass) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *observationInfo = <span class="literal">nil</span>;</span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    <span class="keyword">if</span> (containerClass) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨containerClassçš„cachedObservationInfoImplementationå®ç°</span></span><br><span class="line">        observationInfo = ((<span class="built_in">NSKeyValueObservationInfo</span> * (*)(<span class="keyword">id</span>,SEL))containerClass.cachedObservationInfoImplementation)(object, <span class="keyword">@selector</span>(observationInfo));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥è·å–objectçš„d_observationInfoå¯¹è±¡</span></span><br><span class="line">        observationInfo = (<span class="built_in">NSKeyValueObservationInfo</span> *)[object d_observationInfo];</span><br><span class="line">    &#125;</span><br><span class="line">    [observationInfo <span class="keyword">retain</span>];</span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    <span class="keyword">return</span>  observationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°3-è·å–â€™æ·»åŠ è§‚å¯Ÿè€…â€™æ—¶æ‰€éœ€è¦çš„NSKeyValueObservationInfo"><a href="#å‡½æ•°3-è·å–â€™æ·»åŠ è§‚å¯Ÿè€…â€™æ—¶æ‰€éœ€è¦çš„NSKeyValueObservationInfo" class="headerlink" title="å‡½æ•°3: è·å–â€™æ·»åŠ è§‚å¯Ÿè€…â€™æ—¶æ‰€éœ€è¦çš„NSKeyValueObservationInfo"></a>å‡½æ•°3: è·å–â€™æ·»åŠ è§‚å¯Ÿè€…â€™æ—¶æ‰€éœ€è¦çš„NSKeyValueObservationInfo</h4><p>å¦‚æœ<code>baseObservationInfo</code>å­˜åœ¨ï¼Œåˆ™ä¸€é¡¿å°è£…æ“ä½œåï¼Œä¼šæŠŠå°è£…å®Œæ¯•çš„<code>NSKeyValueObservance</code>â€œè¿½åŠ â€åˆ°<code>baseObservationInfo</code>çš„<code>observances</code>æ•°ç»„ä¸­ã€‚å¦‚æœ<code>baseObservationInfo</code>ä¸å­˜åœ¨ï¼Œåˆ™ä¸€é¡¿å°è£…æ“ä½œåï¼Œä¼šæŠŠå°è£…å®Œæ¯•çš„<code>NSKeyValueObservance</code>æ”¾åˆ°æ–°åˆ›å»ºçš„<code>NSKeyValueObservationInfo</code>å¯¹è±¡çš„<code>observances</code>æ•°ç»„ä¸­ã€‚æœ€åï¼Œ<code>cacheHit</code>å‘Šè¯‰è°ƒç”¨è€…æ˜¯å¦æœ‰å‘½ä¸­ç¼“å­˜ï¼Œ<code>*addedObservance</code>æŒ‡å‘äº†<code>observance</code>å¯¹è±¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueObservationInfoCreateByAdding(<span class="built_in">NSKeyValueObservationInfo</span> *baseObservationInfo, <span class="keyword">id</span> observer, <span class="built_in">NSKeyValueProperty</span> *property, <span class="keyword">int</span> options, <span class="keyword">void</span> *context, <span class="keyword">id</span> originalObservable,  <span class="built_in">BOOL</span> *cacheHit, <span class="built_in">NSKeyValueObservance</span> **addedObservance) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *createdObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨å¼±å¼•ç”¨è¡¨NSKeyValueShareableObservationInfosç¼“å­˜è§‚å¯Ÿè€…å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰NSPointerFunctions</span></span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">        <span class="comment">// è®¾ç½®hashå‡½æ•°</span></span><br><span class="line">        [pointerFunctions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">        <span class="comment">// è®¾ç½®åˆ¤ç­‰å‡½æ•°</span></span><br><span class="line">        [pointerFunctions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">        <span class="comment">// åˆ›å»ºNSHashTable</span></span><br><span class="line">        <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span>) &#123;</span><br><span class="line">        <span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span> = [<span class="built_in">NSKeyValueShareableObservationInfoKey</span> <span class="keyword">class</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™ä¸ªå…¬å…±keyåˆ°ç¼“å­˜è¡¨NSKeyValueShareableObservationInfosä¸­æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservationInfoKey</span> * shareableObservationInfoKey;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!shareableObservationInfoKey) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡ä½¿ç”¨, ä¸ºç©ºæ—¶åˆ›å»º</span></span><br><span class="line">        shareableObservationInfoKey = [[<span class="built_in">NSKeyValueShareableObservationInfoKey</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®keyçš„ä¿¡æ¯</span></span><br><span class="line">    shareableObservationInfoKey.addingNotRemoving = <span class="literal">YES</span>;</span><br><span class="line">    shareableObservationInfoKey.baseObservationInfo = baseObservationInfo;</span><br><span class="line">    shareableObservationInfoKey.additionObserver = observer;</span><br><span class="line">    shareableObservationInfoKey.additionProperty = property;</span><br><span class="line">    shareableObservationInfoKey.additionOptions = options;</span><br><span class="line">    shareableObservationInfoKey.additionContext = context;</span><br><span class="line">    shareableObservationInfoKey.additionOriginalObservable = originalObservable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®shareableObservationInfoKeyçš„å·²æœ‰ä¿¡æ¯è¿›è¡ŒæŸ¥æ‰¾</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> * existsObservationInfo = [<span class="built_in">NSKeyValueShareableObservationInfos</span> member:shareableObservationInfoKey];</span><br><span class="line">    <span class="comment">// æ¸…ç©ºshareableObservationInfoKeyçš„åºŸå¼ƒä¿¡æ¯(ä¸»è¦æ˜¯å‡å°‘å¯¹observerçš„å¼•ç”¨è®¡æ•°)</span></span><br><span class="line">    shareableObservationInfoKey.additionOriginalObservable = <span class="literal">nil</span>;</span><br><span class="line">    shareableObservationInfoKey.additionObserver = <span class="literal">nil</span>;</span><br><span class="line">    shareableObservationInfoKey.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!existsObservationInfo) &#123; <span class="comment">// ç¼“å­˜ä¸­ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="comment">// (ä¸€èˆ¬æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶)NSHashTableä¸ºç©º, åˆ›å»º</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservances</span>) &#123;</span><br><span class="line">            <span class="built_in">NSKeyValueShareableObservances</span> = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€šè¿‡è¿™ä¸ªå…¬å…±keyåˆ°ç¼“å­˜è¡¨NSKeyValueShareableObservancesä¸­æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservanceKey</span> *shareableObservanceKey;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!shareableObservanceKey) &#123; <span class="comment">// keyä¸å­˜åœ¨æ—¶åˆ›å»º</span></span><br><span class="line">            shareableObservanceKey = [[<span class="built_in">NSKeyValueShareableObservanceKey</span> alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®keyçš„ä¿¡æ¯</span></span><br><span class="line">        shareableObservanceKey.observer = observer;</span><br><span class="line">        shareableObservanceKey.property = property;</span><br><span class="line">        shareableObservanceKey.options = options;</span><br><span class="line">        shareableObservanceKey.context = context;</span><br><span class="line">        shareableObservanceKey.originalObservable = originalObservable;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾Observanceç¼“å­˜</span></span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *existsObservance = [<span class="built_in">NSKeyValueShareableObservances</span> member:shareableObservanceKey];</span><br><span class="line">        <span class="comment">// æ¸…ç©ºshareableObservanceKeyçš„åºŸå¼ƒä¿¡æ¯</span></span><br><span class="line">        shareableObservanceKey.originalObservable = <span class="literal">nil</span>;</span><br><span class="line">        shareableObservanceKey.observer = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *observance = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!existsObservance) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰æ‰¾åˆ°, åˆ™åˆ›å»ºobservance</span></span><br><span class="line">            observance = [[<span class="built_in">NSKeyValueObservance</span> alloc] _initWithObserver:observer property:property options:options context:context originalObservable:originalObservable];</span><br><span class="line">            <span class="keyword">if</span>(observance.cachedIsShareable) &#123;</span><br><span class="line">                <span class="comment">// å¯ä»¥ç¼“å­˜, æ”¾å…¥NSKeyValueShareableObservancesä¸­</span></span><br><span class="line">                [<span class="built_in">NSKeyValueShareableObservances</span> addObject:observance];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰¾åˆ°äº†, observanceå°±æŒ‡å‘existsObservance</span></span><br><span class="line">            observance = existsObservance;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (baseObservationInfo) &#123;</span><br><span class="line">            <span class="comment">// å¤åˆ¶baseObservationInfoå¹¶è¿½åŠ observance</span></span><br><span class="line">            createdObservationInfo = [baseObservationInfo _copyByAddingObservance:observance];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæ–°çš„ObservationInfo</span></span><br><span class="line">            createdObservationInfo = [[<span class="built_in">NSKeyValueObservationInfo</span> alloc] _initWithObservances:&amp;observance count:<span class="number">1</span> hashValue:<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (createdObservationInfo.cachedIsShareable)&#123;</span><br><span class="line">            <span class="comment">// å…è®¸ç¼“å­˜, æ·»åŠ åˆ°NSKeyValueShareableObservationInfosä¸­</span></span><br><span class="line">            [<span class="built_in">NSKeyValueShareableObservationInfos</span> addObject:createdObservationInfo];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">        *cacheHit = <span class="literal">NO</span>;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ–°æ·»åŠ çš„Observance</span></span><br><span class="line">        *addedObservance = observance;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­å­˜åœ¨</span></span><br><span class="line">        <span class="comment">// è®¾ç½®å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">        *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// observanceå¿…å®šå°±æ˜¯å·²å­˜åœ¨çš„info.observanceåˆ—è¡¨æœ€åä¸€ä¸ª, å› ä¸ºåˆ¤æ–­equalå°±æ˜¯æŒ‰ç…§è¿™ä¸ªåŸåˆ™å»åˆ¤æ–­çš„</span></span><br><span class="line">        <span class="comment">// åˆ¤ç­‰å‡½æ•°: NSKeyValueShareableObservationInfoNSHTIsEqual()</span></span><br><span class="line">        *addedObservance = existsObservationInfo.observances.lastObject;</span><br><span class="line">        <span class="comment">// è®¾ç½®createdObservationInfo</span></span><br><span class="line">        createdObservationInfo = existsObservationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è§£é”</span></span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">    <span class="keyword">return</span> createdObservationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°4-å°†objectçš„observationInfoè®¾ç½®ä¸ºnewObservationInfo"><a href="#å‡½æ•°4-å°†objectçš„observationInfoè®¾ç½®ä¸ºnewObservationInfo" class="headerlink" title="å‡½æ•°4:å°†objectçš„observationInfoè®¾ç½®ä¸ºnewObservationInfo"></a>å‡½æ•°4:å°†objectçš„observationInfoè®¾ç½®ä¸ºnewObservationInfo</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSKeyValueReplaceObservationInfoForObject(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueContainerClass</span> * containerClass, <span class="built_in">NSKeyValueObservationInfo</span> *oldObservationInfo, <span class="built_in">NSKeyValueObservationInfo</span> *newObservationInfo) &#123;</span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newObservationInfo) [newObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ç†è§£??????</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     typedef struct &#123;</span></span><br><span class="line"><span class="comment">         CFMutableArrayRef pendingArray;//0</span></span><br><span class="line"><span class="comment">         ObservationInfoWatcher *firstWatcher;//4</span></span><br><span class="line"><span class="comment">         ImplicitObservanceAdditionInfo  implicitObservanceAdditionInfo;</span></span><br><span class="line"><span class="comment">         ImplicitObservanceRemovalInfo implicitObservanceRemovalInfo;</span></span><br><span class="line"><span class="comment">     &#125; NSKeyValueObservingTSD;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingTSD</span> *TSD = _CFGetTSD(<span class="built_in">NSKeyValueObservingTSDKey</span>);</span><br><span class="line">    <span class="keyword">if</span>(TSD) &#123;</span><br><span class="line">        ObservationInfoWatcher *next = TSD-&gt;firstWatcher;</span><br><span class="line">        <span class="keyword">while</span>(next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (next-&gt;object == object) &#123;</span><br><span class="line">                [next-&gt;observationInfo release];</span><br><span class="line">                next-&gt;observationInfo = [newObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            next = next-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(containerClass) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨objectçš„d_setObservationInfo:æ–¹æ³•, å¹¶ä¼ å‚æ•°newObservationInfo</span></span><br><span class="line">        containerClass.cacheNSetObservationInfoImplementation(object, <span class="keyword">@selector</span>(d_setObservationInfo:), newObservationInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥è®¾ç½®æ–°å€¼</span></span><br><span class="line">        [object d_setObservationInfo: newObservationInfo];</span><br><span class="line">    &#125;</span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-ç¼“å­˜"><a href="#2-ç¼“å­˜" class="headerlink" title="2.ç¼“å­˜"></a>2.ç¼“å­˜</h2><p>ç¼“å­˜æŸ¥æ‰¾é€»è¾‘æ˜¯ä¸€è‡´çš„: ç¡®å®šè¿™äº›å¯¹è±¡çš„<code>hash</code>å’Œ<code>isEqual:</code>æ–¹æ³•ï¼Œé€šè¿‡åˆ›å»ºä¸ç›®æ ‡å¯¹è±¡åˆ¤ç­‰å±æ€§ä¸€è‡´çš„keyå»æŸ¥æ‰¾ã€‚</p><h3 id="2-1-NSKeyValuePropertyçš„ç¼“å­˜"><a href="#2-1-NSKeyValuePropertyçš„ç¼“å­˜" class="headerlink" title="2.1.NSKeyValuePropertyçš„ç¼“å­˜"></a>2.1.NSKeyValuePropertyçš„ç¼“å­˜</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueProperties</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé›†åˆNSKeyValueProperties</span></span><br><span class="line">    <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    callbacks.version =  kCFTypeSetCallBacks.version;</span><br><span class="line">    callbacks.retain =  kCFTypeSetCallBacks.retain;</span><br><span class="line">    callbacks.release =  kCFTypeSetCallBacks.release;</span><br><span class="line">    callbacks.copyDescription =  kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">    <span class="comment">// è®¾ç½®CFSeté›†åˆä¸­å…ƒç´ åˆ¤ç­‰çš„ä¾æ®</span></span><br><span class="line">    callbacks.equal =  (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValuePropertyIsEqual</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®CFSeté›†åˆä¸­å…ƒç´ çš„hashå€¼è·å–å‡½æ•°</span></span><br><span class="line">    callbacks.hash =  (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValuePropertyHash</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueProperties</span> =  <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;callbacks);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŠŠpropertyæ·»åŠ åˆ°NSKeyValuePropertiesé›†åˆä¸­</span></span><br><span class="line"><span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueProperties</span>, property);</span><br></pre></td></tr></table></figure><p>CFSeté›†åˆä¸­å…ƒç´ åˆ¤ç­‰çš„ä¾æ®</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> <span class="built_in">NSKeyValuePropertyIsEqual</span>(<span class="built_in">NSKeyValueProperty</span> *property1, <span class="built_in">NSKeyValueProperty</span> *property2) &#123;</span><br><span class="line">    <span class="keyword">return</span> (property1.containerClass == property2.containerClass) &amp;&amp;</span><br><span class="line">    (property1.keyPath == property2.keyPath || [property1.keyPath isEqual: property2.keyPath]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›NSKeyValuePropertyçš„hashå€¼</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">NSUInteger NSKeyValuePropertyHash(NSKeyValueProperty *<span class="keyword">property</span><span class="title"></span>) &#123;</span><br><span class="line">    return <span class="keyword">property</span>.<span class="title"></span>keyPath.hash ^ (NSUInteger)(void *)<span class="keyword">property</span>.<span class="title"></span>containerClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡è¯æ˜äº† <code>class</code>å’Œ<code>keyPath</code>å†³å®šäº†æ˜¯å¦æ˜¯åŒä¸€ä¸ª<code>NSKeyValueProperty</code>ã€‚</p><h3 id="2-2-NSKeyValueObservanceçš„ç¼“å­˜"><a href="#2-2-NSKeyValueObservanceçš„ç¼“å­˜" class="headerlink" title="2.2.NSKeyValueObservanceçš„ç¼“å­˜"></a>2.2.NSKeyValueObservanceçš„ç¼“å­˜</h3><p>ç¼“å­˜æŸ¥æ‰¾</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSHashTable</span> *<span class="built_in">NSKeyValueShareableObservances</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservances</span>) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueShareableObservances</span> = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// observanceæŸ¥æ‰¾key</span></span><br><span class="line"><span class="keyword">static</span> DNSKeyValueShareableObservanceKey *shareableObservanceKey;</span><br><span class="line"><span class="keyword">if</span>(!shareableObservanceKey) &#123;</span><br><span class="line">    shareableObservanceKey = [[DNSKeyValueShareableObservanceKey alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">shareableObservanceKey.observer = observer;</span><br><span class="line">shareableObservanceKey.property = property;</span><br><span class="line">shareableObservanceKey.options = options;</span><br><span class="line">shareableObservanceKey.context = context;</span><br><span class="line">shareableObservanceKey.originalObservable = originalObservable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾ç¼“å­˜</span></span><br><span class="line"><span class="built_in">NSKeyValueObservance</span> *existsObservance = [<span class="built_in">NSKeyValueShareableObservances</span> member:shareableObservanceKey];</span><br><span class="line">shareableObservanceKey.originalObservable = <span class="literal">nil</span>;</span><br><span class="line">shareableObservanceKey.observer = <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure><p>é‡å†™<code>NSKeyValueObservance</code>çš„<code>hash</code>å’Œ<code>isEqual:</code>æ–¹æ³•</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="keyword">return</span> _NSKVOPointersHash(<span class="number">5</span>, _observer, _property, (<span class="keyword">void</span> *)(<span class="built_in">NSUInteger</span>)(_options), _context, _originalObservable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isKindOfClass: <span class="keyword">self</span>.class])  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *other = (<span class="built_in">NSKeyValueObservance</span> *)object;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> other.observer == <span class="keyword">self</span>.observer &amp;&amp;</span><br><span class="line">    other.options == <span class="keyword">self</span>.options &amp;&amp;</span><br><span class="line">    other.context == <span class="keyword">self</span>.context &amp;&amp;</span><br><span class="line">    other.originalObservable == <span class="keyword">self</span>.originalObservable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-NSKeyValueObservationInfoçš„ç¼“å­˜"><a href="#2-3-NSKeyValueObservationInfoçš„ç¼“å­˜" class="headerlink" title="2.3.NSKeyValueObservationInfoçš„ç¼“å­˜"></a>2.3.NSKeyValueObservationInfoçš„ç¼“å­˜</h3><p>ç¼“å­˜æŸ¥æ‰¾</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSHashTable</span> *<span class="built_in">NSKeyValueShareableObservationInfos</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// observationInfoç¼“å­˜</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">    <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">    [pointerFunctions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">    [pointerFunctions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">    <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-NSKeyValueObservationInfoçš„å­˜å‚¨-observationInfo"><a href="#2-4-NSKeyValueObservationInfoçš„å­˜å‚¨-observationInfo" class="headerlink" title="2.4.NSKeyValueObservationInfoçš„å­˜å‚¨(observationInfo)"></a>2.4.NSKeyValueObservationInfoçš„å­˜å‚¨(observationInfo)</h3><p>å½“å°è£…æˆ<code>NSKeyValueObservationInfo</code>æ—¶ï¼Œ<code>weak</code>çš„<code>NSHashTable</code>å¹¶ä¸è´Ÿè´£å­˜å‚¨ï¼Œé‚£ä¹ˆï¼Œè°è´Ÿè´£çœŸæ­£çš„å­˜å‚¨å‘¢?</p><p>Take or return a pointer that identifies information about all of the observers that are registered with the receiver, the options that were used at registration-time, etc. The default implementation of these methoNS store observation info in a global dictionary keyed by the receiversâ€™ pointers. For improved performance, you can override these methoNS to store the opaque data pointer in an instance variable. Overrides of these methoNS must not attempt to send Objective-C messages to the passed-in observation info, including -retain and -release.</p><blockquote><p>è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯ä»¥å¯¹è±¡çš„æŒ‡é’ˆä½œä¸ºkeyï¼Œä»ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­è·å–ä¿¡æ¯ã€‚</p></blockquote><p>å¦‚ä½•è·å–å¯¹è±¡çš„æŒ‡é’ˆï¼Ÿè¿™é‡Œæœ‰ä¸ªå®šä¹‰ï¼š<br><code>OBSERVATION_INFO_KEY</code>çš„å®šä¹‰æ˜¯: <code>#define OBSERVATION_INFO_KEY(object) ((void *)(~(NSUInteger)(object)))</code></p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CFMutableDictionaryRef</span> <span class="built_in">NSKeyValueObservationInfoPerObject</span> = <span class="literal">NULL</span>;</span><br><span class="line">- (<span class="keyword">void</span> *)observationInfo &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NSKeyValueObservationInfoPerObject</span> ? (<span class="keyword">void</span> *)<span class="built_in">CFDictionaryGetValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>)) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObservationInfo:(<span class="keyword">void</span> *)info &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueObservationInfoPerObject</span>) &#123;</span><br><span class="line">        <span class="built_in">NSKeyValueObservationInfoPerObject</span> = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (info) &#123;</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>), info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryRemoveValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å³è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯ä»¥å¯¹è±¡çš„æŒ‡é’ˆä½œä¸ºkeyï¼Œä»ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­è·å–ä¿¡æ¯ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼ŒKVOçš„ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨å¯¹è±¡æœ¬èº«ã€‚<br>ä¸è¿‡ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™observationInfoå±æ€§çš„setå’Œgetæ–¹æ³•ï¼Œä»¥å°†è¿™ä¸ªä¸é€æ˜çš„æ•°æ®æŒ‡é’ˆå­˜å‚¨åˆ°ä¸€ä¸ªå®ä¾‹å˜é‡ä¸­ã€‚ä½†æ˜¯ï¼Œåœ¨é‡å†™æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å°è¯•å»å‘è¿™äº›æ•°æ®å‘é€ä¸€ä¸ªObjective-Cæ¶ˆæ¯ï¼ŒåŒ…æ‹¬retainå’Œreleaseã€‚</p></blockquote><h2 id="3-æ–°å»ºä¸é‡å†™"><a href="#3-æ–°å»ºä¸é‡å†™" class="headerlink" title="3.æ–°å»ºä¸é‡å†™"></a>3.æ–°å»ºä¸é‡å†™</h2><p>åœ¨è¿™ä¸€æ­¥éª¤ä¸­ï¼ŒåŠ¨æ€åˆ›å»ºäº†åŸæ¥classçš„å­ç±»ï¼Œå½“ç„¶ï¼Œä¹Ÿé‡å†™å’Œæ·»åŠ äº†è®¸å¤šæ–¹æ³•ã€‚</p><h3 id="3-1åŠ¨æ€åˆ›å»ºå­ç±»çš„æ ¸å¿ƒå®ç°"><a href="#3-1åŠ¨æ€åˆ›å»ºå­ç±»çš„æ ¸å¿ƒå®ç°" class="headerlink" title="3.1åŠ¨æ€åˆ›å»ºå­ç±»çš„æ ¸å¿ƒå®ç°"></a>3.1åŠ¨æ€åˆ›å»ºå­ç±»çš„æ ¸å¿ƒå®ç°</h3><p>åŠ¨æ€åˆ›å»ºå­ç±»ä¸­ï¼Œé‡å†™äº†<code>deallocã€classã€_isKVOA</code>æ–¹æ³•ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueNotifyingInfo</span> *_NSKVONotifyingCreateInfoWithOriginalClass(Class originalClass) &#123;</span><br><span class="line">    <span class="keyword">static</span> IMP <span class="built_in">NSObjectWillChange</span>;</span><br><span class="line">    <span class="keyword">static</span> IMP <span class="built_in">NSObjectDidChange</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ æ–°çš„å­ç±»å</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalClassName = class_getName(originalClass);</span><br><span class="line">    size_t size = strlen(originalClassName) + <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">char</span> *newClassName = (<span class="keyword">char</span> *)malloc(size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// #define NOTIFY_CLASSNAME_PREFIX "NSKVONotifying_"</span></span><br><span class="line">    strlcpy(newClassName, NOTIFY_CLASSNAME_PREFIX, size);</span><br><span class="line">    strlcat(newClassName, originalClassName, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºå­ç±»</span></span><br><span class="line">    Class newSubClass = objc_allocateClassPair(originalClass, newClassName, <span class="keyword">sizeof</span>(<span class="built_in">NSKeyValueNotifyingInfo</span>));</span><br><span class="line">    objc_registerClassPair(newSubClass);</span><br><span class="line">    </span><br><span class="line">    free(newClassName);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ivars = object_getIndexedIvars(newSubClass);</span><br><span class="line">    <span class="comment">// åˆ›å»ºNSKeyValueNotifyingInfoå¯¹è±¡, å°è£…å­ç±»\åŸå§‹ç±»ç­‰ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">NSKeyValueNotifyingInfo</span> *notifyingInfo = (<span class="built_in">NSKeyValueNotifyingInfo</span> *)ivars;</span><br><span class="line">    notifyingInfo-&gt;originalClass = originalClass;</span><br><span class="line">    notifyingInfo-&gt;newSubClass = newSubClass;</span><br><span class="line">    notifyingInfo-&gt;notifyingKeys = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;kCFCopyStringSetCallBacks);</span><br><span class="line">    notifyingInfo-&gt;selKeyMap = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">    </span><br><span class="line">    pthread_mutexattr_t mutexattr;</span><br><span class="line">    pthread_mutexattr_init(&amp;mutexattr);</span><br><span class="line">    pthread_mutexattr_settype(&amp;mutexattr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">    pthread_mutex_init(&amp;notifyingInfo-&gt;mutex, &amp;mutexattr);</span><br><span class="line">    pthread_mutexattr_destroy(&amp;mutexattr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–NSObjectç±»çš„ willChangeValueForKey å’Œ didChangeValueForKeyå®ç°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> <span class="built_in">NSObjectIMPLookupOnce</span>;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;<span class="built_in">NSObjectIMPLookupOnce</span>, ^&#123;</span><br><span class="line">        <span class="built_in">NSObjectWillChange</span> = class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(d_willChangeValueForKey:));</span><br><span class="line">        <span class="built_in">NSObjectDidChange</span> = class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(d_didChangeValueForKey:));</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­originalClassç±»æ˜¯å¦é‡å†™äº† willChangeValueForKey æˆ–  didChangeValueForKey</span></span><br><span class="line">    <span class="comment">// å°±æ˜¯æ‹¿NSObjectçš„å®ç°ä¸originalClassçš„å®ç°åšå¯¹æ¯”(å‡½æ•°æŒ‡é’ˆIMPæ¯”è¾ƒ)</span></span><br><span class="line">    notifyingInfo-&gt;overrideWillOrDidChange = class_getMethodImplementation(notifyingInfo-&gt;originalClass, <span class="keyword">@selector</span>(d_willChangeValueForKey:)) != <span class="built_in">NSObjectWillChange</span> || class_getMethodImplementation(notifyingInfo-&gt;originalClass, <span class="keyword">@selector</span>(d_didChangeValueForKey:)) != <span class="built_in">NSObjectDidChange</span>;</span><br><span class="line">    <span class="comment">// å¯¹notifyingInfoçš„originalClassæ·»åŠ  _isKVOAæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, ISKVOA_SELECTOR, (IMP)<span class="built_in">NSKVOIsAutonotifying</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// å¯¹notifyingInfoçš„originalClassæ·»åŠ  deallocæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, <span class="keyword">@selector</span>(dealloc), (IMP)<span class="built_in">NSKVODeallocate</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// å¯¹notifyingInfoçš„originalClassæ·»åŠ  classæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, <span class="keyword">@selector</span>(<span class="keyword">class</span>), (IMP)<span class="built_in">NSKVOClass</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> notifyingInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ -isKVOAæ–¹æ³•"><a href="#æ·»åŠ -isKVOAæ–¹æ³•" class="headerlink" title="æ·»åŠ _isKVOAæ–¹æ³•"></a>æ·»åŠ _isKVOAæ–¹æ³•</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> <span class="built_in">NSKVOIsAutonotifying</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é‡å†™classæ–¹æ³•"><a href="#é‡å†™classæ–¹æ³•" class="headerlink" title="é‡å†™classæ–¹æ³•"></a>é‡å†™classæ–¹æ³•</h4><figure class="highlight monkey"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">NSKVOClass</span>(<span class="title">id</span> <span class="title">object</span>, <span class="title">SEL</span> <span class="title">selector</span>) &#123;</span></span><br><span class="line">    // æ–°çš„<span class="class"><span class="keyword">class</span>: <span class="title">NSKVONotifying_XXXX</span></span></span><br><span class="line">    <span class="class"><span class="keyword">Class</span> <span class="title">currentClass</span> = <span class="title">object_getClass</span>(<span class="title">object</span>);</span></span><br><span class="line">    // åŸå…ˆçš„<span class="class"><span class="keyword">class</span>: <span class="title">XXXX</span></span></span><br><span class="line">    <span class="class"><span class="keyword">Class</span> <span class="title">originalClass</span> =  <span class="title">_NSKVONotifyingOriginalClassForIsa</span>(<span class="title">currentClass</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (currentClass == originalClass) &#123;</span><br><span class="line">        // ç›¸åŒ, è¿”å›objectçš„currentClass</span><br><span class="line">        <span class="function"><span class="keyword">Method</span> <span class="title">m</span> =</span> class_getInstanceMethod(currentClass, selector);</span><br><span class="line">        <span class="keyword">return</span> ((<span class="class"><span class="keyword">Class</span> (*)(<span class="title">id</span>,<span class="title">Method</span>))<span class="title">method_invoke</span>)(<span class="title">object</span>, <span class="title">m</span>);</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        // ä¸åŒ, è¿”å›originalClass</span><br><span class="line">        <span class="keyword">return</span> [originalClass <span class="class"><span class="keyword">class</span>];</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é‡å†™deallocæ–¹æ³•"><a href="#é‡å†™deallocæ–¹æ³•" class="headerlink" title="é‡å†™deallocæ–¹æ³•"></a>é‡å†™deallocæ–¹æ³•</h4><p>è·å–<code>object</code>å¯¹åº”çš„<code>observationInfo</code>(å¯¹è±¡)å¹¶æŠŠå®ƒæ”¾åˆ°ç»“æ„ä½“ä¸­ï¼Œåœ¨è°ƒç”¨å®Œ<code>object</code>åŸå…ˆçš„<code>dealloc</code>æ–¹æ³•ä¹‹ååˆ¤æ–­<code>observationInfo</code>æ˜¯å¦è¿˜å­˜åœ¨ï¼Œè‹¥å­˜åœ¨è¯´æ˜<code>observer</code>æ²¡æœ‰åœ¨<code>dealloc</code>ä¹‹å‰è¢«ç§»é™¤æ‰ï¼Œè¿›è€ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="built_in">NSKVODeallocate</span>(<span class="keyword">id</span> object, SEL selector) &#123;</span><br><span class="line">    <span class="comment">// è·å–objectå¯¹åº”çš„observationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *observationInfo = _NSKeyValueRetainedObservationInfoForObject(object, <span class="literal">nil</span>);</span><br><span class="line">    ObservationInfoWatcher watcher = &#123;object, observationInfo, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    _NSKeyValueAddObservationInfoWatcher(&amp;watcher);</span><br><span class="line">    <span class="comment">// è·å–notifyInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueNotifyingInfo</span> *notifyInfo = (<span class="built_in">NSKeyValueNotifyingInfo</span> *)object_getIndexedIvars(object_getClass(object));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨objectåŸæ¥çš„deallocå®ç°</span></span><br><span class="line">    Method originDellocMethod = class_getInstanceMethod(notifyInfo-&gt;originalClass, selector);</span><br><span class="line">    ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>,Method))method_invoke)(object, originDellocMethod);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(watcher.observationInfo) &#123;</span><br><span class="line">            <span class="comment">// observationInfoä¸å­˜åœ¨æ‰å¯¹, å¦‚æœè¿˜å­˜åœ¨, è¯´æ˜æ²¡æœ‰æ­£ç¡®åœ°ç§»é™¤observer</span></span><br><span class="line">            <span class="built_in">BOOL</span> keyExistsAndHasValidFormat = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">BOOL</span> cleansUpBeforeThrowing = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            cleansUpBeforeThrowing = (<span class="built_in">BOOL</span>)<span class="built_in">CFPreferencesGetAppBooleanValue</span>(<span class="built_in">CFSTR</span>(<span class="string">"NSKVODeallocateCleansUpBeforeThrowing"</span>), kCFPreferencesCurrentApplication, (Boolean *)&amp;keyExistsAndHasValidFormat);</span><br><span class="line">            <span class="comment">// keyå­˜åœ¨ä¸”keyå¯¹åº”çš„valueä¸ºYES</span></span><br><span class="line">            cleansUpBeforeThrowing = cleansUpBeforeThrowing &amp;&amp; keyExistsAndHasValidFormat;</span><br><span class="line">            <span class="comment">// dyld_get_program_sdk_versionè¿”å›ç³»ç»Ÿç‰ˆæœ¬</span></span><br><span class="line">            <span class="keyword">if</span> (dyld_get_program_sdk_version() &gt; <span class="number">0x7FFFF</span> || cleansUpBeforeThrowing) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cleansUpBeforeThrowing) &#123;</span><br><span class="line">                    _NSKeyValueRemoveObservationInfoForObject(object, watcher.observationInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                [<span class="built_in">NSException</span> raise:<span class="built_in">NSInternalInconsistencyException</span> format:<span class="string">@"An instance %p of class %@ was deallocated while key value observers were still registered with it. Current observation info: %@"</span>, object, notifyInfo-&gt;originalClass, watcher.observationInfo];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSKVODeallocateBreak</span>(object);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">        [exception raise];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@finally</span> &#123;</span><br><span class="line">        <span class="comment">// ç§»é™¤watcher</span></span><br><span class="line">        _NSKeyValueRemoveObservationInfoWatcher(&amp;watcher);</span><br><span class="line">        </span><br><span class="line">        [watcher.observationInfo release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-å›è°ƒé€šçŸ¥"><a href="#4-å›è°ƒé€šçŸ¥" class="headerlink" title="4.å›è°ƒé€šçŸ¥"></a>4.å›è°ƒé€šçŸ¥</h2><p>ä¸Šæ–‡åˆ†æï¼Œ<code>NSKeyValueNotifyObserver()</code>å°±æ˜¯å›è°ƒçš„å‡½æ•°ï¼Œé€šè¿‡å®ƒè°ƒç”¨<code>observeValueForKeyPath:ofObject:change:context:</code>æ–¹æ³•ã€‚è¿™é‡Œè¿˜å‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜ï¼Œå›è°ƒæ˜¯æ€ä¹ˆå¤„ç†çš„?</p><p>åœ¨<code>NSKVONotifyingEnableForInfoAndKey()</code>å‡½æ•°ä¸­é‡å†™setteræ–¹æ³•ï¼Œä¹‹ååœ¨<code>NSSetPrimitiveValueAndNotify()</code>å‡½æ•°ä¸­å…ˆè°ƒç”¨<code>willChangeValueForKey</code>ï¼Œå†è°ƒç”¨åŸå…ˆçš„setteræ–¹æ³•ï¼Œå†è°ƒç”¨<code>didChangeValueForKey</code>ã€‚</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">static inline void NSSetPrimitiveValueAndNotify(id object,SEL selector, void (^setValueWithImplementation)(IMP imp)) &#123;</span><br><span class="line">    NSKeyValueNotifyingInfo *info = object_getIndexedIvars(object_getClass(object));</span><br><span class="line">    <span class="function"><span class="title">pthread_mutex_lock</span>(&amp;info-&gt;</span>mutex);</span><br><span class="line">    NSS<span class="function"><span class="title">tring</span> *key = CFDictionaryGetValue(info-&gt;</span>selKeyMap, selector);</span><br><span class="line">    key = [key copyWithZone:<span class="literal">nil</span>];</span><br><span class="line">    <span class="function"><span class="title">pthread_mutex_unlock</span>(&amp;info-&gt;</span>mutex);</span><br><span class="line">    <span class="function"><span class="title">if</span> (info-&gt;</span>overrideWillOrDidChange) &#123;</span><br><span class="line">        [object willChangeValueForKey:key];</span><br><span class="line">        IMP <span class="function"><span class="title">imp</span> = class_getMethodImplementation(info-&gt;</span>originalClass, selector);</span><br><span class="line">        setValueWithImplementation(imp);</span><br><span class="line">        [object didChangeValueForKey:key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [object changeValueForKey:key key:<span class="literal">nil</span> key:<span class="literal">nil</span> usingBlock:^&#123;</span><br><span class="line">            IMP <span class="function"><span class="title">imp</span> = class_getMethodImplementation(info-&gt;</span>originalClass, selector);</span><br><span class="line">            setValueWithImplementation(imp);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    [key release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè¿™é‡Œçš„<code>didChangeValueForKey</code>ä¹Ÿè¢«é‡å†™å®ç°äº†ï¼Œå®ƒä¼šè°ƒç”¨çœŸæ­£çš„å›è°ƒ<code>observeValueForKeyPath:ofObject:change:context:</code>æ–¹æ³•ã€‚</p><h1 id="äº”ã€ç§»é™¤è§‚å¯Ÿè€…"><a href="#äº”ã€ç§»é™¤è§‚å¯Ÿè€…" class="headerlink" title="äº”ã€ç§»é™¤è§‚å¯Ÿè€…"></a>äº”ã€ç§»é™¤è§‚å¯Ÿè€…</h1><p>æ‰¾åˆ°NSKeyValueObservanceç§»é™¤å³å¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueObservationInfoCreateByRemoving(<span class="built_in">NSKeyValueObservationInfo</span> *baseObservationInfo, <span class="keyword">id</span> observer, <span class="built_in">NSKeyValueProperty</span> *property, <span class="keyword">void</span> *context, <span class="built_in">BOOL</span> shouldCompareContext,  <span class="keyword">id</span> originalObservable,  <span class="built_in">BOOL</span> *cacheHit, <span class="built_in">NSKeyValueObservance</span> **removalObservance) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *createdObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å½“å‰å·²ç»å­˜åœ¨çš„observanceçš„æ•°é‡</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> observanceCount = <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)baseObservationInfo.observances);</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *observancesBuff[observanceCount];</span><br><span class="line">    <span class="built_in">CFArrayGetValues</span>((<span class="built_in">CFArrayRef</span>)baseObservationInfo.observances, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, observanceCount), (<span class="keyword">const</span> <span class="keyword">void</span> **)observancesBuff);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSUInteger</span> removalObservanceIndex = <span class="built_in">NSNotFound</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = observanceCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="comment">// é€ä¸ªéå†observancesBuffæ•°ç»„ä¸­çš„å…ƒç´ </span></span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *observance = observancesBuff[i];</span><br><span class="line">        <span class="comment">// propertyå’Œobserverä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> (observance.property == property &amp;&amp; observance.observer == observer) &#123;</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦æ¯”è¾ƒcontextæˆ–è€…contextä¸€è‡´</span></span><br><span class="line">            <span class="keyword">if</span> (!shouldCompareContext || observance.context == context) &#123;</span><br><span class="line">                <span class="comment">// originalObservableä¸€è‡´</span></span><br><span class="line">                <span class="keyword">if</span> (!originalObservable || observance.originalObservable == originalObservable) &#123;</span><br><span class="line">                    <span class="comment">// éœ€è¦ç§»é™¤çš„observance</span></span><br><span class="line">                    *removalObservance = observance;</span><br><span class="line">                    <span class="comment">// ç¡®å®šäº†å°†è¦ç§»é™¤çš„observanceçš„ç´¢å¼•</span></span><br><span class="line">                    removalObservanceIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å·²ç»æ‰¾åˆ°éœ€è¦ç§»é™¤çš„observance</span></span><br><span class="line">    <span class="keyword">if</span> (*removalObservance) &#123;</span><br><span class="line">        <span class="comment">// åŸå…ˆobservanceçš„æ•°é‡å¤§äº1ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (observanceCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">            <span class="comment">// NSKeyValueShareableObservationInfosç¼“å­˜ä¸å­˜åœ¨, åˆ›å»º</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">                <span class="built_in">NSPointerFunctions</span> *functions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">                [functions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">                [functions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:functions capacity:<span class="number">0</span>];</span><br><span class="line">                </span><br><span class="line">                [functions release];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span>) &#123;</span><br><span class="line">                <span class="comment">// å°±æ˜¯NSKeyValueShareableObservationInfoKey.class</span></span><br><span class="line">                <span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span> = <span class="built_in">NSKeyValueShareableObservationInfoKey</span>.self;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservationInfoKey</span> * shareableObservationInfoKey = <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// æ„å»ºæŸ¥æ‰¾ç¼“å­˜çš„Key</span></span><br><span class="line">            <span class="keyword">if</span> (!shareableObservationInfoKey) &#123;</span><br><span class="line">                shareableObservationInfoKey = [[<span class="built_in">NSKeyValueShareableObservationInfoKey</span> alloc] init];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            shareableObservationInfoKey.addingNotRemoving = <span class="literal">NO</span>;</span><br><span class="line">            shareableObservationInfoKey.baseObservationInfo = baseObservationInfo;</span><br><span class="line">            shareableObservationInfoKey.removalObservance = *removalObservance;</span><br><span class="line">            shareableObservationInfoKey.removalObservanceIndex = removalObservanceIndex;</span><br><span class="line">            shareableObservationInfoKey.cachedHash = <span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>(shareableObservationInfoKey, <span class="literal">NULL</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°è¯•åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾NSKeyValueObservationInfo</span></span><br><span class="line">            <span class="built_in">NSKeyValueObservationInfo</span> *existsObservationInfo = [<span class="built_in">NSKeyValueShareableObservationInfos</span> member:shareableObservationInfoKey];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é‡ç½®keyçš„æ•°æ®</span></span><br><span class="line">            shareableObservationInfoKey.removalObservance = <span class="literal">nil</span>;</span><br><span class="line">            shareableObservationInfoKey.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSUInteger</span> cachedHash = shareableObservationInfoKey.cachedHash;</span><br><span class="line">            </span><br><span class="line">            shareableObservationInfoKey.cachedHash = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!existsObservationInfo) &#123;</span><br><span class="line">                <span class="comment">// åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°, ç§»é™¤removalObservanceIndexå¯¹åº”çš„å…ƒç´ </span></span><br><span class="line">                memmove(observancesBuff + removalObservanceIndex, observancesBuff + removalObservanceIndex + <span class="number">1</span>, (observanceCount - (removalObservanceIndex + <span class="number">1</span>)) * <span class="keyword">sizeof</span>(<span class="built_in">NSKeyValueObservance</span> *));</span><br><span class="line">                <span class="comment">// é‡æ–°åˆ›å»ºObservationInfo, æ•°é‡ä¸ºobservanceCount - 1</span></span><br><span class="line">                createdObservationInfo = [[<span class="built_in">NSKeyValueObservationInfo</span> alloc] _initWithObservances:observancesBuff count:observanceCount - <span class="number">1</span> hashValue:cachedHash];</span><br><span class="line">                <span class="keyword">if</span> (createdObservationInfo.cachedIsShareable) &#123;</span><br><span class="line">                    <span class="comment">// ç¼“å­˜ObservationInfo</span></span><br><span class="line">                    [<span class="built_in">NSKeyValueShareableObservationInfos</span> addObject:createdObservationInfo];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">                *cacheHit = <span class="literal">NO</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">                *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">                <span class="comment">// ç›´æ¥èµ‹å€¼existsObservationInfo</span></span><br><span class="line">                createdObservationInfo = [existsObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> createdObservationInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åŸå…ˆåªæœ‰ä¸€ä¸ªobservance, å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">            *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°éœ€è¦ç§»é™¤çš„observance, è¿”å›nil</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å…­ã€KVOè‡ªå®ç°"><a href="#å…­ã€KVOè‡ªå®ç°" class="headerlink" title="å…­ã€KVOè‡ªå®ç°"></a>å…­ã€KVOè‡ªå®ç°</h1><p>æœ‰å¾ˆå¤šåŒå­¦å°è¯•è‡ªå·±å®ç°äº†KVOï¼Œæœ‰æŒ‰ç…§åŸç”Ÿæ¥å£çš„ï¼Œä¹Ÿæœ‰è‡ªæˆ‘å‘æŒ¥ç›´æ¥ä¼ é€’blockçš„ã€‚ç”±äºä¹‹å‰æˆ‘å·²ç»è¯»è¿‡ä¸€äº›å¼€æºçš„ä»£ç ï¼Œè§<a href="https://blog.chenyalun.com/2019/01/12/ã€ŒKVOControllerã€çš„å°è£…/">ã€Šã€ŒKVOControllerã€çš„å°è£…ã€‹</a>ï¼Œä½œè€…å°±æ˜¯ä½¿ç”¨äº†blockå¾ˆå¥½åœ°å°è£…äº†KVOçš„å›è°ƒã€‚æ‰€ä»¥ï¼Œè¿™é‡Œè¿˜æ˜¯è¯•ç€æŒ‰ç…§åŸç”Ÿæ¥å£å®ç°ä¸€ä¸‹ã€‚</p><p>ç”±äºå¯¹æºç ç†è§£åœ°ä¸æ˜¯ååˆ†é€å½»ï¼Œå†åŠ ä¸Šèƒ½åŠ›æœ‰é™ï¼Œåœ¨å°è¯•å®ç°è¿‡ç¨‹ä¸­é‡åˆ°ä¸å°‘é—®é¢˜ï¼Œå¹¸å¥½éƒ½è§£å†³äº†ã€‚å½“ç„¶ï¼Œä»£ç è‚¯å®šæœ‰ä¸å°‘é—®é¢˜çš„ï¼Œè€Œä¸”ä»…ä»…å®ç°ä¸€ç‚¹æ ¸å¿ƒåŠŸèƒ½ï¼Œå§‘ä¸”å½“åšç©å…·çœ‹çœ‹å§ã€‚</p><h2 id="1-æ¥å£"><a href="#1-æ¥å£" class="headerlink" title="1.æ¥å£"></a>1.æ¥å£</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="meta">@interface</span> NSObject(YAKVO)</span><br><span class="line"><span class="meta">@property</span> <span class="keyword">void</span> *ya_observationInfo;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_willChangeValueForKey:</span>(NSString *)key;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_didChangeValueForKey:</span>(NSString *)key;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_addObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_removeObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_observeValueForKeyPath:</span>(NSString *)keyPath <span class="string">ofObject:</span>(id)object <span class="string">change:</span>(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><h2 id="2-å®ç°"><a href="#2-å®ç°" class="headerlink" title="2.å®ç°"></a>2.å®ç°</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#define ClassPrefixCStr <span class="meta-string">"YAKVONotifying_"</span> // æ–°ç±»çš„å‰ç¼€</span></span><br><span class="line"><span class="meta">#define ClassPrefix     @ ClassPrefixCStr</span></span><br><span class="line"><span class="meta">#define OBSERVATION_INFO_KEY(object) ((void *)(~(NSUInteger)(object)))</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *YAKeyValueChangeDictionary = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ä¸€äº›ç§æœ‰æ–¹æ³•å’Œå±æ€§</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">YAKVOPrivate</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">YAKVOPrivate</span>)</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)ya_isKVOClass &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_changeValueForKey:(<span class="built_in">NSString</span> *)key usingBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">    [<span class="keyword">self</span> ya_willChangeValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (block) block();</span><br><span class="line">    [<span class="keyword">self</span> ya_didChangeValueForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// åŒ…è£…keyPathå’ŒoriginalClass</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueProperty</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) Class isaForAutonotifying;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *keyPath;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) Class originalClass;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOriginalClass:(Class)originalClass keyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueProperty</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOriginalClass:(Class)originalClass</span><br><span class="line">                              keyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _originalClass = originalClass;</span><br><span class="line">        _keyPath = keyPath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)isaForAutonotifying &#123;</span><br><span class="line">    <span class="comment">// æ„é€ æ–°çš„å­ç±»å</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalClassName = class_getName(_originalClass);</span><br><span class="line">    size_t size = strlen(originalClassName) + <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">char</span> *newClassName = (<span class="keyword">char</span> *)malloc(size);</span><br><span class="line">    </span><br><span class="line">    strlcpy(newClassName, ClassPrefixCStr, size);</span><br><span class="line">    strlcat(newClassName, originalClassName, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºå­ç±»</span></span><br><span class="line">    Class newSubClass = objc_allocateClassPair(_originalClass, newClassName, <span class="number">0</span>);</span><br><span class="line">    objc_registerClassPair(newSubClass);</span><br><span class="line">    free(newClassName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Setteræ–¹æ³•æ›¿æ¢</span></span><br><span class="line">    <span class="built_in">NSString</span> *uppercase= [[_keyPath substringToIndex:<span class="number">1</span>] uppercaseString];</span><br><span class="line">    <span class="built_in">NSString</span> *last = [_keyPath substringFromIndex:<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *<span class="keyword">setter</span> = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>, uppercase, last];</span><br><span class="line">    SEL sel = <span class="built_in">NSSelectorFromString</span>(<span class="keyword">setter</span>);</span><br><span class="line">    Method method = class_getInstanceMethod(newSubClass, sel);</span><br><span class="line">    <span class="keyword">if</span> (method) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = method_getTypeEncoding(method);</span><br><span class="line">        class_replaceMethod(newSubClass, sel, (IMP)YASetValueAndNotifyForKey, typeEncoding);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [[<span class="built_in">NSException</span> exceptionWithName:<span class="string">@"ç¼ºå°‘å‚æ•°"</span> reason:<span class="string">@"æ²¡æœ‰å®ç°Setteræ–¹æ³•"</span> userInfo:<span class="literal">nil</span>] raise];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// classæ–¹æ³•æ›¿æ¢ã€ya_isKVOClassæ–¹æ³•æ›¿æ¢</span></span><br><span class="line">    YAKVONotifyingSetMethodImplementation(newSubClass, <span class="keyword">@selector</span>(ya_isKVOClass), (IMP)YAKVOIsAutonotifying);</span><br><span class="line">    YAKVONotifyingSetMethodImplementation(newSubClass, <span class="keyword">@selector</span>(<span class="keyword">class</span>), (IMP)YAKVOClass);</span><br><span class="line">    <span class="keyword">return</span> newSubClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹åº”originalClassçš„ya_isKVOClassæ–¹æ³•</span></span><br><span class="line"><span class="built_in">BOOL</span> YAKVOIsAutonotifying(<span class="keyword">id</span> object, SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹åº”originalClassçš„classæ–¹æ³•</span></span><br><span class="line">Class YAKVOClass(<span class="keyword">id</span> object, SEL sel) &#123;</span><br><span class="line">    <span class="comment">// æ–°çš„class: NSKVONotifying_XXXX</span></span><br><span class="line">    Class currentClass = object_getClass(object);</span><br><span class="line">    <span class="keyword">if</span> ([object ya_isKVOClass]) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *clsStr = [<span class="built_in">NSStringFromClass</span>(currentClass) stringByReplacingOccurrencesOfString:ClassPrefix withString:<span class="string">@""</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹åº”originalClassçš„setteræ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> YASetValueAndNotifyForKey(<span class="keyword">id</span> obj, SEL sel, <span class="keyword">id</span> value, IMP imp) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *key = [[<span class="built_in">NSStringFromSelector</span>(sel) substringFromIndex:<span class="number">3</span>] lowercaseString];</span><br><span class="line">    key = [key substringToIndex:key.length - <span class="number">1</span>];</span><br><span class="line">    [obj ya_changeValueForKey:key usingBlock:^&#123;</span><br><span class="line">        Class cls = [obj <span class="keyword">class</span>];</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„setteræ–¹æ³•</span></span><br><span class="line">        IMP superImp = class_getMethodImplementation(cls, sel);</span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span> ,SEL , <span class="keyword">id</span>))superImp)(obj, sel, value);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æŸä¸ªclassæ·»åŠ å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> YAKVONotifyingSetMethodImplementation(Class cls, SEL sel, IMP imp) &#123;</span><br><span class="line">    Method originMethod = class_getInstanceMethod(cls, sel);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *encoding = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (originMethod) &#123;</span><br><span class="line">        encoding = method_getTypeEncoding(originMethod);</span><br><span class="line">        class_addMethod(cls, sel, imp, encoding);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// åŒ…è£…propertyã€observerã€contextã€options</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservance</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) YAKeyValueProperty *property;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> observer;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">void</span> *context;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> options;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">id</span>)observer property:(YAKeyValueProperty *)property options:(<span class="keyword">int</span>)options context:(<span class="keyword">void</span> *)context;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservance</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">id</span>)observer</span><br><span class="line">                        property:(YAKeyValueProperty *)property</span><br><span class="line">                         options:(<span class="keyword">int</span>)options</span><br><span class="line">                         context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _observer = observer;</span><br><span class="line">        _property = property;</span><br><span class="line">        _options = options;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> observerContextHash = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-%p"</span>, _observer, _context] hash];</span><br><span class="line">    <span class="keyword">return</span> observerContextHash ^ _property.hash ^ _options;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isKindOfClass:object_getClass(<span class="keyword">self</span>)]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    YAKeyValueObservance *other = (YAKeyValueObservance *)object;</span><br><span class="line">    <span class="keyword">return</span> other.observer == <span class="keyword">self</span>.observer &amp;&amp;</span><br><span class="line">    other.options == <span class="keyword">self</span>.options &amp;&amp;</span><br><span class="line">    other.context == <span class="keyword">self</span>.context;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// åŒ…è£…YAKeyValueObservanceæ•°ç»„</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservationInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observances;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObservances:(<span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *)observances</span><br><span class="line">                              count:(<span class="built_in">NSUInteger</span>)count;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservationInfo</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObservances:(<span class="built_in">NSArray</span>&lt;YAKeyValueObservance *&gt; *)observances</span><br><span class="line">                              count:(<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _observances = [[<span class="built_in">NSArray</span> alloc] initWithArray:observances];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// é…ç½®YAKeyValueObservationInfoKeyï¼Œå»æŸ¥è¯¢åŒ¹é…çš„YAKeyValueObservationInfo</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservationInfoKey</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) YAKeyValueObservationInfo *baseObservationInfo;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSObject</span> *additionObserver;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) YAKeyValueProperty *additionProperty;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> additionOptions;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">void</span>* additionContext;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservationInfoKey</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private methods</span></span><br><span class="line"><span class="built_in">BOOL</span> YAKeyValuePropertyIsEqual(YAKeyValueProperty *property1, YAKeyValueProperty *property2) &#123;</span><br><span class="line">    <span class="keyword">return</span> (property1.originalClass == property2.originalClass) &amp;&amp;</span><br><span class="line">    (property1.keyPath == property2.keyPath || [property1.keyPath isEqual: property2.keyPath]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSUInteger</span> YAKeyValuePropertyHash(YAKeyValueProperty *property) &#123;</span><br><span class="line">    <span class="keyword">return</span> property.keyPath.hash ^ (<span class="built_in">NSUInteger</span>)(__bridge <span class="keyword">void</span> *)property.originalClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–YAKeyValueProperty</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> YAKeyValueProperty *getKeyValueProperty(Class cls, <span class="built_in">NSString</span> *keyPath) &#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜é›†åˆ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableSetRef</span> YAKeyValueProperties;</span><br><span class="line">    <span class="keyword">if</span>(!YAKeyValueProperties) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºYAKeyValueProperties</span></span><br><span class="line">        <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        callbacks.version =  kCFTypeSetCallBacks.version;</span><br><span class="line">        callbacks.retain =  kCFTypeSetCallBacks.retain;</span><br><span class="line">        callbacks.release =  kCFTypeSetCallBacks.release;</span><br><span class="line">        callbacks.copyDescription =  kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">        callbacks.equal =  (<span class="built_in">CFSetEqualCallBack</span>)YAKeyValuePropertyIsEqual;</span><br><span class="line">        callbacks.hash =  (<span class="built_in">CFSetHashCallBack</span>)YAKeyValuePropertyHash;</span><br><span class="line">        YAKeyValueProperties = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueProperty *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) finder = [YAKeyValueProperty new];</span><br><span class="line">    finder.originalClass = cls;</span><br><span class="line">    finder.keyPath = keyPath;</span><br><span class="line">    YAKeyValueProperty *property = <span class="built_in">CFSetGetValue</span>(YAKeyValueProperties, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(finder));</span><br><span class="line">    <span class="keyword">if</span> (!property) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°, åˆ›å»º</span></span><br><span class="line">        property = [[YAKeyValueProperty alloc] initWithOriginalClass:cls keyPath:keyPath];</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">        <span class="built_in">CFSetAddValue</span>(YAKeyValueProperties, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(property));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> property;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–YAKeyValueObservance</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> YAKeyValueObservance *getKeyValueObservance(YAKeyValueProperty *property,</span><br><span class="line">                                                          <span class="keyword">id</span> observer,</span><br><span class="line">                                                          <span class="keyword">void</span> *context,</span><br><span class="line">                                                          <span class="keyword">int</span> options) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSHashTable</span> *YAKeyValueShareableObservances;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueShareableObservances) &#123;</span><br><span class="line">        YAKeyValueShareableObservances = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueObservance *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) finder = [YAKeyValueObservance new];</span><br><span class="line">    finder.property = property;</span><br><span class="line">    finder.context = context;</span><br><span class="line">    finder.observer = observer;</span><br><span class="line">    finder.options = options;</span><br><span class="line">    YAKeyValueObservance *observance = [YAKeyValueShareableObservances member:finder];</span><br><span class="line">    <span class="keyword">if</span> (!observance) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°, åˆ›å»º</span></span><br><span class="line">        observance = [[YAKeyValueObservance alloc] initWithObserver:observer property:property options:options context:context];</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">        [YAKeyValueShareableObservances addObject:observance];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSUInteger</span> YAKeyValueObservationInfoNSHTHash(<span class="keyword">const</span> <span class="keyword">void</span> *item, <span class="built_in">NSUInteger</span> (*size)(<span class="keyword">const</span> <span class="keyword">void</span> *item)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">        YAKeyValueObservationInfoKey *key = (__bridge YAKeyValueObservationInfoKey *)item;</span><br><span class="line">        <span class="keyword">return</span> key.baseObservationInfo.observances.firstObject.hash;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        YAKeyValueObservationInfo *info = (__bridge YAKeyValueObservationInfo *)item;</span><br><span class="line">        <span class="keyword">return</span> info.observances.firstObject.hash;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> YAKeyValueObservationInfoNSHTIsEqual(<span class="keyword">const</span> <span class="keyword">void</span> *item1, <span class="keyword">const</span> <span class="keyword">void</span> *item2, <span class="built_in">NSUInteger</span> (* size)(<span class="keyword">const</span> <span class="keyword">void</span> * item)) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä»…ä»…å†™äº†YAKeyValueObservationInfoKeyä¸YAKeyValueObservationInfoçš„æ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item1) == YAKeyValueObservationInfoKey.class || object_getClass((__bridge <span class="keyword">id</span>)item2) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">        YAKeyValueObservationInfo *info = <span class="literal">nil</span>;</span><br><span class="line">        YAKeyValueObservationInfoKey *key = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¡®å®šå“ªä¸€ä¸ªæ˜¯info, å“ªä¸€ä¸ªæ˜¯key</span></span><br><span class="line">        <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item1) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">            info = (__bridge YAKeyValueObservationInfo *)item2;</span><br><span class="line">            key = (__bridge YAKeyValueObservationInfoKey *)item1;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            info = (__bridge YAKeyValueObservationInfo *)item1;</span><br><span class="line">            key = (__bridge YAKeyValueObservationInfoKey *)item2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observancesInKey = key.baseObservationInfo.observances;</span><br><span class="line">        <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observancesInInfo = info.observances;</span><br><span class="line">        <span class="comment">// keyä¸­observanceçš„æ•°é‡</span></span><br><span class="line">        <span class="built_in">NSUInteger</span> countInkey = observancesInKey.count;</span><br><span class="line">        <span class="comment">// infoä¸­observanceçš„æ•°é‡</span></span><br><span class="line">        <span class="built_in">NSUInteger</span> countInInfo = observancesInInfo.count;</span><br><span class="line">        <span class="keyword">if</span> (countInkey != countInInfo) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; countInkey; i++) &#123;</span><br><span class="line">            <span class="comment">// ä¿è¯æ¯ä¸ªobservanceå®Œå…¨åŒ¹é…</span></span><br><span class="line">            <span class="keyword">if</span> (observancesInKey[i] != observancesInInfo[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Public methods</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">YAKVO</span>)</span></span><br><span class="line"><span class="built_in">CFMutableDictionaryRef</span> YAKeyValueObservationInfoPerObject = <span class="literal">NULL</span>;</span><br><span class="line">- (<span class="keyword">void</span> *)ya_observationInfo &#123;</span><br><span class="line">    <span class="keyword">return</span> YAKeyValueObservationInfoPerObject ? (<span class="keyword">void</span> *)<span class="built_in">CFDictionaryGetValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>)) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setYa_observationInfo:(<span class="keyword">void</span> *)info &#123;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueObservationInfoPerObject) &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryValueCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        callbacks.version = kCFTypeDictionaryKeyCallBacks.version;</span><br><span class="line">        callbacks.retain = kCFTypeDictionaryKeyCallBacks.retain;</span><br><span class="line">        callbacks.release = kCFTypeDictionaryKeyCallBacks.release;</span><br><span class="line">        callbacks.copyDescription = kCFTypeDictionaryKeyCallBacks.copyDescription;</span><br><span class="line">        YAKeyValueObservationInfoPerObject = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (info) &#123;</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>), info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryRemoveValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_willChangeValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueChangeDictionary) &#123;</span><br><span class="line">        YAKeyValueChangeDictionary = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">id</span> oldValue = <span class="literal">nil</span>;</span><br><span class="line">    oldValue = [<span class="keyword">self</span> valueForKeyPath:key];</span><br><span class="line">    <span class="keyword">if</span> (!oldValue) oldValue = [<span class="built_in">NSNull</span> null];</span><br><span class="line">    [YAKeyValueChangeDictionary setObject:oldValue forKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_didChangeValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, key);</span><br><span class="line">        YAKeyValueObservationInfo *observation = <span class="keyword">self</span>.ya_observationInfo;</span><br><span class="line">        [observation.observances enumerateObjectsUsingBlock:^(YAKeyValueObservance *obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj.property isEqual:property]) &#123;</span><br><span class="line">                <span class="built_in">NSMutableDictionary</span> *change = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">                <span class="keyword">if</span> (obj.options &amp; <span class="built_in">NSKeyValueObservingOptionOld</span>) &#123;</span><br><span class="line">                    <span class="keyword">id</span> old = [YAKeyValueChangeDictionary objectForKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                    [change setObject:old forKey:<span class="string">@"old"</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    [YAKeyValueChangeDictionary removeObjectForKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (obj.options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">                    <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">                    newValue = [<span class="keyword">self</span> valueForKeyPath:key];</span><br><span class="line">                    <span class="keyword">if</span> (!newValue) newValue = [<span class="built_in">NSNull</span> null];</span><br><span class="line">                    [YAKeyValueChangeDictionary setObject:newValue forKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-new"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                    [change setObject:newValue forKey:<span class="string">@"new"</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                [obj.observer ya_observeValueForKeyPath:key ofObject:<span class="keyword">self</span> change:change context:<span class="literal">nil</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_addObserver:(<span class="built_in">NSObject</span> *)observer</span><br><span class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">               options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</span><br><span class="line">               context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, keyPath);</span><br><span class="line">    YAKeyValueObservance *observance = getKeyValueObservance(property, observer, context, options);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSHashTable</span> *YAKeyValueShareableObservationInfos;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueShareableObservationInfos) &#123;</span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">        [pointerFunctions setHashFunction:YAKeyValueObservationInfoNSHTHash];</span><br><span class="line">        [pointerFunctions setIsEqualFunction:YAKeyValueObservationInfoNSHTIsEqual];</span><br><span class="line">        YAKeyValueShareableObservationInfos = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueObservationInfoKey *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) &#123;</span><br><span class="line">        finder = [YAKeyValueObservationInfoKey new];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueObservationInfo *info = (__bridge <span class="keyword">id</span>)[<span class="keyword">self</span> ya_observationInfo];</span><br><span class="line">    finder.baseObservationInfo = info;</span><br><span class="line">    finder.additionObserver = observer;</span><br><span class="line">    finder.additionContext = context;</span><br><span class="line">    finder.additionOptions = options;</span><br><span class="line">    finder.additionProperty = property;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueObservationInfo *observation = [YAKeyValueShareableObservationInfos member:finder];</span><br><span class="line">    <span class="comment">// é‡ç½®finderæ•°æ®</span></span><br><span class="line">    finder.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    finder.additionObserver = <span class="literal">nil</span>;</span><br><span class="line">    finder.additionContext = <span class="literal">NULL</span>;</span><br><span class="line">    finder.additionOptions = <span class="number">0</span>;</span><br><span class="line">    finder.additionProperty = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!observation) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°, åˆ›å»º</span></span><br><span class="line">        observation = [[YAKeyValueObservationInfo alloc] initWithObservances:@[observance] count:<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">        [YAKeyValueShareableObservationInfos addObject:observation];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *buffer = [<span class="built_in">NSMutableArray</span> arrayWithArray:observation.observances];</span><br><span class="line">        [buffer addObject:observance];</span><br><span class="line">        observation.observances = [<span class="built_in">NSArray</span> arrayWithArray:buffer];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.ya_observationInfo = (__bridge <span class="keyword">void</span> *)(observation);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        Class isaForAutonotifying = [property isaForAutonotifying];</span><br><span class="line">        <span class="comment">// æ›´æ”¹isaæŒ‡é’ˆ</span></span><br><span class="line">        object_setClass(<span class="keyword">self</span>, isaForAutonotifying);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionInitial</span>) &#123;</span><br><span class="line">        <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">            newValue = [<span class="keyword">self</span> valueForKeyPath:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!newValue) newValue = [<span class="built_in">NSNull</span> null]; <span class="comment">// ä½¿ç”¨NSNullå¯¹è±¡</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *change = @&#123;<span class="string">@"new"</span>: newValue&#125;;</span><br><span class="line">        [observer ya_observeValueForKeyPath:keyPath ofObject:<span class="keyword">self</span> change:change context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, keyPath);</span><br><span class="line">        YAKeyValueObservationInfo *observation = <span class="keyword">self</span>.ya_observationInfo;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *diff = [<span class="built_in">NSMutableArray</span> arrayWithArray:observation.observances];</span><br><span class="line">        __block <span class="built_in">NSInteger</span> removeIdx = <span class="number">-1</span>;</span><br><span class="line">        [diff enumerateObjectsUsingBlock:^(YAKeyValueObservance *obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj.property isEqual:property] &amp;&amp; obj.observer == observer &amp;&amp; obj.context == context) &#123;</span><br><span class="line">                removeIdx = idx;</span><br><span class="line">                *stop = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">if</span> (removeIdx != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‰¾åˆ°éœ€è¦ç§»é™¤çš„å…ƒç´ </span></span><br><span class="line">            [diff removeObjectAtIndex:removeIdx];</span><br><span class="line">            observation.observances = [<span class="built_in">NSArray</span> arrayWithArray:diff];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context&#123;&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="åŠŸèƒ½check"><a href="#åŠŸèƒ½check" class="headerlink" title="åŠŸèƒ½check"></a>åŠŸèƒ½check</h2><p>1.æ·»åŠ è§‚å¯Ÿè€…ä¸è®¾ç½®å›è°ƒï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"> [<span class="keyword">self</span>.obj ya_addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="string">"NULL"</span>];</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)ya_observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, change);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">self</span>.obj.name = <span class="string">@"Aaron"</span>;</span><br><span class="line"><span class="keyword">self</span>.obj.name = <span class="string">@"Jack"</span>;</span><br></pre></td></tr></table></figure><p>æ‰“å°ï¼š</p><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:41:23.595046<span class="string">+0800</span> Aaron[24893:604622] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">    old = "&lt;null&gt;";</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:41:23.595215<span class="string">+0800</span> Aaron[24893:604622] &#123;</span><br><span class="line">    new = Jack;</span><br><span class="line">    old = Aaron;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨NSKeyValueObservingOptionInitial</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionInitial <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">self.obj.name = @<span class="string">"Aaron"</span>;</span><br></pre></td></tr></table></figure><p>æ‰“å°<br><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-05</span><span class="number">-30</span> <span class="number">09</span>:<span class="type">45</span>:<span class="number">01.717131</span>+<span class="number">0800</span> Aaron[<span class="number">25010</span>:<span class="type">609398</span>] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type"></span>= <span class="string">"&lt;null&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.å¤šæ¬¡æ·»åŠ è§‚å¯Ÿè€…</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">self.obj.name = @<span class="string">"Aaron"</span>;</span><br></pre></td></tr></table></figure><p>æ‰“å°</p><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.625826<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.625992<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.626128<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„ä»£ç æ”¾åˆ°äº†githubä¸Šï¼š<a href="https://github.com/ChenYalun/Project/tree/master/KVO" target="_blank" rel="noopener">https://github.com/ChenYalun/Project/tree/master/KVO</a></p><h1 id="ä¸ƒã€å°ç»“"><a href="#ä¸ƒã€å°ç»“" class="headerlink" title="ä¸ƒã€å°ç»“"></a>ä¸ƒã€å°ç»“</h1><p>è¿™é‡Œå­¦åˆ°ä¸€ä¸ªæŠ€å·§ï¼šå¦‚ä½•ç¡®è®¤<code>NSUserDefaults</code>ä¸­æŸä¸ªkeyæ˜¯å¦å­˜åœ¨?</p><p>æ¯”å¦‚</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">BOOL result</span> = [NSUserDefaults.standardUserDefaults boolForKey:@<span class="string">"key"</span>];</span><br></pre></td></tr></table></figure><p>å½“resultä¸ºNOæ—¶ï¼Œæ€ä¹ˆåˆ¤æ–­æ˜¯å­˜å‚¨é”®<code>@&quot;key&quot;</code>å¯¹åº”çš„valueæ˜¯NOï¼Œè¿˜æ˜¯è¯´å‹æ ¹å°±æ²¡æœ‰å­˜è¿‡è¿™ä¸ªkeyå‘¢?å¯ä»¥ä½¿ç”¨<code>CFPreferencesGetAppBooleanValue()</code>å‡½æ•°ã€‚<br>KVOä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç :</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> keyExistsAndHasValidFormat = <span class="literal">false</span>; <span class="comment">// keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="built_in">BOOL</span> cleansUpBeforeThrowing = <span class="literal">false</span>; <span class="comment">// å­˜å‚¨çš„å€¼ä¸ºYESæˆ–è€…NO</span></span><br><span class="line"></span><br><span class="line">cleansUpBeforeThrowing = (<span class="built_in">BOOL</span>)<span class="built_in">CFPreferencesGetAppBooleanValue</span>(<span class="built_in">CFSTR</span>(<span class="string">"key"</span>), kCFPreferencesCurrentApplication, (Boolean *)&amp;keyExistsAndHasValidFormat);</span><br><span class="line"><span class="comment">// èƒ½åˆ¤æ–­å‡ºkeyå­˜åœ¨</span></span><br><span class="line">cleansUpBeforeThrowing = cleansUpBeforeThrowing &amp;&amp; keyExistsAndHasValidFormat;</span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œè¯´æ­£é¢˜ï¼Œæœ¬æ–‡ç®€å•æ€»ç»“äº†KVOçš„åŸç†ï¼Œå¹¶å°è¯•é˜…è¯»æºç ï¼Œç„¶è€Œèƒ½åŠ›æœ‰é™ã€æ—¶é—´æœ‰é™ï¼Œåªèƒ½æ˜ç™½ä¸ªå¤§æ¦‚ã€‚åœ¨åº”ç”¨åœºæ™¯æ–¹é¢ï¼Œå°±æ˜¯â€œè§‚å¯Ÿâ€ï¼Œå®é™…å¼€å‘ä¸­ï¼Œç›‘å¬UIScrollViewï¼ˆåŠå…¶å­ç±»ï¼‰çš„å±æ€§æ¯”è¾ƒå¤šã€‚æœ€åï¼Œç»™è‡ªå·±æŒ–äº†ä¸ªå‘ï¼š<code>willChangeValueForKey:</code>å’Œ<code>didChangeValueForKey:</code>ä¸ºä»€ä¹ˆè¦æˆå¯¹å‡ºç°ï¼Ÿå“ªå¤©æœ‰æ—¶é—´äº†ï¼Œå†ä»”ç»†çœ‹ä¸€çœ‹ã€‚</p><hr><p>KVOçš„æºç æ¥è‡ªï¼š<a href="https://github.com/renjinkui2719/DIS_KVC_KVO" target="_blank" rel="noopener">https://github.com/renjinkui2719/DIS_KVC_KVO</a> ã€‚æ„Ÿè°¢ä½œè€…ã€‚</p><blockquote><p>å‚è€ƒæ–‡ç« <br><a href="http://southpeak.github.io/2015/04/23/cocoa-foundation-nskeyvalueobserving/" target="_blank" rel="noopener">Foundation: NSKeyValueObserving(KVO)</a><br><a href="https://tech.glowing.com/cn/implement-kvo/" target="_blank" rel="noopener">å¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®ç° KVO</a><br><a href="https://knightsj.github.io/2017/05/15/ä½¿ç”¨Blockå®ç°KVO/" target="_blank" rel="noopener">ä½¿ç”¨Blockå®ç°KVO</a><br><a href="https://blog.sunnyxx.com/2014/03/09/objc_kvo_secret/" target="_blank" rel="noopener">objc kvoç®€å•æ¢ç´¢</a><br><a href="http://chuquan.me/2018/12/12/kvo-principle/" target="_blank" rel="noopener">KVO åŸç†è¯¦è§£</a> </p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; KVOæºç é˜…è¯»ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>è¯¦è§£Key-Value Codingæºç </title>
    <link href="http://blog.chenyalun.com/2019/05/05/%E8%AF%A6%E8%A7%A3Key-Value%20Coding%E6%BA%90%E7%A0%81/"/>
    <id>http://blog.chenyalun.com/2019/05/05/è¯¦è§£Key-Value Codingæºç /</id>
    <published>2019-05-05T12:12:24.000Z</published>
    <updated>2019-09-17T03:32:29.747Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> KVCæºç é˜…è¯»ã€‚ </p><br><a id="more"></a><p></p><h1 id="ä¸€ã€æ¥å£"><a href="#ä¸€ã€æ¥å£" class="headerlink" title="ä¸€ã€æ¥å£"></a>ä¸€ã€æ¥å£</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line"><span class="comment">// æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å®ä¾‹å˜é‡(å®ä¾‹å˜é‡è®¿é—®å¼€å…³, é»˜è®¤YES)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> accessInstanceVariablesDirectly;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡keyè®¿é—®</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// å°è¯•éªŒè¯å°†è¦è®¾å®šçš„value(ioValueæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡)æ˜¯å¦åˆç†æœ‰æ•ˆ</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKey:(<span class="built_in">NSString</span> *)inKey error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line"><span class="comment">// è·å–ç›¸å¯¹åº”çš„ç²¾ç¡®å®¹å™¨ç±»å‹</span></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="built_in">NSMutableSet</span> *)mutableSetValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡keyPathè®¿é—®</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKeyPath:(<span class="built_in">NSString</span> *)inKeyPath error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">NSMutableSet</span> *)mutableSetValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾keyå¤±è´¥é»˜è®¤æŠ›å‡ºå¼‚å¸¸, å¯é‡å†™è‡ªè¡Œå®ç°</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// è®¾ç½®valueå¤±è´¥é»˜è®¤æŠ›å‡ºå¼‚å¸¸, å¯é‡å†™è‡ªè¡Œå®ç°</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// è®¾ç½®valueä¸ºnilæ—¶æŠ›å‡ºå¼‚å¸¸, å¯é‡å†™è‡ªè¡Œå®ç°</span></span><br><span class="line">- (<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// ä¼ å…¥keyæ•°ç»„, è¿”å›ä¸€ä¸ªæˆå‘˜å˜é‡åå’Œå˜é‡å€¼çš„é”®å€¼å¯¹ç»„æˆçš„å­—å…¸(å¯ç”¨äºæ¨¡å‹è½¬å­—å…¸)</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br><span class="line"><span class="comment">// å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">- (<span class="keyword">void</span>)setValuesForKeysWithDictionary:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)keyedValues;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// å®¹å™¨æ‰©å±•</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSDictionary</span>&lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">nullable</span> ObjectType)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableDictionary</span>&lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> ObjectType)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSSet</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSOrderedSet</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="é›†åˆä»£ç†å¯¹è±¡"><a href="#é›†åˆä»£ç†å¯¹è±¡" class="headerlink" title="é›†åˆä»£ç†å¯¹è±¡"></a>é›†åˆä»£ç†å¯¹è±¡</h2><p>è¿™é‡Œç®€å•æ€»ç»“é›†åˆä»£ç†å¯¹è±¡çš„ä½¿ç”¨ã€‚</p><blockquote><p>å½“æˆ‘ä»¬åœ¨å¯¹è±¡ä¸Šè°ƒç”¨ <code>-valueForKey:</code> çš„æ—¶å€™ï¼Œå®ƒå¯ä»¥è¿”å› <code>NSArray</code>ï¼Œ<code>NSSet</code> æˆ–æ˜¯ <code>NSOrderedSet</code> çš„é›†åˆä»£ç†å¯¹è±¡ã€‚è¿™ä¸ªç±»æ²¡æœ‰å®ç°é€šå¸¸çš„ <code>-&lt;Key&gt;</code> æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå®ç°äº†ä»£ç†å¯¹è±¡æ‰€éœ€è¦ä½¿ç”¨çš„å¾ˆå¤šæ–¹æ³•ã€‚</p></blockquote><h3 id="NSArray"><a href="#NSArray" class="headerlink" title="NSArray"></a>NSArray</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Primes</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *primes;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Primes</span></span></span><br><span class="line"><span class="keyword">@dynamic</span> primes; <span class="comment">// ä¸è¦ç”Ÿæˆgetæ–¹æ³•</span></span><br><span class="line"><span class="keyword">static</span> int32_t <span class="keyword">const</span> primes[] = &#123;</span><br><span class="line">    <span class="number">2</span>, <span class="number">101</span>, <span class="number">233</span>, <span class="number">383</span>, <span class="number">3</span>, <span class="number">103</span>, <span class="number">239</span>, <span class="number">389</span>, <span class="number">5</span>, <span class="number">107</span>, <span class="number">241</span>, <span class="number">397</span>, <span class="number">7</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">251</span>, <span class="number">401</span>, <span class="number">11</span>, <span class="number">113</span>, <span class="number">257</span>, <span class="number">409</span>, <span class="number">13</span>, <span class="number">127</span>, <span class="number">263</span>, <span class="number">419</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">269</span>,</span><br><span class="line">    <span class="number">421</span>, <span class="number">19</span>, <span class="number">137</span>, <span class="number">271</span>, <span class="number">431</span>, <span class="number">23</span>, <span class="number">139</span>, <span class="number">277</span>, <span class="number">433</span>, <span class="number">29</span>, <span class="number">149</span>, <span class="number">281</span>, <span class="number">439</span>,</span><br><span class="line">    <span class="number">31</span>, <span class="number">151</span>, <span class="number">283</span>, <span class="number">443</span>, <span class="number">37</span>, <span class="number">157</span>, <span class="number">293</span>, <span class="number">449</span>, <span class="number">41</span>, <span class="number">163</span>, <span class="number">307</span>, <span class="number">457</span>, <span class="number">43</span>,</span><br><span class="line">    <span class="number">167</span>, <span class="number">311</span>, <span class="number">461</span>, <span class="number">47</span>, <span class="number">173</span>, <span class="number">313</span>, <span class="number">463</span>, <span class="number">53</span>, <span class="number">179</span>, <span class="number">317</span>, <span class="number">467</span>, <span class="number">59</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">331</span>, <span class="number">479</span>, <span class="number">61</span>, <span class="number">191</span>, <span class="number">337</span>, <span class="number">487</span>, <span class="number">67</span>, <span class="number">193</span>, <span class="number">347</span>, <span class="number">491</span>, <span class="number">71</span>, <span class="number">197</span>, <span class="number">349</span>,</span><br><span class="line">    <span class="number">499</span>, <span class="number">73</span>, <span class="number">199</span>, <span class="number">353</span>, <span class="number">503</span>, <span class="number">79</span>, <span class="number">211</span>, <span class="number">359</span>, <span class="number">509</span>, <span class="number">83</span>, <span class="number">223</span>, <span class="number">367</span>, <span class="number">521</span>,</span><br><span class="line">    <span class="number">89</span>, <span class="number">227</span>, <span class="number">373</span>, <span class="number">523</span>, <span class="number">97</span>, <span class="number">229</span>, <span class="number">379</span>, <span class="number">541</span>, <span class="number">547</span>, <span class="number">701</span>, <span class="number">877</span>, <span class="number">1049</span>,</span><br><span class="line">    <span class="number">557</span>, <span class="number">709</span>, <span class="number">881</span>, <span class="number">1051</span>, <span class="number">563</span>, <span class="number">719</span>, <span class="number">883</span>, <span class="number">1061</span>, <span class="number">569</span>, <span class="number">727</span>, <span class="number">887</span>,</span><br><span class="line">    <span class="number">1063</span>, <span class="number">571</span>, <span class="number">733</span>, <span class="number">907</span>, <span class="number">1069</span>, <span class="number">577</span>, <span class="number">739</span>, <span class="number">911</span>, <span class="number">1087</span>, <span class="number">587</span>, <span class="number">743</span>,</span><br><span class="line">    <span class="number">919</span>, <span class="number">1091</span>, <span class="number">593</span>, <span class="number">751</span>, <span class="number">929</span>, <span class="number">1093</span>, <span class="number">599</span>, <span class="number">757</span>, <span class="number">937</span>, <span class="number">1097</span>, <span class="number">601</span>,</span><br><span class="line">    <span class="number">761</span>, <span class="number">941</span>, <span class="number">1103</span>, <span class="number">607</span>, <span class="number">769</span>, <span class="number">947</span>, <span class="number">1109</span>, <span class="number">613</span>, <span class="number">773</span>, <span class="number">953</span>, <span class="number">1117</span>,</span><br><span class="line">    <span class="number">617</span>, <span class="number">787</span>, <span class="number">967</span>, <span class="number">1123</span>, <span class="number">619</span>, <span class="number">797</span>, <span class="number">971</span>, <span class="number">1129</span>, <span class="number">631</span>, <span class="number">809</span>, <span class="number">977</span>,</span><br><span class="line">    <span class="number">1151</span>, <span class="number">641</span>, <span class="number">811</span>, <span class="number">983</span>, <span class="number">1153</span>, <span class="number">643</span>, <span class="number">821</span>, <span class="number">991</span>, <span class="number">1163</span>, <span class="number">647</span>, <span class="number">823</span>,</span><br><span class="line">    <span class="number">997</span>, <span class="number">1171</span>, <span class="number">653</span>, <span class="number">827</span>, <span class="number">1009</span>, <span class="number">1181</span>, <span class="number">659</span>, <span class="number">829</span>, <span class="number">1013</span>, <span class="number">1187</span>, <span class="number">661</span>,</span><br><span class="line">    <span class="number">839</span>, <span class="number">1019</span>, <span class="number">1193</span>, <span class="number">673</span>, <span class="number">853</span>, <span class="number">1021</span>, <span class="number">1201</span>, <span class="number">677</span>, <span class="number">857</span>, <span class="number">1031</span>,</span><br><span class="line">    <span class="number">1213</span>, <span class="number">683</span>, <span class="number">859</span>, <span class="number">1033</span>, <span class="number">1217</span>, <span class="number">691</span>, <span class="number">863</span>, <span class="number">1039</span>, <span class="number">1223</span>, <span class="number">1229</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectInPrimesAtIndex:(<span class="built_in">NSUInteger</span>)idx &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(idx &lt; <span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">    <span class="keyword">return</span> @(primes[idx]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¯¹äºNSArrayï¼Œ å®ç°<code>-countOf&lt;Key&gt;</code>æ–¹æ³•ï¼Œ<code>-objectIn&lt;Key&gt;AtIndex:</code>æˆ–è€…<code>-&lt;key&gt;AtIndexes:</code>ä¸­çš„ä¸€ä¸ªå³å¯ï¼Œå½“ç„¶å¦‚æœå†å®ç°<code>-get&lt;Key&gt;:range:</code>å°†ä¼šå¢å¼ºæ€§èƒ½ã€‚</p><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œkeyæ˜¯â€œprimesâ€ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªprimesæ•°ç»„ï¼Œè€Œæ˜¯ç”¨äº†ä¸€ä¸ªCæ•°ç»„ä»£ç†äº†ã€‚<code>@property (nonatomic, copy, readonly) NSArray *primes;</code>å’Œ<code>@dynamic primes;</code> è¿™ä¸¤å¥è¯å¯ä»¥çœç•¥ï¼ˆä¸‹æ–‡çš„ä¾‹å­å°±çœç•¥äº†ï¼‰ï¼Œè¿™é‡ŒåŠ ä¸Šçš„åŸå› æ˜¯ï¼Œä¾¿äºå¤–ç•ŒçŸ¥æ™“å…·ä½“çš„keyå€¼ã€‚</p><p>ä½¿ç”¨ï¼š</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">Primes *primes = [Primes <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueArray</span>'</span></span><br><span class="line">id obj = [primes valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œè·å¾—çš„å¯¹è±¡å¹¶ä¸æ˜¯ä¸€ä¸ªNSArrayï¼Œè€Œæ˜¯<code>NSKeyValueArray</code>ã€‚</p><h3 id="NSSet"><a href="#NSSet" class="headerlink" title="NSSet"></a>NSSet</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrimesSet</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrimesSet</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSSet</span> *_numSet;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _numSet = [<span class="built_in">NSSet</span> setWithObjects:@<span class="number">0</span>, @<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, <span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numSet.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSEnumerator</span> *)enumeratorOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numSet.objectEnumerator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)memberOfPrimes:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numSet member:obj];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¯¹äºNSSetï¼Œè¦å®ç°<code>-countOf&lt;Key&gt;</code>ã€<code>-enumeratorOf&lt;Key&gt;</code>å’Œ<code>-memberOf&lt;Key&gt;:</code>è¿™ä¸‰ä¸ªæ–¹æ³•ã€‚</p><p>ä½¿ç”¨ï¼š</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">PrimesSet *primesSet = [PrimesSet <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueSet</span>'</span></span><br><span class="line">id obj = [primesSet valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure><p>è·å–åˆ°çš„å¯¹è±¡æ˜¯<code>NSKeyValueSet</code>ã€‚</p><h3 id="NSOrderedSet"><a href="#NSOrderedSet" class="headerlink" title="NSOrderedSet"></a>NSOrderedSet</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrimesOrderedSet</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrimesOrderedSet</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSOrderedSet</span> *_numOrderedSet;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _numOrderedSet = [<span class="built_in">NSOrderedSet</span> orderedSetWithObjects:@<span class="number">0</span>, @<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, <span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numOrderedSet.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)indexInPrimesOfObject:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numOrderedSet indexOfObject:obj];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectInPrimesAtIndex:(<span class="built_in">NSUInteger</span>)idx &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numOrderedSet objectAtIndex:idx];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºæé«˜æ€§èƒ½</span></span><br><span class="line">- (<span class="keyword">void</span>)getPrimes:(<span class="keyword">id</span> __<span class="keyword">unsafe_unretained</span> *)buffer range:(<span class="built_in">NSRange</span>)inRange &#123;</span><br><span class="line">    <span class="comment">// è¿”å›æä¾›çš„ç¼“å†²åŒºå†…æŒ‡å®šèŒƒå›´å†…çš„æ•°æ®é›†åˆ</span></span><br><span class="line">    [_numOrderedSet getObjects:buffer range:inRange];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¿…é¡»å®ç°çš„æ–¹æ³•æ˜¯<code>-countOf&lt;Key&gt;</code>å’Œ<code>-indexIn&lt;Key&gt;OfObject:</code>ã€‚äºŒé€‰ä¸€å®ç°çš„æ–¹æ³•æ˜¯<code>-objectIn&lt;Key&gt;AtIndex:</code>å’Œ<code>-&lt;key&gt;AtIndexes:</code>ã€‚å¦‚æœå†å®ç°<code>-get&lt;Key&gt;:range:</code>å°†ä¼šå¢å¼ºæ€§èƒ½ã€‚</p><p>ä½¿ç”¨ï¼š</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">PrimesOrderedSet *primesOrderedSet = [PrimesOrderedSet <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueOrderedSet</span>'</span></span><br><span class="line">id obj = [primesOrderedSet valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure><p>è·å–åˆ°çš„å¯¹è±¡æ˜¯<code>NSKeyValueOrderedSet</code>ã€‚</p><h2 id="é›†åˆæ“ä½œ"><a href="#é›†åˆæ“ä½œ" class="headerlink" title="é›†åˆæ“ä½œ"></a>é›†åˆæ“ä½œ</h2><p>æ•°ç»„æœ€å¤§å€¼ï¼š</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">NSArray <span class="symbol">*</span>array = <span class="meta">@[</span><span class="meta">@1,</span> <span class="meta">@8,</span> <span class="meta">@5];</span></span><br><span class="line">[array valueForKeyPath:<span class="meta">@"</span><span class="meta">@max.self"];</span></span><br></pre></td></tr></table></figure><p>æ¨¡å‹æ•°ç»„æœ€å¤§å€¼ï¼š</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">NSArray *<span class="keyword">array</span> = @[person1, person2, person3];</span><br><span class="line">[<span class="keyword">array</span> valueForKeyPath:@<span class="string">"@max.age"</span>];</span><br></pre></td></tr></table></figure><p>å…¶ä»–æ“ä½œç¬¦ï¼š</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@max</span> <span class="variable">@min</span>: è·å¾—æ•°ç»„ä¸­æœ€å¤§(æˆ–è€…æœ€å°)çš„ä¸€ä¸ªå…ƒç´ </span><br><span class="line"><span class="variable">@avg</span>: å°†é›†åˆä¸­å¯¹è±¡è½¬æ¢æˆdoubleç±»å‹ï¼Œè¿”å›æ•°ç»„ä¸­æŒ‡å®šçš„å¹³å‡å€¼çš„numberå¯¹è±¡</span><br><span class="line"><span class="variable">@sum</span>: å°†é›†åˆä¸­æ¯ä¸ªå¯¹è±¡éƒ½è½¬æ¢æˆdoubleç±»å‹ï¼Œç„¶åè®¡ç®—æ€»å’Œï¼Œæœ€åè¿”å›ä¸€ä¸ªå€¼ä¸ºè¿™ä¸ªæ€»å’Œçš„NSNumberå¯¹è±¡</span><br><span class="line"><span class="variable">@count</span>ï¼šè¿”å›é›†åˆä¸­å¯¹è±¡æ€»æ•°çš„NSNumberå¯¹è±¡</span><br><span class="line"></span><br><span class="line">è¿”å›ä¸€ä¸ªç”±æ“ä½œç¬¦å³è¾¹çš„key pathæŒ‡å®šçš„å¯¹è±¡å±æ€§ç»„æˆçš„æ•°ç»„ï¼ŒdistincUnionOfObjectsä¼šå¯¹æ•°ç»„å»é‡ã€‚</span><br><span class="line">ç¤ºä¾‹ï¼š</span><br><span class="line">[personList <span class="attribute">valueForKeyPath</span>:@<span class="string">"@unionOfObjects.name"</span>];</span><br><span class="line"><span class="selector-attr">[personList valueForKeyPath:@"@distinctUnionOfObjects.name"]</span>;</span><br><span class="line">æ“ä½œå¯¹è±¡ï¼š<span class="variable">@unionOfObjects</span>/<span class="variable">@distincUnionOfObjects</span> </span><br><span class="line">æ“ä½œæ•°ç»„ï¼š<span class="variable">@distinctUnionOfArrays</span>/<span class="variable">@unionOfArrays</span></span><br><span class="line">æ“ä½œé›†åˆï¼š<span class="variable">@distinctUnionOfSets</span> å’Œ<span class="variable">@distinctUnionOfArrays</span></span><br></pre></td></tr></table></figure><h2 id="åˆ†ç±»çš„KVC"><a href="#åˆ†ç±»çš„KVC" class="headerlink" title="åˆ†ç±»çš„KVC"></a>åˆ†ç±»çš„KVC</h2><p>ä¸€èˆ¬çš„åœºæ™¯æ˜¯è¿™æ ·ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸»ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> :  <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> (<span class="title">PrimitiveAccessors</span>)</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span> (<span class="title">PrimitiveAccessors</span>)</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSNumber</span> *gVolume;</span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume &#123;</span><br><span class="line">    <span class="keyword">return</span> gVolume;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value &#123;</span><br><span class="line">    gVolume = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸»ç±»ä¸­æ²¡æœ‰çš„keyï¼Œåˆ†ç±»å®ç°ç‰¹å®šçš„æ–¹æ³•åï¼ŒKVCä¹Ÿå°†ä¼šç”Ÿæ•ˆã€‚å¦‚æœæ˜¯å–å€¼ï¼Œåˆ†ç±»å¿…é¡»å®ç°è¿™æ ·çš„æ–¹æ³•ï¼š<code>getPrimitive&lt;key&gt;</code>æˆ–è€…<code>primitive&lt;key&gt;</code>ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œkeyæ˜¯volumeã€‚å¦‚æœæ˜¯è®¾å€¼ï¼Œåˆ†ç±»å¿…é¡»å®ç°<code>setPrimitive&lt;key&gt;:</code>æ–¹æ³•ã€‚</p><p>ä½¿ç”¨ï¼š</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">Portion *p = [Portion <span class="keyword">new</span>];</span><br><span class="line">[p <span class="string">setValue:</span>@<span class="number">234</span> <span class="string">forKey:</span>@<span class="string">"volume"</span>];</span><br><span class="line">id m = [p <span class="string">valueForKey:</span>@<span class="string">"volume"</span>];</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæœ¬è´¨ä¸Šæ¥è®²ï¼ŒKVCå¹¶ä¸ä»‹æ„è¿™äº›æ–¹æ³•åœ¨ä¸»ç±»è¿˜æ˜¯åˆ†ç±»å®ç°çš„ï¼Œåªè¦æœ‰å®ç°å°±æˆã€‚ä¸Šé¢çš„åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®é™…ä¸Šï¼Œå®Œå…¨ä¾é ä¸»ç±»ä¹Ÿæ˜¯æ— å¦¨çš„ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> :  <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSNumber</span> *gVolume;</span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume &#123;</span><br><span class="line">    <span class="keyword">return</span> gVolume;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value &#123;</span><br><span class="line">    gVolume = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h1 id="äºŒã€å–å€¼"><a href="#äºŒã€å–å€¼" class="headerlink" title="äºŒã€å–å€¼"></a>äºŒã€å–å€¼</h1><h2 id="valueForKey"><a href="#valueForKey" class="headerlink" title="valueForKey:"></a>valueForKey:</h2><p>è‹¹æœåœ¨æ¥å£è¿™é‡Œå·²ç»ç»™å‡ºäº†å…¶åŸºæœ¬åŸç†ï¼š</p><blockquote><p>The default implementation of this method does the following:</p><ol><li><p>Searches the class of the receiver for an accessor method whose name matches the pattern <code>-get&lt;Key&gt;, -&lt;key&gt;, or -is&lt;Key&gt;</code>, in that order. If such a method is found it is invoked. If the type of the methodâ€™s result is an object pointer type the result is simply returned. If the type of the result is one of the scalar types supported by NSNumber conversion is done and an NSNumber is returned. Otherwise, conversion is done and an NSValue is returned (new in Mac OS 10.5: results of arbitrary type are converted to NSValues, not just NSPoint, NRange, NSRect, and NSSize).</p></li><li><p>(introduced in Mac OS 10.7). Otherwise (no simple accessor method is found), searches the class of the receiver for methods whose names match the patterns <code>-countOf&lt;Key&gt; and -indexIn&lt;Key&gt;OfObject: and -objectIn&lt;Key&gt;AtIndex:</code>(corresponding to the primitive methods defined by the NSOrderedSet class) and also <code>-&lt;key&gt;AtIndexes:</code> (corresponding to -[NSOrderedSet objectsAtIndexes:]). If a count method and an indexOf method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSOrderedSet methods is returned. Each NSOrderedSet message sent to the collection proxy object will result in some combination of<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:, -objectIn&lt;Key&gt;AtIndex:, and -&lt;key&gt;AtIndexes:</code> messages being sent to the original receiver of <code>-valueForKey:</code>. If the class of the receiver also implements an optional method whose name matches the pattern -get<key>:range: that method will be used when appropriate for best performance.</key></p></li></ol><ol start="3"><li><p>Otherwise (no simple accessor method or set of ordered set access methods is found), searches the class of the receiver for methods whose names match the patterns <code>-countOf&lt;Key&gt; and -objectIn&lt;Key&gt;AtIndex:</code>(corresponding to the primitive methods defined by the NSArray class) and (introduced in Mac OS 10.4) also<code>-&lt;key&gt;AtIndexes:</code>(corresponding to -[NSArray objectsAtIndexes:]). If a count method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSArray methods is returned. Each NSArray message sent to the collection proxy object will result in some combination of <code>-countOf&lt;Key&gt;, -objectIn&lt;Key&gt;AtIndex:, and -&lt;key&gt;AtIndexes:</code> messages being sent to the original receiver of <code>-valueForKey:</code>. If the class of the receiver also implements an optional method whose name matches the pattern <code>-get&lt;Key&gt;:range:</code> that method will be used when appropriate for best performance.</p></li><li><p>(introduced in Mac OS 10.4). Otherwise (no simple accessor method or set of ordered set or array access methods is found), searches the class of the receiver for a threesome of methods whose names match the patterns <code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;:</code> (corresponding to the primitive methods defined by the NSSet class). If all three such methods are found a collection proxy object that responds to all NSSet methods is returned. Each NSSet message sent to the collection proxy object will result in some combination of <code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;:</code>messages being sent to the original receiver of <code>-valueForKey:</code>.</p></li><li><p>Otherwise (no simple accessor method or set of collection access methods is found), if the receiverâ€™s classâ€™ +accessInstanceVariablesDirectly property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern <code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;</code>, in that order. If such an instance variable is found, the value of the instance variable in the receiver is returned, with the same sort of conversion to NSNumber or NSValue as in step 1.</p></li><li><p>Otherwise (no simple accessor method, set of collection access methods, or instance variable is found), invokes <code>-valueForUndefinedKey:</code> and returns the result. The default implementation of <code>-valueForUndefinedKey:</code> raises an NSUndefinedKeyException, but you can override it in your application.</p></li></ol><p>Compatibility notes:</p><ul><li>For backward binary compatibility, an accessor method whose name matches the pattern <code>-_get&lt;Key&gt;</code>, or <code>-_&lt;key&gt;</code> is searched for between steps 1 and 3. If such a method is found it is invoked, with the same sort of conversion to NSNumber or NSValue as in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</li><li>The behavior described in step 5 is a change from Mac OS 10.2, in which the instance variable search order was <code>&lt;key&gt;, _&lt;key&gt;</code>.</li><li>For backward binary compatibility, <code>-handleQueryWithUnboundKey:</code> will be invoked instead of <code>-valueForUndefinedKey:</code> in step 6, if the implementation of <code>-handleQueryWithUnboundKey:</code> in the receiverâ€™s class is not NSObjectâ€™s.</li></ul></blockquote><p>ç®€å•ç¿»è¯‘å¦‚ä¸‹ï¼š</p><ol><li>æŒ‰ç…§<code>-get&lt;Key&gt;, -&lt;key&gt;, -is&lt;Key&gt;</code>çš„é¡ºåºæœç´¢è¯¥ç±»çš„å­˜å–å™¨æ–¹æ³•ï¼Œè‹¥æ‰¾åˆ°ï¼Œåˆ™ç›´æ¥è°ƒç”¨ã€‚å¦‚æœæ–¹æ³•è°ƒç”¨çš„ç»“æœæ˜¯<code>id</code>ç±»å‹ï¼Œç›´æ¥æŠŠç»“æœè¿”å›ã€‚å¦‚æœæ–¹æ³•è°ƒç”¨çš„ç»“æœæ˜¯èƒ½å¤Ÿè¢«<code>NSNumber</code>è½¬æ¢çš„æ ‡é‡ç±»å‹ï¼Œåˆ™ç»“æœä¼šè¢«è½¬ä¸º<code>NSNumber</code>è¿”å›ã€‚å¦åˆ™å¯¹äºä¸€èˆ¬çš„æ ‡é‡ç±»å‹ï¼Œè¿™äº›ç±»å‹å°†ä¼šè¢«è½¬åŒ–ä¸º<code>NSValue</code>ï¼ˆåœ¨Mac OS 10.5åŠä»¥åï¼Œä¸ä»…ä»…æ”¯æŒ<code>NSPoint, NRange, NSRect</code>ï¼Œä»¥åŠ<code>NSSize</code>è¿™äº›ç±»å‹ï¼‰ã€‚</li><li>å¦‚æœç®€å•çš„å­˜å–å™¨æ–¹æ³•æ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆæœç´¢è¯¥ç±»çš„<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:</code>æ–¹æ³•ï¼Œè¿˜æœ‰<code>-objectIn&lt;Key&gt;AtIndex:</code>ï¼ˆå¯¹åº”è¢«<code>NSOrderedSet</code>ç±»æ‰€å®šä¹‰çš„æ–¹æ³•ï¼‰ï¼Œ<code>-&lt;key&gt;AtIndexes:</code>ï¼ˆå¯¹åº”<code>-[NSOrderedSet objectsAtIndexes:]</code>ï¼‰æ–¹æ³•ã€‚å¦‚æœ<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:</code>è¿™ä¸¤ä¸ªæ–¹æ³•è¢«æ‰¾åˆ°ï¼Œå¦å¤–ä¸¤ä¸ªæ–¹æ³•ä¸­çš„è‡³å°‘ä¸€ä¸ªè¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªèƒ½å“åº”<code>NSOrderedSet</code>æ‰€æœ‰æ–¹æ³•çš„é›†åˆä»£ç†å¯¹è±¡ä¼šè¢«è¿”å›ã€‚å‘é€ç»™åŸæ¥æ¶ˆæ¯æ¥æ”¶è€…çš„<code>-valueForKey:</code>æ¶ˆæ¯ï¼Œå°†ä¼šè¢«è¿™ä¸ªé›†åˆä»£ç†å¯¹è±¡çš„<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:, -objectIn&lt;Key&gt;AtIndex:, -&lt;key&gt;AtIndexes:</code>è¿™äº›æ–¹æ³•å…±åŒå¤„ç†ã€‚å¦‚æœè¿™ä¸ªä»£ç†å¯¹è±¡ä¹Ÿå®ç°äº†å¯é€‰çš„<code>-get&lt;Key&gt;:range:</code>æ–¹æ³•ï¼Œè¿™å°†æœ‰åŠ©äºå¢å¼ºæ€§èƒ½ã€‚</li><li>å¦‚æœå­˜å–å™¨æ–¹æ³•å’Œ<code>ordered set</code>çš„ä»£ç†æ–¹æ³•æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆæœç´¢è¯¥ç±»çš„<code>-countOf&lt;Key&gt;</code>æ–¹æ³•ï¼Œè¿˜æœ‰<code>-objectIn&lt;Key&gt;AtIndex:</code>ï¼ˆå¯¹åº”è¢«<code>NSArray</code>ç±»æ‰€å®šä¹‰çš„æ–¹æ³•ï¼‰ï¼Œ<code>-&lt;key&gt;AtIndexes:</code>ï¼ˆå¯¹åº”<code>-[NSArray objectsAtIndexes:]</code>ï¼‰æ–¹æ³•ã€‚å¦‚æœ<code>-countOf&lt;Key&gt;</code>è¿™ä¸ªæ–¹æ³•è¢«æ‰¾åˆ°ï¼Œå¦å¤–ä¸¤ä¸ªæ–¹æ³•ä¸­çš„è‡³å°‘ä¸€ä¸ªè¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªèƒ½å“åº”<code>NSArray</code>æ‰€æœ‰æ–¹æ³•çš„é›†åˆä»£ç†å¯¹è±¡ä¼šè¢«è¿”å›ã€‚å‘é€ç»™åŸæ¥æ¶ˆæ¯æ¥æ”¶è€…çš„<code>-valueForKey:</code>æ¶ˆæ¯ï¼Œå°†ä¼šè¢«è¿™ä¸ªé›†åˆä»£ç†å¯¹è±¡çš„<code>-countOf&lt;Key&gt;, -objectIn&lt;Key&gt;AtIndex:, -&lt;key&gt;AtIndexes:</code>è¿™äº›æ–¹æ³•å…±åŒå¤„ç†ã€‚å¦‚æœè¿™ä¸ªä»£ç†å¯¹è±¡ä¹Ÿå®ç°äº†å¯é€‰çš„<code>-get&lt;Key&gt;:range:</code>æ–¹æ³•ï¼Œè¿™å°†æœ‰åŠ©äºå¢å¼ºæ€§èƒ½ã€‚</li><li>å¦‚æœå­˜å–å™¨æ–¹æ³•ã€<code>ordered set</code>å’Œ<code>array</code>çš„ä»£ç†æ–¹æ³•éƒ½æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆå°è¯•æœç´¢<code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;,  -memberOf&lt;Key&gt;:</code>è¿™äº›(è¢«<code>NSSet</code>ç±»æ‰€å®šä¹‰çš„)æ–¹æ³•ã€‚å¦‚æœè¿™ä¸‰ä¸ªæ–¹æ³•éƒ½èƒ½è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªèƒ½å“åº”<code>NSSet</code>æ‰€æœ‰æ–¹æ³•çš„é›†åˆä»£ç†å¯¹è±¡ä¼šè¢«è¿”å›ã€‚å‘é€ç»™åŸæ¥æ¶ˆæ¯æ¥æ”¶è€…çš„<code>-valueForKey:</code>æ¶ˆæ¯ï¼Œå°†ä¼šè¢«è¿™ä¸ªé›†åˆä»£ç†å¯¹è±¡çš„<code>countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;,  -memberOf&lt;Key&gt;:</code>è¿™äº›æ–¹æ³•å…±åŒå¤„ç†ã€‚</li><li>å¦‚æœå­˜å–å™¨æ–¹æ³•ã€<code>ordered set</code>ã€<code>array</code>ä»¥åŠ<code>set</code>çš„ä»£ç†æ–¹æ³•éƒ½æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œå€˜è‹¥æ­¤æ—¶æ¶ˆæ¯æ¥æ”¶è€…çš„<code>+accessInstanceVariablesDirectly</code>å±æ€§è¿”å›çš„æ˜¯<code>YES</code>ï¼ˆé»˜è®¤å®ç°å°±æ˜¯è¿”å›<code>YES</code>ï¼‰ï¼Œé‚£ä¹ˆæŒ‰ç…§<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>çš„é¡ºåºæœç´¢è¯¥ç±»çš„å®ä¾‹å˜é‡ã€‚å¦‚æœæ‰¾åˆ°è¿™ä¸ªå®ä¾‹å˜é‡ï¼Œé‚£ä¹ˆæŒ‰ç…§æ­¥éª¤1ä¸­çš„ç±»å‹è½¬æ¢è§„åˆ™è¿”å›è¿™ä¸ªå®ä¾‹å˜é‡çš„å€¼ã€‚</li><li>å¦åˆ™(å•¥ä¹Ÿæ²¡æ‰¾åˆ°)ï¼Œè°ƒç”¨<code>-valueForUndefinedKey:</code>æ–¹æ³•å¹¶è¿”å›ç»“æœã€‚è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡º<code>NSUndefinedKeyException</code>å¼‚å¸¸ï¼Œä¸è¿‡ä½ å¯ä»¥é‡å†™è¯¥æ–¹æ³•è‡ªè¡Œå®ç°ã€‚</li></ol><p>å…¼å®¹æ€§ï¼š</p><ul><li><p>ä¸ºäº†å‘åå…¼å®¹ï¼Œä¼šåœ¨æ­¥éª¤1ä¸­æŸ¥æ‰¾åç§°ä¸º<code>-_get&lt;Key&gt;,  -_&lt;key&gt;</code>çš„å­˜å–å™¨æ–¹æ³•ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œä¼šè¿›è¡Œè°ƒç”¨å¹¶æŒ‰ç…§æ­¥éª¤1ä¸­çš„ç±»å‹è½¬æ¢è§„åˆ™è¿”å›è°ƒç”¨çš„ç»“æœã€‚</p></li><li><p>ä»Mac OS 10.2å¼€å§‹ï¼Œæ­¥éª¤5ä¸­çš„å®ä¾‹å˜é‡æœç´¢é¡ºåºä»åŸå…ˆçš„<code>&lt;key&gt;, _&lt;key&gt;</code>æ”¹ä¸ºç°åœ¨çš„<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>ã€‚</p></li><li><p>å¦‚æœ<code>-handleQueryWithUnboundKey:</code>çš„å®ç°ä¸æ˜¯<code>NSObject</code>çš„é»˜è®¤å®ç°ï¼ˆæ¢å¥è¯è¯´ï¼Œè‡ªå·±æ‰‹åŠ¨å®ç°äº†<code>-handleQueryWithUnboundKey:</code>æ–¹æ³•ï¼‰ï¼Œé‚£åœ¨æ­¥éª¤6ä¸­ï¼Œ<code>-handleQueryWithUnboundKey:</code>æ–¹æ³•å°†ä¼šä»£æ›¿<code>-valueForUndefinedKey:</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</p></li></ul><p>è¯´å¾—æ¸…æ™°æ˜äº†ã€‚æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://image.chenyalun.com/2019/05/05/001.png" alt></p><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(key) &#123;</span><br><span class="line">        OSSpinLockLock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºç¼“å­˜getterçš„CFSeté›†åˆNSKeyValueCachedGetters</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NSKeyValueCachedGetters</span>) &#123;</span><br><span class="line">            <span class="comment">// CFSetå¯¹è±¡éœ€è¦çš„ç»“æ„ä½“å‚æ•°, å‘Šè¯‰è¿™ä¸ªé›†åˆæ€ä¹ˆç®¡ç†å®¹å™¨ä¸­çš„å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// retain\releaseæ˜¯å†…å­˜ç®¡ç† equal\hashæ˜¯å¯¹è±¡å¤„ç† copyDescriptionæ˜¯å¤åˆ¶å¤„ç†</span></span><br><span class="line">            <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            callbacks.version = kCFTypeSetCallBacks.version;</span><br><span class="line">            <span class="comment">// ä¹Ÿå¯ä»¥ç¦ç”¨æ‰retainå’Œrelease, è¿™æ ·å½“å¯¹è±¡é”€æ¯æ—¶éœ€è¦åŠæ—¶å°†å…¶ä»é›†åˆä¸­ç§»é™¤å¦åˆ™ä¼šå´©æºƒ</span></span><br><span class="line">            <span class="comment">// callbacks.retain = NULL;</span></span><br><span class="line">            <span class="comment">// callbacks.release = NULL;</span></span><br><span class="line">            callbacks.retain = kCFTypeSetCallBacks.retain;</span><br><span class="line">            callbacks.release = kCFTypeSetCallBacks.release;</span><br><span class="line">            callbacks.copyDescription = kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">            callbacks.equal = (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValueAccessorIsEqual</span>;</span><br><span class="line">            callbacks.hash = (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValueAccessorHash</span>;</span><br><span class="line">            <span class="built_in">NSKeyValueCachedGetters</span> = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>,<span class="number">0</span>,&amp;callbacks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®classã€keyå’Œhashåˆ›å»ºå”¯ä¸€çš„NSKeyValueGetterå¯¹è±¡, ä½œä¸ºä»ç¼“å­˜é›†åˆä¸­æŸ¥æ‰¾çš„"å¼•å­"</span></span><br><span class="line">        <span class="comment">// åªè¦hashValueä¸€è‡´, ä¸ç®¡å…¶ä»–å±æ€§æ˜¯å¦ä¸€è‡´, å°±å¯ä»¥åˆ¤å®šè¿™ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸€è‡´çš„</span></span><br><span class="line">        <span class="comment">// è¿™ä¹Ÿæ˜¯ä¸ºå•¥é¦–å…ˆæ ¹æ®classå’Œkey, åˆ›å»ºä¸€ä¸ª"ç®€å•"çš„finderåˆ°ç¼“å­˜é›†åˆä¸­æŸ¥æ‰¾çš„åŸå› </span></span><br><span class="line">        <span class="built_in">NSKeyValueGetter</span> *finder = [<span class="built_in">NSKeyValueGetter</span> new];</span><br><span class="line">        finder.containerClassID = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        finder.key = key;</span><br><span class="line">        finder.hashValue = <span class="built_in">CFHash</span>(key) ^ (<span class="built_in">NSUInteger</span>)(object_getClass(<span class="keyword">self</span>));</span><br><span class="line">        <span class="comment">// ç¼“å­˜é›†åˆä¸­æ˜¯å¦å«æœ‰ç‰¹å®šçš„NSKeyValueGetter</span></span><br><span class="line">        <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span> =  <span class="built_in">CFSetGetValue</span>(<span class="built_in">NSKeyValueCachedGetters</span>, finder);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">getter</span>) &#123;</span><br><span class="line">            <span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°, åˆ›å»ºgetter</span></span><br><span class="line">            <span class="keyword">getter</span> = [object_getClass(<span class="keyword">self</span>) _createValueGetterWithContainerClassID:object_getClass(<span class="keyword">self</span>) key:key];</span><br><span class="line">            <span class="comment">// è¿™é‡Œçš„getterç›¸æ¯”ä¸Šé¢çš„finderæ›´åŠ å…·ä½“è¯¦ç»†, è™½ç„¶æ ¹æ®å“ˆå¸Œæ¥è¯´, äºŒè€…æ˜¯"ç›¸åŒçš„å¯¹è±¡"</span></span><br><span class="line">            <span class="comment">// åˆ›å»ºå¥½getterå, æŠŠå®ƒæ”¾åˆ°ç¼“å­˜é›†åˆä¸­</span></span><br><span class="line">            <span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueCachedGetters</span>, <span class="keyword">getter</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        OSSpinLockUnlock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°getter, äº¤ç»™_NSGetUsingKeyValueGetterå‡½æ•°å¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> _NSGetUsingKeyValueGetter(<span class="keyword">self</span>, <span class="keyword">getter</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// keyä¸ºç©º, æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"%@: attempt to retrieve a value for a nil key"</span>,_NSMethodExceptionProem(<span class="keyword">self</span>,_cmd)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†å››ä»¶äº‹:</p><ol><li><p>å–å€¼æ—¶ï¼Œä½¿ç”¨<code>OSSpinLockLock</code>ä¿è¯çº¿ç¨‹å®‰å…¨</p></li><li><p>æ ¹æ®classå’Œkeyï¼Œç”Ÿæˆä¸€ä¸ª<code>NSKeyValueGetter</code>å¯¹è±¡ï¼Œç”¨äºå°è£…ä¿¡æ¯</p></li><li><p>å–å€¼æ—¶ï¼Œä¼šæ ¹æ®classå’Œkeyé…ç½®ä¸€ä¸ªç®€å•çš„<code>Getter</code>ï¼Œé¦–å…ˆåˆ°<code>CFSet</code>ç¼“å­˜é›†åˆä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä»¥æé«˜æŸ¥æ‰¾é€Ÿåº¦</p></li><li><p>å½“<code>key</code>ä¸å­˜åœ¨æ—¶ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸: å‚æ•°æœ‰è¯¯</p></li></ol><h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><p>å½“ç¼“å­˜é›†åˆä¸­ä¸å­˜åœ¨æ—¶ï¼Œä¾¿è¿›å…¥äº†æ›´ä¸ºå…·ä½“çš„â€œæŸ¥æ‰¾â€æµç¨‹ä¸­ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯¦ç»†çš„æŸ¥æ‰¾æµç¨‹(æ­¤å¤„å‡å®škeyä¸º"name")</span></span><br><span class="line">+ (<span class="built_in">NSKeyValueGetter</span> *)_createValueGetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueGetter</span> * <span class="keyword">getter</span> = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å­—èŠ‚é•¿åº¦</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> keyLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ•°ç»„ç”¨äºå­˜æ”¾é¦–å­—ç¬¦å¤§å†™çš„key, ä¾‹å¦‚: "Name"</span></span><br><span class="line">    <span class="keyword">char</span> keyCStrUpFirst[keyLen + <span class="number">1</span>];</span><br><span class="line">    <span class="comment">// å°†keyè½¬ä¸ºCå­—ç¬¦ä¸², å­˜å‚¨åœ¨keyCStrUpFirstæ•°ç»„ä¸­</span></span><br><span class="line">    [key getCString:keyCStrUpFirst maxLength:keyLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span> (key.length) &#123;</span><br><span class="line">        <span class="comment">// å°†å°å†™å­—æ¯è½¬ä¸ºå¤§å†™å­—æ¯</span></span><br><span class="line">        keyCStrUpFirst[<span class="number">0</span>] = toupper(keyCStrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ•°ç»„ç”¨äºå­˜æ”¾ä¸keyä¸€è‡´çš„å­—ç¬¦, ä¾‹å¦‚: "name"</span></span><br><span class="line">    <span class="keyword">char</span> keyCStr[keyLen + <span class="number">16</span>];</span><br><span class="line">    <span class="comment">// å†å°†keyè½¬ä¸ºCå­—ç¬¦ä¸², å­˜å‚¨åœ¨keyCStræ•°ç»„ä¸­</span></span><br><span class="line">    [key getCString:keyCStr maxLength:keyLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    Method getMethod = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ–¹æ³•æŒ‡é’ˆ, ä½¿ç”¨'é€»è¾‘æˆ–'å›ºå®šäº†é»˜è®¤é¡ºåº:getName==&gt;name==&gt;isName==&gt;_getName==&gt;_name</span></span><br><span class="line">    <span class="comment">// æ­¤å¤„è¯æ˜äº†æ¥å£æ–‡æ¡£ä¸­çš„ç¬¬ä¸€æ­¥</span></span><br><span class="line">    <span class="comment">// 1. Whose name matches the pattern -get&lt;Key&gt;, -&lt;key&gt;, or -is&lt;Key&gt;, in that order.</span></span><br><span class="line">    <span class="comment">// 2. For backward binary compatibility, an accessor method whose name matches the pattern -_get&lt;Key&gt;, or -_&lt;key&gt; is searched for between steps 1 and 3.</span></span><br><span class="line">    <span class="keyword">if</span>((getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"get%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"%s"</span>,keyCStr)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"is%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"_get%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"_%s"</span>,keyCStr))) &#123;</span><br><span class="line">        <span class="comment">// æˆåŠŸæ‰¾åˆ°, åˆ›å»ºNSKeyValueMethodGetterå¯¹è±¡, ä¿å­˜æ‰¾åˆ°çš„method</span></span><br><span class="line">        <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueMethodGetter</span> alloc] initWithContainerClassID:containerClassID key:key method:getMethod];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        æ²¡æœ‰æ‰¾åˆ°, è¿›å…¥ä¸‹ä¸ªæµç¨‹, å‡å®škeyä¸º"name", åˆ™:</span></span><br><span class="line"><span class="comment">        ountOf_Method å¯¹åº” countOfName</span></span><br><span class="line"><span class="comment">        ObjectIn_AtIndexMethod å¯¹åº” objectInNameAtIndex:</span></span><br><span class="line"><span class="comment">        _AtIndexesMethod å¯¹åº” nameAtIndexes:</span></span><br><span class="line"><span class="comment">        IndexIn_OfObjectMethod å¯¹åº” indexInNameOfObject:</span></span><br><span class="line"><span class="comment">        enumeratorOf_Method å¯¹åº” enumeratorOfName</span></span><br><span class="line"><span class="comment">        memberOf_Method å¯¹åº” memberOfName:</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Method ountOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"countOf%"</span>, keyCStrUpFirst);</span><br><span class="line">        Method ObjectIn_AtIndexMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"objectIn%sAtIndex:"</span>, keyCStrUpFirst);</span><br><span class="line">        Method _AtIndexesMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"%sAtIndexes:"</span>, keyCStr);</span><br><span class="line">        Method IndexIn_OfObjectMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"indexIn%sOfObject:"</span>, keyCStrUpFirst);</span><br><span class="line">        </span><br><span class="line">        Method enumeratorOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"enumeratorOf%s"</span>, keyCStrUpFirst);</span><br><span class="line">        Method memberOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"memberOf%s:"</span>, keyCStrUpFirst);</span><br><span class="line">        <span class="keyword">if</span>(ountOf_Method &amp;&amp; IndexIn_OfObjectMethod &amp;&amp; (ObjectIn_AtIndexMethod || _AtIndexesMethod)) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬äºŒæ­¥, é’ˆå¯¹NSOrderedSet, ountOf_Methodã€IndexIn_OfObjectMethodï¼Œä»¥åŠObjectIn_AtIndexMethodæˆ–è€…_AtIndexesMethodä¸­çš„ä¸€ä¸ªå­˜åœ¨(å®ç°ä»£ç†é›†åˆå¯¹è±¡)</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingOrderedSetMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingOrderedSetMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.objectAtIndex =  ObjectIn_AtIndexMethod;</span><br><span class="line">            methodSet.indexOfObject =  IndexIn_OfObjectMethod;</span><br><span class="line">            methodSet.objectsAtIndexes =  _AtIndexesMethod;</span><br><span class="line">            <span class="comment">// eg: getName:range:æ–¹æ³•(ç”¨äºå¢å¼ºæ€§èƒ½)</span></span><br><span class="line">            methodSet.getObjectsRange =  <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"get%s:range:"</span>, keyCStrUpFirst);</span><br><span class="line">            <span class="comment">// NSKeyValueNonmutatingOrderedSetMethodSetå°±æ˜¯ä¸€ä¸ªæ‹¥æœ‰å‡ ä¸ªå±æ€§çš„ç®€å•çš„å¯¹è±¡, ç”¨äºä¿å­˜countã€objectAtIndexç­‰æ–¹æ³•æŒ‡é’ˆä¿¡æ¯</span></span><br><span class="line">            <span class="comment">// æˆåŠŸæ‰¾åˆ°, åˆ›å»ºNSKeyValueCollectionGetterå¯¹è±¡, ä¿å­˜ä¿å­˜å¥½çš„methodSetå¯¹è±¡</span></span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueOrderedSet</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ountOf_Method &amp;&amp; (ObjectIn_AtIndexMethod || _AtIndexesMethod))&#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸‰æ­¥, é’ˆå¯¹NSArray, ountOf_Methodã€ä»¥åŠObjectIn_AtIndexMethodæˆ–è€…_AtIndexesMethodä¸­çš„ä¸€ä¸ªå­˜åœ¨</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingArrayMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingArrayMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.objectAtIndex =  ObjectIn_AtIndexMethod;</span><br><span class="line">            methodSet.objectsAtIndexes =  _AtIndexesMethod;</span><br><span class="line">            methodSet.getObjectsRange =  <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"get%s:range:"</span>, keyCStrUpFirst);</span><br><span class="line">            <span class="comment">// åŒæ ·çš„, æˆåŠŸæ‰¾åˆ°, åˆ›å»ºNSKeyValueCollectionGetterå¯¹è±¡,ä¿å­˜methodSet</span></span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueArray</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ountOf_Method &amp;&amp; enumeratorOf_Method &amp;&amp; memberOf_Method)&#123;</span><br><span class="line">            <span class="comment">// ç¬¬å››æ­¥, é’ˆå¯¹NSSet, ountOf_Methodã€enumeratorOf_Methodä»¥åŠmemberOf_Method</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingSetMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingSetMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.enumerator =  enumeratorOf_Method;</span><br><span class="line">            methodSet.member =  memberOf_Method;</span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueSet</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬äº”æ­¥, å¦‚æœå…è®¸ç›´æ¥è®¿é—®å®ä¾‹å˜é‡, ä¹Ÿå³accessInstanceVariablesDirectlyä¸ºYES, åˆ™ç›´æ¥å–å‡ºå®ä¾‹å˜é‡</span></span><br><span class="line">            <span class="comment">// é»˜è®¤é¡ºåºä¸º_name==&gt;_isName==&gt;name==&gt;isName</span></span><br><span class="line">            Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span>((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCStr)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCStrUpFirst)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCStr)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCStrUpFirst))</span><br><span class="line">               ) &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶ivaræœ‰å€¼, åˆ›å»ºNSKeyValueIvarGetter</span></span><br><span class="line">                <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueIvarGetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">getter</span>) &#123;</span><br><span class="line">        <span class="comment">// æœ€å, getteråˆ›å»ºå¤±è´¥, è¯´æ˜æ–¹æ³•ã€å®ä¾‹å˜é‡æŸ¥è¯¢å¤±è´¥, è¿›å…¥ä¸‹ä¸ªæµç¨‹</span></span><br><span class="line">        <span class="keyword">getter</span> = [<span class="keyword">self</span> _createValuePrimitiveGetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">getter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•è¯¦ç»†åœ°è®¾å®šäº†æŸ¥æ‰¾çš„é¡ºåºï¼Œå€¼å¾—å…³æ³¨çš„æ˜¯ï¼Œ<code>NSKeyValueMethodForPattern()</code>è¿™ä¸ªå‡½æ•°è°ƒç”¨çš„æ¬¡æ•°ç›¸å½“çš„å¤šã€‚</p><h3 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ€åä¸€æ¬¡æŸ¥æ‰¾</span></span><br><span class="line">+ (<span class="built_in">NSKeyValueGetter</span> *)_createValuePrimitiveGetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> keyCstrLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">char</span> keyCstrUpFirst[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstrUpFirst maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span>(key.length) &#123;</span><br><span class="line">        keyCstrUpFirst[<span class="number">0</span>] = toupper(keyCstrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> keyCstr[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstr maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    Method getMethod = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// åŒæ ·çš„å¥—è·¯, æŸ¥æ‰¾é¡ºåº: getPrimitiveName==&gt;primitiveName</span></span><br><span class="line">    <span class="keyword">if</span>((getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"getPrimitive%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"primitive%s"</span>, keyCstrUpFirst))</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">getter</span> =  [[<span class="built_in">NSKeyValueMethodGetter</span> alloc] initWithContainerClassID:containerClassID key:key method:getMethod];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">        Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// ç›´æ¥è®¿é—®å®ä¾‹å˜é‡</span></span><br><span class="line">        <span class="comment">// åœ¨æ–¹æ³•äºŒä¸­æ‰¾è¿‡ä¸€éäº†, ä¸ºå•¥è¿˜è¦å†æ‰¾ä¸€é?</span></span><br><span class="line">        <span class="comment">// è¯´æ˜è¦ä¹ˆæ˜¯æ ¹æœ¬æ²¡æœ‰æ‰¾åˆ°, è¦ä¹ˆæ˜¯è™½ç„¶æ‰¾åˆ°äº†, ä½†æ˜¯åœ¨åˆ›å»ºNSKeyValueIvarGetteræˆ–è€…NSKeyValueMethodGetterçš„æ—¶å€™å¤±è´¥äº†, æœ€ç»ˆçš„getterè¿˜æ˜¯nil</span></span><br><span class="line">        <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCstrUpFirst))</span><br><span class="line">            ) &#123;</span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueIvarGetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">getter</span>) &#123;</span><br><span class="line">        <span class="keyword">getter</span> = [<span class="keyword">self</span> _createOtherValueGetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">getter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è½¬å‘å¤„ç†ç»™NSKeyValueUndefinedGetterå¯¹è±¡</span></span><br><span class="line">+ (id)<span class="string">_createOtherValueGetterWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [[NSKeyValueUndefinedGetter alloc] <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">containerIsa:</span>self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•äº”"><a href="#æ–¹æ³•äº”" class="headerlink" title="æ–¹æ³•äº”"></a>æ–¹æ³•äº”</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueUndefinedGetterè´Ÿè´£è°ƒç”¨å…¶çˆ¶ç±»(NSKeyValueGetter)çš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="meta">@implementation</span> NSKeyValueUndefinedGetter</span><br><span class="line">- (id)<span class="string">initWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key <span class="string">containerIsa:</span>(Class)containerIsa &#123;</span><br><span class="line">    <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    arguments[<span class="number">0</span>] = key;</span><br><span class="line">    <span class="comment">// è°ƒç”¨valueForUndefinedKeyæ–¹æ³•, è¯¥æ–¹æ³•é»˜è®¤å®ç°æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">implementation:</span>methogetImplementation(class_getInstanceMethod(containerIsa,<span class="meta">@selector</span>(<span class="string">valueForUndefinedKey:</span>))) <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">valueForUndefinedKey:</span>) <span class="string">extraArguments:</span>arguments <span class="string">count:</span><span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•æ€ä¹ˆæŸ¥æ‰¾"><a href="#æ–¹æ³•æ€ä¹ˆæŸ¥æ‰¾" class="headerlink" title="æ–¹æ³•æ€ä¹ˆæŸ¥æ‰¾"></a>æ–¹æ³•æ€ä¹ˆæŸ¥æ‰¾</h3><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueMethodForPattern</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">NSKeyValueMethodForPattern</span><span class="params">(<span class="keyword">Class</span> <span class="keyword">class</span>, <span class="keyword">const</span> char *pattern,<span class="keyword">const</span> char *param)</span> <span class="comment">&#123;</span></span></span><br><span class="line"><span class="function"><span class="comment">    size_t paramLen = strlen(param);</span></span></span><br><span class="line"><span class="function"><span class="comment">    size_t patternLen = strlen(pattern);</span></span></span><br><span class="line"><span class="function"><span class="comment">    char selName[patternLen + paramLen * 2 + 1];</span></span></span><br><span class="line"><span class="function"><span class="comment">    snprintf(selName, (patternLen + paramLen * 2 + 1), pattern,param,param);</span></span></span><br><span class="line"><span class="function"><span class="comment">    // ä¾èµ–Runtimeçš„class_getInstanceMethod</span></span></span><br><span class="line"><span class="function"><span class="comment">    return class_getInstanceMethod(class, sel_registerName(selName));</span></span></span><br><span class="line"><span class="function"><span class="comment">&#125;</span></span></span><br></pre></td></tr></table></figure><h3 id="å®ä¾‹å˜é‡æ€ä¹ˆæŸ¥æ‰¾"><a href="#å®ä¾‹å˜é‡æ€ä¹ˆæŸ¥æ‰¾" class="headerlink" title="å®ä¾‹å˜é‡æ€ä¹ˆæŸ¥æ‰¾"></a>å®ä¾‹å˜é‡æ€ä¹ˆæŸ¥æ‰¾</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueIvarForPattern</span></span><br><span class="line"><span class="function">Ivar <span class="title">NSKeyValueIvarForPattern</span><span class="params">(Class class, <span class="keyword">const</span> <span class="keyword">char</span> *pattern,<span class="keyword">const</span> <span class="keyword">char</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> paramLen = <span class="built_in">strlen</span>(param);</span><br><span class="line">    <span class="keyword">size_t</span> patternLen = <span class="built_in">strlen</span>(pattern);</span><br><span class="line">    <span class="keyword">char</span> ivarName[paramLen + patternLen + <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(ivarName, paramLen + patternLen + <span class="number">1</span>, pattern,param);</span><br><span class="line">    <span class="comment">// ä¾èµ–Runtimeçš„class_getInstanceVariable</span></span><br><span class="line">    <span class="keyword">return</span> class_getInstanceVariable(class, ivarName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NSKeyValueMethodGetterå¦‚ä½•åˆ›å»º"><a href="#NSKeyValueMethodGetterå¦‚ä½•åˆ›å»º" class="headerlink" title="NSKeyValueMethodGetterå¦‚ä½•åˆ›å»º"></a>NSKeyValueMethodGetterå¦‚ä½•åˆ›å»º</h3><h4 id="1-NSKeyValueMethodGetteræ„é€ æ–¹æ³•ä¸­ç”ŸæˆIMP"><a href="#1-NSKeyValueMethodGetteræ„é€ æ–¹æ³•ä¸­ç”ŸæˆIMP" class="headerlink" title="1. NSKeyValueMethodGetteræ„é€ æ–¹æ³•ä¸­ç”ŸæˆIMP"></a>1. NSKeyValueMethodGetteræ„é€ æ–¹æ³•ä¸­ç”ŸæˆIMP</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSKeyValueMethodGetter</span></span></span><br><span class="line">- (<span class="keyword">id</span>)initWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key method:(Method)method &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> methodArgumentsCount = methogetNumberOfArguments(method);</span><br><span class="line">    <span class="built_in">NSUInteger</span> extraAtgumentCount = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸¤ä¸ªå‚æ•°((void (*)(id, SEL))objc_msgSend)</span></span><br><span class="line">    <span class="keyword">if</span>(methodArgumentsCount == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> *returnType = methocopyReturnType(method);</span><br><span class="line">        IMP imp = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">switch</span> (returnType[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'@'</span>: &#123;</span><br><span class="line">                <span class="comment">// è¿”å›ç±»å‹æ˜¯å¯¹è±¡æ—¶, ç›´æ¥è·å–methodçš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">                <span class="comment">// è¿˜æ˜¯ä»¥keyä¸º"name"ä¸¾ä¾‹, åˆ™æ–¹æ³•ä¸º- (NSString *)name; è¿™é‡Œç›´æ¥è·å–å…¶IMP</span></span><br><span class="line">                imp = methogetImplementation(method);</span><br><span class="line">                extraAtgumentCount = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'B'</span>: &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 // è·å–å°†BOOLç±»å‹è½¬ä¸ºNSNumberå¯¹è±¡ç±»å‹çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">                 NSNumber * _NSGetBoolValueWithMethod(id object, SEL selctor, Method method) &#123;</span></span><br><span class="line"><span class="comment">                 return [[[NSNumber alloc] initWithBool: ((BOOL (*)(id,SEL))methogetImplementation(method))(object, methogetName(method))] autorelease];</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 // æ¯”å¦‚keyä¸º"isMan", åˆ™æ–¹æ³•ä¸º - (BOOL)iaMan;</span></span><br><span class="line"><span class="comment">                 // è·å–çš„IMPä¾¿æ˜¯å°†æ™®é€šBOOLç±»å‹å€¼è½¬åŒ–ä¸ºNSNumberç±»å‹å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆ, å…¶ä»–ç±»ä¼¼</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetBoolValueWithMethod;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'C'</span>: &#123;imp = (IMP)_NSGetUnsignedCharValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'I'</span>: &#123;imp = (IMP)_NSGetUnsignedIntValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Q'</span>: &#123;imp = (IMP)_NSGetUnsignedLongLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'L'</span>: &#123;imp = (IMP)_NSGetUnsignedLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>: &#123;imp = (IMP)_NSGetUnsignedShortValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'c'</span>: &#123;imp = (IMP)_NSGetCharValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'d'</span>: &#123;imp = (IMP)_NSGetDoubleValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'f'</span>: &#123;imp = (IMP)_NSGetFloatValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'i'</span>: &#123;imp = (IMP)_NSGetIntValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'l'</span>: &#123;imp = (IMP)_NSGetLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'q'</span>: &#123;imp = (IMP)_NSGetLongLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>: &#123;imp = (IMP)_NSGetShortValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">                <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGPoint</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetPointValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">NSRange</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetRangeValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGRect</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetRectValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGSize</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetSizeValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    imp = (IMP)_NSGetValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        free(returnType);</span><br><span class="line">        <span class="keyword">if</span>(imp) &#123;</span><br><span class="line">            <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span>(extraAtgumentCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                arguments[<span class="number">0</span>] = method;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†class key selector imp method å‚æ•° å‚æ•°æ•°é‡ç­‰ä¿¡æ¯äº¤ç»™çˆ¶ç±»å¤„ç†</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">super</span> initWithContainerClassID:containerClassID key:key implementation:imp selector:methogetName(method) extraArguments:arguments count:extraAtgumentCount];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span> release];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> release];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ç”±äºKVCè¿”å›çš„ç±»å‹ä¸ºå¯¹è±¡<code>(NSObject)</code>ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ–¹æ³•è¿”å›å€¼ç±»å‹åˆ†åˆ«è¿›è¡Œåˆ¤æ–­ä»è€Œä¸º<code>Getter</code>èµ‹å€¼ä¸åŒçš„å‡½æ•°æŒ‡é’ˆã€‚ä¹Ÿå³ä»<code>BOOLã€doubleã€intã€CGSize</code>ç­‰æ™®é€šç±»å‹è½¬åŒ–ä¸º<code>NSNumberã€NSValueã€id</code>ç­‰å¯¹è±¡ç±»å‹çš„å‡½æ•°(æŒ‡é’ˆ)ã€‚</p><h4 id="2-åœ¨çˆ¶ç±»NSKeyValueAccessorä¸­-å¯¹class-key-selector-imp-method-å‚æ•°-å‚æ•°æ•°é‡ç­‰ä¿¡æ¯è¿›è¡Œä¿å­˜"><a href="#2-åœ¨çˆ¶ç±»NSKeyValueAccessorä¸­-å¯¹class-key-selector-imp-method-å‚æ•°-å‚æ•°æ•°é‡ç­‰ä¿¡æ¯è¿›è¡Œä¿å­˜" class="headerlink" title="2. åœ¨çˆ¶ç±»NSKeyValueAccessorä¸­, å¯¹class key selector imp method å‚æ•° å‚æ•°æ•°é‡ç­‰ä¿¡æ¯è¿›è¡Œä¿å­˜"></a>2. åœ¨çˆ¶ç±»<code>NSKeyValueAccessor</code>ä¸­, å¯¹<code>class key selector imp method</code> å‚æ•° å‚æ•°æ•°é‡ç­‰ä¿¡æ¯è¿›è¡Œä¿å­˜</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">@implementation NSKeyValueAccessor</span><br><span class="line">- (id)initWithContainerClassID:(id)containerClassID key:(NSString *)key implementation:(IMP)implementation selector:(SEL)selector extraArguments:(void *[<span class="number">3</span>])extraArguments <span class="built_in">count</span>:(NSUInteger)<span class="built_in">count</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (self = [super init]) &#123;</span><br><span class="line">        <span class="variable">_containerClassID</span> = containerClassID;</span><br><span class="line">        <span class="variable">_key</span> = key.copy;</span><br><span class="line">        <span class="variable">_implementation</span> = implementation;</span><br><span class="line">        <span class="variable">_selector</span> = selector;</span><br><span class="line">        </span><br><span class="line">        NSUInteger hash = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (key) &#123;</span><br><span class="line">            hash = CFHash(key);</span><br><span class="line">        &#125;</span><br><span class="line">        hash ^= (NSUInteger)containerClassID;</span><br><span class="line">        <span class="variable">_hashValue</span> = hash;</span><br><span class="line">        <span class="variable">_extraArgumentCount</span> = <span class="built_in">count</span>;</span><br><span class="line">        <span class="variable">_extraArgument1</span> = extraArguments[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_extraArgument1</span> == key) &#123;</span><br><span class="line">            <span class="variable">_extraArgument1</span> = <span class="variable">_key</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">_extraArgument2</span> = extraArguments[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_extraArgument2</span> == key) &#123;</span><br><span class="line">            <span class="variable">_extraArgument2</span> = <span class="variable">_key</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">_extraArgument3</span> = extraArguments[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><h3 id="NSKeyValueIvarGetterå¦‚ä½•åˆ›å»º"><a href="#NSKeyValueIvarGetterå¦‚ä½•åˆ›å»º" class="headerlink" title="NSKeyValueIvarGetterå¦‚ä½•åˆ›å»º"></a>NSKeyValueIvarGetterå¦‚ä½•åˆ›å»º</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key containerIsa:(Class)containerIsa ivar:(Ivar)ivar &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ivarEncoding = ivar_getTypeEncoding(ivar);</span><br><span class="line">    IMP imp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (ivarEncoding[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'@'</span>: &#123;</span><br><span class="line">            objc_ivar_memory_management_t mngment = objc_ivar_memoryUnknown;<span class="comment">//_class_getIvarMemoryManagement(containerIsa, ivar);</span></span><br><span class="line">            <span class="keyword">if</span>(mngment &lt; objc_ivar_memoryWeak) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 id _NSGetObjectGetAssignValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">                 return *(id *)object_getIvarAddress(object, ivar);</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetObjectGetAssignValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mngment == objc_ivar_memoryWeak) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 id _NSGetObjectGetWeakValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">                 return objc_loadWeak((id *)object_getIvarAddress(object, ivar));</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetObjectGetWeakValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mngment == objc_ivar_memoryUnretained) &#123;</span><br><span class="line">                imp = (IMP)_NSGetObjectGetAssignValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                imp = (IMP)_NSGetObjectGetIvarValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'C'</span>: &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             NSNumber * _NSGetUnsignedCharValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">             unsigned char value = *(unsigned char *)object_getIvarAddress(object, ivar);</span></span><br><span class="line"><span class="comment">             return [[[NSNumber alloc] initWithUnsignedChar:value] autorelease];</span></span><br><span class="line"><span class="comment">             &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            imp = (IMP)_NSGetUnsignedCharValueInIvar;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'B'</span>: &#123;imp = (IMP)_NSGetBoolValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'I'</span>: &#123;imp = (IMP)_NSGetUnsignedIntValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'L'</span>: &#123;imp = (IMP)_NSGetUnsignedLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'Q'</span>: &#123;imp = (IMP)_NSGetUnsignedLongLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'S'</span>: &#123;imp = (IMP)_NSGetUnsignedShortValueInIvar;&#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">            <span class="keyword">char</span>* idx = index(ivarEncoding, <span class="string">'='</span>);</span><br><span class="line">            <span class="keyword">if</span> (idx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                imp = (IMP)_NSGetValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGPoint</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetPointValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">NSRange</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetRangeValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGRect</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetRectValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGSize</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetSizeValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                imp = (IMP)_NSGetValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'c'</span>: &#123;imp = (IMP)_NSGetCharValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'d'</span>: &#123;imp = (IMP)_NSGetDoubleValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'f'</span>: &#123;imp = (IMP)_NSGetFloatValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'i'</span>: &#123;imp = (IMP)_NSGetIntValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'l'</span>: &#123;imp = (IMP)_NSGetLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'q'</span>: &#123;imp = (IMP)_NSGetLongLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'s'</span>: &#123;imp = (IMP)_NSGetShortValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(imp) &#123;</span><br><span class="line">        <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        arguments[<span class="number">0</span>] = ivar;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> initWithContainerClassID:containerClassID key:key implementation:imp selector:<span class="literal">NULL</span> extraArguments:arguments count:<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> release];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·åœ°ï¼Œåˆ¤æ–­å®ä¾‹å˜é‡çš„ç±»å‹ç¼–ç ï¼Œè¿›è€Œèµ‹å€¼ä¸åŒçš„IMPã€‚</p><h3 id="æ€ä¹ˆæ ¹æ®Getterå–å€¼"><a href="#æ€ä¹ˆæ ¹æ®Getterå–å€¼" class="headerlink" title="æ€ä¹ˆæ ¹æ®Getterå–å€¼"></a>æ€ä¹ˆæ ¹æ®Getterå–å€¼</h3><h4 id="1-çº¿ç¨‹æ ¡éªŒ"><a href="#1-çº¿ç¨‹æ ¡éªŒ" class="headerlink" title="1. çº¿ç¨‹æ ¡éªŒ"></a>1. çº¿ç¨‹æ ¡éªŒ</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">void NSKeyValueObservingAssertRegistrationLockNotHeld() &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">_NSKeyValueObserverRegistrationEnableLockingAssertions</span> &amp;&amp; <span class="variable">_NSKeyValueObserverRegistrationLockOwner</span> == pthreaself()) &#123;</span><br><span class="line">        <span class="built_in">assert</span>(pthreaself() != <span class="variable">_NSKeyValueObserverRegistrationLockOwner</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-ç›´æ¥è°ƒç”¨Getterä¸­å­˜å‚¨çš„æ–¹æ³•å®ç°-getter-implementation"><a href="#2-ç›´æ¥è°ƒç”¨Getterä¸­å­˜å‚¨çš„æ–¹æ³•å®ç°-getter-implementation" class="headerlink" title="2. ç›´æ¥è°ƒç”¨Getterä¸­å­˜å‚¨çš„æ–¹æ³•å®ç°(getter.implementation)"></a>2. ç›´æ¥è°ƒç”¨Getterä¸­å­˜å‚¨çš„æ–¹æ³•å®ç°(getter.implementation)</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> _NSGetUsingKeyValueGetter(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span>) &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹åˆ¤æ–­</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingAssertRegistrationLockNotHeld</span>();</span><br><span class="line">    <span class="comment">// æ ¹æ®å…¶ä»–å‚æ•°æ•°é‡extraArgumentCountåˆ†åˆ«è¿›è¡Œå‡½æ•°è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">getter</span>.extraArgumentCount) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1, <span class="keyword">getter</span>.extraArgument2);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1, <span class="keyword">getter</span>.extraArgument2, <span class="keyword">getter</span>.extraArgument3);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="valueForKeyPath"><a href="#valueForKeyPath" class="headerlink" title="valueForKeyPath:"></a>valueForKeyPath:</h2><p>å‡å®šè¿™é‡Œçš„keyPathä¸º<code>@&quot;key1.key2.key3.key4&quot;</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span>(keyPath) &#123;</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²ç¼–ç åˆ¤æ–­</span></span><br><span class="line">        <span class="built_in">CFStringEncoding</span> encoding = __CFDefaultEightBitStringEncoding;</span><br><span class="line">        <span class="keyword">if</span>(encoding == kCFStringEncodingInvalidId) &#123;</span><br><span class="line">            <span class="comment">// ç¼–ç æ— æ•ˆ kCFStringEncodingInvalidIdå°±æ˜¯ (0xffffffffU)</span></span><br><span class="line">            encoding = __CFStringComputeEightBitStringEncoding();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºCå­—ç¬¦ä¸²: "key1.key2.key3.key4"</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cStr = <span class="built_in">CFStringGetCStringPtr</span>((<span class="built_in">CFStringRef</span>)keyPath, encoding);</span><br><span class="line">        <span class="keyword">if</span>(cStr) &#123;</span><br><span class="line">            <span class="comment">// memchrå‡½æ•°:ä»å¤´å¼€å§‹æœå¯»s æ‰€æŒ‡çš„å†…å­˜å†…å®¹å‰n ä¸ªå­—èŠ‚ï¼Œç›´åˆ°å‘ç°ç¬¬ä¸€ä¸ªå€¼ä¸ºc çš„å­—èŠ‚ï¼Œåˆ™è¿”å›æŒ‡å‘è¯¥å­—èŠ‚çš„æŒ‡é’ˆ</span></span><br><span class="line">            <span class="comment">// æ‰€ä»¥æœ€åè·å–åˆ°åŒ…å«'ç‚¹ç¬¦å·'çš„åéƒ¨åˆ† å³firstDotPointersä¸º ".key2.key3.key4"</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *firstDotPointer = memchr(cStr, <span class="string">'.'</span>, keyPath.length);</span><br><span class="line">            <span class="keyword">if</span>(firstDotPointer) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œçš„subKeyæ˜¯ "key1"</span></span><br><span class="line">                <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, firstDotPointer - cStr)] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="comment">// è¿™é‡Œçš„subKeyPathLeftæ˜¯ "key2.key3.key4"</span></span><br><span class="line">                <span class="built_in">NSString</span> *subKeyPathLeft =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(firstDotPointer - cStr + <span class="number">1</span>, keyPath.length -  (firstDotPointer - cStr + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="comment">// å…ˆè·å–åˆ°subKeyçš„ç»“æœ, ç„¶åç”¨å®ƒçš„ç»“æœå†æ±‚subKeyPathLeft, è¿›å…¥é€’å½’ä¸­</span></span><br><span class="line">                <span class="keyword">id</span> value = [[<span class="keyword">self</span> valueForKey:subKey] valueForKeyPath:subKeyPathLeft];</span><br><span class="line">                [subKey release];</span><br><span class="line">                [subKeyPathLeft release];</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// firstDotPointerä¸å­˜åœ¨, è¯´æ˜keyPathä¸­æ²¡æœ‰'ç‚¹ç¬¦å·', åˆ™ç›´æ¥è°ƒç”¨valueForKey</span></span><br><span class="line">                <span class="keyword">return</span> [<span class="keyword">self</span> valueForKey:keyPath];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™é‡Œ, ä¸Šé¢ä»£ç æ²¡æœ‰return, è¯´æ˜keyPathä¸ºnilæˆ–è€…cSträ¸ºnil</span></span><br><span class="line">    <span class="built_in">NSRange</span> range = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">    <span class="keyword">if</span>(range.length) &#123;</span><br><span class="line">        <span class="comment">// range.lengthä¸ä¸º0, ä¹Ÿå³keyPathä¸­æœ‰'ç‚¹ç¬¦å·'</span></span><br><span class="line">        <span class="comment">// subKeyä¸º"key1"</span></span><br><span class="line">        <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, range.location)] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="comment">// subKeyPathLeftä¸º"key2.key3.key4"</span></span><br><span class="line">        <span class="built_in">NSString</span> *subKeyPathLeft =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(range.location + <span class="number">1</span>, keyPath.length -  (range.location + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="comment">// åŒæ ·çš„, å…ˆè·å–åˆ°subKeyçš„ç»“æœ, ç„¶åç”¨å®ƒçš„ç»“æœå†æ±‚subKeyPathLeft, è¿›å…¥é€’å½’ä¸­</span></span><br><span class="line">        <span class="keyword">id</span> value = [[<span class="keyword">self</span> valueForKey:subKey] valueForKeyPath:subKeyPathLeft];</span><br><span class="line">        [subKey release];</span><br><span class="line">        [subKeyPathLeft release];</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// keyPathä¸ºnilæˆ–è€…keyPathä¸­æ²¡æœ‰'ç‚¹ç¬¦å·', ç›´æ¥è°ƒç”¨valueForKey</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> valueForKey:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œç›¸ä¼¼çš„æŠŠkeyPathæ‹†åˆ†é€»è¾‘çš„é€»è¾‘ä¸ºå•¥è¦å†™ä¸¤ä¸ªï¼Œä¸€ä¸ªè½¬ä¸ºCå­—ç¬¦ä¸²æ‹†åˆ†ï¼Œä¸€ä¸ªç›´æ¥æ‹†åˆ†?  æ£æµ‹ä¸¤è€…çš„åŒºåˆ«ä¸»è¦æ˜¯å¯¹å­—ç¬¦ä¸²ç¼–ç çš„åˆ¤æ–­ã€‚</p><h1 id="ä¸‰ã€è®¾å€¼"><a href="#ä¸‰ã€è®¾å€¼" class="headerlink" title="ä¸‰ã€è®¾å€¼"></a>ä¸‰ã€è®¾å€¼</h1><p>è®¾å€¼çš„æµç¨‹å°±æ¯”è¾ƒç®€å•äº†ã€‚</p><blockquote><p>The default implementation of this method does the following:</p><ol><li><p>Searches the class of the receiver for an accessor method whose name matches the pattern <code>-set&lt;Key&gt;:</code>. If such a method is found the type of its parameter is checked. If the parameter type is not an object pointer type but the value is nil <code>-setNilValueForKey:</code> is invoked. The default implementation of <code>-setNilValueForKey:</code> raises an NSInvalidArgumentException, but you can override it in your application. Otherwise, if the type of the methodâ€™s parameter is an object pointer type the method is simply invoked with the value as the argument. If the type of the methodâ€™s parameter is some other type the inverse of the NSNumber/NSValue conversion done by <code>-valueForKey:</code> is performed before the method is invoked.</p></li><li><p>Otherwise (no accessor method is found), if the receiverâ€™s classâ€™ <code>+accessInstanceVariablesDirectly</code> property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern <code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;</code>, in that order. If such an instance variable is found and its type is an object pointer type the value is retained and the result is set in the instance variable, after the instance variableâ€™s old value is first released. If the instance variableâ€™s type is some other type its value is set after the same sort of conversion from NSNumber or NSValue as in step 1.</p></li><li><p>Otherwise (no accessor method or instance variable is found), invokes <code>-setValue:forUndefinedKey:</code>. The default implementation of <code>-setValue:forUndefinedKey:</code> raises an NSUndefinedKeyException, but you can override it in your application.</p></li></ol><p>Compatibility notes:</p><ul><li>For backward binary compatibility with <code>-takeValue:forKey:</code>â€˜s behavior, a method whose name matches the pattern <code>-_set&lt;Key&gt;:</code> is also recognized in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</li><li>For backward binary compatibility, -unableToSetNilForKey: will be invoked instead of <code>-setNilValueForKey:</code> in step 1, if the implementation of <code>-unableToSetNilForKey:</code> in the receiverâ€™s class is not NSObjectâ€™s.</li><li>The behavior described in step 2 is different from <code>-takeValue:forKey:</code>â€˜s, in which the instance variable search order is <code>&lt;key&gt;, _&lt;key&gt;</code>.</li><li>For backward binary compatibility with <code>-takeValue:forKey:</code>â€˜s behavior, <code>-handleTakeValue:forUnboundKey:</code> will be invoked instead of <code>-setValue:forUndefinedKey:</code> in step 3, if the implementation of <code>-handleTakeValue:forUnboundKey:</code> in the receiverâ€™s class is not NSObjectâ€™s.</li></ul></blockquote><p>ç¿»è¯‘å¦‚ä¸‹ï¼š<br>è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>æœç´¢è¯¥ç±»åç§°ä¸º<code>-set&lt;Key&gt;:</code>çš„å­˜å–å™¨æ–¹æ³•ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œæ£€æŸ¥å…¶å‚æ•°ç±»å‹ã€‚å¦‚æœå‚æ•°ä¸º<code>nil</code>ï¼Œ<code>-setNilValueForKey:</code>æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡º<code>NSInvalidArgumentException</code>å¼‚å¸¸ï¼Œä¸è¿‡ä½ å¯ä»¥é‡å†™è¯¥æ–¹æ³•è‡ªè¡Œå®ç°ã€‚å¦‚æœå‚æ•°ç±»å‹ä¸ºå¯¹è±¡ç±»å‹ï¼Œè¯¥å­˜å–å™¨æ–¹æ³•ä¼šè¢«ç›´æ¥è°ƒç”¨ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿä¼šè¢«ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœå‚æ•°èƒ½è¢«è½¬åŒ–ä¸º<code>NSNumber/NSValue</code>ç±»å‹ï¼Œå‚æ•°ä¼šåœ¨å­˜å–å™¨æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è¿›è¡Œè½¬æ¢ã€‚</li><li>å¦‚æœå­˜å–å™¨æ–¹æ³•æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œå€˜è‹¥æ­¤æ—¶æ¶ˆæ¯æ¥æ”¶è€…çš„<code>+accessInstanceVariablesDirectly</code>å±æ€§è¿”å›çš„æ˜¯<code>YES</code>ï¼Œé‚£ä¹ˆæŒ‰ç…§<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>çš„é¡ºåºæœç´¢è¯¥ç±»çš„å®ä¾‹å˜é‡ã€‚å¦‚æœæ‰¾åˆ°è¿™ä¸ªå®ä¾‹å˜é‡ï¼Œå½“å…¶ä¸ºå¯¹è±¡ç±»å‹æ—¶ï¼Œè¯¥å®ä¾‹å˜é‡ä¼šåœ¨æ—§å€¼é‡Šæ”¾ä¹‹åè¢«è®¾ç½®æ–°å€¼ã€‚å½“å…¶ä¸ºå…¶ä»–ç±»å‹æ—¶ï¼Œé‚£ä¹ˆæŒ‰ç…§æ­¥éª¤1ä¸­çš„ç±»å‹è½¬æ¢è§„åˆ™è®¾ç½®è¿™ä¸ªå®ä¾‹å˜é‡çš„å€¼ã€‚</li><li>å¦‚æœå­˜å–å™¨æ–¹æ³•å’Œå®ä¾‹å˜é‡éƒ½æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œ<code>-setValue:forUndefinedKey:</code>æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡º<code>NSUndefinedKeyException</code>å¼‚å¸¸ï¼Œä¸è¿‡ä½ å¯ä»¥é‡å†™è¯¥æ–¹æ³•è‡ªè¡Œå®ç°ã€‚</li></ol><p>å…¼å®¹æ€§ï¼š</p><ul><li>ä¸ºäº†å‘åå…¼å®¹<code>-takeValue:forKey:</code>ï¼Œåç§°ä¸º<code>-_set&lt;Key&gt;:</code>çš„æ–¹æ³•ä¹Ÿä¼šåœ¨æ­¥éª¤1ä¸­è¢«æŸ¥æ‰¾ã€‚</li><li>å¦‚æœ<code>-unableToSetNilForKey:</code>çš„å®ç°ä¸æ˜¯<code>NSObject</code>çš„é»˜è®¤å®ç°ï¼ˆæ¢å¥è¯è¯´ï¼Œè‡ªå·±æ‰‹åŠ¨å®ç°äº†<code>-unableToSetNilForKey:</code>æ–¹æ³•ï¼‰ï¼Œé‚£åœ¨æ­¥éª¤1ä¸­ï¼Œ<code>-unableToSetNilForKey:</code>æ–¹æ³•å°†ä¼šä»£æ›¿<code>-setNilValueForKey:</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</li><li>å¯¹äº<code>-takeValue:forKey:</code>ï¼Œå…¶å®ä¾‹å˜é‡çš„æŸ¥æ‰¾é¡ºåºä¸åŒäºæ­¥éª¤2æ‰€æè¿°çš„ï¼Œè°ƒç”¨å®ƒæ—¶ï¼Œå®ä¾‹å˜é‡æŸ¥æ‰¾é¡ºåºæ˜¯<code>&lt;key&gt;, _&lt;key&gt;</code>ã€‚</li><li>ä¸ºäº†å‘åå…¼å®¹<code>-takeValue:forKey:</code>ï¼Œå¦‚æœ<code>-handleTakeValue:forUnboundKey:</code>çš„å®ç°ä¸æ˜¯<code>NSObject</code>çš„é»˜è®¤å®ç°ï¼ˆæ¢å¥è¯è¯´ï¼Œè‡ªå·±æ‰‹åŠ¨å®ç°äº†<code>-handleTakeValue:forUnboundKey:</code>æ–¹æ³•ï¼‰ï¼Œé‚£åœ¨æ­¥éª¤3ä¸­ï¼Œ<code>-handleTakeValue:forUnboundKey:</code>æ–¹æ³•å°†ä¼šä»£æ›¿<code>-setValue:forUndefinedKey:</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</li></ul><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://image.chenyalun.com/2019/05/05/002.png" alt></p><h2 id="setValue"><a href="#setValue" class="headerlink" title="setValue:"></a>setValue:</h2><h3 id="æ–¹æ³•ä¸€-1"><a href="#æ–¹æ³•ä¸€-1" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><p>è¿™é‡Œä½¿ç”¨<code>NSKeyValueCachedSetters</code>ç¼“å­˜<code>setter</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡å®škeyä¸º@"name"</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="comment">// åŠ é”</span></span><br><span class="line">        OSSpinLockLock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NSKeyValueCachedSetters</span>) &#123;</span><br><span class="line">            <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            callbacks.version = kCFTypeSetCallBacks.version;</span><br><span class="line">            callbacks.retain = kCFTypeSetCallBacks.retain;</span><br><span class="line">            callbacks.release = kCFTypeSetCallBacks.release;</span><br><span class="line">            callbacks.copyDescription = kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">            callbacks.equal = (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValueAccessorIsEqual</span>;</span><br><span class="line">            callbacks.hash = (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValueAccessorHash</span>;</span><br><span class="line">            <span class="built_in">NSKeyValueCachedSetters</span> = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>,<span class="number">0</span>,&amp;callbacks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSKeyValueSetter</span> *finder = [<span class="built_in">NSKeyValueSetter</span> new];</span><br><span class="line">        finder.containerClassID = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        finder.key = key;</span><br><span class="line">        finder.hashValue = <span class="built_in">CFHash</span>((<span class="built_in">CFTypeRef</span>)key) ^ (<span class="built_in">NSUInteger</span>)(object_getClass(<span class="keyword">self</span>));</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­å–Setter</span></span><br><span class="line">        <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> =  <span class="built_in">CFSetGetValue</span>(<span class="built_in">NSKeyValueCachedSetters</span>, (<span class="keyword">void</span> *)finder);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">setter</span>) &#123;</span><br><span class="line">            <span class="keyword">setter</span> = [object_getClass(<span class="keyword">self</span>) _createValueSetterWithContainerClassID:object_getClass(<span class="keyword">self</span>) key:key];</span><br><span class="line">            <span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueCachedSetters</span>, (<span class="keyword">void</span>*)<span class="keyword">setter</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        OSSpinLockUnlock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// è®¾å€¼</span></span><br><span class="line">        _NSSetUsingKeyValueSetter(<span class="keyword">self</span>,<span class="keyword">setter</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"%@: attempt to set a value for a nil key"</span>,_NSMethodExceptionProem(<span class="keyword">self</span>,_cmd)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•äºŒ-1"><a href="#æ–¹æ³•äºŒ-1" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSKeyValueSetter</span> *)_createValueSetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> key_cstr_len = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// é¦–å­—ç¬¦å¤§å†™çš„key</span></span><br><span class="line">    <span class="keyword">char</span> key_cstr_upfirst[key_cstr_len + <span class="number">1</span>];</span><br><span class="line">    [key getCString:key_cstr_upfirst maxLength:key_cstr_len + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span> (key.length) &#123;</span><br><span class="line">        key_cstr_upfirst[<span class="number">0</span>] = toupper(key_cstr_upfirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŸæ¥çš„key</span></span><br><span class="line">    <span class="keyword">char</span> key_cstr[key_cstr_len + <span class="number">1</span>];</span><br><span class="line">    [key getCString:key_cstr maxLength:key_cstr_len + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    Method method = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾æ–¹æ³•é¡ºåº, å‡å®škeyä¸º@"name"</span></span><br><span class="line">    <span class="comment">// setName: ==&gt; _setName: ==&gt; setIsName:</span></span><br><span class="line">    <span class="keyword">if</span> ((method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"set%s:"</span>, key_cstr_upfirst)) ||</span><br><span class="line">        (method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"_set%s:"</span>, key_cstr_upfirst)) ||</span><br><span class="line">        (method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"setIs%s:"</span>, key_cstr_upfirst))</span><br><span class="line">        ) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueMethodSetter</span> alloc] initWithContainerClassID:containerClassID key:key method:method];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">        Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// å…è®¸ç›´æ¥è®¿é—®å®ä¾‹å˜é‡, æŸ¥æ‰¾é¡ºåºä¸º: _name ==&gt; _isName ==&gt; name ==&gt; isName</span></span><br><span class="line">        <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, key_cstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, key_cstr_upfirst)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, key_cstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, key_cstr_upfirst))</span><br><span class="line">            ) &#123;</span><br><span class="line">            <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueIvarSetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">setter</span>) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [<span class="keyword">self</span> _createValuePrimitiveSetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">setter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•ä¸‰-1"><a href="#æ–¹æ³•ä¸‰-1" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSKeyValueSetter</span> *)_createValuePrimitiveSetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> keyCstrLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">char</span> keyCstrUpFirst[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    [key getCString:keyCstrUpFirst maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(key.length) &#123;</span><br><span class="line">        keyCstrUpFirst[<span class="number">0</span>] = toupper(keyCstrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> keyCstr[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstr maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// å‡å®škeyä¸º@"name", æŸ¥è¯¢ setPrimitiveName:æ–¹æ³•</span></span><br><span class="line">    Method method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"setPrimitive%s:"</span>,keyCstrUpFirst);</span><br><span class="line">    <span class="keyword">if</span>(method) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueMethodSetter</span> alloc] initWithContainerClassID:containerClassID key:key method:method];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">            Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCstr)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCstr)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCstrUpFirst))</span><br><span class="line">                ) &#123;</span><br><span class="line">                <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueIvarSetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">setter</span>) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [<span class="keyword">self</span> _createOtherValueSetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">setter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•å››-1"><a href="#æ–¹æ³•å››-1" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">+ (NSKeyValueSetter *)<span class="string">_createOtherValueSetterWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [[NSKeyValueUndefinedSetter alloc] <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">containerIsa:</span>self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€ä¹ˆæ ¹æ®Setterè®¾å€¼"><a href="#æ€ä¹ˆæ ¹æ®Setterè®¾å€¼" class="headerlink" title="æ€ä¹ˆæ ¹æ®Setterè®¾å€¼"></a>æ€ä¹ˆæ ¹æ®Setterè®¾å€¼</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSSetUsingKeyValueSetter(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span>, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">setter</span>.extraArgumentCount) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector,value);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1, <span class="keyword">setter</span>.extraArgument2);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1, <span class="keyword">setter</span>.extraArgument2, <span class="keyword">setter</span>.extraArgument3);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨Setterä¸­å­˜å‚¨çš„æ–¹æ³•å®ç°(getter.implementation)ã€‚</p><h2 id="setValue-forKeyPath"><a href="#setValue-forKeyPath" class="headerlink" title="setValue:forKeyPath:"></a>setValue:forKeyPath:</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span>(keyPath) &#123;</span><br><span class="line">        <span class="built_in">CFStringEncoding</span> encoding = __CFDefaultEightBitStringEncoding;</span><br><span class="line">        <span class="keyword">if</span>(encoding == kCFStringEncodingInvalidId) &#123;</span><br><span class="line">            encoding = __CFStringComputeEightBitStringEncoding();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *keyPathCStr = <span class="built_in">CFStringGetCStringPtr</span>((<span class="built_in">CFStringRef</span>)keyPath, encoding);</span><br><span class="line">        <span class="keyword">if</span>(keyPathCStr) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *firstDotPointer = memchr(keyPathCStr, <span class="string">'.'</span>, keyPath.length);</span><br><span class="line">            <span class="keyword">if</span>(firstDotPointer) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, firstDotPointer - keyPathCStr)] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="built_in">NSString</span> *subKeyPathAfterDot =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(firstDotPointer - keyPathCStr + <span class="number">1</span>, keyPath.length -  (firstDotPointer - keyPathCStr + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">                </span><br><span class="line">                [[<span class="keyword">self</span> valueForKey:subKey] setValue:value forKeyPath:subKeyPathAfterDot];</span><br><span class="line">                </span><br><span class="line">                [subKey release];</span><br><span class="line">                [subKeyPathAfterDot release];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span> setValue:value forKey:keyPath];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSRange</span> dotRange = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">    <span class="keyword">if</span>(dotRange.length) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, dotRange.location)] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="built_in">NSString</span> *subKeyPathAfterDot =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(dotRange.location + <span class="number">1</span>, keyPath.length -  (dotRange.location + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">        </span><br><span class="line">        [[<span class="keyword">self</span> valueForKey:subKey] setValue:value forKeyPath:subKeyPathAfterDot];</span><br><span class="line">        </span><br><span class="line">        [subKey release];</span><br><span class="line">        [subKeyPathAfterDot release];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">         [<span class="keyword">self</span> setValue:value forKey:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬æ˜¯ä¸å–å€¼ç±»ä¼¼çš„é€»è¾‘ã€‚</p><h1 id="å››ã€é›†åˆå¯¹è±¡çš„KVC"><a href="#å››ã€é›†åˆå¯¹è±¡çš„KVC" class="headerlink" title="å››ã€é›†åˆå¯¹è±¡çš„KVC"></a>å››ã€é›†åˆå¯¹è±¡çš„KVC</h1><h2 id="NSArrayçš„KVC"><a href="#NSArrayçš„KVC" class="headerlink" title="NSArrayçš„KVC"></a>NSArrayçš„KVC</h2><h3 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line"><span class="comment">// è¿”å›Arrayå†…æ¯ä¸ªå¯¹è±¡çš„â€œkeyâ€å¯¹åº”å€¼ç»„æˆçš„æ•°ç»„</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// å¦‚æœkeyPathä¸­åŒ…å«é›†åˆè¿ç®—ç¬¦, åˆ™è¿”å›è¿ç®—ç»“æœ, å¦åˆ™è¿”å›Arrayå†…æ¯ä¸ªå¯¹è±¡çš„â€œkeyPathâ€å¯¹åº”å€¼ç»„æˆçš„æ•°ç»„</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="comment">// è®¾ç½®Arrayé‡Œæ¯ä¸ªå¯¹è±¡çš„keyå¯¹åº”å€¼ä¸ºvalue</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *operationKey = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// é›†åˆè¿ç®—ç¬¦:å¦‚@count, @firstObject, @lastObjectç­‰</span></span><br><span class="line">    <span class="keyword">if</span> (key.length &amp;&amp; [key characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span> &amp;&amp; (operationKey = [key substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, key.length - <span class="number">1</span>)])) &#123;</span><br><span class="line">        <span class="comment">// å»æ‰'@'ä¾¿æ˜¯operationKey</span></span><br><span class="line">        <span class="keyword">id</span> value =  [<span class="keyword">super</span> valueForKey:operationKey];</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸è‡ªèº«ç›¸ç­‰æ•°é‡çš„array</span></span><br><span class="line">        <span class="keyword">id</span> *objectsBuff = <span class="built_in">NSAllocateObjectArray</span>(<span class="keyword">self</span>.count);</span><br><span class="line">        <span class="comment">// ç°åœ¨, æŒ‡é’ˆpä¸æŒ‡é’ˆobjectsBuffæŒ‡å‘ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">id</span> *p = objectsBuff;</span><br><span class="line">        <span class="comment">// éå†è‡ªèº«</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="comment">// å–å‡ºå®¹å™¨ä¸­çš„å…ƒç´ å¯¹åº”çš„value</span></span><br><span class="line">            <span class="keyword">id</span> eachValue = [object valueForKey:key];</span><br><span class="line">            <span class="comment">// å¦‚æœeachValueä¸å­˜åœ¨, åˆ™pçš„nextæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡è®¾ç½®æˆ NSNullå®ä¾‹å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// å¦‚æœeachValueæœ‰å€¼, åˆ™pçš„nextæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡è®¾ç½®ä¸ºeachValue</span></span><br><span class="line">            *(p++) = (eachValue ? : [<span class="built_in">NSNull</span> null]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®objectsBuffåˆ›å»ºä¸€ä¸ªæ•°ç»„, è¿™ä¸ªobjectsBuffå°±æ˜¯'eachValue'çš„é›†åˆ</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå³å‡å®škeyä¸º@"name", éå†å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´ , å–å‡ºæ¯ä¸ªå…ƒç´ keyä¸º@"name"å¯¹åº”çš„å€¼, è¿™äº›å€¼çš„é›†åˆå°±æ˜¯æ•°ç»„arrayValue</span></span><br><span class="line">        <span class="built_in">NSArray</span> *arrayValue = [[[<span class="built_in">NSArray</span> alloc] initWithObjects:objectsBuff count:<span class="keyword">self</span>.count] autorelease];</span><br><span class="line">        <span class="comment">// é‡Šæ”¾objectsBuff</span></span><br><span class="line">        <span class="built_in">NSFreeObjectArray</span>(objectsBuff);</span><br><span class="line">        <span class="keyword">return</span> arrayValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="comment">// é›†åˆè¿ç®—ç¬¦: å¦‚@count, @firstObject, @"@unionOfObjects.friend.name"ç­‰</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œä»¥ @"@unionOfObjects.friend"ä¸ºä¾‹</span></span><br><span class="line">    <span class="keyword">if</span>(keyPath.length &amp;&amp; [keyPath characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span>) &#123;</span><br><span class="line">        <span class="comment">// è¯´æ˜keyPathä¸­æœ‰'@ç¬¦å·', ä¸”'@ç¬¦å·'åœ¨ç¬¬0ä¸ªä½ç½®å¤„</span></span><br><span class="line">        <span class="built_in">NSRange</span> dotRange = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">        <span class="keyword">if</span>(dotRange.length) &#123;</span><br><span class="line">            <span class="comment">// dotRange.lengthä¸ä¸º0, è¯´æ˜keyPathä¸­æœ‰'@ç¬¦å·', è€Œä¸”è¿˜æœ‰'ç‚¹ç¬¦å·'</span></span><br><span class="line">            <span class="comment">// å–å‡ºåŒ…å«è¿ç®—ç¬¦çš„é‚£éƒ¨åˆ†,å¦‚ @"unionOfObjects"</span></span><br><span class="line">            <span class="built_in">NSString</span> *operator = [keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, dotRange.location)];</span><br><span class="line">            <span class="comment">// å–å‡ºé™¤è¿ç®—ç¬¦ä¹‹å¤–çš„é‚£éƒ¨åˆ†,å¦‚ @"friend"</span></span><br><span class="line">            <span class="built_in">NSString</span> *keyPathForOperator = [keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(dotRange.location + <span class="number">1</span>, keyPath.length - (dotRange.location + <span class="number">1</span>))];</span><br><span class="line">            <span class="keyword">if</span>(keyPathForOperator) &#123;</span><br><span class="line">                <span class="comment">// è¯´æ˜å«è¿ç®—ç¬¦çš„é‚£éƒ¨åˆ†å¦‚ @"unionOfObjects" å’Œé™¤è¿ç®—ç¬¦ä¹‹å¤–çš„é‚£éƒ¨åˆ†å¦‚ @"friend" éƒ½å­˜åœ¨</span></span><br><span class="line">                <span class="built_in">NSUInteger</span> operatorCStrLength = [operator lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                <span class="keyword">char</span> operatorCStr[operatorCStrLength + <span class="number">1</span>];</span><br><span class="line">                <span class="comment">// è½¬ä¸ºCå­—ç¬¦ä¸²operatorCStr, ä¹Ÿå³ @"unionOfObjects" è½¬ä¸º "unionOfObjects"</span></span><br><span class="line">                [operator getCString:operatorCStr maxLength:operatorCStrLength + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                <span class="comment">// æŸ¥æ‰¾æ–¹æ³•, å³: "unionOfObjectsForKeyPath:"</span></span><br><span class="line">                Method operatorMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>.class, <span class="string">"%sForKeyPath:"</span>, operatorCStr);</span><br><span class="line">                <span class="keyword">if</span>(!operatorMethod) &#123;</span><br><span class="line">                    <span class="comment">// ä¸Šé¢çš„æ–¹æ³•æ²¡æ‰¾åˆ°, å°±æŸ¥æ‰¾å¸¦ä¸‹åˆ’çº¿çš„é‚£ä¸ª: "_unionOfObjectsForKeyPath:"</span></span><br><span class="line">                    operatorMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>.class, <span class="string">"_%sForKeyPath:"</span>, operatorCStr);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (operatorMethod) &#123;</span><br><span class="line">                    <span class="comment">// æŸ¥æ‰¾æˆåŠŸ, è°ƒç”¨è¿ç®—ç¬¦å¯¹åº”çš„æ–¹æ³•</span></span><br><span class="line">                    <span class="keyword">id</span> value = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>,Method,<span class="built_in">NSString</span> *))methoinvoke)(<span class="keyword">self</span>,operatorMethod,keyPathForOperator);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°, è¯´æ˜æ˜¯ä¸æ”¯æŒçš„è¿ç®—ç¬¦</span></span><br><span class="line">                    [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"[&lt;%@ %p&gt; valueForKeyPath:]: this class does not implement the %@ operation."</span>, <span class="keyword">self</span>.class,<span class="keyword">self</span>,operator];</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è¯´æ˜åªæœ‰åŒ…å«è¿ç®—ç¬¦çš„é‚£éƒ¨åˆ†å¦‚ @"friend", èµ°NSObjectçš„valueForKeyé€»è¾‘</span></span><br><span class="line">                <span class="keyword">id</span> value = [<span class="keyword">super</span> valueForKey:operator];</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// keyPathä¸­æœ‰'@ç¬¦å·', ä½†æ˜¯æ²¡æœ‰'ç‚¹ç¬¦å·', å–å‡ºé™¤'@ç¬¦å·'ä¹‹å¤–çš„key</span></span><br><span class="line">            <span class="built_in">NSString</span> *key = [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, keyPath.length - <span class="number">1</span>)] <span class="keyword">retain</span>];</span><br><span class="line">            <span class="comment">// èµ°NSObjectçš„valueForKeyé€»è¾‘</span></span><br><span class="line">            <span class="keyword">id</span> value = [<span class="keyword">super</span> valueForKey:key];</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰'@ç¬¦å·',å¯èƒ½æœ‰'ç‚¹ç¬¦å·', èµ°NSObjectçš„valueForKeyPathé€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> valueForKeyPath: keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹å®¹å™¨å†…çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½è®¾å€¼</span></span><br><span class="line">        [object setValue:value forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‚å’Œ"><a href="#æ±‚å’Œ" class="headerlink" title="æ±‚å’Œ"></a>æ±‚å’Œ</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// @sum.keyPath, ä¾‹å¦‚ @"@sum.price", ä¼ é€’åˆ°è¿™ä¸ªæ–¹æ³•ä¸­, å‚æ•°keyPathä¸º@"price"</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_sumForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSDecimal</span> resultDecimal = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">NSDecimalNumber</span> *zero = [<span class="built_in">NSDecimalNumber</span> zero];</span><br><span class="line">    <span class="keyword">if</span> (zero) resultDecimal = [zero decimalValue];</span><br><span class="line">    <span class="comment">// è¿™é‡Œä½¿ç”¨NSDecimalNumber ä¿è¯ç²¾ç¡®åº¦</span></span><br><span class="line">    <span class="built_in">NSDecimal</span> eachDecimal = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¯ä¸ªå¯¹è±¡çš„keyPath(å¦‚@"price")å¯¹åº”å€¼</span></span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            eachDecimal = [eachValue decimalValue];</span><br><span class="line">            <span class="comment">// ç´¯åŠ </span></span><br><span class="line">            <span class="built_in">NSDecimalAdd</span>(&amp;resultDecimal, &amp;resultDecimal, &amp;eachDecimal, <span class="built_in">NSRoundBankers</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDecimalNumber</span> decimalNumberWithDecimal:resultDecimal];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‚å¹³å‡å€¼"><a href="#æ±‚å¹³å‡å€¼" class="headerlink" title="æ±‚å¹³å‡å€¼"></a>æ±‚å¹³å‡å€¼</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯¹ Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”å€¼ æ±‚å¹³å‡å€¼</span></span><br><span class="line"><span class="comment">// @avg.keyPath</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_avgForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.count) &#123;</span><br><span class="line">        <span class="comment">//æ€»å’Œ / å¯¹è±¡æ•°</span></span><br><span class="line">        <span class="keyword">return</span> [(<span class="built_in">NSDecimalNumber</span>*)[<span class="keyword">self</span> _sumForKeyPath:keyPath]  decimalNumberByDividingBy:(<span class="built_in">NSDecimalNumber</span>*)[<span class="built_in">NSDecimalNumber</span> numberWithUnsignedInteger:<span class="keyword">self</span>.count]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‚æ•°é‡"><a href="#æ±‚æ•°é‡" class="headerlink" title="æ±‚æ•°é‡"></a>æ±‚æ•°é‡</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å¯¹è±¡æ•°ç›®</span></span><br><span class="line"><span class="comment">// @count</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_countForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithInteger:<span class="keyword">self</span>.count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‚æœ€å¤§å€¼"><a href="#æ±‚æœ€å¤§å€¼" class="headerlink" title="æ±‚æœ€å¤§å€¼"></a>æ±‚æœ€å¤§å€¼</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯¹ Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”å€¼ æ±‚æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">// @max.keyPath</span></span><br><span class="line">- (<span class="keyword">id</span>)_maxForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">id</span> maxValue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!maxValue) &#123;</span><br><span class="line">                maxValue = eachValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([maxValue compare:eachValue] == <span class="built_in">NSOrderedAscending</span>)&#123;</span><br><span class="line">                maxValue = eachValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maxValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‚æœ€å°å€¼"><a href="#æ±‚æœ€å°å€¼" class="headerlink" title="æ±‚æœ€å°å€¼"></a>æ±‚æœ€å°å€¼</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯¹ Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”å€¼ æ±‚æœ€å°å€¼</span></span><br><span class="line"><span class="comment">// @min.keyPath</span></span><br><span class="line">- (<span class="keyword">id</span>)_minForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">id</span> minValue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!minValue) &#123;</span><br><span class="line">                minValue = eachValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([minValue compare:eachValue] == <span class="built_in">NSOrderedDescending</span>)&#123;</span><br><span class="line">                minValue = eachValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–æ•°ç»„"><a href="#è·å–æ•°ç»„" class="headerlink" title="è·å–æ•°ç»„"></a>è·å–æ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”å€¼ ç»„æˆæ•°ç»„</span></span><br><span class="line"><span class="comment">// @unionOfObjects.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfObjectsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObject:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–å»é‡æ•°ç»„"><a href="#è·å–å»é‡æ•°ç»„" class="headerlink" title="è·å–å»é‡æ•°ç»„"></a>è·å–å»é‡æ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”å€¼ ç»„æˆå»é‡æ•°ç»„</span></span><br><span class="line"><span class="comment">// @distinctUnionOfObjects.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfObjectsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *unionArray = [<span class="keyword">self</span> _unionOfObjectsForKeyPath:keyPath];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithArray:unionArray].allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–æˆå‘˜æ•°ç»„"><a href="#è·å–æˆå‘˜æ•°ç»„" class="headerlink" title="è·å–æˆå‘˜æ•°ç»„"></a>è·å–æˆå‘˜æ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”æ•°ç»„çš„æ¯ä¸ªæˆå‘˜ ç»„æˆæ•°ç»„ è¿™é‡Œæ¯ä¸ªkeyPathå¯¹åº”å€¼æ˜¯ä¹Ÿæ˜¯æ•°ç»„ï¼Œè·å–çš„æ˜¯æ¯ä¸ªæ•°ç»„å±•å¼€åç»„æˆçš„æ€»æ•°ç»„</span></span><br><span class="line"><span class="comment">// @unionOfArrays.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfArraysForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObjectsFromArray:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–å»é‡çš„æˆå‘˜æ•°ç»„"><a href="#è·å–å»é‡çš„æˆå‘˜æ•°ç»„" class="headerlink" title="è·å–å»é‡çš„æˆå‘˜æ•°ç»„"></a>è·å–å»é‡çš„æˆå‘˜æ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”æ•°ç»„çš„æ¯ä¸ªæˆå‘˜ ç»„æˆçš„å»é‡å¤æ•°ç»„.</span></span><br><span class="line"><span class="comment">// @distinctUnionOfArrays.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfArraysForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *unionArray = [<span class="keyword">self</span> _unionOfArraysForKeyPath:keyPath];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithArray:unionArray].allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–é›†åˆæ•°ç»„"><a href="#è·å–é›†åˆæ•°ç»„" class="headerlink" title="è·å–é›†åˆæ•°ç»„"></a>è·å–é›†åˆæ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”é›†åˆçš„æ¯ä¸ªæˆå‘˜ ç»„æˆçš„æ•°ç»„. è¿™é‡Œæ¯ä¸ªkeyPathå¯¹åº”å€¼æ˜¯æ˜¯é›†åˆï¼Œè·å–çš„æ˜¯æ¯ä¸ªé›†åˆå±•å¼€åç»„æˆçš„æ€»æ•°ç»„</span></span><br><span class="line"><span class="comment">// @unionOfSets.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfSetsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObjectsFromArray:[eachValue allObjects]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–å»é‡çš„é›†åˆæ•°ç»„"><a href="#è·å–å»é‡çš„é›†åˆæ•°ç»„" class="headerlink" title="è·å–å»é‡çš„é›†åˆæ•°ç»„"></a>è·å–å»é‡çš„é›†åˆæ•°ç»„</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› Arrayä¸­æ¯ä¸ªå¯¹è±¡çš„keyPathå¯¹åº”é›†åˆçš„æ¯ä¸ªæˆå‘˜ ç»„æˆçš„å»é‡å¤æ•°ç»„.</span></span><br><span class="line"><span class="comment">// @distinctUnionOfSets.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfSetsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableSet</span> *unionSet = [<span class="built_in">NSMutableSet</span> setWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionSet unionSet:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionSet.allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="NSSetçš„KVC"><a href="#NSSetçš„KVC" class="headerlink" title="NSSetçš„KVC"></a>NSSetçš„KVC</h2><p>ä¸NSArrayçš„é€»è¾‘åŸºæœ¬ä¿æŒä¸€è‡´ã€‚</p><h2 id="NSOrderedSetçš„KVC"><a href="#NSOrderedSetçš„KVC" class="headerlink" title="NSOrderedSetçš„KVC"></a>NSOrderedSetçš„KVC</h2><p>ä¸NSArrayçš„é€»è¾‘åŸºæœ¬ä¿æŒä¸€è‡´ã€‚</p><h2 id="NSDictionaryçš„KVC"><a href="#NSDictionaryçš„KVC" class="headerlink" title="NSDictionaryçš„KVC"></a>NSDictionaryçš„KVC</h2><p>ä¸NSArrayç›¸æ¯”ï¼Œä¸»è¦åŒºåˆ«åœ¨äºï¼š</p><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">- (id)<span class="symbol">valueForKey:</span>(NSString *)key &#123;</span><br><span class="line">    NSString *operationKey = <span class="literal">nil</span>;</span><br><span class="line">    /<span class="regexp">/ keyä¸­åŒ…å«'@å­—ç¬¦', ä¸”'@å­—ç¬¦'åœ¨ç¬¬0ä½, å¦‚ @"@count"</span></span><br><span class="line"><span class="regexp">    if(key.length &amp;&amp; [key characterAtIndex:0] == '@' &amp;&amp; (operationKey = [key substringWithRange:NSMakeRange(1, key.length - 1)])) &#123;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ æ­¤æ—¶, operationKeyä¸º @"count"</span></span><br><span class="line"><span class="regexp">        return [super valueForKey:operationKey];</span></span><br><span class="line"><span class="regexp">    &#125; else &#123;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ æ²¡æœ‰'@å­—ç¬¦', èµ°å­—å…¸çš„objectForKeyé€»è¾‘</span></span><br><span class="line"><span class="regexp">        return [self objectForKey:key];</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><code>valueForKey:</code>å–å€¼é€»è¾‘å¤šäº†å¯¹<code>@</code>å­—ç¬¦çš„å¤„ç†ã€‚</p><p><code>valueForKeyPath:</code>ä¸NSArrayçš„é€»è¾‘ä¸€è‡´ã€‚</p><h1 id="äº”ã€å…¶ä»–åˆ†ç±»çš„KVC"><a href="#äº”ã€å…¶ä»–åˆ†ç±»çš„KVC" class="headerlink" title="äº”ã€å…¶ä»–åˆ†ç±»çš„KVC"></a>äº”ã€å…¶ä»–åˆ†ç±»çš„KVC</h1><h2 id="NSMutableDictionaryçš„KVC"><a href="#NSMutableDictionaryçš„KVC" class="headerlink" title="NSMutableDictionaryçš„KVC"></a>NSMutableDictionaryçš„KVC</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="meta">@implementation</span> NSMutableDictionary (NSKeyValueCoding)</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">setValue:</span>(id)value <span class="string">forKey:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(value) &#123;</span><br><span class="line">        [self <span class="string">setObject:</span>value <span class="string">forKey:</span>key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [self <span class="string">removeObjectForKey:</span>key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><p>ç›¸æ¯”ä¸»ç±»å¢åŠ çš„ç‰¹æ€§æ˜¯ï¼šåœ¨<code>NSMutableDictionary</code>ä¸­ï¼Œå¦‚æœè®¾ç½®çš„<code>value</code>ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨å°†<code>key</code>å¯¹åº”çš„<code>value</code>ç§»é™¤ã€‚</p><h2 id="NSUserDefaultsçš„KVC"><a href="#NSUserDefaultsçš„KVC" class="headerlink" title="NSUserDefaultsçš„KVC"></a>NSUserDefaultsçš„KVC</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSUserDefaults</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *subKey = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span>(key.length &amp;&amp; [key characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span> &amp;&amp; (subKey = [key substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, key.length - <span class="number">1</span>)])) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> valueForKey:subKey];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> objectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(value) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setObject:value forKey:key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>æ•´åˆäº†<code>NSDictionary</code>ä¸<code>NSMutableDictionary</code>çš„ç‰¹è‰²ã€‚</p><ol><li>å¢åŠ äº†å¯¹<code>@</code>å­—ç¬¦çš„å¤„ç†ã€‚</li><li>å¦‚æœè®¾ç½®çš„<code>value</code>ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨å°†<code>key</code>å¯¹åº”çš„<code>value</code>ç§»é™¤ã€‚</li></ol><h2 id="NSNullçš„KVC"><a href="#NSNullçš„KVC" class="headerlink" title="NSNullçš„KVC"></a>NSNullçš„KVC</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSNull</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¯¹äº<code>NSNull</code>æ¥è¯´ï¼Œæ— è®ºæ€ä¹ˆè®¾å€¼ï¼Œå–å‡ºæ¥çš„å€¼æ€»æ˜¯<code>NSNull</code>å¯¹è±¡ã€‚</p><h1 id="å…­ã€æ€»ç»“"><a href="#å…­ã€æ€»ç»“" class="headerlink" title="å…­ã€æ€»ç»“"></a>å…­ã€æ€»ç»“</h1><p>çºµè§‚å…¨æµç¨‹ï¼Œä½¿ç”¨KVCä¸ç›´æ¥ä½¿ç”¨å­˜å–å™¨ç›¸æ¯”ï¼Œé€Ÿåº¦æ–¹é¢ç¨æœ‰é€Šè‰²ï¼Œæ£æµ‹ä¸»è¦åŸå› å¦‚ä¸‹ï¼š</p><ol><li>å­—ç¬¦ä¸²å¤„ç†ã€‚å°¤å…¶æ˜¯å«æœ‰é”®è·¯å¾„çš„æ—¶å€™ï¼Œä½¿ç”¨åˆ°é€’å½’ï¼ˆå‡½æ•°è°ƒç”¨æ ˆï¼‰ã€‚ï¼ˆå½“ç„¶ï¼Œå«æœ‰<code>@</code>å­—ç¬¦çš„é›†åˆè¿ç®—ç¬¦ä¹Ÿç®—ã€‚ï¼‰</li><li>æ–¹æ³•æŸ¥æ‰¾ã€‚æµç¨‹é¢‡å¤šï¼Œå°½ç®¡æœ‰ä½¿ç”¨<code>CFSet</code>ä½œä¸ºç¼“å­˜ã€‚</li><li>è£…ç®±æ‹†ç®±ã€‚KVCè¦æ±‚è®¾å€¼å‚æ•°å’Œå–å€¼å‚æ•°å‡ä¸ºå¯¹è±¡ï¼Œè¿™å°±éœ€è¦ä¸€èˆ¬å€¼ç±»å‹å’Œå¯¹è±¡ç±»å‹çš„ç›¸äº’è½¬æ¢ã€‚</li></ol><p>è¿™ä¹Ÿæ˜¯ä¸ºå•¥ç°åœ¨å­—å…¸è½¬æ¨¡å‹éƒ½ä¸ä½¿ç”¨KVCäº†ï¼Œå‚è§<a href="https://blog.chenyalun.com/2018/12/20/è¯»ã€ŒYYModelã€/">ã€Šè¯»YYModelã€‹</a>ã€‚</p><p>KVCå¹¶æ²¡æœ‰é‚£ä¹ˆé«˜æ€§èƒ½ï¼Œé‚£ä¹ˆå°±æ— ç”¨æ­¦ä¹‹åœ°äº†å—ï¼Ÿéä¹Ÿã€‚</p><p><strong>1.è®¿é—®ç§æœ‰æˆå‘˜å˜é‡</strong><br>å¯¹äºåªç»™å‡ºå­˜å–æ–¹æ³•çš„å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨KVCç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜å˜é‡ã€‚ä¸è¿‡å¯èƒ½ä¼šç ´åå°è£…æ€§ï¼Œæ¯•ç«Ÿäººå®¶æ²¡æš´éœ²ç§æœ‰æˆå‘˜å˜é‡è¯´æ˜ä¸æƒ³è®©äººè®¿é—®ã€‚æ›´å¤šçš„å…¶å®æ˜¯ä½“ç°åœ¨å¯¹ç³»ç»Ÿåº“ä¸Šè®¿é—®ä¸Šï¼Œâ€œä¸€ä¸ç•™ç¥â€å°±ç”¨åˆ°ç§æœ‰APIäº†ï¼Œæˆ‘æ˜¯ä¹–å­©å­ï¼Œä¸æ•¢è¿™ä¹ˆç”¨ï¼Œä¸‡ä¸€è¢«è‹¹æœå‘ç°æ•´ä¸ªæ‰‹ç™¾Appå°±è¦è¢«æ‰“å›äº†ã€‚ã€‚ã€‚ä¸è¿‡éç§æœ‰APIå€’ä¹Ÿå¯ä»¥å°è¯•ä¸‹ï¼Œ<a href="https://blog.chenyalun.com/2019/04/25/è¯»ã€ŒFDFullscreenPopGestureã€/">FDFullscreenPopGesture</a>å°±ç”¨åˆ°äº†ç§æœ‰æˆå‘˜å˜é‡ï¼Œæå…¶å·§å¦™åœ°è§£å†³äº†å…¨å±ä¾§æ»‘çš„é—®é¢˜ã€‚</p><p><strong>2.é›†åˆæ“ä½œ</strong><br>åœ¨æ–‡ç« çš„ç¬¬å››éƒ¨åˆ†ã€é›†åˆå¯¹è±¡çš„KVCã€‘ï¼Œå°±å·²ç»æè¿°è¿‡ï¼Œæ±‚å’Œã€æ±‚å¹³å‡å€¼ã€å»é‡å·´æ‹‰å·´æ‹‰ï¼ŒèŠèƒœäºæ— ã€‚</p><p><strong>3.JSONè§£æ</strong><br>å‰äº›æ—¥å­ï¼Œå›¾æœè¿›è¡Œæ¡†æ¶æ”¹ç‰ˆï¼Œä¸‹å‘æ¥å£éœ€è¦å®Œå…¨é‡æ„ã€‚è¿™å¯æ˜¯ä¸ªå±é™©çš„å·¥ä½œï¼Œä»Šå¹´åç«¯å·²ç»å‡ºç°ä¸¤æ¬¡é—®é¢˜äº†ï¼Œä¸»è¦æ˜¯å­—æ®µçš„ç±»å‹å‡ºç°é”™è¯¯ï¼Œé€ æˆç«¯å¯åŠ¨çš„Crashã€‚ç«¯ä¸Šåšäº†å¤§é‡çš„é˜²æŠ¤å·¥ä½œï¼Œé˜²ä¸èƒœé˜²ï¼Œè€Œä¸”ä»£ç è¶Šæ¥è¶Šéš¾çœ‹ã€‚äºæ˜¯æˆ‘æƒ³åˆ°äº†ä½¿ç”¨KVCè§£æå­—æ®µï¼Œé‡æ–°æ•´ç†ç°æœ‰é€»è¾‘ï¼Œè„±æ•åå¤§è‡´æ˜¯è¿™æ ·ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">handleResponse:</span>(NSDictionary *)response &#123;</span><br><span class="line">    <span class="keyword">if</span> (![response <span class="string">isKindOfClass:</span>NSDictionary.<span class="keyword">class</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†è‹¹æœä¸šåŠ¡</span></span><br><span class="line">    [self <span class="string">handleAppleConfigWithResponse:</span>[response <span class="string">valueForKeyPath:</span>@<span class="string">"dataset.config1.apple"</span>]];</span><br><span class="line">    <span class="comment">// å¤„ç†é¦™è•‰ä¸šåŠ¡</span></span><br><span class="line">    [self <span class="string">handleBananaConfigWithResponse:</span>[response <span class="string">valueForKeyPath:</span>@<span class="string">"dataset.config2.banana"</span>]];</span><br><span class="line">    <span class="comment">// å¤„ç†æ©˜å­ä¸šåŠ¡</span></span><br><span class="line">    [self <span class="string">handleOrangeConfigWithResponse:</span>[response <span class="string">valueForKeyPath:</span>@<span class="string">"dataset.config3.orange"</span>]];</span><br><span class="line">    <span class="comment">/// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨keyPathå¯¹åº”åˆ°å…·ä½“çš„å¤„ç†é€»è¾‘ï¼Œä¸åŒå­—æ®µä¹‹é—´é€»è¾‘éš”ç¦»ï¼Œä¸€ä¸ªå­—æ®µå‡ºé”™ï¼Œå¹¶ä¸å½±å“å…¶ä»–å­—æ®µï¼›å­—æ®µã€æ–¹æ³•ã€é€»è¾‘ä¸€ä¸€å¯¹åº”ï¼ŒåæœŸå¢åŠ æˆ–è€…åˆ å‡å¾ˆæ–¹ä¾¿ï¼Œæ–°åŒå­¦ç†Ÿæ‚‰ä¸šåŠ¡é€»è¾‘ä¹Ÿæ¸…æ™°æ˜äº†ï¼›responseæ˜¯å­—å…¸ï¼Œä¸ä¼šå‡ºç°<code>valueForUndefinedKey</code>çš„å¼‚å¸¸ã€‚åœ¨æ¯æ¡å¤„ç†é€»è¾‘ä¸­åšç±»å‹ä¿æŠ¤å·¥ä½œï¼Œæ–¹ä¾¿reviewï¼Œä¸ä¼šé—æ¼ã€‚</p><hr><p>å¼ºçƒˆå»ºè®®é˜…è¯»ï¼š</p><blockquote><p><a href="https://myzerone.com/posts/2016/10/20/KVC(Key-Value-Coding)/" target="_blank" rel="noopener">https://myzerone.com/posts/2016/10/20/KVC(Key-Value-Coding)/</a><br><a href="https://objccn.io/issue-7-3/" target="_blank" rel="noopener">KVC å’Œ KVO</a></p></blockquote><p>æºç æ¥è‡ªï¼š<a href="https://github.com/renjinkui2719/DIS_KVC_KVO" target="_blank" rel="noopener">https://github.com/renjinkui2719/DIS_KVC_KVO</a> ã€‚æ„Ÿè°¢ä½œè€…ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™<br><a href="https://nshipster.cn/kvc-collection-operators/" target="_blank" rel="noopener">KVC Collection Operators</a><br><a href="https://www.jianshu.com/p/a50ea091e1f4" target="_blank" rel="noopener">iOS KVC</a><br><a href="http://hufeng825.github.io/2013/09/23/ios33/" target="_blank" rel="noopener">iOSå¼€å‘ä¹‹ä½ çœŸçš„äº†è§£äº†KVCå—ï¼Ÿ</a><br><a href="https://www.jianshu.com/p/938855e842e4" target="_blank" rel="noopener">KVCé›†åˆæ“ä½œç¬¦</a><br><a href="https://suhou.github.io/2017/09/29/KVCåŸç†å°è®°/" target="_blank" rel="noopener">KVCåŸç†å°è®°</a><br><a href="http://blog.cocoabit.com/ios-settter-benchmark/" target="_blank" rel="noopener">iOS å¯¹è±¡çš„ setter æ–¹æ³•æ€§èƒ½æµ‹è¯•</a> </p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; KVCæºç é˜…è¯»ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ã€ŒFDFullscreenPopGestureã€</title>
    <link href="http://blog.chenyalun.com/2019/04/25/%E8%AF%BB%E3%80%8CFDFullscreenPopGesture%E3%80%8D/"/>
    <id>http://blog.chenyalun.com/2019/04/25/è¯»ã€ŒFDFullscreenPopGestureã€/</id>
    <published>2019-04-25T11:52:23.000Z</published>
    <updated>2019-09-23T09:13:10.739Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2019.5.29 ä¿®æ”¹Method Swizzlingéƒ¨åˆ†å†…å®¹</p></blockquote><p></p><p align="center"> ä¼˜é›…åœ°å¼€å¯å…¨å±ä¾§æ»‘æ‰‹åŠ¿ã€‚ </p><br><a id="more"></a><p></p><h2 id="ä¸€ã€ä½¿ç”¨"><a href="#ä¸€ã€ä½¿ç”¨" class="headerlink" title="ä¸€ã€ä½¿ç”¨"></a>ä¸€ã€ä½¿ç”¨</h2><p>ä½œè€…ç»™UINavigationControllerå’ŒUIViewControlleréƒ½æ·»åŠ äº†åˆ†ç±»ï¼Œå¹¶è¿›è¡Œäº†é»˜è®¤çš„å‚æ•°è®¾ç½®ï¼Œå› æ­¤ä¸åšä»»ä½•é…ç½®å°±èƒ½æ‹¥æœ‰è¿™ä¸ªåŠŸèƒ½ã€‚</p><h2 id="äºŒã€åŸç†"><a href="#äºŒã€åŸç†" class="headerlink" title="äºŒã€åŸç†"></a>äºŒã€åŸç†</h2><p>ä½œè€…é€šè¿‡æ–¹æ³•äº¤æ¢ï¼Œhookåˆ°ç³»ç»ŸåŸç”Ÿpushæ–¹æ³•ä¸­çš„æ‰‹åŠ¿ä¸­çš„targetå’ŒåŠ¨ç”»è°ƒç”¨selectorï¼Œåˆ›å»ºè‡ªå·±çš„UIPanGestureRecognizerï¼Œå¹¶è®¾ç½®å®ƒçš„targetå’Œselectorã€‚</p><h2 id="ä¸‰ã€æ¥å£"><a href="#ä¸‰ã€æ¥å£" class="headerlink" title="ä¸‰ã€æ¥å£"></a>ä¸‰ã€æ¥å£</h2> <figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> UINavigationController (FDFullscreenPopGesture)</span><br><span class="line"><span class="comment">// è·å–é‡æ–°å®ç°çš„ä¾§æ»‘è¿”å›æ‰‹åŠ¿å¯¹è±¡</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong, readonly) UIPanGestureRecognizer *fd_fullscreenPopGestureRecognizer;</span><br><span class="line"><span class="comment">// æ˜¯å¦å…è®¸è§†å›¾æ§åˆ¶å™¨å•ç‹¬ç®¡ç†å®ƒå¯¹åº”çš„NavigationBaræ˜¾ç¤ºä¸éšè—.é»˜è®¤æ˜¯YES</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªéœ€è¦é…åˆè§†å›¾æ§åˆ¶å™¨çš„fd_prefersNavigationBarHiddenå±æ€§æ¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯è¯´å¦‚æœæŠŠè¿™ä¸ªå±æ€§è®¾ç½®ä¸ºNO, è§†å›¾æ§åˆ¶å™¨å¯¹åº”çš„å¯¼èˆªæ çš„éšè—ä¸å¦ä¸ç”±è§†å›¾æ§åˆ¶å™¨å†³å®š</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) BOOL fd_viewControllerBasedNavigationBarAppearanceEnabled;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line">  </span><br><span class="line"><span class="variable">@interface</span> UIViewController (FDFullscreenPopGesture)</span><br><span class="line"><span class="comment">// æ˜¯å¦ç¦ç”¨å…¨å±ä¾§æ»‘æ‰‹åŠ¿(é»˜è®¤NO)</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) BOOL fd_interactivePopDisabled;</span><br><span class="line"><span class="comment">// è¡¨æ˜å½“å‰æ§åˆ¶å™¨çš„å¯¼èˆªæ æ˜¯æ˜¾ç¤ºè¿˜æ˜¯éšè—, é»˜è®¤NO (æ˜¾ç¤ºå¯¼èˆªæ )</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) BOOL fd_prefersNavigationBarHidden;</span><br><span class="line"><span class="comment">// è®¾ç½®èƒ½å¤Ÿå“åº”ä¾§æ»‘çš„æœ€å¤§è¾¹ç•Œ(è·ç¦»)</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) CGFloat fd_interactivePopMaxAllowedInitialDistanceToLeftEdge;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€æºç é˜…è¯»"><a href="#å››ã€æºç é˜…è¯»" class="headerlink" title="å››ã€æºç é˜…è¯»"></a>å››ã€æºç é˜…è¯»</h2><h3 id="FDFullscreenPopGestureRecognizerDelegate"><a href="#FDFullscreenPopGestureRecognizerDelegate" class="headerlink" title="_FDFullscreenPopGestureRecognizerDelegate"></a>_FDFullscreenPopGestureRecognizerDelegate</h3><p><code>_FDFullscreenPopGestureRecognizerDelegate</code>å¯¹è±¡ã€‚éµå¾ª<code>UIGestureRecognizerDelegate</code>åè®®ï¼Œä¸»è¦ç”¨äºå†³å®šæ§åˆ¶å™¨æ˜¯å¦èƒ½å“åº”æ‰‹åŠ¿ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_FDFullscreenPopGestureRecognizerDelegate</span> : <span class="title">NSObject</span> &lt;<span class="title">UIGestureRecognizerDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UINavigationController</span> *navigationController;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_FDFullscreenPopGestureRecognizerDelegate</span></span></span><br><span class="line">- (<span class="built_in">BOOL</span>)gestureRecognizerShouldBegin:(<span class="built_in">UIPanGestureRecognizer</span> *)gestureRecognizer &#123;</span><br><span class="line">    <span class="comment">// æ ˆçš„æœ€é¡¶å±‚, ä¸éœ€è¦å“åº”æ‰‹åŠ¿</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.navigationController.viewControllers.count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å¼€äº†ç¦ç”¨æ‰‹åŠ¿çš„å¼€å…³</span></span><br><span class="line">    <span class="built_in">UIViewController</span> *topViewController = <span class="keyword">self</span>.navigationController.viewControllers.lastObject;</span><br><span class="line">    <span class="keyword">if</span> (topViewController.fd_interactivePopDisabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¶…è¿‡è‡ªå·±è®¾ç½®çš„left edge</span></span><br><span class="line">    <span class="built_in">CGPoint</span> beginningLocation = [gestureRecognizer locationInView:gestureRecognizer.view];</span><br><span class="line">    <span class="built_in">CGFloat</span> maxAllowedInitialDistance = topViewController.fd_interactivePopMaxAllowedInitialDistanceToLeftEdge;</span><br><span class="line">    <span class="keyword">if</span> (maxAllowedInitialDistance &gt; <span class="number">0</span> &amp;&amp; beginningLocation.x &gt; maxAllowedInitialDistance) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£åœ¨æ‰§è¡ŒTransitionåŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span>.navigationController valueForKey:<span class="string">@"_isTransitioning"</span>] boolValue]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰‹æœºæ¨ªå±çŠ¶æ€ä¸‹, é€‚é…ä¾§æ»‘æ–¹å‘</span></span><br><span class="line">    <span class="comment">// It tells you how far the touch moved since it was last reset. It resets when the touch goes down or if you reset it yourself.</span></span><br><span class="line">    <span class="built_in">CGPoint</span> translation = [gestureRecognizer translationInView:gestureRecognizer.view];</span><br><span class="line">    <span class="built_in">BOOL</span> isLeftToRight = [<span class="built_in">UIApplication</span> sharedApplication].userInterfaceLayoutDirection == <span class="built_in">UIUserInterfaceLayoutDirectionLeftToRight</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> multiplier = isLeftToRight ? <span class="number">1</span> : - <span class="number">1</span>; <span class="comment">// åªèƒ½æ˜¯ä»å·¦å‘å³æ»‘</span></span><br><span class="line">    <span class="keyword">if</span> ((translation.x * multiplier) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="UIViewController-FDFullscreenPopGesturePrivate"><a href="#UIViewController-FDFullscreenPopGesturePrivate" class="headerlink" title="UIViewController (FDFullscreenPopGesturePrivate)"></a>UIViewController (FDFullscreenPopGesturePrivate)</h3><p>UIViewControllerçš„åˆ†ç±»ã€‚ç»™å…¶æ·»åŠ å…³è”å±æ€§<code>fd_willAppearInjectBlock</code>ã€‚hook <code>viewWillAppear</code>æ–¹æ³•å¹¶åœ¨å…¶ä¸­è°ƒç”¨<code>fd_willAppearInjectBlock</code>å›è°ƒï¼Œhook <code>viewWillDisappear</code>æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­æ ¹æ®æ§åˆ¶å™¨çš„<code>fd_prefersNavigationBarHidden</code>å±æ€§æ¥è®¾ç½®çŠ¶æ€æ çš„æ˜¾ç¤ºä¸å¦ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^_FDViewControllerWillAppearInjectBlock)(<span class="built_in">UIViewController</span> *viewController, <span class="built_in">BOOL</span> animated);</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIViewController</span> (<span class="title">FDFullscreenPopGesturePrivate</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) _FDViewControllerWillAppearInjectBlock fd_willAppearInjectBlock;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">FDFullscreenPopGesturePrivate</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="comment">// æ–¹æ³•äº¤æ¢, viewWillAppearå’Œfd_viewWillAppearäº’æ¢, viewWillDisappearå’Œfd_viewWillDisappearäº’æ¢</span></span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Method viewWillAppear_originalMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(viewWillAppear:));</span><br><span class="line">        Method viewWillAppear_swizzledMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_viewWillAppear:));</span><br><span class="line">        method_exchangeImplementations(viewWillAppear_originalMethod, viewWillAppear_swizzledMethod);</span><br><span class="line">    </span><br><span class="line">        Method viewWillDisappear_originalMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(viewWillDisappear:));</span><br><span class="line">        Method viewWillDisappear_swizzledMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_viewWillDisappear:));</span><br><span class="line">        method_exchangeImplementations(viewWillDisappear_originalMethod, viewWillDisappear_swizzledMethod);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fd_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// ä¸»ç±»çš„å®ç° Forward to primary implementation.</span></span><br><span class="line">    [<span class="keyword">self</span> fd_viewWillAppear:animated];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.fd_willAppearInjectBlock) &#123;</span><br><span class="line">        <span class="keyword">self</span>.fd_willAppearInjectBlock(<span class="keyword">self</span>, animated);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fd_viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// Forward to primary implementation.</span></span><br><span class="line">    [<span class="keyword">self</span> fd_viewWillDisappear:animated];</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿä¸º0ç›¸å½“äºç›´æ¥è°ƒç”¨å¼‚æ­¥</span></span><br><span class="line">    <span class="comment">// dispatch_async(dispatch_get_main_queue(), ^&#123;&#125;);</span></span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">UIViewController</span> *viewController = <span class="keyword">self</span>.navigationController.viewControllers.lastObject;</span><br><span class="line">        <span class="comment">// viewControllerå­˜åœ¨è€Œä¸”å®ƒçš„fd_prefersNavigationBarHiddenä¸ºNO, æŠŠNavigationBaræ˜¾ç¤ºå‡ºæ¥</span></span><br><span class="line">        <span class="keyword">if</span> (viewController &amp;&amp; !viewController.fd_prefersNavigationBarHidden) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.navigationController setNavigationBarHidden:<span class="literal">NO</span> animated:<span class="literal">NO</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (_FDViewControllerWillAppearInjectBlock)fd_willAppearInjectBlock &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFd_willAppearInjectBlock:(_FDViewControllerWillAppearInjectBlock)block &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_willAppearInjectBlock), block, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="UINavigationController-FDFullscreenPopGesture"><a href="#UINavigationController-FDFullscreenPopGesture" class="headerlink" title="UINavigationController (FDFullscreenPopGesture)"></a>UINavigationController (FDFullscreenPopGesture)</h3><p>UINavigationControllerçš„åˆ†ç±»ã€‚hook<code>pushViewController:animated:</code>æ–¹æ³•ï¼Œç»™å“åº”pushæ‰‹åŠ¿çš„viewæ·»åŠ è‡ªå®šä¹‰çš„<code>fd_fullscreenPopGestureRecognizer</code>æ‰‹åŠ¿ã€‚å½“ç„¶ï¼Œ<code>fd_fullscreenPopGestureRecognizer</code>çš„targetå’Œselectorä¸pushåŸç”Ÿæ‰‹åŠ¿çš„targetåŠselectorä¿æŒä¸€è‡´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>fd_fullscreenPopGestureRecognizer</code>æ‰‹åŠ¿çš„ä»£ç†æ˜¯ä¸Šé¢çš„<code>_FDFullscreenPopGestureRecognizerDelegate</code>å¯¹è±¡ï¼Œç›®çš„æ˜¯å†³å®šæ˜¯å¦å“åº”æ‰‹åŠ¿ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UINavigationController</span> (<span class="title">FDFullscreenPopGesture</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">// Inject "-pushViewController:animated:"</span></span><br><span class="line">    <span class="comment">// äº¤æ¢pushViewControllerä¸fd_pushViewController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(pushViewController:animated:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(fd_pushViewController:animated:);</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">BOOL</span> success = class_addMethod(<span class="keyword">class</span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            class_replaceMethod(<span class="keyword">class</span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fd_pushViewController:(<span class="built_in">UIViewController</span> *)viewController</span><br><span class="line">                     animated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// ä¿è¯viewåªæ·»åŠ ä¸€æ¬¡fd_fullscreenPopGestureRecognizeræ‰‹åŠ¿</span></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.interactivePopGestureRecognizer.view.gestureRecognizers containsObject:<span class="keyword">self</span>.fd_fullscreenPopGestureRecognizer]) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add our own gesture recognizer to where the onboard screen edge pan gesture recognizer is attached to.</span></span><br><span class="line">        [<span class="keyword">self</span>.interactivePopGestureRecognizer.view addGestureRecognizer:<span class="keyword">self</span>.fd_fullscreenPopGestureRecognizer];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–ç§æœ‰å˜é‡targetå’Œselector</span></span><br><span class="line">        <span class="built_in">NSArray</span> *internalTargets = [<span class="keyword">self</span>.interactivePopGestureRecognizer valueForKey:<span class="string">@"targets"</span>];</span><br><span class="line">        <span class="keyword">id</span> internalTarget = [internalTargets.firstObject valueForKey:<span class="string">@"target"</span>];</span><br><span class="line">        SEL internalAction = <span class="built_in">NSSelectorFromString</span>(<span class="string">@"handleNavigationTransition:"</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ»‘åŠ¨æ‰‹åŠ¿çš„ä»£ç†</span></span><br><span class="line">        <span class="keyword">self</span>.fd_fullscreenPopGestureRecognizer.delegate = <span class="keyword">self</span>.fd_popGestureRecognizerDelegate;</span><br><span class="line">        [<span class="keyword">self</span>.fd_fullscreenPopGestureRecognizer addTarget:internalTarget action:internalAction];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¦ç”¨åŸç”Ÿçš„æ‰‹åŠ¿</span></span><br><span class="line">        <span class="keyword">self</span>.interactivePopGestureRecognizer.enabled = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†navigation bar çš„æ˜¾ç¤ºä¸éšè—</span></span><br><span class="line">    [<span class="keyword">self</span> fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:viewController];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨åŸæ¥çš„æ–¹æ³•å®ç°(åŠ ä¸€ä¸ªåˆ¤æ–­, é¿å…é‡å¤push)</span></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.viewControllers containsObject:viewController]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> fd_pushViewController:viewController animated:animated];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:(<span class="built_in">UIViewController</span> *)appearingViewController &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœfd_viewControllerBasedNavigationBarAppearanceEnabledè®¾ç½®ä¸ºNO, ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.fd_viewControllerBasedNavigationBarAppearanceEnabled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…åˆfd_prefersNavigationBarHiddenæ¥ä½¿ç”¨</span></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    _FDViewControllerWillAppearInjectBlock block = ^(<span class="built_in">UIViewController</span> *viewController, <span class="built_in">BOOL</span> animated) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf) &#123;</span><br><span class="line">            [strongSelf setNavigationBarHidden:viewController.fd_prefersNavigationBarHidden animated:animated];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®appearingViewControllerã€disappearingViewControllerçš„fd_willAppearInjectBlock</span></span><br><span class="line">    appearingViewController.fd_willAppearInjectBlock = block;</span><br><span class="line">    <span class="built_in">UIViewController</span> *disappearingViewController = <span class="keyword">self</span>.viewControllers.lastObject;</span><br><span class="line">    <span class="keyword">if</span> (disappearingViewController &amp;&amp; !disappearingViewController.fd_willAppearInjectBlock) &#123;</span><br><span class="line">        disappearingViewController.fd_willAppearInjectBlock = block;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (_FDFullscreenPopGestureRecognizerDelegate *)fd_popGestureRecognizerDelegate &#123;</span><br><span class="line">    _FDFullscreenPopGestureRecognizerDelegate *delegate = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">    <span class="comment">// åªåˆå§‹åŒ–delegateä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (!delegate) &#123;</span><br><span class="line">        delegate = [[_FDFullscreenPopGestureRecognizerDelegate alloc] init];</span><br><span class="line">        delegate.navigationController = <span class="keyword">self</span>;</span><br><span class="line">        </span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, _cmd, delegate, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delegate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIPanGestureRecognizer</span> *)fd_fullscreenPopGestureRecognizer &#123;</span><br><span class="line">    <span class="built_in">UIPanGestureRecognizer</span> *panGestureRecognizer = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">    <span class="comment">// åªåˆå§‹åŒ–panGestureRecognizerä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (!panGestureRecognizer) &#123;</span><br><span class="line">        panGestureRecognizer = [[<span class="built_in">UIPanGestureRecognizer</span> alloc] init];</span><br><span class="line">        panGestureRecognizer.maximumNumberOfTouches = <span class="number">1</span>;</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, _cmd, panGestureRecognizer, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> panGestureRecognizer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)fd_viewControllerBasedNavigationBarAppearanceEnabled &#123;</span><br><span class="line">    <span class="built_in">NSNumber</span> *number = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">    <span class="keyword">if</span> (number) &#123; <span class="comment">// BOOLå€¼è¢«å°è£…æˆå¯¹è±¡äº†</span></span><br><span class="line">        <span class="keyword">return</span> number.boolValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜è¿˜æ²¡æœ‰è®¾ç½®è¿‡å…³è”å±æ€§, æ‰‹åŠ¨è®¾ç½®</span></span><br><span class="line">    <span class="keyword">self</span>.fd_viewControllerBasedNavigationBarAppearanceEnabled = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFd_viewControllerBasedNavigationBarAppearanceEnabled:(<span class="built_in">BOOL</span>)enabled &#123;</span><br><span class="line">    SEL key = <span class="keyword">@selector</span>(fd_viewControllerBasedNavigationBarAppearanceEnabled);</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, key, @(enabled), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="UIViewController-FDFullscreenPopGesture"><a href="#UIViewController-FDFullscreenPopGesture" class="headerlink" title="UIViewController (FDFullscreenPopGesture)"></a>UIViewController (FDFullscreenPopGesture)</h3><p>UIViewControllerçš„åˆ†ç±»ã€‚ç»™å…¶æ·»åŠ å…³è”å±æ€§<code>fd_interactivePopDisabled</code>ã€<code>fd_interactivePopMaxAllowedInitialDistanceToLeftEdge</code>å’Œ<code>fd_prefersNavigationBarHidden</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">FDFullscreenPopGesture</span>)</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)fd_interactivePopDisabled &#123;</span><br><span class="line">    <span class="comment">// å…³äº_cmd: è¿™è¡Œä»£ç ç­‰ä»·äº return [objc_getAssociatedObject(self, @selector(fd_interactivePopDisabled)) boolValue];</span></span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFd_interactivePopDisabled:(<span class="built_in">BOOL</span>)disabled &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_interactivePopDisabled), @(disabled), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)fd_prefersNavigationBarHidden &#123;</span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFd_prefersNavigationBarHidden:(<span class="built_in">BOOL</span>)hidden &#123;</span><br><span class="line">    <span class="comment">// å­˜å‚¨çš„æ—¶å€™éœ€è¦æŠŠåŸºæœ¬æ•°æ®ç±»å‹åŒ…è£…æˆå¯¹è±¡ @(hidden)</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_prefersNavigationBarHidden), @(hidden), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)fd_interactivePopMaxAllowedInitialDistanceToLeftEdge &#123;</span><br><span class="line"><span class="meta">#if CGFLOAT_IS_DOUBLE // CGFLOAT_IS_DOUBLEå®: 64ä½ä¸‹æ˜¯1 å¦åˆ™0, ç‰¹åˆ«ä¸¥è°¨</span></span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) doubleValue];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) floatValue];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFd_interactivePopMaxAllowedInitialDistanceToLeftEdge:(<span class="built_in">CGFloat</span>)distance &#123;</span><br><span class="line">    SEL key = <span class="keyword">@selector</span>(fd_interactivePopMaxAllowedInitialDistanceToLeftEdge);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨@(MAX(0, distance), é€‚é…distanceè¢«å¤–ç•Œè®¾ç½®ä¸ºè´Ÿå€¼çš„æƒ…å†µ</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, key, @(MAX(<span class="number">0</span>, distance)), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€å†è°ˆMethod-Swizzling"><a href="#äº”ã€å†è°ˆMethod-Swizzling" class="headerlink" title="äº”ã€å†è°ˆMethod Swizzling"></a>äº”ã€å†è°ˆMethod Swizzling</h2><h3 id="å®ä¾‹æ–¹æ³•äº¤æ¢"><a href="#å®ä¾‹æ–¹æ³•äº¤æ¢" class="headerlink" title="å®ä¾‹æ–¹æ³•äº¤æ¢"></a>å®ä¾‹æ–¹æ³•äº¤æ¢</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@end</span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewWillAppear:(<span class="keyword">BOOL)animated </span>&#123;</span><br><span class="line">    [super viewWillAppear:animated]<span class="comment">;</span></span><br><span class="line">    NSLog(@<span class="string">"åŸå§‹çš„æ–¹æ³•å®ç°"</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController (MethodSwizzling1)</span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    static <span class="keyword">dispatch_once_t </span>onceToken<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dispatch_once(&amp;onceToken, </span>^&#123;</span><br><span class="line">        Class cls = [self class]<span class="comment">;</span></span><br><span class="line">        SEL <span class="keyword">originalSel </span>= @selector(viewWillAppear:)<span class="comment">;</span></span><br><span class="line">        SEL <span class="keyword">swizzledSel </span>= @selector(ya1_viewWillAppear:)<span class="comment">;</span></span><br><span class="line">        Method <span class="keyword">originalMethod </span>= class_getInstanceMethod(cls, <span class="keyword">originalSel);</span></span><br><span class="line"><span class="keyword"> </span>       Method <span class="keyword">swizzledMethod </span>= class_getInstanceMethod(cls, <span class="keyword">swizzledSel);</span></span><br><span class="line"><span class="keyword"> </span>       if (class_addMethod(cls, <span class="keyword">originalSel, </span>method_getImplementation(<span class="keyword">swizzledMethod), </span>method_getTypeEncoding(<span class="keyword">swizzledMethod))) </span>&#123;</span><br><span class="line">            class_replaceMethod(cls, <span class="keyword">swizzledSel, </span>method_getImplementation(<span class="keyword">originalMethod), </span>method_getTypeEncoding(<span class="keyword">originalMethod));</span></span><br><span class="line"><span class="keyword"> </span>       &#125; else &#123;</span><br><span class="line">            method_exchangeImplementations(<span class="keyword">originalMethod, </span><span class="keyword">swizzledMethod);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)ya1_viewWillAppear:(<span class="keyword">BOOL)animated </span> &#123;</span><br><span class="line">    [self ya1_viewWillAppear:animated]<span class="comment">;</span></span><br><span class="line">    NSLog(@<span class="string">"ç¬¬ä¸€æ¬¡åœ¨åˆ†ç±»é‡Œé¢äº’æ¢"</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><h3 id="ç±»æ–¹æ³•äº¤æ¢"><a href="#ç±»æ–¹æ³•äº¤æ¢" class="headerlink" title="ç±»æ–¹æ³•äº¤æ¢"></a>ç±»æ–¹æ³•äº¤æ¢</h3><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// äº¤æ¢ç±»æ–¹æ³•</span></span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        SEL originalSel = <span class="meta">@selector(a)</span>;</span><br><span class="line">        SEL swizzledSel = <span class="meta">@selector(b)</span>;</span><br><span class="line">        Class <span class="class"><span class="keyword">class</span> = <span class="title">object_getClass</span></span>(self);</span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">originalSel);</span></span></span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">swizzledSel);</span></span></span><br><span class="line">        <span class="keyword">if</span> (class_addMethod(<span class="class"><span class="keyword">class</span>, <span class="type">originalSel</span>, <span class="type">method_getImplementation</span></span>(swizzledMethod), method_getTypeEncoding(swizzledMethod))) &#123;</span><br><span class="line">            class_replaceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">swizzledSel</span>, <span class="type">method_getImplementation</span></span>(originalMethod), method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)b &#123;</span><br><span class="line">    NSLog(@<span class="string">"b"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜1ï¼šå®ä¾‹æ–¹æ³•äº¤æ¢ä¸ç±»æ–¹æ³•äº¤æ¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#é—®é¢˜1ï¼šå®ä¾‹æ–¹æ³•äº¤æ¢ä¸ç±»æ–¹æ³•äº¤æ¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="é—®é¢˜1ï¼šå®ä¾‹æ–¹æ³•äº¤æ¢ä¸ç±»æ–¹æ³•äº¤æ¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>é—®é¢˜1ï¼šå®ä¾‹æ–¹æ³•äº¤æ¢ä¸ç±»æ–¹æ³•äº¤æ¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>æ²¡æœ‰å¤§çš„å˜åŒ–ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºè·å–æ–¹æ³•æ‰€å±çš„å¯¹è±¡ä¸Šï¼Œä¸€ä¸ªè·å–çš„æ˜¯ç±»å¯¹è±¡ä¸€ä¸ªè·å–çš„æ˜¯å…ƒç±»å¯¹è±¡ã€‚å³ä¸€ä¸ªæ˜¯<code>[self class]</code>æˆ–è€…è¯´<code>[self self]</code>ï¼Œä¸€ä¸ªæ˜¯<code>object_getClass(self)</code>ï¼ˆåœ¨ç±»æ–¹æ³•loadä¸­è°ƒç”¨çš„ï¼‰ã€‚<br>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§åŒºåˆ«ï¼ŸåŸå› åœ¨äºï¼Œå®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»å¯¹è±¡ä¸­ï¼Œç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ã€‚</p><p>å†ä¸€ä¸ªï¼Œçœ‹çœ‹<code>class</code>çš„å®ç°ï¼š</p><figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)<span class="class"><span class="keyword">class</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> object_getClass(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šè®¸å¤šæ–‡ç« è¿™ä¹ˆè¯´çš„ï¼š</p><blockquote><p>object_getClassä¸self.classçš„åŒºåˆ«<br>self.class:å½“selfæ˜¯å®ä¾‹å¯¹è±¡çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯ç±»å¯¹è±¡ï¼Œå¦åˆ™åˆ™è¿”å›è‡ªèº«ã€‚<br>object_getClass:è·å¾—çš„æ˜¯isaçš„æŒ‡å‘</p></blockquote><p>è¿™ä¸ªâ€œè¿”å›è‡ªèº«â€å¾ˆå«ç³Šã€‚</p><p><code>object_getClass()</code>è·å–isaæŒ‡å‘æ¯‹åº¸ç½®ç–‘ã€‚å®ä¾‹å¯¹è±¡çš„isaæŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡çš„isaæŒ‡å‘æ ¹å…ƒç±»ï¼Œæ ¹å…ƒç±»çš„isaæŒ‡å‘å®ƒè‡ªå·±ï¼Œè€³ç†Ÿèƒ½è¯¦ã€‚</p><p>å…³é”®æ˜¯<code>class</code>ï¼ŒselfæŒ‡å‘äº†æ¶ˆæ¯çš„æ¥æ”¶è€…ï¼ˆâ€œthe object thatâ€™s received this messageâ€ï¼‰ï¼Œå¾ˆè‡ªç„¶åœ°ï¼Œå®ä¾‹æ–¹æ³•çš„æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å®ä¾‹å¯¹è±¡ï¼Œç±»æ–¹æ³•çš„æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ç±»å¯¹è±¡ã€‚æ ¹æ®ä»£ç å®ç°æ¥çœ‹ï¼Œå®ä¾‹æ–¹æ³•è°ƒç”¨<code>class</code>æ˜¯è·å–å®ä¾‹å¯¹è±¡çš„isaæŒ‡å‘ï¼Œå³ç±»å¯¹è±¡ã€‚è€Œç±»å¯¹è±¡è°ƒç”¨<code>class</code>è¿”å›çš„æ¶ˆæ¯æ¥æ”¶è€…è‡ªå·±ï¼Œ<strong>è¿™ä¸ªâ€œè‡ªèº«â€æŒ‡çš„å°±æ˜¯ç±»å¯¹è±¡</strong>ã€‚äºæ˜¯ï¼Œä¸ç®¡æ˜¯å®ä¾‹å¯¹è±¡è¿˜æ˜¯ç±»å¯¹è±¡è°ƒç”¨<code>class</code>æ–¹æ³•ï¼Œè¿”å›çš„æ€»æ˜¯ç±»å¯¹è±¡ã€‚</p><p>åŒæ ·åœ°ï¼Œåœ¨å®ä¾‹æ–¹æ³•çš„äº¤æ¢ä¸­ï¼Œè¿™å‡ ç§è·å–ç±»å¯¹è±¡çš„æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼š</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Class</span> <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">self</span>];</span><br><span class="line"><span class="keyword">Class</span> <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line"><span class="keyword">Class</span> <span class="keyword">class</span> = <span class="keyword">self</span>;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>self</code>çš„<code>self</code>æ–¹æ³•ä¹Ÿæ²¡å•¥å¥‡æ€ªçš„ï¼Œæºç æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">- (id)<span class="keyword">self</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜2ï¼šèƒ½å¦åšåˆ°å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº¤æ¢ï¼Ÿ"><a href="#é—®é¢˜2ï¼šèƒ½å¦åšåˆ°å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº¤æ¢ï¼Ÿ" class="headerlink" title="é—®é¢˜2ï¼šèƒ½å¦åšåˆ°å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº¤æ¢ï¼Ÿ"></a>é—®é¢˜2ï¼šèƒ½å¦åšåˆ°å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº¤æ¢ï¼Ÿ</h3><p>å®ä¾‹æ–¹æ³•ä¸å®ä¾‹æ–¹æ³•äº’æ¢ã€ç±»æ–¹æ³•ä¸ç±»æ–¹æ³•äº’æ¢éƒ½å¾ˆå®¹æ˜“åšåˆ°ã€‚é‚£ä¸€ä¸ªå®ä¾‹æ–¹æ³•ä¸ä¸€ä¸ªç±»æ–¹æ³•äº’æ¢ï¼Œæˆ–è€…ä¸€ä¸ªç±»æ–¹æ³•ä¸ä¸€ä¸ªå®ä¾‹æ–¹æ³•äº’æ¢å¯ä»¥åšåˆ°å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚<br>æ ¹æ®ä¸Šæ–‡è®¨è®ºï¼Œå…³é”®åœ¨äºè·å–æ–¹æ³•æ‰€å±çš„å¯¹è±¡ä¸Šï¼Œå³å·§å¦™æ§åˆ¶å¥½è·å–çš„ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å³å¯ã€‚</p><h4 id="ï¼ˆ1ï¼‰å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„å®ä¾‹æ–¹æ³•äº¤æ¢åŸå…ˆçš„ç±»æ–¹æ³•ï¼‰"><a href="#ï¼ˆ1ï¼‰å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„å®ä¾‹æ–¹æ³•äº¤æ¢åŸå…ˆçš„ç±»æ–¹æ³•ï¼‰" class="headerlink" title="ï¼ˆ1ï¼‰å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„å®ä¾‹æ–¹æ³•äº¤æ¢åŸå…ˆçš„ç±»æ–¹æ³•ï¼‰"></a>ï¼ˆ1ï¼‰å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„å®ä¾‹æ–¹æ³•äº¤æ¢åŸå…ˆçš„ç±»æ–¹æ³•ï¼‰</h4><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">SEL originalSel</span> = @selector(classMethod);</span><br><span class="line"><span class="attribute">SEL swizzledSel</span> = @selector(newInstanceMethod);</span><br><span class="line"><span class="attribute">Class originClass</span> = object_getClass(self);</span><br><span class="line"><span class="attribute">Class swizzleClass</span> = self;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰ç±»æ–¹æ³•ä¸å®ä¾‹æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„ç±»æ–¹æ³•äº¤æ¢åŸå…ˆçš„å®ä¾‹æ–¹æ³•ï¼‰"><a href="#ï¼ˆ2ï¼‰ç±»æ–¹æ³•ä¸å®ä¾‹æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„ç±»æ–¹æ³•äº¤æ¢åŸå…ˆçš„å®ä¾‹æ–¹æ³•ï¼‰" class="headerlink" title="ï¼ˆ2ï¼‰ç±»æ–¹æ³•ä¸å®ä¾‹æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„ç±»æ–¹æ³•äº¤æ¢åŸå…ˆçš„å®ä¾‹æ–¹æ³•ï¼‰"></a>ï¼ˆ2ï¼‰ç±»æ–¹æ³•ä¸å®ä¾‹æ–¹æ³•äº’æ¢ï¼ˆæ–°çš„ç±»æ–¹æ³•äº¤æ¢åŸå…ˆçš„å®ä¾‹æ–¹æ³•ï¼‰</h4><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">SEL originalSel</span> = @selector(instanceMethod);</span><br><span class="line"><span class="attribute">SEL swizzledSel</span> = @selector(newClassMethod);</span><br><span class="line"><span class="attribute">Class originClass</span> = self;</span><br><span class="line"><span class="attribute">Class swizzleClass</span> = object_getClass(self);</span><br></pre></td></tr></table></figure><p>äºŒè€…çš„å…±åŒå®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">originalMethod</span> = <span class="title">class_getInstanceMethod</span><span class="params">(originClass, originalSel)</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">swizzledMethod</span> = <span class="title">class_getInstanceMethod</span><span class="params">(swizzleClass, swizzledSel)</span>;</span></span><br><span class="line"><span class="keyword">if</span> (class_addMethod(originClass, originalSel, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod))) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">       class_replaceMethod(originClass, swizzledSel, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</span></span><br><span class="line"><span class="comment">&#125;</span> <span class="keyword">else</span> <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">       method_exchangeImplementations(originalMethod, swizzledMethod);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜3ï¼šæ–¹æ³•äºŒæ¬¡äº¤æ¢æ˜¯å¦ä¼šå½±å“ç¬¬ä¸€æ¬¡äº¤æ¢ï¼ˆé€ æˆç¬¬ä¸€æ¬¡äº¤æ¢å¤±æ•ˆï¼‰ï¼Ÿ"><a href="#é—®é¢˜3ï¼šæ–¹æ³•äºŒæ¬¡äº¤æ¢æ˜¯å¦ä¼šå½±å“ç¬¬ä¸€æ¬¡äº¤æ¢ï¼ˆé€ æˆç¬¬ä¸€æ¬¡äº¤æ¢å¤±æ•ˆï¼‰ï¼Ÿ" class="headerlink" title="é—®é¢˜3ï¼šæ–¹æ³•äºŒæ¬¡äº¤æ¢æ˜¯å¦ä¼šå½±å“ç¬¬ä¸€æ¬¡äº¤æ¢ï¼ˆé€ æˆç¬¬ä¸€æ¬¡äº¤æ¢å¤±æ•ˆï¼‰ï¼Ÿ"></a>é—®é¢˜3ï¼šæ–¹æ³•äºŒæ¬¡äº¤æ¢æ˜¯å¦ä¼šå½±å“ç¬¬ä¸€æ¬¡äº¤æ¢ï¼ˆé€ æˆç¬¬ä¸€æ¬¡äº¤æ¢å¤±æ•ˆï¼‰ï¼Ÿ</h3><p>æ¯”å¦‚ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@implementation ViewController (MethodSwizzling2)</span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    static <span class="keyword">dispatch_once_t </span>onceToken<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dispatch_once(&amp;onceToken, </span>^&#123;</span><br><span class="line">        SEL <span class="keyword">originalSel </span>= @selector(viewWillAppear:)<span class="comment">;</span></span><br><span class="line">        SEL <span class="keyword">swizzledSel </span>= @selector(ya2_viewWillAppear:)<span class="comment">;</span></span><br><span class="line">        Method <span class="keyword">originalMethod </span>= class_getInstanceMethod(self, <span class="keyword">originalSel);</span></span><br><span class="line"><span class="keyword"> </span>       Method <span class="keyword">swizzledMethod </span>= class_getInstanceMethod(self, <span class="keyword">swizzledSel);</span></span><br><span class="line"><span class="keyword"> </span>       if (class_addMethod(self, <span class="keyword">originalSel, </span>method_getImplementation(<span class="keyword">swizzledMethod), </span>method_getTypeEncoding(<span class="keyword">swizzledMethod))) </span>&#123;</span><br><span class="line">            class_replaceMethod(self, <span class="keyword">swizzledSel, </span>method_getImplementation(<span class="keyword">originalMethod), </span>method_getTypeEncoding(<span class="keyword">originalMethod));</span></span><br><span class="line"><span class="keyword"> </span>       &#125; else &#123;</span><br><span class="line">            method_exchangeImplementations(<span class="keyword">originalMethod, </span><span class="keyword">swizzledMethod);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)ya2_viewWillAppear:(<span class="keyword">BOOL)animated </span> &#123;</span><br><span class="line">    [self ya2_viewWillAppear:animated]<span class="comment">;</span></span><br><span class="line">    NSLog(@<span class="string">"ç¬¬äºŒæ¬¡åœ¨åˆ†ç±»é‡Œé¢äº’æ¢"</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ä¸ä¼šã€‚</p><p>åŸå› : <code>Compile Sources</code>ä¸­è®¾å®šäº†åˆ†ç±»çš„ç¼–è¯‘é¡ºåºä¸º<code>ViewController+MethodSwizzling.m --&gt; ViewController+MethodSwizzling2.m</code>ï¼Œ<code>load</code>æ–¹æ³•çš„è°ƒç”¨é¡ºåºä¹Ÿæ˜¯è¿™æ ·ã€‚æœ€æ–°å…ˆè°ƒç”¨ä¸»ç±»çš„<code>viewWillAppear:</code>æ–¹æ³•ä¸å¿…å¤šè¯´ï¼Œæ¥ç€è°ƒç”¨åˆ†ç±»<code>ViewController+MethodSwizzling</code>ä¸­çš„æ–¹æ³•äº’æ¢é€»è¾‘ï¼Œä½¿å¾—ç¬¬ä¸€æ¬¡æ–¹æ³•äº’æ¢æˆåŠŸã€‚ç´§æ¥ç€è°ƒç”¨åˆ†ç±»<code>ViewController+MethodSwizzling2</code>ä¸­çš„æ–¹æ³•äº’æ¢é€»è¾‘ï¼Œè¿™ä¸ªä¸ä¼šå½±å“ç¬¬ä¸€æ¬¡æ–¹æ³•äº’æ¢çš„é€»è¾‘ï¼Œç›¸å½“äºåœ¨ç¬¬ä¸€æ¬¡çš„æ–¹æ³•äº’æ¢ä¹‹åå†äº’æ¢ä¸€æ¬¡ã€‚<br><img src="https://image.chenyalun.com/2019/04/23/001.png" style="zoom:50%"></p><p>ç¬¬ä¸€æ¬¡: <code>ya_viewWillAppear</code>çš„å®ç°ä¸<code>viewWillAppear</code>çš„å®ç°äº’æ¢<br>ç¬¬äºŒæ¬¡: <code>ya2_viewWillAppear</code>çš„å®ç°ä¸<code>ya_viewWillAppear</code>çš„å®ç°äº’æ¢ï¼Œå› ä¸º<code>viewWillAppear</code>çš„å®ç°è¢«<code>ya_viewWillAppear</code>ä»£æ›¿äº†ã€‚æ‰€ä»¥ä¸»ç±»å’Œå„ä¸ªåˆ†ç±»çš„æ–¹æ³•éƒ½è¢«æ¸…æ™°åœ°è°ƒç”¨äº†ã€‚<br><img src="https://image.chenyalun.com/2019/04/23/002.png" style="zoom:50%"></p><h3 id="é—®é¢˜4ï¼šä¸ºä»€ä¹ˆéœ€è¦class-replaceMethod-å‡½æ•°"><a href="#é—®é¢˜4ï¼šä¸ºä»€ä¹ˆéœ€è¦class-replaceMethod-å‡½æ•°" class="headerlink" title="é—®é¢˜4ï¼šä¸ºä»€ä¹ˆéœ€è¦class_replaceMethod()å‡½æ•°?"></a>é—®é¢˜4ï¼šä¸ºä»€ä¹ˆéœ€è¦class_replaceMethod()å‡½æ•°?</h3><p>åŸå…ˆçš„æ–¹æ³•å­˜åœ¨(æœ‰å®ç°)ï¼Œè‡ªä¸å¿…è¯´ï¼Œä½¿ç”¨<code>method_exchangeImplementations()</code>ç›´æ¥äº¤æ¢å‡½æ•°æŒ‡é’ˆå³å¯ã€‚<br>é‚£ä¹ˆæœ‰ä¸ªé—®é¢˜ï¼Œå‡å®šåŸå…ˆçš„æ–¹æ³•ä¸å­˜åœ¨ï¼Œé‚£ç›´æ¥ä½¿ç”¨<code>class_addMethod()</code>å‡½æ•°æŠŠswizzledMethodæ–¹æ³•çš„å®ç°â€œäº¤ç»™äº†â€åŸå…ˆçš„originalMethodæ–¹æ³•ï¼Œæ­¤æ—¶åŸå…ˆçš„originalMethodæ–¹æ³•å’Œæ–°çš„swizzledMethodæ–¹æ³•éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå®ç°ï¼šswizzledMethodæ–¹æ³•çš„å®ç°ã€‚è¿›è¡Œåˆ°è¿™ä¸€æ­¥è¶³å¤Ÿäº†ï¼Œ<code>class_addMethod()</code>å‡½æ•°æ—¢åˆ¤æ–­äº†åŸå…ˆçš„æ–¹æ³•æ˜¯å¦å®ç°ï¼Œå€˜è‹¥æœªå®ç°åˆè‡ªåŠ¨æŠŠæ–°æ–¹æ³•çš„å®ç°â€œäº¤ç»™äº†â€å®ƒï¼Œå®Œå…¨è§£å†³äº†é—®é¢˜ï¼Œè¿˜éœ€è¦<code>class_replaceMethod()</code>å‡½æ•°åšå•¥?</p><p>é¦–å…ˆè¦æ˜ç¡®ï¼š<strong><code>class_addMethod()</code>çš„å®ç°ä¼šè¦†ç›–çˆ¶ç±»çš„æ–¹æ³•å®ç°ï¼Œä½†ä¸ä¼šå–ä»£æœ¬ç±»ä¸­å·²å­˜åœ¨çš„å®ç°ï¼Œå¦‚æœæœ¬ç±»ä¸­åŒ…å«ä¸€ä¸ªåŒåçš„å®ç°ï¼Œåˆ™å‡½æ•°ä¼šè¿”å›NOã€‚</strong>â€œåŸå…ˆçš„æ–¹æ³•æ²¡æœ‰å®ç°â€æœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§:è¯¥æ–¹æ³•æ˜¯ä»…ä»…å±äºè¿™ä¸ªç±»çš„ï¼Œçˆ¶ç±»æ²¡æœ‰ã€‚ç¬¬äºŒç§:è¯¥æ–¹æ³•æ˜¯ç»§æ‰¿è‡ªè¿™ä¸ªç±»çš„çˆ¶ç±»çš„ï¼Œçˆ¶ç±»ä¸­æœ‰å®ç°ï¼Œè€Œå®ƒè‡ªå·±å´æ²¡æœ‰å®ç°ã€‚<br>å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œå€˜è‹¥ä»…ä»…ä½¿ç”¨<code>class_addMethod()</code>å‡½æ•°è€Œæ²¡æœ‰ä½¿ç”¨<code>class_replaceMethod()</code>å‡½æ•°ï¼Œä¼šé€ æˆ<strong>â€œä¸¢å¤±æ‰åŸå…ˆçš„çˆ¶ç±»çš„å®ç°â€</strong>ã€‚</p><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MainObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MainObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)a &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"super-main"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AObjectç»§æ‰¿è‡ªMainObject</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AObject</span> : <span class="title">MainObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AObject</span> (<span class="title">Object</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AObject</span> (<span class="title">Object</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        SEL originalSel = <span class="keyword">@selector</span>(a);</span><br><span class="line">        SEL swizzledSel = <span class="keyword">@selector</span>(b);</span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">self</span>, originalSel);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">self</span>, swizzledSel);</span><br><span class="line">        <span class="keyword">if</span> (class_addMethod(<span class="keyword">self</span>, originalSel, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod))) &#123;</span><br><span class="line">            <span class="comment">// ä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)b &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"b-method"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨</span></span><br><span class="line">AObject *obj = [AObject new];</span><br><span class="line">[obj performSelector:<span class="keyword">@selector</span>(a)];</span><br><span class="line">[obj performSelector:<span class="keyword">@selector</span>(b)];</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œæ‰“å°äº†ä¸¤æ¬¡â€b-methodâ€ã€‚</p><blockquote><p>2019-05-29 20:01:19.934449+0800 Aaron[35973:604269] b-method<br>2019-05-29 20:01:19.934591+0800 Aaron[35973:604269] b-method</p></blockquote><p>è€Œå¦‚æœæ·»åŠ ä¸Š<code>class_replaceMethod()</code>å‡½æ•°ï¼Œå…ˆç»™originalSelæ·»åŠ ä¸ŠswizzledMethodçš„å®ç°ï¼Œå†æŠŠçˆ¶ç±»çš„å®ç°originalMethodæ›¿æ¢åˆ°swizzledSelä¸­ï¼Œè¿™æ ·çˆ¶ç±»çš„å®ç°å°±ä¼šå¾—åˆ°è°ƒç”¨:</p><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line">///......</span><br><span class="line"><span class="symbol">if</span> (class_addMethod(<span class="keyword">self, </span>originalSel, method_getImplementation(<span class="keyword">swizzledMethod), </span>method_getTypeEncoding(<span class="keyword">swizzledMethod))) </span>&#123;</span><br><span class="line">    class_replaceMethod(<span class="keyword">self, </span><span class="keyword">swizzledSel, </span>method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod))<span class="comment">;</span></span><br><span class="line">&#125; <span class="meta">else</span> &#123;</span><br><span class="line">    method_exchangeImplementations(originalMethod, <span class="keyword">swizzledMethod);</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br><span class="line"><span class="keyword">///......</span></span><br></pre></td></tr></table></figure><p>æ‰“å°ï¼š</p><blockquote><p>2019-05-29 20:06:39.298454+0800 Aaron[36191:611275] b-method<br>2019-05-29 20:06:39.298605+0800 Aaron[36191:611275] super-main</p></blockquote><p>å› æ­¤ï¼Œå½“â€œä¸»ç±»æœ¬èº«æ²¡æœ‰å®ç°éœ€è¦æ›¿æ¢çš„æ–¹æ³•ï¼Œè€Œæ˜¯ç»§æ‰¿äº†çˆ¶ç±»çš„å®ç°â€æ—¶ï¼Œæ¯”å¦‚ä¸€å¼€å§‹çš„ä¾‹å­<code>viewWillAppear</code>æ–¹æ³•ï¼Œå°±å¯ä»¥è°ƒç”¨åˆ°çˆ¶ç±»çš„å®ç°ï¼Œé¿å…å‡ºç°é—®é¢˜ã€‚å¯¹äºå®Œå…¨â€œæ— ä¸­ç”Ÿæœ‰â€çš„æ¯”å¦‚<code>aaa</code>æ–¹æ³•ï¼Œç”¨ä¸ç”¨<code>class_replaceMethod()</code>éƒ½æ— å¦¨ã€‚</p><h3 id="é—®é¢˜5ï¼šæ–¹æ³•äº¤æ¢çš„æ ‡å‡†å§¿åŠ¿ä¸ºä»€ä¹ˆæ˜¯loadæ–¹æ³•é…åˆdispatch-onceï¼Ÿ"><a href="#é—®é¢˜5ï¼šæ–¹æ³•äº¤æ¢çš„æ ‡å‡†å§¿åŠ¿ä¸ºä»€ä¹ˆæ˜¯loadæ–¹æ³•é…åˆdispatch-onceï¼Ÿ" class="headerlink" title="é—®é¢˜5ï¼šæ–¹æ³•äº¤æ¢çš„æ ‡å‡†å§¿åŠ¿ä¸ºä»€ä¹ˆæ˜¯loadæ–¹æ³•é…åˆdispatch_onceï¼Ÿ"></a>é—®é¢˜5ï¼šæ–¹æ³•äº¤æ¢çš„æ ‡å‡†å§¿åŠ¿ä¸ºä»€ä¹ˆæ˜¯loadæ–¹æ³•é…åˆdispatch_onceï¼Ÿ</h3><p>å¸¸ä¸<code>+ (void)load;</code>æ–¹æ³•åœ¨ä¸€èµ·æ¯”è¾ƒçš„æ˜¯<code>+ (void)initialize;</code>æ–¹æ³•ã€‚<br><strong>ä¸ºä»€ä¹ˆæ˜¯<code>+ (void)load;</code>æ–¹æ³•ï¼Ÿ</strong></p><ol><li><code>+ (void)load;</code>æ˜¯åœ¨è¯¥ç±»è¢«åŠ è½½åˆ°Runtimeæ—¶è°ƒç”¨çš„ï¼Œåœ¨æ‰‹åŠ¨å®ç°ä¹‹åï¼Œä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå­ç±»ä¹Ÿä¸ä¼šå¤šæ¬¡è°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³•ï¼ˆå› ä¸ºloadæ–¹æ³•æ—¶é€šè¿‡å‡½æ•°æŒ‡é’ˆç›´æ¥è°ƒç”¨ï¼Œè€Œæ™®é€šæ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯æœºåˆ¶è°ƒç”¨ã€‚ï¼‰ã€‚</li><li><code>+ (void)initialize;</code>æ˜¯åœ¨è¯¥ç±»æ”¶åˆ°ç¬¬ä¸€æ¡æ¶ˆæ¯å‰è¢«è°ƒç”¨ï¼Œå¦‚æœä¸å‘å®ƒå‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç±»æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•ï¼‰ï¼Œåˆ™è¯¥æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœä¸€ä¸ªå­ç±»æ²¡æœ‰å®ç°<code>+ (void)initialize;</code>æ–¹æ³•ï¼Œé‚£ä¹ˆçˆ¶ç±»çš„è¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨å¤šæ¬¡ã€‚</li></ol><p>å¸Œæœ›æ–¹æ³•äº¤æ¢çš„é€»è¾‘<strong>ä¸€å®šä¼šè¢«æ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥é€‰æ‹©äº†loadæ–¹æ³•ã€‚æœ€æ ¹æœ¬ä¹Ÿæœ€å…·æœ‰è¯´æœåŠ›çš„åŸå› æ˜¯initializeæ˜¯åŸºäºæ¶ˆæ¯æœºåˆ¶çš„ï¼Œå¦‚æœåœ¨ä¸»ç±»çš„initializeæ–¹æ³•ä¸­å®ç°äº†æ–¹æ³•äº¤æ¢é€»è¾‘ï¼Œåœ¨åˆ†ç±»ä¸­åˆå®ç°äº†initializeæ–¹æ³•ï¼Œç”±äºåˆ†ç±»ä¸­çš„æ–¹æ³•åœ¨å…ƒç±»å¯¹è±¡æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œæ‰€ä»¥ä¼šé€ æˆæ–¹æ³•äº¤æ¢é€»è¾‘å¹¶ä¸ä¼šç”Ÿæ•ˆã€‚è€Œloadæ–¹æ³•æ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆç›´æ¥è°ƒç”¨ï¼Œçˆ¶ç±»ã€å­ç±»ã€çˆ¶ç±»çš„åˆ†ç±»å’Œå­ç±»çš„åˆ†ç±»çš„loadæ–¹æ³•éƒ½ä¼šè¢«ä¾æ¬¡è°ƒç”¨ï¼ŒåŒæ ·çš„æƒ…å†µï¼Œæ–¹æ³•äº¤æ¢é€»è¾‘å´ä¾ç„¶ä¼šç”Ÿæ•ˆã€‚å†è€…ï¼Œå‡å®šåœ¨çˆ¶ç±»çš„initializeæ–¹æ³•ä¸­å®ç°äº†æ–¹æ³•äº¤æ¢é€»è¾‘ï¼Œå­ç±»ä¼šè°ƒç”¨çˆ¶ç±»çš„initializeæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨<code>dispatch_once</code>ï¼Œä¼šé€ æˆæ–¹æ³•äº¤æ¢é€»è¾‘å¤šæ¬¡æ‰§è¡Œã€‚è€Œloadæ–¹æ³•ï¼Œä¸éœ€è¦ä¹Ÿä¸åº”è¯¥è°ƒç”¨<code>[super load]</code>ï¼Œæ€»è€Œè¨€ä¹‹å°±æ˜¯ï¼Œâ€œinitializeæ–¹æ³•ä¼šé€ æˆæ–¹æ³•äº¤æ¢ä¸å…·å¤‡ç¨³å®šæ€§â€ã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ˜¯<code>dispatch_once</code>ï¼Ÿ</strong><br>æ­£å¸¸æƒ…å†µä¸‹loadæ–¹æ³•åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯è¦è€ƒè™‘æ‰‹åŠ¨è°ƒç”¨çš„æƒ…å†µï¼ˆä¸€èˆ¬æ¥è¯´ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼‰ï¼š<code>[ViewController load];</code>ã€‚ä½¿ç”¨dispatch_onceæ›´åŠ å®Œå¤‡åœ°ä¿è¯åªæ‰§è¡Œä¸€æ¬¡ã€‚</p><h2 id="å…­ã€è‡ªå®šä¹‰ä¾§æ»‘æ‰‹åŠ¿"><a href="#å…­ã€è‡ªå®šä¹‰ä¾§æ»‘æ‰‹åŠ¿" class="headerlink" title="å…­ã€è‡ªå®šä¹‰ä¾§æ»‘æ‰‹åŠ¿"></a>å…­ã€è‡ªå®šä¹‰ä¾§æ»‘æ‰‹åŠ¿</h2><p>é™¤äº†å…¨å±ä¾§æ»‘ä¹‹å¤–ï¼Œæœ‰äº›æƒ…å†µä¸‹éœ€è¦è‡ªå®šä¹‰ä¾§æ»‘æ‰‹åŠ¿ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨<code>UIScreenEdgePanGestureRecognizer</code>å®ç°ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="built_in">UIView</span> *orangeView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds];</span><br><span class="line">    orangeView.backgroundColor = <span class="built_in">UIColor</span>.orangeColor;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:orangeView];</span><br><span class="line">    <span class="built_in">UIScreenEdgePanGestureRecognizer</span> *pan = [[<span class="built_in">UIScreenEdgePanGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(handlePop:)];</span><br><span class="line">    pan.edges = <span class="built_in">UIRectEdgeLeft</span>;</span><br><span class="line">    [orangeView addGestureRecognizer:pan];</span><br><span class="line">    <span class="keyword">self</span>.orangeView = orangeView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handlePop:(<span class="built_in">UIScreenEdgePanGestureRecognizer</span> *)pan &#123;</span><br><span class="line">    <span class="keyword">void</span> (^setOriginX)(<span class="built_in">UIView</span> *, <span class="built_in">CGFloat</span>) = ^(<span class="built_in">UIView</span> *view, <span class="built_in">CGFloat</span> x) &#123;</span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.15</span> animations:^&#123;</span><br><span class="line">            <span class="built_in">CGRect</span> frame = view.frame;</span><br><span class="line">            frame.origin.x = x;</span><br><span class="line">            view.frame = frame;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *targetView = pan.view;</span><br><span class="line">    <span class="built_in">CGFloat</span> offsetX = [pan translationInView:targetView].x;</span><br><span class="line">    <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateChanged</span>) &#123;</span><br><span class="line">        targetView.center = <span class="built_in">CGPointMake</span>(targetView.center.x + offsetX, targetView.center.y);</span><br><span class="line">        [pan setTranslation:<span class="built_in">CGPointZero</span> inView:targetView.superview];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateEnded</span> || pan.state == <span class="built_in">UIGestureRecognizerStateCancelled</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetView.frame.origin.x / targetView.frame.size.width &gt; <span class="number">0.3</span>) &#123;</span><br><span class="line">            setOriginX(targetView, targetView.bounds.size.width);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setOriginX(targetView, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€æ€»ç»“"><a href="#ä¸ƒã€æ€»ç»“" class="headerlink" title="ä¸ƒã€æ€»ç»“"></a>ä¸ƒã€æ€»ç»“</h2><p>ä½œä¸ºFDFullscreenPopGestureçš„æºç é˜…è¯»æ–‡ç« ï¼Œå®é™…ä¸Šé‡å¿ƒå´ä¸åœ¨å®ƒè¿™ã€‚æ‹œè¯»ä¸‹æ¥ï¼Œå…¶å®éƒ½æ˜¯äº›å¸¸è§çš„ä¸œè¥¿ï¼šå…³è”å±æ€§ï¼Œæ–¹æ³•äº¤æ¢ã€‚å…¶å®è§£å†³é—®é¢˜æœ€é‡è¦çš„ï¼Œæ˜¯æ€è·¯ã€‚ä¸ç„¶å¯èƒ½è‡ªå·±å†™äº†ä¸€å¤§å †ä»£ç ï¼Œä¹Ÿä¸èƒ½å¾ˆå¥½é«˜æ•ˆåœ°è§£å†³é—®é¢˜ã€‚</p><p>ä»¥FDFullscreenPopGestureä¸ºå¼•å­ï¼Œåˆé‡ç‚¹å›é¡¾äº†æ–¹æ³•äº¤æ¢ï¼Œä½œä¸ºæ‹“å±•ï¼Œå›ç­”äº†å¼•å‡ºçš„è®¸å¤šé—®é¢˜ï¼Œåƒå®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•äº¤æ¢å®Œå…¨æ˜¯è„‘æ´æ¥çš„ï¼Œå·¥ä½œä¸­æˆ‘è¿˜æ²¡è¿™ä¹ˆç”¨è¿‡ğŸ˜‚ğŸ˜‚ã€‚æœ€åç®€å•ä»‹ç»äº†UIScreenEdgePanGestureRecognizerï¼Œè¿™ä¸ªå¾ˆå¥½ä½¿çš„ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™<br><a href="http://blog.sunnyxx.com/2015/06/07/fullscreen-pop-gesture/" target="_blank" rel="noopener">ä¸€ä¸ªä¸æ»‘çš„å…¨å±æ»‘åŠ¨è¿”å›æ‰‹åŠ¿</a><br><a href="https://www.jianshu.com/p/d39f7d22db6c" target="_blank" rel="noopener">iOSåˆ©ç”¨Runtimeè‡ªå®šä¹‰æ§åˆ¶å™¨POPæ‰‹åŠ¿åŠ¨ç”»</a><br><a href="https://juejin.im/entry/5bea8d6de51d454fbd6b472f" target="_blank" rel="noopener">iOS-FDFullscreenPopGestureè¯¦è§£</a> </p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;2019.5.29 ä¿®æ”¹Method Swizzlingéƒ¨åˆ†å†…å®¹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; ä¼˜é›…åœ°å¼€å¯å…¨å±ä¾§æ»‘æ‰‹åŠ¿ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>å¼€æºé¡¹ç›®ï¼šPageMenu</title>
    <link href="http://blog.chenyalun.com/2019/03/21/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%EF%BC%9APageMenu/"/>
    <id>http://blog.chenyalun.com/2019/03/21/å¼€æºé¡¹ç›®ï¼šPageMenu/</id>
    <published>2019-03-21T11:42:23.000Z</published>
    <updated>2019-09-16T09:10:17.293Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> ä¸€ä¸ªä½¿ç”¨Swiftå†™çš„PageMenuã€‚ </p><br><a id="more"></a><p></p><p>ä¸€ä¸ªä½¿ç”¨Swiftå†™çš„PageMenuã€‚æ²¡æœ‰é‚£ä¹ˆå¤šæ¥å£ï¼Œè‡ªå·±å¯ä»¥æ ¹æ®å®é™…éœ€è¦æ‰©å±•ã€‚å†™è¿™ä¸ªçš„ç›®çš„ä¸€æ˜¯ä¸ºäº†ç»ƒæ‰‹ï¼Œæ¯•ç«Ÿå·¥ä½œä¸­ä½¿ç”¨Swiftæå°‘ï¼Œå†ä¸€ä¸ªï¼ŒPageMenuä½¿ç”¨åœºæ™¯æŒºå¤šçš„ï¼Œæˆ‘é‡åˆ°è¿‡å¥½å‡ æ¬¡ï¼Œè¿™æ¬¡åšä¸€ä¸ªæ€»ç»“ã€‚</p><p>é¡¹ç›®åœ°å€:<a href="https://github.com/ChenYalun/PageMenu" target="_blank" rel="noopener">https://github.com/ChenYalun/PageMenu</a></p><h1 id="ä¸€ã€æ€è·¯"><a href="#ä¸€ã€æ€è·¯" class="headerlink" title="ä¸€ã€æ€è·¯"></a>ä¸€ã€æ€è·¯</h1><p>MenuStyle: ç”¨äºæ ‡é¢˜çš„æ ·å¼é…ç½®<br>PageTitleView: ç§æœ‰çš„å•ä¸ªæ ‡é¢˜æ§ä»¶<br>PageTitle: æ ‡é¢˜åŒºè§†å›¾<br>PageContent: å†…å®¹åŒºè§†å›¾<br>PageMenu: ç»§æ‰¿è‡ªUIViewControllerçš„è§†å›¾æ§åˆ¶å™¨ï¼Œç”¨äºè¿æ¥PageTitleå’ŒPageContent<br>UIColor+RGB: ä¸€äº›å¯¹UIColorçš„æ‹“å±•ï¼Œä¸»è¦æ˜¯æ”¯æŒRGBçš„æ–¹å¼è®¾ç½®é¢œè‰²</p><h1 id="äºŒã€ä»£ç "><a href="#äºŒã€ä»£ç " class="headerlink" title="äºŒã€ä»£ç "></a>äºŒã€ä»£ç </h1><h2 id="MenuStyle"><a href="#MenuStyle" class="headerlink" title="MenuStyle"></a>MenuStyle</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MenuStyle</span>: <span class="type">UIView &#123;</span></span></span><br><span class="line">    <span class="comment">// æ ‡é¢˜ä¹‹é—´çš„é—´è·</span></span><br><span class="line">    <span class="keyword">var</span> margin: CGFloat = <span class="number">10</span></span><br><span class="line">    <span class="comment">// é»˜è®¤é¢œè‰²</span></span><br><span class="line">    <span class="keyword">var</span> defaultColor = UIColor(r: <span class="number">0</span>, g: <span class="number">0</span>, b: <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤å­—ä½“</span></span><br><span class="line">    <span class="keyword">var</span> defaultFont = UIFont.systemFont(ofSize: <span class="number">17</span>)</span><br><span class="line">    <span class="comment">// é€‰ä¸­æ€é¢œè‰²</span></span><br><span class="line">    <span class="keyword">var</span> selectedColor = UIColor(r: <span class="number">239</span>, g: <span class="number">154</span>, b: <span class="number">64</span>)</span><br><span class="line">    <span class="comment">// é€‰ä¸­æ€å­—ä½“</span></span><br><span class="line">    <span class="keyword">var</span> selectedFont = UIFont.systemFont(ofSize: <span class="number">18</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºæ¡é«˜åº¦, ä¸º0è¡¨ç¤ºéšè—</span></span><br><span class="line">    <span class="keyword">var</span> lineHeight: CGFloat = <span class="number">2</span></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºæ¡å®½åº¦, ä¸º0è¡¨ç¤ºè‡ªé€‚åº”</span></span><br><span class="line">    <span class="keyword">var</span> lineWidth: CGFloat = <span class="number">0</span></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºæ¡é¢œè‰², é»˜è®¤ä¸selectedColorä¿æŒä¸€è‡´</span></span><br><span class="line">    <span class="keyword">var</span> lineColor: UIColor?</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¼€å¯æŒ‡ç¤ºæ¡é¢œè‰²æ¸å˜</span></span><br><span class="line">    <span class="keyword">var</span> lineColorGradual = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºæ¡åœ†è§’</span></span><br><span class="line">    <span class="keyword">var</span> lineCornerRadius: CGFloat = <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‡é¢˜åŒºçš„frame</span></span><br><span class="line">    <span class="keyword">var</span> pageTitleFrame = CGRect(x: <span class="number">0</span>, y: <span class="number">20</span>, width: UIScreen.main.bounds.width, height: <span class="number">25</span>)</span><br><span class="line">    <span class="comment">// æ ‡é¢˜åŒºä¸å†…å®¹åŒºçš„é—´è·</span></span><br><span class="line">    <span class="keyword">var</span> titleContentMargin: CGFloat = <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PageTitle"><a href="#PageTitle" class="headerlink" title="PageTitle"></a>PageTitle</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»£ç†</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PageTitleDelegate</span> : <span class="title">class</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pageTitleDidSelected</span><span class="params">(pageTitle: PageTitle, pageTitleView: PageTitleView)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡é¢˜è§†å›¾ç»„ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageTitleView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">var</span> index: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// æ ‡é¢˜</span></span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span>?</span><br><span class="line">    <span class="comment">// æ¸å˜é¢œè‰²</span></span><br><span class="line">    <span class="keyword">var</span> color: <span class="type">UIColor</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            label.textColor = color</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ·å¼</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> style: <span class="type">MenuStyle</span></span><br><span class="line">    <span class="comment">// é€‰ä¸­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> isSelected: <span class="type">Bool</span> = <span class="literal">false</span> &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123; reloadState() &#125;<span class="comment">// åˆ·æ–°æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è‡ªèº«å®½åº¦</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> width: <span class="type">CGFloat</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> title?.size(withAttributes: [<span class="type">NSAttributedString</span>.<span class="type">Key</span>.font: font]).width ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­—ä½“å¤§å°</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> font: <span class="type">UIFont</span> &#123; <span class="keyword">return</span> isSelected ? style.selectedFont : style.defaultFont &#125;</span><br><span class="line">    <span class="comment">// å­—ä½“é¢œè‰²</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> fontColor: <span class="type">UIColor</span> &#123; <span class="keyword">return</span> isSelected ? style.selectedColor : style.defaultColor &#125;</span><br><span class="line">    <span class="comment">// ç‚¹å‡»å›è°ƒ</span></span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> tapCallBack: ((<span class="number">_</span> view: <span class="type">PageTitleView</span>) -&gt; <span class="type">Void</span>)?</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> label: <span class="type">UILabel</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">        <span class="keyword">let</span> gesture = <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: #selector(action(<span class="number">_</span>:)))</span><br><span class="line">        label.addGestureRecognizer(gesture)</span><br><span class="line">        label.isUserInteractionEnabled = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> label</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">init</span>(title: <span class="type">String</span>?, isSelected: <span class="type">Bool</span>, style: <span class="type">MenuStyle</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.title = title</span><br><span class="line">        <span class="keyword">self</span>.isSelected = isSelected</span><br><span class="line">        <span class="keyword">self</span>.style = style</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: <span class="type">CGRect</span>.zero)</span><br><span class="line">        reloadState()</span><br><span class="line">        <span class="keyword">self</span>.addSubview(label)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ¨æ€é“¾æ¥</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">action</span><span class="params">(<span class="number">_</span> tap: UITapGestureRecognizer)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> tapCallBack != <span class="literal">nil</span> &#123;</span><br><span class="line">            tapCallBack!(<span class="keyword">self</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ·æ–°æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">reloadState</span><span class="params">()</span></span> &#123;</span><br><span class="line">        label.text = title</span><br><span class="line">        label.textColor = fontColor</span><br><span class="line">        label.font = font</span><br><span class="line">        label.sizeToFit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡é¢˜è§†å›¾</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageTitle</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»£ç†</span></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">PageTitleDelegate</span>?</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> titleList: [<span class="type">String</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> scrollView: <span class="type">UIScrollView</span> = &#123;</span><br><span class="line">        <span class="keyword">var</span> scrollView = <span class="type">UIScrollView</span>(frame: bounds)</span><br><span class="line">        scrollView.showsHorizontalScrollIndicator = <span class="literal">false</span></span><br><span class="line">        addSubview(scrollView)</span><br><span class="line">        <span class="keyword">return</span> scrollView</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºå™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> lineView: <span class="type">UIView</span> = &#123;</span><br><span class="line">        <span class="keyword">var</span> lineView = <span class="type">UIView</span>()</span><br><span class="line">        lineView.backgroundColor = menuStyle.lineColor ?? menuStyle.selectedColor</span><br><span class="line">        lineView.layer.cornerRadius = menuStyle.lineCornerRadius</span><br><span class="line">        lineView.layer.masksToBounds = <span class="literal">true</span></span><br><span class="line">        scrollView.addSubview(lineView)</span><br><span class="line">        <span class="keyword">return</span> lineView</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// æ ·å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> menuStyle: <span class="type">MenuStyle</span></span><br><span class="line">    <span class="comment">// å½“å‰é€‰ä¸­æ ‡é¢˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> currentSelectedView: <span class="type">PageTitleView</span>?</span><br><span class="line">    <span class="comment">// æ ‡é¢˜åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> titleViewList = [<span class="type">PageTitleView</span>]()</span><br><span class="line">    <span class="keyword">init</span>(frame: <span class="type">CGRect</span>, menuStyle: <span class="type">MenuStyle</span>, titleList: [<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.menuStyle = menuStyle</span><br><span class="line">        <span class="keyword">self</span>.titleList = titleList</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">        setupSubViews()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupSubViews</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> totalWidth: <span class="type">CGFloat</span> = <span class="number">0</span></span><br><span class="line">        <span class="comment">// è®¾ç½®å­æ§ä»¶</span></span><br><span class="line">        <span class="keyword">for</span> (idx, title) <span class="keyword">in</span> titleList.enumerated() &#123;</span><br><span class="line">            <span class="keyword">let</span> view = <span class="type">PageTitleView</span>(title: title <span class="keyword">as</span> <span class="type">String</span>, isSelected: <span class="literal">false</span>, style: menuStyle)</span><br><span class="line">            view.index = idx</span><br><span class="line">            titleViewList.append(view)</span><br><span class="line">            <span class="keyword">let</span> x = <span class="type">CGFloat</span>(idx + <span class="number">1</span>) * menuStyle.margin + totalWidth</span><br><span class="line">            view.frame = <span class="type">CGRect</span>(x: x, y: <span class="number">0</span>, width: view.width, height: frame.height - menuStyle.lineHeight)</span><br><span class="line">            totalWidth += view.width</span><br><span class="line">            scrollView.addSubview(view)</span><br><span class="line">            view.tapCallBack = &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] view <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                <span class="keyword">self</span>.changeToSelectedIndex(idx: view.index)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        scrollView.contentSize = <span class="type">CGSize</span>(width: totalWidth + <span class="type">CGFloat</span>(titleList.<span class="built_in">count</span> + <span class="number">1</span>) * menuStyle.margin, height: <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// é»˜è®¤é€‰ä¸­çš„ç´¢å¼• 0</span></span><br><span class="line">        changeToSelectedIndex()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: åˆ‡æ¢è¿‡ç¨‹ä¸­éœ€è¦è°ƒç”¨çš„å‡½æ•°</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PageTitle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">changeToSelectedIndex</span><span class="params">(idx: Int = <span class="number">0</span>, progress: CGFloat = <span class="number">1</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// ç´¢å¼•å€¼è¶Šç•Œ</span></span><br><span class="line">        <span class="keyword">if</span> idx &gt; titleViewList.<span class="built_in">count</span> - <span class="number">1</span> || idx &lt; <span class="number">0</span> || titleViewList.<span class="built_in">count</span> &lt;= <span class="number">0</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">var</span> fromView, toView: <span class="type">PageTitleView</span></span><br><span class="line">        <span class="keyword">if</span> currentSelectedView == <span class="literal">nil</span> &#123;</span><br><span class="line">            fromView = titleViewList.first!</span><br><span class="line">            toView = fromView</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fromView = currentSelectedView!</span><br><span class="line">            toView = titleViewList[idx]</span><br><span class="line">            <span class="comment">// åŒä¸€ä¸ªæ ‡é¢˜</span></span><br><span class="line">            <span class="keyword">if</span> fromView == toView &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> menuStyle.lineHeight != <span class="number">0</span> &#123;</span><br><span class="line">            refreshBottomLineFrame(fromView.frame, toView.frame, progress)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> menuStyle.lineColorGradual &#123;</span><br><span class="line">            refreshTitleViewColor(fromView, toView, progress)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> progress == <span class="number">1</span> &#123;</span><br><span class="line">            refreshTitleViewState(fromView, toView)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®æŒ‡ç¤ºæ¡frame</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">refreshBottomLineFrame</span><span class="params">(<span class="number">_</span> from: CGRect, <span class="number">_</span> to: CGRect, <span class="number">_</span> progress: CGFloat)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> from = from</span><br><span class="line">        <span class="keyword">var</span> to = to</span><br><span class="line">        <span class="keyword">let</span> lineHeight = menuStyle.lineHeight</span><br><span class="line">        <span class="keyword">let</span> lineWidth = menuStyle.lineWidth</span><br><span class="line">        <span class="keyword">let</span> y = frame.height - lineHeight</span><br><span class="line">        <span class="keyword">let</span> isFixedLineWidth = lineWidth != <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> fromWidth = isFixedLineWidth ? lineWidth : from.width</span><br><span class="line">        <span class="keyword">let</span> toWidth = isFixedLineWidth ? lineWidth : to.width</span><br><span class="line">        <span class="keyword">let</span> fromMinX = isFixedLineWidth ? from.midX - lineWidth * <span class="number">0.5</span> : from.minX</span><br><span class="line">        <span class="keyword">let</span> fromMaxX = isFixedLineWidth ? fromMinX + lineWidth : from.maxX</span><br><span class="line">        <span class="keyword">let</span> toMinX = isFixedLineWidth ? to.midX - lineWidth * <span class="number">0.5</span> : to.minX</span><br><span class="line">        <span class="keyword">let</span> toMaxX = isFixedLineWidth ? toMinX + lineWidth : to.maxX</span><br><span class="line">        from = <span class="type">CGRect</span>(x: fromMinX, y: y, width: fromWidth, height: lineHeight)</span><br><span class="line">        to = <span class="type">CGRect</span>(x: toMinX, y: y, width: toWidth, height: lineHeight)</span><br><span class="line">        <span class="keyword">let</span> isToLeft = toMinX &lt; fromMinX <span class="comment">// å‘å·¦</span></span><br><span class="line">        <span class="keyword">if</span> progress &lt; <span class="number">0.5</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> isToLeft &#123; <span class="comment">// å‘å·¦ç§»åŠ¨</span></span><br><span class="line">                <span class="keyword">let</span> offsetWidth = (fromMinX - toMinX) * <span class="number">2</span> * progress</span><br><span class="line">                lineView.frame = <span class="type">CGRect</span>(x: fromMinX - offsetWidth, y: y, width:  fromMaxX - fromMinX + offsetWidth, height: lineHeight)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> offsetWidth = (toMaxX - fromMaxX) * <span class="number">2</span> * progress</span><br><span class="line">                lineView.frame = <span class="type">CGRect</span>(x: fromMinX, y: y, width:from.width + offsetWidth, height: lineHeight)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> isToLeft &#123; <span class="comment">// å‘å·¦ç§»åŠ¨</span></span><br><span class="line">                <span class="keyword">let</span> offsetWidth = (fromMaxX - to.maxX) * (<span class="number">1</span> - (progress - <span class="number">0.5</span>) * <span class="number">2</span>)</span><br><span class="line">                lineView.frame = <span class="type">CGRect</span>(x: toMinX, y: y, width:to.width + offsetWidth, height: lineHeight)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> offsetWidth = (toMinX - fromMinX) * (<span class="number">1</span> - (progress - <span class="number">0.5</span>) * <span class="number">2</span>)</span><br><span class="line">                lineView.frame = <span class="type">CGRect</span>(x: toMinX - offsetWidth, y: y, width:toMaxX - toMinX + offsetWidth, height: lineHeight)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ·æ–°æ ‡é¢˜çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">refreshTitleViewState</span><span class="params">(<span class="number">_</span> fromView: PageTitleView, <span class="number">_</span> toView: PageTitleView)</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°currentSelectedView</span></span><br><span class="line">        currentSelectedView?.isSelected = <span class="literal">false</span></span><br><span class="line">        toView.isSelected = <span class="literal">true</span></span><br><span class="line">        currentSelectedView = toView</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®æ ‡é¢˜å±…ä¸­</span></span><br><span class="line">        <span class="keyword">let</span> width = scrollView.bounds.width</span><br><span class="line">        <span class="keyword">let</span> contentWidth = scrollView.contentSize.width</span><br><span class="line">        <span class="keyword">var</span> offsetX = toView.center.x - width * <span class="number">0.5</span></span><br><span class="line">        offsetX = <span class="built_in">max</span>(offsetX, <span class="number">0</span>)</span><br><span class="line">        offsetX = <span class="built_in">min</span>(contentWidth - width, offsetX)</span><br><span class="line">        <span class="keyword">if</span> contentWidth &lt;= width &#123; <span class="comment">// ä¿æŒå±…ä¸­</span></span><br><span class="line">            <span class="keyword">let</span> viewWidth = <span class="type">CGFloat</span>(titleViewList.last?.frame.maxX ?? <span class="number">0</span>) - <span class="type">CGFloat</span>(titleViewList.first?.frame.minX ?? <span class="number">0</span>)</span><br><span class="line">            offsetX = -(width - viewWidth) * <span class="number">0.5</span> + menuStyle.margin</span><br><span class="line">        &#125;</span><br><span class="line">        scrollView.setContentOffset(<span class="type">CGPoint</span>(x: offsetX, y: <span class="number">0</span>), animated: <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> delegate != <span class="literal">nil</span> &#123;</span><br><span class="line">            delegate?.pageTitleDidSelected(pageTitle: <span class="keyword">self</span>, pageTitleView: toView)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ‡é¢˜é¢œè‰²æ¸å˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">refreshTitleViewColor</span><span class="params">(<span class="number">_</span> fromView: PageTitleView, <span class="number">_</span> toView: PageTitleView, <span class="number">_</span> progress: CGFloat)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> toRGB = <span class="type">UIColor</span>.rgbValue(menuStyle.selectedColor)</span><br><span class="line">        <span class="keyword">let</span> fromRGB = <span class="type">UIColor</span>.rgbValue(menuStyle.defaultColor)</span><br><span class="line">        <span class="keyword">let</span> deltaRGB = (toRGB.<span class="number">0</span> - fromRGB.<span class="number">0</span>, toRGB.<span class="number">1</span> - fromRGB.<span class="number">1</span>, toRGB.<span class="number">2</span> - fromRGB.<span class="number">2</span>)</span><br><span class="line">        fromView.color = <span class="type">UIColor</span>(r: toRGB.<span class="number">0</span> - deltaRGB.<span class="number">0</span> * progress, g: toRGB.<span class="number">1</span> - deltaRGB.<span class="number">1</span> * progress, b: toRGB.<span class="number">2</span> - deltaRGB.<span class="number">2</span> * progress)</span><br><span class="line">        toView.color = <span class="type">UIColor</span>(r: fromRGB.<span class="number">0</span> + deltaRGB.<span class="number">0</span> * progress, g: fromRGB.<span class="number">1</span> + deltaRGB.<span class="number">1</span> * progress, b: fromRGB.<span class="number">2</span> + deltaRGB.<span class="number">2</span> * progress)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: PageContentDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PageTitle</span> : <span class="title">PageContentDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pageContentDidChange</span><span class="params">(pageContent: PageContent, targetIndex: Int, progress: CGFloat)</span></span> &#123;</span><br><span class="line">        changeToSelectedIndex(idx: targetIndex, progress: progress)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PageContent"><a href="#PageContent" class="headerlink" title="PageContent"></a>PageContent</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»£ç†</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PageContentDelegate</span> : <span class="title">class</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pageContentDidChange</span><span class="params">(pageContent: PageContent, targetIndex: Int, progress: CGFloat)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageContent</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">PageContentDelegate</span>?</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> controllerList: [<span class="type">UIViewController</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> identifier = <span class="string">"PageMenu_CollectionView_Identifier"</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> currentIndex = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> shouldCallDelegate = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> collectionView: <span class="type">UICollectionView</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> layout = <span class="type">UICollectionViewFlowLayout</span>()</span><br><span class="line">        layout.itemSize = bounds.size</span><br><span class="line">        layout.scrollDirection = .horizontal</span><br><span class="line">        layout.minimumLineSpacing = <span class="number">0</span></span><br><span class="line">        layout.minimumInteritemSpacing = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> collectionView = <span class="type">UICollectionView</span>(frame: bounds, collectionViewLayout: layout)</span><br><span class="line">        collectionView.dataSource = <span class="keyword">self</span> <span class="keyword">as</span> <span class="type">UICollectionViewDataSource</span></span><br><span class="line">        collectionView.delegate = <span class="keyword">self</span> <span class="keyword">as</span> <span class="type">UICollectionViewDelegate</span></span><br><span class="line">        collectionView.showsHorizontalScrollIndicator = <span class="literal">false</span></span><br><span class="line">        collectionView.scrollsToTop = <span class="literal">false</span></span><br><span class="line">        collectionView.isPagingEnabled = <span class="literal">true</span></span><br><span class="line">        collectionView.bounces = <span class="literal">false</span></span><br><span class="line">        collectionView.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">        <span class="comment">// æ³¨å†Œcell</span></span><br><span class="line">        collectionView.register(<span class="type">UICollectionViewCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: identifier)</span><br><span class="line">        addSubview(collectionView)</span><br><span class="line">        <span class="keyword">return</span> collectionView</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">init</span>(frame: <span class="type">CGRect</span>, controllerList: [<span class="type">UIViewController</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.controllerList = controllerList</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">        <span class="keyword">self</span>.collectionView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: UICollectionViewDataSource</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PageContent</span> : <span class="title">UICollectionViewDataSource</span>, <span class="title">UICollectionViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> controllerList.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: identifier, <span class="keyword">for</span>: indexPath)</span><br><span class="line">        <span class="keyword">let</span> view = controllerList[indexPath.row].view!</span><br><span class="line">        view.frame = cell.bounds</span><br><span class="line">        cell.contentView.addSubview(view)</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: UIScrollViewDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PageContent</span> : <span class="title">UIScrollViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndDecelerating</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="type">Int</span>(scrollView.contentOffset.x / scrollView.bounds.width)</span><br><span class="line">        currentIndex = index</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scrollViewWillBeginDragging</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">        shouldCallDelegate = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidScroll</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !shouldCallDelegate &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> width = scrollView.bounds.width</span><br><span class="line">        <span class="keyword">let</span> offsetX = scrollView.contentOffset.x - <span class="type">CGFloat</span>(currentIndex) * width</span><br><span class="line">        <span class="keyword">let</span> offsetIndex = offsetX &gt; <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> progress = <span class="built_in">abs</span>(offsetX) / width</span><br><span class="line">        <span class="keyword">if</span> delegate != <span class="literal">nil</span> &#123;</span><br><span class="line">            delegate?.pageContentDidChange(pageContent: <span class="keyword">self</span>, targetIndex: currentIndex + offsetIndex, progress: progress)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: PageTitleDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PageContent</span> : <span class="title">PageTitleDelegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">pageTitleDidSelected</span><span class="params">(pageTitle: PageTitle, pageTitleView: PageTitleView)</span></span> &#123;</span><br><span class="line">        shouldCallDelegate = <span class="literal">false</span></span><br><span class="line">        collectionView.scrollToItem(at: <span class="type">IndexPath</span>(item: pageTitleView.index, section: <span class="number">0</span>), at: .<span class="keyword">left</span>, animated: <span class="literal">false</span>)</span><br><span class="line">        currentIndex = pageTitleView.index</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PageMenu"><a href="#PageMenu" class="headerlink" title="PageMenu"></a>PageMenu</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageMenu</span> : <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pageTitle: <span class="type">PageTitle</span></span><br><span class="line">    <span class="keyword">var</span> pageContent: <span class="type">PageContent</span></span><br><span class="line">    <span class="keyword">var</span> menuStyle: <span class="type">MenuStyle</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> controllerList: [<span class="type">UIViewController</span>]</span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> menuStyle: <span class="type">MenuStyle</span>, <span class="number">_</span> controllerList: [<span class="type">UIViewController</span>]) &#123;</span><br><span class="line">        <span class="keyword">var</span> titleList = [<span class="type">String</span>]()</span><br><span class="line">        <span class="keyword">for</span> controller <span class="keyword">in</span> controllerList &#123;</span><br><span class="line">            titleList.append(controller.title ?? <span class="string">"null"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.pageTitle = <span class="type">PageTitle</span>(frame: menuStyle.pageTitleFrame, menuStyle: menuStyle, titleList: titleList)</span><br><span class="line">        <span class="keyword">self</span>.pageContent = <span class="type">PageContent</span>(frame: <span class="type">CGRect</span>(x: pageTitle.frame.minX, y: pageTitle.frame.maxY + menuStyle.titleContentMargin, width: pageTitle.frame.width, height: <span class="type">UIScreen</span>.main.bounds.height - pageTitle.frame.height), controllerList: controllerList)</span><br><span class="line">        <span class="keyword">self</span>.menuStyle = menuStyle</span><br><span class="line">        <span class="keyword">self</span>.controllerList = controllerList</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">        configureComponent()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">configureComponent</span><span class="params">()</span></span> &#123;</span><br><span class="line">        view.addSubview(pageTitle)</span><br><span class="line">        view.addSubview(pageContent)</span><br><span class="line">        <span class="keyword">for</span> controller <span class="keyword">in</span> controllerList &#123;</span><br><span class="line">            addChild(controller)</span><br><span class="line">        &#125;</span><br><span class="line">        pageTitle.delegate = pageContent</span><br><span class="line">        pageContent.delegate = pageTitle</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="UIColor-RGB"><a href="#UIColor-RGB" class="headerlink" title="UIColor+RGB"></a>UIColor+RGB</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">convenience</span> <span class="keyword">init</span>(r : <span class="type">CGFloat</span>, g : <span class="type">CGFloat</span>, b : <span class="type">CGFloat</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(red: r / <span class="number">255.0</span>, green: g / <span class="number">255.0</span>, blue: b / <span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">rgbValue</span>(<span class="title">_</span> <span class="title">color</span> : <span class="title">UIColor</span>) -&gt; (<span class="title">CGFloat</span>, <span class="title">CGFloat</span>, <span class="title">CGFloat</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> components = color.cgColor.components <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"é¢œè‰²æŒ‰ç…§RGBè®¾ç½®"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (components[<span class="number">0</span>] * <span class="number">255</span>, components[<span class="number">1</span>] * <span class="number">255</span>, components[<span class="number">2</span>] * <span class="number">255</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¸‰ã€ä½¿ç”¨"><a href="#ä¸‰ã€ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ä½¿ç”¨"></a>ä¸‰ã€ä½¿ç”¨</h1><p>ç®€å•é…ç½®ä¸€ä¸‹MenuStyleï¼Œåˆ›å»ºè‡ªå·±çš„è§†å›¾æ§åˆ¶å™¨ï¼Œå°±èƒ½ç›´æ¥ä½¿ç”¨äº†ã€‚</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">    super.viewDidLoad()</span><br><span class="line">    <span class="selector-tag">var</span> controllerList = [UIViewController]()</span><br><span class="line">    let style: MenuStyle = MenuStyle()</span><br><span class="line">    <span class="comment">// åˆ›å»ºstyleå¹¶é…ç½®æ ·å¼</span></span><br><span class="line">    style<span class="selector-class">.margin</span> = <span class="number">30</span></span><br><span class="line">    style<span class="selector-class">.defaultColor</span> = UIColor(r: <span class="number">135</span>, g: <span class="number">135</span>, <span class="selector-tag">b</span>: <span class="number">135</span>)</span><br><span class="line">    style<span class="selector-class">.selectedColor</span> = UIColor(r: <span class="number">0</span>, g: <span class="number">0</span>, <span class="selector-tag">b</span>: <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ§åˆ¶å™¨</span></span><br><span class="line">    let red = UIViewController()</span><br><span class="line">    red<span class="selector-class">.view</span><span class="selector-class">.backgroundColor</span> = UIColor.red</span><br><span class="line">    red<span class="selector-class">.title</span> = <span class="string">"å…³æ³¨"</span></span><br><span class="line">    let blue = UIViewController()</span><br><span class="line">    blue<span class="selector-class">.view</span><span class="selector-class">.backgroundColor</span> = UIColor.blue</span><br><span class="line">    blue<span class="selector-class">.title</span> = <span class="string">"çƒ­é—¨"</span></span><br><span class="line">    controllerList = [red, blue]</span><br><span class="line">    <span class="comment">// åˆ›å»ºPageMenu</span></span><br><span class="line">    let pageMenu = PageMenu(style, controllerList)</span><br><span class="line">    pageMenu<span class="selector-class">.pageTitle</span><span class="selector-class">.backgroundColor</span> = UIColor(r: <span class="number">45</span>, g: <span class="number">184</span>, <span class="selector-tag">b</span>: <span class="number">105</span>)</span><br><span class="line">    addChild(pageMenu)</span><br><span class="line">    view.addSubview(pageMenu.view)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å››ã€æ•ˆæœ"><a href="#å››ã€æ•ˆæœ" class="headerlink" title="å››ã€æ•ˆæœ"></a>å››ã€æ•ˆæœ</h1><p>å¾®åšæ ·å¼ï¼š<br><img src="https://image.chenyalun.com/2019/03/22/weibo.gif" style="zoom:60%"></p><p>itä¹‹å®¶æ ·å¼ï¼š<br><img src="https://image.chenyalun.com/2019/03/22/ithome.gif" style="zoom:60%"></p><h1 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h1><p>å¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ä¸€ç‚¹çš„å°±æ˜¯ï¼Œæ ‡é¢˜åŒºæŒ‡ç¤ºæ¡çš„frameæ¸å˜ï¼Œè¦è€ƒè™‘å·¦æ»‘å’Œå³æ»‘çš„æƒ…å†µï¼Œè¿˜è¦è€ƒè™‘è¿›åº¦progressçš„é—®é¢˜ã€‚ä¸è¿‡è¿˜å¥½ï¼Œä»”ç»†æƒ³æƒ³éƒ½èƒ½è§£å†³çš„ã€‚</p><p>å†ä¸€ä¸ªï¼ŒPageTitleå’ŒPageContentä¹‹é—´äº’ç›¸é€šä¿¡çš„æ–¹æ¡ˆï¼Œæˆ‘é€‰æ‹©çš„æ˜¯ä»£ç†ã€‚PageTitleæ˜¯PageContentçš„ä»£ç†ï¼ŒåŒæ—¶ï¼ŒPageContentåˆæ˜¯PageTitleçš„ä»£ç†ã€‚ç”±PageMenuè´Ÿè´£è¿æ¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; ä¸€ä¸ªä½¿ç”¨Swiftå†™çš„PageMenuã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="å¼€æºé¡¹ç›®" scheme="http://blog.chenyalun.com/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>Appç•Œé¢ä¼˜åŒ–Tips</title>
    <link href="http://blog.chenyalun.com/2019/03/15/App%E7%95%8C%E9%9D%A2%E4%BC%98%E5%8C%96Tips/"/>
    <id>http://blog.chenyalun.com/2019/03/15/Appç•Œé¢ä¼˜åŒ–Tips/</id>
    <published>2019-03-15T13:15:23.000Z</published>
    <updated>2019-12-21T07:51:01.424Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚</p><br><a id="more"></a><p></p><p>æœ¬æ¥è¿™ç¯‡æ–‡ç« åªæ˜¯é˜…è¯»YYAsyncLayeråçš„ä½“ä¼šï¼Œåæ¥ä¸€å†æ‰©å……ï¼Œå˜æˆäº†Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚ã€‚ã€‚</p><h1 id="ä¸€ã€åˆ—è¡¨è§†å›¾"><a href="#ä¸€ã€åˆ—è¡¨è§†å›¾" class="headerlink" title="ä¸€ã€åˆ—è¡¨è§†å›¾"></a>ä¸€ã€åˆ—è¡¨è§†å›¾</h1><h2 id="å®šé«˜Cell"><a href="#å®šé«˜Cell" class="headerlink" title="å®šé«˜Cell"></a>å®šé«˜Cell</h2><h3 id="1ï¼Œå¤ç”¨"><a href="#1ï¼Œå¤ç”¨" class="headerlink" title="1ï¼Œå¤ç”¨"></a>1ï¼Œå¤ç”¨</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kWBStatusCellIdentifier = <span class="string">@"kWBStatusCellIdentifier"</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView</span><br><span class="line">         cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    WBStatusCell *cell = [tableView dequeueReusableCellWithIdentifier:kWBStatusCellIdentifier forIndexPath:indexPath];</span><br><span class="line">    [cell setLayout:_layouts[indexPath.row]];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ‡å‡†åŒ–çš„å†™æ³•æ˜¯è¿™æ ·çš„ã€‚<code>dequeueReusableCellWithIdentifier:forIndexPath:</code>æ–¹æ³•æ¯”<code>dequeueReusableCellWithIdentifier:</code>æ–¹æ³•å¤šäº†â€œè‡ªåŠ¨åˆ›å»ºâ€ã€‚cellçš„é‡ç”¨IDæœ€å¥½ä½¿ç”¨é™æ€å¸¸é‡ï¼Œå°½ç®¡ç›´æ¥ä½¿ç”¨<code>@&quot;kWBStatusCellIdentifier&quot;</code>ï¼Œç¼–è¯‘å™¨å±‚é¢ä¹Ÿä¼šåšä¼˜åŒ–ï¼Œå¸®æˆ‘ä»¬ç”Ÿæˆé™æ€å¸¸é‡ï¼Œä½†æ˜¯æ„ä¹‰ä¸ä¸€æ ·ã€‚</p><p>cellçš„ç§ç±»ä¸è¦å¤ªå¤šï¼Œå°½é‡é€šè¿‡hidden subviewæ¥åŒºåˆ«ã€‚</p><h3 id="2ï¼Œè®¾ç½®è¡Œé«˜"><a href="#2ï¼Œè®¾ç½®è¡Œé«˜" class="headerlink" title="2ï¼Œè®¾ç½®è¡Œé«˜"></a>2ï¼Œè®¾ç½®è¡Œé«˜</h3><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">_tableView.rowHeight = <span class="number">60</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯å›ºå®šè¡Œé«˜ï¼Œç›´æ¥åœ¨é…ç½®TableViewçš„æ‡’åŠ è½½ä¸­ç›´æ¥è®¾ç½®rowHeightå±æ€§å³å¯ã€‚å¦‚æœä½¿ç”¨ä»£ç†ï¼Œä¼šä½¿TableViewå¤šæ¬¡è¯¢é—®ï¼Œå¢åŠ ä¸å¿…è¦çš„è°ƒç”¨ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">CGFloat</span>)tableView:(<span class="built_in">UITableView</span> *)tableView heightForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">60</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œèƒ½ä½¿ç”¨æ•´æ•°çš„åœ°æ–¹å°±ä¸è¦ä½¿ç”¨å°æ•°ï¼Œ<code>60</code>è¦æ¯”<code>60.2</code>æ›´å¥½ä¸€ç‚¹ï¼ŒCPUä¸å–œæ¬¢å°æ•°ã€‚ä¸ä»…ä»…æŒ‡rowHeightè¿™ä¸ªå±æ€§ï¼Œå…¶ä»–è§†å›¾çš„widthã€heightç­‰å±æ€§ï¼Œåœ¨æ»¡è¶³UEè¦æ±‚çš„æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥å°½å¯èƒ½åœ°é‡‡ç”¨æ•´æ•°ã€‚</p><h3 id="3ï¼Œæ¨¡å‹ç”Ÿæˆ"><a href="#3ï¼Œæ¨¡å‹ç”Ÿæˆ" class="headerlink" title="3ï¼Œæ¨¡å‹ç”Ÿæˆ"></a>3ï¼Œæ¨¡å‹ç”Ÿæˆ</h3><p>é‡‡ç”¨MVVMï¼Œéœ€è¦å­—å…¸è½¬æ¨¡å‹ï¼›å»ModelåŒ–ï¼Œéœ€è¦æ ¼å¼åŒ–å­—å…¸ï¼›æ— è®ºæ€æ ·ï¼Œéƒ½è¦æŠŠæ•°æ®è½¬æ¢æˆè§†å›¾å–œæ¬¢çš„æ ·å­ï¼Œè¿™äº›æ“ä½œå°±å¯ä»¥æ”¾åˆ°å­çº¿ç¨‹ä¸­è¿›è¡Œã€‚å°¤å…¶æ˜¯é‡åˆ°DateFormatterã€stringWithFormatè¿™äº›ç¨å¾®è€—æ€§èƒ½çš„æ–¹æ³•ï¼Œè¯¥ç¼“å­˜å°±ç¼“å­˜ï¼Œè¯¥æ›¿æ¢å°±æ›¿æ¢ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">   <span class="comment">// å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">   WBTimelineItem *item = [WBTimelineItem modelWithJSON:data];</span><br><span class="line">   _statuses = item.statuses;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// ä¸»çº¿ç¨‹åˆ·æ–°</span></span><br><span class="line">   <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       [_tableView reloadData];</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="4ï¼Œsubviewsæ“ä½œ"><a href="#4ï¼Œsubviewsæ“ä½œ" class="headerlink" title="4ï¼Œsubviewsæ“ä½œ"></a>4ï¼Œsubviewsæ“ä½œ</h3><p>1ï¼Œå­è§†å›¾è¶Šå°‘ï¼Œå‡ºç°é—®é¢˜çš„å¯èƒ½æ€§ä¹Ÿè¶Šå°ã€‚æ‰€ä»¥åœ¨æ„æ€çš„æ—¶å€™ï¼Œä¸€ä¸ªè§†å›¾èƒ½è§£å†³çš„é—®é¢˜ï¼Œæ²¡å¿…è¦å¤šå†™å‡ ä¸ªè§†å›¾ã€‚æ¯”å¦‚éœ€è¦åœ¨åŒä¸€è¡Œå±•ç¤ºå†…å®¹aå’Œå†…å®¹bï¼Œå¯ä»¥è€ƒè™‘åªä½¿ç”¨ä¸€ä¸ªLabelã€‚<br>2ï¼Œè§†å›¾çš„åŠ¨æ€åˆ›å»ºå’Œé”€æ¯ä¹Ÿæ˜¯å¾ˆheavilyçš„ï¼Œè€ƒè™‘è®¾ç½®hiddenå±æ€§æ¥æ§åˆ¶æ˜¾ç¤ºå’Œéšè—ã€‚<br>3ï¼Œå°½é‡é€‰ç”¨è½»é‡çº§çš„æ§ä»¶ï¼Œä¸éœ€è¦ç”¨æˆ·å“åº”çš„å¯ä»¥æ¢æˆCALayerï¼Œæ¯”å¦‚CALayeræ›¿ä»£UIImageViewï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">CALayer</span> *)photoImageViewLayer &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_photoImageViewLayer) &#123;</span><br><span class="line">        _photoImageViewLayer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line">        _photoImageViewLayer.contentsGravity = <span class="string">@"resizeAspectFill"</span>;</span><br><span class="line">        _photoImageViewLayer.masksToBounds = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _photoImageViewLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®</span></span><br><span class="line">[<span class="keyword">self</span>.photoImageViewLayer yy_setImageWithURL:url</span><br><span class="line">                                    placeholder:<span class="built_in">UIImage</span>.randomColorImage</span><br><span class="line">                                        options:options</span><br><span class="line">                                    completion:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯CALayerä¸èƒ½è®¾ç½®çº¦æŸï¼Œè¿™å°±éœ€è¦è‡ªå·±è®¡ç®—frameäº†ã€‚</p><h3 id="5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“"><a href="#5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“" class="headerlink" title="5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“"></a>5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“</h3><p>ç¦»å±›æ¸²æŸ“éœ€è¦å¼€è¾Ÿä¸€å—æ–°çš„ç¼“å†²åŒºï¼Œåœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­è¿˜ä¼šæœ‰å¤šæ¬¡çš„åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œè¿™äº›å¾ˆæ¶ˆè€—æ€§èƒ½ã€‚</p><blockquote><p>å¦‚æœè¦åœ¨æ˜¾ç¤ºå±ä¸Šæ˜¾ç¤ºå†…å®¹ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¸€å—ä¸å±å¹•åƒç´ æ•°æ®é‡ä¸€æ ·å¤§çš„frame bufferï¼Œä½œä¸ºåƒç´ æ•°æ®å­˜å‚¨åŒºåŸŸï¼Œè€Œè¿™ä¹Ÿæ˜¯GPUå­˜å‚¨æ¸²æŸ“ç»“æœçš„åœ°æ–¹ã€‚å¦‚æœæœ‰æ—¶å› ä¸ºé¢ä¸´ä¸€äº›é™åˆ¶ï¼Œæ— æ³•æŠŠæ¸²æŸ“ç»“æœç›´æ¥å†™å…¥frame bufferï¼Œè€Œæ˜¯å…ˆæš‚å­˜åœ¨å¦å¤–çš„å†…å­˜åŒºåŸŸï¼Œä¹‹åå†å†™å…¥frame bufferï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¹‹ä¸ºç¦»å±æ¸²æŸ“ã€‚</p></blockquote><p>1ï¼Œ layer.cornerRadius + layer.masksToBoundsä¸€èµ·è®¾ç½®<br>2ï¼Œ è®¾ç½®å›¾å±‚é˜´å½±layer.shadow<br>3ï¼Œ è®¾ç½®è’™å±‚layer.mask<br>4ï¼Œ layer.allowsGroupOpacity è®¾ç½®ä¸ºYESåŒæ—¶layer.opacityå°äº1.0<br>5ï¼Œ layer.shouldRasterizeè®¾ç½®ä¸ºYESã€‚<br>å¼€å¯ Rasterization åï¼ŒGPU åªåˆæˆä¸€æ¬¡å†…å®¹ï¼Œç„¶åå¤ç”¨åˆæˆçš„ç»“æœï¼›åˆæˆçš„å†…å®¹è¶…è¿‡100msæ²¡æœ‰ä½¿ç”¨ä¼šä»ç¼“å­˜é‡Œç§»é™¤ï¼Œæ‰€ä»¥å¯¹äºä¸è¿ç»­ä½¿ç”¨çš„å†…å®¹è¿›è¡Œå…‰æ …åŒ–æ˜¯æ—¢æ²¡æœ‰æ„ä¹‰åˆæµªè´¹èµ„æºçš„ï¼Œåœ¨æ›´æ–°å†…å®¹æ—¶è¿˜ä¼šäº§ç”Ÿæ›´å¤šçš„ç¦»å±æ¸²æŸ“ã€‚å¯¹äºå†…å®¹ä¸å‘ç”Ÿå˜åŒ–çš„è§†å›¾ï¼Œè¿›è¡Œå…‰æ …åŒ–ä¼šä½¿åŸæœ¬æ‹–åè…¿çš„ç¦»å±æ¸²æŸ“å°±æˆä¸ºäº†åŠ©åŠ›ï¼›å¦‚æœè§†å›¾å†…å®¹æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆæœ‰å¯èƒ½è®©æ€§èƒ½å˜å¾—æ›´ç³Ÿã€‚ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œç³»ç»Ÿé™åˆ¶ç¼“å­˜çš„å¤§å°ä¸º 2.5x screen sizeï¼Œè¿‡åº¦ä½¿ç”¨çš„è¯ä¹Ÿä¼šé€ æˆç¦»å±æ¸²æŸ“ã€‚ï¼ˆä¸€èˆ¬ç”¨åœ¨å•ç‹¬çš„è§†å›¾ä¸Šï¼Œè€Œä¸æ˜¯cellçš„layerï¼‰<br>6ï¼Œ ä½¿ç”¨UIBlurEffect</p><p><a href="https://zhuanlan.zhihu.com/p/72653360" target="_blank" rel="noopener">å³åˆ»App</a>çš„ä¼˜åŒ–æ€è·¯æ˜¯è¿™æ ·ï¼š<br>1ï¼Œå¯¹äºå›¾ç‰‡çš„åœ†è§’ï¼Œç»Ÿä¸€é‡‡ç”¨â€œprecompositeâ€çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸ç»ç”±å®¹å™¨æ¥åšå‰ªåˆ‡ï¼Œè€Œæ˜¯é¢„å…ˆä½¿ç”¨CoreGraphicsä¸ºå›¾ç‰‡è£å‰ªåœ†è§’<br>2ï¼Œå¯¹äºè§†é¢‘çš„åœ†è§’ï¼Œç”±äºå®æ—¶å‰ªåˆ‡éå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºå››ä¸ªç™½è‰²å¼§å½¢çš„layerç›–ä½å››ä¸ªè§’ï¼Œä»è§†è§‰ä¸Šåˆ¶é€ åœ†è§’çš„æ•ˆæœ<br>3ï¼Œå¯¹äºviewçš„åœ†å½¢è¾¹æ¡†ï¼Œå¦‚æœæ²¡æœ‰backgroundColorï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨cornerRadiusæ¥åš<br>4ï¼Œå¯¹äºæ‰€æœ‰çš„é˜´å½±ï¼Œä½¿ç”¨shadowPathæ¥è§„é¿ç¦»å±æ¸²æŸ“<br>5ï¼Œå¯¹äºç‰¹æ®Šå½¢çŠ¶çš„viewï¼Œä½¿ç”¨layer maskå¹¶æ‰“å¼€shouldRasterizeæ¥å¯¹æ¸²æŸ“ç»“æœè¿›è¡Œç¼“å­˜<br>6ï¼Œå¯¹äºæ¨¡ç³Šæ•ˆæœï¼Œä¸é‡‡ç”¨ç³»ç»Ÿæä¾›çš„UIVisualEffectï¼Œè€Œæ˜¯å¦å¤–å®ç°æ¨¡ç³Šæ•ˆæœï¼ˆCIGaussianBlurï¼‰ï¼Œå¹¶æ‰‹åŠ¨ç®¡ç†æ¸²æŸ“ç»“æœ</p><h3 id="6ï¼Œåœ†è§’"><a href="#6ï¼Œåœ†è§’" class="headerlink" title="6ï¼Œåœ†è§’"></a>6ï¼Œåœ†è§’</h3><p>â€œcornerRadiuså’ŒmaskToBoundsä¸€èµ·è®¾ç½®ä¼šè§¦å‘ç¦»å±æ¸²æŸ“â€ï¼Œè¿™å¥è¯éœ€è¦è®¨è®ºä¸€ä¸‹äº†ï¼š</p><p>1ï¼ŒUIViewè¿™èˆ¬è®¾ç½®åœ†è§’ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ã€‚<br>2ï¼ŒiOS9.0ä¹‹åUIImageViewä¸­çš„pngå›¾ç‰‡è¿™èˆ¬è®¾ç½®åœ†è§’ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Œä½†æ˜¯å¦‚æœUIImageViewçš„backgroundColorä¸æ˜¯clearColoræˆ–è€…ä¸æ˜¯nilï¼Œåˆ™ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ã€‚</p><p>ä¸Šé¢ä¸¤æ¡æ˜¯æˆ‘æœäº†å¾ˆå¤šèµ„æ–™å‘ç°çš„ï¼Œäº²è‡ªéªŒè¯äº†ä¸€ä¸‹ï¼Œåœ¨iOS13ä¸Šç¬¬ä¸€æ¡æ˜¯çœŸçš„ã€‚ç¬¬äºŒæ¡è¯•ç€ä¸è®¾ç½®backgroundColoræœç„¶ä¹Ÿæ²¡æœ‰å‡ºç°ç¦»å±æ¸²æŸ“ã€‚ä½†æ˜¯ï¼Œæ˜¯ä¸æ˜¯ä»iOS9å¼€å§‹çš„ï¼Œæˆ‘æ²¡æœ‰çœŸæœºä¹Ÿæ²¡æ³•åšåˆ¤æ–­ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å®˜æ–¹çš„è¯´æ˜ã€‚</p><p><strong>ä¸‹é¢æ˜¯ä¹‹å‰çš„UIImageViewè®¾ç½®åœ†è§’çš„å¤„ç†æ–¹å¼</strong><br>ç›´æ¥ä½¿ç”¨layer.maskæ¥è¾¾åˆ°åœ†è§’æ•ˆæœåŒæ ·ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Œå¯¹äºç½‘ç»œå›¾ç‰‡çš„åœ†è§’å¤„ç†é€šå¸¸æ˜¯å…ˆä¸‹è½½ååœ†è§’åŒ–ã€‚<br>ä¸‹è½½é€»è¾‘ï¼ˆä»¥æˆ‘å–œæ¬¢çš„YYWebImageä¸ºä¾‹ï¼‰ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSString *radiusKey = [url.absoluteString <span class="string">stringByAppendingString:</span>@<span class="string">"radiusCache"</span>];</span><br><span class="line">UIImage *radiusImage = [YYImageCache.sharedCache <span class="string">getImageForKey:</span>radiusKey];</span><br><span class="line"><span class="keyword">if</span> (radiusImage) &#123;</span><br><span class="line">   self.photoImageView.image = radiusImage;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   [YYWebImageManager.sharedManager <span class="string">requestImageWithURL:</span>url <span class="string">options:</span>YYWebImageOptionShowNetworkActivity <span class="string">progress:</span>nil <span class="string">transform:</span>nil <span class="string">completion:</span>^(UIImage *image, NSURL *url, YYWebImageFromType from, YYWebImageStage stage, NSError * error) &#123;</span><br><span class="line">       dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">           <span class="keyword">if</span> (!error &amp;&amp; image) &#123;</span><br><span class="line">               [YYImageCache.sharedCache <span class="string">setImage:</span>radiusImage <span class="string">imageData:</span>nil <span class="string">forKey:</span>radiusKey <span class="string">withType:</span>YYImageCacheTypeAll];</span><br><span class="line">               self.photoImageView.image = image.radiusImage;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å›¾ç‰‡ä¸‹è½½å®Œæ¯•ååšåœ†è§’å¤„ç†å¹¶ä¿å­˜ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦æ€è€ƒï¼š<br>1ï¼Œè¿™å¼ å›¾ç‰‡çš„åœ†è§’åŠå¾„åœ¨ä¸šåŠ¡ä¸Šæ˜¯å›ºå®šçš„å—ï¼Œå¦‚æœä¸å›ºå®šï¼ˆæ¯”å¦‚éœ€è¦10pxã€20pxä¸¤ç§ï¼‰é‚£å°±éœ€è¦å­˜å‚¨å¤šä»½äº†ï¼›<br>2ï¼Œè¿™å¼ å›¾ç‰‡çš„å±•ç¤ºæ•ˆæœæ˜¯å¦åªæœ‰åœ†è§’ä¸€ç§ï¼Œæ˜¯å¦åŒæ—¶å­˜åœ¨æœ‰æ–¹å›¾å’Œåœ†è§’å›¾ä¸¤ç§å½¢å¼ï¼Ÿéœ€è¦ä¿ç•™åŸå›¾å—ï¼›</p><p>è¿™ä¸ªæ˜¯ä½¿ç”¨Core Graphicsåˆ›å»ºåœ†è§’å›¾ç‰‡çš„ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“çš„ç¤ºä¾‹ï¼Œå¯ä»¥å­çº¿ç¨‹ç»˜åˆ¶ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)radiusImage &#123;</span><br><span class="line">    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.size.width, <span class="keyword">self</span>.size.height);</span><br><span class="line">    <span class="built_in">CGFloat</span> radius = <span class="number">100.</span>f; <span class="comment">// è¿™ä¸ªåº¦é‡æ˜¯å›¾ç‰‡çš„ï¼Œè€Œä¸æ˜¯imageViewçš„</span></span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(rect.size, <span class="literal">false</span>, <span class="built_in">UIScreen</span>.mainScreen.scale);</span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:rect byRoundingCorners:<span class="built_in">UIRectCornerAllCorners</span> cornerRadii:<span class="built_in">CGSizeMake</span>(radius, radius)];</span><br><span class="line">    <span class="built_in">CGContextAddPath</span>(context, path.CGPath);</span><br><span class="line">    <span class="built_in">CGContextClip</span>(context);</span><br><span class="line">    [<span class="keyword">self</span> drawInRect:rect];</span><br><span class="line">    <span class="built_in">CGContextDrawPath</span>(context, kCGPathFillStroke);</span><br><span class="line">    <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="7ï¼Œé˜´å½±"><a href="#7ï¼Œé˜´å½±" class="headerlink" title="7ï¼Œé˜´å½±"></a>7ï¼Œé˜´å½±</h3><p>å‡å¦‚éœ€è¦è¿™ä¹ˆè®¾ç½®é˜´å½±æ•ˆæœï¼š<br><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">button.layer.shadowColor </span>= UIColor.<span class="keyword">blackColor.CGColor;</span></span><br><span class="line"><span class="keyword">button.layer.shadowOpacity </span>= <span class="number">0</span>.<span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">button.layer.shadowRadius </span>= <span class="number">10</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">button.layer.shadowOffset </span>= CGSizeMake(<span class="number">10</span>, <span class="number">10</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>åªéœ€è¦å†åŠ ä¸Šä¸€å¥è¯å°±èƒ½é¿å…ç¦»å±æ¸²æŸ“äº†ï¼š<br><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line"><span class="keyword">button</span>.layer.shadowPath = [UIBezierPath bezierPathWithRect:<span class="keyword">button</span>.bounds].CGPath;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªå…·æœ‰é˜´å½±æ•ˆæœçš„è§†å›¾éœ€è¦åšframeåŠ¨ç”»ï¼Œé‚£å®ƒçš„shadowæ•ˆæœæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè¿™è¿˜å¾—å†æƒ³åŠæ³•è§£å†³ï¼š<a href="https://www.jianshu.com/p/fd0e7709a404" target="_blank" rel="noopener">æ˜¾å¼æŒ‡å®šshadowPathçš„åŠ¨ç”»æ•ˆæœ</a>ã€‚</p><h2 id="ä¸å®šé«˜cell"><a href="#ä¸å®šé«˜cell" class="headerlink" title="ä¸å®šé«˜cell"></a>ä¸å®šé«˜cell</h2><p>ä¸å®šé«˜çš„celléœ€è¦è®¡ç®—cellçš„é«˜åº¦ã€‚æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€æ˜¯è‡ªå·±åœ¨åå°æ ¹æ®æ¨¡å‹æ•°æ®é…ç½®å­è§†å›¾çš„å¸ƒå±€ï¼Œæ‰‹åŠ¨è®¡ç®—ï¼Œå¹¶æŠŠé«˜åº¦å­˜å‚¨åˆ°å¯¹åº”çš„æ¨¡å‹ä¸­ï¼›äºŒæ˜¯å€ŸåŠ©è‡ªåŠ¨å¸ƒå±€ï¼Œä¿è¯å­è§†å›¾â€œæ’‘æ»¡â€cellï¼Œè‡ªåŠ¨æ›´æ–°cellçš„é«˜åº¦ã€‚</p><p>å¦‚æœå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæˆ–è€…å¼€å‘å‘¨æœŸçŸ­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Auto Layoutï¼Œå†é…åˆ<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/" target="_blank" rel="noopener">FDTemplateLayoutCell</a>çš„é«˜åº¦ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥è¯´å·²ç»å¾ˆæ–¹ä¾¿äº†ã€‚ä¸ç„¶åªèƒ½è‡ªå·±è®¡ç®—å¹¶åšç¼“å­˜å¤„ç†ã€‚</p><h1 id="äºŒã€å¼‚æ­¥æ¸²æŸ“"><a href="#äºŒã€å¼‚æ­¥æ¸²æŸ“" class="headerlink" title="äºŒã€å¼‚æ­¥æ¸²æŸ“"></a>äºŒã€å¼‚æ­¥æ¸²æŸ“</h1><p>TableViewå’ŒCollectionViewçš„ä¼˜åŒ–ä¹Ÿå¯ä»¥å€ŸåŠ©å¼‚æ­¥æ¸²æŸ“ï¼ŒYYAsyncLayeræè¿°äº†å¼‚æ­¥æ¸²æŸ“çš„æ ¸å¿ƒåŸç†ã€‚</p><h2 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h2><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YYAsyncLayer </span>: CALayer</span><br><span class="line"><span class="comment">// Default is YES.</span></span><br><span class="line"><span class="variable">@property</span> BOOL displaysAsynchronously;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@protocol</span> YYAsyncLayerDelegate &lt;NSObject&gt;</span><br><span class="line"><span class="variable">@required</span></span><br><span class="line">- (YYAsyncLayerDisplayTask *)newAsyncDisplayTask;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¦ç»˜åˆ¶ã€æ­£åœ¨ç»˜åˆ¶ã€ç»˜åˆ¶å®Œæ¯• å¯¹åº”çš„block</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">YYAsyncLayerDisplayTask </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^willDisplay)(CALayer *layer);</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^display)(CGContextRef context, CGSize size, BOOL(^isCancelled)(void));</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^didDisplay)(CALayer *layer, BOOL finished);</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>è§†å›¾åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¹‹å‰è°ƒç”¨UIViewç±»æ–¹æ³•layerClassï¼Œå¹¶ä¸”ä½¿ç”¨è¿”å›çš„ç±»æ¥åˆ›å»ºlayerå¯¹è±¡ã€‚é€šè¿‡åˆ›å»ºUIViewçš„å­ç±»ï¼Œé‡å†™layerClassç±»å‡½æ•°å¯ä»¥æ”¹å˜åˆ›å»ºå›¾å±‚æ—¶çš„é»˜è®¤çš„CALayerç±»ã€‚åœ¨è‡ªå®šä¹‰è§†å›¾å¯¹è±¡ä¸­ï¼Œè¿”å›ä¸€ä¸ªYYAsyncLayerDisplayTaskï¼Œè¿™ä¸ªtaskæ‰¿æ‹…ç€ç»˜åˆ¶çš„ä»»åŠ¡ã€‚</p><h3 id="å¼‚æ­¥ç»˜åˆ¶æ–‡å­—"><a href="#å¼‚æ­¥ç»˜åˆ¶æ–‡å­—" class="headerlink" title="å¼‚æ­¥ç»˜åˆ¶æ–‡å­—"></a>å¼‚æ­¥ç»˜åˆ¶æ–‡å­—</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YALabel</span> : <span class="title">UIView</span> &lt;<span class="title">YYAsyncLayerDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSAttributedString</span> *attributedString;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YALabel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAttributedString:(<span class="built_in">NSAttributedString</span> *)attributedString &#123;</span><br><span class="line">    _attributedString = attributedString;</span><br><span class="line">    <span class="comment">// YYTransaction let you perform a selector once before current runloop sleep.</span></span><br><span class="line">    [[YYTransaction transactionWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(setTextNeedsDisplay)] commit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">    [[YYTransaction transactionWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(setTextNeedsDisplay)] commit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTextNeedsDisplay &#123;</span><br><span class="line">    [<span class="keyword">self</span>.layer setNeedsDisplay];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)layerClass &#123;</span><br><span class="line">    <span class="keyword">return</span> YYAsyncLayer.class;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (YYAsyncLayerDisplayTask *)newAsyncDisplayTask &#123;</span><br><span class="line">    YYAsyncLayerDisplayTask *task = [YYAsyncLayerDisplayTask new];</span><br><span class="line">    task.display = ^(<span class="built_in">CGContextRef</span> context, <span class="built_in">CGSize</span> size, <span class="built_in">BOOL</span> (^isCancelled)(<span class="keyword">void</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled() || <span class="keyword">self</span>.attributedString.string.length &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// ä¿®å¤ç»˜åˆ¶æ–‡å­—ä¼šé¢ å€’</span></span><br><span class="line">        [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</span><br><span class="line">            <span class="built_in">CGContextTranslateCTM</span>(context, <span class="number">0</span>, <span class="keyword">self</span>.bounds.size.height);</span><br><span class="line">            <span class="built_in">CGContextScaleCTM</span>(context, <span class="number">1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="built_in">NSAttributedString</span> *str = <span class="keyword">self</span>.attributedString;</span><br><span class="line">        [str enumerateAttribute:<span class="built_in">NSFontAttributeName</span> inRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, str.length) options:<span class="built_in">NSAttributedStringEnumerationLongestEffectiveRangeNotRequired</span> usingBlock:^(<span class="built_in">UIFont</span> *font, <span class="built_in">NSRange</span> range, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å­—ä½“è®¾ç½®pointSize</span></span><br><span class="line">            <span class="built_in">CGContextSetTextPosition</span>(context, <span class="number">0</span>, font.pointSize);</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶</span></span><br><span class="line">        <span class="built_in">CTLineRef</span> line = <span class="built_in">CTLineCreateWithAttributedString</span>((__bridge <span class="built_in">CFAttributedStringRef</span>)str);</span><br><span class="line">        <span class="built_in">CTLineDraw</span>(line, context);</span><br><span class="line">        <span class="built_in">CFRelease</span>(line);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™å¾ˆç®€å•äº†ï¼Œè®¾ç½®ä¸€ä¸ªAttributedStringå³å¯ï¼š<br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">YALabel *<span class="keyword">label</span><span class="bash"> = [YALabel new];</span></span><br><span class="line"><span class="bash">NSAttributedString *str = [[NSAttributedString alloc] initWithString:@<span class="string">"ğŸ˜€ğŸ˜ğŸ¤£ğŸ˜‚Labelçš„å¼‚æ­¥ç»˜åˆ¶"</span> attributes:@&#123;NSFontAttributeName:[UIFont systemFontOfSize:15]&#125;];</span></span><br><span class="line"><span class="bash">label.attributedString = str;</span></span><br><span class="line"><span class="bash">label.backgroundColor = UIColor.orangeColor;</span></span><br><span class="line"><span class="bash">label.frame = CGRectMake(100, 100, 200, 50);</span></span><br><span class="line"><span class="bash">[self.view addSubview:label];</span></span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œçš„newAsyncDisplayTaskæ¯”è¾ƒç®€å•ï¼Œåªç»˜åˆ¶äº†å•è¡Œæ–‡æœ¬ï¼Œå¦‚æœçœŸçš„è¦åº”ç”¨åˆ°é¡¹ç›®ä¸­ï¼Œå¯ä»¥åˆ©ç”¨CoreTextæ›´åŠ å®Œå–„äº›ï¼ŒåŠ ä¸Šè‡ªåŠ¨æ¢è¡Œï¼Œè‡ªé€‚åº”sizeï¼Œå›¾æ–‡æ··æ’ç­‰åŠŸèƒ½ã€‚</p><p>æœ‰å‰è¾ˆå†™äº†ä¸€ä¸ªIMçš„Demoï¼Œé‡Œé¢æœ‰ç”¨åˆ°å¼‚æ­¥ç»˜åˆ¶ï¼š<a href="https://github.com/Yuzeyang/GCAsyncDisplayDemoï¼Œè¯»ä¸€è¯»è¿˜æ˜¯å¾ˆæ£’çš„ã€‚" target="_blank" rel="noopener">https://github.com/Yuzeyang/GCAsyncDisplayDemoï¼Œè¯»ä¸€è¯»è¿˜æ˜¯å¾ˆæ£’çš„ã€‚</a></p><h2 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h2><p>æºç ä¸æ˜¯å¾ˆå¤šï¼Œå°±å‡ ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è·Ÿä½œè€…çš„å…¶ä»–æ¡†æ¶ä¸€æ ·ï¼Œä»£ç ç‰¹åˆ«ä¼˜ç§€ã€‚</p><h3 id="YYSentinel"><a href="#YYSentinel" class="headerlink" title="YYSentinel"></a>YYSentinel</h3><p>è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨? ä¸»è¦æ˜¯ä¾èµ–äºåŸå­å‡½æ•°<code>OSAtomicIncrement32()</code>ã€‚</p><blockquote><p>å¦‚æœæˆ‘ä»¬æƒ³è¦åˆå§‹åŒ–ä¸€ä¸ªå…±äº«çš„æ•°æ®ç»“æ„ï¼Œç„¶åè‡ªåŠ¨å¢åŠ æŸä¸ªå˜é‡å€¼æ¥æ ‡è¯†åˆå§‹åŒ–æ“ä½œå®Œæˆï¼Œåˆ™æˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code>OSAtomicIncrement32Barrier</code>æ¥ç¡®ä¿æ•°æ®ç»“æ„çš„å­˜å‚¨æ“ä½œåœ¨å˜é‡è‡ªåŠ¨å¢åŠ å‰å®Œæˆã€‚</p></blockquote><p>ä½¿ç”¨è¿™ä¸ªç±»çš„ç›®çš„ï¼š æ ‡è®°æŸä¸ªæ“ä½œæ˜¯å¦å®Œæˆï¼Œä¹Ÿå³åˆ¤æ–­æˆ–è€…æ ‡è®°å¼‚æ­¥æ¸²æŸ“æ“ä½œçš„å®Œæˆæƒ…å†µ</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;libkern/OSAtomic.h&gt;</span></span></span><br><span class="line"><span class="comment">// çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYSentinel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) int32_t value;</span><br><span class="line">- (int32_t)increase;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYSentinel</span> </span>&#123;</span><br><span class="line">    int32_t _value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int32_t)value &#123;</span><br><span class="line">    <span class="keyword">return</span> _value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int32_t)increase &#123;</span><br><span class="line">    <span class="keyword">return</span> OSAtomicIncrement32(&amp;_value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="YYTransaction"><a href="#YYTransaction" class="headerlink" title="YYTransaction"></a>YYTransaction</h3><p>åªæœ‰ä¸¤ä¸ªæ–¹æ³•æ¥å£ã€‚<br>æ–¹æ³•ä¸€ï¼š åŒ…è£…<code>target</code>å’Œ<code>selector</code>å¹¶ç”Ÿæˆä¸€ä¸ª<code>YYTransaction</code>å¯¹è±¡ã€‚<br>æ–¹æ³•äºŒï¼š commitè¿™ä¸ªå¯¹è±¡ã€‚<br>åŒ…è£…æˆYYTransactionå¯¹è±¡çš„æ–¹æ³•ä¸ç”¨å¤šè¯´ï¼Œå…¶å†…éƒ¨ä½¿ç”¨å®ä¾‹å˜é‡å¼•ç”¨ç€ä¼ é€’çš„å‚æ•°ã€‚<br>æœ€å…³é”®çš„æ˜¯<code>commit</code>æ–¹æ³•ã€‚It will perform the selector on the target once before main runloopâ€™s current loop sleep. If the same transaction (same target and same selector) has already commit to runloop in this loop, this method do nothing. ä¹Ÿå°±æ˜¯è¯´åœ¨Runloopæ¯æ¬¡ä¼‘çœ ä¹‹å‰åªè°ƒç”¨ä¸€æ¬¡<code>target</code>çš„<code>selector</code>æ–¹æ³•ã€‚</p><p>commitæ–¹æ³•å†…éƒ¨ä½¿ç”¨transactionSeté›†åˆæ·»åŠ äº†è¿™ä¸ª<code>YYTransaction</code>å¯¹è±¡ã€‚ä½œè€…ç»™Runloopæ·»åŠ äº†ä¸€ä¸ªobserverï¼Œåœ¨ <code>kCFRunLoopBeforeWaiting</code> å’Œ <code>kCFRunLoopExit</code>è¿™ä¸¤ç§çŠ¶æ€ä¸‹ä¼šè°ƒç”¨æŒ‡å®šçš„<code>YYRunLoopObserverCallBack()</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å¾ˆç®€å•ï¼šé€ä¸ªéå†transactionSeté›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½¿å…¶<code>target</code>è°ƒç”¨å¯¹åº”çš„<code>selector</code>ã€‚</p><p><code>YYTransaction</code>é‡å†™äº†<code>- (NSUInteger)hash</code>æ–¹æ³•å’Œ<code>- (BOOL)isEqual:(id)object</code>æ–¹æ³•æ¥ç¡®å®šâ€œå¯¹è±¡ç›¸ç­‰â€ã€‚è¿™ä¿è¯äº†Seté›†åˆä¸­çš„å…ƒç´ å”¯ä¸€æ€§ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYTransaction</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (YYTransaction *)transactionWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector;</span><br><span class="line">- (<span class="keyword">void</span>)commit;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYTransaction</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) SEL selector;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableSet</span> *transactionSet = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€ä¸ªéå†transactionSetä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½¿å…¶targetè°ƒç”¨å¯¹åº”çš„selector</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> YYRunLoopObserverCallBack(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity, <span class="keyword">void</span> *info) &#123;</span><br><span class="line">    <span class="keyword">if</span> (transactionSet.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">NSSet</span> *currentSet = transactionSet;</span><br><span class="line">    transactionSet = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">    [currentSet enumerateObjectsUsingBlock:^(YYTransaction *transaction, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-performSelector-leaks"</span></span></span><br><span class="line">        [transaction.target performSelector:transaction.selector];</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“Runloopå¤„äºkCFRunLoopBeforeWaitingæˆ–è€…kCFRunLoopExitçš„çŠ¶æ€çš„æ—¶å€™è°ƒç”¨YYRunLoopObserverCallBack()å‡½æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> YYTransactionSetup() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        transactionSet = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        <span class="built_in">CFRunLoopRef</span> runloop = <span class="built_in">CFRunLoopGetMain</span>();</span><br><span class="line">        <span class="built_in">CFRunLoopObserverRef</span> observer;</span><br><span class="line">        </span><br><span class="line">        observer = <span class="built_in">CFRunLoopObserverCreate</span>(<span class="built_in">CFAllocatorGetDefault</span>(),</span><br><span class="line">                                           kCFRunLoopBeforeWaiting | kCFRunLoopExit,</span><br><span class="line">                                           <span class="literal">true</span>,      <span class="comment">// repeat</span></span><br><span class="line">                                           <span class="number">0xFFFFFF</span>,  <span class="comment">// after CATransaction(2000000)</span></span><br><span class="line">                                           YYRunLoopObserverCallBack, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">CFRunLoopAddObserver</span>(runloop, observer, kCFRunLoopCommonModes);</span><br><span class="line">        <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYTransaction</span></span></span><br><span class="line"></span><br><span class="line">+ (YYTransaction *)transactionWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector&#123;</span><br><span class="line">    <span class="keyword">if</span> (!target || !selector) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    YYTransaction *t = [YYTransaction new];</span><br><span class="line">    t.target = target;</span><br><span class="line">    t.selector = selector;</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠç”Ÿæˆçš„YYTransactionå¯¹è±¡æ”¾å…¥transactionSetä¸­</span></span><br><span class="line">- (<span class="keyword">void</span>)commit &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_target || !_selector) <span class="keyword">return</span>;</span><br><span class="line">    YYTransactionSetup();</span><br><span class="line">    [transactionSet addObject:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// isEqual: æ˜¯é€šè¿‡hashæ–¹æ³•æ¥åˆ¤ç­‰çš„</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="keyword">long</span> v1 = (<span class="keyword">long</span>)((<span class="keyword">void</span> *)_selector);</span><br><span class="line">    <span class="keyword">long</span> v2 = (<span class="keyword">long</span>)_target;</span><br><span class="line">    <span class="keyword">return</span> v1 ^ v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªè¦_targetå’Œ_selectoréƒ½ä¸€è‡´ï¼Œå°±è¯´æ˜'YYTransaction'æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> == object) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isMemberOfClass:<span class="keyword">self</span>.class]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    YYTransaction *other = object;</span><br><span class="line">    <span class="keyword">return</span> other.selector == _selector &amp;&amp; other.target == _target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="YYAsyncLayer"><a href="#YYAsyncLayer" class="headerlink" title="YYAsyncLayer"></a>YYAsyncLayer</h3><p>æœ€åæ˜¯YYAsyncLayerçš„å®ç°ï¼Œæœ€æ ¸å¿ƒçš„é€»è¾‘å°±åœ¨è¿™é‡Œäº†ã€‚æˆ‘ä¸€å¹´ä¹‹å‰å°±æ›¾ç»è¯»è¿‡è¿™å—æºç ï¼Œå½“æ—¶æœ‰å¥½å¤šç–‘æƒ‘ï¼Œç°åœ¨å†æ¥çœ‹ï¼Œæœ‰çš„ç–‘æƒ‘å·²ç»è§£å¼€äº†ï¼Œæœ‰çš„è¿˜æ²¡æœ‰ï¼Œåœ¨è¿™è®°å½•ä¸€ä¸‹ã€‚</p><h4 id="1ï¼Œå­çº¿ç¨‹çš„å¤„ç†"><a href="#1ï¼Œå­çº¿ç¨‹çš„å¤„ç†" class="headerlink" title="1ï¼Œå­çº¿ç¨‹çš„å¤„ç†"></a>1ï¼Œå­çº¿ç¨‹çš„å¤„ç†</h4><p>å¼‚æ­¥ï¼Œè‡ªç„¶è¦æ”¾åˆ°å­çº¿ç¨‹ã€‚ä¸»é˜Ÿåˆ—å¯¹åº”çš„æ˜¯ä¸»çº¿ç¨‹ï¼Œ4ä¸ªä¸åŒä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—å¹¶ä¸å¯¹åº”4ä¸ªå­çº¿ç¨‹ã€‚æ¯…ç„¶æ”¾åœ¨å…¨å±€é˜Ÿåˆ—ä¸å¤ªå¯å–ï¼Œå¯èƒ½ä¼šå‡ºç°Appåœ¨åŒä¸€æ—¶åˆ»å­˜åœ¨å‡ åä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œã€åˆ›å»ºã€é”€æ¯çš„æƒ…å†µã€‚â€œå½“å¤§é‡çº¿ç¨‹åŒæ—¶åˆ›å»ºè¿è¡Œé”€æ¯æ—¶ï¼Œè¿™äº›æ“ä½œä»ç„¶ä¼šæŒ¤å æ‰ä¸»çº¿ç¨‹çš„ CPU èµ„æºã€‚â€ã€‚ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—åˆæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„èµ„æºã€‚ä½œè€…åœ¨YYAsyncLayerä¸­çš„æ€è·¯æ˜¯ï¼šåˆ›å»ºå’Œ CPU æ•°é‡ç›¸åŒçš„ä¸²è¡Œqueueï¼ˆæœ€å¤š16ä¸ªï¼‰ï¼Œæ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ¯æ¬¡ä»æ•°ç»„ä¸­éšæœºè·å–å…¶ä¸­çš„ä¸€ä¸ªqueueã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Global display queue, used for content rendering.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> dispatch_queue_t <span class="title">YYAsyncLayerGetDisplayQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_QUEUE_COUNT 16</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> queueCount;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_queue_t</span> queues[MAX_QUEUE_COUNT];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int32_t</span> counter = <span class="number">0</span>;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// è·å–è¿è¡Œè¯¥è¿›ç¨‹çš„ç³»ç»Ÿçš„å¤„äºæ¿€æ´»çŠ¶æ€çš„å¤„ç†å™¨æ•°é‡, iPhone 6s æ˜¯2ä¸ª</span></span><br><span class="line">        queueCount = (<span class="keyword">int</span>)[NSProcessInfo processInfo].activeProcessorCount;</span><br><span class="line">        queueCount = queueCount &lt; <span class="number">1</span> ? <span class="number">1</span> : queueCount &gt; MAX_QUEUE_COUNT ? MAX_QUEUE_COUNT : queueCount;</span><br><span class="line">        <span class="keyword">for</span> (NSUInteger i = <span class="number">0</span>; i &lt; queueCount; i++) &#123;</span><br><span class="line">            <span class="keyword">dispatch_queue_attr_t</span> attr =</span><br><span class="line">            <span class="comment">// QOS_CLASS_USER_INITIATED ç”¨æˆ·å‘èµ·å¹¶ç­‰å¾…çš„ä¼˜å…ˆçº§</span></span><br><span class="line">            dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_USER_INITIATED, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line">            queues[i] = dispatch_queue_create(<span class="string">"com.ibireme.yykit.render"</span>, attr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// å¤§é‡ä½¿ç”¨ OSAtomicIncrement32,ç”±äºè¯¥å‡½æ•°å¯¹æŸä¸ªå€¼è¿›è¡Œè‡ªå¢è®¡ç®—,è€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„,æ‰€ä»¥è¢«ç”¨æ¥ä½œä¸ºç»˜åˆ¶æ—¶çš„æ ‡è®°ä½(å“¨å…µ).å¼‚æ­¥ç»˜åˆ¶çš„å…³é”®åœ¨äºæ¯æ¬¡è°ƒç”¨ setNeedDisplay æ—¶éƒ½ä¼šå°†å“¨å…µå˜é‡è‡ªå¢,åœ¨ display æ–¹æ³•ä¸­,æ ¹æ®è¿™ä¸ªå“¨å…µå˜é‡æ¥ç¡®å®šæ˜¯å¦ç»§ç»­ç»˜åˆ¶è¿˜æ˜¯åœæ­¢ç»˜åˆ¶.ä¸€è‡´åˆ™ç»§ç»­ç»˜åˆ¶, ä¸ä¸€è‡´åˆ™åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">    <span class="keyword">int32_t</span> cur = OSAtomicIncrement32(&amp;counter); <span class="comment">// counterè‡ªå¢ä¸€, å¹¶å–å‡ºè¯¥å€¼,</span></span><br><span class="line">    <span class="keyword">if</span> (cur &lt; <span class="number">0</span>) cur = -cur; <span class="comment">// å•¥æ—¶å€™ä¼šå‡ºç°?? counterå–INT_MAXçš„æ—¶å€™å‡ºç°</span></span><br><span class="line">    <span class="keyword">return</span> queues[(cur) % queueCount]; <span class="comment">// å–ä½™</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> MAX_QUEUE_COUNT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å•çº¯å°±å­çº¿ç¨‹ç»˜åˆ¶è¿™ä¸ªé—®é¢˜è€Œè¨€ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œæ—¢ç„¶ä¼šå‡ºç°â€œåŒä¸€æ—¶åˆ»å­˜åœ¨å‡ åä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œã€åˆ›å»ºã€é”€æ¯â€çš„æƒ…å†µï¼Œé‚£å¦‚æœç›´æ¥æ“ä½œçº¿ç¨‹å‘¢ï¼Œç›´æ¥åˆ›å»ºä¸‰äº”ä¸ªNSThreadå¯¹è±¡ï¼Œè®©å®ƒä»¬å¤„ç†Appä¸­çš„æ‰€æœ‰å¼‚æ­¥æ¸²æŸ“æ“ä½œã€‚å¦‚æœè¿™æ ·çš„è¯ï¼Œå°±éœ€è¦å¯¹è¿™ä¸‰äº”ä¸ªNSThreadå¯¹è±¡è¿›è¡Œçº¿ç¨‹ä¿æ´»ï¼Œä¿è¯å®ƒä»¬æ°¸è¿œå­˜åœ¨ã€‚å†è€…åªèƒ½é€šè¿‡performSelector:onThread:è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼ˆæˆ–è€…å†åšä¸€ä¸ªblockæ–¹å¼çš„å°è£…ï¼‰ã€‚<strong>æœ€åä¹Ÿæ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œæ²¡åŠæ³•åˆ©ç”¨è®¾å¤‡å¤šæ ¸çš„ä¼˜åŠ¿ã€‚</strong>å•æ ¸ä¸­çš„å¤šçº¿ç¨‹å®é™…ä¸Šæ˜¯æ¯ä¸ªæ—¶é—´ç‰‡ä¸Šåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œè€Œå¤šæ ¸å®é™…ä¸Šæ˜¯çœŸçš„å¤šçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªæ—¶é—´ç‰‡æ¯ä¸ªæ ¸éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚dispatch_asyncæ˜¯å¤šæ ¸çº§åˆ«ç¼–ç¨‹æ¡†æ¶è°ƒåº¦å‡½æ•°ï¼Œè¿™æ‰çœŸæ­£å†³å®šäº†ä¸ºå•¥è¦ä½¿ç”¨GCDã€‚</p><h4 id="2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶"><a href="#2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶" class="headerlink" title="2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶"></a>2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é‡å†™ä¿®æ”¹CALayeræˆ–å…¶å­ç±»å±æ€§çš„é»˜è®¤å€¼ï¼Œkeyä¸ºå±æ€§åç§°ï¼Œå¦‚æœæ²¡æœ‰è¯¥å±æ€§åˆ™è¿”å›nilã€‚</span></span><br><span class="line">+ (<span class="keyword">id</span>)defaultValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"displaysAsynchronously"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> @(<span class="literal">YES</span>); <span class="comment">// ä»…ä»…é’ˆå¯¹displaysAsynchronouslyè¿™ä¸ªå±æ€§ä¿®æ”¹</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> defaultValueForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="comment">// è®¾ç½®å±å¹•ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CGFloat</span> scale; <span class="comment">// global</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        scale = [<span class="built_in">UIScreen</span> mainScreen].scale;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">self</span>.contentsScale = scale;</span><br><span class="line">    <span class="comment">// è®¡æ•°å™¨, æ§åˆ¶å¤šçº¿ç¨‹è®¿é—®</span></span><br><span class="line">    _sentinel = [YYSentinel new];</span><br><span class="line">    <span class="comment">// é»˜è®¤æ˜¯YES</span></span><br><span class="line">    _displaysAsynchronously = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>displaysAsynchronously</code>æ¥æ§åˆ¶æ˜¯å¦å¼€å¯å¼‚æ­¥æ¸²æŸ“ã€‚<br>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜æƒ³ä¸é€šï¼ŒYYAsyncLayerçš„initæ–¹æ³•ä¸­å·²ç»åˆå§‹åŒ–<code>_displaysAsynchronously</code>çš„å€¼ä¸ºYESäº†ï¼Œä½†æ˜¯ä½œè€…åˆé‡å†™defaultValueForKeyæ–¹æ³•å¹¶åœ¨å…¶ä¸­å†æ¬¡è®¾ç½®displaysAsynchronouslyå±æ€§ä¸ºYESã€‚è¿™ä¸¤ä¸ªæ–¹å¼çš„æ•ˆæœä¸€æ ·å‘€ï¼Œä¼šä¸ä¼šå¤šæ­¤ä¸€ä¸¾äº†å‘¢ï¼Ÿ</p><h4 id="3ï¼Œç»˜åˆ¶æ—¶æœº"><a href="#3ï¼Œç»˜åˆ¶æ—¶æœº" class="headerlink" title="3ï¼Œç»˜åˆ¶æ—¶æœº"></a>3ï¼Œç»˜åˆ¶æ—¶æœº</h4><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="comment">// layeré”€æ¯çš„æ—¶å€™, è®¡æ•°å™¨åŠ 1, è¡¨ç¤ºåŸå…ˆçš„ç»˜åˆ¶éœ€è¦å–æ¶ˆ</span></span><br><span class="line">    [<span class="meta">_sentinel increase</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNeedsDisplay &#123;</span><br><span class="line">    <span class="comment">// è¢«æ ‡è®°éœ€è¦é‡æ–°ç»˜åˆ¶, åˆ™å–æ¶ˆä¸Šæ¬¡çš„å¼‚æ­¥è°ƒç”¨</span></span><br><span class="line">    [<span class="meta">self _cancelAsyncDisplay</span>];</span><br><span class="line">    [<span class="meta">super setNeedsDisplay</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reload the content of this layer.</span></span><br><span class="line"><span class="comment">// Subclasses can override this method and use it to set the layerâ€™s contents property directly. You might do this if your custom layer subclass handles layer updates differently.</span></span><br><span class="line">- (<span class="keyword">void</span>)display &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªèµ‹å€¼æ˜¯å› ä¸ºè¿™æ ·å—??</span></span><br><span class="line">    <span class="comment">// Assigning a value to this property causes the layer to use your image rather than create a separate backing store.</span></span><br><span class="line">    super.contents = super.contents;</span><br><span class="line">    [<span class="meta">self _displayAsync:_displaysAsynchronously</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)_cancelAsyncDisplay &#123;</span><br><span class="line">    <span class="comment">// increaseå¢åŠ 1, ä¸ç›®å‰çš„ä¸ä¸€è‡´äº†, è¡¨ç¤ºç›®å‰çš„æ¸²æŸ“å·²å–æ¶ˆ</span></span><br><span class="line">    [<span class="meta">_sentinel increase</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®é™…çš„ç»˜åˆ¶é€»è¾‘ä¸­ï¼Œæ˜¯é€šè¿‡åˆ¤æ–­è®¡æ•°å™¨<code>_sentinel</code>çš„å€¼æ¥ç¡®å®šæ˜¯å¦å–æ¶ˆç»˜åˆ¶ï¼š<br><figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line">YYSentinel *sentinel = <span class="number">_</span>sentinel;</span><br><span class="line">int<span class="number">32_</span>t <span class="keyword">value</span> = sentinel.<span class="keyword">value</span>;</span><br><span class="line">BOOL (^isCancelled)(<span class="keyword">void</span>) = ^BOOL() &#123;</span><br><span class="line">  <span class="comment">// å€¼ç›¸ç­‰, è¯´æ˜æ­£åœ¨ç»˜åˆ¶æ²¡æœ‰å–æ¶ˆ, å¦åˆ™è¯´æ˜å·²ç»å–æ¶ˆå•¦</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">value</span> != sentinel.<span class="keyword">value</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>åè¿‡æ¥ï¼Œåªéœ€è¦æŠŠè®¡æ•°å™¨çš„å€¼è‡ªå¢ï¼ˆ<code>[_sentinel increase]</code>ï¼‰å°±å¯ä»¥è¡¨ç¤ºç›®å‰çš„ç»˜åˆ¶æ“ä½œå–æ¶ˆäº†ã€‚åœ¨Layeré”€æ¯çš„æ—¶å€™ï¼ˆdeallocï¼‰å’Œè¢«æ ‡è®°éœ€è¦é‡æ–°ç»˜åˆ¶çš„æ—¶å€™ï¼ˆsetNeedsDisplayï¼‰åº”è¯¥å–æ¶ˆåŸå…ˆçš„ç»˜åˆ¶æ“ä½œã€‚</p><p>æŒ‰ç…§è‹¹æœçš„è¯´æ˜ï¼ŒCALayerçš„å­ç±»å¯ä»¥é‡å†™displayæ–¹æ³•å¹¶åœ¨å…¶ä¸­ç›´æ¥è®¾ç½®contentsã€‚YYAsyncLayerä¾¿åœ¨å…¶ä¸­åšäº†å¼‚æ­¥ç»˜åˆ¶æ“ä½œã€‚è¿™é‡Œçš„<code>super.contents = super.contents;</code>ä¸€å¥è¯ç¡®å®å½“ç„¶æ²¡çœ‹æ‡‚ï¼Œåæ¥å‘ç°ä¹Ÿæœ‰å°ä¼™ä¼´è·Ÿæˆ‘ä¸€æ ·æ²¡å¼„æ˜ç™½ï¼Œç„¶åæŸ¥é˜…èµ„æ–™å‘ç°äº†è‹¹æœçš„è§£é‡Šï¼šAssigning a value to this property causes the layer to use your image rather than create a separate backing store.</p><h4 id="4ï¼Œç»˜åˆ¶æ“ä½œ"><a href="#4ï¼Œç»˜åˆ¶æ“ä½œ" class="headerlink" title="4ï¼Œç»˜åˆ¶æ“ä½œ"></a>4ï¼Œç»˜åˆ¶æ“ä½œ</h4><p>æœ€åä¾¿æ˜¯ç»˜åˆ¶çš„æ“ä½œäº†ï¼Œå†™äº†å¾ˆè¯¦ç»†çš„æ³¨é‡Šï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)_displayAsync:(<span class="built_in">BOOL</span>)async &#123;</span><br><span class="line">    <span class="comment">// å¼ºå¼•ç”¨ä»£ç†, é¿å…é‡Šæ”¾</span></span><br><span class="line">    __<span class="keyword">strong</span> <span class="keyword">id</span>&lt;YYAsyncLayerDelegate&gt; delegate = (<span class="keyword">id</span>)<span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="comment">// è·å–ä¸€ä¸ªDisplay Task</span></span><br><span class="line">    YYAsyncLayerDisplayTask *task = [delegate newAsyncDisplayTask];</span><br><span class="line">    <span class="keyword">if</span> (!task.display) &#123; <span class="comment">// æ²¡æœ‰éœ€è¦ç»˜åˆ¶çš„å†…å®¹, è®¾ç½®contentsä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (async) &#123; <span class="comment">// å¼‚æ­¥ç»˜åˆ¶</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        YYSentinel *sentinel = _sentinel;</span><br><span class="line">        int32_t value = sentinel.value;</span><br><span class="line">        <span class="built_in">BOOL</span> (^isCancelled)(<span class="keyword">void</span>) = ^<span class="built_in">BOOL</span>() &#123;</span><br><span class="line">            <span class="comment">// å€¼ç›¸ç­‰, è¯´æ˜æ­£åœ¨ç»˜åˆ¶æ²¡æœ‰å–æ¶ˆ, å¦åˆ™è¯´æ˜å·²ç»å–æ¶ˆå•¦</span></span><br><span class="line">            <span class="keyword">return</span> value != sentinel.value;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">CGSize</span> size = <span class="keyword">self</span>.bounds.size;</span><br><span class="line">        <span class="built_in">BOOL</span> opaque = <span class="keyword">self</span>.opaque;</span><br><span class="line">        <span class="built_in">CGFloat</span> scale = <span class="keyword">self</span>.contentsScale;</span><br><span class="line">        <span class="comment">// è·å–èƒŒæ™¯è‰²</span></span><br><span class="line">        <span class="built_in">CGColorRef</span> backgroundColor = (opaque &amp;&amp; <span class="keyword">self</span>.backgroundColor) ? <span class="built_in">CGColorRetain</span>(<span class="keyword">self</span>.backgroundColor) : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (size.width &lt; <span class="number">1</span> || size.height &lt; <span class="number">1</span>) &#123; <span class="comment">// å®½æˆ–è€…é«˜å°äº1çš„æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// è·å–å›¾ç‰‡å†é‡Šæ”¾æ‰, ä¸ºå•¥è¦å¤šæ­¤ä¸€ä¸¾?</span></span><br><span class="line">            <span class="comment">// å› ä¸ºèµ‹å€¼ç»™contentsçš„å°±æ˜¯ä¸€ä¸ªCGImageRef, å¦‚æœç›´æ¥self.contents = nil;ä¼šé€ æˆè¿™ä¸ªimageåœ¨å½“å‰çº¿ç¨‹(ä¸»çº¿ç¨‹)é‡Šæ”¾ã€‚ä½œè€…æ‰‹åŠ¨æŠŠè¿™ä¸ªimageå–å‡ºæ¥çš„ç›®çš„å°±æ˜¯æŠŠ'release'æ“ä½œæ”¾åœ¨YYAsyncLayerGetReleaseQueue()è¿™ä¸ªé˜Ÿåˆ—ä¸­</span></span><br><span class="line">            <span class="built_in">CGImageRef</span> image = (__bridge_retained <span class="built_in">CGImageRef</span>)(<span class="keyword">self</span>.contents);</span><br><span class="line">            <span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(YYAsyncLayerGetReleaseQueue(), ^&#123;</span><br><span class="line">                    <span class="built_in">CFRelease</span>(image);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">            <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»è¿™é‡Œå¼€å§‹è¿›å…¥å­çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(YYAsyncLayerGetDisplayQueue(), ^&#123;</span><br><span class="line">            <span class="comment">// è¿›å…¥å­çº¿ç¨‹å, ç¬¬1æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼€å¯å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">            <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, opaque, scale);</span><br><span class="line">            <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">            <span class="keyword">if</span> (opaque) &#123;</span><br><span class="line">            <span class="comment">// UIGraphicsPushContext:å‹æ ˆå½“å‰çš„ç»˜åˆ¶å¯¹è±¡, ç”Ÿæˆæ–°çš„ç»˜åˆ¶å›¾å±‚ã€‚UIKitçš„ç»˜åˆ¶å¿…é¡»åœ¨å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­ç»˜åˆ¶ï¼Œè€ŒUIGraphicsPushContextå¯ä»¥å°†å½“å‰çš„å‚æ•°contextè½¬åŒ–ä¸ºå¯ä»¥UIKitç»˜åˆ¶çš„ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œç»˜åˆ¶å›¾ç‰‡ã€‚</span></span><br><span class="line">            <span class="comment">// CGContextSaveGState:å‹æ ˆå½“å‰çš„ç»˜åˆ¶çŠ¶æ€</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯ä¸ºäº†ä¸"æ±¡æŸ“"åŸå…ˆçš„contextå†…å®¹, ä¿å­˜çŠ¶æ€åç»˜åˆ¶æ–°çš„å†…å®¹</span></span><br><span class="line">                <span class="built_in">CGContextSaveGState</span>(context);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰èƒŒæ™¯è‰²æˆ–è€… é€æ˜åº¦å°äº1, ä½¿ç”¨ç™½è‰²å¡«å……</span></span><br><span class="line">                    <span class="keyword">if</span> (!backgroundColor || <span class="built_in">CGColorGetAlpha</span>(backgroundColor) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="built_in">CGContextSetFillColorWithColor</span>(context, [<span class="built_in">UIColor</span> whiteColor].CGColor);</span><br><span class="line">                        <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width * scale, size.height * scale));</span><br><span class="line">                        <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œä½¿ç”¨backgroundColorå¡«å……</span></span><br><span class="line">                    <span class="keyword">if</span> (backgroundColor) &#123;</span><br><span class="line">                        <span class="built_in">CGContextSetFillColorWithColor</span>(context, backgroundColor);</span><br><span class="line">                        <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width * scale, size.height * scale));</span><br><span class="line">                        <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">CGContextRestoreGState</span>(context);</span><br><span class="line">                <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">            &#125;</span><br><span class="line">            task.display(context, size, isCancelled);</span><br><span class="line">            <span class="comment">// displayå®Œæ¯•å, ç¬¬2æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœç¡®å®šå·²ç»å–æ¶ˆç»˜åˆ¶äº†, å…³é—­å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">                <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»å½“å‰ä¸Šä¸‹æ–‡ä¸­è·å–ç”Ÿæˆçš„æ–°å†…å®¹</span></span><br><span class="line">            <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">            <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">            <span class="comment">// ä»ä¸Šä¸‹æ–‡ä¸­è·å–å›¾ç‰‡å, ç¬¬3æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                <span class="comment">// è½¬åˆ°ä¸»çº¿ç¨‹å¯¹contentsèµ‹å€¼ï¼Œç¬¬4æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// åœ¨è¿™é‡Œå¯¹contentsèµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// éå¼‚æ­¥ç»˜åˆ¶</span></span><br><span class="line">        <span class="comment">// ä¸éœ€è¦è¿›è¡Œçº¿ç¨‹å®‰å…¨åˆ¤æ–­äº†</span></span><br><span class="line">        [_sentinel increase];</span><br><span class="line">        <span class="comment">// ä¸‹é¢çš„ä»£ç éƒ½æ˜¯å’Œå¼‚æ­¥ç»˜åˆ¶ç›¸åŒçš„å¥—è·¯</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(<span class="keyword">self</span>.bounds.size, <span class="keyword">self</span>.opaque, <span class="keyword">self</span>.contentsScale);</span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.opaque) &#123;</span><br><span class="line">            <span class="built_in">CGSize</span> size = <span class="keyword">self</span>.bounds.size;</span><br><span class="line">            size.width *= <span class="keyword">self</span>.contentsScale;</span><br><span class="line">            size.height *= <span class="keyword">self</span>.contentsScale;</span><br><span class="line">            <span class="built_in">CGContextSaveGState</span>(context); &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">self</span>.backgroundColor || <span class="built_in">CGColorGetAlpha</span>(<span class="keyword">self</span>.backgroundColor) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">CGContextSetFillColorWithColor</span>(context, [<span class="built_in">UIColor</span> whiteColor].CGColor);</span><br><span class="line">                    <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width, size.height));</span><br><span class="line">                    <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.backgroundColor) &#123;</span><br><span class="line">                    <span class="built_in">CGContextSetFillColorWithColor</span>(context, <span class="keyword">self</span>.backgroundColor);</span><br><span class="line">                    <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width, size.height));</span><br><span class="line">                    <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="built_in">CGContextRestoreGState</span>(context);</span><br><span class="line">        &#125;</span><br><span class="line">        task.display(context, <span class="keyword">self</span>.bounds.size, ^&#123;<span class="keyword">return</span> <span class="literal">NO</span>;&#125;);</span><br><span class="line">        <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">        <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">        <span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br><span class="line">        <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>çœ‹èµ·æ¥è²Œä¼¼å¾ˆå¤šï¼Œå®é™…çš„ç»˜åˆ¶åŸç†ä¸‰è¡Œä»£ç å¯ä»¥è¯´æ¸…æ¥šï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¼Œä»å½“å‰å›¾å½¢ä¸Šä¸‹æ–‡ä¸­è·å–Image</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line"><span class="comment">// 2ï¼Œå…³é—­å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line"><span class="comment">// 3ï¼Œå°†imageèµ‹å€¼ç»™layerçš„contentså±æ€§</span></span><br><span class="line"><span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¹‹å¤–æ›´å¤šçš„æ˜¯ æ˜¯å¦å–æ¶ˆç»˜åˆ¶çš„åˆ¤æ–­ã€æ²¡æœ‰èƒŒæ™¯è‰²æˆ–è€…é€æ˜åº¦å°äº1çš„å¤„ç†ã€sizeæå°å€¼çš„å¤„ç†ç­‰ç­‰ã€‚</p><p>å½“ç„¶è¿˜æœ‰é‚£ä¸ªå·§å¦™çš„å­çº¿ç¨‹å¼‚æ­¥é‡Šæ”¾å¯¹è±¡çš„é€»è¾‘ï¼Œè®°å¾—ä¹Ÿè§è¿‡å¥½å¤šæ¬¡äº†ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGImageRef</span> image = (__bridge_retained <span class="built_in">CGImageRef</span>)(<span class="keyword">self</span>.contents);</span><br><span class="line"><span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">if</span> (image) &#123;</span><br><span class="line"> <span class="built_in">dispatch_async</span>(YYAsyncLayerGetReleaseQueue(), ^&#123;</span><br><span class="line">     <span class="built_in">CFRelease</span>(image);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¹³æ—¶çš„ä¸šåŠ¡å¼€å‘ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ä¹ˆç”¨ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">// å«æœ‰å¤§é‡å…ƒç´ çš„æ•°ç»„</span><br><span class="line">NSMutableArray *array = self.itemArray;</span><br><span class="line">self.itemArray = nil;</span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">  <span class="built_in"> array </span>= nil; // å­çº¿ç¨‹é‡Šæ”¾</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h1 id="ä¸‰ã€å°ç»“"><a href="#ä¸‰ã€å°ç»“" class="headerlink" title="ä¸‰ã€å°ç»“"></a>ä¸‰ã€å°ç»“</h1><p><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">ã€ŠiOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ã€‹</a>è¿™ç¯‡æ–‡ç« æƒ³å¿…å¾ˆå¤šäººéƒ½æœ‰äººé˜…è¯»è¿‡ï¼Œä¹Ÿéƒ½èƒ½ä»ä¸­å—ç›Šã€‚<br>è¿™é‡Œå›é¡¾ä¸€ä¸‹ibiremeå¤§ç¥çš„å¾®åšDemoæ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼š<br><strong>1ï¼Œé¢„æ’ç‰ˆ</strong><br>è¿™é‡Œæ˜¯æŒ‡ä¸å®šé«˜cellçš„é¢„æ’ç‰ˆï¼Œæœ¬æ–‡ä¹Ÿå·²ç»æè¿‡ï¼Œframeå¸ƒå±€ï¼Œå¯ä»¥å­çº¿ç¨‹æ‰‹åŠ¨è®¡ç®—å¹¶æŠŠlayoutæ•°æ®ç¼“å­˜åœ¨æ¨¡å‹ä¸­ï¼Œautolayoutå¸ƒå±€ï¼Œå¯ä»¥å€ŸåŠ©FDTemplateLayoutCellåšé«˜åº¦ç¼“å­˜ã€‚<br><strong>2ï¼Œé¢„æ¸²æŸ“</strong><br>ä½œè€…ä¸¾äº†ä¸€ä¸ªåœ†è§’å›¾ç‰‡é¢„å…ˆè£å‰ªå¹¶åšç¼“å­˜å¤„ç†æ¥é¿å…ç¦»å±æ¸²æŸ“çš„ä¾‹å­ï¼Œä¹Ÿæ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œlayer.cornerRadius + layer.masksToBoundsä¸€èµ·è®¾ç½®åœ¨æ–°ç‰ˆæœ¬ç³»ç»Ÿä¸Šå·²ç»ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼ˆå¤§å¤šæ•°äººè¯´æ˜¯iOS9ï¼Œæˆ‘è¿˜æ²¡æœ‰ç¡®è®¤ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªæ€è·¯å¯ä»¥ä¸¾ä¸€åä¸‰ï¼Œå¾ˆå¤šå¯ä»¥æå‰çš„å·¥ä½œæ²¡å¿…è¦ç­‰åˆ°cellè¦å±•ç¤ºäº†æ‰å¼€å§‹åšã€‚<br><strong>3ï¼Œå¼‚æ­¥ç»˜åˆ¶+å…¨å±€å¹¶å‘æ§åˆ¶</strong></p><ul><li>å€ŸåŠ©YYDispatchQueuePoolæŠŠAppå†…æ‰€æœ‰å¼‚æ­¥æ“ä½œæŒ‰ä¼˜å…ˆçº§ä¸åŒæ”¾å…¥äº†å…¨å±€çš„ serial queue ä¸­æ‰§è¡Œï¼Œå°½é‡é¿å…äº†è¿‡å¤šçº¿ç¨‹å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚</li><li>å€ŸåŠ©YYAsyncLayerå’ŒCoreTextå®ç°å¯Œæ–‡æœ¬çš„å¼‚æ­¥ç»˜åˆ¶ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åŠŸèƒ½æ›´å¼ºå¤§çš„YYTextï¼Œä½œè€…æŠŠè·¯éƒ½ç»™é“ºå¥½äº†ğŸ˜‚ï¼‰ã€‚<br><strong>4ï¼Œå¼‚æ­¥å›¾ç‰‡åŠ è½½</strong><br>å¤§å¤šæ—¶å€™ï¼Œåªæ˜¯æ˜¾ç¤ºç®€å•çš„å•å¼ å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨UIView.layer.contentsï¼Œè€Œä¸éœ€è¦ä½¿ç”¨UIImageViewã€‚å½“ç„¶ï¼ŒSDWebImageå’ŒYYWebImageæŠŠå¾ˆå¤šå·¥ä½œéƒ½åšå¥½äº†ã€‚<br><strong>5ï¼Œä¸éœ€è¦è§¦æ‘¸äº‹ä»¶çš„UIViewæ¢æˆCALayer</strong><br>å¯ä»¥è¿™ä¹ˆåšï¼Œä½†æ˜¯CALayeræ²¡æ³•è®¾ç½®çº¦æŸäº†ï¼Œå¦‚æœä½¿ç”¨è‡ªåŠ¨å¸ƒå±€å°±å¾ˆè›‹ç–¼äº†ã€‚<br><strong>6ï¼Œå¤šä¸ªè§†è§‰å…ƒç´ åˆæˆä¸€å¼ å›¾</strong><br>ä¹Ÿæ˜¯ä¸€ç§æ€è·¯ï¼Œç”šè‡³ä¹Ÿä¸€å®šæ¡ä»¶ä¸‹å¯ä»¥æŠŠcellçš„å…¨éƒ¨å†…å®¹åˆæˆä¸€å¼ å›¾ç‰‡ï¼Œä½†æ˜¯å¯èƒ½æ€§æ¯”è¾ƒå°ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡æ¥èµ°ã€‚<br>ä»¥å¾®åšä¸ºä¾‹ï¼Œâ€œæ¥è‡ªiPhoneâ€ã€ä¼šå‘˜å›¾æ ‡ã€è¯é¢˜ã€è½¬å‘å¾®åšåŸä½œè€…æ˜µç§°ã€å¾®åšå†…å®¹çš„é“¾æ¥è¿™äº›å…ƒç´ éƒ½éœ€è¦å“åº”ç‚¹å‡»äº‹ä»¶ï¼Œæ ¹æœ¬ä¸å¯èƒ½ç”¨ä¸€ç§å›¾ç‰‡ä»£æ›¿ã€‚<br>ç™¾åº¦çš„feedæµï¼Œå¾ˆå¤šæ–°é—»çš„æ ·å¼æ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”ä¸åƒå¾®åšéœ€è¦å¤„ç†å¾ˆå¤šå­å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ï¼Œå¾ˆå¤šæƒ…å†µä¸‹åªéœ€è¦å¤„ç†cellçš„ç‚¹å‡»äº‹ä»¶å°±å¯ä»¥äº†ï¼Œè¿™æ‰æœ‰åˆæˆä¸€å¼ å›¾ç‰‡çš„å¯èƒ½æ€§ã€‚</li></ul><p>è¿‡æ—©çš„ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºï¼Œæ‰€æœ‰çš„tipséƒ½åªæ˜¯å»ºè®®ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚å¾ˆå¤šå‰è¾ˆç»™æˆ‘ä»¬æä¾›äº†è¯¸å¤šä¾¿åˆ©çš„å·¥å…·ï¼Œå¯¹äºæˆ‘ä»¬ï¼Œå¹³æ—¶è¸è¸å®å®å†™ä»£ç ï¼Œå°‘å†™bugï¼Œä¸å†™crashï¼Œè¿™æ‰æ˜¯æœ€é‡è¦çš„ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">ã€ŠiOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ã€‹</a><br><a href="http://tutuge.me/2015/02/19/æå‡UITableViewæ€§èƒ½-å¤æ‚é¡µé¢çš„ä¼˜åŒ–/" target="_blank" rel="noopener">ã€Šæå‡UITableViewæ€§èƒ½-å¤æ‚é¡µé¢çš„ä¼˜åŒ–ã€‹</a><br><a href="https://www.jianshu.com/p/15b8b1844e9c" target="_blank" rel="noopener">ã€ŠiOS é˜´å½±ï¼Œåœ†è§’ï¼Œé¿å…ç¦»å±æ¸²æŸ“ã€‹</a><br><a href="https://juejin.im/post/5acf34eff265da237314d6e0" target="_blank" rel="noopener">ã€ŠUITableView æ€§èƒ½ä¼˜åŒ–ã€‹</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚&lt;/p&gt;&lt;br&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://blog.chenyalun.com/categories/iOS/"/>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>NSNotificationCenteræ¢ç´¢</title>
    <link href="http://blog.chenyalun.com/2019/01/28/NSNotificationCenter%E6%8E%A2%E7%B4%A2/"/>
    <id>http://blog.chenyalun.com/2019/01/28/NSNotificationCenteræ¢ç´¢/</id>
    <published>2019-01-28T13:12:23.000Z</published>
    <updated>2019-10-15T02:20:11.886Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2019å¹´10æœˆ14æ—¥ æ›´æ–°æºç </p></blockquote><p></p><p align="center"> æ¢ç©¶NSNotificationCenterçš„å®ç°å¹¶å°è¯•è‡ªå®ç°ã€‚ </p><br><a id="more"></a><p></p><h1 id="ä¸€ã€åŒæ­¥é€šçŸ¥"><a href="#ä¸€ã€åŒæ­¥é€šçŸ¥" class="headerlink" title="ä¸€ã€åŒæ­¥é€šçŸ¥"></a>ä¸€ã€åŒæ­¥é€šçŸ¥</h1><h2 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h2><p>NSNotificationå¹¶ä¸å¤æ‚ï¼Œå°è£…äº†nameã€objectä»¥åŠuserInfoï¼Œä½¿ç”¨æŒ‡å®šæ„é€ å™¨åˆå§‹åŒ–å³å¯ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSNotification</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>, <span class="title">NSCoding</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSNotificationName</span> name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">readonly</span>, <span class="keyword">retain</span>) <span class="keyword">id</span> object;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSDictionary</span> *userInfo;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSNotificationName</span>)name object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object userInfo:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)userInfo;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSNotification</span> (<span class="title">NSNotificationCreation</span>)</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)notificationWithName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)notificationWithName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject userInfo:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)aUserInfo;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><p>NSNotificationCenteråˆ™ç»™æˆ‘ä»¬æä¾›äº†æ·»åŠ é€šçŸ¥æ¥æ”¶è€…ã€å‘é€é€šçŸ¥çš„æ¥å£ã€‚NSNotificationNameå°±æ˜¯<code>NSString *</code>ï¼ŒdefaultCenteræ˜¯å•ä¾‹ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSNotificationCenter</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="keyword">void</span> *_impl;</span><br><span class="line">    <span class="keyword">void</span> *_callback;</span><br><span class="line">    <span class="keyword">void</span> *_pad[<span class="number">11</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) <span class="built_in">NSNotificationCenter</span> *defaultCenter;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="keyword">id</span>)observer selector:(SEL)aSelector name:(<span class="keyword">nullable</span> <span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)postNotification:(<span class="built_in">NSNotification</span> *)notification;</span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject userInfo:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)aUserInfo;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer;</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer name:(<span class="keyword">nullable</span> <span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span> &lt;<span class="built_in">NSObject</span>&gt;)addObserverForName:(<span class="keyword">nullable</span> <span class="built_in">NSNotificationName</span>)name object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)obj queue:(<span class="keyword">nullable</span> <span class="built_in">NSOperationQueue</span> *)queue usingBlock:(<span class="keyword">void</span> (^)(<span class="built_in">NSNotification</span> *note))block;</span><br><span class="line">    <span class="comment">// The return value is retained by the system, and should be held onto by the caller in order to remove the observer with removeObserver: later, to stop observation.</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><h2 id="æ·»åŠ observer"><a href="#æ·»åŠ observer" class="headerlink" title="æ·»åŠ observer"></a>æ·»åŠ observer</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="keyword">id</span>)observer selector:(SEL)aSelector name:(<span class="keyword">nullable</span> <span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br></pre></td></tr></table></figure><p>æœ€å¸¸ç”¨çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼ŒæŒ‡å®šobserverã€selectorã€nameä»¥åŠobjectå³å¯ã€‚å®ƒåšäº†ä»€ä¹ˆå‘¢ï¼Ÿ<br>è‹¹æœå®˜æ–¹æ–‡æ¡£è§£é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p>Adds an entry to the notification centerâ€™s dispatch table with an observer and a notification selector, and an optional notification name and sender.<br>Parameters</p></blockquote><blockquote><p>observer: Object registering as an observer.</p></blockquote><blockquote><p>aSelector: Selector that specifies the message the receiver sends observer to notify it of the notification posting. The method specified by aSelector must have one and only one argument (an instance of NSNotification).</p></blockquote><blockquote><p>aName: The name of the notification for which to register the observer; that is, only notifications with this name are delivered to the observer.<br>If you pass nil, the notification center doesnâ€™t use a notificationâ€™s name to decide whether to deliver it to the observer.</p></blockquote><blockquote><p>anObject: The object whose notifications the observer wants to receive; that is, only notifications sent by this sender are delivered to the observer.<br>If you pass nil, the notification center doesnâ€™t use a notificationâ€™s sender to decide whether to deliver it to the observer.</p></blockquote><blockquote><p>If your app targets iOS 9.0 and later or macOS 10.11 and later, you donâ€™t need to unregister an observer in its dealloc method. Otherwise, you should call removeObserver:name:object: before observer or any object passed to this method is deallocated</p></blockquote><p>ç®€å•è§£é‡Šå°±æ˜¯ï¼ŒæŠŠå¿…éœ€çš„observerã€selectorå’Œå¯é€‰çš„nameã€objectæ³¨å†Œåˆ°é€šçŸ¥ä¸­å¿ƒã€‚è¿™ä¸ªselectoræœ‰ä¸”åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°æ˜¯NSNotificationå¯¹è±¡ã€‚è‹¥æŒ‡å®šäº†é€šçŸ¥çš„nameï¼Œåˆ™observerå¿…é¡»åŒ¹é…ç›¸åŒçš„nameé€šçŸ¥ä¸­å¿ƒæ‰ä¼šæŠŠæ¶ˆæ¯åˆ†å‘ç»™å®ƒï¼ŒåŒæ ·ï¼Œè‹¥æŒ‡å®šäº†é€šçŸ¥çš„objectï¼Œåˆ™observerå¿…é¡»åŒ¹é…ç›¸åŒçš„objecté€šçŸ¥ä¸­å¿ƒæ‰ä¼šæŠŠæ¶ˆæ¯åˆ†å‘ç»™å®ƒã€‚åœ¨iOS9.0æˆ–è€…macOS 10.11ä¹‹åï¼Œå’±ä»¬ä¸å¿…è¦åœ¨observerçš„deallocæ–¹æ³•ä¸­å–æ¶ˆæ³¨å†Œäº†ï¼ˆç°åœ¨åŸºæœ¬éƒ½è¦æ±‚æœ€ä½æ˜¯iOS9äº†ï¼‰ã€‚</p><p>å†çœ‹çœ‹åŠé—´GNUçš„è§£é‡Šï¼š</p><blockquote><p>Registers observer to receive notifications with the name<br> notificationName and/or containing object (one or both of these two must be<br> non-nil; nil acts like a wildcard).  When a notification of name name<br> containing object is posted, observer receives a selector message with this<br> notification as the argument.  The notification center waits for the<br> observer to finish processing the message, then informs the next registree<br> matching the notification, and after all of this is done, control returns<br> to the poster of the notification.  Therefore the processing in the<br> selector implementation should be short.</p></blockquote><blockquote><p>The notification center does not retain observer or object. Therefore,<br> you should always send removeObserver: or removeObserver:name:object: to<br> the notification center before releasing these objects.</p></blockquote><blockquote><p>As a convenience, when built with garbage collection, you do not need to<br> remove any garbage collected observer as the system will do it implicitly.</p></blockquote><blockquote><p>NB. For MacOS-X compatibility, adding an observer multiple times will<br> register it to receive multiple copies of any matching notification, however<br> removing an observer will remove <em>all</em> of the multiple registrations.</p></blockquote><p>æˆ‘ä»¬å¾—åˆ°çš„é‡è¦ä¿¡æ¯æ˜¯ï¼š</p><ol><li>é€šçŸ¥ä¸­å¿ƒä¼šç­‰å¾…æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„observeræŠŠé€šçŸ¥æ¶ˆæ¯å¤„ç†å®Œæ¯•ä¹‹åæ‰ä¼šreturnï¼Œä¹Ÿå³å‘é€é€šçŸ¥æ˜¯åŒæ­¥çš„ã€‚è¿™è¦æ±‚æˆ‘ä»¬å¤„ç†é€šçŸ¥æ¶ˆæ¯çš„é€»è¾‘åº”è¯¥â€œç®€çŸ­â€ã€ä¸ä¼šé•¿æ—¶é—´é˜»å¡ã€‚</li><li>é€šçŸ¥ä¸­å¿ƒå¹¶ä¸å¢åŠ observerå’Œobjectçš„å¼•ç”¨è®¡æ•°ï¼Œå»ºè®®æˆ‘ä»¬é€‚æ—¶removeObserverã€‚</li><li>æ³¨å†Œå®Œå…¨ä¸€è‡´çš„observerä¿¡æ¯ï¼ˆå«nameã€objectã€selectorï¼‰å¤šæ¬¡ï¼Œå›è°ƒä¹Ÿæ˜¯æœ‰å¤šæ¬¡çš„ï¼Œè€Œåªç§»é™¤ä¸€æ¬¡å®Œå…¨ä¸€è‡´çš„observerä¿¡æ¯ï¼Œå´ä¼šæŠŠæ‰€æœ‰çš„observerä¿¡æ¯éƒ½ç§»é™¤æ‰ã€‚</li></ol><p>å¯¹äºç¬¬ä¸‰æ¡è¿™ä¹ˆç†è§£ï¼Œæ³¨å†Œ3æ¬¡ï¼Œå›è°ƒä¹Ÿæ˜¯æœ‰ä¸‰æ¬¡ï¼›è€Œç§»é™¤ä¸€æ¬¡ï¼Œæ‰€æœ‰çš„è¯¥é€šçŸ¥éƒ½è¢«ç§»é™¤äº†ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[NSNotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">dealWithNoti:</span>) <span class="string">name:</span>name <span class="string">object:</span>obj];</span><br><span class="line">[NSNotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">dealWithNoti:</span>) <span class="string">name:</span>name <span class="string">object:</span>obj];</span><br><span class="line">[NSNotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">dealWithNoti:</span>) <span class="string">name:</span>name <span class="string">object:</span>obj];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[NSNotificationCenter.defaultCenter <span class="string">removeObserver:</span>self <span class="string">name:</span>name <span class="string">object:</span>obj];</span><br></pre></td></tr></table></figure></p><p>æºç é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">- (void)addObserver:(id)observer</span><br><span class="line">           selector:(SEL)selector</span><br><span class="line">               <span class="keyword">name</span>:(NSString *)<span class="keyword">name</span></span><br><span class="line">             object:(id)object &#123;</span><br><span class="line">    Observation*list;</span><br><span class="line">    Observation*o;</span><br><span class="line">    NSIMapTablem;</span><br><span class="line">    NSIMapNoden;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lockNCTable(_table);</span><br><span class="line">    <span class="comment">// æ ¹æ®observerå’Œselectorè·å–Observation</span></span><br><span class="line">    o = obsNew(_table, selector, observer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">name</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®nameåœ¨namedè¡¨ä¸­æœç´¢å¯¹åº”çš„NSIMapNode</span></span><br><span class="line">        <span class="function"><span class="title">n</span> = NSIMapNodeForKey(_table-&gt;</span>named, (NSIMapKey)(id)<span class="keyword">name</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123; <span class="comment">// æ²¡æœ‰åœ¨namedè¡¨ä¸­æ‰¾åˆ°</span></span><br><span class="line">            <span class="comment">// ä¼˜å…ˆåœ¨_tableçš„ç¼“å­˜ä¸­æŸ¥æ‰¾, æ‰¾ä¸åˆ°åˆ™åˆ›å»º</span></span><br><span class="line">            m = mapNew(_table);</span><br><span class="line">            <span class="comment">// å°†nameè½¬æ¢ä¸ºä¸å¯å˜çš„name</span></span><br><span class="line">            <span class="keyword">name</span> = [<span class="keyword">name</span> copyWithZone:NSDefaultMallocZone()];</span><br><span class="line">            <span class="comment">// æŠŠnameä½œä¸ºkey, å°†æ–°åˆ›å»ºçš„m(NSIMapTable)è®¾ç½®åˆ°namedè¡¨ä¸­</span></span><br><span class="line">            NSIM<span class="function"><span class="title">apAddPair</span>(_table-&gt;</span>named, (NSIMapKey)(id)<span class="keyword">name</span>, (NSIMapVal)(void *)m);</span><br><span class="line">            NS_CONSUMED(<span class="keyword">name</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åœ¨namedè¡¨ä¸­æ‰¾åˆ°äº†, å–å‡ºNSIMapNodeå¯¹åº”çš„value</span></span><br><span class="line">            <span class="function"><span class="title">m</span> = (NSIMapTable)n-&gt;</span>value.ptr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// objectä½œä¸ºkey, å–å‡ºå…¶åœ¨mè¡¨ä¸­å¯¹åº”çš„NSIMapNode</span></span><br><span class="line">        n = NSIMapNodeForSimpleKey(m, (NSIMapKey)object);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="function"><span class="title">o</span>-&gt;</span>next = -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// mè¡¨ä¸­å–ä¸åˆ°objectå¯¹åº”çš„å€¼, æŠŠObservationç›´æ¥å­˜åˆ°mè¡¨ä¸­</span></span><br><span class="line">            NSIMapAddPair(m, (NSIMapKey)object, (NSIMapVal)o);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// objectä½œä¸ºkey, å–å‡ºå…¶åœ¨mè¡¨ä¸­å¯¹åº”çš„NSIMapNode, è·å–nodeä¸­çš„é“¾è¡¨</span></span><br><span class="line">            <span class="function"><span class="title">list</span> = (Observation *)n-&gt;</span>value.ptr;</span><br><span class="line">            <span class="comment">// æŠŠObservationè¿½åŠ åˆ°é“¾è¡¨çš„æœ€å‰é¢</span></span><br><span class="line">            <span class="function"><span class="title">o</span>-&gt;</span><span class="function"><span class="title">next</span> = list-&gt;</span>next;</span><br><span class="line">            <span class="function"><span class="title">list</span>-&gt;</span>next = o;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object) &#123;</span><br><span class="line">        <span class="comment">// nameä¸å­˜åœ¨, åˆ™ä»namelessè¡¨ä¸­æœç´¢å¯¹åº”çš„NSIMapNode</span></span><br><span class="line">        <span class="function"><span class="title">n</span> = NSIMapNodeForSimpleKey(_table-&gt;</span>nameless, (NSIMapKey)object);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// åŒæ ·çš„é€»è¾‘, æŠŠObservationè¿½åŠ åˆ°é“¾è¡¨çš„æœ€å‰é¢</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="function"><span class="title">o</span>-&gt;</span>next = ENDOBS;</span><br><span class="line">            NSIM<span class="function"><span class="title">apAddPair</span>(_table-&gt;</span>nameless, (NSIMapKey)object, (NSIMapVal)o);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="function"><span class="title">list</span> = (Observation *)n-&gt;</span>value.ptr;</span><br><span class="line">            <span class="function"><span class="title">o</span>-&gt;</span><span class="function"><span class="title">next</span> = list-&gt;</span>next;</span><br><span class="line">            <span class="function"><span class="title">list</span>-&gt;</span>next = o;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// nameå’Œobjectéƒ½ä¸ºç©º, æŠŠObservationè¿½åŠ åˆ°wildcardè¡¨çš„æœ€å‰é¢</span></span><br><span class="line">        <span class="function"><span class="title">o</span>-&gt;</span><span class="function"><span class="title">next</span> = _table-&gt;</span>wildcard;</span><br><span class="line">        _<span class="function"><span class="title">table</span>-&gt;</span>wildcard = o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£é”</span></span><br><span class="line">    unlockNCTable(_table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>namedè¡¨çš„ç»“æ„å¤§è‡´å¦‚æ­¤ï¼š<br><img src="https://image.chenyalun.com/2019/01/28/002.png" style="zoom:50%"></p><p>è€Œnamelessè¡¨åˆ™æ›´ç®€å•ï¼Œobjectä½œä¸ºkeyï¼Œobserveræ•°ç»„ä½œä¸ºvalueã€‚</p><p>è¿˜æœ‰ä¸€ç§æ˜¯ä»¥blockçš„å½¢å¼æ·»åŠ è§‚å¯Ÿè€…ï¼š<br><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(id)</span>addObserverForName:<span class="params">(NSString *)</span>name</span><br><span class="line">                  object:<span class="params">(id)</span>object</span><br><span class="line">                   queue:<span class="params">(NSOperationQueue *)</span>queue</span><br><span class="line">              usingBlock:<span class="params">(NSNotificationBlock)</span>block</span><br></pre></td></tr></table></figure></p><p>ä¸éœ€è¦è®¾ç½®selectorï¼Œè¿˜èƒ½æ–¹ä¾¿åœ°åœ¨blockä¸­æ‰§è¡Œã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)addObserverForName:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                  object:(<span class="keyword">id</span>)object</span><br><span class="line">                   queue:(<span class="built_in">NSOperationQueue</span> *)queue</span><br><span class="line">              usingBlock:(<span class="built_in">NSNotificationBlock</span>)block &#123;</span><br><span class="line">    <span class="built_in">NSNotificationObserver</span> *observer =</span><br><span class="line">    [[<span class="built_in">NSNotificationObserver</span> alloc] initWithQueue:queue block:block];</span><br><span class="line">    [<span class="keyword">self</span> addObserver:observer</span><br><span class="line">         selector:<span class="keyword">@selector</span>(didReceiveNotification:)</span><br><span class="line">             name:name</span><br><span class="line">           object:object];</span><br><span class="line">    <span class="keyword">return</span> observer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç æ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº†addObserver:selector:name:objectæ–¹æ³•ã€‚observeræ²¡æœ‰å˜ï¼Œä½†æ˜¯æŠŠselectoræ›¿æ¢æˆäº†didReceiveNotification:ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveNotification: (<span class="built_in">NSNotification</span> *)notif &#123;</span><br><span class="line">    <span class="keyword">if</span> (_queue != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSNotificationBlockOperation</span> *op = [[<span class="built_in">NSNotificationBlockOperation</span> alloc] </span><br><span class="line">initWithNotification:notif block:_block];</span><br><span class="line">        [_queue addOperation:op];</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">CALL_BLOCK</span>(_block, notif);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>didReceiveNotification:æ–¹æ³•å¤„ç†äº†Queueçš„é€»è¾‘ã€‚å¦‚æœQueueä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨blockã€‚å¦‚æœQueueæ˜¯å­˜åœ¨çš„ï¼Œç»§æ‰¿è‡ªNSOperationçš„NSNotificationBlockOperationå°è£…äº†éœ€è¦å›è°ƒçš„blockå’Œå›ä¼ çš„NSNotificationï¼Œå¹¶åœ¨mainæ–¹æ³•ä¸­è°ƒç”¨äº†è¿™ä¸ªblockã€‚æœ€åï¼Œè¿™ä¸ªoperationè¢«æ·»åŠ åˆ°æŒ‡å®šçš„Queueä¸­æ‰§è¡Œã€‚</p><h2 id="å‘é€é€šçŸ¥"><a href="#å‘é€é€šçŸ¥" class="headerlink" title="å‘é€é€šçŸ¥"></a>å‘é€é€šçŸ¥</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject userInfo:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)aUserInfo;</span><br></pre></td></tr></table></figure><p>å‘é€é€šçŸ¥æœ€ç»ˆæ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                      object:(<span class="keyword">id</span>)object</span><br><span class="line">                    userInfo:(<span class="built_in">NSDictionary</span> *)info &#123;</span><br><span class="line">    <span class="built_in">NSNotification</span> *notification;</span><br><span class="line">    notification = (<span class="keyword">id</span>)<span class="built_in">NSAllocateObject</span>(concrete, <span class="number">0</span>, <span class="built_in">NSDefaultMallocZone</span>());</span><br><span class="line">    notification-&gt;_name = [name copyWithZone: [<span class="keyword">self</span> zone]];</span><br><span class="line">    notification-&gt;_object = [object <span class="keyword">retain</span>];</span><br><span class="line">    notification-&gt;_info = [info <span class="keyword">retain</span>];</span><br><span class="line">    [<span class="keyword">self</span> _postAndRelease: notification];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…³é”®çš„æ˜¯<code>_postAndRelease:</code>çš„å®ç°ï¼š<br><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">- (void)_postAndRelease:(NSNotification *)notification &#123;</span><br><span class="line">    Observation*o;</span><br><span class="line">    unsigned count;</span><br><span class="line">    NSString *<span class="keyword">name</span> = [notification <span class="keyword">name</span>];</span><br><span class="line">    id object;</span><br><span class="line">    GSIMapNoden;</span><br><span class="line">    GSIMapTablem;</span><br><span class="line">    GSIArrayItem i[<span class="number">64</span>];</span><br><span class="line">    GSIArray_t b;</span><br><span class="line">    GSIArray a = &amp;b;</span><br><span class="line">    <span class="comment">// è·å–object</span></span><br><span class="line">    object = [notification object];</span><br><span class="line"></span><br><span class="line">    GSIArrayInitWithZoneAndStaticCapacity(a, _zone, <span class="number">64</span>, i);</span><br><span class="line">    lockNCTable(_table);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ²¡æœ‰æŒ‡å®šnameä¹Ÿæ²¡æœ‰æŒ‡å®šobjectçš„æ‰€æœ‰observer</span></span><br><span class="line">    <span class="function"><span class="title">for</span> (o = _table-&gt;</span><span class="function"><span class="title">wildcard</span> = purgeCollected(WILDCARD); o != ENDOBS; o = o-&gt;</span>next) &#123;</span><br><span class="line">        GSIArrayAddItem(a, (GSIArrayItem)o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šobjectä½†æ˜¯æ²¡æœ‰æŒ‡å®šnameçš„æ‰€æœ‰observer</span></span><br><span class="line">    <span class="keyword">if</span> (object) &#123;</span><br><span class="line">        <span class="function"><span class="title">n</span> = GSIMapNodeForSimpleKey(_table-&gt;</span>nameless, (GSIMapKey)object);</span><br><span class="line">        <span class="keyword">if</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="function"><span class="title">o</span> = ((Observation *)n-&gt;</span>value.ext)</span><br><span class="line">            <span class="keyword">while</span> (o != (Observation *)-<span class="number">1</span>) &#123;</span><br><span class="line">                GSIArrayAddItem(a, (GSIArrayItem)o);</span><br><span class="line">                <span class="function"><span class="title">o</span> = o-&gt;</span>next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šnameè€Œä¸”objectä¹Ÿä¸é€šçŸ¥è¦æ±‚çš„objectç›¸åŒ¹é…çš„æ‰€æœ‰observer</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">name</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">n</span> = GSIMapNodeForKey(_table-&gt;</span>named, (GSIMapKey)((id)<span class="keyword">name</span>));</span><br><span class="line">        <span class="keyword">if</span> (n) &#123;</span><br><span class="line">            <span class="function"><span class="title">m</span> = (GSIMapTable)n-&gt;</span>value.ptr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// objectä¸ºç©º</span></span><br><span class="line">            n = GSIMapNodeForSimpleKey(m, (GSIMapKey)object);</span><br><span class="line">            <span class="keyword">if</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="function"><span class="title">o</span> = ((Observation *)n-&gt;</span>value.ext)</span><br><span class="line">                <span class="keyword">while</span> (o != (Observation *)-<span class="number">1</span>) &#123;</span><br><span class="line">                    GSIArrayAddItem(a, (GSIArrayItem)o);</span><br><span class="line">                    <span class="function"><span class="title">o</span> = o-&gt;</span>next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// objectä¸ä¸ºç©º, ä¸”åŒ¹é…</span></span><br><span class="line">            <span class="keyword">if</span> (object != <span class="literal">nil</span>) &#123;</span><br><span class="line">                n = GSIMapNodeForSimpleKey(m, (GSIMapKey)<span class="literal">nil</span>);</span><br><span class="line">                <span class="keyword">if</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="function"><span class="title">o</span> = ((Observation *)n-&gt;</span>value.ext)</span><br><span class="line">                    <span class="keyword">while</span> (o != (Observation *)-<span class="number">1</span>) &#123;</span><br><span class="line">                        GSIArrayAddItem(a, (GSIArrayItem)o);</span><br><span class="line">                        <span class="function"><span class="title">o</span> = o-&gt;</span>next;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£é”</span></span><br><span class="line">    unlockNCTable(TABLE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†æ•°ç»„a, é€ä¸ªå‘é€é€šçŸ¥</span></span><br><span class="line">    count = GSIArrayCount(a);</span><br><span class="line">    <span class="keyword">while</span> (count-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        o = GSIArrayItemAtIndex(a, count).ext;</span><br><span class="line">        <span class="function"><span class="title">if</span> (o-&gt;</span>next != <span class="number">0</span>) &#123;</span><br><span class="line">            [<span class="function"><span class="title">o</span>-&gt;</span><span class="function"><span class="title">observer</span> performSelector:o-&gt;</span>selector withObject:notification];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç½®ç©ºæ•°ç»„a</span></span><br><span class="line">    lockNCTable(_table);</span><br><span class="line">    GSIArrayEmpty(a);</span><br><span class="line">    unlockNCTable(_table);</span><br><span class="line">    <span class="comment">// releaseé€šçŸ¥å¯¹è±¡</span></span><br><span class="line">    RELEASE(notification);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…³é”®åœ¨äºä»è¡¨ä¸­è·å–ç¬¦åˆè¦æ±‚çš„Observationï¼šåœ¨wildcardè¡¨ä¸­è·å–åŒ¿åä¸”æ²¡æœ‰æŒ‡å®šobjectçš„Observationï¼›åœ¨namelessè¡¨ä¸­è·å–åŒ¹é…objectä½†æ˜¯åŒ¿åçš„Observationï¼›åœ¨namedè¡¨ä¸­è·å–objectä¸ºç©ºçš„Observationå’ŒobjectåŒ¹é…çš„Observationã€‚æŠŠè¿™äº›Observationæ·»åŠ åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œéå†ï¼Œé€ä¸ªè°ƒç”¨selectorã€‚</p><p>é‚£ä¹ˆï¼Œç§»é™¤é€šçŸ¥è‡ªç„¶ä¹Ÿæ˜¯æ ¹æ®nameã€objectã€observerï¼Œæ‰¾åˆ°åŒ¹é…çš„Observationå¯¹è±¡ï¼Œä»ç›¸åº”çš„è¡¨ä¸­ç§»é™¤ï¼Œä¸å†èµ˜è¿°ã€‚</p><h1 id="äºŒã€å¼‚æ­¥é€šçŸ¥"><a href="#äºŒã€å¼‚æ­¥é€šçŸ¥" class="headerlink" title="äºŒã€å¼‚æ­¥é€šçŸ¥"></a>äºŒã€å¼‚æ­¥é€šçŸ¥</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)enqueueNotification:(<span class="built_in">NSNotification</span> *)notification postingStyle:(<span class="built_in">NSPostingStyle</span>)postingStyle;</span><br><span class="line">- (<span class="keyword">void</span>)enqueueNotification:(<span class="built_in">NSNotification</span> *)notification postingStyle:(<span class="built_in">NSPostingStyle</span>)postingStyle coalesceMask:(<span class="built_in">NSNotificationCoalescing</span>)coalesceMask forModes:(<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSRunLoopMode</span>&gt; *)modes;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dequeueNotificationsMatching:(<span class="built_in">NSNotification</span> *)notification coalesceMask:(<span class="built_in">NSUInteger</span>)coalesceMask;</span><br></pre></td></tr></table></figure><p>é€šè¿‡NSNotificationQueueå¯ä»¥å®ç°å¼‚æ­¥é€šçŸ¥ã€‚NSNotificationCoalescingæä¾›äº†èšåˆé€‰é¡¹ï¼Œä¸èšåˆã€æ ¹æ®nameèšåˆä»¥åŠæ ¹æ®å‘é€è€…èšåˆï¼Œä¹Ÿå³å¦‚æœåœ¨é˜Ÿåˆ—ä¸­å·²æœ‰è¯¥ç§é€šçŸ¥ï¼Œå¦‚æœæ»¡è¶³é€‰é¡¹ï¼Œåˆ™ä¸ä¼šè¿›å…¥é˜Ÿåˆ—ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªé€šçŸ¥ã€‚NSPostingStyleåˆ™å¯ä»¥è®¾ç½®é€šçŸ¥å‘é€çš„æ—¶æœºï¼Œç«‹å³åŒæ­¥å‘é€ã€å°½å¯èƒ½å¿«åœ°å‘é€ï¼Œä»¥åŠåœ¨Runloopç©ºé—²æ—¶å‘é€ã€‚</p><p><strong>åœºæ™¯å¦‚ä¸‹ï¼š</strong><br>NSPostWhenIdleï¼šæ¯”å¦‚å½“ç”¨æˆ·æ­£åœ¨è¾“å…¥æ–‡å­—ï¼Œéœ€è¦åœ¨æŸä¸ªæ§ä»¶ä¸Šå®æ—¶å±•ç¤ºæ–‡å­—çš„é•¿åº¦çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨åˆ°è¿™ä¸ªé€‰é¡¹ã€‚<br>NSPostNowï¼šå®æ—¶å‘é€é€šçŸ¥ï¼Œä½†æ˜¯ä¸åŒæ­¥é€šçŸ¥ç›¸æ¯”ï¼Œå…³é”®åœ¨äºèšåˆé€‰é¡¹ï¼šé˜Ÿåˆ—ä¸­å·²æœ‰æ»¡è¶³é€‰é¡¹çš„é€šçŸ¥æ—¶ï¼Œæ˜¯å¦åªä¿ç•™ä¸€ä¸ªã€‚<br>NSPostASAPï¼šå¤šä¸ªé€šçŸ¥è¿›å…¥åˆ°ç¼“å†²åŒºåï¼Œåˆ©ç”¨èšåˆé€‰é¡¹ï¼Œåªç•™ä¸‹ä¸€ä¸ªï¼Œå¹¶å°½å¯èƒ½å¿«åœ°å‘é€é€šçŸ¥ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)enqueueNotification:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">               postingStyle:(<span class="built_in">NSPostingStyle</span>)postingStyle</span><br><span class="line">               coalesceMask:(<span class="built_in">NSUInteger</span>)coalesceMask</span><br><span class="line">                   forModes:(<span class="built_in">NSArray</span> *)modes &#123;</span><br><span class="line">    <span class="keyword">if</span> (modes == <span class="literal">nil</span>) modes = defaultMode; <span class="comment">// é»˜è®¤æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (coalesceMask != <span class="built_in">NSNotificationNoCoalescing</span>) &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦èšåˆ, åˆ™å…ˆæŠŠé˜Ÿåˆ—ä¸­çš„ç›¸åº”çš„notificationç§»é™¤</span></span><br><span class="line">        [<span class="keyword">self</span> dequeueNotificationsMatching:notification</span><br><span class="line">    coalesceMask:coalesceMask];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> (postingStyle) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å‘é€</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSPostNow</span>: &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *mode = [[<span class="built_in">NSRunLoop</span> currentRunLoop] currentMode];</span><br><span class="line">            <span class="comment">// è¦æ±‚å½“å‰Runloopçš„modeéœ€è¦åŒ¹é…, ä¸ç„¶æ— æ•ˆ</span></span><br><span class="line">            <span class="keyword">if</span> (mode == <span class="literal">nil</span> || [modes indexOfObject:mode] != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">                [_center postNotification: notification];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å°½å¯èƒ½æ—©å‘é€(as soon as possible)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSPostASAP</span>:</span><br><span class="line">            add_to_queue(_asapQueue, notification, modes, _zone); <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// åœ¨Runloopç©ºé—²æ—¶å‘é€</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSPostWhenIdle</span>:</span><br><span class="line">            add_to_queue(_idleQueue, notification, modes, _zone); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å…¥å£æ–¹æ³•æ¥çœ‹ï¼Œå…³é”®åœ¨äºadd_to_queue()å‡½æ•°ï¼Œæ ¹æ®NSPostingStyleé€‰é¡¹ï¼ŒæŠŠé€šçŸ¥æ·»åŠ åˆ°_asapQueueé˜Ÿåˆ—æˆ–è€…_idleQueueé˜Ÿåˆ—ã€‚</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">static void add_to_queue(NSNotificationQueueList *queue,</span><br><span class="line">                         NSNotification *notification,</span><br><span class="line">                         NSArray *modes, NSZone *_zone) &#123;</span><br><span class="line">    NSNotificationQueueRegistration *item;</span><br><span class="line">    item = NSZoneCalloc(_zone, <span class="number">1</span>, sizeof(NSNotificationQueueRegistration));</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span>notification = RETAIN(notification);</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span><span class="keyword">name</span> = [notification <span class="keyword">name</span>];</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span>object = [notification object];</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span>modes = [modes copyWithZone: [modes zone]];</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span>next = NULL;</span><br><span class="line">    <span class="function"><span class="title">item</span>-&gt;</span><span class="function"><span class="title">prev</span> = queue-&gt;</span>tail;</span><br><span class="line">    <span class="function"><span class="title">queue</span>-&gt;</span>tail = item;</span><br><span class="line">    <span class="function"><span class="title">if</span> (item-&gt;</span><span class="function"><span class="title">prev</span>) item-&gt;</span><span class="function"><span class="title">prev</span>-&gt;</span>next = item;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!queue-&gt;</span><span class="function"><span class="title">head</span>) queue-&gt;</span>head = item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠnotificationå’Œmodeså°è£…æˆNSNotificationQueueRegistrationï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ°åŒå‘é“¾è¡¨queueçš„å°¾éƒ¨ã€‚</p><p>ä»¥NSPostWhenIdleé€‰é¡¹ä¸ºä¾‹ï¼Œåœ¨Runloopçš„<code>acceptInputForMode:beforeDate:</code>æ–¹æ³•ä¸­æ‰¾åˆ°äº†é€šçŸ¥çš„å‘é€ç—•è¿¹ï¼šGSPrivateNotifyIdle(mode)ã€‚</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void GSPrivateNotifyIdle(NSString *mode) &#123;</span><br><span class="line">    NotificationQueueList*item;</span><br><span class="line">    <span class="function"><span class="title">for</span> (item = currentList(); item; item = item-&gt;</span>next) &#123;</span><br><span class="line">        <span class="function"><span class="title">if</span> (item-&gt;</span>queue) &#123;</span><br><span class="line">            <span class="function"><span class="title">notify</span>(item-&gt;</span><span class="function"><span class="title">queue</span>-&gt;</span>_center,</span><br><span class="line">                   <span class="function"><span class="title">item</span>-&gt;</span><span class="function"><span class="title">queue</span>-&gt;</span>_idleQueue,</span><br><span class="line">                   mode,</span><br><span class="line">                   <span class="function"><span class="title">item</span>-&gt;</span><span class="function"><span class="title">queue</span>-&gt;</span>_zone);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å¾ˆæ˜æœ—äº†ï¼Œnotify()çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä»åŒå‘é“¾è¡¨listä¸­å–å‡ºæ‰€æœ‰çš„ç»“ç‚¹å¯¹è±¡NSNotificationQueueRegistrationï¼Œå¹¶æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚</li><li>éå†è¯¥æ•°ç»„ï¼Œé€ä¸ªä»listä¸­ç§»é™¤ï¼š<code>remove_from_queue(list, item, zone);</code>ã€‚</li><li>éå†è¯¥æ•°ç»„ï¼Œé€ä¸ªå‘é€é€šçŸ¥<code>[NSNotificationCenter.defaultCenter postNotification:notification];</code>ï¼Œè€Œ<code>postNotification:</code>æ–¹æ³•æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨åŒæ­¥é€šçŸ¥ä¸­çš„<code>_postAndRelease:</code>æ–¹æ³•ã€‚</li></ol><p>ä»€ä¹ˆæ—¶å€™å‘é€ï¼Œäº¤ç”±Runloopå¤„ç†ã€‚</p><h1 id="ä¸‰ã€å­çº¿ç¨‹é€šçŸ¥"><a href="#ä¸‰ã€å­çº¿ç¨‹é€šçŸ¥" class="headerlink" title="ä¸‰ã€å­çº¿ç¨‹é€šçŸ¥"></a>ä¸‰ã€å­çº¿ç¨‹é€šçŸ¥</h1><p>å­çº¿ç¨‹é€šçŸ¥è‹¹æœç»™å‡ºäº†æ ‡å‡†çš„<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Notifications/Articles/Threading.html#//apple_ref/doc/uid/20001289-CEGJFDFG" target="_blank" rel="noopener">è§£å†³æ–¹æ¡ˆ</a>ï¼šåˆ©ç”¨NSMachPortã€‚å‡å®šåœ¨Açº¿ç¨‹å‘é€é€šçŸ¥ï¼Œéœ€è¦åœ¨Bçº¿ç¨‹å¤„ç†é€šçŸ¥ï¼Œé‚£ä¹ˆBçº¿ç¨‹ä¸­æ³¨å†ŒNSMachPortï¼ŒAçº¿ç¨‹ä¸­ä½¿ç”¨æ­¤portå‘é€é€šçŸ¥ï¼Œåˆ™Bçº¿ç¨‹å°±èƒ½æ”¶åˆ°æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚</p><p>ç®€å•æ¦‚è¿°å®ç°æ€è·¯å°±æ˜¯ï¼šç»´æŠ¤ä¸€ä¸ªNSNotificationæ•°ç»„ï¼Œæ¥æ”¶åˆ°é€šçŸ¥æ—¶ï¼Œå¦‚æœé€šçŸ¥åˆ†å‘çš„çº¿ç¨‹ä¸æœŸæœ›çš„çº¿ç¨‹ï¼ˆå¤„ç†é€šçŸ¥çš„çº¿ç¨‹ï¼‰ä¸ä¸€è‡´ï¼Œåˆ™æŠŠè¿™ä¸ªé€šçŸ¥æ·»åŠ åˆ°NSNotificationæ•°ç»„ä¸­ï¼Œå¹¶åˆ©ç”¨NSMachPortå‘é€ä¸€ä¸ªâ€œä¿¡å·â€åˆ°æœŸæœ›çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯åˆ›å»ºNSMachPortå¯¹è±¡çš„çº¿ç¨‹ï¼‰ä¸­ï¼Œåœ¨æœŸæœ›çš„çº¿ç¨‹ä¸­æ”¶åˆ°ä¿¡å·åï¼ŒæŠŠé€šçŸ¥ä»NSNotificationæ•°ç»„ä¸­ç§»é™¤ï¼Œå¹¶å¤„ç†ã€‚</p><p>æ¯”å¦‚ï¼Œéœ€è¦åœ¨ä¸»çº¿ç¨‹å‘é€é€šçŸ¥ï¼Œè€Œåœ¨å­çº¿ç¨‹æ¥æ”¶å¹¶å¤„ç†é€šçŸ¥ï¼Œç»“åˆè‹¹æœç»™å‡ºçš„ç¤ºä¾‹ä»£ç ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šçŸ¥åç§°</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">NSNotificationName</span> YADemoNotification = <span class="string">@"YADemoNotification"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAThreadedNotificationHandler</span>: <span class="title">NSObject</span> &lt;<span class="title">NSMachPortDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *notifications;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *notificationThread;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSLock</span> *notificationLock;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMachPort</span> *notificationPort;</span><br><span class="line">- (<span class="keyword">void</span>)setUpThreadingSupport;</span><br><span class="line">- (<span class="keyword">void</span>)processNotification:(<span class="built_in">NSNotification</span> *)notification;</span><br><span class="line"><span class="comment">// Mach port delegate</span></span><br><span class="line">- (<span class="keyword">void</span>)handleMachMessage:(<span class="keyword">void</span> *)msg;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAThreadedNotificationHandler</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setUpThreadingSupport];</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(processNotification:) name:YADemoNotification object:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private methods</span></span><br><span class="line">- (<span class="keyword">void</span>)setUpThreadingSupport &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.notifications) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">self</span>.notifications      = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.notificationLock   = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">    <span class="comment">// é…ç½®æœŸæœ›çº¿ç¨‹ï¼ˆå½“å‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">    <span class="keyword">self</span>.notificationThread = [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½®ç«¯å£æ¶ˆæ¯å¤„ç†çš„çº¿ç¨‹ï¼ˆå½“å‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">    <span class="keyword">self</span>.notificationPort = [[<span class="built_in">NSMachPort</span> alloc] init];</span><br><span class="line">    [<span class="keyword">self</span>.notificationPort setDelegate:<span class="keyword">self</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:<span class="keyword">self</span>.notificationPort forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç«¯å£ä»£ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)handleMachMessage:(<span class="keyword">void</span> *)msg &#123;</span><br><span class="line">    [<span class="keyword">self</span>.notificationLock lock];</span><br><span class="line">    <span class="keyword">while</span> ([<span class="keyword">self</span>.notifications count]) &#123;</span><br><span class="line">        <span class="built_in">NSNotification</span> *notification = [<span class="keyword">self</span>.notifications objectAtIndex:<span class="number">0</span>];</span><br><span class="line">        [<span class="keyword">self</span>.notifications removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">        [<span class="keyword">self</span>.notificationLock unlock];</span><br><span class="line">        [<span class="keyword">self</span> processNotification:notification];</span><br><span class="line">        [<span class="keyword">self</span>.notificationLock lock];</span><br><span class="line">    &#125;;</span><br><span class="line">    [<span class="keyword">self</span>.notificationLock unlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†é€šçŸ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)processNotification:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="built_in">NSThread</span> currentThread] != <span class="keyword">self</span>.notificationThread) &#123;</span><br><span class="line">        <span class="comment">// Forward the notification to the correct thread.</span></span><br><span class="line">        [<span class="keyword">self</span>.notificationLock lock];</span><br><span class="line">        [<span class="keyword">self</span>.notifications addObject:notification];</span><br><span class="line">        [<span class="keyword">self</span>.notificationLock unlock];</span><br><span class="line">        [<span class="keyword">self</span>.notificationPort sendBeforeDate:[<span class="built_in">NSDate</span> date]</span><br><span class="line">                components:<span class="literal">nil</span></span><br><span class="line">                from:<span class="literal">nil</span></span><br><span class="line">                reserved:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Process the notification here;</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å¤„ç†é€šçŸ¥åœ¨%@çº¿ç¨‹"</span>, <span class="built_in">NSThread</span>.currentThread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>åœ¨æ§åˆ¶å™¨ä¸­ï¼Œè¿™æ ·å‘é€é€šçŸ¥ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *thread;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) YAThreadedNotificationHandler *notificationHandler;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)startThread &#123;</span><br><span class="line">    <span class="keyword">self</span>.notificationHandler = [YAThreadedNotificationHandler new];</span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹å‘é€é€šçŸ¥</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [<span class="built_in">NSNotificationCenter</span>.defaultCenter postNotificationName:YADemoNotification object:<span class="literal">nil</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// å­çº¿ç¨‹æ‰‹åŠ¨å¼€å¯Runloop</span></span><br><span class="line">    [<span class="built_in">NSRunLoop</span>.currentRunLoop run];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(startThread) object:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.thread start];    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="å››ã€è‡ªå®ç°"><a href="#å››ã€è‡ªå®ç°" class="headerlink" title="å››ã€è‡ªå®ç°"></a>å››ã€è‡ªå®ç°</h1><p>æœ‰å‡ ä¸ªå¼±å¼•ç”¨å®¹å™¨åœ¨æ—¥å¸¸å·¥ä½œä¸­æ²¡æœ‰ç”¨è¿‡ï¼Œä½†æ˜¯åˆç‰¹åˆ«æƒ³äº²æ‰‹å®è·µä¸€ç•ªã€‚å¶å°”çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œè¯´æ˜¯è‡ªå·±å®ç°äº†ç³»ç»Ÿä¸­é€šçŸ¥ä¸­å¿ƒçš„åŠŸèƒ½ï¼Œå‡ºäºå¥½å¥‡ï¼Œè‡ªå·±ä¹Ÿå°è¯•ä¸€ç•ªï¼Œä¾¿åœ¨è¿™é‡Œæ¨¡ä»¿äº†åŒæ­¥é€šçŸ¥çš„å®ç°ã€‚</p><p>ä¸»è¦åŸç†å°±æ˜¯åˆ›å»ºä¸€ä¸ªå­—å…¸observerMapï¼Œnotification nameä½œä¸ºkeyï¼ŒNSMapTableä½œä¸ºvalueã€‚åœ¨è¿™ä¸ªNSMapTableä¸­ï¼Œobjectä½œä¸ºkeyï¼Œç”¨äºå­˜æ”¾observerçš„NSHashSetå®¹å™¨ä½œä¸ºvalueã€‚</p><h2 id="æ¥å£æ–‡ä»¶"><a href="#æ¥å£æ–‡ä»¶" class="headerlink" title="æ¥å£æ–‡ä»¶"></a>æ¥å£æ–‡ä»¶</h2><p>æ¥å£ä¸ç³»ç»Ÿä¿æŒä¸€è‡´ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> *YANotificationName <span class="built_in">NS_EXTENSIBLE_STRING_ENUM</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YANotificationCenter</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) YANotificationCenter *defaultCenter;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="keyword">id</span>)observer selector:(SEL)aSelector name:(<span class="keyword">nullable</span> YANotificationName)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject userInfo:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)aUserInfo;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer;</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer name:(<span class="keyword">nullable</span> YANotificationName)aName object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure><h2 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h2><ul><li style="list-style: none"><input type="checkbox" checked> ä¸å¢åŠ observerå’Œobjectçš„å¼•ç”¨è®¡æ•°</li><li style="list-style: none"><input type="checkbox" checked> æ”¯æŒæºå¸¦å‚æ•°ä¿¡æ¯userInfo</li><li style="list-style: none"><input type="checkbox" checked> å¯ä»¥ä¸æŒ‡å®šobject</li><li style="list-style: none"><input type="checkbox" checked> æ·»åŠ è§‚å¯Ÿè€…æ—¶æŒ‡å®šobjectï¼Œposté€šçŸ¥æ—¶åªæœ‰ç›¸åŒçš„objectæ‰ä¼šæœ‰æ•ˆ</li><li style="list-style: none"><input type="checkbox" checked> observerä¸ºnilï¼Œå‘é€é€šçŸ¥æ—¶æ²¡æœ‰ä½œç”¨</li><li style="list-style: none"><input type="checkbox" checked> æŒ‡å®šçº¿ç¨‹å‘é€é€šçŸ¥ï¼Œåˆ™åœ¨æŒ‡å®šçº¿ç¨‹è°ƒç”¨</li><li style="list-style: none"><input type="checkbox" checked> æ²¡æœ‰åŠæ—¶ç§»é™¤é€šçŸ¥ï¼Œobserveré”€æ¯ä¹‹åç»§ç»­å‘é€é€šçŸ¥ä¸ä¼šäº§ç”Ÿå¼‚å¸¸<br>(ä»iOS 9å¼€å§‹ï¼Œå³ä½¿ä¸ç§»é™¤è§‚å¯Ÿè€…å¯¹è±¡ï¼Œç¨‹åºä¹Ÿä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚)</li><li style="list-style: none"><input type="checkbox" checked> æ”¯æŒå¤šä¸ªobserverç›‘å¬åŒä¸€ä¸ªé€šçŸ¥</li><li style="list-style: none"><input type="checkbox" checked> å¦‚æœnotificationNameä¸ºnilï¼Œobjectæœ‰å€¼ï¼Œåˆ™æ¥æ”¶æ‰€æœ‰æŒ‡å®šä¸ºobjectçš„é€šçŸ¥</li><li style="list-style: none"><input type="checkbox" checked> å¦‚æœnotificationNameä¸ºnilï¼Œä¸”objectä¹Ÿä¸ºnilï¼Œåˆ™æ¥æ”¶ç³»ç»Ÿå†…æ‰€æœ‰é€šçŸ¥<br>(ä¹Ÿå³YANotificationCenterå‘å‡ºçš„æ‰€æœ‰é€šçŸ¥)</li><li style="list-style: none"><input type="checkbox" checked> ç§»é™¤æ‰€æœ‰é€šçŸ¥åï¼Œç›¸å…³æ–¹æ³•ä¸å†è°ƒç”¨</li><li style="list-style: none"><input type="checkbox" checked> ç§»é™¤æŒ‡å®šé€šçŸ¥åï¼Œç›¸å…³æ–¹æ³•ä¸å†è°ƒç”¨</li><li style="list-style: none"><input type="checkbox" checked> åŒæ­¥å¤„ç†é€šçŸ¥æ¶ˆæ¯</li><li style="list-style: none"><input type="checkbox"> å¤šæ¬¡æ·»åŠ observerï¼Œå‘é€é€šçŸ¥æ—¶å¤šæ¬¡è°ƒç”¨</li><li style="list-style: none"><input type="checkbox"> æ”¯æŒå¼‚æ­¥å‘å¸ƒé€šçŸ¥ï¼ˆNotificationQueueï¼‰</li></ul><h2 id="åŠŸèƒ½æµ‹è¯•"><a href="#åŠŸèƒ½æµ‹è¯•" class="headerlink" title="åŠŸèƒ½æµ‹è¯•"></a>åŠŸèƒ½æµ‹è¯•</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> ä¸å¯¹observerå’Œobjectå¼ºå¼•ç”¨</span><br><span class="line"><span class="number">2.</span> å¯ä»¥æºå¸¦å‚æ•°userInfo</span><br><span class="line"><span class="number">3.</span> æ·»åŠ è§‚å¯Ÿè€…æ—¶objectä¸ºnilï¼Œposté€šçŸ¥æ—¶objectæœ‰å€¼ï¼Œä¾ç„¶æœ‰æ•ˆ(è¡¨ç¤ºä¸é™äºæŒ‡å®šçš„object)</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">print3:</span>) <span class="string">name:</span>@<span class="string">"Noti_1"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_1"</span> <span class="string">object:</span>self <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"><span class="number">4.</span> æ·»åŠ è§‚å¯Ÿè€…æ—¶æŒ‡å®šobjectï¼Œposté€šçŸ¥æ—¶ç›¸åŒçš„objectï¼Œæœ‰æ•ˆï¼Œä¸åŒçš„objectï¼Œæ— æ•ˆ</span><br><span class="line"><span class="comment">// æœ‰æ•ˆ</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">print3:</span>) <span class="string">name:</span>@<span class="string">"Noti_2"</span> <span class="string">object:</span>self];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_2"</span> <span class="string">object:</span>self <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— æ•ˆ</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">print3:</span>) <span class="string">name:</span>@<span class="string">"Noti_3"</span> <span class="string">object:</span>self];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_3"</span> <span class="string">object:</span>a <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> å¯ä»¥æ·»åŠ næ¬¡observerï¼Œå‘é€é€šçŸ¥æ—¶å¯¹åº”è°ƒç”¨næ¬¡(ä¸æ”¯æŒ)</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">print3:</span>) <span class="string">name:</span>@<span class="string">"Noti_4"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">print3:</span>) <span class="string">name:</span>@<span class="string">"Noti_4"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_4"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"><span class="number">6.</span> æœªæ·»åŠ observerï¼Œå‘é€é€šçŸ¥æ—¶æ²¡æœ‰ä½œç”¨</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_5"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> æŒ‡å®šçº¿ç¨‹å‘é€é€šçŸ¥ï¼Œåˆ™åœ¨æŒ‡å®šçº¿ç¨‹è°ƒç”¨</span><br><span class="line"><span class="comment">// printæ–¹æ³•æ˜¯åœ¨å‘é€é€šçŸ¥çš„çº¿ç¨‹ä¸­è°ƒç”¨çš„</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(print) <span class="string">name:</span>@<span class="string">"Noti_6"</span> <span class="string">object:</span>nil];</span><br><span class="line">dispatch_async(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">NSLog(@<span class="string">"å½“å‰çº¿ç¨‹:%@"</span>,[NSThread currentThread]);</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_6"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> æ²¡æœ‰åœ¨observerçš„deallocæ–¹æ³•ä¸­ç§»é™¤é€šçŸ¥ï¼Œobserveré”€æ¯ä¹‹åç»§ç»­å‘é€é€šçŸ¥ï¼Œæ— å½±å“(ä»iOS <span class="number">9</span>å¼€å§‹ï¼Œå³ä½¿ä¸ç§»é™¤è§‚å¯Ÿè€…å¯¹è±¡ï¼Œç¨‹åºä¹Ÿä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚)</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(print) <span class="string">name:</span>@<span class="string">"Noti_7"</span> <span class="string">object:</span>nil];</span><br><span class="line"><span class="comment">// aå¯¹è±¡é”€æ¯ä¹‹åç»§ç»­å‘é€é€šçŸ¥</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_7"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> å¤šä¸ªobserverç›‘å¬åŒä¸€ä¸ªé€šçŸ¥ï¼Œæ‰€æœ‰observerçš„ç›¸å…³æ–¹æ³•å‡å¾—åˆ°è°ƒç”¨</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>a <span class="string">selector:</span><span class="meta">@selector</span>(print) <span class="string">name:</span>@<span class="string">"Noti_8"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>b <span class="string">selector:</span><span class="meta">@selector</span>(print) <span class="string">name:</span>@<span class="string">"Noti_8"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>c <span class="string">selector:</span><span class="meta">@selector</span>(print) <span class="string">name:</span>@<span class="string">"Noti_8"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_8"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"><span class="number">10.</span> å¦‚æœnotificationNameä¸ºnilï¼Œobjectæœ‰å€¼ï¼Œåˆ™æ¥æ”¶æ‰€æœ‰æŒ‡å®šä¸ºobjectçš„é€šçŸ¥</span><br><span class="line"><span class="comment">// æ¥æ”¶selfå‘é€çš„æ‰€æœ‰é€šçŸ¥</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(print1) <span class="string">name:</span>nil <span class="string">object:</span>self];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_9"</span> <span class="string">object:</span>self <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"><span class="number">11.</span> å¦‚æœnotificationNameä¸ºnilï¼Œä¸”objectä¹Ÿä¸ºnilï¼Œåˆ™æ¥æ”¶ç³»ç»Ÿå†…æ‰€æœ‰é€šçŸ¥(ä¹Ÿå³YANotificationCenterå‘å‡ºçš„æ‰€æœ‰é€šçŸ¥)</span><br><span class="line"><span class="comment">// æ¥æ”¶ç³»ç»Ÿå†…æ‰€æœ‰é€šçŸ¥ï¼Œä¹Ÿå³ä»»æ„ä¸€ä¸ªé€šçŸ¥éƒ½ä¼šè§¦å‘</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(print1) <span class="string">name:</span>nil <span class="string">object:</span>nil];</span><br><span class="line"><span class="number">12.</span> ç§»é™¤æ‰€æœ‰é€šçŸ¥åï¼Œç›¸å…³æ–¹æ³•ä¸å†è°ƒç”¨</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(print1) <span class="string">name:</span>@<span class="string">"Noti_10"</span> <span class="string">object:</span>nil];</span><br><span class="line"><span class="comment">// ç§»é™¤æ‰€æœ‰é€šçŸ¥åï¼Œå†æ¬¡å‘é€é€šçŸ¥æ²¡æœ‰æ•ˆæœ</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">removeObserver:</span>self];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_10"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="number">13.</span> ç§»é™¤æŒ‡å®šé€šçŸ¥åï¼Œç›¸å…³æ–¹æ³•ä¸å†è°ƒç”¨</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">addObserver:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(print1) <span class="string">name:</span>@<span class="string">"Noti_11"</span> <span class="string">object:</span>nil];</span><br><span class="line"><span class="comment">// ç§»é™¤æŒ‡å®šé€šçŸ¥åï¼Œå†æ¬¡å‘é€é€šçŸ¥æ²¡æœ‰æ•ˆæœ</span></span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">removeObserver:</span>self <span class="string">name:</span>@<span class="string">"Noti_11"</span> <span class="string">object:</span>nil];</span><br><span class="line">[YANotificationCenter.defaultCenter <span class="string">postNotificationName:</span>@<span class="string">"Noti_11"</span> <span class="string">object:</span>nil <span class="string">userInfo:</span>@&#123;@<span class="string">"key"</span>: @<span class="string">"value"</span>&#125;];</span><br></pre></td></tr></table></figure><h2 id="å®ç°æ–‡ä»¶"><a href="#å®ç°æ–‡ä»¶" class="headerlink" title="å®ç°æ–‡ä»¶"></a>å®ç°æ–‡ä»¶</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"YANotificationCenter.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, YANotificationSenderType) &#123;</span><br><span class="line">    YANotificationSenderTypeObject   = <span class="number">0</span>, <span class="comment">// æŒ‡å®šå¯¹è±¡</span></span><br><span class="line">    YANotificationSenderTypeObserver = <span class="number">1</span>, <span class="comment">// è§‚å¯Ÿè€…</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YANotificationCenter</span>()</span></span><br><span class="line"><span class="comment">// Recorder observer.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *observerMap;</span><br><span class="line"><span class="comment">// Recorder all the selector.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *selectorMap;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YANotificationCenter</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _observerMap = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">        _selectorMap = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (YANotificationCenter *)defaultCenter &#123;</span><br><span class="line">    <span class="keyword">static</span> YANotificationCenter *center = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        center = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="keyword">id</span>)observer selector:(SEL)aSelector name:(YANotificationName)aName object:(<span class="keyword">id</span>)anObject &#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!aName) aName = (<span class="keyword">id</span>)kCFNull;</span><br><span class="line">    <span class="built_in">NSMapTable</span> *map = [<span class="keyword">self</span>.observerMap objectForKey:aName];</span><br><span class="line">    <span class="keyword">if</span> (!map) map = [<span class="built_in">NSMapTable</span> weakToStrongObjectsMapTable];</span><br><span class="line">    <span class="keyword">if</span> (anObject) &#123;</span><br><span class="line">        <span class="built_in">NSHashTable</span> *set = [map objectForKey:observer];</span><br><span class="line">        <span class="keyword">if</span> (!set || ![set isKindOfClass:[<span class="built_in">NSHashTable</span> <span class="keyword">class</span>]]) set = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        [set addObject:anObject];</span><br><span class="line">        [map setObject:set forKey:observer];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [map setObject:(<span class="keyword">id</span>)kCFNull forKey:observer];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span>.observerMap setObject:map forKey:aName];</span><br><span class="line">    <span class="built_in">NSString</span> *key = generateKey(observer, anObject, aName);</span><br><span class="line">    [<span class="keyword">self</span>.selectorMap setObject:<span class="built_in">NSStringFromSelector</span>(aSelector) forKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(<span class="built_in">NSNotificationName</span>)aName object:(<span class="keyword">id</span>)anObject &#123;</span><br><span class="line">    [<span class="keyword">self</span> postNotificationName:aName object:anObject userInfo:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)postNotificationName:(YANotificationName)aName object:(<span class="keyword">id</span>)anObject userInfo:(<span class="built_in">NSDictionary</span> *)aUserInfo &#123;</span><br><span class="line">    <span class="comment">// When the notification name is nil.</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSMapTable</span> *map = [<span class="keyword">self</span>.observerMap objectForKey:(<span class="keyword">id</span>)kCFNull];</span><br><span class="line">        <span class="keyword">id</span> key = <span class="literal">nil</span>;</span><br><span class="line">        <span class="built_in">NSEnumerator</span> *enumerator = map.keyEnumerator;</span><br><span class="line">        <span class="keyword">while</span> (key = [enumerator nextObject]) &#123;</span><br><span class="line">            <span class="built_in">NSHashTable</span> *set = [map objectForKey:key];</span><br><span class="line">            <span class="built_in">NSArray</span> *selectorList = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (set == (<span class="keyword">id</span>)kCFNull) &#123;</span><br><span class="line">                selectorList = <span class="keyword">self</span>.selectorMap.allValues;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([set containsObject:anObject]) &#123;</span><br><span class="line">                selectorList = selectorListForSender(<span class="keyword">self</span>, anObject, YANotificationSenderTypeObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!selectorList) <span class="keyword">break</span>;</span><br><span class="line">            [selectorList enumerateObjectsUsingBlock:^(<span class="built_in">NSString</span> *selector, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">                SEL sel = <span class="built_in">NSSelectorFromString</span>(selector);</span><br><span class="line">                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))[key methodForSelector:sel])(<span class="keyword">self</span>, sel, aUserInfo);</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Normal process.</span></span><br><span class="line">    <span class="built_in">NSMapTable</span> *map = [<span class="keyword">self</span>.observerMap objectForKey:aName];</span><br><span class="line">    <span class="keyword">id</span> key = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSEnumerator</span> *enumerator = map.keyEnumerator;</span><br><span class="line">    <span class="keyword">if</span> (anObject) &#123;</span><br><span class="line">        <span class="keyword">while</span> (key = [enumerator nextObject]) &#123;</span><br><span class="line">            <span class="built_in">NSHashTable</span> *set = [map objectForKey:key];</span><br><span class="line">            <span class="keyword">if</span> (set == (<span class="keyword">id</span>)kCFNull || [set containsObject:anObject]) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *selector = [<span class="keyword">self</span>.selectorMap objectForKey:generateKey(key, anObject, aName)];</span><br><span class="line">                <span class="keyword">if</span> (!selector) <span class="keyword">return</span>;</span><br><span class="line">                SEL sel = <span class="built_in">NSSelectorFromString</span>(selector);</span><br><span class="line">                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))[key methodForSelector:sel])(<span class="keyword">self</span>, sel, aUserInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (key = [enumerator nextObject]) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *selector = [<span class="keyword">self</span>.selectorMap objectForKey:generateKey(key, anObject, aName)];</span><br><span class="line">            <span class="keyword">if</span> (!selector) <span class="keyword">return</span>;</span><br><span class="line">            SEL sel = <span class="built_in">NSSelectorFromString</span>(selector);</span><br><span class="line">            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))[key methodForSelector:sel])(<span class="keyword">self</span>, sel, aUserInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer &#123;</span><br><span class="line">    [<span class="keyword">self</span>.observerMap.allValues enumerateObjectsUsingBlock:^(<span class="built_in">NSMapTable</span> *map, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        [map removeObjectForKey:observer];</span><br><span class="line">    &#125;];</span><br><span class="line">    [<span class="keyword">self</span>.selectorMap removeObjectsForKeys:selectorListForSender(<span class="keyword">self</span>, observer, YANotificationSenderTypeObserver)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="keyword">id</span>)observer name:(YANotificationName)aName object:(<span class="keyword">id</span>)anObject &#123;</span><br><span class="line">    <span class="built_in">NSMapTable</span> *map = [<span class="keyword">self</span>.observerMap objectForKey:aName];</span><br><span class="line">    <span class="comment">// Remove selector.</span></span><br><span class="line">    [<span class="keyword">self</span>.selectorMap removeObjectForKey:generateKey(observer, anObject, aName)];</span><br><span class="line">    <span class="keyword">if</span> (anObject) &#123;</span><br><span class="line">        <span class="built_in">NSHashTable</span> *set = [map objectForKey:observer];</span><br><span class="line">        [set removeObject:anObject];</span><br><span class="line">        <span class="keyword">if</span> (set.count == <span class="number">0</span>) [map removeObjectForKey:observer];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [map removeObjectForKey:observer];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (map.count == <span class="number">0</span>) [<span class="keyword">self</span>.observerMap removeObjectForKey:aName];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">NSString</span> *generateKey(<span class="keyword">id</span> observer, <span class="keyword">id</span> anObject, YANotificationName name) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *key = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (anObject) &#123;</span><br><span class="line">        key = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p_%@_%p"</span> ,anObject, name, observer];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        key = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@_%p"</span>, name, observer];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">NSArray</span> *selectorListForSender(YANotificationCenter *<span class="keyword">self</span>, <span class="keyword">id</span> object, YANotificationSenderType type) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *p = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p"</span>, object];</span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (type == YANotificationSenderTypeObject) &#123;</span><br><span class="line">        predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF BEGINSWITH %@"</span>, p];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF ENDSWITH %@"</span>, p];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSArray</span> *keys = [<span class="keyword">self</span>.selectorMap.allKeys filteredArrayUsingPredicate:predicate];</span><br><span class="line">    <span class="built_in">NSArray</span> *result = [<span class="keyword">self</span>.selectorMap objectsForKeys:keys notFoundMarker:(<span class="keyword">id</span>)kCFNull];</span><br><span class="line">    <span class="keyword">return</span> result.count == <span class="number">0</span> ? <span class="literal">nil</span> : result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h1 id="äº”ã€å°ç»“"><a href="#äº”ã€å°ç»“" class="headerlink" title="äº”ã€å°ç»“"></a>äº”ã€å°ç»“</h1><ol><li>åŒæ­¥é€šçŸ¥å†…éƒ¨å®ç°æ˜¯ç»´æŠ¤äº†ä¸¤å±‚æ˜ å°„ï¼šç¬¬ä¸€å±‚nameä½œä¸ºkeyï¼Œç¬¬äºŒå±‚objectä½œä¸ºkeyï¼Œæœ€ç»ˆæŠŠobserverä¿å­˜åœ¨æ•°ç»„ä¸­ã€‚iOS9ä¹‹åå¯¹observeræ˜¯å®‰å…¨çš„å¼±å¼•ç”¨ã€‚</li><li>å¼‚æ­¥é€šçŸ¥å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ä»¥æ»¡è¶³â€œèšåˆï¼ˆNSNotificationCoalescingï¼‰â€é€‰é¡¹ï¼Œä¾èµ–Runloopçš„è¿­ä»£ä»¥æ»¡è¶³â€œæ—¶æœºï¼ˆNSPostingStyleï¼‰â€é€‰é¡¹ã€‚</li><li>ä½¿ç”¨å­çº¿ç¨‹é€šçŸ¥éœ€è¦ä¾é NSMachPortçš„é€šä¿¡ã€‚</li></ol><p>æ—¥å¸¸å¼€å‘ä¸­åŒæ­¥é€šçŸ¥èƒ½æ»¡è¶³ç»å¤§å¤šæ•°åœºæ™¯ï¼Œå¼‚æ­¥é€šçŸ¥çš„åœºæ™¯æœ‰é™ï¼Œè‹¹æœç»™å‡ºçš„å‡ ä¸ªä¾‹å­è¿˜æ˜¯å¾ˆç»å…¸çš„ã€‚å­çº¿ç¨‹é€šçŸ¥ä¹Ÿæ˜¯å¸¸è§çš„ï¼Œæ¯”å¦‚å­çº¿ç¨‹å‘é€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†é€šçŸ¥ï¼Œä½†æ˜¯æˆ‘çœ‹å¤§å®¶éƒ½ä¹ æƒ¯ç›´æ¥åˆ©ç”¨GCDä»å­çº¿ç¨‹ç¯å¢ƒåˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œå†å‘å‡ºé€šçŸ¥ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™ï¼š<br><a href="http://southpeak.github.io/2015/03/20/cocoa-foundation-nsnotificationcenter/" target="_blank" rel="noopener">ã€ŠNotificationä¸å¤šçº¿ç¨‹ã€‹</a><br><a href="http://cloverkim.com/ios_notification-principle.html" target="_blank" rel="noopener">ã€ŠNSNotificationåŸç†ç†è§£ã€‹</a><br><a href="https://philm.gitbook.io/philm-ios-wiki/mei-zhou-yue-du/shen-ru-si-kao-nsnotification" target="_blank" rel="noopener">ã€Šæ·±å…¥æ€è€ƒNSNotificationã€‹</a><br><a href="[](https://www.jianshu.com/p/83770200d476">ã€Šæ·±å…¥ç†è§£iOS NSNotificationã€‹</a>)</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;2019å¹´10æœˆ14æ—¥ æ›´æ–°æºç &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; æ¢ç©¶NSNotificationCenterçš„å®ç°å¹¶å°è¯•è‡ªå®ç°ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Weak Associated Object</title>
    <link href="http://blog.chenyalun.com/2019/01/20/Weak%20Associated%20Object/"/>
    <id>http://blog.chenyalun.com/2019/01/20/Weak Associated Object/</id>
    <published>2019-01-20T13:22:23.000Z</published>
    <updated>2019-08-28T12:04:08.062Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> ç»™åˆ†ç±»æ·»åŠ weakå±æ€§çš„å‡ ç§æ–¹æ³•ã€‚ </p><br><a id="more"></a><p></p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œé€šè¿‡Runtimeçš„å…³è”å±æ€§æ¥ç»™åˆ†ç±»æ·»åŠ â€œå±æ€§â€ï¼Œè¿™é‡Œçš„å±æ€§ç¼ºå°‘äº†ä¸¥æ ¼æ„ä¹‰ä¸Šçš„æˆå‘˜å˜é‡ï¼Œè€Œä¸”æ˜¯è‡ªå·±æ‰‹åŠ¨å®ç°äº†getteræ–¹æ³•å’Œsetteræ–¹æ³•ã€‚å‡ ç§å…³è”ç­–ç•¥ä¸­å¹¶æ²¡æœ‰ä¸weakæ•ˆæœç›¸åª²ç¾çš„é€‰é¡¹ï¼Œ<code>OBJC_ASSOCIATION_ASSIGN</code>ç­–ç•¥ä¸weakæ•ˆæœçš„ä¸»è¦åŒºåˆ«åœ¨äºweakè‡ªåŠ¨èƒ½å°†æŒ‡å‘å·²é”€æ¯å¯¹è±¡çš„æŒ‡é’ˆæŒ‡ä¸ºnilã€‚</p><h1 id="å±é™©çš„ASSIGN"><a href="#å±é™©çš„ASSIGN" class="headerlink" title="å±é™©çš„ASSIGN"></a>å±é™©çš„ASSIGN</h1><p>å•çº¯ä½¿ç”¨ASSIGNå®¹æ˜“è¯±å‘åå†…å­˜è®¿é—®ï¼ŒåŸå› æ— éœ€å¤šè¨€ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">Default</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">id</span> strongObj;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">Default</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setStrongObj:(<span class="keyword">id</span>)strongObj &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(strongObj), strongObj, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)strongObj &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(strongObj));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹å¦‚ä¸‹</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSObject</span> *obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">    <span class="built_in">NSObject</span> *main = [<span class="built_in">NSObject</span> new];</span><br><span class="line">    main.strongObj = obj;</span><br><span class="line">    obj = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, main.strongObj); <span class="comment">// Crash</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æç®€æ–¹æ¡ˆ"><a href="#æç®€æ–¹æ¡ˆ" class="headerlink" title="æç®€æ–¹æ¡ˆ"></a>æç®€æ–¹æ¡ˆ</h1><p>è¿™æ˜¯ä¸€ç§æå¥½çš„ç»™åˆ†ç±»æ·»åŠ <code>weak</code>å±æ€§çš„å®ç°æ–¹å¼ã€‚çœ‹åˆ°è¿™ç§å®ç°æ–¹å¼åæä¸ºå…´å¥‹ï¼Œå®åœ¨å¤ªç®€æ´ã€å·§å¦™äº†ã€‚<code>__weak</code>æœ¬èº«å°±ä¼šæŠŠæŒ‡é’ˆæŒ‡å‘nilï¼Œé‚£ç›´æ¥åˆ©ç”¨å°±æ˜¯äº†ã€‚ä½¿ç”¨<code>OBJC_ASSOCIATION_COPY</code>å…³è”ç­–ç•¥å°†block copyåˆ°å †ä¸Šï¼Œåˆ©ç”¨blockæŠŠæŒæœ‰çš„<code>weak</code>å¯¹è±¡è¿”å›ï¼Œå¦‚æœå¯¹è±¡ä¸å­˜åœ¨äº†ï¼Œè¿”å›çš„ä¾¿æ˜¯ç©ºå€¼ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">Weak</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">id</span> object;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">Weak</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">weak</span> weakObject = object;</span><br><span class="line">    <span class="keyword">id</span> (^block)(<span class="keyword">void</span>) = ^&#123; <span class="keyword">return</span> weakObject; &#125;;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(object), block, OBJC_ASSOCIATION_COPY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">id</span> (^block)(<span class="keyword">void</span>) = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(object));</span><br><span class="line">    <span class="keyword">return</span> (block ? block() : <span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h1 id="åŒ…è£…ç±»"><a href="#åŒ…è£…ç±»" class="headerlink" title="åŒ…è£…ç±»"></a>åŒ…è£…ç±»</h1><p>è¿™ç§æ–¹å¼æ˜¯é€šè¿‡åŒ…è£…ä¸€ä¸ªå¯¹è±¡å®ç°çš„ã€‚è¦æ±‚è®¾ç½®çš„å…³è”å¯¹è±¡æ˜¯<code>YAWeakObject</code>ç±»å‹ã€‚å½“è¿™ä¸ªå¯¹è±¡é”€æ¯çš„æ—¶å€™è°ƒç”¨<code>deallocBlock</code>ï¼Œè€Œåœ¨è¿™ä¸ªblockä¸­æŠŠå…³è”çš„å¯¹è±¡é‡æ–°è®¾ç½®ä¸º<code>nil</code>(ä¸å¯ä½¿ç”¨<code>objc_removeAssociatedObjects</code>ç›´æ¥ç§»é™¤å…³è”å¯¹è±¡)ï¼Œè¿™æ ·è®¿é—®è¿™ä¸ªå…³è”å¯¹è±¡çš„æ—¶å€™å¾—åˆ°çš„å°±æ˜¯nilå€¼äº†ã€‚</p><p>è¿™ç§æ–¹å¼ä¼šæ±¡æŸ“<code>weak</code>å±æ€§ï¼Œè¦æ±‚è¢«è®¾ç½®ä¸º<code>weak</code>å±æ€§çš„å¯¹è±¡å¿…é¡»æ˜¯æŸç§ç±»å‹ï¼Œä¸æ˜¯å¤ªå¥½ã€‚å½“ç„¶æ ¹æ®è¿™ç§æ€è·¯ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å°è£…ï¼Œæœ€ç»ˆçš„è½è„šç‚¹æ— éæ˜¯æä¾›æ–°çš„æ–¹æ³•æ¥å£æ›¿ä»£åŸç”Ÿçš„è¿è¡Œæ—¶æ–¹æ³•(è§<a href="https://www.jianshu.com/p/ed65d71554d8" target="_blank" rel="noopener">å‚è€ƒæ–‡ç« </a>)ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">WeakClass</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) YAWeakObject *weakObject;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">WeakClass</span>)</span></span><br><span class="line">- (YAWeakObject *)weakObject &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObject));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setWeakObject:(YAWeakObject *)weakObject &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObject), weakObject, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    <span class="keyword">typeof</span>(<span class="keyword">self</span>) slf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        <span class="keyword">typeof</span>(slf) <span class="keyword">self</span> = slf;</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObject), <span class="literal">nil</span>, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    &#125;;</span><br><span class="line">    [weakObject setDeallocBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p><h1 id="ä½¿ç”¨å®¹å™¨"><a href="#ä½¿ç”¨å®¹å™¨" class="headerlink" title="ä½¿ç”¨å®¹å™¨"></a>ä½¿ç”¨å®¹å™¨</h1><p>å®é™…ä¸Šä½¿ç”¨æ”¯æŒå¼±å¼•ç”¨çš„å®¹å™¨å¦‚<code>NSHashTable</code>ã€<code>NSMapTable</code>ã€<code>NSPointerArray</code>éƒ½æ˜¯å¯ä»¥å®ç°çš„ã€‚åŸç†å¾ˆç®€å•ï¼Œä½¿ç”¨å®¹å™¨æŒæœ‰å…³è”çš„å¯¹è±¡ï¼Œå½“è¯¥å¯¹è±¡ä¸å­˜åœ¨æ—¶ï¼Œå®¹å™¨è‡ªèº«ä¾¿æœ‰è‡ªåŠ¨ç§»é™¤å·²é”€æ¯å¯¹è±¡çš„ç‰¹æ€§ï¼Œè¿™æ ·å°±å®ç°äº†<code>weak</code>å±æ€§ã€‚</p><blockquote><p>NSMapTable å¯ä»¥æŒæœ‰é”®å’Œå€¼çš„å¼±å¼•ç”¨ï¼Œå½“é”®æˆ–è€…å€¼å½“ä¸­çš„ä¸€ä¸ªè¢«é‡Šæ”¾æ—¶ï¼Œæ•´ä¸ªè¿™ä¸€é¡¹å°±ä¼šè¢«ç§»é™¤æ‰ã€‚<br>NSHashTable å¯ä»¥æŒæœ‰æˆå‘˜çš„å¼±å¼•ç”¨ã€‚<br>NSPointerArray å¯ä»¥æŒæœ‰æˆå‘˜çš„å¼±å¼•ç”¨ï¼Œå½“æˆå‘˜ä¸å­˜åœ¨æ—¶è‡ªåŠ¨æŠŠæ‰€åœ¨indexç½®ä¸ºNULLã€‚</p></blockquote><p>è¿™ç§åšæ³•éœ€è¦åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">WeakContainer</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">id</span> weakObj;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">WeakContainer</span>)</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSPointerArray</span> *gPointerArray = <span class="literal">nil</span>;</span><br><span class="line">- (<span class="keyword">id</span>)weakObj &#123;</span><br><span class="line">    <span class="keyword">if</span> (!gPointerArray) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// Removes NULL values from the receiver.(sometimes doesn't work as documented)</span></span><br><span class="line">    [gPointerArray compact];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> gPointerArray) &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObj));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    gPointerArray = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setWeakObj:(<span class="keyword">id</span>)weakObj &#123;</span><br><span class="line">    <span class="keyword">if</span> (weakObj) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!gPointerArray) gPointerArray = [<span class="built_in">NSPointerArray</span> weakObjectsPointerArray];</span><br><span class="line">        [gPointerArray addPointer:(__bridge <span class="keyword">void</span> *)weakObj];</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObj), weakObj, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>å…¶å®çœ‹åˆ°ä½œè€…çš„æ€è·¯ï¼ˆæç®€æ–¹æ¡ˆï¼‰ç¡®å®æŒºæœ‰æ„Ÿè§¦çš„ï¼Œå®Œå…¨åˆ©ç”¨ç°æœ‰çš„<code>__weak</code>å…³é”®å­—é…åˆblockï¼Œæ²¡æœ‰å†—ä½™çš„åŒ…è£…ï¼Œæ–¹æ³•ç²¾ç®€ä¸”å·§å¦™ã€‚å»å¹´åœ¨æƒ³è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è€ƒè™‘å¾ˆå¤šï¼Œåœ¨<a href="https://blog.chenyalun.com/2018/07/10/RuntimeåŸºç¡€/#å…³è”å¼•ç”¨">ã€ŠRuntimeåŸºç¡€ã€‹</a>ä¸€æ–‡ä¸­æè¿°äº†æˆ‘å½“æ—¶çš„æ€è·¯ï¼ŒåŸºæœ¬ä¸Šä¹Ÿæ˜¯ä»<strong>æŠŠæŒ‡é’ˆç½®ä¸ºnil</strong>è¿™ä¸ªè§’åº¦å‡ºå‘ï¼Œæˆ–è€…æ´¾ç”Ÿå­ç±»é‡å†™deallocï¼Œæˆ–è€…ä½¿ç”¨å¼±å¼•ç”¨å®¹å™¨ï¼Œéƒ½ä¸å¤Ÿå·§å¦™ã€‚</p><p>å¾ˆå¤šæ—¶å€™ï¼Œå¥½çš„æ€è·¯ï¼Œçµå…‰ä¸€ç°çš„æƒ³æ³•ï¼ŒçœŸçš„æ— æ¯”é‡è¦ã€‚å°±åƒbangå“¥åœ¨<a href="https://github.com/bang590/JSPatch/wiki/JSPatch-å®ç°åŸç†è¯¦è§£" target="_blank" rel="noopener">å†™JSPatch</a>æ—¶ï¼š</p><blockquote><p>å½“æ—¶ç»§ç»­è‹¦è‹¦å¯»æ‰¾è§£å†³æ–¹æ¡ˆï¼Œè‹¥æŒ‰ JS è¯­æ³•ï¼Œè¿™æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼Œä½†è‹¥ä¸æŒ‰ JS è¯­æ³•å‘¢ï¼Ÿçªç„¶è„‘æ´å¼€äº†ä¸‹ï¼ŒCoffieScript/JSX éƒ½å¯ä»¥ç”¨ JS å®ç°ä¸€ä¸ªè§£é‡Šå™¨å®ç°è‡ªå·±çš„è¯­æ³•ï¼Œæˆ‘ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹å¼åšåˆ°ï¼Œå†è¿›ä¸€æ­¥æƒ³åˆ°å…¶å®æˆ‘æƒ³è¦çš„æ•ˆæœå¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨æ–¹æ³•æ—¶ï¼Œèƒ½è½¬å‘åˆ°ä¸€ä¸ªæŒ‡å®šå‡½æ•°å»æ‰§è¡Œï¼Œå°±èƒ½è§£å†³ä¸€åˆ‡é—®é¢˜äº†ï¼Œè¿™å…¶å®å¯ä»¥ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼ŒæŠŠ JS è„šæœ¬é‡Œçš„æ–¹æ³•è°ƒç”¨éƒ½æ›¿æ¢æ‰ã€‚</p></blockquote><p>è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿åœ¨ä½œè€…çš„æ–‡ç« é‡Œçœ‹åˆ°ï¼Œæ¯”è¾ƒæœ‰æ„æ€ï¼Œè¿™é‡Œæä¸€ä¸‹ã€‚</p><p><strong>Weak Singleton</strong></p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)sharedWeakInstance &#123;</span><br><span class="line">    <span class="keyword">static</span> __<span class="keyword">weak</span> <span class="keyword">id</span> weakObj = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">id</span> strongObj = weakObj;</span><br><span class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strongObj) &#123;</span><br><span class="line">            strongObj = [[<span class="keyword">self</span> <span class="keyword">class</span>] new];</span><br><span class="line">            weakObj = strongObj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> strongObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åº”ç”¨åœºæ™¯:ä¸éœ€è¦ä¿å­˜å…¬å…±çš„ä¿¡æ¯ã€ç”¨æˆ·çŠ¶æ€ç­‰ï¼Œç¬¦åˆâ€œç”¨å®Œå°±èµ°â€ã€‚å¦‚æœç±»ä¼¼LoginManagerç®¡ç†ç™»å½•çŠ¶æ€ï¼Œç»§æ‰¿è‡ª AFHttpSessionManagerçš„NetworkManagerå•ä¾‹ï¼ŒAppå•ä¾‹ClientManagerç­‰åˆ™ä¸é€‚ç”¨è¿™ç§æ–¹å¼ã€‚</p></blockquote><blockquote><p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.jianshu.com/p/ed65d71554d8" target="_blank" rel="noopener">å¦‚ä½•ä½¿ç”¨ Runtime ç»™ç°æœ‰çš„ç±»æ·»åŠ  weak å±æ€§</a><br><a href="https://blog.csdn.net/yan_1564335/article/details/53996538" target="_blank" rel="noopener">iOSç»™ç±»åˆ«æ·»åŠ weakå±æ€§</a><br><a href="http://mrpeak.cn/blog/ios-weak/" target="_blank" rel="noopener">iOS weak å…³é”®å­—æ¼«è°ˆ</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; ç»™åˆ†ç±»æ·»åŠ weakå±æ€§çš„å‡ ç§æ–¹æ³•ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŒKVOControllerã€çš„å°è£…</title>
    <link href="http://blog.chenyalun.com/2019/01/12/%E3%80%8CKVOController%E3%80%8D%E7%9A%84%E5%B0%81%E8%A3%85/"/>
    <id>http://blog.chenyalun.com/2019/01/12/ã€ŒKVOControllerã€çš„å°è£…/</id>
    <published>2019-01-12T13:45:10.000Z</published>
    <updated>2019-08-28T11:42:20.827Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> å­¦ä¹ KVOçš„å°è£…ã€‚ </p><br><a id="more"></a><p></p><p>KVOControlleræºç åªæœ‰700è¡Œå·¦å³ï¼Œè¯»ä¸€éä¸‹æ¥è¿˜æ˜¯æ¯”è¾ƒé€šç•…çš„ã€‚è¿™é‡Œåšä¸€ä¸ªè®°å½•ã€‚</p><h1 id="ä¸€ã€ä½¿ç”¨"><a href="#ä¸€ã€ä½¿ç”¨" class="headerlink" title="ä¸€ã€ä½¿ç”¨"></a>ä¸€ã€ä½¿ç”¨</h1><p>ä½¿ç”¨èµ·æ¥æå…¶ç®€ä¾¿ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®æ‰€è§‚å¯Ÿçš„å¯¹è±¡åŠå…¶keyPath</span></span><br><span class="line">[<span class="keyword">self</span>.KVOController observe:<span class="keyword">self</span>.myButton keyPath:<span class="string">@"backgroundColor"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> block:^(<span class="keyword">id</span>  _Nullable observer, <span class="keyword">id</span>  _Nonnull object, <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; * _Nonnull change) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, change[<span class="built_in">NSKeyValueChangeNewKey</span>]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>self.KVOController</code>å¯ä»¥è‡ªå·±åˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤ï¼Œå› ä¸º<code>KVOController</code>æ˜¯æ‡’åŠ è½½çš„ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åƒä¸Šé¢è¿™æ ·ä½¿ç”¨çš„ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä¸éœ€è¦å¼ºæŒæœ‰è¢«è§‚å¯Ÿè€…çš„æ—¶å€™ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.KVOControllerNonRetaining observe:<span class="keyword">self</span>.myButton keyPath:<span class="string">@"backgroundColor"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> block:^(<span class="keyword">id</span>  _Nullable observer, <span class="keyword">id</span>  _Nonnull object, <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; * _Nonnull change) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, change[<span class="built_in">NSKeyValueChangeNewKey</span>]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>åªéœ€ä½¿ç”¨<code>self.KVOControllerNonRetaining</code>å³å¯ä¸å¢åŠ è¢«è§‚å¯Ÿè€…<code>self.myButton</code>çš„å¼•ç”¨è®¡æ•°ã€‚</p><h1 id="äºŒã€åˆ†ç±»"><a href="#äºŒã€åˆ†ç±»" class="headerlink" title="äºŒã€åˆ†ç±»"></a>äºŒã€åˆ†ç±»</h1><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> NSObject (FBKVOController)</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) FBKVOController *KVOController;</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) FBKVOController *KVOControllerNonRetaining;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>è¦å®ç°ä»¥ä¸Šä½¿ç”¨çš„æ–¹å¼ï¼Œæ˜¯ç»™ <code>NSObject</code> åˆ†ç±»æ·»åŠ ä¸¤ä¸ªå±æ€§:<code>KVOController</code>å’Œ<code>KVOControllerNonRetaining</code>ã€‚è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨<code>Runtime</code> çš„å…³è”å±æ€§å³å¯ã€‚å€¼å¾—ä¸€æçš„æ˜¯ä½œè€…åœ¨ <code>getter</code> æ–¹æ³•é‡Œä½¿ç”¨äº†æ‡’åŠ è½½ï¼Œåªæœ‰å½“ä½¿ç”¨åˆ°<code>KVOController</code>æˆ–è€…<code>KVOControllerNonRetaining</code>çš„æ—¶å€™ï¼Œæ‰ä¼šåˆ›å»ºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è‡ªè¡Œåˆ›å»ºã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (FBKVOController *)KVOController &#123;</span><br><span class="line">  <span class="keyword">id</span> controller = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="built_in">NSObjectKVOControllerKey</span>);</span><br><span class="line">  <span class="comment">// æ‡’åŠ è½½KVOController, ç”¨åˆ°æ—¶æ‰ä¼šåˆ›å»º</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == controller) &#123;</span><br><span class="line">    controller = [FBKVOController controllerWithObserver:<span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">self</span>.KVOController = controller;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> controller;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (FBKVOController *)KVOControllerNonRetaining &#123;</span><br><span class="line">  <span class="keyword">id</span> controller = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="built_in">NSObjectKVOControllerNonRetainingKey</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == controller) &#123;</span><br><span class="line">    controller = [[FBKVOController alloc] initWithObserver:<span class="keyword">self</span> retainObserved:<span class="literal">NO</span>];</span><br><span class="line">    <span class="keyword">self</span>.KVOControllerNonRetaining = controller;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> controller;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ä¸ª <code>getter</code> æ–¹æ³•åˆ†åˆ«å¯¹åº”å¼ºå¼•ç”¨è¢«è§‚å¯Ÿè€…å’Œå¼±å¼•ç”¨è¢«è§‚å¯Ÿè€…ã€‚</p><h1 id="ä¸‰ã€æ¥å£"><a href="#ä¸‰ã€æ¥å£" class="headerlink" title="ä¸‰ã€æ¥å£"></a>ä¸‰ã€æ¥å£</h1><p>ç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒåŠŸèƒ½çš„å®ç°ä¾èµ–äº<code>FBKVOController</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¼ºå¼•ç”¨</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)controllerWithObserver:(<span class="keyword">nullable</span> <span class="keyword">id</span>)observer;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">nullable</span> <span class="keyword">id</span>)observer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®šæ„é€ å™¨</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">nullable</span> <span class="keyword">id</span>)observer retainObserved:(<span class="built_in">BOOL</span>)retainObserved <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init <span class="built_in">NS_UNAVAILABLE</span>;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new <span class="built_in">NS_UNAVAILABLE</span>;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•é‡Œä¸»è¦æš´éœ²äº†ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ï¼Œå…¶ä¸­é€šè¿‡<code>initWithObserver</code>è¿™ä¸ªæ–¹æ³•å¯ä»¥è®¾ç½®å‚æ•°<code>retainObserved</code>ä»¥è¡¨æ˜æ˜¯å¦éœ€è¦å¼ºå¼•ç”¨è¢«è§‚å¯Ÿè€…ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">readonly</span>) <span class="keyword">id</span> observer;</span><br></pre></td></tr></table></figure><p>åªæœ‰ä¸€ä¸ªåªè¯»å±æ€§ï¼Œç»™å‡ºè¢«è§‚å¯Ÿè€…å¯¹è±¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options block:(FBKVONotificationBlock)block;</span><br><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options action:(SEL)action;</span><br><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure><p>ä½œè€…ç»™å‡ºäº†å›è°ƒçš„ä¸‰ä¸ªé€‰é¡¹ï¼šblockå›è°ƒï¼Œé€‰æ‹©å­å›è°ƒä»¥åŠ KVO é»˜è®¤æ–¹æ³•å›è°ƒã€‚å¯ä»¥åœ¨æ·»åŠ è¢«è§‚å¯Ÿè€…çš„æ—¶å€™è‡ªè¡Œé€‰æ‹©ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPaths options:(<span class="built_in">NSKeyValueObservingOptions</span>)options block:(FBKVONotificationBlock)block;</span><br><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPaths options:(<span class="built_in">NSKeyValueObservingOptions</span>)options action:(SEL)action;</span><br><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPaths options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure><p>è€ƒè™‘åˆ°ä¸ä¸€å®šåªè§‚å¯Ÿä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå› æ­¤ä½œè€…æä¾›äº†<code>keyPaths</code>é€‰é¡¹ï¼Œå¯ä»¥åŒæ—¶è§‚å¯Ÿä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªkeyPathï¼šä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„å³å¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)unobserve:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object keyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="keyword">void</span>)unobserve:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object;</span><br><span class="line">- (<span class="keyword">void</span>)unobserveAll;</span><br></pre></td></tr></table></figure><p>ç§»é™¤ç›‘å¬æä¾›ä¸‰ç§æ¥å£ï¼šç§»é™¤æŸä¸ªå¯¹è±¡æŸä¸ªkeyPath çš„ç›‘å¬ï¼Œç§»é™¤å¯¹æŸä¸ªå¯¹è±¡çš„ç›‘å¬ï¼Œå–æ¶ˆè§‚å¯Ÿè€…å¯¹æ‰€æœ‰å¯¹è±¡çš„æ‰€æœ‰ç›‘å¬ã€‚</p><h1 id="å››ã€FBKVOControllerå®ç°"><a href="#å››ã€FBKVOControllerå®ç°" class="headerlink" title="å››ã€FBKVOControllerå®ç°"></a>å››ã€FBKVOControllerå®ç°</h1><h2 id="æ„é€ å™¨"><a href="#æ„é€ å™¨" class="headerlink" title="æ„é€ å™¨"></a>æ„é€ å™¨</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FBKVOController</span> </span>&#123;</span><br><span class="line">  <span class="built_in">NSMapTable</span>&lt;<span class="keyword">id</span>, <span class="built_in">NSMutableSet</span>&lt;_FBKVOInfo *&gt; *&gt; *_objectInfosMap;</span><br><span class="line">  pthread_mutex_t _lock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FBKVOController</code>ä¸»è¦ç»´æŠ¤äº†ä¸€ä¸ª<code>NSMapTable</code>ã€‚<code>key</code> æ˜¯æ‰€è§‚å¯Ÿçš„å¯¹è±¡ï¼Œ<code>value</code> æ˜¯<code>NSMutableSet</code>ç±»å‹çš„é›†åˆ(å†…éƒ¨å…ƒç´ æ˜¯<code>_FBKVOInfo</code>ç±»å‹)ã€‚ç»´æŠ¤ä¸€ä¸ª<code>NSMapTable</code>çš„åŸå› æ˜¯ï¼šä¾¿äºè§‚å¯Ÿä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ª<code>keyPath</code>ï¼Œè¿™ä¸ªå¯¹è±¡ä½œä¸º <code>key</code>ï¼Œè¿™è®¸å¤šä¸ª<code>keyPath</code>å°è£…æˆä¸€ä¸ªä¸ª<code>_FBKVOInfo</code>å­˜å…¥<code>NSMutableSet</code>ä¸­ã€‚å¦å¤–ä¸€ä¸ªæˆå‘˜å˜é‡<code>_lock</code>ä¸»è¦æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">nullable</span> <span class="keyword">id</span>)observer retainObserved:(<span class="built_in">BOOL</span>)retainObserved &#123;</span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != <span class="keyword">self</span>) &#123;</span><br><span class="line">    _observer = observer;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦retainObservedï¼Œé€‰æ‹©NSMapTableçš„"å¼º-å¼º"æˆ–è€…"å¼±-å¼º"</span></span><br><span class="line">    <span class="built_in">NSPointerFunctionsOptions</span> keyOptions = retainObserved ? <span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span> : <span class="built_in">NSPointerFunctionsWeakMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span>;</span><br><span class="line">    _objectInfosMap = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyOptions:keyOptions valueOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPersonality</span> capacity:<span class="number">0</span>];</span><br><span class="line">    pthread_mutex_init(&amp;_lock, <span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FBKVOController</code>æ‰€æœ‰æš´éœ²çš„æ„é€ æ–¹æ³•æ¥å£éƒ½æŒ‡å‘äº†ä¸Šé¢çš„é‚£ä¸ªå®ç°ã€‚è¿™ä¸ªæ–¹æ³•åªåšäº†ä¸‰ä»¶äº‹: 1ï¼Œåˆå§‹åŒ–çº¿ç¨‹é”<code>_lock</code>ï¼Œ2ï¼Œæ ¹æ®<code>retainObserved</code>å‚æ•°åˆ›å»ºä¸åŒç±»å‹çš„<code>NSMapTable</code>ï¼Œæ˜¯é€‰æ‹©â€å¼º-å¼ºâ€è¿˜æ˜¯é€‰æ‹©â€å¼±-å¼ºâ€ã€‚3ï¼Œå±æ€§<code>observer</code>èµ‹å€¼ã€‚</p><p>ç”±æ­¤å¯è§ï¼Œ<code>FBKVOController</code>æœ¬èº«å¯¹è¢«è§‚å¯Ÿè€…<code>observer</code>æ˜¯å¼±å¼•ç”¨çš„(æœ‰ä¸€ä¸ª <code>weak</code> å±æ€§çš„<code>observer</code>æˆå‘˜å˜é‡)ï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ª<code>NSMapTable</code>æ¥æœ€ç»ˆç¡®å®šå¯¹è¢«è§‚å¯Ÿè€…çš„å¼ºå¼±å¼•ç”¨å…³ç³»ã€‚</p><h2 id="æ¥å£å®ç°"><a href="#æ¥å£å®ç°" class="headerlink" title="æ¥å£å®ç°"></a>æ¥å£å®ç°</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">observe:</span>(nullable id)object <span class="string">keyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">block:</span>(FBKVONotificationBlock)block &#123;</span><br><span class="line">  <span class="keyword">if</span> (nil == object || <span class="number">0</span> == keyPath.length || NULL == block) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»ºæ•°æ®ç»“æ„_FBKVOInfo</span></span><br><span class="line">  _FBKVOInfo *info = [[_FBKVOInfo alloc] <span class="string">initWithController:</span>self <span class="string">keyPath:</span>keyPath <span class="string">options:</span>options <span class="string">block:</span>block];</span><br><span class="line">  <span class="comment">// æ·»åŠ å¯¹objectçš„è§‚å¯Ÿ, å¹¶ä¼ å…¥info</span></span><br><span class="line">  [self <span class="string">_observe:</span>object <span class="string">info:</span>info];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥æ·»åŠ ä¸€ä¸ªè¢«è§‚å¯Ÿè€…å¹¶ä¸”å›è°ƒæ˜¯ block ä¸ºä¾‹ã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¦–å…ˆæ˜¯å¯¹å‚æ•°çš„åˆç†æ€§åˆ¤æ–­ï¼Œè¦æ±‚<code>object</code>ã€<code>keyPath</code>ä»¥åŠ<code>block</code>å‡æ˜¯åˆç†å€¼ã€‚<br> æ¥ç€æŠŠ<code>keyPath</code>ã€<code>options</code>ã€<code>block</code>åŒ…è£…æˆä¸€ä¸ªæ•°æ®ç»“æ„<code>_FBKVOInfo</code>ã€‚<br> æœ€åè°ƒç”¨è‡ªå·±çš„<code>_observe:info:</code>æ–¹æ³•ï¼Œä¼ å…¥<code>object</code>å’Œ<code>info</code>ã€‚</p><h3 id="FBKVOInfoæ•°æ®ç»“æ„"><a href="#FBKVOInfoæ•°æ®ç»“æ„" class="headerlink" title="_FBKVOInfoæ•°æ®ç»“æ„"></a>_FBKVOInfoæ•°æ®ç»“æ„</h3><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">_FBKVOInfo </span>: NSObject</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> _FBKVOInfo &#123;</span><br><span class="line"><span class="variable">@public</span></span><br><span class="line">  __weak FBKVOController *_controller;</span><br><span class="line">  <span class="selector-tag">NSString</span> *<span class="selector-tag">_keyPath</span>;</span><br><span class="line">  <span class="selector-tag">NSKeyValueObservingOptions</span> <span class="selector-tag">_options</span>;</span><br><span class="line">  <span class="selector-tag">SEL</span> <span class="selector-tag">_action</span>;</span><br><span class="line">  <span class="selector-tag">void</span> *<span class="selector-tag">_context</span>;</span><br><span class="line">  <span class="selector-tag">FBKVONotificationBlock</span> <span class="selector-tag">_block</span>;</span><br><span class="line">  <span class="selector-tag">_FBKVOInfoState</span> <span class="selector-tag">_state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_FBKVOInfo</code>æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†ç›‘å¬çš„<code>keyPath</code>ã€<code>block</code>ã€é€‰æ‹©å­ã€<code>context</code>ç­‰ç­‰å…ƒç´ ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithController:(FBKVOController *)controller</span><br><span class="line">                           keyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                           options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</span><br><span class="line">                             block:(<span class="keyword">nullable</span> FBKVONotificationBlock)block</span><br><span class="line">                            action:(<span class="keyword">nullable</span> SEL)action</span><br><span class="line">                           context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context &#123;</span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != <span class="keyword">self</span>) &#123;</span><br><span class="line">    _controller = controller;</span><br><span class="line">    _block = [block <span class="keyword">copy</span>];</span><br><span class="line">    _keyPath = [keyPath <span class="keyword">copy</span>];</span><br><span class="line">    _options = options;</span><br><span class="line">    _action = action;</span><br><span class="line">    _context = context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•çš„å®ç°å°±æ˜¯è¿™æ ·ï¼Œä¸è¿‡æœ‰ä¸¤ä¸ªå…³é”®ç‚¹:<code>block</code>å’Œ<code>keyPath</code>è°ƒç”¨ä¸€ä¸‹ <code>copy</code> æ–¹æ³•ã€‚<br><code>keyPath</code>è°ƒç”¨ä¸€ä¸‹ <code>copy</code>çš„åŸå› æ˜¯ï¼Œè¿™é‡Œçš„<code>_keyPath</code>æ˜¯ä½¿ç”¨<code>__strong</code>ä¿®é¥°çš„ï¼Œå¦‚æœå¤–é¢ä¼ è¿›æ¥çš„æ˜¯ä¸å¯å˜å­—ç¬¦ä¸²ï¼Œè‡ªç„¶æ²¡æœ‰å•¥é—®é¢˜ï¼Œå¯æ˜¯ä¸€æ—¦ä¼ è¿›æ¥ä¸€ä¸ªå¯å˜å­—ç¬¦ä¸²ï¼Œå¦‚æœç›´æ¥èµ‹å€¼<code>_keyPath = keyPath;</code>ï¼Œå½“è¿™ä¸ªå¯å˜å­—ç¬¦ä¸²æ”¹å˜å°±ä¼šé€ æˆ<code>_keyPath</code>ä¹Ÿæ”¹å˜ï¼Œæ¯”è¾ƒå®¹æ˜“äº§ç”Ÿä¸å¯æ§äº‹ä»¶ï¼Œæ‰€ä»¥è°ƒç”¨ <code>copy</code>æ–¹æ³•ï¼Œä¹Ÿå³æ˜¯æ·±å¤åˆ¶æµ…å¤åˆ¶çš„é—®é¢˜ã€‚</p><p>æ²¡æœ‰æ·±å¤åˆ¶çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSMutableString</span> *str = [<span class="built_in">NSMutableString</span> stringWithString:<span class="string">@"key"</span>];</span><br><span class="line"><span class="comment">// å‡å®šæ˜¯_keyPath = keyPath;è€Œä¸æ˜¯_keyPath = [keyPath copy];</span></span><br><span class="line">_FBKVOInfo *info = [[_FBKVOInfo alloc] initWithController:<span class="keyword">self</span> keyPath:str options:<span class="built_in">NSKeyValueObservingOptionNew</span> block:^(<span class="keyword">id</span>  _Nullable observer, <span class="keyword">id</span>  _Nonnull object, <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; * _Nonnull change) &#123;</span><br><span class="line">   </span><br><span class="line">&#125; action:<span class="keyword">@selector</span>(push) context:<span class="literal">nil</span>];</span><br><span class="line">[str appendString:<span class="string">@"new"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, info-&gt;_keyPath); <span class="comment">//info-&gt;_keyPathä¸ç¬¦åˆé¢„æœŸçš„æ”¹å˜äº†</span></span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œ<code>block</code> çš„<code>copy</code>æ˜¯æŠŠ<code>block</code>ä»æ ˆæ‹·è´åˆ°å †ä¸­ï¼Œé˜²æ­¢è¢«é‡Šæ”¾ã€‚å› ä¸º<code>block</code>ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ä¸ä¼šè¢« <code>copy</code>ï¼Œä¾ç„¶åœ¨æ ˆä¸Šï¼Œæ–¹æ³•æ‰§è¡Œå®Œç«‹å³é‡Šæ”¾çš„ã€‚</p><blockquote><p>åœ¨ARCä¸‹ï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹ç³»ç»Ÿä¼šæŠŠBlockè‡ªåŠ¨copyåˆ°å †ä¸Šã€‚</p><p>Blockä½œä¸ºå˜é‡ï¼š<br>æ–¹æ³•ä¸­å£°æ˜ä¸€ä¸ª block çš„æ—¶å€™æ˜¯åœ¨æ ˆä¸Šï¼›<br>å¼•ç”¨äº†å¤–éƒ¨å±€éƒ¨å˜é‡æˆ–æˆå‘˜å˜é‡, å¹¶ä¸”æœ‰èµ‹å€¼æ“ä½œï¼ˆæœ‰åå­—ï¼‰ï¼Œä¼šè¢« copy åˆ°å †ä¸Šï¼›<br>èµ‹å€¼ç»™é™„æœ‰__strongä¿®é¥°ç¬¦çš„idç±»å‹çš„ç±»æˆ–è€…Blcokç±»å‹æˆå‘˜å˜é‡æ—¶ï¼›<br>èµ‹å€¼ç»™ä¸€ä¸ª weak å˜é‡ä¸ä¼šè¢« copyï¼›</p><p>Blockä½œä¸ºå±æ€§ï¼š<br>ç”¨ copy ä¿®é¥°ä¼šè¢« copyï¼›</p><p>Blockä½œä¸ºå‡½æ•°å‚æ•°ï¼š<br>ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ä¸ä¼šè¢« copyï¼Œä¾ç„¶åœ¨æ ˆä¸Šï¼Œæ–¹æ³•æ‰§è¡Œå®Œå³é‡Šæ”¾ï¼›<br>ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ä¼šè¢« copy åˆ°å †ï¼›</p></blockquote><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">- (NSUInteger)hash &#123;</span><br><span class="line">  <span class="keyword">return</span> [_keyPath hash];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isEqual:(id)<span class="keyword">object</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (nil == <span class="keyword">object</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NO;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (self == <span class="keyword">object</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (![<span class="keyword">object</span> isKindOfClass:[self <span class="class"><span class="keyword">class</span>]]) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NO;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [_keyPath isEqualToString:((_FBKVOInfo *)<span class="keyword">object</span>)-&gt;_keyPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_FBKVOInfo</code>è¿˜åšäº†ä¸€ç‚¹å…¶ä»–çš„äº‹ï¼š<br>1.é‡å†™äº†<code>- (NSUInteger)hash;</code>æ–¹æ³•ï¼Œä½¿ç”¨<code>_keyPath</code>çš„ <code>hash</code> å€¼æ¥ä½œä¸º<code>_FBKVOInfo</code>çš„ <code>hash</code> å€¼ã€‚åˆ†é…çš„è¿™ä¸ª<code>hash</code>å€¼(å³ç”¨äºæŸ¥æ‰¾é›†åˆä¸­æˆå‘˜çš„ä½ç½®æ ‡è¯†)ï¼Œå°±æ˜¯é€šè¿‡<code>hash</code>æ–¹æ³•è®¡ç®—å¾—æ¥çš„ï¼Œä¸”<code>hash</code>æ–¹æ³•è¿”å›çš„<code>hash</code>å€¼æœ€å¥½å”¯ä¸€ã€‚<br>2.é‡å†™äº†<code>- (BOOL)isEqual:(id)object;</code>æ–¹æ³•ï¼Œæ»¡è¶³<code>Equal</code>çš„æ¡ä»¶æœ‰ä¸¤ä¸ª: é¦–å…ˆæ˜¯ç±»å¯¹è±¡ä¸€è‡´ï¼Œå†è€…æ˜¯<code>_keyPath</code>åŒ¹é…ã€‚æ¢å¥è¯è¯´ï¼Œ<code>_keyPath</code>å†³å®šäº†<code>_FBKVOInfo</code>æ˜¯å¦æ˜¯åŒä¸€ä¸ªã€‚ä¸ºäº†ä¼˜åŒ–åˆ¤ç­‰çš„æ•ˆç‡ï¼ŒåŸºäº<code>hash</code>çš„<code>NSSet</code>å’Œ<code>NSDictionary</code>åœ¨åˆ¤æ–­æˆå‘˜æ˜¯å¦ç›¸ç­‰æ—¶ï¼Œ ä¼šè¿™æ ·åšStep1: æˆå‘˜çš„<code>hash</code>å€¼æ˜¯å¦å’Œç›®æ ‡<code>hash</code>å€¼ç›¸ç­‰ï¼Œå¦‚æœç›¸åŒè¿›å…¥Step 2ï¼Œå¦‚æœä¸ç­‰ï¼Œç›´æ¥åˆ¤æ–­ä¸ç›¸ç­‰<br>Step 2: <code>hash</code>å€¼ç›¸åŒ(å³Step 1)çš„æƒ…å†µä¸‹ï¼Œå†è¿›è¡Œå¯¹è±¡åˆ¤ç­‰ï¼Œ ä½œä¸ºåˆ¤ç­‰çš„ç»“æœã€‚</p><blockquote><p>hashå€¼æ˜¯å¯¹è±¡åˆ¤ç­‰çš„å¿…è¦éå……åˆ†æ¡ä»¶</p></blockquote><p><code>NSPointerFunctionsObjectPointerPersonality</code>å¯¹äº <code>isEqual:</code> å’Œ <code>hash</code> ä½¿ç”¨ç›´æ¥çš„æŒ‡é’ˆæ¯”è¾ƒã€‚ä½¿ç”¨ç§»ä½æŒ‡é’ˆ(shifted pointer)æ¥åšhashæ£€æµ‹åŠç¡®å®šä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼›åŒæ—¶ä½¿ç”¨descriptionæ–¹æ³•æ¥åšæè¿°å­—ç¬¦ä¸²ã€‚</p><blockquote><p>Personalities determine hashing and equality. NSPointerFunctionsObjectPersonality provides the standard Foundation behavior of using hash and isEqual:. You can also use NSPointerFunctionsObjectPointerPersonality, which treats the contents as objects, but uses direct pointer value comparison; this is useful if you need a collection to work with object identity rather than value.<br>NSPointerFunctionsObjectPointerPersonality ä½¿ç”¨ <code>==</code>åˆ¤æ–­ç›¸ç­‰<br>NSPointerFunctionsObjectPersonality ä½¿ç”¨<code>hash</code>å’Œ<code>isEqual:</code>åˆ¤æ–­ç›¸ç­‰ </p></blockquote><h3 id="observe-info-æ–¹æ³•"><a href="#observe-info-æ–¹æ³•" class="headerlink" title="_observe:info:æ–¹æ³•"></a>_observe:info:æ–¹æ³•</h3><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)<span class="variable">_observe</span>:(id)object info:(<span class="variable">_FBKVOInfo</span> *)info &#123;</span><br><span class="line">  <span class="comment">// lock</span></span><br><span class="line">  pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">  NSMutableSet *infos = [<span class="variable">_objectInfosMap</span> objectForKey:object];</span><br><span class="line">  <span class="comment">// æ£€æŸ¥infosæ˜¯å¦å­˜åœ¨äº_objectInfosMapä¸­</span></span><br><span class="line">  <span class="variable">_FBKVOInfo</span> *existingInfo = [infos member:info];</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != existingInfo) &#123;</span><br><span class="line">    <span class="comment">// å·²ç»å­˜åœ¨äº†ï¼Œreturn</span></span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»ºinfoså¹¶ä¿å­˜äº_objectInfosMapä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == infos) &#123;</span><br><span class="line">    infos = [NSMutableSet <span class="built_in">set</span>];</span><br><span class="line">    [<span class="variable">_objectInfosMap</span> setObject:infos forKey:object];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æŠŠinfoæ·»åŠ åˆ°infosä¸­</span></span><br><span class="line">  [infos addObject:info];</span><br><span class="line">  pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">  <span class="comment">// _FBKVOSharedControlleræ·»åŠ è§‚å¯Ÿ</span></span><br><span class="line">  [[<span class="variable">_FBKVOSharedController</span> sharedController] observe:object info:info];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåŠ é”ã€‚æŠŠè¢«è§‚å¯Ÿçš„å¯¹è±¡<code>object</code>ä½œä¸º<code>key</code>ä»è‡ªå·±çš„<code>_objectInfosMap</code>è·å–å…¶å¯¹åº”çš„<code>NSMutableSet</code>ç±»å‹çš„é›†åˆï¼Œå¦‚æœè¿™ä¸ªé›†åˆåŒ…å«äº†å·²ç»å°è£…å¥½çš„<code>info</code>å¯¹è±¡ï¼Œè¯´æ˜å·²ç»å¯¹è¿™ä¸ª<code>info</code>æ·»åŠ è¿‡ç›‘å¬äº†ï¼Œè§£é”ç›´æ¥ return å°±æ˜¯äº†ã€‚<br>å¦‚æœè¿™ä¸ª<code>infos</code>é›†åˆä¸å­˜åœ¨ï¼Œåˆ›å»ºã€‚æŠŠ<code>info</code>å…ƒç´ æ·»åŠ åˆ°è¿™ä¸ª<code>infos</code>é›†åˆä¸­ã€‚è§£é”ã€‚è°ƒç”¨<code>[[_FBKVOSharedController sharedController] observe:object info:info];</code>æ–¹æ³•ã€‚</p><p>å¯è§è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ä½¿ç”¨<code>_objectInfosMap</code>ä¿å­˜äº†å°è£…å¥½çš„<code>info</code>å¯¹è±¡ï¼Œå…·ä½“ç›‘å¬è°ƒç”¨é€»è¾‘ä¾èµ–äº<code>_FBKVOSharedController</code>ã€‚</p><h1 id="äº”ã€-FBKVOSharedControllerå®ç°"><a href="#äº”ã€-FBKVOSharedControllerå®ç°" class="headerlink" title="äº”ã€_FBKVOSharedControllerå®ç°"></a>äº”ã€_FBKVOSharedControllerå®ç°</h1><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_FBKVOSharedController</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedController;</span><br><span class="line">- (<span class="keyword">void</span>)observe:(<span class="keyword">id</span>)object info:(<span class="keyword">nullable</span> _FBKVOInfo *)info;</span><br><span class="line">- (<span class="keyword">void</span>)unobserve:(<span class="keyword">id</span>)object info:(<span class="keyword">nullable</span> _FBKVOInfo *)info;</span><br><span class="line">- (<span class="keyword">void</span>)unobserve:(<span class="keyword">id</span>)object infos:(<span class="keyword">nullable</span> <span class="built_in">NSSet</span> *)infos;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_FBKVOSharedController</span> </span>&#123;</span><br><span class="line">  <span class="built_in">NSHashTable</span>&lt;_FBKVOInfo *&gt; *_infos;</span><br><span class="line">  pthread_mutex_t _mutex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_FBKVOSharedController</code>æ˜¯ä¸€ä¸ªå•ä¾‹ã€‚ä½œç”¨æ˜¯è§‚å¯Ÿ <code>_FBKVOInfo</code> ä¸­çš„ <code>keyPath</code>ï¼Œå¹¶ç»™äºˆå›è°ƒ(å›è°ƒçš„ç±»å‹å¯ä»¥æ˜¯ <code>block</code>ã€<code>selector</code>ã€ç³»ç»Ÿå›è°ƒæ–¹æ³•)ã€‚</p><p> æš´éœ²å‡ºä¸¤ä¸ªæ–¹æ³•:</p><ol><li>æ·»åŠ ç›‘å¬ï¼Œå‚æ•°ä¸º<code>_infos</code></li><li><p>ç§»é™¤ç›‘å¬ï¼Œå‚æ•°ä¸º<code>_FBKVOInfo</code>æˆ–è€…<code>NSSet</code>ç±»å‹çš„<code>infos</code>(å®¹å™¨å†…çš„å…ƒç´ ä»ç„¶æ˜¯<code>_FBKVOInfo</code>)</p><p>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå“ˆå¸Œè¡¨(NSHashTable)<code>_infos</code>ï¼Œç”¨äºä¿å­˜è¿™äº›<code>_FBKVOInfo</code>ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªé”:<code>_mutex</code>ï¼Œç”¨äºå®ç°çº¿ç¨‹å®‰å…¨ã€‚</p><p>å“ˆå¸Œè¡¨çš„åˆ›å»º:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSHashTable</span> *infos = [<span class="built_in">NSHashTable</span> alloc];</span><br><span class="line">_infos = [infos initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span> capacity:<span class="number">0</span>];</span><br><span class="line"><span class="built_in">NSPointerFunctionsWeakMemory</span>: æŒå¼±æŒ‡é’ˆå¼•ç”¨ç€_FBKVOInfoå¯¹è±¡ã€‚</span><br><span class="line"><span class="built_in">NSPointerFunctionsObjectPointerPersonality</span> ä½¿ç”¨==åˆ¤å®šç›¸ç­‰ã€‚</span><br></pre></td></tr></table></figure></li></ol><p>å¯è§<code>_FBKVOSharedController</code>åªæ˜¯å•çº¯åœ°æŒç®¡<code>_FBKVOInfo</code>é›†åˆï¼Œå®ƒåªéœ€è¦è§£æ<code>_FBKVOInfo</code>å¹¶ç»™observerå›è°ƒå³å¯ï¼Œå…¶ä»–çš„ä¸€åˆ‡éƒ½ä¸å…³å¿ƒã€‚</p><h2 id="æ·»åŠ ç›‘å¬"><a href="#æ·»åŠ ç›‘å¬" class="headerlink" title="æ·»åŠ ç›‘å¬"></a>æ·»åŠ ç›‘å¬</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">observe:</span>(id)object <span class="string">info:</span>(nullable _FBKVOInfo *)info &#123;</span><br><span class="line">  <span class="keyword">if</span> (nil == info) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// _infosæ·»åŠ å¯¹è±¡</span></span><br><span class="line">  pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">  [_infos <span class="string">addObject:</span>info];</span><br><span class="line">  pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">  <span class="comment">// æ·»åŠ è§‚å¯Ÿï¼Œä¼ å…¥çš„contextæ˜¯info</span></span><br><span class="line">  [object <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>info-&gt;_keyPath <span class="string">options:</span>info-&gt;_options <span class="string">context:</span>(<span class="keyword">void</span> *)info];</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;_state == _FBKVOInfoStateInitial) &#123;</span><br><span class="line">    info-&gt;_state = _FBKVOInfoStateObserving; <span class="comment">// åˆå§‹çŠ¶æ€è½¬ç›‘å¬çŠ¶æ€</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info-&gt;_state == _FBKVOInfoStateNotObserving) &#123; <span class="comment">// æœªç›‘å¬çŠ¶æ€ä¾¿ç§»é™¤</span></span><br><span class="line">    <span class="comment">// this could happen when `NSKeyValueObservingOptionInitial` is one of the NSKeyValueObservingOptions,</span></span><br><span class="line">    <span class="comment">// and the observer is unregistered within the callback block.</span></span><br><span class="line">    <span class="comment">// at this time the object has been registered as an observer (in Foundation KVO),</span></span><br><span class="line">    <span class="comment">// so we can safely unobserve it.</span></span><br><span class="line">    <span class="comment">// NSKeyValueObservingOptionInitialï¼šæ·»åŠ è§‚å¯Ÿè€…æ—¶å°±è§¦å‘å›è°ƒï¼Œå¹¶ä¸”åœ¨åé¢èµ‹å€¼æ—¶ä¹Ÿä¼šè§¦å‘å›è°ƒï¼Œä½†æ˜¯éƒ½åªè¿”å›NSKeyValueChangeKindKeyã€‚è§‚å¯Ÿè€…åœ¨callback blockä¸­å–æ¶ˆè§‚å¯Ÿï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒremoveObserver</span></span><br><span class="line">    [object <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>info-&gt;_keyPath <span class="string">context:</span>(<span class="keyword">void</span> *)info];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨ä¸­æ·»åŠ  info å…ƒç´ ï¼Œæ·»åŠ ç›‘å¬ã€‚</p><h2 id="ç§»é™¤ç›‘å¬"><a href="#ç§»é™¤ç›‘å¬" class="headerlink" title="ç§»é™¤ç›‘å¬"></a>ç§»é™¤ç›‘å¬</h2><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)unobserve:(id)object info:(nullable <span class="variable">_FBKVOInfo</span> *)info &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> == info) return;</span><br><span class="line">  <span class="comment">// å“ˆå¸Œè¡¨ä¸­ç§»é™¤info</span></span><br><span class="line">  pthread_mutex_lock(&amp;<span class="variable">_mutex</span>);</span><br><span class="line">  [<span class="variable">_infos</span> removeObject:info];</span><br><span class="line">  pthread_mutex_unlock(&amp;<span class="variable">_mutex</span>);</span><br><span class="line">  <span class="comment">// ç§»é™¤ç›‘å¬</span></span><br><span class="line">  <span class="keyword">if</span> (info-&gt;<span class="variable">_state</span> == <span class="variable">_FBKVOInfoStateObserving</span>) &#123;</span><br><span class="line">    [object removeObserver:self forKeyPath:info-&gt;<span class="variable">_keyPath</span> context:(void *)info];</span><br><span class="line">  &#125;</span><br><span class="line">  info-&gt;<span class="variable">_state</span> = <span class="variable">_FBKVOInfoStateNotObserving</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨ä¸­ç§»é™¤ info å…ƒç´ ï¼Œç§»é™¤ç›‘å¬ã€‚</p><h2 id="ç³»ç»ŸKVOè°ƒç”¨"><a href="#ç³»ç»ŸKVOè°ƒç”¨" class="headerlink" title="ç³»ç»ŸKVOè°ƒç”¨"></a>ç³»ç»ŸKVOè°ƒç”¨</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change</span><br><span class="line">                       context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context &#123;</span><br><span class="line">  _FBKVOInfo *info;</span><br><span class="line">  &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    <span class="comment">// çœ‹çœ‹infoæ˜¯å¦å­˜åœ¨äº_infosä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¿”å›info</span></span><br><span class="line">    info = [_infos member:(__bridge <span class="keyword">id</span>)context];</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != info) &#123;</span><br><span class="line">    <span class="comment">// å±€éƒ¨å˜é‡å¼ºå¼•ç”¨controller</span></span><br><span class="line">    FBKVOController *controller = info-&gt;_controller;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> != controller) &#123;</span><br><span class="line">      <span class="comment">// å±€éƒ¨å˜é‡å¼ºå¼•ç”¨observer</span></span><br><span class="line">      <span class="keyword">id</span> observer = controller.observer;</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">nil</span> != observer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;_block) &#123;  <span class="comment">// å›è°ƒ block</span></span><br><span class="line">          <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *changeWithKeyPath = change;</span><br><span class="line">          <span class="keyword">if</span> (keyPath) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *mChange = [<span class="built_in">NSMutableDictionary</span> dictionaryWithObject:keyPath forKey:FBKVONotificationKeyPathKey];</span><br><span class="line">            [mChange addEntriesFromDictionary:change];</span><br><span class="line">            changeWithKeyPath = [mChange <span class="keyword">copy</span>];</span><br><span class="line">          &#125;</span><br><span class="line">          info-&gt;_block(observer, object, changeWithKeyPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info-&gt;_action) &#123; <span class="comment">// å›è°ƒ selector</span></span><br><span class="line">          [observer performSelector:info-&gt;_action withObject:change withObject:object];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// è°ƒç”¨KVO ç³»ç»Ÿæ–¹æ³•</span></span><br><span class="line">          [observer observeValueForKeyPath:keyPath ofObject:object change:change context:info-&gt;_context];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ç³»ç»Ÿæ–¹æ³•ä¸­ç»™äºˆä¸åŒç±»å‹çš„å›è°ƒã€‚</p><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">typedef NS_ENUM(uint8_t, <span class="variable">_FBKVOInfoState</span>) &#123;</span><br><span class="line">  <span class="variable">_FBKVOInfoStateInitial</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="variable">_FBKVOInfoStateObserving</span>,</span><br><span class="line">  <span class="variable">_FBKVOInfoStateNotObserving</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½œè€…ä½¿ç”¨äº†ä¸‰ä¸ªæšä¸¾å€¼æ¥è®°å½•ç›‘å¬çŠ¶æ€ã€‚ä¼šä¸ä¼šæ˜¯å¤šæ­¤ä¸€ä¸¾å‘¢ï¼Ÿä¸ä¼šã€‚ä½œç”¨ä¸»è¦ä½“ç°åœ¨æ·»åŠ ç›‘å¬çš„æ–¹æ³•é‡Œæœ‰ä¸ªç§»é™¤ç›‘å¬æ“ä½œï¼š</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// æ·»åŠ è§‚å¯Ÿï¼Œä¼ å…¥çš„contextæ˜¯info</span></span><br><span class="line">[<span class="function"><span class="title">object</span> addObserver:self forKeyPath:info-&gt;</span>_<span class="function"><span class="title">keyPath</span> options:info-&gt;</span>_options context:(void *)info];</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="title">if</span> (info-&gt;</span>_state == _FBKVOInfoStateInitial) &#123;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>_state = _FBKVOInfoStateObserving; <span class="comment">// åˆå§‹çŠ¶æ€è½¬ç›‘å¬çŠ¶æ€</span></span><br><span class="line">  &#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (info-&gt;</span>_state == _FBKVOInfoStateNotObserving) &#123; <span class="comment">// æœªç›‘å¬çŠ¶æ€ä¾¿ç§»é™¤</span></span><br><span class="line">    [<span class="function"><span class="title">object</span> removeObserver:self forKeyPath:info-&gt;</span>_keyPath context:(void *)info];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>â€œæœªç›‘å¬çŠ¶æ€ä¾¿ç§»é™¤â€œæ˜¯æ€ä¹ˆå‡ºç°çš„ï¼Ÿç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.KVOController observe:<span class="keyword">self</span>.myButton keyPath:<span class="string">@"backgroundColor"</span> options:<span class="built_in">NSKeyValueObservingOptionInitial</span> block:^(<span class="keyword">id</span>  _Nullable observer, <span class="keyword">id</span>  _Nonnull object, <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; * _Nonnull change) &#123;</span><br><span class="line">     [<span class="keyword">self</span>.KVOController unobserve:<span class="keyword">self</span>.myButton keyPath:<span class="string">@"backgroundColor"</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>åŒ…å«äº†<code>NSKeyValueObservingOptionInitial</code>é€‰é¡¹ä¸”åœ¨å›è°ƒä¸­ç§»é™¤äº†ç›‘å¬å°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚å› ä¸ºå¦‚æœæœ‰<code>NSKeyValueObservingOptionInitial</code>é€‰é¡¹ï¼Œåœ¨æ·»åŠ ç›‘å¬çš„æ—¶å€™å°±ä¼šæœ‰å›è°ƒã€‚è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š<br><img src="https://image.chenyalun.com/2019/01/07/001.png" style="zoom:70%"><br>æ‰§è¡Œåˆ°<code>[object addObserver:self forKeyPath:info-&gt;_keyPath options:info-&gt;_options context:(void *)info];</code>è¿™è¡Œä»£ç çš„æ—¶å€™ï¼Œé¦–å…ˆæ·»åŠ ç›‘å¬ï¼Œæ¥ç€è°ƒç”¨å›è°ƒï¼Œè€Œå›è°ƒä¸­åˆç§»é™¤äº†è§‚å¯Ÿï¼Œè¿™æ—¶infoçš„çŠ¶æ€è¢«è®¾ç½®ä¸º<code>_FBKVOInfoStateNotObserving</code>ã€‚æ¥ç€è¿›å…¥äº†ä¸‹é¢çš„ if-else åˆ¤æ–­ä¸­ï¼Œæ‰æœ‰äº†ç§»é™¤ç›‘å¬çš„æ“ä½œã€‚å¯è§é€»è¾‘éå¸¸ä¸¥è°¨ã€‚</p><p>NSKeyValueObservingOptionå‚è€ƒï¼š</p><blockquote><p>NSKeyValueObservingOptionNewï¼šæ¥æ”¶æ–¹æ³•ä¸­ä½¿ç”¨changeå‚æ•°ä¼ å…¥å˜åŒ–åçš„æ–°å€¼ï¼Œé”®ä¸ºï¼š&gt;NSKeyValueChangeNewKeyï¼›<br>NSKeyValueObservingOptionOldï¼šæ¥æ”¶æ–¹æ³•ä¸­ä½¿ç”¨changeå‚æ•°ä¼ å…¥å˜åŒ–å‰çš„æ—§å€¼ï¼Œé”®ä¸ºï¼š&gt;NSKeyValueChangeOldKeyï¼›<br>NSKeyValueObservingOptionInitialï¼šæ³¨å†Œä¹‹åç«‹åˆ»è°ƒç”¨æ¥æ”¶æ–¹æ³•ï¼Œå¦‚æœé…ç½®äº†&gt;NSKeyValueObservingOptionNewï¼Œchangeå‚æ•°å†…å®¹ä¼šåŒ…å«æ–°å€¼ï¼Œé”®ä¸ºï¼š&gt;NSKeyValueChangeNewKeyï¼›<br>NSKeyValueObservingOptionPriorï¼šå¦‚æœåŠ å…¥è¿™ä¸ªå‚æ•°ï¼Œæ¥æ”¶æ–¹æ³•ä¼šåœ¨å˜åŒ–å‰ååˆ†åˆ«è°ƒç”¨ä¸€æ¬¡ï¼Œå…±ä¸¤&gt;æ¬¡ï¼Œå˜åŒ–å‰çš„é€šçŸ¥changeå‚æ•°åŒ…å«notificationIsPrior = 1ã€‚å…¶ä»–å†…å®¹æ ¹æ®&gt;NSKeyValueObservingOptionNewå’ŒNSKeyValueObservingOptionOldçš„é…ç½®ç¡®å®šã€‚</p></blockquote><h1 id="å…­ã€ä¸€ä¸ªå‡½æ•°"><a href="#å…­ã€ä¸€ä¸ªå‡½æ•°" class="headerlink" title="å…­ã€ä¸€ä¸ªå‡½æ•°"></a>å…­ã€ä¸€ä¸ªå‡½æ•°</h1><p>å…¶å®ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸è¿‡æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼Œæ ¸å¿ƒè¿˜æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.æšä¸¾å­—ç¬¦ä¸²åŒ–</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *describe_option(<span class="built_in">NSKeyValueObservingOptions</span> option) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (option) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSKeyValueObservingOptionNew</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@"NSKeyValueObservingOptionNew"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSKeyValueObservingOptionOld</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@"NSKeyValueObservingOptionOld"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSKeyValueObservingOptionInitial</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@"NSKeyValueObservingOptionInitial"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSKeyValueObservingOptionPrior</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@"NSKeyValueObservingOptionPrior"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">NSCAssert</span>(<span class="literal">NO</span>, <span class="string">@"unexpected option %tu"</span>, option);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.æ‹¼æ¥option</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> append_option_description(<span class="built_in">NSMutableString</span> *s, <span class="built_in">NSUInteger</span> option) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == s.length) &#123;</span><br><span class="line">        [s appendString:describe_option(option)];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [s appendString:<span class="string">@"|"</span>];</span><br><span class="line">        [s appendString:describe_option(option)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.NSKeyValueObservingOptionsç±»å‹å€¼éå†</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSUInteger</span> enumerate_flags(<span class="built_in">NSUInteger</span> *ptrFlags) &#123;</span><br><span class="line">    <span class="built_in">NSCAssert</span>(ptrFlags, <span class="string">@"expected ptrFlags"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ptrFlags) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> flags = *ptrFlags;</span><br><span class="line">    <span class="keyword">if</span> (!flags)  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> flag = <span class="number">1</span> &lt;&lt; __builtin_ctzl(flags);</span><br><span class="line">    flags &amp;= ~flag;</span><br><span class="line">    *ptrFlags = flags;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.æŠŠoptionsæ‰€æœ‰å€¼éƒ½æ‹¼å‡ºæ¥</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *describe_options(<span class="built_in">NSKeyValueObservingOptions</span> options) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *s = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="built_in">NSUInteger</span> option;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">0</span> != (option = enumerate_flags(&amp;options))) &#123;</span><br><span class="line">        append_option_description(s, option);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä½¿ç”¨ switch-case æŠŠä½ç§»æšä¸¾çš„å€¼éå†å‡ºæ¥äº†ã€‚</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Similar to __builtin_ctz, except the argument type is unsigned long.</span></span><br><span class="line"><span class="comment">// __builtin_ctz(x)ï¼šxæœ«å°¾0çš„ä¸ªæ•°</span></span><br><span class="line"><span class="comment">// å·¦ç§»__builtin_ctz(x)ä½å¾—åˆ°åŸå…ˆçš„æšä¸¾å€¼</span></span><br><span class="line">NSUInteger flag = <span class="number">1</span> &lt;&lt; __builtin_ctzl(<span class="keyword">flags</span>);</span><br><span class="line"><span class="comment">// flags å»é™¤å·²ç»å–åˆ°çš„å€¼</span></span><br><span class="line"><span class="keyword">flags</span> &amp;= ~flag;</span><br><span class="line"><span class="comment">// æŠŠæ›´æ–°åçš„flagsèµ‹äºˆæŒ‡å‘ptrFlagsçš„æŒ‡é’ˆ</span></span><br><span class="line">*ptrFlags = <span class="keyword">flags</span>;</span><br></pre></td></tr></table></figure><p>ä¸å¤±ä¸ºä¸€ä¸ªå¥½åŠæ³•ã€‚</p><h1 id="ä¸ƒã€æ€»ç»“"><a href="#ä¸ƒã€æ€»ç»“" class="headerlink" title="ä¸ƒã€æ€»ç»“"></a>ä¸ƒã€æ€»ç»“</h1><blockquote><p>ä½¿ç”¨ KVOController è¿›è¡Œé”®å€¼è§‚æµ‹å¯ä»¥è¯´å®Œç¾åœ°è§£å†³äº†åœ¨ä½¿ç”¨åŸç”Ÿ KVO æ—¶é‡åˆ°çš„å„ç§é—®é¢˜ã€‚</p><p>1.ä¸éœ€è¦æ‰‹åŠ¨ç§»é™¤è§‚å¯Ÿè€…ï¼›<br>2.å®ç° KVO ä¸äº‹ä»¶å‘ç”Ÿå¤„çš„ä»£ç ä¸Šä¸‹æ–‡ç›¸åŒï¼Œä¸éœ€è¦è·¨æ–¹æ³•ä¼ å‚æ•°ï¼›<br>3.ä½¿ç”¨ block æ¥æ›¿ä»£æ–¹æ³•èƒ½å¤Ÿå‡å°‘ä½¿ç”¨çš„å¤æ‚åº¦ï¼Œæå‡ä½¿ç”¨ KVO çš„ä½“éªŒï¼›<br>4.æ¯ä¸€ä¸ª keyPath ä¼šå¯¹åº”ä¸€ä¸ªå±æ€§ï¼Œä¸éœ€è¦åœ¨ block ä¸­ä½¿ç”¨ if åˆ¤æ–­ keyPathï¼›</p></blockquote><p>ä»¥ä¸Šå¼•è‡ªdravenessã€‚è§£é‡Šå¦‚ä¸‹ï¼š<br>1.NSMapTable å¯ä»¥æŒæœ‰é”®å’Œå€¼çš„å¼±å¼•ç”¨ï¼Œå½“é”®æˆ–è€…å€¼å½“ä¸­çš„ä¸€ä¸ªè¢«é‡Šæ”¾æ—¶ï¼Œæ•´ä¸ªè¿™ä¸€é¡¹å°±ä¼šè¢«ç§»é™¤æ‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œä½¿ç”¨è¢«è§‚å¯Ÿè€…observerä½œä¸ºå¼ºå¼•ç”¨æˆ–è€…å¼±å¼•ç”¨çš„keyï¼Œä½¿ç”¨_FBKVOInfoä½œä¸ºå¼ºå¼•ç”¨çš„value</span></span><br><span class="line"><span class="built_in">NSPointerFunctionsOptions</span> keyOptions = retainObserved ? <span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span> : <span class="built_in">NSPointerFunctionsWeakMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span>;</span><br><span class="line">_objectInfosMap = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyOptions:keyOptions valueOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPersonality</span> capacity:<span class="number">0</span>];</span><br></pre></td></tr></table></figure><p>2.å› ä¸ºæ˜¯åœ¨@selector(observeValueForKeyPath:ofObject:change:context:)ä¸­å¤„ç†çš„å›è°ƒã€‚<br>3.ä½¿ç”¨FBKVONotificationBlockã€‚<br>4._FBKVOInfoå°è£…ã€‚</p><p>çºµè§‚å…¨éƒ¨ä»£ç ï¼Œä½œè€…é¦–å…ˆç»™åˆ†ç±»æ·»åŠ äº†ä¸¤ä¸ªå±æ€§ï¼Œç”¨äºæ¥å£è°ƒç”¨ã€‚è¿™äº›å±æ€§éƒ½æŒ‡å‘äº†FBKVOControllerï¼ŒFBKVOControllerä¸»è¦ç»´æŠ¤äº†ä¸€ä¸ªNSMapTableã€‚key æ˜¯æ‰€è§‚å¯Ÿçš„å¯¹è±¡ï¼Œvalue æ˜¯NSMutableSetç±»å‹çš„é›†åˆï¼Œå…¶å†…éƒ¨å…ƒç´ æ˜¯_FBKVOInfoç±»å‹å¯¹è±¡ã€‚ä¸€ä¸ª_FBKVOInfoå¯¹è±¡å¯¹åº”ä¸€ä¸ªä¿¡æ¯å°è£…ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨NSMapTableé›†åˆæ˜¯ä¾¿äºå¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªkeyPathè¿›è¡Œè§‚å¯Ÿï¼ŒåŒæ—¶å¤„ç†è¢«è§‚å¯Ÿè€…çš„å¼ºå¼±å¼•ç”¨ã€‚å¦å¤–_FBKVOInfoå¯¹è±¡æ˜¯å¯¹FBKVOControllerã€keyPathã€contextã€å›è°ƒblockç­‰ä¿¡æ¯çš„å°è£…ã€‚æœ€åï¼Œå„ä¸ªFBKVOControlleræŠŠæ‰€æœ‰å¯¹è§‚å¯Ÿçš„å¤„ç†äº¤ç»™å•ä¾‹_FBKVOSharedControllerï¼Œè¿™ä¸ªå•ä¾‹è°ƒç”¨ç³»ç»ŸKVOæ–¹æ³•å›è°ƒã€å¤„ç†åŒ…å«æ‰€æœ‰_FBKVOInfoå¯¹è±¡çš„NSHashTableé›†åˆã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™<br><a href="https://github.com/draveness/analyze/blob/master/contents/KVOController/KVOController.md" target="_blank" rel="noopener">KVOController</a><br><a href="https://blog.csdn.net/DonnyDN/article/details/77750751" target="_blank" rel="noopener">iOSä¸­Blockä½¿ç”¨æ³¨æ„ç‚¹</a><br><a href="https://www.jianshu.com/p/915356e280fc" target="_blank" rel="noopener">isEqualä¸hash</a><br><a href="https://blog.kyleduo.com/2014/10/20/ios_learning-kvo/" target="_blank" rel="noopener">iOSå­¦ä¹ ç¬”è®°â€”â€”KVO</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å­¦ä¹ KVOçš„å°è£…ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ã€ŒYYCacheã€</title>
    <link href="http://blog.chenyalun.com/2019/01/02/%E8%AF%BB%E3%80%8CYYCache%E3%80%8D/"/>
    <id>http://blog.chenyalun.com/2019/01/02/è¯»ã€ŒYYCacheã€/</id>
    <published>2019-01-02T07:22:17.000Z</published>
    <updated>2019-09-17T07:12:50.754Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> å…³äºYYCacheçš„ç®€å•æ€»ç»“ã€‚ </p><br><a id="more"></a><p></p><p>é˜…è¯»YYCacheæºç æœ‰3éäº†ï¼Œè‡ªæˆ‘æ„Ÿè§‰â€œéœ€è¦ç†è§£â€çš„éƒ¨åˆ†æŒæ¡çš„å·®ä¸å¤šäº†ï¼Œåšä¸ªè®°å½•ã€‚</p><h1 id="ä¸€ã€æ¥å£"><a href="#ä¸€ã€æ¥å£" class="headerlink" title="ä¸€ã€æ¥å£"></a>ä¸€ã€æ¥å£</h1><p>API ç±»ä¼¼å­—å…¸ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚</p><h2 id="1-åˆå§‹åŒ–"><a href="#1-åˆå§‹åŒ–" class="headerlink" title="1.åˆå§‹åŒ–"></a>1.åˆå§‹åŒ–</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYMemoryCache *memoryCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYDiskCache *diskCache;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithPath:(<span class="built_in">NSString</span> *)path;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new UNAVAILABLE_ATTRIBUTE;</span><br></pre></td></tr></table></figure><h2 id="2-æ˜¯å¦å­˜åœ¨"><a href="#2-æ˜¯å¦å­˜åœ¨" class="headerlink" title="2.æ˜¯å¦å­˜åœ¨"></a>2.æ˜¯å¦å­˜åœ¨</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> contains))block;</span><br></pre></td></tr></table></figure><h2 id="3-æŸ¥è¯¢"><a href="#3-æŸ¥è¯¢" class="headerlink" title="3.æŸ¥è¯¢"></a>3.æŸ¥è¯¢</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)objectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object))block;</span><br></pre></td></tr></table></figure><h2 id="4-è®¾å€¼"><a href="#4-è®¾å€¼" class="headerlink" title="4.è®¾å€¼"></a>4.è®¾å€¼</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br></pre></td></tr></table></figure><h2 id="5-ç§»é™¤"><a href="#5-ç§»é™¤" class="headerlink" title="5.ç§»é™¤"></a>5.ç§»é™¤</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key))block;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjects;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithBlock:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithProgressBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">int</span> removedCount, <span class="keyword">int</span> totalCount))progress endBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> error))end;</span><br></pre></td></tr></table></figure><h1 id="äºŒã€å®ç°"><a href="#äºŒã€å®ç°" class="headerlink" title="äºŒã€å®ç°"></a>äºŒã€å®ç°</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYCache</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>) init &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Use \"initWithName\" or \"initWithPath\" to create YYCache instance."</span>);</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:<span class="string">@""</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *cacheFolder = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) firstObject];</span><br><span class="line">    <span class="built_in">NSString</span> *path = [cacheFolder stringByAppendingPathComponent:name];</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:path];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    YYDiskCache *diskCache = [[YYDiskCache alloc] initWithPath:path];</span><br><span class="line">    <span class="keyword">if</span> (!diskCache) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *name = [path lastPathComponent];</span><br><span class="line">    YYMemoryCache *memoryCache = [YYMemoryCache new];</span><br><span class="line">    memoryCache.name = name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _name = name;</span><br><span class="line">    _diskCache = diskCache;</span><br><span class="line">    _memoryCache = memoryCache;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)cacheWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithName:name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)cacheWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithPath:path];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [_memoryCache containsObjectForKey:key] || [_diskCache containsObjectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">void</span> (^)(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> contains))block &#123;</span><br><span class="line">    <span class="keyword">if</span> (!block) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([_memoryCache containsObjectForKey:key]) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">            block(key, <span class="literal">YES</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        [_diskCache containsObjectForKey:key withBlock:block];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object = [_memoryCache objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (!object) &#123;</span><br><span class="line">        object = [_diskCache objectForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (object) &#123;</span><br><span class="line">            [_memoryCache setObject:object forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)objectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">void</span> (^)(<span class="built_in">NSString</span> *key, <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object))block &#123;</span><br><span class="line">    <span class="keyword">if</span> (!block) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object = [_memoryCache objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (object) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">            block(key, object);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [_diskCache objectForKey:key withBlock:^(<span class="built_in">NSString</span> *key, <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (object &amp;&amp; ![_memoryCache objectForKey:key]) &#123;</span><br><span class="line">                [_memoryCache setObject:object forKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">            block(key, object);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    [_memoryCache setObject:object forKey:key];</span><br><span class="line">    [_diskCache setObject:object forKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">    [_memoryCache setObject:object forKey:key];</span><br><span class="line">    [_diskCache setObject:object forKey:key withBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    [_memoryCache removeObjectForKey:key];</span><br><span class="line">    [_diskCache removeObjectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">void</span> (^)(<span class="built_in">NSString</span> *key))block &#123;</span><br><span class="line">    [_memoryCache removeObjectForKey:key];</span><br><span class="line">    [_diskCache removeObjectForKey:key withBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjects &#123;</span><br><span class="line">    [_memoryCache removeAllObjects];</span><br><span class="line">    [_diskCache removeAllObjects];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithBlock:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">    [_memoryCache removeAllObjects];</span><br><span class="line">    [_diskCache removeAllObjectsWithBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithProgressBlock:(<span class="keyword">void</span>(^)(<span class="keyword">int</span> removedCount, <span class="keyword">int</span> totalCount))progress</span><br><span class="line">                                 endBlock:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> error))end &#123;</span><br><span class="line">    [_memoryCache removeAllObjects];</span><br><span class="line">    [_diskCache removeAllObjectsWithProgressBlock:progress endBlock:end];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)description &#123;</span><br><span class="line">    <span class="keyword">if</span> (_name) <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"&lt;%@: %p&gt; (%@)"</span>, <span class="keyword">self</span>.class, <span class="keyword">self</span>, _name];</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"&lt;%@: %p&gt;"</span>, <span class="keyword">self</span>.class, <span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>æ•´ä½“æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ï¼ŒYYCache æ•´åˆäº†å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ï¼Œä¸»è¦åšäº†è¿™äº›äº‹ï¼š</p><ol><li>åˆå§‹åŒ–YYCacheå®ä¾‹ï¼Œè¦æ±‚ç¼“å­˜è·¯å¾„è¦åˆç†ã€‚</li><li>æŸ¥è¯¢ç¼“å­˜å¯¹è±¡å…ˆä»å†…å­˜ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†ä»ç£ç›˜ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚å½“ç£ç›˜ç¼“å­˜ä¸­æœ‰è€Œå†…å­˜ç¼“å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™ï¼ŒæŠŠå–å¾—çš„ç¼“å­˜å¯¹è±¡ä¿å­˜åœ¨å†…å­˜ç¼“å­˜ä¸­ã€‚</li><li>ç¼“å­˜å¯¹è±¡çš„å­˜å–å’Œç§»é™¤ï¼Œå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ä¸¤è€…ä¿æŒåŒæ­¥ã€‚</li></ol><h2 id="1-YYMemoryCache"><a href="#1-YYMemoryCache" class="headerlink" title="1.YYMemoryCache"></a>1.YYMemoryCache</h2><h3 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">@<span class="keyword">property</span><span class="title"> </span>(nullable, copy) NSString *name;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>(readonly) NSUInteger totalCount;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>(readonly) NSUInteger totalCost;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#pragma mark - Limit</span></span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>NSUInteger countLimit;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>NSUInteger costLimit;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>NSTimeInterval ageLimit;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>NSTimeInterval autoTrimInterval;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>BOOL shouldRemoveAllObjectsOnMemoryWarning;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>BOOL shouldRemoveAllObjectsWhenEnteringBackground;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>(nullable, copy) void(^didReceiveMemoryWarningBlock)(YYMemoryCache *cache);</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>(nullable, copy) void(^didEnterBackgroundBlock)(YYMemoryCache *cache);</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>BOOL releaseOnMainThread;</span><br><span class="line">@<span class="keyword">property</span><span class="title"> </span>BOOL releaseAsynchronously;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äºNSCacheï¼Œæä¾›åŒ…æ‹¬ç¼“å­˜æ•°é‡ã€ç¼“å­˜èŠ±è´¹ã€ç¼“å­˜æ—¶é—´çš„ç®¡ç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå½“æ¥æ”¶åˆ°å†…å­˜è­¦å‘Šæ—¶<code>(shouldRemoveAllObjectsOnMemoryWarning)</code>æˆ–è€… App è¿›å…¥åˆ°åå°æ—¶<code>(shouldRemoveAllObjectsWhenEnteringBackground)</code>å¯ä»¥é€‰æ‹©é‡Šæ”¾ç¼“å­˜å¯¹è±¡ã€‚è€Œå¯¹ç¼“å­˜å¯¹è±¡é‡Šæ”¾ä¹Ÿå¯ä»¥è¿›è¡Œæ§åˆ¶ï¼Œæ¯”å¦‚å¯ä»¥é€‰æ‹©åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾<code>(releaseOnMainThread)</code>æˆ–è€…å¼‚æ­¥é‡Šæ”¾<code>(releaseAsynchronously)</code>ã€‚</p><h3 id="å­˜å–æ¥å£"><a href="#å­˜å–æ¥å£" class="headerlink" title="å­˜å–æ¥å£"></a>å­˜å–æ¥å£</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="keyword">id</span>)key;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)objectForKey:(<span class="keyword">id</span>)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object forKey:(<span class="keyword">id</span>)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object forKey:(<span class="keyword">id</span>)key withCost:(<span class="built_in">NSUInteger</span>)cost;</span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="keyword">id</span>)key;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjects;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count;</span><br><span class="line">- (<span class="keyword">void</span>)trimToCost:(<span class="built_in">NSUInteger</span>)cost;</span><br><span class="line">- (<span class="keyword">void</span>)trimToAge:(<span class="built_in">NSTimeInterval</span>)age;</span><br></pre></td></tr></table></figure><p> é™¤äº†åŸºæœ¬çš„å­˜å–æ–¹æ³•ä¹‹å¤–ï¼ŒYYMemoryCache è¿˜æš´éœ²äº†ä¸‰ä¸ªç§»é™¤ç¼“å­˜å¯¹è±¡çš„æ–¹æ³•ã€‚<br> trimToCountï¼šæ ¹æ®é™åˆ¶çš„æ•°é‡(countLimit)è¿›è¡Œç§»é™¤ç¼“å­˜å¯¹è±¡æ“ä½œï¼Œç›´åˆ°æ»¡è¶³æ•°é‡é™åˆ¶è¦æ±‚ã€‚<br> trimToCostï¼šæ ¹æ®é™åˆ¶çš„èŠ±è´¹(costLimit)è¿›è¡Œç§»é™¤ç¼“å­˜å¯¹è±¡æ“ä½œï¼Œç›´åˆ°æ»¡è¶³èŠ±è´¹é™åˆ¶è¦æ±‚ã€‚<br> trimToAgeï¼šæ ¹æ®ç¼“å­˜å¯¹è±¡çš„è¿‡æœŸæ—¶é—´(ageLimit)è¿›è¡Œç§»é™¤ç¼“å­˜å¯¹è±¡æ“ä½œï¼Œç›´åˆ°æ»¡è¶³è¦æ±‚ã€‚</p><h3 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h3><p>åœ¨å…·ä½“å®ç°ä¸­ï¼Œä½œè€…è€ƒè™‘äº†ä»¥ä¸‹è¦æ±‚:</p><ol><li>ç¼“å­˜å¯¹è±¡çš„å­˜å–ã€‚è¦ä¿è¯æ•ˆç‡å°±è¦æ±‚å­˜å–æ—¶é—´å¤æ‚åº¦æœ€å¥½æ˜¯O(1)ã€‚</li><li>ç¼“å­˜å¯¹è±¡çš„ç§»é™¤ã€‚è¦ä¿è¯èƒ½æŒ‰ç…§ <code>costã€ageã€count</code> ç­‰æ¡ä»¶å¯¹æ‰€æœ‰ä¸ç¬¦åˆè¦æ±‚çš„å¯¹è±¡è¿›è¡Œç§»é™¤ã€‚</li><li>çº¿ç¨‹å®‰å…¨ã€‚éœ€è¦åŠ é”ã€‚<br>ç¬¬ä¸€æ¡ï¼šè¦æ±‚æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œé‚£å°±å¯ä»¥é‡‡ç”¨å“ˆå¸Œè¡¨ã€å­—å…¸ç­‰ã€‚ä½œè€…ä½¿ç”¨äº†å­—å…¸ï¼Œä¸”æ˜¯æ•ˆç‡æ›´é«˜çš„<code>CFMutableDictionaryRef</code>ã€‚<br>ç¬¬äºŒæ¡ï¼šè®°å½• <code>costã€ageã€count</code>ç­‰å±æ€§ï¼Œè‚¯å®šéœ€è¦å¯¹ç¼“å­˜å¯¹è±¡è¿›è¡ŒåŒ…è£…ã€‚å†è€…éœ€è¦è€ƒè™‘LRU(Least Recently Used)ï¼Œå°±éœ€è¦ä¿è¯é¡ºåºã€‚è€Œè¦ä½¿å¾—å­—å…¸ä¸­çš„å¯¹è±¡(value)æœ‰é¡ºåºï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæŒ‡å‘å…¶ä»–å¯¹è±¡çš„æŒ‡é’ˆ(å±æ€§ï¼‰ã€‚å¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨åŒ…è£…ç¼“å­˜å¯¹è±¡ã€‚<br>ç¬¬ä¸‰æ¡ï¼šå­˜å–çš„çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨GCDçº¿ç¨‹é”ã€‚</li></ol><h4 id="ç»“ç‚¹"><a href="#ç»“ç‚¹" class="headerlink" title="ç»“ç‚¹"></a>ç»“ç‚¹</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">@interface <span class="variable">_YYLinkedMapNode</span> : NSObject &#123;</span><br><span class="line">    @package</span><br><span class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_YYLinkedMapNode</span> *<span class="variable">_prev</span>; <span class="comment">// retained by dic</span></span><br><span class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_YYLinkedMapNode</span> *<span class="variable">_next</span>; <span class="comment">// retained by dic</span></span><br><span class="line">    id <span class="variable">_key</span>;</span><br><span class="line">    id <span class="variable">_value</span>;</span><br><span class="line">    NSUInteger <span class="variable">_cost</span>;</span><br><span class="line">    NSTimeInterval <span class="variable">_time</span>;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>é“¾è¡¨çš„ç»“ç‚¹ä¸­ä¿å­˜ç€key å’Œ valueï¼Œè¿™æ˜¯å¯¹ç¼“å­˜å¯¹è±¡çš„åŒ…è£…ã€‚_costå’Œ_timeè®°å½•ç€ç¼“å­˜å¯¹è±¡çš„èŠ±è´¹å’Œè¿‡æœŸæ—¶é—´ã€‚è€Œä½¿ç”¨<code>__unsafe_unretained</code>ä¿®é¥°çš„_prevå’Œ_nextåˆ™åˆ†åˆ«æŒ‡å‘å‰ä¸€ä¸ªå¯¹è±¡å’Œåä¸€ä¸ªå¯¹è±¡ã€‚ç”±äºè¿™äº›ç»“ç‚¹å·²ç»è¢«å­—å…¸æŒæœ‰äº†ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨<code>__unsafe_unretained</code>ä¿®é¥°ï¼Œä¸å¿…å†å¢åŠ å®ƒçš„å¼•ç”¨è®¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚è¿™ä¸€ç‚¹ä¸éšå¼å‚æ•°<code>self</code>å¾ˆåƒï¼Œ<code>self</code>å…¶å®ä¹Ÿæ˜¯ä½¿ç”¨<code>__unsafe_unretained</code>ä¿®é¥°çš„ã€‚</p><h4 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">@interface <span class="variable">_YYLinkedMap</span> : NSObject &#123;</span><br><span class="line">    @package</span><br><span class="line">    CFMutableDictionaryRef <span class="variable">_dic</span>; <span class="comment">// do not set object directly</span></span><br><span class="line">    NSUInteger <span class="variable">_totalCost</span>;</span><br><span class="line">    NSUInteger <span class="variable">_totalCount</span>;</span><br><span class="line">    <span class="variable">_YYLinkedMapNode</span> *<span class="variable">_head</span>; <span class="comment">// MRU, do not change it directly</span></span><br><span class="line">    <span class="variable">_YYLinkedMapNode</span> *<span class="variable">_tail</span>; <span class="comment">// LRU, do not change it directly</span></span><br><span class="line">    BOOL <span class="variable">_releaseOnMainThread</span>;</span><br><span class="line">    BOOL <span class="variable">_releaseAsynchronously</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)insertNodeAtHead:(<span class="variable">_YYLinkedMapNode</span> *)node;</span><br><span class="line">- (void)bringNodeToHead:(<span class="variable">_YYLinkedMapNode</span> *)node;</span><br><span class="line">- (void)removeNode:(<span class="variable">_YYLinkedMapNode</span> *)node;</span><br><span class="line">- (<span class="variable">_YYLinkedMapNode</span> *)removeTailNode;</span><br><span class="line">- (void)removeAll;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª <code>YYMemoryCache</code> å¯¹è±¡æœ‰ä¸€ä¸ªé“¾è¡¨ã€‚è¿™ä¸ªé“¾è¡¨ä½¿ç”¨<code>_dic</code>ä¿å­˜ç€æ‰€æœ‰åŒ…è£…å¥½çš„ç¼“å­˜å¯¹è±¡(<code>_YYLinkedMapNode</code>)ï¼Œè®°å½•ç€æ€»çš„èŠ±è´¹(<code>_totalCost</code>)å’Œæ€»çš„æ•°é‡(<code>_totalCount</code>)ã€‚å½“ç„¶ï¼Œè¿˜ä½¿ç”¨<code>_head</code>æŒ‡ç€é“¾è¡¨çš„å¤´æŒ‡é’ˆï¼Œä½¿ç”¨<code>_tail</code>æŒ‡ç€é“¾è¡¨çš„å°¾æŒ‡é’ˆã€‚<code>_releaseOnMainThread</code>å’Œ<code>_releaseAsynchronously</code>ç”¨äºè®¾ç½®å¯¹ç¼“å­˜å¯¹è±¡é‡Šæ”¾æ“ä½œçš„é€‰é¡¹:ä¸»çº¿ç¨‹é‡Šæ”¾æˆ–è€…å¼‚æ­¥é‡Šæ”¾ã€‚</p><p><code>_YYLinkedMap</code>æš´éœ²å‡ºçš„äº”ä¸ªæ–¹æ³•å¾ˆæ¸…æ™°åœ°è¡¨æ˜å®ƒçš„ä½œç”¨ï¼šæ¯æ¬¡å½“ç¼“å­˜å–åˆ°æŸä¸ªå¯¹è±¡æ—¶ï¼ŒæŠŠå®ƒç½®åœ¨å¤´ç»“ç‚¹çš„ä½ç½®ã€‚è¿™æ ·éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¾ˆè½»æ¾åœ°ä½¿å¾—é‚£äº›ä¸ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡å¤„åœ¨é“¾è¡¨çš„åç«¯ï¼Œç»å¸¸ä½¿ç”¨çš„å¯¹è±¡å¤„åœ¨é“¾è¡¨çš„å‰ç«¯ï¼Œè¿™æ ·å°±å®ç°äº† <code>LRU</code>ã€‚</p><h4 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h4><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">- (void)insertNodeAtHead:(_YYLinkedMapNode *)<span class="keyword">node</span> <span class="title">&#123;</span></span><br><span class="line"><span class="title">    CFDictionarySetValue</span>(_dic, (__bridge const void *)(<span class="keyword">node</span><span class="title">-&gt;_key</span>), (__bridge const void *)(<span class="keyword">node</span><span class="title">));</span></span><br><span class="line"><span class="title">    _totalCost</span> += <span class="keyword">node</span><span class="title">-&gt;_cost</span>;</span><br><span class="line">    _totalCount++;</span><br><span class="line">    if (_head) &#123;</span><br><span class="line">        <span class="keyword">node</span><span class="title">-&gt;_next</span> = _head;</span><br><span class="line">        _head-&gt;_prev = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        _head</span> = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">    &#125; else</span> &#123;</span><br><span class="line">        _head = _tail = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">    &#125;</span></span><br><span class="line"><span class="title">&#125;</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">- (void</span>)bringNodeToHead:(_YYLinkedMapNode *)<span class="keyword">node</span> <span class="title">&#123;</span></span><br><span class="line"><span class="title">    if</span> (_head == <span class="keyword">node</span><span class="title">) return</span>;</span><br><span class="line">    </span><br><span class="line">    if (_tail == <span class="keyword">node</span><span class="title">) &#123;</span></span><br><span class="line"><span class="title">        _tail</span> = <span class="keyword">node</span><span class="title">-&gt;_prev</span>;</span><br><span class="line">        _tail-&gt;_next = nil;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="keyword">node</span><span class="title">-&gt;_next-</span>&gt;_prev = <span class="keyword">node</span><span class="title">-&gt;_prev</span>;</span><br><span class="line">        <span class="keyword">node</span><span class="title">-&gt;_prev-</span>&gt;_next = <span class="keyword">node</span><span class="title">-&gt;_next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">node</span><span class="title">-&gt;_next</span> = _head;</span><br><span class="line">    <span class="keyword">node</span><span class="title">-&gt;_prev</span> = nil;</span><br><span class="line">    _head-&gt;_prev = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">    _head</span> = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">&#125;</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">- (void</span>)removeNode:(_YYLinkedMapNode *)<span class="keyword">node</span> <span class="title">&#123;</span></span><br><span class="line"><span class="title">    CFDictionaryRemoveValue</span>(_dic, (__bridge const void *)(<span class="keyword">node</span><span class="title">-&gt;_key</span>));</span><br><span class="line">    _totalCost -= <span class="keyword">node</span><span class="title">-&gt;_cost</span>;</span><br><span class="line">    _totalCount--;</span><br><span class="line">    if (<span class="keyword">node</span><span class="title">-&gt;_next</span>) <span class="keyword">node</span><span class="title">-&gt;_next-</span>&gt;_prev = <span class="keyword">node</span><span class="title">-&gt;_prev</span>;</span><br><span class="line">    if (<span class="keyword">node</span><span class="title">-&gt;_prev</span>) <span class="keyword">node</span><span class="title">-&gt;_prev-</span>&gt;_next = <span class="keyword">node</span><span class="title">-&gt;_next</span>;</span><br><span class="line">    if (_head == <span class="keyword">node</span><span class="title">) _head</span> = <span class="keyword">node</span><span class="title">-&gt;_next</span>;</span><br><span class="line">    if (_tail == <span class="keyword">node</span><span class="title">) _tail</span> = <span class="keyword">node</span><span class="title">-&gt;_prev</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (_YYLinkedMapNode *)removeTailNode &#123;</span><br><span class="line">    if (!_tail) return nil;</span><br><span class="line">    _YYLinkedMapNode *tail = _tail;</span><br><span class="line">    CFDictionaryRemoveValue(_dic, (__bridge const void *)(_tail-&gt;_key));</span><br><span class="line">    _totalCost -= _tail-&gt;_cost;</span><br><span class="line">    _totalCount--;</span><br><span class="line">    if (_head == _tail) &#123;</span><br><span class="line">        _head = _tail = nil;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        _tail = _tail-&gt;_prev;</span><br><span class="line">        _tail-&gt;_next = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return tail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç»“ç‚¹çš„æ’å…¥ã€ç§»é™¤ã€è°ƒæ•´ä½ç½®ï¼Œæ˜¯æ•°æ®ç»“æ„çš„åŸºç¡€æ“ä½œã€‚ä»¤äººæ€€å¿µï¼</p><p><code>_releaseOnMainThread</code>å’Œ<code>_releaseAsynchronously</code>è¿™ä¸¤ä¸ªé€‰é¡¹çš„å®ç°ä¹Ÿå¾ˆç®€å•ã€‚ä½œè€…è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—:</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> dispatch_queue_t <span class="title">YYMemoryCacheGetReleaseQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç§»é™¤çš„æ—¶å€™æœ‰æ‰€åˆ¤æ–­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">CFDictionaryGetCount</span>(_dic) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="built_in">CFMutableDictionaryRef</span> holder = _dic;</span><br><span class="line">   _dic = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> (_releaseAsynchronously) &#123;</span><br><span class="line">       <span class="built_in">dispatch_queue_t</span> queue = _releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">       <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">           <span class="built_in">CFRelease</span>(holder); <span class="comment">// hold and release in specified queue</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_releaseOnMainThread &amp;&amp; !pthread_main_np()) &#123;</span><br><span class="line">       <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">           <span class="built_in">CFRelease</span>(holder); <span class="comment">// hold and release in specified queue</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="built_in">CFRelease</span>(holder);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®çº¿ç¨‹ã€æ˜¯å¦å¼‚æ­¥å†³å®šå…·ä½“çš„é€»è¾‘ï¼ŒæŠŠreleaseæ“ä½œæ”¾åˆ°ç›¸åº”çº¿ç¨‹ä¸­ã€‚è¿™é‡Œä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡holderï¼Œå¾ˆæ˜¯å·§å¦™ã€‚</p><h3 id="æ ¸å¿ƒæ“ä½œ"><a href="#æ ¸å¿ƒæ“ä½œ" class="headerlink" title="æ ¸å¿ƒæ“ä½œ"></a>æ ¸å¿ƒæ“ä½œ</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">@implementation YYMemoryCache &#123;</span><br><span class="line">    pthread_mutex_t _lock<span class="comment">;</span></span><br><span class="line">    _YYLinkedMap *_lru<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dispatch_queue_t </span>_queue<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º<code>YYMemoryCache</code>ä½¿ç”¨<code>pthread_mutex_t</code>ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><p>æœ€å…³é”®çš„è¿˜æ˜¯å¯¹æ— æ•ˆç¼“å­˜å¯¹è±¡çš„é‡Šæ”¾ï¼Œä»¥ <code>count</code> ä¸ºä¾‹ï¼Œå½“ç¼“å­˜çš„å¯¹è±¡æ•°é‡è¶…è¿‡äº† <code>count</code> é™åˆ¶ï¼Œå°±éœ€è¦å¯¹é“¾è¡¨åç«¯ä¸å¸¸ä½¿ç”¨çš„ç¼“å­˜å¯¹è±¡è¿›è¡Œç§»é™¤æ“ä½œï¼Œç›´åˆ°æ»¡è¶³ <code>count</code> é™åˆ¶ã€‚</p><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)<span class="variable">_trimToCount</span>:(NSUInteger)countLimit &#123;</span><br><span class="line">    BOOL finish = NO;</span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="keyword">if</span> (countLimit == <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="variable">_lru</span> removeAll];</span><br><span class="line">        finish = YES;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCount</span> &lt;= countLimit) &#123;</span><br><span class="line">        finish = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="keyword">if</span> (finish) return;</span><br><span class="line">    </span><br><span class="line">    NSMutableArray *holder = [NSMutableArray new];</span><br><span class="line">    <span class="keyword">while</span> (!finish) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_trylock(&amp;<span class="variable">_lock</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCount</span> &gt; countLimit) &#123;</span><br><span class="line">                <span class="variable">_YYLinkedMapNode</span> *node = [<span class="variable">_lru</span> removeTailNode];</span><br><span class="line">                <span class="keyword">if</span> (node) [holder addObject:node];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                finish = YES;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            usleep(<span class="number">10</span> * <span class="number">1000</span>); <span class="comment">//10 ms</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (holder.<span class="built_in">count</span>) &#123;</span><br><span class="line">        dispatch_queue_t queue = <span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">        dispatch_async(queue, ^&#123;</span><br><span class="line">            [holder <span class="built_in">count</span>]; <span class="comment">// release in queue</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼Ÿ</p><ol><li>ä½¿ç”¨<code>pthread_mutex_lock(&amp;_lock);pthread_mutex_unlock(&amp;_lock);</code>å¯¹æ“ä½œåŠ é”è§£é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li><li>å¯¹å‚æ•° countLimit åˆ¤æ–­ï¼š<br>å¦‚æœcountLimitä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼“å­˜æ•°é‡é™åˆ¶ä¸º0ï¼Œé‚£ç§»é™¤æ‰€æœ‰ç¼“å­˜å¯¹è±¡å°±æ˜¯äº†ã€‚å¦‚æœå½“å‰æ‰€ç¼“å­˜çš„å¯¹è±¡æ•°é‡å°äºcountLimitï¼Œé‚£è¯´æ˜æ»¡è¶³æ•°é‡é™åˆ¶è¦æ±‚ï¼Œå°±ä¸éœ€è¦ç§»é™¤æ“ä½œäº†ã€‚</li><li>ä½œè€…åˆ›å»ºä¸€ä¸ªå¯å˜å­—å…¸holderï¼Œå½“ä¸æ»¡è¶³countLimité™åˆ¶è¦æ±‚çš„æ—¶å€™ï¼Œå¯¹é“¾è¡¨å°¾ç»“ç‚¹è¿›è¡Œç§»é™¤æ“ä½œï¼Œå¹¶æŠŠè¿™ä¸ªå°¾ç»“ç‚¹æ·»åŠ åˆ°holderä¸­æŒæœ‰ã€‚å½“ç„¶ï¼Œè¿™é‡Œæœ‰åŠ é”æ“ä½œã€‚è¿™ä¸ª while å¾ªç¯ç»“æŸï¼Œæ‰€æœ‰å¤šä½™çš„ç¼“å­˜å¯¹è±¡å°±åœ¨holderä¸­äº†ã€‚<br>4.å¯¹holderä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œ release æ“ä½œã€‚<br>å…¶ä»–çš„å¦‚:</li></ol><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(void)</span>_trimToAge:<span class="params">(NSTimeInterval)</span>ageLimit; </span><br><span class="line">- <span class="params">(void)</span>_trimToCost:<span class="params">(NSUInteger)</span>costLimit</span><br></pre></td></tr></table></figure><p>æ“ä½œåŒç†ã€‚</p><h3 id="å†…å­˜è­¦å‘Š"><a href="#å†…å­˜è­¦å‘Š" class="headerlink" title="å†…å­˜è­¦å‘Š"></a>å†…å­˜è­¦å‘Š</h3><p>å†…å­˜è­¦å‘Šè¯­ App è¿›å…¥åå°æ—¶é‡Šæ”¾ç¼“å­˜å¯¹è±¡çš„æ“ä½œï¼Œä½œè€…æ¥å—äº†ç³»ç»Ÿé€šçŸ¥ï¼Œç›´æ¥å¤„ç†å³å¯ã€‚</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[[NSNotificationCenter defaultCenter]</span> <span class="selector-tag">addObserver</span><span class="selector-pseudo">:self</span> <span class="selector-tag">selector</span>:@<span class="keyword">selector</span>(<span class="keyword">_appDidReceiveMemoryWarningNotification</span>) name:UIApplicationDidReceiveMemoryWarningNotification object:nil];</span><br><span class="line"><span class="selector-attr">[[NSNotificationCenter defaultCenter]</span> <span class="selector-tag">addObserver</span><span class="selector-pseudo">:self</span> <span class="selector-tag">selector</span>:@<span class="keyword">selector</span>(<span class="keyword">_appDidEnterBackgroundNotification</span>) name:UIApplicationDidEnterBackgroundNotification object:nil];</span><br></pre></td></tr></table></figure><h3 id="å­˜å–å®ç°"><a href="#å­˜å–å®ç°" class="headerlink" title="å­˜å–å®ç°"></a>å­˜å–å®ç°</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    <span class="built_in">BOOL</span> contains = <span class="built_in">CFDictionaryContainsKey</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">    <span class="keyword">return</span> contains;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectForKey:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    _YYLinkedMapNode *node = <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        node-&gt;_time = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">        [_lru bringNodeToHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">    <span class="keyword">return</span> node ? node-&gt;_value : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>)object forKey:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">    [<span class="keyword">self</span> setObject:object forKey:key withCost:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç¼“å­˜å¯¹è±¡çš„è¯»å–è‡ªç„¶æ˜¯æ ¹æ® key è¯»å–åˆ°å­—å…¸ä¸­å¯¹åº”çš„ valueï¼Œè¿™ä¸ª value æ˜¯ä¸ªç»“ç‚¹(<code>_YYLinkedMapNode</code>)ï¼Œå†å–å‡ºè¿™ä¸ªç»“ç‚¹çš„value å±æ€§ï¼Œä¾¿æ˜¯æœ€åŸå§‹çš„ç¼“å­˜å¯¹è±¡äº†:<code>node-&gt;_value</code>ã€‚</p><h2 id="2-å…³é”®ç‚¹"><a href="#2-å…³é”®ç‚¹" class="headerlink" title="2.å…³é”®ç‚¹"></a>2.å…³é”®ç‚¹</h2><p>1.å­—å…¸CFMutableDictionaryRefçš„ä½¿ç”¨</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">å£°æ˜: <span class="built_in">CFMutableDictionaryRef</span> _dic;</span><br><span class="line">åˆ›å»º: _dic = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">è®¾å€¼: <span class="built_in">CFDictionarySetValue</span>(_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(node-&gt;_key), (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(node));</span><br><span class="line">å–å€¼: <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">ç§»é™¤: <span class="built_in">CFDictionaryRemoveValue</span>(_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(node-&gt;_key));</span><br><span class="line">è·å–æ•°é‡: <span class="built_in">CFDictionaryGetCount</span>(_dic);</span><br><span class="line">æ˜¯å¦å­˜åœ¨: <span class="built_in">CFDictionaryContainsKey</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">é‡Šæ”¾: <span class="built_in">CFRelease</span>(_dic);</span><br></pre></td></tr></table></figure><p>2.å®¹å™¨ä¸­å¯¹è±¡é”€æ¯æ§åˆ¶</p><blockquote><p>â€œå¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»â€¦â€</p></blockquote><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ åœ¨å­çº¿ç¨‹é‡Šæ”¾</span></span><br><span class="line">&#123; </span><br><span class="line">   <span class="built_in">NSArray</span> *holder = tmp;</span><br><span class="line">   tmp = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">   <span class="keyword">if</span> (holder.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">           [holder count];</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ åœ¨å­çº¿ç¨‹é‡Šæ”¾</span></span><br><span class="line">&#123; </span><br><span class="line">   <span class="keyword">id</span> obj = tmp[<span class="number">2</span>];</span><br><span class="line">   <span class="built_in">NSMutableArray</span> *holder = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">   [holder addObject:obj];</span><br><span class="line">   [tmp removeObject:obj];</span><br><span class="line">   <span class="keyword">if</span> (holder.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">           [holder count];</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.çº¿ç¨‹å®‰å…¨çš„å®ç°</p><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å–å€¼çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">&#123;  </span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    BOOL releaseAsynchronously = <span class="variable">_lru</span>-&gt;<span class="variable">_releaseAsynchronously</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    return releaseAsynchronously;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å€¼çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">&#123; </span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="variable">_lru</span>-&gt;<span class="variable">_releaseAsynchronously</span> = releaseAsynchronously;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.<code>pthread_mutex_lock</code>ä½¿ç”¨</p><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">å£°æ˜é”: pthread_mutex_t <span class="variable">_lock</span>;</span><br><span class="line">åˆ›å»ºé”: pthread_mutex_init(&amp;<span class="variable">_lock</span>, NULL);</span><br><span class="line">åŠ é”: pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">è§£é”: pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">å°è¯•åŠ é”:</span><br><span class="line"><span class="keyword">if</span> (pthread_mutex_trylock(&amp;<span class="variable">_lock</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    usleep(<span class="number">10</span> * <span class="number">1000</span>); <span class="comment">//10 ms</span></span><br><span class="line">&#125;</span><br><span class="line">é”€æ¯é”: pthread_mutex_destroy(&amp;<span class="variable">_lock</span>);</span><br></pre></td></tr></table></figure><p>5.if-else å•å¥</p><figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (_name) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure><h2 id="3-YYDiskCache"><a href="#3-YYDiskCache" class="headerlink" title="3.YYDiskCache"></a>3.YYDiskCache</h2><p>YYDiskCacheä¸»è¦è°ƒç”¨äº†YYKVStorageçš„æ¥å£ï¼Œå¹¶æä¾›å¯¹å¤– APIã€‚</p><h4 id="äº”ä¸ªå‡½æ•°"><a href="#äº”ä¸ªå‡½æ•°" class="headerlink" title="äº”ä¸ªå‡½æ•°"></a>äº”ä¸ªå‡½æ•°</h4><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">/// <span class="type">Free</span> disk space <span class="keyword">in</span> bytes.</span><br><span class="line"><span class="keyword">static</span> int64_t _YYDiskSpaceFree() &#123;</span><br><span class="line">    <span class="type">NSError</span> *error = <span class="keyword">nil</span>;</span><br><span class="line">    <span class="type">NSDictionary</span> *attrs = [[<span class="type">NSFileManager</span> defaultManager] attributesOfFileSystemForPath:<span class="type">NSHomeDirectory</span>() error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    int64_t space =  [[attrs objectForKey:<span class="type">NSFileSystemFreeSize</span>] longLongValue];</span><br><span class="line">    <span class="keyword">if</span> (space &lt; <span class="number">0</span>) space = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> space;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// <span class="type">String</span>'s md5 hash.</span><br><span class="line"><span class="keyword">static</span> <span class="type">NSString</span> *_YYNSStringMD5(<span class="type">NSString</span> *<span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">string</span>) <span class="keyword">return</span> <span class="keyword">nil</span>;</span><br><span class="line">    <span class="type">NSData</span> *data = [<span class="built_in">string</span> dataUsingEncoding:<span class="type">NSUTF8StringEncoding</span>];</span><br><span class="line">    unsigned <span class="built_in">char</span> <span class="literal">result</span>[<span class="type">CC_MD5_DIGEST_LENGTH</span>];</span><br><span class="line">    <span class="type">CC_MD5</span>(data.bytes, (<span class="type">CC_LONG</span>)data.length, <span class="literal">result</span>);</span><br><span class="line">    <span class="keyword">return</span> [<span class="type">NSString</span> stringWithFormat:</span><br><span class="line">                @<span class="string">"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"</span>,</span><br><span class="line">                <span class="literal">result</span>[<span class="number">0</span>],  <span class="literal">result</span>[<span class="number">1</span>],  <span class="literal">result</span>[<span class="number">2</span>],  <span class="literal">result</span>[<span class="number">3</span>],</span><br><span class="line">                <span class="literal">result</span>[<span class="number">4</span>],  <span class="literal">result</span>[<span class="number">5</span>],  <span class="literal">result</span>[<span class="number">6</span>],  <span class="literal">result</span>[<span class="number">7</span>],</span><br><span class="line">                <span class="literal">result</span>[<span class="number">8</span>],  <span class="literal">result</span>[<span class="number">9</span>],  <span class="literal">result</span>[<span class="number">10</span>], <span class="literal">result</span>[<span class="number">11</span>],</span><br><span class="line">                <span class="literal">result</span>[<span class="number">12</span>], <span class="literal">result</span>[<span class="number">13</span>], <span class="literal">result</span>[<span class="number">14</span>], <span class="literal">result</span>[<span class="number">15</span>]</span><br><span class="line">            ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">void</span> _YYDiskCacheInitGlobal() &#123;</span><br><span class="line">    <span class="keyword">static</span> dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        _globalInstancesLock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">        _globalInstances = [[<span class="type">NSMapTable</span> alloc] initWithKeyOptions:<span class="type">NSPointerFunctionsStrongMemory</span> valueOptions:<span class="type">NSPointerFunctionsWeakMemory</span> capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">YYDiskCache</span> *_YYDiskCacheGetGlobal(<span class="type">NSString</span> *path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">nil</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    dispatch_semaphore_wait(_globalInstancesLock, <span class="type">DISPATCH_TIME_FOREVER</span>);</span><br><span class="line">    id cache = [_globalInstances objectForKey:path];</span><br><span class="line">    dispatch_semaphore_signal(_globalInstancesLock);</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">void</span> _YYDiskCacheSetGlobal(<span class="type">YYDiskCache</span> *cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.path.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    dispatch_semaphore_wait(_globalInstancesLock, <span class="type">DISPATCH_TIME_FOREVER</span>);</span><br><span class="line">    [_globalInstances setObject:cache forKey:cache.path];</span><br><span class="line">    dispatch_semaphore_signal(_globalInstancesLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_YYDiskSpaceFree()</code>æä¾›å‰©ä½™ç£ç›˜ç©ºé—´çš„æŸ¥è¯¢ã€‚<br><code>_YYNSStringMD5(NSString *string)</code>æä¾›å­—ç¬¦ä¸²è½¬ md5ã€‚</p><p><code>_YYDiskCacheInitGlobal()</code>ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªå¼º-å¼±çš„<code>NSMapTable</code>ï¼Œä¿å­˜<code>YYDiskCache</code>å¯¹è±¡ã€‚<br><code>_YYDiskCacheGetGlobal(NSString *path)</code>ç”¨äºæ ¹æ®è·¯å¾„ path è·å–å¯¹åº”çš„<code>YYDiskCache</code>å¯¹è±¡ã€‚<br><code>_YYDiskCacheSetGlobal(YYDiskCache *cache)</code>ç”¨äºæ ¹æ®è·¯å¾„ path åœ¨<code>NSMapTable</code>ä¿å­˜ä¸€ä¸ª<code>YYDiskCache</code>å¯¹è±¡ã€‚</p><h4 id="ä¸»è¦å®ç°"><a href="#ä¸»è¦å®ç°" class="headerlink" title="ä¸»è¦å®ç°"></a>ä¸»è¦å®ç°</h4><p>YYDiskCacheçš„åŠŸèƒ½æ¯”å¦‚ç§»é™¤è¿‡æœŸçš„å¯¹è±¡ã€ç§»é™¤è¶…è¿‡æ•°é‡é™åˆ¶çš„å¯¹è±¡ç­‰ï¼Œä¸»è¦é€šè¿‡YYKVStorageå®ç°ã€‚<br>ä½œè€…æŠŠä¿å­˜ç±»å‹åˆ†ä¸ºä¸‰ç§ï¼š</p><figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">typedef <span class="type">NS_ENUM</span>(<span class="type">NSUInteger</span>, <span class="type">YYKVStorageType</span>) &#123;</span><br><span class="line">    /// file system.</span><br><span class="line">    <span class="type">YYKVStorageTypeFile</span> = 0,</span><br><span class="line">    ///  in sqlite.</span><br><span class="line">    <span class="type">YYKVStorageTypeSQLite</span> = 1,</span><br><span class="line">    ///  based on your choice.</span><br><span class="line">    <span class="type">YYKVStorageTypeMixed</span> = 2,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½œè€…æŒ‡æ˜äº†åŸå› ï¼šTypically, write data to sqlite is faster than extern file, but<br> reading performance is dependent on data size. In my test (on iPhone 6 64G),<br> read data from extern file is faster than from sqlite when the data is larger<br> than 20KB.</p><ul><li>If you want to store large number of small datas (such as contacts cache),<br>use YYKVStorageTypeSQLite to get better performance.</li><li>If you want to store large files (such as image cache),<br>use YYKVStorageTypeFile to get better performance.</li><li><p>You can use YYKVStorageTypeMixed and choice your storage type for each item.</p><p>20kb ä»¥ä¸‹çš„æŒä¹…åŒ–ï¼Œæ”¾åˆ°æ–‡ä»¶ä¸­ã€‚ 20kb ä»¥ä¸Šçš„æŒä¹…åŒ–ï¼Œæ”¾åˆ°æ•°æ®åº“sqliteä¸­ã€‚ä¹Ÿå¯ä»¥é€‰æ‹©æ··åˆå­˜å‚¨ã€‚</p></li></ul><h3 id="4-YYKVStorage"><a href="#4-YYKVStorage" class="headerlink" title="4.YYKVStorage"></a>4.YYKVStorage</h3><p>YYKVStorageæ²¡æœ‰é˜…è¯»ã€‚ä¹ä¸€çœ‹æ˜¯è®¸å¤šçç¢çš„ SQL æ“ä½œå’Œæ–‡ä»¶æ“ä½œï¼Œæ²¡æœ‰çº³å…¥é˜…è¯»è®¡åˆ’ã€‚</p><h1 id="ä¸‰ã€å°ç»“"><a href="#ä¸‰ã€å°ç»“" class="headerlink" title="ä¸‰ã€å°ç»“"></a>ä¸‰ã€å°ç»“</h1><p>YYCacheå±äºå°å®¶ç¢§ç‰å‹çš„å¼€æºä½œå“ï¼Œä»£ç é‡ä¸æ˜¯å¾ˆå¤šï¼Œä½†æ˜¯å¾ˆç²¾ç¾ã€‚LRUé…åˆåŒå‘é“¾è¡¨ä¹Ÿæ˜¯å¾ˆç»å…¸çš„ç®—æ³•é¢˜ã€‚æˆ‘è§‰å¾—æœ€å¥½ç©çš„æ˜¯å®¹å™¨å…ƒç´ çš„å¼‚æ­¥é‡Šæ”¾é€»è¾‘ï¼Œä»¥å‰ç¡®å®æ²¡è§è¿‡è¿™ç§å†™æ³•ï¼Œä½œè€…ä¹Ÿç»™å‡ºäº†è§£é‡Šï¼Œå¾ˆå€¼å¾—å­¦ä¹ å€Ÿé‰´ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å…³äºYYCacheçš„ç®€å•æ€»ç»“ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ã€ŒYYModelã€</title>
    <link href="http://blog.chenyalun.com/2018/12/20/%E8%AF%BB%E3%80%8CYYModel%E3%80%8D/"/>
    <id>http://blog.chenyalun.com/2018/12/20/è¯»ã€ŒYYModelã€/</id>
    <published>2018-12-20T11:32:33.000Z</published>
    <updated>2019-03-29T03:01:31.589Z</updated>
    
    <content type="html"><![CDATA[<p></p><p align="center"> å…³äºYYModelçš„ç®€å•æ€»ç»“ã€‚ </p><br><a id="more"></a><p></p><p>å°è¯•é˜…è¯»YYModelæºç ï¼Œå‘ç°æœ‰ä¸€äº›ç»†èŠ‚å¹¶ä¸èƒ½ååˆ†é€å½»åœ°ç†è§£æ¸…æ¥šï¼Œåªèƒ½ç•¥å¾®çª¥æ¢åˆ°å…¶ä¸­ä¸»è¦åŸç†ã€‚è¿™é‡Œå°±å½“åšç¬¬ä¸€éé˜…è¯»ç¬”è®°ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">YYModel</span>)</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)yy_modelWithJSON:(<span class="keyword">id</span>)json;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)yy_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dictionary;</span><br><span class="line">- (<span class="built_in">BOOL</span>)yy_modelSetWithJSON:(<span class="keyword">id</span>)json;</span><br><span class="line">- (<span class="built_in">BOOL</span>)yy_modelSetWithDictionary:(<span class="built_in">NSDictionary</span> *)dic;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)yy_modelToJSONObject;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)yy_modelToJSONData;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)yy_modelToJSONString;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)yy_modelCopy;</span><br><span class="line">- (<span class="keyword">void</span>)yy_modelEncodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder;</span><br><span class="line">- (<span class="keyword">id</span>)yy_modelInitWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder;</span><br><span class="line">- (<span class="built_in">NSUInteger</span>)yy_modelHash;</span><br><span class="line">- (<span class="built_in">BOOL</span>)yy_modelIsEqual:(<span class="keyword">id</span>)model;</span><br><span class="line">- (<span class="built_in">NSString</span> *)yy_modelDescription;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span> (<span class="title">YYModel</span>)</span></span><br><span class="line"><span class="comment">// jsonåˆ°æ¨¡å‹æ•°ç»„</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSArray</span> *)yy_modelArrayWithClass:(Class)cls json:(<span class="keyword">id</span>)json;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSDictionary</span> (<span class="title">YYModel</span>)</span></span><br><span class="line"><span class="comment">// jsonåˆ°å­—å…¸</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)yy_modelDictionaryWithClass:(Class)cls json:(<span class="keyword">id</span>)json;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">YYModel</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ¨¡å‹å±æ€§ä¸json's keyçš„æ˜ å°„</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)modelCustomPropertyMapper;</span><br><span class="line">+ (<span class="built_in">NSDictionary</span> *)modelCustomPropertyMapper &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123; <span class="string">@"name"</span> : <span class="string">@"n"</span>,</span><br><span class="line">              <span class="string">@"count"</span> : <span class="string">@"ext.c"</span>,</span><br><span class="line">              <span class="string">@"desc1"</span> : <span class="string">@"ext.d"</span>,</span><br><span class="line">              <span class="string">@"desc4"</span> : <span class="string">@".ext"</span>,</span><br><span class="line">              <span class="string">@"modelID"</span> : @[<span class="string">@"ID"</span>, <span class="string">@"Id"</span>, <span class="string">@"id"</span>, <span class="string">@"ext.id"</span>]&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é»‘åå•, è‹¥å®ç°è¯¥æ–¹æ³•, é»‘åå•ä¹‹å†…çš„keyå‡ä¸ä½œå¤„ç†</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)modelPropertyBlacklist;</span><br><span class="line">+ (<span class="built_in">NSArray</span> *)modelPropertyBlacklist &#123;</span><br><span class="line">    <span class="keyword">return</span> @[<span class="string">@"name"</span>, <span class="string">@"age"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™½åå•, è‹¥å®ç°è¯¥æ–¹æ³•, ç™½åå•ä¹‹å¤–çš„keyå‡ä¸ä½œå¤„ç†</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)modelPropertyWhitelist;</span><br><span class="line">+ (<span class="built_in">NSArray</span> *)modelPropertyWhitelist &#123;</span><br><span class="line">    <span class="keyword">return</span> @[<span class="string">@"name"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.è¦åœ¨JSONè½¬Modelçš„è¿‡ç¨‹ä¸­æ ¹æ®æƒ…å†µåˆ›å»ºä¸åŒç±»å‹çš„å®ä¾‹</span></span><br><span class="line">+ (<span class="keyword">nullable</span> Class)modelCustomClassForDictionary:(<span class="built_in">NSDictionary</span> *)dictionary;</span><br><span class="line">+ (Class)modelCustomClassForDictionary:(<span class="built_in">NSDictionary</span>*)dictionary &#123;</span><br><span class="line">    <span class="keyword">if</span> (dictionary[<span class="string">@"localName"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [YYLocalUser <span class="keyword">class</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dictionary[<span class="string">@"remoteName"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [YYRemoteUser <span class="keyword">class</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [YYBaseUser <span class="keyword">class</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.è¯¥æ–¹æ³•å‘ç”Ÿåœ¨å­—å…¸è½¬æ¨¡å‹ä¹‹å‰, æœ€åå¯¹å­—å…¸åšä¸€æ¬¡å¤„ç†</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)modelCustomWillTransformFromDictionary:(<span class="built_in">NSDictionary</span> *)dic;</span><br><span class="line"><span class="comment">//- (NSDictionary *)modelCustomWillTransformFromDictionary:(NSDictionary *)dic&#123;</span></span><br><span class="line">    <span class="keyword">if</span> ([dic[<span class="string">@"sex"</span>] isEqualToString:<span class="string">@"Man"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.JSONè½¬ä¸ºModelå, è¿›è¡Œæ•°æ®æ ¡éªŒ</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)modelCustomTransformFromDictionary:(<span class="built_in">NSDictionary</span> *)dic;</span><br><span class="line">- (<span class="built_in">BOOL</span>)modelCustomTransformFromDictionary:(<span class="built_in">NSDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="built_in">NSNumber</span> *timestamp = dic[<span class="string">@"timestamp"</span>];</span><br><span class="line">    <span class="keyword">if</span> (![timestamp isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    _createdAt = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:timestamp.floatValue];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å‹å®¹å™¨å±æ€§ä¸­çš„æ‰€éœ€è¦å­˜æ”¾çš„æ•°æ®ç±»å‹</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)modelContainerPropertyGenericClass;</span><br><span class="line">+ (<span class="built_in">NSDictionary</span> *)modelContainerPropertyGenericClass &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123;<span class="string">@"shadows"</span> : [Shadow <span class="keyword">class</span>],</span><br><span class="line">             <span class="string">@"borders"</span> : Border.class,</span><br><span class="line">             <span class="string">@"attachments"</span> : <span class="string">@"Attachment"</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Modelè½¬ä¸ºJSONå, è¿›è¡Œæ•°æ®æ ¡éªŒ</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)modelCustomTransformToDictionary:(<span class="built_in">NSMutableDictionary</span> *)dic;</span><br><span class="line">- (<span class="built_in">BOOL</span>)modelCustomTransformToDictionary:(<span class="built_in">NSMutableDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_createdAt) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    dic[<span class="string">@"timestamp"</span>] = @(_createdAt.timeIntervalSince1970);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°1: æ ¹æ®classä¿¡æ¯è·å–å…¶å¯¹åº”çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> force_inline YYEncodingNSType YYClassGetNSType(Class cls) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> YYEncodingTypeNSUnknown;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSMutableString;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSString;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDecimalNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSDecimalNumber;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSNumber;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSValue</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSValue;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableData</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSMutableData;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSData;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDate</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSDate;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSURL;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSMutableArray;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSArray;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSMutableDictionary;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSDictionary;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableSet</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSMutableSet;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> YYEncodingTypeNSSet;</span><br><span class="line">    <span class="keyword">return</span> YYEncodingTypeNSUnknown;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°2: åˆ¤æ–­YYEncodingTypeæ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°å­—(æ•´å½¢\é•¿æ•´å‹\æµ®ç‚¹å‹ç­‰)</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">BOOL</span> YYEncodingTypeIsCNumber(YYEncodingType type) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeBool:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt8:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeUInt8:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt16:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeUInt16:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt32:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeUInt32:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt64:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeUInt64:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeFloat:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeDouble:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeLongDouble: <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°3: æ ¹æ®ä¸€ä¸ªidç±»å‹çš„å¯¹è±¡åˆ›å»ºä¸€ä¸ªNSNumberç±»å‹çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSNumber</span> *YYNSNumberCreateFromID(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSCharacterSet</span> *dot;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSDictionary</span> *dic;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        dot = [<span class="built_in">NSCharacterSet</span> characterSetWithRange:<span class="built_in">NSMakeRange</span>(<span class="string">'.'</span>, <span class="number">1</span>)];</span><br><span class="line">        dic = @&#123;<span class="string">@"TRUE"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"True"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"true"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"FALSE"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"False"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"false"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"YES"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"Yes"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"yes"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"NO"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"No"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"no"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"NIL"</span> :    (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"Nil"</span> :    (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"nil"</span> :    (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"NULL"</span> :   (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"Null"</span> :   (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"null"</span> :   (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"(NULL)"</span> : (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"(Null)"</span> : (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"(null)"</span> : (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"&lt;NULL&gt;"</span> : (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"&lt;Null&gt;"</span> : (<span class="keyword">id</span>)kCFNull,</span><br><span class="line">                <span class="string">@"&lt;null&gt;"</span> : (<span class="keyword">id</span>)kCFNull&#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// kCFNullå•ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (!value || value == (<span class="keyword">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// NSNumberç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> value;</span><br><span class="line">    <span class="comment">// NSString, å–å‡ºdicä¸­å¯¹åº”çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSNumber</span> *num = dic[value];</span><br><span class="line">        <span class="keyword">if</span> (num) &#123;</span><br><span class="line">            <span class="keyword">if</span> (num == (<span class="keyword">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿™ä¸ªå­—ç¬¦ä¸²ä¸­å«æœ‰ ".", ä¾‹å¦‚ @"12.344"</span></span><br><span class="line">        <span class="keyword">if</span> ([(<span class="built_in">NSString</span> *)value rangeOfCharacterFromSet:dot].location != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cstring = ((<span class="built_in">NSString</span> *)value).UTF8String;</span><br><span class="line">            <span class="keyword">if</span> (!cstring) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">double</span> num = atof(cstring);</span><br><span class="line">            <span class="comment">// isfinite()æµ‹è¯•æŸä¸ªæµ®ç‚¹æ•°æ˜¯ä¸æ˜¯æœ‰é™çš„æ•°</span></span><br><span class="line">            <span class="comment">// isinf()æµ‹è¯•æŸä¸ªæµ®ç‚¹æ•°æ˜¯å¦æ˜¯æ— é™å¤§</span></span><br><span class="line">            <span class="comment">// isnan()æµ‹è¯•æŸä¸ªæµ®ç‚¹æ•°æ˜¯å¦æ˜¯ éæ•°å­—</span></span><br><span class="line">            <span class="keyword">if</span> (isnan(num) || isinf(num)) <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">// numæ˜¯å¦æ˜¯æ— é™å¤§æˆ–è€…æ˜¯å¦æ˜¯éæ•°å­—</span></span><br><span class="line">            <span class="keyword">return</span> @(num); <span class="comment">// return @(12.344);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å­—ç¬¦ä¸²ä¸­æ²¡æœ‰".", ä¾‹å¦‚ @"1323"</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cstring = ((<span class="built_in">NSString</span> *)value).UTF8String;<span class="comment">// è½¬åŒ–ä¸ºCå­—ç¬¦ä¸²"1323"</span></span><br><span class="line">            <span class="keyword">if</span> (!cstring) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// atoiå‡½æ•°ï¼šå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºintç±»å‹å˜é‡. atolå‡½æ•°ï¼šå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºlongç±»å‹å˜é‡.</span></span><br><span class="line">            <span class="comment">// atollå‡½æ•°ï¼šå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºlong longç±»å‹å˜é‡.atofå‡½æ•°ï¼šå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºdoubleç±»å‹å˜é‡</span></span><br><span class="line">            <span class="keyword">return</span> @(atoll(cstring)); <span class="comment">// è½¬æ¢ä¸ºlong longç±»å‹å˜é‡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°4: å°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ—¥æœŸNSDate</span></span><br><span class="line"><span class="comment">// æ ¹æ®stringçš„lengthåˆ¤æ–­éœ€è¦è°ƒç”¨å“ªä¸€ä¸ªblock, ä¸ºäº†é¿å…æ•ˆç‡è¾ƒä½çš„if-else, é‡‡ç”¨blockæ•°ç»„çš„å½¢å¼, stringçš„lengthæ­£å¥½å¯¹åº”blocksæ•°ç»„çš„ç´¢å¼•, å³æŸ¥è¡¨æ³•, æ•ˆç‡å¾—åˆ°æå‡.</span></span><br><span class="line"><span class="comment">// YYNSDateParseBlock parser = blocks[string.length];</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSDate</span> *YYNSDateFromString(__<span class="keyword">unsafe_unretained</span> <span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">NSDate</span>* (^YYNSDateParseBlock)(<span class="built_in">NSString</span> *string);</span><br><span class="line">    <span class="meta">#define kParserNum 34</span></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªblockæ•°ç»„, æ•°ç»„æ˜¯Cæ•°ç»„</span></span><br><span class="line">    <span class="keyword">static</span> YYNSDateParseBlock blocks[kParserNum + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             2014-01-20  // Google , 10ä¸ªå­—ç¬¦, å¯¹åº”blocks[10]</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"yyyy-MM-dd"</span>;</span><br><span class="line">            blocks[<span class="number">10</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             2014-01-20 12:24:48 // 19ä¸ªå­—ç¬¦, å¯¹åº”blocks[19]</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48   // Google, 19ä¸ªå­—ç¬¦, å¯¹åº”blocks[19]</span></span><br><span class="line"><span class="comment">             2014-01-20 12:24:48.000 // 23ä¸ªå­—ç¬¦, å¯¹åº”blocks[23]</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48.000 // 23ä¸ªå­—ç¬¦, å¯¹åº”blocks[23]</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter1 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter1.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter1.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter1.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss"</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter3 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter3.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter3.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter3.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss.SSS"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter4 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter4.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter4.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter4.dateFormat = <span class="string">@"yyyy-MM-dd HH:mm:ss.SSS"</span>;</span><br><span class="line">            </span><br><span class="line">            blocks[<span class="number">19</span>] = ^(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([string characterAtIndex:<span class="number">10</span>] == <span class="string">'T'</span>) &#123;<span class="comment">// 2014-01-20T12:24:48</span></span><br><span class="line">                    <span class="keyword">return</span> [formatter1 dateFromString:string];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">// 2014-01-20 12:24:48</span></span><br><span class="line">                    <span class="keyword">return</span> [formatter2 dateFromString:string];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">23</span>] = ^(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([string characterAtIndex:<span class="number">10</span>] == <span class="string">'T'</span>) &#123;<span class="comment">// 2014-01-20T12:24:48.000</span></span><br><span class="line">                    <span class="keyword">return</span> [formatter3 dateFromString:string];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">// 2014-01-20 12:24:48.000</span></span><br><span class="line">                    <span class="keyword">return</span> [formatter4 dateFromString:string];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48Z        // Github, Apple</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48+0800    // Facebook</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48+12:00   // Google</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48.000Z</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48.000+0800</span></span><br><span class="line"><span class="comment">             2014-01-20T12:24:48.000+12:00</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ssZ"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss.SSSZ"</span>;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">20</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">24</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]?: [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">25</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">28</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">29</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             Fri Sep 04 00:12:21 +0800 2015 // Weibo, Twitter</span></span><br><span class="line"><span class="comment">             Fri Sep 04 00:12:21.000 +0800 2015</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"EEE MMM dd HH:mm:ss Z yyyy"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"EEE MMM dd HH:mm:ss.SSS Z yyyy"</span>;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">30</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">34</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!string) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (string.length &gt; kParserNum) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    YYNSDateParseBlock parser = blocks[string.length];</span><br><span class="line">    <span class="keyword">if</span> (!parser) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> parser(string);</span><br><span class="line">    <span class="meta">#undef kParserNum</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°5: è·å–NSBlockç±»</span></span><br><span class="line"><span class="keyword">static</span> force_inline Class YYNSBlockClass() &#123;</span><br><span class="line">    <span class="keyword">static</span> Class cls;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;&#125;;</span><br><span class="line">        cls = ((<span class="built_in">NSObject</span> *)block).class;</span><br><span class="line">        <span class="keyword">while</span> (class_getSuperclass(cls) != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">            cls = class_getSuperclass(cls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> cls; <span class="comment">// current is "NSBlock"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°6: è·å–ISO NSDateFormatter</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> example:</span></span><br><span class="line"><span class="comment"> 2010-07-09T16:13:30+12:00</span></span><br><span class="line"><span class="comment"> 2011-01-11T11:11:11+0000</span></span><br><span class="line"><span class="comment"> 2011-01-26T19:06:43Z</span></span><br><span class="line"><span class="comment"> length: 20/24/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSDateFormatter</span> *YYISODateFormatter() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSDateFormatter</span> *formatter = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">        formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">        formatter.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ssZ"</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> formatter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    "version": "1.1",</span></span><br><span class="line"><span class="comment">    "object": &#123;</span></span><br><span class="line"><span class="comment">        "data": &#123;</span></span><br><span class="line"><span class="comment">            "phone": "12332123"</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å‡½æ•°7: æ ¹æ®keypathä»å­—å…¸ä¸­è·å–å¯¹åº”çš„å€¼(è¿™ä¸ªå€¼æ˜¯idç±»å‹)</span></span><br><span class="line"><span class="comment">// keyPaths: @[@"object", @"data", @"phone"] å¯¹åº”çš„å€¼æ˜¯ @"12332123"</span></span><br><span class="line"><span class="comment">// keyPaths: @[@"object", @"data"] å¯¹åº”çš„å€¼æ˜¯ @&#123;@"phone": @"12332123"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="keyword">id</span> YYValueForKeyPath(__<span class="keyword">unsafe_unretained</span> <span class="built_in">NSDictionary</span> *dic, __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSArray</span> *keyPaths) &#123;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = keyPaths.count; i &lt; max; i++) &#123;</span><br><span class="line">        value = dic[keyPaths[i]];</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &lt; max) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                dic = value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°8: æ ¹æ®å¯å˜çš„keypathä»å­—å…¸ä¸­è·å–å¯¹åº”çš„å€¼(è¿™ä¸ªå€¼æ˜¯idç±»å‹)</span></span><br><span class="line"><span class="comment">// multiKeys: @[ @[@"object", @"data"], @"phone"] å¯¹åº”çš„å€¼æ˜¯ @&#123;@"phone": @"12332123"&#125;</span></span><br><span class="line"><span class="comment">// multiKeys: @[@"object", @"data"] å¯¹åº”çš„å€¼æ˜¯ @&#123;@"data": @&#123;@"phone": @"12332123"&#125;&#125;</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="keyword">id</span> YYValueForMultiKeys(__<span class="keyword">unsafe_unretained</span> <span class="built_in">NSDictionary</span> *dic, __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSArray</span> *multiKeys) &#123;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> multiKeys) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([key isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            value = dic[key];</span><br><span class="line">            <span class="keyword">if</span> (value) <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = YYValueForKeyPath(dic, (<span class="built_in">NSArray</span> *)key);</span><br><span class="line">            <span class="keyword">if</span> (value) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°9: ä»æ¨¡å‹ä¸­çš„å±æ€§(_YYModelPropertyMetaç±»å‹)ä¸­è·å–NSNumber</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSNumber</span> *ModelCreateNumberFromProperty(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> model,</span><br><span class="line">                                                            __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeBool: &#123;</span><br><span class="line">            <span class="keyword">return</span> @(((<span class="keyword">bool</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_<span class="keyword">getter</span>));&#125;</span><br><span class="line">      <span class="comment">//......</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°10: å¯¹æ¨¡å‹ä¸­çš„å±æ€§(_YYModelPropertyMetaç±»å‹)è®¾å€¼. å’Œå‡½æ•°9ç±»ä¼¼</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="keyword">void</span> ModelSetNumberToProperty(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> model,</span><br><span class="line">                                                  __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSNumber</span> *num,</span><br><span class="line">                                                  __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeBool: &#123;</span><br><span class="line">            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">bool</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, num.boolValue);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°11: å¯¹æ¨¡å‹ä¸­çš„å±æ€§(_YYModelPropertyMetaç±»å‹)è®¾å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetValueForProperty(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> model,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> value,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> *modelMeta;  <span class="comment">///&lt; _YYModelMeta</span></span><br><span class="line">    <span class="keyword">void</span> *model;      <span class="comment">///&lt; id (self)</span></span><br><span class="line">    <span class="keyword">void</span> *dictionary; <span class="comment">///&lt; NSDictionary (json)</span></span><br><span class="line">&#125; ModelSetContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°12: å¯¹æ¨¡å‹(_context.modelMeta and _context.model)è®¾ç½® key-valueé”®å€¼å¯¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetWithDictionaryFunction(<span class="keyword">const</span> <span class="keyword">void</span> *_key, <span class="keyword">const</span> <span class="keyword">void</span> *_value, <span class="keyword">void</span> *_context) &#123;</span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta);</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge <span class="keyword">id</span>)(_key)];</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> model = (__bridge <span class="keyword">id</span>)(context-&gt;model);</span><br><span class="line">    <span class="keyword">while</span> (propertyMeta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_<span class="keyword">setter</span>) &#123;</span><br><span class="line">            ModelSetValueForProperty(model, (__bridge __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span>)_value, propertyMeta);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ‰å¤šä¸ªå±æ€§æ˜ å°„åˆ°åŒä¸€ä¸ª key åˆ™æŒ‡å‘ä¸‹ä¸€ä¸ªæ¨¡å‹å±æ€§å…ƒ</span></span><br><span class="line">        propertyMeta = propertyMeta-&gt;_next;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Apply function for model property meta, to set dictionary to model.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param _propertyMeta should not be nil, _YYModelPropertyMeta.</span></span><br><span class="line"><span class="comment"> @param _context      _context.model and _context.dictionary should not be nil.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å‡½æ•°13:</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetWithPropertyMetaArrayFunction(<span class="keyword">const</span> <span class="keyword">void</span> *_propertyMeta, <span class="keyword">void</span> *_context) &#123;</span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSDictionary</span> *dictionary = (__bridge <span class="built_in">NSDictionary</span> *)(context-&gt;dictionary);</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *propertyMeta = (__bridge _YYModelPropertyMeta *)(_propertyMeta);</span><br><span class="line">    <span class="keyword">if</span> (!propertyMeta-&gt;_<span class="keyword">setter</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyArray) &#123;</span><br><span class="line">        value = YYValueForMultiKeys(dictionary, propertyMeta-&gt;_mappedToKeyArray);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">        value = YYValueForKeyPath(dictionary, propertyMeta-&gt;_mappedToKeyPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = [dictionary objectForKey:propertyMeta-&gt;_mappedToKey];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line">        __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> model = (__bridge <span class="keyword">id</span>)(context-&gt;model);</span><br><span class="line">        ModelSetValueForProperty(model, value, propertyMeta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Returns a valid JSON object (NSArray/NSDictionary/NSString/NSNumber/NSNull),</span></span><br><span class="line"><span class="comment"> or nil if an error occurs.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param model Model, can be nil.</span></span><br><span class="line"><span class="comment"> @return JSON object, nil if an error occurs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å‡½æ•°14: æ¨¡å‹è½¬ json</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> ModelToJSONObjectRecursive(<span class="built_in">NSObject</span> *model) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!model || model == (<span class="keyword">id</span>)kCFNull) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *newDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        [((<span class="built_in">NSDictionary</span> *)model) enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> obj, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *stringKey = [key isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]] ? key : key.description;</span><br><span class="line">            <span class="keyword">if</span> (!stringKey) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">            <span class="keyword">if</span> (!jsonObj) jsonObj = (<span class="keyword">id</span>)kCFNull;</span><br><span class="line">            newDic[stringKey] = jsonObj;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">return</span> newDic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *array = ((<span class="built_in">NSSet</span> *)model).allObjects;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:array]) <span class="keyword">return</span> array;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *newArray = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> array) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]] || [obj isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                [newArray addObject:obj];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">                <span class="keyword">if</span> (jsonObj &amp;&amp; jsonObj != (<span class="keyword">id</span>)kCFNull) [newArray addObject:jsonObj];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newArray;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *newArray = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> (<span class="built_in">NSArray</span> *)model) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]] || [obj isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                [newArray addObject:obj];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">                <span class="keyword">if</span> (jsonObj &amp;&amp; jsonObj != (<span class="keyword">id</span>)kCFNull) [newArray addObject:jsonObj];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newArray;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSURL</span> *)model).absoluteString;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSAttributedString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSAttributedString</span> *)model).string;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDate</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> [YYISODateFormatter() stringFromDate:(<span class="keyword">id</span>)model];</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model <span class="keyword">class</span>]];</span><br><span class="line">    <span class="keyword">if</span> (!modelMeta || modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *result = [[<span class="built_in">NSMutableDictionary</span> alloc] initWithCapacity:<span class="number">64</span>];</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSMutableDictionary</span> *dic = result; <span class="comment">// avoid retain and release in block</span></span><br><span class="line">    [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!propertyMeta-&gt;_<span class="keyword">getter</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_isCNumber) &#123;</span><br><span class="line">            value = ModelCreateNumberFromProperty(model, propertyMeta);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_nsType) &#123;</span><br><span class="line">            <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">            value = ModelToJSONObjectRecursive(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                    <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = ModelToJSONObjectRecursive(v);</span><br><span class="line">                    <span class="keyword">if</span> (value == (<span class="keyword">id</span>)kCFNull) value = <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                    Class v = ((Class (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromClass</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeSEL: &#123;</span><br><span class="line">                    SEL v = ((SEL (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromSelector</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *superDic = dic;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *subDic = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *key = propertyMeta-&gt;_mappedToKeyPath[i];</span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span> == max) &#123; <span class="comment">// end</span></span><br><span class="line">                    <span class="keyword">if</span> (!superDic[key]) superDic[key] = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                subDic = superDic[key];</span><br><span class="line">                <span class="keyword">if</span> (subDic) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ([subDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                        subDic = subDic.mutableCopy;</span><br><span class="line">                        superDic[key] = subDic;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    subDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">                    superDic[key] = subDic;</span><br><span class="line">                &#125;</span><br><span class="line">                superDic = subDic;</span><br><span class="line">                subDic = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!dic[propertyMeta-&gt;_mappedToKey]) &#123;</span><br><span class="line">                dic[propertyMeta-&gt;_mappedToKey] = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformToDictionary) &#123;</span><br><span class="line">        <span class="comment">// å½“ Model è½¬ä¸º JSON å®Œæˆåï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="comment">// ä½ å¯ä»¥åœ¨è¿™é‡Œå¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæ ¡éªŒä¸é€šè¿‡ï¼Œå¯ä»¥è¿”å› NOï¼Œåˆ™è¯¥ Model ä¼šè¢«å¿½ç•¥ã€‚</span></span><br><span class="line">        <span class="comment">// ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›è‡ªåŠ¨è½¬æ¢ä¸èƒ½å®Œæˆçš„å·¥ä½œã€‚</span></span><br><span class="line">        <span class="built_in">BOOL</span> suc = [((<span class="keyword">id</span>&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic];</span><br><span class="line">        <span class="keyword">if</span> (!suc) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å‡½æ•°15: Add indent to string (exclude first line)</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableString</span> *ModelDescriptionAddIndent(<span class="built_in">NSMutableString</span> *desc, <span class="built_in">NSUInteger</span> indent) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = desc.length; i &lt; max; i++) &#123;</span><br><span class="line">        <span class="keyword">unichar</span> c = [desc characterAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'\n'</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> j = <span class="number">0</span>; j &lt; indent; j++) &#123;</span><br><span class="line">                [desc insertString:<span class="string">@"    "</span> atIndex:i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            i += indent * <span class="number">4</span>;</span><br><span class="line">            max += indent * <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å‡½æ•°16: æ ¹æ®modelç”Ÿæˆä¸€ä¸ªæè¿°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *ModelDescription(<span class="built_in">NSObject</span> *model) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kDescMaxLength = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">if</span> (!model) <span class="keyword">return</span> <span class="string">@"&lt;nil&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span> (model == (<span class="keyword">id</span>)kCFNull) <span class="keyword">return</span> <span class="string">@"&lt;null&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span> (![model isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,model];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:model.class];</span><br><span class="line">    <span class="keyword">switch</span> (modelMeta-&gt;_nsType) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSString: <span class="keyword">case</span> YYEncodingTypeNSMutableString: &#123;</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"\"%@\""</span>,model];</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSValue:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSData: <span class="keyword">case</span> YYEncodingTypeNSMutableData: &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *tmp = model.description;</span><br><span class="line">            <span class="keyword">if</span> (tmp.length &gt; kDescMaxLength) &#123;</span><br><span class="line">                tmp = [tmp substringToIndex:kDescMaxLength];</span><br><span class="line">                tmp = [tmp stringByAppendingString:<span class="string">@"..."</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSNumber:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSDecimalNumber:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSDate:</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSURL: &#123;</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,model];</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSSet: <span class="keyword">case</span> YYEncodingTypeNSMutableSet: &#123;</span><br><span class="line">            model = ((<span class="built_in">NSSet</span> *)model).allObjects;</span><br><span class="line">        &#125; <span class="comment">// no break</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSArray: <span class="keyword">case</span> YYEncodingTypeNSMutableArray: &#123;</span><br><span class="line">            <span class="built_in">NSArray</span> *array = (<span class="keyword">id</span>)model;</span><br><span class="line">            <span class="built_in">NSMutableString</span> *desc = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">            <span class="keyword">if</span> (array.count == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> [desc stringByAppendingString:<span class="string">@"[]"</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [desc appendFormat:<span class="string">@"[\n"</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = array.count; i &lt; max; i++) &#123;</span><br><span class="line">                    <span class="built_in">NSObject</span> *obj = array[i];</span><br><span class="line">                    [desc appendString:<span class="string">@"    "</span>];</span><br><span class="line">                    [desc appendString:ModelDescriptionAddIndent(ModelDescription(obj).mutableCopy, <span class="number">1</span>)];</span><br><span class="line">                    [desc appendString:(i + <span class="number">1</span> == max) ? <span class="string">@"\n"</span> : <span class="string">@";\n"</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                [desc appendString:<span class="string">@"]"</span>];</span><br><span class="line">                <span class="keyword">return</span> desc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeNSDictionary: <span class="keyword">case</span> YYEncodingTypeNSMutableDictionary: &#123;</span><br><span class="line">            <span class="built_in">NSDictionary</span> *dic = (<span class="keyword">id</span>)model;</span><br><span class="line">            <span class="built_in">NSMutableString</span> *desc = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">            <span class="keyword">if</span> (dic.count == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> [desc stringByAppendingString:<span class="string">@"&#123;&#125;"</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSArray</span> *keys = dic.allKeys;</span><br><span class="line">                </span><br><span class="line">                [desc appendFormat:<span class="string">@"&#123;\n"</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = keys.count; i &lt; max; i++) &#123;</span><br><span class="line">                    <span class="built_in">NSString</span> *key = keys[i];</span><br><span class="line">                    <span class="built_in">NSObject</span> *value = dic[key];</span><br><span class="line">                    [desc appendString:<span class="string">@"    "</span>];</span><br><span class="line">                    [desc appendFormat:<span class="string">@"%@ = %@"</span>,key, ModelDescriptionAddIndent(ModelDescription(value).mutableCopy, <span class="number">1</span>)];</span><br><span class="line">                    [desc appendString:(i + <span class="number">1</span> == max) ? <span class="string">@"\n"</span> : <span class="string">@";\n"</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                [desc appendString:<span class="string">@"&#125;"</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> desc;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="built_in">NSMutableString</span> *desc = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">            [desc appendFormat:<span class="string">@"&lt;%@: %p&gt;"</span>, model.class, model];</span><br><span class="line">            <span class="keyword">if</span> (modelMeta-&gt;_allPropertyMetas.count == <span class="number">0</span>) <span class="keyword">return</span> desc;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// sort property names</span></span><br><span class="line">            <span class="built_in">NSArray</span> *properties = [modelMeta-&gt;_allPropertyMetas</span><br><span class="line">                                   sortedArrayUsingComparator:^<span class="built_in">NSComparisonResult</span>(_YYModelPropertyMeta *p1, _YYModelPropertyMeta *p2) &#123;</span><br><span class="line">                                       <span class="keyword">return</span> [p1-&gt;_name compare:p2-&gt;_name];</span><br><span class="line">                                   &#125;];</span><br><span class="line">            </span><br><span class="line">            [desc appendFormat:<span class="string">@" &#123;\n"</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = properties.count; i &lt; max; i++) &#123;</span><br><span class="line">                _YYModelPropertyMeta *property = properties[i];</span><br><span class="line">                <span class="built_in">NSString</span> *propertyDesc;</span><br><span class="line">                <span class="keyword">if</span> (property-&gt;_isCNumber) &#123;</span><br><span class="line">                    <span class="built_in">NSNumber</span> *num = ModelCreateNumberFromProperty(model, property);</span><br><span class="line">                    propertyDesc = num.stringValue;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (property-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                            <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, property-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                            propertyDesc = ModelDescription(v);</span><br><span class="line">                            <span class="keyword">if</span> (!propertyDesc) propertyDesc = <span class="string">@"&lt;nil&gt;"</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                            <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, property-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                            propertyDesc = ((<span class="built_in">NSObject</span> *)v).description;</span><br><span class="line">                            <span class="keyword">if</span> (!propertyDesc) propertyDesc = <span class="string">@"&lt;nil&gt;"</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeSEL: &#123;</span><br><span class="line">                            SEL sel = ((SEL (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, property-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                            <span class="keyword">if</span> (sel) propertyDesc = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">                            <span class="keyword">else</span> propertyDesc = <span class="string">@"&lt;NULL&gt;"</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeBlock: &#123;</span><br><span class="line">                            <span class="keyword">id</span> block = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, property-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                            propertyDesc = block ? ((<span class="built_in">NSObject</span> *)block).description : <span class="string">@"&lt;nil&gt;"</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeCArray: <span class="keyword">case</span> YYEncodingTypeCString: <span class="keyword">case</span> YYEncodingTypePointer: &#123;</span><br><span class="line">                            <span class="keyword">void</span> *pointer = ((<span class="keyword">void</span>* (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, property-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                            propertyDesc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p"</span>,pointer];</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> YYEncodingTypeStruct: <span class="keyword">case</span> YYEncodingTypeUnion: &#123;</span><br><span class="line">                            <span class="built_in">NSValue</span> *value = [model valueForKey:property-&gt;_name];</span><br><span class="line">                            propertyDesc = value ? value.description : <span class="string">@"&#123;unknown&#125;"</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>: propertyDesc = <span class="string">@"&lt;unknown&gt;"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                propertyDesc = ModelDescriptionAddIndent(propertyDesc.mutableCopy, <span class="number">1</span>);</span><br><span class="line">                [desc appendFormat:<span class="string">@"    %@ = %@"</span>,property-&gt;_name, propertyDesc];</span><br><span class="line">                [desc appendString:(i + <span class="number">1</span> == max) ? <span class="string">@"\n"</span> : <span class="string">@";\n"</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            [desc appendFormat:<span class="string">@"&#125;"</span>];</span><br><span class="line">            <span class="keyword">return</span> desc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³é”®ç‚¹"><a href="#å…³é”®ç‚¹" class="headerlink" title="å…³é”®ç‚¹"></a>å…³é”®ç‚¹</h2><p> 1.å¼ºåˆ¶å†…è”</p> <figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">#define force_inline __inline__ __attribute__((<span class="name">always_inline</span>))</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨ä»£ç å—, èŠ‚çœè®¸å¤šå˜é‡å</p> <figure class="highlight clojure"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    NSDateFormatter *formatter = [[NSDateFormatter alloc] init]<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    NSDateFormatter *formatter = [[NSDateFormatter alloc] init]<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨blockæ•°ç»„</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSDate</span>* (^YYNSDateParseBlock)(<span class="built_in">NSString</span> *string);</span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªblockæ•°ç»„</span></span><br><span class="line"><span class="keyword">static</span> YYNSDateParseBlock blocks[<span class="number">35</span>] = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></figure><p>4.è·å–NSBlockç±»</p><figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;&#125;;</span><br><span class="line">cls = ((NSObject *)block).<span class="keyword">class</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">class</span><span class="number">_</span>getSuperclass(cls) != [NSObject <span class="keyword">class</span>]) &#123;</span><br><span class="line">    cls = <span class="keyword">class</span><span class="number">_</span>getSuperclass(cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 5.å‡½æ•°å‚æ•°ä½¿ç”¨<code>__unsafe_unretained</code><br> åœ¨ ARC æ¡ä»¶ä¸‹ï¼Œé»˜è®¤å£°æ˜çš„å¯¹è±¡æ˜¯ <code>__strong</code> ç±»å‹çš„ï¼Œèµ‹å€¼æ—¶æœ‰å¯èƒ½ä¼šäº§ç”Ÿ<code>retain/release</code>è°ƒç”¨ï¼Œå¦‚æœä¸€ä¸ªå˜é‡åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«é‡Šæ”¾ï¼Œåˆ™ä½¿ç”¨<code>__unsafe_unretained `</code>ä¼šèŠ‚çœå¾ˆå¤§çš„å¼€é”€ã€‚</p><p> è®¿é—®å…·æœ‰ <code>__weak</code>å±æ€§çš„å˜é‡æ—¶ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨ <code>objc_loadWeak()</code> å’Œ <code>objc_storeWeak()</code> æ¥å®Œæˆï¼Œè¿™ä¹Ÿä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œæ‰€ä»¥è¦é¿å…ä½¿ç”¨ <code>__weak</code>å±æ€§ã€‚</p><p> åˆ›å»ºå’Œä½¿ç”¨å¯¹è±¡æ—¶ï¼Œè¦å°½é‡é¿å…å¯¹è±¡è¿›å…¥<code>autoreleasepool</code>ï¼Œä»¥é¿å…é¢å¤–çš„èµ„æºå¼€é”€ã€‚</p><p> 6.forå¾ªç¯ä¸­å®šä¹‰å˜é‡, ä½¿ç”¨unsigned</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="built_in">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>, <span class="built_in">max</span> = keyPaths.count; i &lt; <span class="built_in">max</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 7.å¯å˜é‡åˆ›å»ºé™æ€ä¸å˜é‡, é™æ€å¸¸é‡é…åˆdispatch_onceä½¿ç”¨</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSSet</span> *types = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line"><span class="built_in">NSMutableSet</span> *set = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">    types = set;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p> 8.çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜å­—å…¸</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> cacheWithKey(<span class="built_in">NSString</span> *key) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> cache;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> dispatch_semaphore_t lock;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        cache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="keyword">id</span> obj = <span class="built_in">CFDictionaryGetValue</span>(cache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    <span class="keyword">if</span> (!obj) &#123;</span><br><span class="line">        obj = [<span class="built_in">NSObject</span> new]; <span class="comment">// Other operation.</span></span><br><span class="line">        <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            <span class="built_in">CFDictionarySetValue</span>(cache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key), (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(obj));</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>9.æ¶ˆæ¯å‘é€è°ƒç”¨æ ¼å¼</p><figure class="highlight hy"><table><tr><td class="code"><pre><span class="line">((<span class="name">int32_t</span> (<span class="name"><span class="builtin-name">*</span></span>)(<span class="name"><span class="builtin-name">id</span></span>, SEL))(<span class="name">void</span> *) objc_msgSend)((<span class="name"><span class="builtin-name">id</span></span>)model, meta-&gt;_getter)</span><br></pre></td></tr></table></figure><p>10.<code>NSNull</code>çš„å•ä¾‹<code>kCFNull</code>, æ¨èä½¿ç”¨, è€Œä¸æ˜¯åˆ›å»º<code>[NSNull null]</code></p> <figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSNull</span> *null1 = (<span class="keyword">id</span>)kCFNull;</span><br><span class="line"><span class="built_in">NSNull</span> *null2 = [<span class="built_in">NSNull</span> null];</span><br><span class="line"></span><br><span class="line">Class <span class="keyword">class</span> = Nil;</span><br><span class="line"><span class="built_in">NSDate</span> *date = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">char</span> *p = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p>11.<code>YYClassIvarInfo</code>ä¸­çš„ <code>name</code> å’Œ <code>typeEncoding</code> å±æ€§éƒ½ç”¨ <code>strong</code> ä¿®é¥°ã€‚<br>NSString è¿™ç±»å±æ€§åœ¨ç¡®å®šå…¶ä¸ä¼šåœ¨åˆå§‹åŒ–ä¹‹åè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ strong åšä¸€æ¬¡å•çº¯çš„å¼ºå¼•ç”¨åœ¨æ€§èƒ½ä¸Šè®²æ¯” copy è¦é«˜ä¸€äº›ã€‚</p><p>12.<code>NSString</code>è½¬Cå­—ç¬¦ä¸²</p><p> <code>const char *cstring = ((NSString *)value).UTF8String;</code></p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p> YYModel æœ€æ ¸å¿ƒçš„ä¾¿æ˜¯é€šè¿‡éå†æ¨¡å‹çš„æ‰€æœ‰å±æ€§ï¼Œæ ¹æ®å­—å…¸å€¼æ¥è°ƒç”¨å±æ€§çš„ setter æ–¹æ³•ã€‚æ²¡æœ‰ä½¿ç”¨æ•ˆç‡ä½ä¸‹çš„ KVCï¼ˆæ•ˆç‡ä½ä¸‹çš„åŸå› å¯èƒ½æ˜¯éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œæœç´¢å§ï¼Œæœ‰ç©ºæ·±ç©¶ï¼‰ã€‚é‰´äºæ­¤ï¼Œç”¨äº†300è¡Œä»£ç ç®€å•å†™äº†ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹çš„ç©å…·ï¼Œæƒå½“åšæ˜¯è¯»å®Œ YYModel çš„å®è·µå§ã€‚è¯•äº†ä¸€ä¸‹ï¼Œæ•ˆæœè¿˜å¯ä»¥ğŸ˜‚ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">@protocol</span> <span class="title">YAModelProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="keyword">@optional</span>;</span><br><span class="line">+ (<span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)customPropertyKey;</span><br><span class="line">+ (<span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, Class&gt;*)classInArray;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">YAModel</span>)</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)ya_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dict;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)ya_modelWithJSON:(<span class="built_in">NSData</span> *)data;</span><br><span class="line">+ (<span class="built_in">NSArray</span> *)ya_modelArrayWithKeyValuesArray:(<span class="built_in">NSArray</span> &lt;<span class="built_in">NSDictionary</span> *&gt;*)dictArray;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¼–ç ç±»å‹</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, YAType) &#123;</span><br><span class="line">    YATypeMask              = <span class="number">0xFF</span>,</span><br><span class="line">    YATypeUnknown           = <span class="number">0</span>,</span><br><span class="line">    YATypeBOOL              = <span class="number">1</span>,</span><br><span class="line">    YATypeNSInteger         = <span class="number">2</span>,</span><br><span class="line">    YATypeNSUInteger        = <span class="number">3</span>,</span><br><span class="line">    YATypeCGFloat           = <span class="number">4</span>,</span><br><span class="line">    YATypeObject            = <span class="number">5</span>,</span><br><span class="line">    YATypeDate              = <span class="number">6</span>,</span><br><span class="line">    YATypeClass             = <span class="number">7</span>,</span><br><span class="line">    YATypeSEL               = <span class="number">8</span>,</span><br><span class="line">    YATypeArray             = <span class="number">9</span>,</span><br><span class="line">    YATypeMutableArray      = <span class="number">10</span>,</span><br><span class="line">    YATypeDictionary        = <span class="number">11</span>,</span><br><span class="line">    YATypeMutableDictionary = <span class="number">12</span>,</span><br><span class="line">    YATypeSet               = <span class="number">13</span>,</span><br><span class="line">    YATypeMutableSet        = <span class="number">14</span>,</span><br><span class="line">    YATypeString            = <span class="number">15</span>,</span><br><span class="line">    YATypeMutableString     = <span class="number">16</span>,</span><br><span class="line">    YATypeData              = <span class="number">17</span>,</span><br><span class="line">    YATypeNumber            = <span class="number">18</span>,</span><br><span class="line">    YATypeDecimalNumber     = <span class="number">19</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">YAModel</span>)</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSDictionary</span> *classArrayDict = <span class="literal">nil</span>;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)ya_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line">    <span class="keyword">if</span> (!dict || ![dict isKindOfClass:<span class="built_in">NSDictionary</span>.class]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *propertyList = PropertyList(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">id</span> obj = [<span class="keyword">self</span> new];</span><br><span class="line">    ObjSetWithKeyValueList(obj, propertyList, dict);</span><br><span class="line">    classArrayDict = <span class="literal">nil</span>; <span class="comment">// Clean memory.</span></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)ya_modelWithJSON:(<span class="built_in">NSData</span> *)data &#123;</span><br><span class="line">    <span class="keyword">if</span> (!data || ![data isKindOfClass:<span class="built_in">NSData</span>.class]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">id</span> json = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:kNilOptions error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">if</span> ([json isKindOfClass:<span class="built_in">NSDictionary</span>.class]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> ya_modelWithDictionary:json];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSArray</span> *)ya_modelArrayWithKeyValuesArray:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSDictionary</span> *&gt; *)dictArray &#123;</span><br><span class="line">    <span class="keyword">if</span> (!dictArray || ![dictArray isKindOfClass:<span class="built_in">NSArray</span>.class]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *tmp = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:dictArray.count];</span><br><span class="line">    [dictArray enumerateObjectsUsingBlock:^(<span class="built_in">NSDictionary</span> * _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSDictionary</span>.class]) &#123;</span><br><span class="line">            <span class="keyword">id</span> model = [[<span class="keyword">self</span> <span class="keyword">class</span>] ya_modelWithDictionary:obj];</span><br><span class="line">            [tmp addObject:model];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:tmp] ?: <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å±æ€§åˆ—è¡¨ key:å±æ€§å value: å±æ€§ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSDictionary</span> *PropertyList(Class cls) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(cls, &amp;count);</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *tempDict = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        <span class="built_in">NSString</span> *propertyName = [<span class="built_in">NSString</span> stringWithUTF8String:property_getName(property)];</span><br><span class="line">        <span class="built_in">NSString</span> *propertyAttr = [<span class="built_in">NSString</span> stringWithUTF8String:property_getAttributes(property)];</span><br><span class="line">        <span class="built_in">NSString</span> *type = [propertyAttr substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, <span class="number">1</span>)];</span><br><span class="line">        <span class="keyword">if</span> ([type isEqualToString:<span class="string">@"@"</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSArray</span> *components = [propertyAttr componentsSeparatedByString:<span class="string">@"\""</span>];</span><br><span class="line">            <span class="keyword">if</span> (components.count &gt; <span class="number">2</span>) &#123;</span><br><span class="line">                Class propCls = <span class="built_in">NSClassFromString</span>(components[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span> (propCls == <span class="built_in">NSDate</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"1"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSArray</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"2"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSMutableArray</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"3"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSDictionary</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"4"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSMutableDictionary</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"5"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSSet</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"6"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSMutableSet</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"7"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSString</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"8"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSMutableString</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"9"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSData</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"10"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSNumber</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"11"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSDecimalNumber</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"12"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propCls == <span class="built_in">NSObject</span>.class) &#123;</span><br><span class="line">                    type = <span class="string">@"@"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    type = components[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSNumber</span> *myType = TypeForProperty(type);</span><br><span class="line">        [tempDict setObject:myType forKey:propertyName];</span><br><span class="line">        <span class="keyword">if</span> (myType.integerValue == <span class="number">0</span>) &#123;</span><br><span class="line">            [tempDict setObject:type forKey:propertyName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(properties);</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:tempDict];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSNumber</span> *TypeForProperty(<span class="built_in">NSString</span> *type) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSDictionary</span> *_SELDictionary = <span class="literal">nil</span>;;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _SELDictionary = @&#123;</span><br><span class="line">                           <span class="string">@"B"</span>: @(YATypeBOOL),</span><br><span class="line">                           <span class="string">@"q"</span>: @(YATypeNSInteger),</span><br><span class="line">                           <span class="string">@"Q"</span>: @(YATypeNSUInteger),</span><br><span class="line">                           <span class="string">@"d"</span>: @(YATypeCGFloat),</span><br><span class="line">                           <span class="string">@"#"</span>: @(YATypeClass),</span><br><span class="line">                           <span class="string">@":"</span>: @(YATypeSEL),</span><br><span class="line">                           <span class="string">@"@"</span>: @(YATypeObject),</span><br><span class="line">                           <span class="string">@"1"</span>: @(YATypeDate),</span><br><span class="line">                           <span class="string">@"2"</span>: @(YATypeArray),</span><br><span class="line">                           <span class="string">@"3"</span>: @(YATypeMutableArray),</span><br><span class="line">                           <span class="string">@"4"</span>: @(YATypeDictionary),</span><br><span class="line">                           <span class="string">@"5"</span>: @(YATypeMutableDictionary),</span><br><span class="line">                           <span class="string">@"6"</span>: @(YATypeSet),</span><br><span class="line">                           <span class="string">@"7"</span>: @(YATypeMutableSet),</span><br><span class="line">                           <span class="string">@"8"</span>: @(YATypeString),</span><br><span class="line">                           <span class="string">@"9"</span>: @(YATypeMutableString),</span><br><span class="line">                           <span class="string">@"10"</span>: @(YATypeData),</span><br><span class="line">                           <span class="string">@"11"</span>: @(YATypeNumber),</span><br><span class="line">                           <span class="string">@"12"</span>: @(YATypeDecimalNumber),</span><br><span class="line">                           &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _SELDictionary[type] ?: @(YATypeUnknown);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ObjSetWithArray(Class cls, <span class="built_in">NSDictionary</span> *propertyDict, <span class="built_in">NSArray</span> **keyValueArray) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *tmpArray = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [*keyValueArray enumerateObjectsUsingBlock:^(<span class="keyword">id</span> keyValue, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([keyValue isKindOfClass:<span class="built_in">NSDictionary</span>.class]) &#123;</span><br><span class="line">            <span class="keyword">id</span> obj = [cls new];</span><br><span class="line">            ObjSetWithKeyValueList(obj, PropertyList([obj <span class="keyword">class</span>]), keyValue);</span><br><span class="line">            [tmpArray addObject:obj];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    *keyValueArray = [<span class="built_in">NSArray</span> arrayWithArray:tmpArray];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ObjSetWithKeyValueList(<span class="keyword">id</span> obj, <span class="built_in">NSDictionary</span> *propertyDict, <span class="built_in">NSDictionary</span> *dict) &#123;</span><br><span class="line">    Class cls = [obj <span class="keyword">class</span>];</span><br><span class="line">    <span class="built_in">NSDictionary</span> *customPropertyKeyDict = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(customPropertyKey)]) &#123;</span><br><span class="line">        customPropertyKeyDict = [cls customPropertyKey];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(classInArray)] &amp;&amp; !classArrayDict) &#123;</span><br><span class="line">        classArrayDict = [cls classInArray];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [propertyDict.allKeys enumerateObjectsUsingBlock:^(<span class="built_in">NSString</span> *name, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        SEL <span class="keyword">setter</span> = SetterSelectorFromString(name);</span><br><span class="line">        <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (customPropertyKeyDict[name]) &#123;</span><br><span class="line">            value = customPropertyKeyDict[name];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = dict[name];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">id</span> propType = propertyDict[name];</span><br><span class="line">        YAType type = [propType integerValue];</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (type &amp; YATypeMask) &#123;</span><br><span class="line">                <span class="keyword">case</span> YATypeBOOL: &#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">bool</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, [value boolValue]);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeNSInteger: &#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, int64_t))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, (int64_t)[value longLongValue]);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeNSUInteger: &#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, uint64_t))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, (uint64_t)[value unsignedLongLongValue]);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeCGFloat: &#123;</span><br><span class="line">                    <span class="keyword">long</span> <span class="keyword">double</span> d = [value doubleValue];</span><br><span class="line">                    <span class="keyword">if</span> (isnan(d) || isinf(d)) d = <span class="number">0</span>;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">long</span> <span class="keyword">double</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, (<span class="keyword">long</span> <span class="keyword">double</span>)d);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeDecimalNumber: &#123;</span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:<span class="built_in">NSNumber</span>.class]) &#123;</span><br><span class="line">                        <span class="built_in">NSDecimalNumber</span> *decNum = [<span class="built_in">NSDecimalNumber</span> decimalNumberWithDecimal:[value decimalValue]];</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">NSDecimalNumber</span> *))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, decNum);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeClass: &#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, Class))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, <span class="built_in">NSClassFromString</span>(value));</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeSEL:&#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, <span class="built_in">NSSelectorFromString</span>(value));</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeDate:&#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, DateFromString(value));</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeArray: &#123;</span><br><span class="line">                    Class cls = classArrayDict[name];</span><br><span class="line">                    <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                        ObjSetWithArray(cls, PropertyList(cls), &amp;value);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeMutableArray: &#123;</span><br><span class="line">                    <span class="built_in">NSString</span> *clsStr = classArrayDict[name];</span><br><span class="line">                    <span class="keyword">if</span> (clsStr) &#123;</span><br><span class="line">                        Class cls = <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">                        ObjSetWithArray(cls, PropertyList(cls), &amp;value);</span><br><span class="line">                    &#125;</span><br><span class="line">                    value = [<span class="built_in">NSMutableArray</span> arrayWithArray:value];</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeSet: &#123;</span><br><span class="line">                    value = [<span class="built_in">NSSet</span> setWithArray:value];</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeMutableSet: &#123;</span><br><span class="line">                    value = [<span class="built_in">NSMutableSet</span> setWithArray:value];</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeMutableString:</span><br><span class="line">                <span class="keyword">case</span> YATypeMutableDictionary: &#123;</span><br><span class="line">                    value = [value mutableCopy];</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> YATypeString:</span><br><span class="line">                <span class="keyword">case</span> YATypeDictionary:</span><br><span class="line">                <span class="keyword">case</span> YATypeNumber:</span><br><span class="line">                <span class="keyword">case</span> YATypeUnknown:</span><br><span class="line">                <span class="keyword">case</span> YATypeObject: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type == YATypeUnknown &amp;&amp; [propType isKindOfClass:<span class="built_in">NSString</span>.class]) &#123; <span class="comment">// åµŒå¥—æ¨¡å‹</span></span><br><span class="line">                        Class cls = <span class="built_in">NSClassFromString</span>(propType);</span><br><span class="line">                        <span class="keyword">if</span> (cls &amp;&amp; [value isKindOfClass:<span class="built_in">NSDictionary</span>.class]) &#123;</span><br><span class="line">                            <span class="keyword">id</span> obj = [cls new];</span><br><span class="line">                            ObjSetWithKeyValueList(obj, PropertyList(cls), value);</span><br><span class="line">                            value = obj;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)obj, <span class="keyword">setter</span>, value);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// name  ==&gt; setName:</span></span><br><span class="line"><span class="keyword">static</span> SEL SetterSelectorFromString(<span class="built_in">NSString</span> *str) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!str || str.length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *result = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>, [str substringToIndex:<span class="number">1</span>].uppercaseString, [str substringFromIndex:<span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NSSelectorFromString</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// date string ==&gt; data // @"2016-7-16 09:33:22"</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSDate</span> *DateFromString(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">NSDate</span>* (^DateParseBlock)(<span class="built_in">NSString</span> *string);</span><br><span class="line">    <span class="keyword">static</span> DateParseBlock blocks[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// @"2016-07-16 09:33:22" // 19ä¸ªå­—ç¬¦, å¯¹åº”blocks[19]</span></span><br><span class="line">        <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">        formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">        formatter.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">        formatter.dateFormat = <span class="string">@"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line">        blocks[<span class="number">19</span>] = ^(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">            <span class="keyword">return</span> [formatter dateFromString:string];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!string || string.length &gt; <span class="number">19</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    DateParseBlock parser = blocks[string.length];</span><br><span class="line">    <span class="keyword">if</span> (!parser) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> parser(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å…·ä½“æºç æ”¾åœ¨äº†æˆ‘çš„ä»£ç å·¥å…·åº“é‡Œï¼ŒYAKitï¼š<a href="https://github.com/ChenYalun/YAKit/tree/master/Util/Model" target="_blank" rel="noopener">https://github.com/ChenYalun/YAKit/tree/master/Util/Model</a></p><blockquote><p>å‚è€ƒèµ„æ–™<br> <a href="https://juejin.im/post/5a097435f265da431769a49c" target="_blank" rel="noopener">https://juejin.im/post/5a097435f265da431769a49c</a><br> <a href="https://juejin.im/post/5a1296e36fb9a044fb075d5e" target="_blank" rel="noopener">https://juejin.im/post/5a1296e36fb9a044fb075d5e</a><br> <a href="https://blog.ibireme.com/2015/10/23/ios_model_framework_benchmark/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/10/23/ios_model_framework_benchmark/</a><br> <a href="https://blog.csdn.net/game3108/article/details/52416868" target="_blank" rel="noopener">https://blog.csdn.net/game3108/article/details/52416868</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å…³äºYYModelçš„ç®€å•æ€»ç»“ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>PerformSelectoråŸç†</title>
    <link href="http://blog.chenyalun.com/2018/09/30/PerformSelector%E5%8E%9F%E7%90%86/"/>
    <id>http://blog.chenyalun.com/2018/09/30/PerformSelectoråŸç†/</id>
    <published>2018-09-30T09:22:13.000Z</published>
    <updated>2019-09-22T07:22:44.642Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> PerformSelectorç›¸å…³çŸ¥è¯†ã€‚ </p><a id="more"></a><p>performSelectorç³»åˆ—æ˜¯ä¸ªå¾ˆç¥å¥‡çš„å­˜åœ¨ï¼Œèƒ½ä¼ å‚ï¼Œèƒ½å»¶è¿Ÿï¼Œè¿˜èƒ½å­çº¿ç¨‹è°ƒï¼Œèƒ½è®©ä»»æ„å¯¹è±¡æ‰§è¡Œä»»æ„æ–¹æ³•ï¼Œè¯»äº†gnustepä¸­æœ‰å…³performSelectorçš„æºç åï¼Œè¿™é‡Œåšä¸ªæ€»ç»“ã€‚</p><blockquote><p>æºç åœ°å€ï¼š<a href="https://github.com/gnustep/libs-base/releases/tag/base-1_25_1" target="_blank" rel="noopener">https://github.com/gnustep/libs-base/releases/tag/base-1_25_1</a></p></blockquote><h2 id="åŸºæœ¬"><a href="#åŸºæœ¬" class="headerlink" title="åŸºæœ¬"></a>åŸºæœ¬</h2><p>æœ€åŸºæœ¬çš„performSelectoræœ‰ä¸‰ä¸ªæ¥å£æ–¹æ³•ï¼Œå¯ä»¥ä¸ä¼ å‚ï¼Œä¼ ä¸€ä¸ªå‚æ•°ä»¥åŠä¼ ä¸¤ä¸ªå‚æ•°ã€‚</p><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector;</span><br><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>object;</span><br><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>object1 withObject:<span class="params">(id)</span>object2;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— å‚ </span></span><br><span class="line">id obj1 = [self <span class="string">performSelector:</span><span class="meta">@selector</span>(printString)];</span><br><span class="line"><span class="comment">// ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">id obj2 = [self <span class="string">performSelector:</span><span class="meta">@selector</span>(<span class="string">printString:</span>) <span class="string">withObject:</span>@<span class="string">"string"</span>];</span><br><span class="line"><span class="comment">// ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">id obj3 = [self <span class="string">performSelector:</span><span class="meta">@selector</span>(<span class="string">printString:</span><span class="string">str2:</span>) <span class="string">withObject:</span>@<span class="string">"string"</span> <span class="string">withObject:</span>@&#123;@<span class="string">"key"</span>: @(<span class="number">3</span>)&#125;];</span><br></pre></td></tr></table></figure><p>ä»¥ä¼ é€’ä¸¤ä¸ªå‚æ•°ä¸ºä¾‹ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)performSelector:(SEL)aSelector</span><br><span class="line">           withObject:(<span class="keyword">id</span>)object1</span><br><span class="line">           withObject:(<span class="keyword">id</span>)object2 &#123;</span><br><span class="line">    IMP msg;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise: <span class="built_in">NSInvalidArgumentException</span></span><br><span class="line">                    format: <span class="string">@"%@ null selector given"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd)];</span><br><span class="line">    &#125;</span><br><span class="line">    msg = objc_msg_lookup(<span class="keyword">self</span>, aSelector);</span><br><span class="line">    <span class="keyword">if</span> (!msg) &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise: <span class="built_in">NSGenericException</span></span><br><span class="line">                    format: <span class="string">@"invalid selector '%s' passed to %s"</span>,</span><br><span class="line">         sel_getName(aSelector), sel_getName(_cmd)];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*msg)(<span class="keyword">self</span>, aSelector, object1, object2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§å°±æ˜¯æ ¹æ®æ–¹æ³•åï¼Œ<strong>ä½¿ç”¨Runtimeä¸­çš„<code>objc_msg_lookup()</code>è·å–åˆ°å‡½æ•°æŒ‡é’ˆIMPï¼Œè¿›è€Œè¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚</strong>å½“ç„¶ï¼Œè¿˜æœ‰å¯¹æ–¹æ³•åå’Œå‡½æ•°æŒ‡é’ˆçš„å®¹é”™å¤„ç†ã€‚</p><h3 id="å†…å­˜æ³„éœ²"><a href="#å†…å­˜æ³„éœ²" class="headerlink" title="å†…å­˜æ³„éœ²"></a>å†…å­˜æ³„éœ²</h3><p>performSelectorç³»åˆ—é¢‡å…·æœ‰åŠ¨æ€æ€§ï¼Œå½“ä½¿ç”¨è¿™ä¸‰ä¸ªæ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨å¾ˆå®¹æ˜“å°±ç»™å‡ºè­¦å‘Šï¼šPerformSelector may cause a leak because its selector is unknownã€‚ä¸ºä»€ä¹ˆä¼šæç¤ºæœ‰å†…å­˜æ³„æ¼é—®é¢˜å‘¢ï¼Ÿ</p><p>é¦–å…ˆè¦æ˜ç¡®ï¼š<strong>è°ƒç”¨<code>performSelector:</code>ç¼–è¯‘å™¨ä¼šå‡è®¾è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸”ä¸ä¼šå¯¹è¿”å›å€¼è¿›è¡Œretain/release</strong>ã€‚</p><p>å¦‚æœè°ƒç”¨çš„æ–¹æ³•æ˜¯<code>alloc, new, copy, mutableCopy</code>æ–¹æ³•å®¶æ—ä¸­çš„æ–¹æ³•(åŒ…å«ä»¥å®ƒä»¬å¼€å¤´)ï¼Œæ–¹æ³•è°ƒç”¨çš„ç»“æœæ˜¯å¼€è¾Ÿäº†ä¸€å—å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ç³»ç»Ÿä»ç„¶æŒ‰ç…§éretain/releaseå¤„ç†ï¼Œæ²¡æœ‰å¯¹å®ƒä»¬çš„å¼•ç”¨è®¡æ•°çº³å…¥ç®¡ç†ï¼Œè¿™æ—¶å†…å­˜ç©ºé—´æ— æ³•é‡Šæ”¾ï¼Œå°±ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚</p><p>å½“<strong>æ˜¾å¼è°ƒç”¨</strong>è¿™äº›æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨éƒ½èƒ½æ˜æ˜¾åˆ†æå‡ºæ¥ï¼Œå¹¶ç»™å‡ºæç¤ºï¼šErrorï¼šPerformSelector names a selector which retains the objectã€‚å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ç¬¦åˆå¼•ç”¨è®¡æ•°ç®¡ç†çš„è§„åˆ™ï¼Œç¼–è¯‘ä¸é€šè¿‡ã€‚</p><p>There are really only 4 things that ARC would consider for the return value:4</p><ul><li>Ignore non-object types (void, int, etc)</li><li>Retain object value, then release when it is no longer used (standard assumption)</li><li>Release new object values when no longer used (methods in the init/ copy family or attributed with ns_returns_retained)</li><li>Do nothing &amp; assume returned object value will be valid in local scope (until inner most release pool is drained, attributed with ns_returns_autoreleased)</li></ul><p>The call to methodForSelector: assumes that the return value of the method itâ€™s calling is an object, but does not retain/release it. So you could end up creating a leak if your object is supposed to be released as in #3 above (that is, the method youâ€™re calling returns a new object).</p><p>æ¯”å¦‚è¿™æ ·ï¼š<br><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line">- (id)<span class="keyword">new</span><span class="type">Object</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [NSObject <span class="keyword">new</span><span class="type"></span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨method familyä¸­çš„æ–¹æ³•ï¼š</span></span><br><span class="line">[str <span class="string">performSelector:</span><span class="meta">@selector</span>(copy)];</span><br><span class="line"><span class="comment">// è°ƒç”¨ä»¥method familyä¸­çš„æ–¹æ³•åå¼€å¤´çš„æ–¹æ³•ï¼š</span></span><br><span class="line">[self <span class="string">performSelector:</span><span class="meta">@selector</span>(newObject)];</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯<strong>éšå¼è°ƒç”¨</strong>çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨æ— èƒ½ä¸ºåŠ›äº†ï¼Œåªèƒ½ç»™å‡ºè­¦å‘Šï¼šPerformSelector may cause a leak because its selector is unknownã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// éšå¼è°ƒç”¨æ— æ³•åˆ†æå‡ºé”™è¯¯: å‡ºç°å†…å­˜æ³„éœ²</span></span><br><span class="line"><span class="keyword">id</span> obj1 = [str performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"copy"</span>)];</span><br><span class="line">[str performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"mutableCopy"</span>)];</span><br><span class="line"><span class="keyword">id</span> obj2 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"new"</span>)];</span><br><span class="line"><span class="keyword">id</span> obj3 = [<span class="keyword">self</span> performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"newObject"</span>)];</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆé™¤waring"><a href="#æ¶ˆé™¤waring" class="headerlink" title="æ¶ˆé™¤waring"></a>æ¶ˆé™¤waring</h3><p>æœ€ç®€å•çš„ï¼Œå¯ä»¥åˆ©ç”¨<code>#pragma</code>æ¶ˆé™¤è­¦å‘Šã€‚</p><figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">#</span><span class="title">pragma</span><span class="params">(<span class="string">"clang diagnostic push"</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">#</span><span class="title">pragma</span><span class="params">(<span class="string">"clang diagnostic ignored \"</span>-<span class="variable">Warc</span>-<span class="variable">performSelector</span>-<span class="variable">leaks</span>\<span class="string">""</span>)</span></span></span><br><span class="line">[person performSelector:selector]; // æ’å…¥éœ€è¦æ¶ˆé™¤è­¦å‘Šçš„ä»£ç </span><br><span class="line"><span class="function"><span class="keyword">#</span><span class="title">pragma</span><span class="params">(<span class="string">"clang diagnostic pop"</span>)</span></span></span><br></pre></td></tr></table></figure><p>æˆ–è€…æ¢ç§æ€è·¯ï¼Œæ ¹æ®<code>performSelector</code>çš„å®ç°ï¼Œæ•ˆæœä¸Šå¯ä»¥ç›´æ¥ä½¿ç”¨<code>IMP</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>objc_msgSend()</code>ï¼Œç”šè‡³ä½¿ç”¨<code>NSInvocation</code>ã€<code>sendAction</code>ç­‰ï¼Œè¿™æ ·å°±è¾¾åˆ°åŒç­‰å®ç°è€Œæ²¡æœ‰è­¦å‘Šäº†ã€‚</p><p>æ–¹å¼1ï¼šmethodForSelector<br><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!person) return;</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">IMP imp = [person methodForSelector:<span class="keyword">selector</span>];</span><br><span class="line"><span class="comment">// ç±»å‹è½¬æ¢</span></span><br><span class="line">void <span class="comment">(*func)(id, SEL) = (void *)</span>imp;</span><br><span class="line"><span class="comment">// è°ƒç”¨</span></span><br><span class="line">func(person, <span class="keyword">selector</span>);</span><br></pre></td></tr></table></figure></p><p>æ–¹å¼2ï¼šmethodForSelectorç®€åŒ–ç‰ˆ<br><figure class="highlight hy"><table><tr><td class="code"><pre><span class="line">((<span class="name">void</span> (<span class="name"><span class="builtin-name">*</span></span>)(<span class="name"><span class="builtin-name">id</span></span>, SEL))[person methodForSelector:selector])(<span class="name">self</span>, selector)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>æ–¹å¼3ï¼šä½¿ç”¨objc_msgSend<br><figure class="highlight hy"><table><tr><td class="code"><pre><span class="line">((<span class="name">void</span> *(<span class="name"><span class="builtin-name">*</span></span>)(<span class="name"><span class="builtin-name">id</span></span>, SEL))objc_msgSend)((<span class="name"><span class="builtin-name">id</span></span>)self, NSSelectorFromString(@<span class="string">"show"</span>))<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>æ–¹å¼4ï¼šNSInvocation<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">SEL selector = <span class="built_in">NSSelectorFromString</span>(<span class="string">@"show"</span>);</span><br><span class="line"><span class="built_in">NSMethodSignature</span> *methodSig = [[<span class="keyword">self</span> <span class="keyword">class</span>] instanceMethodSignatureForSelector:selector];</span><br><span class="line"><span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:methodSig];</span><br><span class="line">[invocation setSelector:selector];</span><br><span class="line">[invocation setTarget:<span class="keyword">self</span>];</span><br><span class="line">[invocation invoke];</span><br></pre></td></tr></table></figure></p><p>æ–¹å¼5: sendAction<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="built_in">UIApplication</span>.sharedApplication sendAction:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"show"</span>) to:<span class="keyword">self</span> from:<span class="literal">nil</span> forEvent:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure></p><h3 id="è§£å†³å†…å­˜æ³„æ¼"><a href="#è§£å†³å†…å­˜æ³„æ¼" class="headerlink" title="è§£å†³å†…å­˜æ³„æ¼"></a>è§£å†³å†…å­˜æ³„æ¼</h3><p>å½“æˆ‘ä»¬ä¸€å®šè¦è°ƒç”¨<code>newObject</code>è¿™ç±»ç‰¹æ®Šçš„æ–¹æ³•æ—¶ï¼ˆå¯èƒ½æ€§æå°ï¼‰ï¼Œæ€ä¹ˆè§£å†³å†…å­˜æ³„æ¼é—®é¢˜å‘¢ï¼ŸæŠŠreturnçš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡å°‘å³å¯ï¼Œæ¯”å¦‚ï¼š</p><p>å½“ä½¿ç”¨<code>objc_msgSend()</code>æ—¶<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> obj = <span class="built_in">CFBridgingRelease</span>(((<span class="keyword">void</span> *(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(<span class="keyword">self</span>, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"newObject"</span>)));</span><br></pre></td></tr></table></figure></p><p>å½“ä½¿ç”¨<code>methodForSelector</code>æ—¶<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> obj = <span class="built_in">CFBridgingRelease</span>(((<span class="keyword">void</span> *(*)(<span class="keyword">id</span>, SEL))[<span class="keyword">self</span> methodForSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"newObject"</span>)])(<span class="keyword">self</span>, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"newObject"</span>)));</span><br></pre></td></tr></table></figure></p><h2 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anArgument afterDelay:(<span class="built_in">NSTimeInterval</span>)delay inModes:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSRunLoopMode</span>&gt; *)modes;</span><br><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anArgument afterDelay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br><span class="line">+ (<span class="keyword">void</span>)cancelPreviousPerformRequestsWithTarget:(<span class="keyword">id</span>)aTarget selector:(SEL)aSelector object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anArgument;</span><br><span class="line">+ (<span class="keyword">void</span>)cancelPreviousPerformRequestsWithTarget:(<span class="keyword">id</span>)aTarget;</span><br></pre></td></tr></table></figure><h3 id="performSelector-withObject-afterDelay"><a href="#performSelector-withObject-afterDelay" class="headerlink" title="performSelector:withObject:afterDelay:"></a>performSelector:withObject:afterDelay:</h3><p>æºç å®ç°:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector</span><br><span class="line">             withObject:(<span class="keyword">id</span>)argument</span><br><span class="line">             afterDelay:(<span class="built_in">NSTimeInterval</span>)seconds &#123;</span><br><span class="line">    <span class="built_in">NSRunLoop</span> *loop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">    GSTimedPerformer *item;</span><br><span class="line">    <span class="comment">// itemå¼•ç”¨è®¡æ•°+1</span></span><br><span class="line">    item = [[GSTimedPerformer alloc] initWithSelector:aSelector</span><br><span class="line">                                               target:<span class="keyword">self</span></span><br><span class="line">                                             argument:argument</span><br><span class="line">                                                delay:seconds];</span><br><span class="line">    <span class="comment">// æŒæœ‰item</span></span><br><span class="line">    [[loop _timedPerformers] addObject:item];</span><br><span class="line">    <span class="comment">// itemå¼•ç”¨è®¡æ•°-1</span></span><br><span class="line">    RELEASE(item);</span><br><span class="line">    <span class="comment">// æŒæœ‰timer</span></span><br><span class="line">    [loop addTimer:item-&gt;timer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†è¿™äº›äº‹:</p><ol><li>è·å–å½“å‰çº¿ç¨‹çš„Runloopå¯¹è±¡ã€‚</li><li>æ ¹æ®æ–¹æ³•åã€æ–¹æ³•å‚æ•°ã€æ–¹æ³•è°ƒç”¨è€…åŠå»¶è¿Ÿæ—¶é—´ç­‰ä¿¡æ¯åˆ›å»ºä¸€ä¸ª<code>GSTimedPerformer</code>å¯¹è±¡ï¼ŒæŠŠè¯¥å¯¹è±¡æ·»åŠ åˆ°Runloopçš„<code>_timedPerformers</code>æ•°ç»„ä¸­ä¿å­˜ã€‚</li><li>æŠŠGSTimedPerformerä¸­çš„å®šæ—¶å™¨timeræ·»åŠ åˆ°Runloopä¸­ã€‚</li></ol><p>å¦‚å®˜æ–¹æ–‡æ¡£æ‰€è¯´:This method sets up a timer to perform the aSelector message on the current threadâ€™s run loop. The timer is configured to run in the default mode (NSDefaultRunLoopMode). When the timer fires, the thread attempts to dequeue the message from the run loop and perform the selector. It succeeds if the run loop is running and in the default mode; otherwise, the timer waits until the run loop is in the default mode.</p><p>çœ‹çœ‹GSTimedPerformeråšäº†ä»€ä¹ˆ:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GSTimedPerformer</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="keyword">@public</span></span><br><span class="line">  SEL selector;</span><br><span class="line">  <span class="keyword">id</span> target;</span><br><span class="line">  <span class="keyword">id</span> argument;</span><br><span class="line">  <span class="built_in">NSTimer</span> *timer;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)fire;</span><br><span class="line">- (<span class="keyword">id</span>)initWithSelector:(SEL)aSelector</span><br><span class="line">                target:(<span class="keyword">id</span>)target</span><br><span class="line">              argument:(<span class="keyword">id</span>)argument</span><br><span class="line">                 delay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br><span class="line">- (<span class="keyword">void</span>)invalidate;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">GSTimedPerformer</span></span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span> finalize];</span><br><span class="line">    TEST_RELEASE(timer);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾targetå¯¹è±¡</span></span><br><span class="line">    RELEASE(target);</span><br><span class="line">    RELEASE(argument);</span><br><span class="line">    [<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)finalize &#123;</span><br><span class="line">    [<span class="keyword">self</span> invalidate];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fire &#123;</span><br><span class="line">    DESTROY(timer);</span><br><span class="line">    [target performSelector:selector withObject:argument];</span><br><span class="line">    [[[<span class="built_in">NSRunLoop</span> currentRunLoop] _timedPerformers] removeObjectIdenticalTo:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithSelector:(SEL)aSelector</span><br><span class="line">                target:(<span class="keyword">id</span>)aTarget</span><br><span class="line">              argument:(<span class="keyword">id</span>)anArgument</span><br><span class="line">                 delay:(<span class="built_in">NSTimeInterval</span>)delay &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> != <span class="literal">nil</span>) &#123;</span><br><span class="line">        selector = aSelector;</span><br><span class="line">        <span class="comment">// æŒæœ‰target</span></span><br><span class="line">        target = RETAIN(aTarget);</span><br><span class="line">        argument = RETAIN(anArgument);</span><br><span class="line">        timer = [[<span class="built_in">NSTimer</span> allocWithZone:<span class="built_in">NSDefaultMallocZone</span>()]</span><br><span class="line">                 initWithFireDate:<span class="literal">nil</span></span><br><span class="line">                 interval:delay</span><br><span class="line">                 target:<span class="keyword">self</span></span><br><span class="line">                 selector:<span class="keyword">@selector</span>(fire)</span><br><span class="line">                 userInfo:<span class="literal">nil</span></span><br><span class="line">                 repeats:<span class="literal">NO</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)invalidate &#123;</span><br><span class="line">    <span class="keyword">if</span> (timer != <span class="literal">nil</span>) &#123;</span><br><span class="line">        [timer invalidate];</span><br><span class="line">        DESTROY(timer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>The GSTimedPerformer class is used to hold information about messages which are due to be sent to objects at a particular time.</p><p>å¯è§ï¼Œ<code>GSTimedPerformer</code>ä½œç”¨å°±æ˜¯ä¿å­˜å…³äºæ¶ˆæ¯çš„ä¿¡æ¯ï¼Œå…·ä½“æ–¹æ³•çš„å»¶è¿Ÿå’Œè°ƒç”¨ä¸»è¦è¿˜æ˜¯ä¾é å…¶å†…éƒ¨çš„å®šæ—¶å™¨ã€‚åˆ†ææºç å¯çŸ¥ï¼ŒRunloopçš„<code>_timedPerformers</code>æ•°ç»„æŒæœ‰äº†<code>GSTimedPerformer</code>ï¼ŒRunloopè¿˜æŒæœ‰<code>GSTimedPerformer</code>å†…éƒ¨çš„å®šæ—¶å™¨<code>timer</code>ï¼Œå®šæ—¶å™¨<code>timer</code>æŒæœ‰ç€<code>target(self)</code>ã€‚è€Œ<code>GSTimedPerformer</code>æŒæœ‰ç€<code>target(self)</code>å’Œå®šæ—¶å™¨<code>timer</code>ã€‚</p><p>å¼•ç”¨å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š<br><img src="https://image.chenyalun.com/2018/09/30/002.png" style="zoom:40%"></p><p>å½“è®¾ç½®çš„æ—¶é—´åˆ°çš„æ—¶å€™ï¼Œ<code>GSTimedPerformer</code>å†…éƒ¨çš„<code>fire</code>æ–¹æ³•å¾—åˆ°è°ƒç”¨ï¼Œæ­¤æ—¶å¤–ç•Œçš„<code>target</code>ä¾¿è°ƒç”¨äº†è¢«è®¾ç½®çš„<code>selector</code>ï¼Œèµ·åˆ°äº†å»¶è¿Ÿæ‰§è¡Œçš„æ•ˆæœã€‚ç´§æ¥ç€ï¼ŒRunloopçš„<code>_timedPerformers</code>æ•°ç»„ç§»é™¤äº†å¯¹<code>GSTimedPerformer</code>çš„å¼•ç”¨ï¼Œ<code>GSTimedPerformer</code>è‡ªç„¶ä¼šé”€æ¯ï¼Œå®ƒçš„<code>dealloc</code>æ–¹æ³•å¾—åˆ°è°ƒç”¨ã€‚è€Œ<code>GSTimedPerformer</code>ä¸­çš„<code>dealloc</code>å†…éƒ¨è°ƒç”¨äº†<code>finalize</code>æ–¹æ³•ï¼Œ<code>finalize</code>æ–¹æ³•çš„ç›®çš„æ˜¯<code>invalidate</code>æ‰å®šæ—¶å™¨<code>timer</code>å¹¶å‡å°‘å®ƒçš„å¼•ç”¨è®¡æ•°ã€‚æ­¤æ—¶ï¼Œ<code>timer</code>åªæœ‰RunloopæŒæœ‰ç€å®ƒäº†ï¼Œå…³é”®æ˜¯timerä¸€æ—¦è¢«<code>invalidate</code>ï¼ŒRunloopä¹Ÿä¸ä¼šå†æŒæœ‰å®ƒäº†ï¼ˆTimers are removed automatically when they are invalidï¼‰ã€‚è¿™æ ·ï¼Œ<code>timer</code>å½»åº•æ­»æ‰ï¼Œå¯¹<code>target</code>çš„å¼ºå¼•ç”¨ä¹Ÿæ²¡æœ‰äº†ï¼Œä¸€åˆ‡æ¢å¤å¦‚åˆã€‚</p><p>è¿™ä¸€åˆ‡çš„å‰æå»ºç«‹åœ¨Runloopè¿è¡Œåœ¨<code>NSDefaultRunLoopMode</code>æ¨¡å¼ä¸‹å¹¶é¡ºåˆ©è°ƒç”¨<code>fire</code>æ–¹æ³•ã€‚<strong>å½“å»¶è¿Ÿæ–¹æ³•å› ç§ç§åŸå› æ²¡æœ‰æ‰§è¡Œå°±å¯èƒ½å‡ºç°å†…å­˜æ³„éœ²ã€‚</strong></p><p>å¾ˆç»å…¸çš„ä¾‹å­ï¼šä»Aæ§åˆ¶å™¨pushåˆ°Bæ§åˆ¶å™¨ï¼ŒBæ§åˆ¶å™¨æ­¤æ—¶æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼š<code>[self performSelector:@selector(printInfo) withObject:nil afterDelay:100];</code>ã€‚æ­¤æ—¶ä»Bæ§åˆ¶å™¨popåˆ°Aæ§åˆ¶å™¨ï¼Œå¾ˆæ˜æ˜¾Bæ§åˆ¶å™¨å¹¶æ²¡æœ‰é”€æ¯ï¼Œå› ä¸ºRunloopè¿˜ï¼ˆé—´æ¥ï¼‰å¼ºå¼•ç”¨ç€å®ƒï¼Œå¯ä»¥ç†è§£ä¸ºå‡ºç°äº†å†…å­˜æ³„éœ²(å°½ç®¡100så<code>printInfo</code>æ–¹æ³•å¾—åˆ°æ‰§è¡Œï¼ŒBæ§åˆ¶å™¨ä¼šé”€æ¯)ã€‚</p><blockquote><p>performSelectorå…³äºå†…å­˜ç®¡ç†çš„æ‰§è¡ŒåŸç†æ˜¯è¿™æ ·çš„æ‰§è¡Œ [self performSelector:@selector(method1:) withObject:self afterDelay:3]; çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°†selfçš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ‰§è¡Œå®Œè¿™ä¸ªæ–¹æ³•æ—¶ï¼Œè¿˜ä¼šå°†selfçš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå½“æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦è¿”å›çˆ¶è§†å›¾é‡Šæ”¾å½“å‰è§†å›¾çš„æ—¶å€™ï¼Œselfçš„è®¡æ•°æ²¡æœ‰å‡å°‘åˆ°0ï¼Œè€Œå¯¼è‡´æ— æ³•è°ƒç”¨deallocæ–¹æ³•ï¼Œå‡ºç°äº†å†…å­˜æ³„éœ²ã€‚ </p></blockquote><p><img src="https://image.chenyalun.com/2018/09/30/001.png" style="zoom:60%"></p><p>æ¯”è¾ƒå¥½çš„åšæ³•æ˜¯åŠæ—¶å–æ¶ˆæ‰ä¹‹å‰çš„å»¶è¿Ÿè°ƒç”¨:<code>cancelPreviousPerformRequestsWithTarget: selector:object:</code>ï¼Œé‚£ä¹ˆ<code>cancelPreviousPerformRequestsWithTarget: selector:object:</code>åšäº†ä»€ä¹ˆå‘¢?</p><p><span id="jump1"></span></p><h3 id="cancelPreviousPerformRequestsWithTarget-selector-object"><a href="#cancelPreviousPerformRequestsWithTarget-selector-object" class="headerlink" title="cancelPreviousPerformRequestsWithTarget: selector:object:"></a>cancelPreviousPerformRequestsWithTarget: selector:object:</h3><figure class="highlight scheme"><table><tr><td class="code"><pre><span class="line">[<span class="name">NSObject</span> cancelPreviousPerformRequestsWithTarget:self]<span class="comment">;</span></span><br><span class="line">[<span class="name">NSObject</span> cancelPreviousPerformRequestsWithTarget:self selector:NSSelectorFromString(<span class="name">@</span><span class="string">"printString:"</span>) object:@<span class="string">"str"</span>]<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å–æ¶ˆperformå»¶è¿Ÿè°ƒç”¨ï¼Œå®ƒä»¬å†…éƒ¨åšäº†ä»€ä¹ˆï¼Ÿ</p><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">+ (void)cancelPreviousPerformRequestsWithTarget:(id)targe</span><br><span class="line">                                       selector:(SEL)aSelector</span><br><span class="line">                                         object:(id)arg &#123;</span><br><span class="line">    NSMutableArray *perf = [[NSRunLoop currentRunLoop] _timedPerformers];</span><br><span class="line">    unsigned <span class="built_in">count</span> = [perf <span class="built_in">count</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        GSTimedPerformer *array[<span class="built_in">count</span>];</span><br><span class="line">        IF_NO_GC(RETAIN(<span class="keyword">target</span>));</span><br><span class="line">        IF_NO_GC(RETAIN(arg));</span><br><span class="line">        [perf getObjects: array];</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">count</span>-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            // éå†æŸ¥æ‰¾</span><br><span class="line">            GSTimedPerformer *p = array[<span class="built_in">count</span>];</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;<span class="keyword">target</span> == <span class="keyword">target</span> &amp;&amp; sel_isEqual(p-&gt;selector, aSelector)</span><br><span class="line">                &amp;&amp; (p-&gt;argument == arg || [p-&gt;argument isEqual:arg])) &#123;</span><br><span class="line">                // <span class="keyword">target</span>\sel\argumentå‡ä¸€è‡´</span><br><span class="line">                [p invalidate];</span><br><span class="line">                [perf removeObjectAtIndex: <span class="built_in">count</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(arg);</span><br><span class="line">        RELEASE(<span class="keyword">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è·å–Runloopå†…éƒ¨æŒæœ‰çš„<code>_timedPerformers</code>æ•°ç»„(æ•°ç»„ä¸­çš„æ˜¯<code>GSTimedPerformer</code>å¯¹è±¡)ã€‚</li><li>åˆ›å»ºä¸€ä¸ªCè¯­è¨€æ•°ç»„ï¼Œå¹¶æŠŠ<code>_timedPerformers</code>æ•°ç»„ä¸­çš„å†…å®¹copyåˆ°è¿™ä¸ªCè¯­è¨€æ•°ç»„arrayã€‚</li><li>éå†è¯¥Cè¯­è¨€æ•°ç»„arrayï¼šå¦‚æœç»™å®šå‚æ•°ä¸­çš„<code>target</code>ã€<code>argument</code>ã€<code>selector</code>å‡<strong>ä¸€ä¸€å¯¹åº”</strong>ï¼Œé‚£ä¹ˆé”€æ¯<code>GSTimedPerformer</code>å¯¹è±¡ä¸­çš„å®šæ—¶å™¨ï¼Œå¹¶æ ¹æ®å½“å‰çš„ç´¢å¼•ç§»é™¤<code>_timedPerformers</code>æ•°ç»„çš„<code>GSTimedPerformer</code>å¯¹è±¡ã€‚</li></ol><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœ<code>target</code>ã€<code>argument</code>ã€<code>selector</code>ä¸­æœ‰ä¸€ä¸ªå‚æ•°æ²¡æœ‰å¯¹åº”ï¼Œé‚£ä¹ˆä¾¿ä¸ä¼šæ‰§è¡Œé”€æ¯å®šæ—¶å™¨æ“ä½œå’Œç§»é™¤æ“ä½œã€‚é‚£ä¹ˆï¼Œåˆ¤å®š<code>target</code>ã€<code>argument</code>ã€<code>selector</code>å‡ä¸€ä¸€å¯¹åº”çš„æ ‡å‡†æ˜¯ï¼šMatching of the argument may be either by pointer equality or by use of the [NSObject -isEqual:] method.å°±æ˜¯æŒ‡é’ˆæ¯”è¾ƒä»¥åŠ<code>isEqual</code>æ–¹æ³•ã€‚</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span>(p-&gt;</span>target == target </span><br><span class="line">&amp;&amp; <span class="function"><span class="title">sel_isEqual</span>(p-&gt;</span>selector, aSelector)</span><br><span class="line">&amp;&amp; (<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">argument</span> == arg || [p-&gt;</span>argument isEqual:arg])) </span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œçš„<code>sel_isEqual</code>å°±ç­‰ä»·äº<code>==</code>ï¼Œå¤šè¯´ä¸€å¥ï¼Œ<code>SEL</code>å®é™…ä¸Šå°±æ˜¯æ ¹æ®æ–¹æ³•åhashåŒ–äº†çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆ<code>char *</code>ï¼‰ï¼Œå¯¹äºå­—ç¬¦ä¸²çš„æ¯”è¾ƒåªè¦æ¯”è¾ƒåœ°å€å°±å¯ä»¥äº†ã€‚</p><p>åŒç†ï¼Œ<code>+ (void)cancelPreviousPerformRequestsWithTarget:(id)target</code>æ–¹æ³•å®ç°åŸç†ä¸ä¸Šé¢çš„æ–¹æ³•ç±»ä¼¼ï¼Œåªæ˜¯ä¸ç”¨æ¯”è¾ƒ<code>argument</code>å’Œ<code>selector</code>å‚æ•°ï¼ŒæŠŠ<code>target</code>æœ‰å…³çš„æ‰€æœ‰å®šæ—¶å™¨éƒ½é”€æ¯ï¼Œå¹¶æŠŠæ‰€æœ‰ä¸ä¹‹ç›¸å…³çš„<code>GSTimedPerformer</code>å¯¹è±¡éƒ½ä»<code>_timedPerformers</code>æ•°ç»„ä¸­ç§»é™¤ã€‚<br><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="built_in">count</span>-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">   GSTimedPerformer *p = array[<span class="built_in">count</span>];</span><br><span class="line">   <span class="keyword">if</span> (p-&gt;<span class="keyword">target</span> == <span class="keyword">target</span>) &#123;</span><br><span class="line">       [p invalidate];</span><br><span class="line">       [perf removeObjectAtIndex:<span class="built_in">count</span>];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“æ‰‹åŠ¨é”€æ¯å®šæ—¶å™¨å¹¶æŠŠ<code>GSTimedPerformer</code>ä»Runloopä¸­ç§»é™¤æ—¶ï¼Œå®šæ—¶å™¨å¯¹<code>target</code>çš„å¼ºå¼•ç”¨ä¸å­˜åœ¨ï¼›<code>GSTimedPerformer</code>é”€æ¯ï¼Œ<code>GSTimedPerformer</code>å¯¹<code>target</code>çš„å¼ºå¼•ç”¨ä¹Ÿä¸å­˜åœ¨ï¼Œè¿™æ ·ï¼Œå†…å­˜æ³„éœ²é—®é¢˜è§£å†³äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨<code>cancelPreviousPerformRequestsWithTarget</code>å–æ¶ˆè¿˜æ²¡æœ‰æ‰§è¡Œçš„performå°±å¯ä»¥è§£å†³<code>target</code>æ— æ³•é‡Šæ”¾æ‰çš„åŸå› ã€‚</p><h2 id="æ¨¡å¼"><a href="#æ¨¡å¼" class="headerlink" title="æ¨¡å¼"></a>æ¨¡å¼</h2><p><span id="jump2"></span></p><h3 id="performSelector-target-argument-order-modes"><a href="#performSelector-target-argument-order-modes" class="headerlink" title="performSelector:target:argument:order:modes:"></a>performSelector:target:argument:order:modes:</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector target:(<span class="keyword">id</span>)target argument:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg order:(<span class="built_in">NSUInteger</span>)order modes:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSRunLoopMode</span>&gt; *)modes;</span><br><span class="line">- (<span class="keyword">void</span>)cancelPerformSelector:(SEL)aSelector target:(<span class="keyword">id</span>)target argument:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg;</span><br><span class="line">- (<span class="keyword">void</span>)cancelPerformSelectorsWithTarget:(<span class="keyword">id</span>)target;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çœ‹<code>performSelector:target:argument:order:modes:</code>æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>Sets up sending of aSelector to target with argument. The selector is sent before the next runloop iteration (unless cancelled before then) in any of the specified modes.The target and argument objects are retained.<br>The order value is used to determine the order in which messages are sent if multiple messages have been set up. Messages with a lower order value are sent first.If the modes array is empty, this method has no effect.<br>è¯´çš„å¾ˆæ˜ç™½äº†ï¼Œå°±æ˜¯åœ¨æŒ‡å®šæ¨¡å¼çš„Runloopä¸‹ä¸€æ¬¡è¿­ä»£ä¹‹å‰æŠŠselectorã€argumentç­‰ä¿¡æ¯ä¸¢ç»™targetï¼Œä»¥ä¾¿è°ƒç”¨ã€‚è¿™é‡Œçš„<code>order</code>æŒ‡å®šäº†è¿™ä¸ªè°ƒç”¨çš„ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ï¼Œè¶Šæ—©è¢«è°ƒç”¨ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector</span><br><span class="line">                 target:(<span class="keyword">id</span>)target</span><br><span class="line">               argument:(<span class="keyword">id</span>)argument</span><br><span class="line">                  order:(<span class="built_in">NSUInteger</span>)order</span><br><span class="line">                  modes:(<span class="built_in">NSArray</span> *)modes &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> count = [modes count];</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *array[count];</span><br><span class="line">        GSRunLoopPerformer *item;</span><br><span class="line">        item = [[GSRunLoopPerformer alloc] initWithSelector:aSelector</span><br><span class="line">                                                     target:target</span><br><span class="line">                                                   argument:argument</span><br><span class="line">                                                      order:order];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠmodesä¸­çš„å†…å®¹copyåˆ°array</span></span><br><span class="line">        <span class="keyword">if</span> ([modes isProxy]) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                array[i] = [modes objectAtIndex:i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [modes getObjects:array];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰mode</span></span><br><span class="line">        <span class="keyword">while</span> (count-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *mode = array[count];</span><br><span class="line">            <span class="keyword">unsigned</span> end;</span><br><span class="line">            <span class="keyword">unsigned</span> i;</span><br><span class="line">            GSRunLoopCtxt *context;</span><br><span class="line">            GSIArray performers;</span><br><span class="line">            </span><br><span class="line">            context = <span class="built_in">NSMapGet</span>(_contextMap, mode);</span><br><span class="line">            <span class="keyword">if</span> (context == <span class="literal">nil</span>) &#123;</span><br><span class="line">                context = [[GSRunLoopCtxt alloc] initWithMode:mode extra:_extra];</span><br><span class="line">                <span class="built_in">NSMapInsert</span>(_contextMap, context-&gt;mode, context);</span><br><span class="line">                RELEASE(context);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–RunloopæŸä¸ªmodeä¸‹å¯¹åº”çš„contextä¸­çš„performers</span></span><br><span class="line">            performers = context-&gt;performers;</span><br><span class="line">            <span class="comment">// performersçš„æ•°é‡</span></span><br><span class="line">            end = GSIArrayCount(performers);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">                <span class="comment">// éå†æ•´ä¸ªperformersæ•°ç»„</span></span><br><span class="line">                GSRunLoopPerformer *p;</span><br><span class="line">                p = GSIArrayItemAtIndex(performers, i).obj;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;order &gt; order) &#123;</span><br><span class="line">                    <span class="comment">// æ–°æ·»åŠ è¿›æ¥çš„itemçš„ä¼˜å…ˆçº§é«˜äºå½“å‰ç´¢å¼•iå¯¹åº”itemçš„ä¼˜å…ˆçº§, æ’å…¥</span></span><br><span class="line">                    GSIArrayInsertItem(performers, (GSIArrayItem)((<span class="keyword">id</span>)item), i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ç§å¯èƒ½: iå’Œendéƒ½ä¸º0, performersæ•°ç»„ä¸ºç©º, ä¸Šé¢çš„forå¾ªç¯æ²¡æœ‰æ‰§è¡Œ</span></span><br><span class="line">            <span class="comment">// ç¬¬äºŒç§å¯èƒ½: æ–°æ·»åŠ è¿›æ¥çš„itemçš„ä¼˜å…ˆçº§æœ€ä½, ä¸Šé¢çš„forå¾ªç¯æ²¡æœ‰æ‰§è¡Œ, æŠŠå®ƒæ·»åŠ åˆ°æ•°ç»„çš„æœ€åä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> (i == end) &#123;</span><br><span class="line">                GSIArrayInsertItem(performers, (GSIArrayItem)((<span class="keyword">id</span>)item), i);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            i = GSIArrayCount(performers);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span> &amp;&amp; i &gt; context-&gt;maxPerformers) &#123;</span><br><span class="line">                <span class="comment">// æ›´æ–°contextä¸­çš„performeræœ€å¤§æ•°é‡</span></span><br><span class="line">                context-&gt;maxPerformers = i;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"WARNING ... there are %u performers scheduled"</span></span><br><span class="line">                      <span class="string">@" in mode %@ of %@\n(Latest: [%@ %@])"</span>,</span><br><span class="line">                      i, mode, <span class="keyword">self</span>, <span class="built_in">NSStringFromClass</span>([target <span class="keyword">class</span>]),</span><br><span class="line">                      <span class="built_in">NSStringFromSelector</span>(aSelector));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ–¹æ³•å®ç°æ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•åšäº†è¿™äº›äº‹:</p><ol><li>å¦‚æœæ•°ç»„modesä¸­æ²¡æœ‰å†…å®¹å°±ç›´æ¥returnã€‚</li><li>æŠŠ<code>target</code>ã€<code>argument</code>ã€<code>selector</code>ã€<code>order</code>ç­‰ä¿¡æ¯åŒ…è£…æˆä¸€ä¸ª<code>GSRunLoopPerformer</code>å¯¹è±¡ã€‚</li><li>åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„arrayï¼ŒæŠŠmodesä¸­çš„å†…å®¹copyåˆ°arrayã€‚</li><li>éå†arrayã€‚æ‰¾åˆ°æ¯ä¸€ç§mode(<code>NSString</code>ç±»å‹)åœ¨<code>_contextMap</code>(<code>NSMapTable</code>ç±»å‹)è¡¨ä¸­å¯¹åº”çš„context(<code>GSRunLoopCtxt</code>ç±»å‹)ï¼Œè·å¾—contextä¸­éœ€è¦æ‰§è¡Œçš„performers(<code>GSIArray</code>ç±»å‹)æ•°ç»„ã€‚</li><li>éå†åŸæ¥çš„performersæ•°ç»„ï¼Œæ ¹æ®ç¬¬2æ­¥ä¸­åŒ…è£…å¥½çš„<code>GSRunLoopPerformer</code>å¯¹è±¡çš„ä¼˜å…ˆçº§orderï¼Œæ’å…¥åˆ°performersä¸­çš„åˆé€‚ä½ç½®ã€‚</li></ol><p>æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯æŠŠ<code>target</code>ã€<code>argument</code>ã€<code>selector</code>ã€<code>order</code>ç­‰ä¿¡æ¯åŒ…è£…æˆä¸€ä¸ª<code>GSRunLoopPerformer</code>å¯¹è±¡ï¼Œå¹¶æŠŠè¯¥å¯¹è±¡æ·»åŠ åˆ°Runloopï¼ˆä¸­çš„<code>_contextMap</code>ï¼‰é‡Œé¢çš„performersï¼Œä¾›å…¶åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ã€‚å…·ä½“å•¥æ—¶å€™è°ƒç”¨å‘¢ï¼Ÿå®˜æ–¹æ–‡æ¡£è¯´æ˜¯Runloopçš„ä¸‹ä¸€æ¬¡è¿­ä»£çš„æ—¶å€™ã€‚</p><p>è‡ªä¸å¿…è¯´ï¼Œ<code>cancelPerformSelector:target:argument:</code>å°±æ˜¯æ ¹æ®<code>selector</code>ã€<code>target</code>å’Œ<code>argument</code>ç§»é™¤performersæ•°ç»„ä¸­çš„<code>GSRunLoopPerformer</code>ã€‚è¦æ±‚ä¸‰è€…å®Œå…¨å¯¹åº”ã€‚<br><code>cancelPerformSelector:target:</code>æ˜¯æ ¹æ®<code>selector</code>ã€<code>target</code>ç§»é™¤performersæ•°ç»„ä¸­ç›¸å…³çš„æ‰€æœ‰çš„<code>GSRunLoopPerformer</code>å¯¹è±¡ã€‚åŸç†ä¸ä¸Šæ–‡ä¸­æ‰€è¯´çš„<a href="#jump1">cancelPreviousPerformRequestsWithTarget:</a>åŸºæœ¬ä¸€è‡´ã€‚</p><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><h3 id="performSelector-onThread-withObject-waitUntilDone-modes"><a href="#performSelector-onThread-withObject-waitUntilDone-modes" class="headerlink" title="performSelector:onThread:withObject:waitUntilDone:modes:"></a>performSelector:onThread:withObject:waitUntilDone:modes:</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelectorOnMainThread:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait modes:(<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)array;</span><br><span class="line"><span class="comment">// equivalent to the first method with kCFRunLoopCommonModes</span></span><br><span class="line">- (<span class="keyword">void</span>)performSelectorOnMainThread:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector onThread:(<span class="built_in">NSThread</span> *)thr withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait modes:(<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)array;</span><br><span class="line"><span class="comment">// equivalent to the first method with kCFRunLoopCommonModes</span></span><br><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector onThread:(<span class="built_in">NSThread</span> *)thr withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)performSelectorInBackground:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ–¹æ³•ä¸ç¬¬ä¸€ä¸ªæ–¹æ³•å¯¹åº”ï¼Œå…¶modesæ˜¯<code>kCFRunLoopCommonModes</code>ï¼Œselectoråœ¨ä¸»çº¿ç¨‹æ‰§è¡Œã€‚<br>ç¬¬å››ä¸ªæ–¹æ³•ä¸ç¬¬ä¸‰ä¸ªæ–¹æ³•å¯¹åº”ï¼Œå…¶modesæ˜¯<code>kCFRunLoopCommonModes</code>ï¼Œselectoråœ¨æŒ‡å®šçš„å­çº¿ç¨‹æ‰§è¡Œã€‚<br>ç¬¬äº”ä¸ªæ–¹æ³•çœç•¥å¾ˆå¤šå‚æ•°ï¼Œselectoråœ¨å†…ç½®çš„å­çº¿ç¨‹æ‰§è¡Œã€‚</p><p>å…ˆåˆ†æç¬¬å››ä¸ªæ–¹æ³•å³å¯ã€‚å…·ä½“çš„å®ç°å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector</span><br><span class="line">               onThread:(<span class="built_in">NSThread</span> *)aThread</span><br><span class="line">             withObject:(<span class="keyword">id</span>)anObject</span><br><span class="line">          waitUntilDone:(<span class="built_in">BOOL</span>)aFlag</span><br><span class="line">                  modes:(<span class="built_in">NSArray</span>*)anArray &#123;</span><br><span class="line">    GSRunLoopThreadInfo  *info;</span><br><span class="line">    <span class="built_in">NSThread</span> *t;</span><br><span class="line">    <span class="keyword">if</span> ([anArray count] == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    t = GSCurrentThread();</span><br><span class="line">    <span class="keyword">if</span> (aThread == <span class="literal">nil</span>) aThread = t;</span><br><span class="line">    info = GSRunLoopInfoForThread(aThread);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (t == aThread) &#123;</span><br><span class="line">        <span class="comment">// Perform in current thread.</span></span><br><span class="line">        <span class="keyword">if</span> (aFlag == <span class="literal">YES</span> || info-&gt;loop == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="comment">// Wait until done or no run loop.</span></span><br><span class="line">            [<span class="keyword">self</span> performSelector:aSelector withObject:anObject];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Don't wait ... schedule operation in run loop.</span></span><br><span class="line">            [info-&gt;loop performSelector:aSelector</span><br><span class="line">                                 target:<span class="keyword">self</span></span><br><span class="line">                               argument:anObject</span><br><span class="line">                                  order:<span class="number">0</span></span><br><span class="line">                                  modes:anArray];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        GSPerformHolder *h;</span><br><span class="line">        <span class="built_in">NSConditionLock</span> *l = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹Finishedåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> ([aThread isFinished] == <span class="literal">YES</span>) &#123;</span><br><span class="line">            [<span class="built_in">NSException</span> raise: <span class="built_in">NSInternalInconsistencyException</span></span><br><span class="line">                        format: <span class="string">@"perform on finished thread"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜»å¡ç­‰å¾…åŠ é”</span></span><br><span class="line">        <span class="keyword">if</span> (aFlag == <span class="literal">YES</span>) &#123;</span><br><span class="line">            l = [[<span class="built_in">NSConditionLock</span> alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        h = [GSPerformHolder newForReceiver:<span class="keyword">self</span></span><br><span class="line">                                   argument:anObject</span><br><span class="line">                                   selector:aSelector</span><br><span class="line">                                      modes:anArray</span><br><span class="line">                                       lock:l];</span><br><span class="line">        [info addPerformer:h];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶é”åˆ›å»ºæˆåŠŸ(ä¹Ÿå³å‚æ•°aFlagä¸ºYES)</span></span><br><span class="line">        <span class="keyword">if</span> (l != <span class="literal">nil</span>) &#123;</span><br><span class="line">            [l lockWhenCondition:<span class="number">1</span>]; <span class="comment">// å½“æ¡ä»¶ä¸º1æ—¶åŠ é”</span></span><br><span class="line">            [l unlock];</span><br><span class="line">            RELEASE(l);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// holderå·²ç»å¤±æ•ˆåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> ([h isInvalidated] == <span class="literal">YES</span>) &#123;</span><br><span class="line">                RELEASE(h);</span><br><span class="line">                [<span class="built_in">NSException</span> raise: <span class="built_in">NSInternalInconsistencyException</span></span><br><span class="line">                            format: <span class="string">@"perform on finished thread"</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// holderè‡ªèº«å°±äº§ç”Ÿexceptionäº†, é‚£ä¹ˆå†æ¬¡æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="comment">// If we have an exception passed back from the remote thread, re-raise it.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">nil</span> != h-&gt;exception) &#123;</span><br><span class="line">                <span class="built_in">NSException</span> *e = AUTORELEASE(RETAIN(h-&gt;exception));</span><br><span class="line">                RELEASE(h);</span><br><span class="line">                [e raise];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(h);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†è¿™äº›ä»€ä¹ˆ?</p><ol><li>é¦–å…ˆå¯¹ä¼ è¿›æ¥çš„<code>modes</code>(Runloopæ¨¡å¼æ•°ç»„)ä¸ªæ•°è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸º0ï¼Œåˆ™ç›´æ¥returnã€‚</li><li>è·å–è¯¥æ–¹æ³•æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„çº¿ç¨‹ï¼š <code>t</code>ï¼Œå¹¶æŠŠå®ƒä¸ä½œä¸ºå‚æ•°ä¼ è¿›æ¥çš„çº¿ç¨‹<code>aThread</code>è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹æ˜¯å¦ä¸€è‡´ã€‚å½“ç„¶ï¼Œå¦‚æœä¼ è¿›æ¥çš„<code>aThread</code>ä¸ºç©ºï¼Œé‚£ä¹ˆæ‰§è¡Œ<code>aThread = t;</code>ï¼Œå°±è®©<code>selector</code>åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li><li>å½“ä¸¤ä¸ªçº¿ç¨‹ä¸€è‡´æ—¶ï¼Œå¦‚æœå‚æ•°<code>aFlag</code>ä¸ºYESæˆ–è€…çº¿ç¨‹å¯¹åº”çš„Runloopä¸ºç©ºï¼Œè¯´æ˜éœ€è¦ç­‰å¾…ï¼Œä¹Ÿå³è¿™ä¸ªæ–¹æ³•åº”è¯¥ç­‰åˆ°selectorè¢«æ‰§è¡Œå®Œæ¯•åå†returnã€‚è¿™å°±å¥½åŠäº†ï¼Œç›´æ¥è°ƒç”¨<code>[self performSelector: aSelector withObject: anObject];</code>æ–¹æ³•ï¼ŒåŒæ­¥æ‰§è¡Œå³å¯ã€‚å¦‚æœä¸éœ€è¦ç­‰å¾…å‘¢? æŠŠ<code>selector</code>ã€<code>argument</code>ã€<code>modes</code>ç­‰ä¿¡æ¯äº¤ç»™çº¿ç¨‹å¯¹åº”çš„Runloopå†è¿›ä¸€æ­¥å¤„ç†ï¼ˆschedule operation in run loopï¼‰ã€‚</li><li>å½“ä¸¤ä¸ªçº¿ç¨‹ä¸ä¸€è‡´æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­<code>aThread</code>æœ‰æ²¡æœ‰<code>finished</code>ï¼Œçº¿ç¨‹æ­»äº†è‡ªç„¶<code>selector</code>æ— æ³•æ‰§è¡Œï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚å†è€…åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ç­‰å¾…ï¼Œå¦‚æœéœ€è¦çš„è¯å°±åˆ›å»ºä¸€ä¸ªæ¡ä»¶é”ã€‚æ¥ç€æŠŠ<code>selector</code>ã€<code>argument</code>ã€<code>modes</code>åŠæ¡ä»¶é”ç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ª<code>GSPerformHolder</code>å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒäº¤ç»™å°è£…çº¿ç¨‹ä¿¡æ¯çš„<code>GSRunLoopThreadInfo</code>å¯¹è±¡ã€‚ä¹‹åæ˜¯ä¸€äº›æ”¶å°¾å·¥ä½œï¼šè®¾ç½®æ¡ä»¶é”çš„conditionåŠä¸€äº›å¼‚å¸¸åˆ¤æ–­ã€‚</li></ol><p>éœ€è¦ç€é‡è¯´æ˜çš„æ˜¯å‚æ•°<code>aFlag</code>ï¼š æ˜¯å¦ç«‹å³è¿”å›ã€‚å¦‚æœå‚æ•°<code>aFlag</code>ä¸ºYESï¼Œåˆ™è¿™ä¸ªæ–¹æ³•åº”è¯¥ç­‰åˆ°<code>selector</code>è¢«æ‰§è¡Œå®Œæ¯•åå†returnã€‚å¦‚æœ<code>selector</code>æ˜¯åœ¨å½“å‰æ–¹æ³•ä¸Šä¸‹æ–‡çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸”è¯¥çº¿ç¨‹å¯¹åº”çš„Runloopæ²¡æœ‰runï¼Œé‚£ä¹ˆä¼šå¿½ç•¥<code>modes</code>ï¼Œç›´æ¥æ‰§è¡Œï¼š<code>performSelector:aSelector withObject:</code>ã€‚</p><p>å½“ä¸¤ä¸ªçº¿ç¨‹ä¸€è‡´æ—¶ï¼Œä¹Ÿå³<code>selector</code>æ‰§è¡Œçš„çº¿ç¨‹å°±æ˜¯å½“å‰æ–¹æ³•ä¸Šä¸‹æ–‡ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ¯”è¾ƒå¥½å¤„ç†ï¼ŒæŠŠ<code>selector</code>ã€<code>argument</code>ã€<code>modes</code>ç­‰ä¿¡æ¯äº¤ç»™çº¿ç¨‹å¯¹åº”çš„Runloopå³å¯ï¼Œå°±æ˜¯æ¨¡å¼ä¸­çš„æ–¹æ³•ï¼š<a href="#jump2">performSelector:target:argument:order:modes:</a>ã€‚</p><p><strong>GSPerformHolder</strong></p><p>ä¸¤ä¸ªçº¿ç¨‹ä¸ä¸€è‡´æ—¶ï¼Œâ€œæŠŠ<code>selector</code>ã€<code>argument</code>ã€<code>modes</code>åŠæ¡ä»¶é”ç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ª<code>GSPerformHolder</code>å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒäº¤ç»™å°è£…çº¿ç¨‹ä¿¡æ¯çš„<code>GSRunLoopThreadInfo</code>å¯¹è±¡â€åˆæ˜¯æ€ä¹ˆåšçš„å‘¢?</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">(GSPerformHolder</span> <span class="string">*)h</span> <span class="string">=</span> <span class="string">[GSPerformHolder</span> <span class="attr">newForReceiver:self</span></span><br><span class="line"><span class="attr">                                             argument:</span><span class="string">anObject</span></span><br><span class="line"><span class="attr">                                             selector:</span><span class="string">aSelector</span></span><br><span class="line"><span class="attr">                                                modes:</span><span class="string">anArray</span></span><br><span class="line"><span class="attr">                                                 lock:</span><span class="string">l];</span></span><br><span class="line"><span class="string">[(GSRunLoopThreadInfo</span> <span class="string">*)info</span> <span class="attr">addPerformer:h];</span></span><br></pre></td></tr></table></figure><p><code>newForReceiver:argument:selector:modes:lock:</code> è¿™ä¸ªæ–¹æ³•å°±æ˜¯åšä¸€äº›ä¿¡æ¯å°è£…ï¼Œæ— éœ€å¤šè¨€ã€‚ä¸»è¦æ˜¯è¿™ä¸ª<code>addPerformer</code>ï¼Œåˆ é™¤<code>#if defined(_WIN32)</code>çš„ä»£ç åå…·ä½“å®ç°å¦‚ä¸‹:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addPerformer:(<span class="keyword">id</span>)performer &#123;</span><br><span class="line">    <span class="built_in">BOOL</span>  signalled = <span class="literal">NO</span>;</span><br><span class="line">    <span class="comment">// NSLockåŠ é”</span></span><br><span class="line">    [lock lock];</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> start = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨writeå‡½æ•°å‘ outputFd ä¸­å†™å…¥ 1 å­—èŠ‚æ•°æ®ï¼Œæ•°æ®ä¸º: "0"ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (outputFd &gt;= <span class="number">0</span> &amp;&amp; <span class="literal">NO</span> == (signalled = (write(outputFd, <span class="string">"0"</span>, <span class="number">1</span>) == <span class="number">1</span>) ? <span class="literal">YES</span> : <span class="literal">NO</span>)) &#123;</span><br><span class="line">        <span class="built_in">NSTimeInterval</span>    now = [<span class="built_in">NSDate</span> timeIntervalSinceReferenceDate];</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0.0</span> == start) &#123;</span><br><span class="line">            start = now;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (now - start &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Unable to signal %@ within a second; blocked?"</span>, <span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        [lock unlock];</span><br><span class="line">        [lock lock];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®æˆåŠŸï¼ŒæŠŠperformeræ·»åŠ åˆ°GSRunLoopThreadInfoæ•°ç»„ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (signalled) [performers addObject: performer];</span><br><span class="line">    <span class="comment">// NSLockè§£é”</span></span><br><span class="line">    [lock unlock];</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®å¤±è´¥ï¼Œé”€æ¯performer</span></span><br><span class="line">    <span class="keyword">if</span> (!signalled) [performer invalidate];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¡¥å……writeå‡½æ•°çŸ¥è¯†ç‚¹:</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * <span class="built_in">write</span>å‡½æ•°</span><br><span class="line"> * ssize_t  <span class="built_in">write</span>(int __fd, const void * __buf, size_t __nbyte) __DARWIN_ALIAS_C(<span class="built_in">write</span>);</span><br><span class="line"> * <span class="built_in">write</span> å‡½æ•°å‘ __fd ä¸­å†™å…¥ __nbyte å­—èŠ‚æ•°æ®ï¼Œæ•°æ®æ¥æºä¸º __buf ã€‚è¿”å›å€¼ä¸€èˆ¬æ€»æ˜¯ç­‰äº __nbyte</span><br><span class="line"> * è¿”å›å€¼å¦‚æœä¸æ˜¯ç­‰äº__nbyteï¼Œå°±æ˜¯å‡ºé”™äº†ã€‚å¸¸è§çš„å‡ºé”™åŸå› æ˜¯ç£ç›˜ç©ºé—´æ»¡äº†æˆ–è€…è¶…è¿‡äº†æ–‡ä»¶å¤§å°é™åˆ¶ã€‚</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/* The <span class="built_in">write</span> could concievably fail <span class="keyword">if</span> <span class="keyword">the</span> pipe <span class="keyword">is</span> full.</span><br><span class="line"> * In <span class="keyword">that</span> case we need <span class="keyword">to</span> release <span class="keyword">the</span> lock temporarily <span class="keyword">to</span> allow <span class="keyword">the</span> other</span><br><span class="line"> * thread <span class="keyword">to</span> consume data <span class="keyword">from</span> <span class="keyword">the</span> pipe.  It's possible <span class="keyword">that</span> <span class="keyword">the</span> thread</span><br><span class="line"> * <span class="keyword">and</span> <span class="keyword">its</span> runloop might stop during <span class="keyword">that</span> ... so we need <span class="keyword">to</span> check <span class="keyword">that</span></span><br><span class="line"> * outputFd <span class="keyword">is</span> still valid.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>ä¸æ˜¯ååˆ†ç†è§£writeå‡½æ•°åœ¨è¿™é‡Œçš„ä½œç”¨ï¼Œæ ¹æ®ä¸€äº›å¼‚å¸¸ä¿¡æ¯<code>&quot;Failed to set non block flag for perform in thread&quot; &quot;Failed to create event to handle perform in thread&quot;</code>ï¼Œå¯èƒ½æ˜¯å‘æ–‡ä»¶ä¸­å†™å…¥ä¸€äº›flagè¡¨ç¤ºçº¿ç¨‹æŒ‡å®šäº‹ä»¶å¯¹è±¡çš„ä¿¡å·çŠ¶æ€å§ã€‚</p><p>å¦‚æœä¿¡å·çŠ¶æ€è®¾ç½®æˆåŠŸï¼Œå°±æŠŠè¿™ä¸ªperformå¯¹è±¡(<code>GSPerformHolder</code>ç±»å‹)æ·»åŠ åˆ°<code>GSRunLoopThreadInfo</code>çš„performersæ•°ç»„ä¸­ã€‚</p><p>è¿™ä¸ª<code>GSRunLoopThreadInfo</code>å¯¹è±¡æŠŠ<code>GSPerformHolder</code>å¯¹è±¡æ·»åŠ åˆ°è‡ªå·±æ•°ç»„ä¸­åï¼Œå…·ä½“æœ€åŸå…ˆçš„performä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢? <strong>æ˜¯åœ¨è°ƒç”¨<code>GSRunLoopThreadInfo</code>å¯¹è±¡çš„<code>fire</code>æ–¹æ³•æ—¶é€ä¸ªæ‰§è¡Œ</strong>ï¼š</p><p>GSRunLoopThreadInfoå¯¹è±¡çš„<code>fire</code>æ–¹æ³•éƒ¨åˆ†å®ç°:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">for</span> <span class="string">(i</span> <span class="string">=</span> <span class="number">0</span><span class="string">;</span> <span class="string">i</span> <span class="string">&lt;</span> <span class="string">c;</span> <span class="string">i++)</span> <span class="string">&#123;</span></span><br><span class="line">   <span class="string">GSPerformHolder</span> <span class="meta">*h</span> <span class="string">=</span> <span class="string">[toDo</span> <span class="attr">objectAtIndex:i];</span></span><br><span class="line">   </span><br><span class="line">   <span class="string">[loop</span> <span class="attr">performSelector:@selector(fire)</span></span><br><span class="line"><span class="attr">                  target:</span><span class="string">h</span></span><br><span class="line"><span class="attr">                argument:</span><span class="string">nil</span></span><br><span class="line"><span class="attr">                   order:</span><span class="number">0</span></span><br><span class="line"><span class="attr">                   modes:</span><span class="string">[h</span> <span class="string">modes]];</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯è§æ˜¯é€ä¸ªå–å‡ºæ•°ç»„ä¸­çš„<code>GSPerformHolder</code>å¯¹è±¡ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è°ƒç”¨<code>GSPerformHolder</code>çš„<code>fire</code>æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ä¸ª<code>fire</code>æ–¹æ³•ï¼Œå®ƒå†…éƒ¨åšäº†ä»€ä¹ˆï¼Ÿå°±æ˜¯<code>[receiver performSelector: selector withObject: argument];</code>ã€‚</p><p>æ‹ä¸€æ‹: ä¸¤ä¸ªçº¿ç¨‹ä¸ä¸€è‡´æ—¶ï¼ŒæŠŠ<code>selector</code>ã€<code>argument</code>ã€<code>modes</code>åŠæ¡ä»¶é”ç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ª<code>GSPerformHolder</code>å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒæ·»åŠ åˆ°<code>GSRunLoopThreadInfo</code>å¯¹è±¡çš„performersæ•°ç»„ä¸­ã€‚å½“è°ƒç”¨<code>GSRunLoopThreadInfo</code>å¯¹è±¡çš„<code>fair</code>æ–¹æ³•æ—¶ä¼šéå†performersæ•°ç»„ï¼Œç„¶åé€ä¸ªè°ƒç”¨æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ çš„<code>fair</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ª<code>fair</code>æ–¹æ³•å†…éƒ¨å°±æ˜¯è°ƒç”¨<code>performSelector:withObject</code>æ–¹æ³•ã€‚</p><p>æœ€æœ€å…³é”®çš„ä¸€ä¸ªé—®é¢˜: ä»€ä¹ˆæ—¶å€™è°ƒç”¨<code>GSRunLoopThreadInfo</code>å¯¹è±¡çš„<code>fair</code>æ–¹æ³•? å®˜æ–¹æ–‡æ¡£è¯´:<strong> May only be called from the runloop when the event/descriptor is triggered.</strong></p><p>æˆ‘åœ¨Runloopçš„<code>+(BOOL)awakenedBefore:</code>å’Œ <code>-(BOOL)pollUntil:within:</code>æ–¹æ³•ä¸­æ‰¾åˆ°äº†è°ƒç”¨ç—•è¿¹ã€‚</p><h3 id="ä»»æ„çº¿ç¨‹è°ƒç”¨"><a href="#ä»»æ„çº¿ç¨‹è°ƒç”¨" class="headerlink" title="ä»»æ„çº¿ç¨‹è°ƒç”¨"></a>ä»»æ„çº¿ç¨‹è°ƒç”¨</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">- (void)performSelector:(SEL)aSelector</span><br><span class="line"><span class="symbol">               onThread:</span>(NSThread*)aThread</span><br><span class="line"><span class="symbol">             withObject:</span>(id)anObject</span><br><span class="line"><span class="symbol">          waitUntilDone:</span>(BOOL)<span class="class">aFlag </span>&#123;</span><br><span class="line">    [self performSelector:aSelector</span><br><span class="line"><span class="symbol">                 onThread:</span>aThread</span><br><span class="line"><span class="symbol">               withObject:</span>anObject</span><br><span class="line"><span class="symbol">            waitUntilDone:</span>aFlag</span><br><span class="line"><span class="symbol">                    modes:</span>commonModes()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Runloopçš„äº”ç§modeåˆ†åˆ«æ˜¯:<code>NSDefaultRunLoopModeï¼ŒNSConnectionReplyModeï¼ŒNSModalPanelRunLoopModeï¼ŒNSEventTrackingRunLoopModeï¼ŒNSRunLoopCommonModes</code>ã€‚<br><strong>è¿™ä¸ªæ–¹æ³•çœç•¥äº†modeså‚æ•°ï¼Œå†…éƒ¨ä½¿ç”¨common mode</strong>ï¼Œä¹Ÿå³<code>NSDefaultRunLoopMode</code>å’Œ<code>NSConnectionReplyMode</code>(ä¸æ˜¯<code>NSEventTrackingRunLoopMode</code>)ã€‚æ‰€ä»¥å¦‚æœæœ‰é¼ æ ‡æˆ–è€…æ‰‹åŠ¿äº‹ä»¶éœ€è¦å¤„ç†ï¼Œçœç•¥modeså‚æ•°å¯èƒ½ä¸æ˜¯ä¸ªå¥½åšæ³•ã€‚</p><h3 id="ä¸»çº¿ç¨‹è°ƒç”¨"><a href="#ä¸»çº¿ç¨‹è°ƒç”¨" class="headerlink" title="ä¸»çº¿ç¨‹è°ƒç”¨"></a>ä¸»çº¿ç¨‹è°ƒç”¨</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">- (void)performSelectorOnMainThread:(SEL)aSelector</span><br><span class="line"><span class="symbol">                         withObject:</span>(id)anObject</span><br><span class="line"><span class="symbol">                      waitUntilDone:</span>(BOOL)aFlag</span><br><span class="line"><span class="symbol">                              modes:</span>(NSArray*)<span class="class">anArray </span>&#123;</span><br><span class="line">    if (defaultThread == nil) defaultThread = [NSThread mainThread];</span><br><span class="line">    [self performSelector:aSelector</span><br><span class="line"><span class="symbol">                 onThread:</span>defaultThread</span><br><span class="line"><span class="symbol">               withObject:</span>anObject</span><br><span class="line"><span class="symbol">            waitUntilDone:</span>aFlag</span><br><span class="line"><span class="symbol">                    modes:</span>anArray];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªæ–¹æ³•æŒ‡å®šäº†ä¸»çº¿ç¨‹ã€‚</strong></p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">- (void)performSelectorOnMainThread:(SEL)aSelector</span><br><span class="line"><span class="symbol">                         withObject:</span>(id)anObject</span><br><span class="line"><span class="symbol">                      waitUntilDone:</span>(BOOL)<span class="class">aFlag </span>&#123;</span><br><span class="line">    [self performSelectorOnMainThread:aSelector</span><br><span class="line"><span class="symbol">                           withObject:</span>anObject</span><br><span class="line"><span class="symbol">                        waitUntilDone:</span>aFlag</span><br><span class="line"><span class="symbol">                                modes:</span>commonModes()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸¤ä¸ªæ–¹æ³•æŒ‡å®šäº†ä¸»çº¿ç¨‹ï¼Œå†…éƒ¨ä½¿ç”¨common modeã€‚</strong></p><h3 id="Backgroundè°ƒç”¨"><a href="#Backgroundè°ƒç”¨" class="headerlink" title="Backgroundè°ƒç”¨"></a>Backgroundè°ƒç”¨</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">- (void)performSelectorInBackground:(SEL)aSelector</span><br><span class="line"><span class="symbol">                         withObject:</span>(id)<span class="class">anObject </span>&#123;</span><br><span class="line">    [NSThread detachNewThreadSelector:aSelector</span><br><span class="line"><span class="symbol">                             toTarget:</span>self</span><br><span class="line"><span class="symbol">                           withObject:</span>anObject];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€æ¡ä»»æ„çš„çº¿ç¨‹æ‰§è¡Œ<code>selector</code>æ–¹æ³•ã€‚</strong></p><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h3 id="printInfoæ–¹æ³•ä¼šæ‰§è¡Œå—"><a href="#printInfoæ–¹æ³•ä¼šæ‰§è¡Œå—" class="headerlink" title="printInfoæ–¹æ³•ä¼šæ‰§è¡Œå—"></a>printInfoæ–¹æ³•ä¼šæ‰§è¡Œå—</h3><h4 id="GCDè°ƒç”¨"><a href="#GCDè°ƒç”¨" class="headerlink" title="GCDè°ƒç”¨"></a>GCDè°ƒç”¨</h4><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dispatch_async(<span class="name">dispatch_get_global_queue</span>(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [self performSelector:@selector(<span class="name">printInfo</span>) withObject<span class="symbol">:nil</span> afterDelay:<span class="number">1</span>]<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾æ˜¯ä¸ä¼šçš„ã€‚å› ä¸º<code>performSelector</code>å…·ä½“å®ç°ä¸­å¹¶æ²¡æœ‰ä¸»åŠ¨è§¦å‘çº¿ç¨‹å¯¹åº”Runloopè¿è¡Œã€‚å­çº¿ç¨‹å¯¹åº”çš„Runloopæ²¡æœ‰runã€‚æ€ä¹ˆè®©å®ƒæ‰§è¡Œï¼Ÿå¯åŠ¨Runloop:</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dispatch_async(<span class="name">dispatch_get_global_queue</span>(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [self performSelector:@selector(<span class="name">printInfo</span>) withObject<span class="symbol">:nil</span> afterDelay:<span class="number">1</span>]<span class="comment">;</span></span><br><span class="line">    [[NSRunLoop currentRunLoop] run]<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure><h4 id="NSThreadè°ƒç”¨"><a href="#NSThreadè°ƒç”¨" class="headerlink" title="NSThreadè°ƒç”¨"></a>NSThreadè°ƒç”¨</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSThread *thread = [[NSThread alloc] <span class="string">initWithBlock:</span>^&#123;</span><br><span class="line">   [self <span class="string">performSelector:</span><span class="meta">@selector</span>(printInfo) <span class="string">withObject:</span>nil <span class="string">afterDelay:</span><span class="number">1</span>];</span><br><span class="line">&#125;];</span><br><span class="line">[thread start];</span><br></pre></td></tr></table></figure><p>åŒç†:</p><figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line">NSThread *thread = <span class="comment">[<span class="comment">[NSThread alloc]</span> initWithBlock:^&#123;</span></span><br><span class="line"><span class="comment">   <span class="comment">[self performSelector:@selector(printInfo) withObject:nil afterDelay:1]</span>;</span></span><br><span class="line"><span class="comment">   <span class="comment">[<span class="comment">[NSRunLoop currentRunLoop]</span> run]</span>;</span></span><br><span class="line"><span class="comment">&#125;]</span>;</span><br><span class="line"><span class="comment">[thread start]</span>;</span><br></pre></td></tr></table></figure><p>è¿™å°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ã€‚åœ¨GCDä¸­<code>[[NSRunLoop currentRunLoop] run];</code>æ”¾åœ¨<code>performSelector</code>å‰é¢æˆ–è€…åé¢è²Œä¼¼éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯åœ¨NSThreadä¸­<code>[[NSRunLoop currentRunLoop] run];</code>åªèƒ½æ”¾åœ¨<code>performSelector</code>çš„åé¢ã€‚</p><p>åœ¨NSThreadæ–¹æ³•ä¸­:</p><blockquote><p>å› ä¸ºrunæ–¹æ³•åªæ˜¯å°è¯•æƒ³è¦å¼€å¯å½“å‰çº¿ç¨‹ä¸­çš„runloopï¼Œä½†æ˜¯å¦‚æœè¯¥çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰ä»»ä½•äº‹ä»¶(sourceã€timerã€observer)çš„è¯ï¼Œå¹¶ä¸ä¼šæˆåŠŸçš„å¼€å¯ã€‚</p></blockquote><p>ä¸ºä»€ä¹ˆGCDä¸­å³ä½¿<code>[[NSRunLoop currentRunLoop] run];</code>æ”¾åœ¨å‰é¢<code>printInfo</code>æ–¹æ³•è¿˜æ˜¯è°ƒç”¨äº†å‘¢? ä»£ç å®é™…æµ‹è¯•ï¼Œå»¶è¿Ÿæ•ˆæœæ²¡æœ‰äº†ï¼Œå¹¶ä¸”æœ‰æ—¶æ–¹æ³•æ‰§è¡Œï¼Œæœ‰æ—¶æ–¹æ³•æ²¡æœ‰æ‰§è¡Œã€‚</p><p>ç»¼ä¸Šï¼Œ<strong>åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨performSelectorçš„å»¶è¿Ÿæ–¹æ³•ï¼Œéœ€è¦åŠ ä¸Š<code>[[NSRunLoop currentRunLoop] run];</code>ä½¿å¾—Runloopèƒ½å¤Ÿè¿è¡Œï¼Œå¹¶ä¸”è¯¥æ–¹æ³•è¦æ”¾åœ¨<code>performSelector</code>çš„åé¢æ¥ä¿è¯RunloopæˆåŠŸè¿è¡Œã€‚</strong></p><h4 id="NSThreadæ— æ•ˆ"><a href="#NSThreadæ— æ•ˆ" class="headerlink" title="NSThreadæ— æ•ˆ"></a>NSThreadæ— æ•ˆ</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSThread *thread = [[NSThread alloc] <span class="string">initWithBlock:</span>^&#123;&#125;];</span><br><span class="line">[thread start];</span><br><span class="line">[self <span class="string">performSelector:</span><span class="meta">@selector</span>(printMainInfo) <span class="string">onThread:</span>thread <span class="string">withObject:</span>nil <span class="string">waitUntilDone:</span>NO];</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç ä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡ŒprintMainInfoæ–¹æ³•?</p><p>å­çº¿ç¨‹æ‰§è¡Œå®Œæ“ä½œä¹‹åå°±ä¼šç«‹å³é‡Šæ”¾ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨å¼ºå¼•ç”¨å¼•ç”¨å­çº¿ç¨‹ä½¿å­çº¿ç¨‹ä¸è¢«é‡Šæ”¾ï¼Œä¹Ÿä¸èƒ½ç»™å­çº¿ç¨‹å†æ¬¡æ·»åŠ æ“ä½œï¼Œæˆ–è€…å†æ¬¡å¼€å¯ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨Runloopã€‚å­çº¿ç¨‹è·å–å…¶å¯¹åº”çš„Runloopå¯¹è±¡å¹¶ä½¿ä¹‹è¿è¡Œã€‚ä¸€èˆ¬ä½¿ç”¨å¸¸é©»å­çº¿ç¨‹ã€‚</p><p>æ­£ç¡®å®è·µï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSThread</span> *thread = [[<span class="built_in">NSThread</span> alloc] initWithBlock:^&#123;</span><br><span class="line">   <span class="comment">// æ‰§è¡Œä¸€æ¬¡è€Œå·²</span></span><br><span class="line">   <span class="built_in">NSRunLoop</span> *currentRunLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">   [currentRunLoop runMode:<span class="built_in">NSDefaultRunLoopMode</span> beforeDate:[<span class="built_in">NSDate</span> distantFuture]];</span><br><span class="line">&#125;];</span><br><span class="line">[thread start];</span><br><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(printMainInfo) onThread:thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span>];</span><br></pre></td></tr></table></figure></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ¢³ç†æœ¬æ–‡ï¼Œæ¯”è¾ƒé‡è¦çš„å‡ ä¸ªå°ç‚¹å¦‚ä¸‹ï¼š</p><ol><li><code>performSelector</code>å†…éƒ¨çš„å®ç°å°±æ˜¯ä½¿ç”¨<code>IMP</code>ç›´æ¥è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ã€‚</li><li>ä¸¥æ ¼éµå®ˆARCè§„åˆ™ï¼Œæ³¨æ„æ–¹æ³•çš„å‘½åï¼Œä¸ç„¶ä¼šä¸ºå†…å­˜æ³„æ¼åŸ‹ä¸‹ä¼ç¬”ã€‚</li><li>åå°„<code>NSSelectorFromString()</code>å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯ä½¿ç”¨<code>@selector()</code>æ˜¾å¼å‘Šè¯‰ç¼–è¯‘å™¨å°†è¦è°ƒç”¨çš„æ–¹æ³•æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚</li><li><code>performSelector</code>èƒ½å®ç°å»¶è¿Ÿæ˜¯å› ä¸ºå®šæ—¶å™¨ï¼Œè¦åŠæ—¶å–æ¶ˆæ— æ³•æ‰§è¡Œçš„å»¶è¿Ÿæ–¹æ³•ã€‚</li><li>å­çº¿ç¨‹ä¸­ä½¿ç”¨å»¶è¿Ÿæ–¹æ³•ï¼Œéœ€è¦ä¸»åŠ¨ä½¿Runloopèƒ½å¤Ÿè¿è¡Œã€‚</li><li>NSTimeråœ¨å…¶<code>invalidate</code>æ–¹æ³•è°ƒç”¨åï¼ŒRunloopä¼šè‡ªåŠ¨ç§»é™¤å¯¹å®ƒçš„å¼•ç”¨ã€‚</li></ol><p>å…·ä½“åœ¨ä¸šåŠ¡ä¸Šï¼Œå¯ä»¥ä¸¾å‡ ä¸ªç®€å•çš„åœºæ™¯ã€‚</p><p>å¯¹äºæ–‡ä»¶æˆ–è€…æ¨¡å‹çš„ä¸‹è½½ï¼Œæœ‰æ—¶å€™éœ€è¦ç”¨åˆ°è¿›åº¦æ¡æç¤ºã€‚è¿™æ—¶å€™å¯ä»¥åœ¨å­çº¿ç¨‹ä¸‹è½½ï¼Œè·‘åˆ°ä¸»çº¿ç¨‹æ›´æ–°UIï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self <span class="string">performSelectorOnMainThread:</span><span class="meta">@selector</span>(updateProgress) <span class="string">withObject:</span>nil <span class="string">waitUntilDone:</span>NO];</span><br></pre></td></tr></table></figure></p><p>æœ‰äº›æ—¶å€™éœ€è¦è¿›è¡Œç®€å•çš„Tipæç¤ºï¼Œ3ç§’åè‡ªåŠ¨è®©å®ƒè‡ªåŠ¨éšè—ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.tipView <span class="string">performSelector:</span><span class="meta">@selector</span>(dismiss) <span class="string">withObject:</span>nil <span class="string">afterDelay:</span><span class="number">3.</span>f];</span><br></pre></td></tr></table></figure></p><p>å½“ä½¿ç”¨å¤šæ€çš„æ—¶å€™ï¼ŒåŠ¨æ€è°ƒç”¨æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">Class cls = Nil;</span><br><span class="line"><span class="keyword">if</span> (item.isForChinese) &#123;</span><br><span class="line">    cls = NSClassFromString(@<span class="string">"YAChinesePopView"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cls = NSClassFromString(@<span class="string">"YAEnglishPopView"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> [cls <span class="string">performSelector:</span><span class="meta">@selector</span>(<span class="string">popViewWithItem:</span>) <span class="string">withObject:</span>item];</span><br></pre></td></tr></table></figure></p><p>å¶ç„¶é—´å‘ç°ä¸€ä¸ªå¥½ç©çš„ä¾‹å­ï¼šç›´æ¥è°ƒç”¨æŸä¸ªå¯¹è±¡çš„æŸä¸ªæ–¹æ³•ï¼Œè€Œä¸å¯¼å…¥å…¶å¤´æ–‡ä»¶ã€‚æ¯”å¦‚æ‰‹ç™¾è‡ªå®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ªWKWebViewçš„å­ç±»ï¼Œå¹¶æŠŠè¿™ä¸ªå®ä¾‹æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬æƒ³è®©å®ƒæ‰§è¡ŒæŸæ®µJavaScriptï¼Œä½†æ˜¯åˆä¸æƒ³å¯¼å…¥ç¹é‡çš„å¤´æ–‡ä»¶ï¼š</p><pre><code>if ([obj respondsToSelector:@selector(evaluateJavaScript:completionHandler:)]) {    [obj performSelector:@selector(evaluateJavaScript:completionHandler:) withObject:js withObject:nil];} </code></pre><p>ä¸Šé¢çš„åªæ˜¯å†°å±±ä¸€è§’ï¼Œå…¶åˆç†æ€§éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯å…·ä½“åˆ†æï¼Œåªæ˜¯æƒ³é˜æ˜ï¼ŒperformSelectoråœ¨ä¸€äº›æƒ…å†µä¸‹æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p><hr><blockquote><p>å‚è€ƒèµ„æ–™<br><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmRules.html" target="_blank" rel="noopener">Advanced Memory Management Programming Guide</a><br><a href="https://zhongwuzw.github.io/2017/01/19/Objective-Cä¹‹performSelectorç¼–è¯‘å™¨å†…å­˜æ³„éœ²è­¦å‘Š/" target="_blank" rel="noopener">Objective-Cä¹‹performSelectorç¼–è¯‘å™¨å†…å­˜æ³„éœ²è­¦å‘Š</a><br><a href="https://blog.csdn.net/dean19900504/article/details/8067679" target="_blank" rel="noopener">ç”¨performSelectorçš„æ—¶å€™è¦æ³¨æ„åˆ«å†…å­˜æ³„éœ²äº†</a><br><a href="https://stackoverflow.com/questions/7017281/performselector-may-cause-a-leak-because-its-selector-is-unknown" target="_blank" rel="noopener">PerformSelector May Cause a Leak</a><br><a href="https://blog.csdn.net/wei371522/article/details/81216853" target="_blank" rel="noopener">performSelector æ³¨æ„é—®é¢˜åŠåŸç†</a><br><a href="https://blog.csdn.net/king16304/article/details/52192259" target="_blank" rel="noopener">c/c++ read å‡½æ•°å’Œ write å‡½æ•°</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; PerformSelectorç›¸å…³çŸ¥è¯†ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="é˜…è¯»" scheme="http://blog.chenyalun.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>RuntimeåŸºç¡€</title>
    <link href="http://blog.chenyalun.com/2018/07/10/Runtime%E5%9F%BA%E7%A1%80/"/>
    <id>http://blog.chenyalun.com/2018/07/10/RuntimeåŸºç¡€/</id>
    <published>2018-07-10T15:02:17.000Z</published>
    <updated>2019-08-28T11:30:10.722Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2018.8.26 æ›´æ–°Classå®šä¹‰<br>2019.3.25 æ›´æ–°è®¾ç½®weakå…³è”å±æ€§</p></blockquote><p></p><p align="center"> å…³äºRuntimeçš„ç®€å•æ€»ç»“ã€‚ </p><br><a id="more"></a><p></p><p>ç®€å•æ€»ç»“ä¸€äº›æ¯”è¾ƒå¥½ç©çš„ç”¨æ³•ï¼Œä½†æ˜¯åæ¥æˆ‘æ‰å‘ç°ï¼Œå—å³°å­å¤§ç¥çš„<a href="http://southpeak.github.io/2014/10/25/objective-c-runtime-1/" target="_blank" rel="noopener">Runtimeç³»åˆ—</a>æ€»ç»“çš„å¾ˆè¯¦ç»†å¾ˆå®Œæ•´äº†ã€‚æ–‡ç« èˆä¸å¾—åˆ ï¼Œå°±å½“æŠ›ç –å¼•ç‰å§ã€‚</p><h2 id="ä¸€ã€Runtime"><a href="#ä¸€ã€Runtime" class="headerlink" title="ä¸€ã€Runtime"></a>ä¸€ã€Runtime</h2><h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Objective-C2<span class="number">.0</span>ä¹‹å‰Classçš„å®šä¹‰</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> &#123;</span></span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">    <span class="comment">// çˆ¶ç±»</span></span><br><span class="line">    Class super_class;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">long</span> version;</span><br><span class="line">    <span class="keyword">long</span> info;</span><br><span class="line">    <span class="keyword">long</span> instance_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> *<span class="title">ivars</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> **<span class="title">methodLists</span>;</span></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç¼“å­˜</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_protocol_list</span> *<span class="title">protocols</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied;</span><br><span class="line">    Method buckets[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">æ ¹æ®æºç ï¼Œæœ€æ–°å®šä¹‰å¤§è‡´å¦‚ä¸‹:</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class isa;</span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;<span class="comment">// æ–¹æ³•ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits; <span class="comment">// ç”¨äºè·å–å…·ä½“çš„ç±»ä¿¡æ¯</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç»ƒ</p><figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line">YAPerson *person = [[YAPerson alloc] init];</span><br><span class="line">Class cls = [person <span class="keyword">class</span>];</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–å®ä¾‹å¯¹è±¡å¯¹åº”çš„Class</span></span><br><span class="line">Class <span class="keyword">class</span><span class="number">1</span> = <span class="keyword">object</span><span class="number">_</span>getClass(person);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–æŒ‡å®šåç§°çš„ç±»å¯¹è±¡</span></span><br><span class="line">Class <span class="keyword">class</span><span class="number">3</span> = objc<span class="number">_</span>getClass(<span class="string">"YAPerson"</span>);</span><br><span class="line">Class <span class="keyword">class</span><span class="number">2</span> = objc<span class="number">_</span>getRequiredClass(<span class="string">"YAPerson"</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–æŒ‡å®šåç§°çš„å…ƒç±»å¯¹è±¡</span></span><br><span class="line">Class <span class="keyword">class</span><span class="number">4</span> = objc<span class="number">_</span>getMetaClass(<span class="string">"YAPerson"</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ‰¾åˆ°æŒ‡å®šåç§°çš„ç±»å¯¹è±¡</span></span><br><span class="line">Class <span class="keyword">class</span><span class="number">5</span> = objc<span class="number">_</span>lookUpClass(<span class="string">"NSObject"</span>);</span><br><span class="line">NSLog(@<span class="string">"%@%@%@%@%@"</span>,<span class="keyword">class</span><span class="number">1</span>,<span class="keyword">class</span><span class="number">2</span>,<span class="keyword">class</span><span class="number">3</span>,<span class="keyword">class</span><span class="number">4</span>,<span class="keyword">class</span><span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è®¾ç½®å¯¹è±¡å¯¹åº”çš„Class,è¿”å›åŸå…ˆçš„class</span></span><br><span class="line">Class oriClass = <span class="keyword">object</span><span class="number">_</span>setClass(person, [NSObject <span class="keyword">class</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æ˜¯ç±»å¯¹è±¡æˆ–å…ƒç±»å¯¹è±¡</span></span><br><span class="line">BOOL isClass = <span class="keyword">object</span><span class="number">_</span>isClass(person);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ˜¯å¦æ˜¯å…ƒç±»å¯¹è±¡</span></span><br><span class="line">BOOL isMetaClass = <span class="keyword">class</span><span class="number">_</span>isMetaClass(<span class="keyword">class</span><span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–çˆ¶ç±»</span></span><br><span class="line">Class superClass = <span class="keyword">class</span><span class="number">_</span>getSuperclass(cls);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–ç±»çš„ç‰ˆæœ¬</span></span><br><span class="line">int version = <span class="keyword">class</span><span class="number">_</span>getVersion(cls);</span><br><span class="line"><span class="comment">// è®¾ç½®ç±»çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">class</span><span class="number">_</span>setVersion(cls, <span class="number">88</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å®ä¾‹å¤§å°</span></span><br><span class="line">typedef <span class="number">__</span>SIZE<span class="number">_T</span>YPE<span class="number">__</span> size<span class="number">_</span>t;</span><br><span class="line">    </span><br><span class="line">size<span class="number">_</span>t size = <span class="keyword">class</span><span class="number">_</span>getInstanceSize(cls);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    int objc_getClassList(Class *buffer, int bufferCount)</span></span><br><span class="line"><span class="comment">//    </span></span><br><span class="line"><span class="comment">//    Class *objc_copyClassList(unsigned int *outCount)</span></span><br><span class="line"><span class="comment">//    </span></span><br><span class="line"><span class="comment">// è·å–ç±»çš„åç§°</span></span><br><span class="line">const char *name = <span class="keyword">class</span><span class="number">_</span>getName(cls);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">// åŠ¨æ€åˆ›å»ºç±»</span></span><br><span class="line"><span class="comment">//Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</span></span><br><span class="line"><span class="comment">//void objc_registerClassPair(Class cls)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// åŠ¨æ€åºŸå¼ƒç±»</span></span><br><span class="line"><span class="comment">//Class objc_duplicateClass(Class original, const char *name, size_t extraBytes)</span></span><br><span class="line"><span class="comment">//void objc_disposeClassPair(Class cls)</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">//id o = objc_storeWeak(&amp;weakObject, weakObject);</span></span><br><span class="line"><span class="comment">//id result = objc_loadWeak(&amp;weakObject);</span></span><br></pre></td></tr></table></figure><h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line">ç»™<span class="keyword">blockåˆ›å»ºä¸€ä¸ªå…³è”çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">IMP </span>imp_implementationWithBlock(id <span class="keyword">block)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">è·å–å‡½æ•°æŒ‡é’ˆå…³è”çš„block</span></span><br><span class="line"><span class="keyword">id </span>imp_getBlock(IMP anImp)</span><br><span class="line"></span><br><span class="line">ç§»é™¤å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„<span class="keyword">block</span></span><br><span class="line"><span class="keyword">BOOL </span>imp_removeBlock(IMP anImp)</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç»ƒ</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜block</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^Block) ();</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å®šä¹‰block</span></span><br><span class="line">Block block = ^() &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"å“ˆå“ˆå“ˆ"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ç»™blockåˆ›å»ºä¸€ä¸ªå…³è”çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">IMP imp = imp_implementationWithBlock(block);</span><br><span class="line"><span class="comment">// è°ƒç”¨block</span></span><br><span class="line">(*imp)();</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–å‡½æ•°æŒ‡é’ˆå…³è”çš„block</span></span><br><span class="line"><span class="keyword">id</span> blockObject = imp_getBlock(imp);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,blockObject);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">// ç§»é™¤å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„block</span></span><br><span class="line"><span class="built_in">BOOL</span> isRemoveBlock = imp_removeBlock(imp);</span><br><span class="line"><span class="keyword">if</span> (isRemoveBlock) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"æˆåŠŸç§»é™¤"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line">è·å–<span class="keyword">SELçš„åç§°(char </span>*ç±»å‹)</span><br><span class="line"><span class="symbol">const</span> char *<span class="keyword">sel_getName(SEL </span><span class="keyword">sel)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">æ³¨å†ŒSEL</span></span><br><span class="line"><span class="keyword">SEL </span><span class="keyword">sel_registerName(const </span>char *<span class="keyword">str)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">æ¯”è¾ƒSEL</span></span><br><span class="line"><span class="keyword">BOOL </span><span class="keyword">sel_isEqual(SEL </span>lhs, <span class="keyword">SEL </span>rhs)</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç»ƒ</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–SELçš„åç§°(char *ç±»å‹)</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(<span class="keyword">@selector</span>(viewWillAppear:));</span><br><span class="line">printf(<span class="string">"%s"</span>,selName);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ³¨å†ŒSEL</span></span><br><span class="line">SEL newSel = sel_registerName(<span class="string">"haha"</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ¯”è¾ƒSEL</span></span><br><span class="line"><span class="built_in">BOOL</span> isEqual = sel_isEqual(<span class="keyword">@selector</span>(viewWillAppear:), newSel);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,isEqual);</span><br></pre></td></tr></table></figure><h3 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h3><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">å®šä¹‰ä¸€ä¸ªobjc_ivarç»“æ„ä½“æŒ‡é’ˆIvar</span><br><span class="line"><span class="keyword">typedef</span> struct objc_ivar *Ivar;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">struct objc_ivar &#123;</span><br><span class="line">    æˆå‘˜å˜é‡åç§°</span><br><span class="line">    <span class="keyword">char</span> *ivar_name;</span><br><span class="line">    æˆå‘˜å˜é‡ç±»å‹                                         </span><br><span class="line">    <span class="keyword">char</span> *ivar_type;                                          </span><br><span class="line">    åç§»é‡</span><br><span class="line">    <span class="keyword">int</span> ivar_offset;                                          </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space;                                                </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å…³äºåç§»é‡çš„å®šä¹‰(å°±æ˜¯æ•´å‹)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__PTRDIFF_TYPE__)</span></span><br><span class="line">    <span class="keyword">typedef</span> __PTRDIFF_TYPE____darwin_ptrdiff_t;<span class="comment">/* ptr1 - ptr2 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">long</span>__darwin_ptrdiff_t;<span class="comment">/* ptr1 - ptr2 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">int</span>__darwin_ptrdiff_t;<span class="comment">/* ptr1 - ptr2 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __GNUC__ */</span></span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _PTRDIFF_T</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _PTRDIFF_T</span></span><br><span class="line">    <span class="keyword">typedef</span> __darwin_ptrdiff_t ptrdiff_t;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _PTRDIFF_T */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">struct objc_ivar_list &#123;</span><br><span class="line">    æˆå‘˜å˜é‡æ•°é‡</span><br><span class="line">    <span class="keyword">int</span> ivar_count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    struct objc_ivar ivar_list[<span class="number">1</span>];</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è·å–å®ä¾‹å˜é‡</span><br><span class="line">Ivar class_getInstanceVariable(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">    </span><br><span class="line"><span class="comment">//è·å–ç±»å˜é‡</span></span><br><span class="line"><span class="comment">//Ivar class_getClassVariable(Class cls, const char *name)</span></span><br><span class="line">    </span><br><span class="line">è·å–æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">Ivar *class_copyIvarList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line">   </span><br><span class="line">è·å–Ivarå˜é‡çš„åç§°</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ivar_getName(Ivar v)</span><br><span class="line">    </span><br><span class="line">è·å–Ivarå˜é‡çš„åç§»é‡</span><br><span class="line">ptrdiff_t ivar_getOffset(Ivar v)</span><br><span class="line">    </span><br><span class="line">è·å–Ivarå˜é‡çš„ç¼–ç </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ivar_getTypeEncoding(Ivar v)</span><br><span class="line">    </span><br><span class="line">è®¾ç½®æˆå‘˜å˜é‡çš„å€¼</span><br><span class="line"><span class="keyword">void</span> object_setIvarWithStrongDefault(id obj, Ivar ivar, id value)</span><br><span class="line"></span><br><span class="line">è®¾ç½®æˆå‘˜å˜é‡çš„å€¼</span><br><span class="line"><span class="keyword">void</span> object_setIvar(id obj, Ivar ivar, id value)</span><br><span class="line"></span><br><span class="line">è·å–Ivarå¯¹åº”çš„æˆå‘˜å˜é‡å¯¹è±¡</span><br><span class="line">id object_getIvar(id obj, Ivar ivar)</span><br><span class="line"></span><br><span class="line">IvarLayoutç›¸å…³</span><br><span class="line"><span class="keyword">const</span> uint8_t *class_getIvarLayout(Class cls)</span><br><span class="line"><span class="keyword">const</span> uint8_t *class_getWeakIvarLayout(Class cls)</span><br><span class="line"><span class="keyword">void</span> class_setIvarLayout(Class cls, <span class="keyword">const</span> uint8_t *layout)</span><br><span class="line"><span class="keyword">void</span> class_setWeakIvarLayout(Class cls, <span class="keyword">const</span> uint8_t *layout)</span><br><span class="line">    </span><br><span class="line">æ·»åŠ æˆå‘˜å˜é‡</span><br><span class="line">BOOL class_addIvar(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t <span class="built_in">size</span>,</span><br><span class="line">                  uint8_t alignment, <span class="keyword">const</span> <span class="keyword">char</span> *types)</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç¤º</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    YAPerson *person = [[YAPerson alloc] init];</span><br><span class="line">    Class cls = [person <span class="keyword">class</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å®ä¾‹å˜é‡</span></span><br><span class="line">    Ivar ivar_num = class_getInstanceVariable(cls, <span class="string">"num"</span>);</span><br><span class="line">    </span><br><span class="line">    Ivar ivar_name = class_getInstanceVariable(cls, <span class="string">"name"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–ç±»å˜é‡</span></span><br><span class="line">    <span class="comment">//Ivar class_getClassVariable(Class cls, const char *name)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–Ivarå˜é‡çš„åç§°</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(ivar_name);</span><br><span class="line">    printf(<span class="string">"%s\n"</span>,name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–Ivarå˜é‡çš„åç§»é‡</span></span><br><span class="line">    ptrdiff_t p = ivar_getOffset(ivar_num);</span><br><span class="line">    printf(<span class="string">"%td"</span>,p); <span class="comment">// æ‰“å°16</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–Ivarå˜é‡çš„ç¼–ç </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = ivar_getTypeEncoding(ivar_name);</span><br><span class="line">    printf(<span class="string">"%s\n"</span>,typeEncoding); <span class="comment">// æ‰“å° @"NSString"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®æˆå‘˜å˜é‡çš„å€¼</span></span><br><span class="line">    object_setIvarWithStrongDefault(person, ivar_name, <span class="string">@"haha"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,person-&gt;name);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®æˆå‘˜å˜é‡å¯¹åº”çš„å€¼</span></span><br><span class="line">    object_setIvar(person, ivar_name, <span class="string">@"hahaaaaaa"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,person-&gt;name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–Ivarå¯¹åº”çš„æˆå‘˜å˜é‡å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">id</span> object = object_getIvar(person, ivar_name);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,object);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡</span></span><br><span class="line">    <span class="comment">// å¿…é¡»åœ¨ objc_allocateClassPair ä¹‹å å’Œ åœ¨objc_registerClassPairä¹‹å‰è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// ä¸èƒ½ç»™ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æˆå‘˜å˜é‡</span></span><br><span class="line">    Class peopleClass = objc_allocateClassPair(cls, <span class="string">"YAPeople"</span>, <span class="number">0</span>);</span><br><span class="line">    class_addIvar(peopleClass, <span class="string">"_gayFriend"</span>, <span class="keyword">sizeof</span>(<span class="keyword">id</span>), log2(<span class="keyword">sizeof</span>(<span class="keyword">id</span>)), <span class="keyword">@encode</span>(<span class="keyword">id</span>));</span><br><span class="line">    class_addIvar(peopleClass, <span class="string">"_girlFriend"</span>, <span class="keyword">sizeof</span>(<span class="keyword">id</span>), log2(<span class="keyword">sizeof</span>(<span class="keyword">id</span>)), <span class="keyword">@encode</span>(<span class="keyword">id</span>));</span><br><span class="line">    class_addIvar(peopleClass, <span class="string">"_company"</span>, <span class="keyword">sizeof</span>(<span class="keyword">id</span>), log2(<span class="keyword">sizeof</span>(<span class="keyword">id</span>)), <span class="keyword">@encode</span>(<span class="keyword">id</span>));</span><br><span class="line">    objc_registerClassPair(peopleClass);</span><br><span class="line">    <span class="comment">// æ‰“å°æˆå‘˜å˜é‡åˆ—è¡¨</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="keyword">self</span> ya_getIvarList:peopleClass]);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IvarLayoutç›¸å…³</span></span><br><span class="line">    <span class="comment">// ivarLayout å’Œ weakIvarLayout åˆ†åˆ«è®°å½•äº†å“ªäº› ivar æ˜¯ strong æˆ–æ˜¯ weakï¼Œéƒ½æœªè®°å½•çš„å°±æ˜¯åŸºæœ¬ç±»å‹å’Œ __unsafe_unretained çš„å¯¹è±¡ç±»å‹</span></span><br><span class="line">    <span class="keyword">const</span> uint8_t *ivarLayoutArray= class_getIvarLayout(cls);</span><br><span class="line">    <span class="keyword">const</span> uint8_t *weakIvarLayoutArray = class_getWeakIvarLayout(cls);</span><br><span class="line">    <span class="keyword">if</span> (ivarLayoutArray) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        uint8_t value_s = ivarLayoutArray[i];</span><br><span class="line">        <span class="keyword">while</span> (value_s != <span class="number">0x0</span>) &#123;</span><br><span class="line">            printf(<span class="string">"\\x%02x\n"</span>, value_s);</span><br><span class="line">            value_s = ivarLayoutArray[++i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void class_setIvarLayout(Class cls, const uint8_t *layout)</span></span><br><span class="line">    <span class="comment">//void class_setWeakIvarLayout(Class cls, const uint8_t *layout)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®classè·å–æˆå‘˜å˜é‡åˆ—è¡¨<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®classè·å–æˆå‘˜å˜é‡åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param class ç±»</span></span><br><span class="line"><span class="comment"> @return æˆå‘˜å˜é‡å­—å…¸(åç§°:ç±»å‹)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)ya_getIvarList:(Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡æ•°é‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æˆå‘˜å˜é‡åˆ—è¡¨</span></span><br><span class="line">    Ivar *ivarList = class_copyIvarList(<span class="keyword">class</span>, &amp;count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­˜å‚¨æˆå‘˜å˜é‡</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æˆå‘˜å˜é‡ç±»å‹ä¸æˆå‘˜å˜é‡åç§°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">// æˆå‘˜å˜é‡ç±»å‹</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *c_ivarType = ivar_getTypeEncoding(ivarList[i]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æˆå‘˜å˜é‡åç§°</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *c_ivarName = ivar_getName(ivarList[i]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ©ç”¨å­—å…¸å­˜å‚¨,æ ¼å¼ä¸º æˆå‘˜å˜é‡åç§°:å¯¹åº”çš„æˆå‘˜å˜é‡ç±»å‹</span></span><br><span class="line">        <span class="built_in">NSString</span> *ivarName = [<span class="built_in">NSString</span> stringWithUTF8String:c_ivarName];</span><br><span class="line">        dict[ivarName] = [<span class="built_in">NSString</span> stringWithUTF8String:c_ivarType];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éœ€è¦æ‰‹åŠ¨free</span></span><br><span class="line">    free(ivarList);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:dict];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>å€¼å¾—ä¸€æçš„æ˜¯æ–¹æ³•ç¼–ç å’Œç±»å‹ç¼–ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ID       <span class="meta-string">'@'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_CLASS    <span class="meta-string">'#'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_SEL      <span class="meta-string">':'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_CHR      <span class="meta-string">'c'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_UCHR     <span class="meta-string">'C'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_SHT      <span class="meta-string">'s'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_USHT     <span class="meta-string">'S'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_INT      <span class="meta-string">'i'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_UINT     <span class="meta-string">'I'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_LNG      <span class="meta-string">'l'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ULNG     <span class="meta-string">'L'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_LNG_LNG  <span class="meta-string">'q'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ULNG_LNG <span class="meta-string">'Q'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_FLT      <span class="meta-string">'f'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_DBL      <span class="meta-string">'d'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_BFLD     <span class="meta-string">'b'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_BOOL     <span class="meta-string">'B'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_VOID     <span class="meta-string">'v'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_UNDEF    <span class="meta-string">'?'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_PTR      <span class="meta-string">'^'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_CHARPTR  <span class="meta-string">'*'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ATOM     <span class="meta-string">'%'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ARY_B    <span class="meta-string">'['</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_ARY_E    <span class="meta-string">']'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_UNION_B  <span class="meta-string">'('</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_UNION_E  <span class="meta-string">')'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_STRUCT_B <span class="meta-string">'&#123;'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_STRUCT_E <span class="meta-string">'&#125;'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_VECTOR   <span class="meta-string">'!'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _C_CONST    <span class="meta-string">'r'</span></span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Code</th><th>Meaning</th></tr></thead><tbody><tr><td>r</td><td>const</td></tr><tr><td>n</td><td>in</td></tr><tr><td>N</td><td>inout</td></tr><tr><td>o</td><td>out</td></tr><tr><td>O</td><td>bycopy</td></tr><tr><td>R</td><td>byref</td></tr><tr><td>V</td><td>oneway</td></tr></tbody></table><p>ä»¥ä¸Šä¿¡æ¯åœ¨å…·ä½“åº”ç”¨æ—¶ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæšä¸¾è·å–ã€‚</p><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">typedef struct objc_method *<span class="function"><span class="keyword">Method</span>;</span></span><br><span class="line"></span><br><span class="line">struct objc_method <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    // æ–¹æ³•çš„åç§°</span></span><br><span class="line"><span class="comment">    SEL method_name;                                          </span></span><br><span class="line"><span class="comment">    // æ–¹æ³•çš„å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="comment">    char *method_types;                                       </span></span><br><span class="line"><span class="comment">    // æ–¹æ³•çš„å®ç°(å‡½æ•°æŒ‡é’ˆ)</span></span><br><span class="line"><span class="comment">    IMP method_imp;                                           </span></span><br><span class="line"><span class="comment">&#125;</span>                                                            </span><br><span class="line"></span><br><span class="line">æ ¹æ®æ–¹æ³•åç§°è·å–<span class="function"><span class="keyword">Method</span></span></span><br><span class="line"><span class="function"><span class="title">Method</span> <span class="title">class_getInstanceMethod</span><span class="params">(<span class="keyword">Class</span> cls, SEL name)</span></span></span><br><span class="line"><span class="function"><span class="title">Method</span> <span class="title">class_getClassMethod</span><span class="params">(<span class="keyword">Class</span> cls, SEL name)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–<span class="title">Method</span>çš„æ–¹æ³•åç§°</span></span><br><span class="line"><span class="function"><span class="title">SEL</span> <span class="title">method_getName</span><span class="params">(<span class="keyword">Method</span> m)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–<span class="title">Method</span>çš„æ–¹æ³•å®ç°</span></span><br><span class="line"><span class="function"><span class="title">IMP</span> <span class="title">method_getImplementation</span><span class="params">(<span class="keyword">Method</span> m)</span> </span></span><br><span class="line"><span class="function"><span class="title">IMP</span> <span class="title">class_getMethodImplementation</span><span class="params">(<span class="keyword">Class</span> cls, SEL name)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–<span class="title">Method</span>çš„è¿”å›å€¼ç±»å‹<span class="params">(éœ€æ‰‹åŠ¨é‡Šæ”¾)</span></span></span><br><span class="line"><span class="function"><span class="title">char</span> *<span class="title">method_copyReturnType</span><span class="params">(<span class="keyword">Method</span> m)</span></span></span><br><span class="line"><span class="function">//<span class="title">void</span> <span class="title">method_getReturnType</span><span class="params">(<span class="keyword">Method</span> m, char *dst, size_t dst_len)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–æŒ‡å®š<span class="title">Method</span>çš„ç±»å‹</span></span><br><span class="line"><span class="function"><span class="title">const</span> <span class="title">char</span> *<span class="title">method_getTypeEncoding</span><span class="params">(<span class="keyword">Method</span> m)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–<span class="title">Method</span>çš„å‚æ•°æ•°é‡</span></span><br><span class="line"><span class="function"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">method_getNumberOfArguments</span><span class="params">(<span class="keyword">Method</span> m)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–<span class="title">Method</span>ä¸­ç¬¬<span class="title">i</span>ä¸ªå‚æ•°çš„ç±»å‹<span class="params">(Char *ç±»å‹)</span><span class="params">(éœ€æ‰‹åŠ¨é‡Šæ”¾)</span></span></span><br><span class="line"><span class="function"><span class="title">char</span> *<span class="title">method_copyArgumentType</span><span class="params">(<span class="keyword">Method</span> m, unsigned int <span class="keyword">index</span>)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è·å–æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="title">Method</span> *<span class="title">class_copyMethodList</span><span class="params">(<span class="keyword">Class</span> cls, unsigned int *outCount)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">è®¾ç½®<span class="title">IMP</span></span></span><br><span class="line"><span class="function"><span class="title">IMP</span> <span class="title">method_setImplementation</span><span class="params">(<span class="keyword">Method</span> m, IMP imp)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">äº¤æ¢æ–¹æ³•å®ç°</span></span><br><span class="line"><span class="function"><span class="title">void</span> <span class="title">method_exchangeImplementations</span><span class="params">(<span class="keyword">Method</span> m1, <span class="keyword">Method</span> m2)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">æ·»åŠ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="title">BOOL</span> <span class="title">class_addMethod</span><span class="params">(<span class="keyword">Class</span> cls, SEL name, IMP imp, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">const</span> char *types)</span> </span></span><br><span class="line"><span class="function">æ›¿æ¢æ–¹æ³•                                 </span></span><br><span class="line"><span class="function"><span class="title">IMP</span> <span class="title">class_replaceMethod</span><span class="params">(<span class="keyword">Class</span> cls, SEL name, IMP imp, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> char *types)</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">æ ‡æ˜éœ€è¦æ‰‹åŠ¨é‡Šæ”¾çš„åŠ¨æ€å†…å­˜<span class="params">(å¦‚è¿”å›å€¼ç±»å‹/å‚æ•°ç±»å‹)</span></span></span><br><span class="line"><span class="function">// åŠæ—¶é‡Šæ”¾</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(argumentType)</span> <span class="title">free</span><span class="params">(argumentType)</span>;</span></span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç¤º</p><figure class="highlight monkey"><table><tr><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [<span class="built_in">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    YAPerson *person = [[YAPerson alloc] init];</span><br><span class="line">    </span><br><span class="line">    // è·å–<span class="function"><span class="keyword">Method</span></span></span><br><span class="line">    <span class="function"><span class="keyword">Method</span> <span class="title">method</span> =</span> class_getInstanceMethod([person <span class="class"><span class="keyword">class</span>] , <span class="title">NSSelectorFromString</span>(@"<span class="title">nameWithArg</span>:<span class="title">arg</span>:<span class="title">arg</span>:<span class="title">arg</span>:<span class="title">arg</span>:"));</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    // è·å–<span class="function"><span class="keyword">Method</span>çš„æ–¹æ³•åç§°</span></span><br><span class="line">    SEL sel = method_getName(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    NSLog(@<span class="string">"%@"</span>,NSStringFromSelector(sel));</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    // è·å–<span class="function"><span class="keyword">Method</span>çš„æ–¹æ³•å®ç°</span></span><br><span class="line">    IMP imp1 = method_getImplementation(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    IMP imp2 = class_getMethodImplementation([person <span class="class"><span class="keyword">class</span>],<span class="title">sel</span>);</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    // è·å–<span class="function"><span class="keyword">Method</span>çš„è¿”å›å€¼ç±»å‹(</span>éœ€æ‰‹åŠ¨é‡Šæ”¾)</span><br><span class="line">    char *returnType = method_copyReturnType(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (returnType) &#123;</span><br><span class="line">        NSLog(@<span class="string">"%@"</span>,[NSString stringWithUTF8String:returnType]);</span><br><span class="line">        free(returnType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    // è·å–æŒ‡å®š<span class="function"><span class="keyword">Method</span>çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">const</span> char *typeEncoding = method_getTypeEncoding(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (typeEncoding) &#123;</span><br><span class="line">        NSLog(@<span class="string">"%@"</span>,[NSString stringWithUTF8String:typeEncoding]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // è·å–<span class="function"><span class="keyword">Method</span>çš„å‚æ•°æ•°é‡</span></span><br><span class="line">    unsigned int arguementCount = method_getNumberOfArguments(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (arguementCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (unsigned int i = <span class="number">0</span>; i &lt; arguementCount; i++) &#123;</span><br><span class="line">            //è·å–<span class="function"><span class="keyword">Method</span>ä¸­ç¬¬<span class="title">i</span>ä¸ªå‚æ•°çš„ç±»å‹(</span>Char *ç±»å‹)(éœ€æ‰‹åŠ¨é‡Šæ”¾)</span><br><span class="line">            char *arguementType = method_copyArgumentType(<span class="function"><span class="keyword">method</span>, <span class="title">i</span>);</span></span><br><span class="line">            NSLog(@<span class="string">"%@"</span>,[NSString stringWithUTF8String:arguementType]);</span><br><span class="line">            </span><br><span class="line">            // æ‰‹åŠ¨é‡Šæ”¾</span><br><span class="line">            <span class="keyword">if</span> (arguementType) &#123;</span><br><span class="line">                free(arguementType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    // è®¾ç½®æ–°çš„æ–¹æ³•å®ç°IMP,å¹¶è¿”å›åŸå…ˆçš„IMP</span><br><span class="line">    IMP imp3 = method_setImplementation(<span class="function"><span class="keyword">method</span>, <span class="title">imp2</span>);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Method Swizzling</strong><br>ä½¿ç”¨ Method Swizzling çš„ç›®çš„é€šå¸¸éƒ½æ˜¯ä¸ºäº†ç»™ç¨‹åºå¢åŠ åŠŸèƒ½ï¼Œè€Œä¸æ˜¯å®Œå…¨åœ°æ›¿æ¢æŸä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½éœ€è¦åœ¨è‡ªå®šä¹‰çš„å®ç°ä¸­è°ƒç”¨åŸå§‹çš„å®ç°ã€‚</p><p>Swizzlingåº”è¯¥æ€»æ˜¯åœ¨+loadä¸­æ‰§è¡Œ</p><blockquote><p>åœ¨Objective-Cä¸­ï¼Œè¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨æ¯ä¸ªç±»çš„ä¸¤ä¸ªæ–¹æ³•ã€‚+loadä¼šåœ¨ç±»åˆå§‹åŠ è½½æ—¶è°ƒç”¨ï¼Œ+initializeä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œä¸”åªæœ‰åœ¨å®ç°äº†å®ƒä»¬æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚ç”±äºmethod swizzlingä¼šå½±å“åˆ°ç±»çš„å…¨å±€çŠ¶æ€ï¼Œå› æ­¤è¦å°½é‡é¿å…åœ¨å¹¶å‘å¤„ç†ä¸­å‡ºç°ç«äº‰çš„æƒ…å†µã€‚+loadèƒ½ä¿è¯åœ¨ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«åŠ è½½ï¼Œå¹¶ä¿è¯è¿™ç§æ”¹å˜åº”ç”¨çº§åˆ«çš„è¡Œä¸ºçš„ä¸€è‡´æ€§ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ+initializeåœ¨å…¶æ‰§è¡Œæ—¶ä¸æä¾›è¿™ç§ä¿è¯â€“äº‹å®ä¸Šï¼Œå¦‚æœåœ¨åº”ç”¨ä¸­æ²¡ä¸ºç»™è¿™ä¸ªç±»å‘é€æ¶ˆæ¯ï¼Œåˆ™å®ƒå¯èƒ½æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚</p></blockquote><p>Swizzlingåº”è¯¥æ€»æ˜¯åœ¨dispatch_onceä¸­æ‰§è¡Œ</p><blockquote><p>ä¸ä¸Šé¢ç›¸åŒï¼Œå› ä¸ºswizzlingä¼šæ”¹å˜å…¨å±€çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶é‡‡å–ä¸€äº›é¢„é˜²æªæ–½ã€‚åŸå­æ€§å°±æ˜¯è¿™æ ·ä¸€ç§æªæ–½ï¼Œå®ƒç¡®ä¿ä»£ç åªè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œä¸ç®¡æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ã€‚GCDçš„dispatch_onceå¯ä»¥ç¡®ä¿è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬åº”è¯¥å°†å…¶ä½œä¸ºmethod swizzlingçš„æœ€ä½³å®è·µã€‚</p></blockquote><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Method Swizzling</span></span><br><span class="line"><span class="comment"> ä¸€èˆ¬æ”¾åœ¨loadæ–¹æ³•ä¸­,å¹¶ä¸”ä½¿ç”¨dispatch_once,éœ€è¦è°ƒç”¨ class_addMethod æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (void)load &#123;</span><br><span class="line"> </span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        Class cls = [self <span class="class"><span class="keyword">class</span>];</span></span><br><span class="line">        </span><br><span class="line">        SEL oldSelector = NSSelectorFromString(@<span class="string">"XXXX"</span>);</span><br><span class="line">        SEL newSelector = NSSelectorFromString(@<span class="string">"XXXXXXXX"</span>);</span><br><span class="line">        </span><br><span class="line">        Method oldMethod = class_getInstanceMethod(cls, oldSelector);</span><br><span class="line">        Method newMethod = class_getInstanceMethod(cls, newSelector);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•ç»™æ—§çš„æ–¹æ³•oldSelectoræ·»åŠ æ–°çš„æ–¹æ³•newSelectotçš„å®ç°,å¦‚æœå·²ç»å­˜åœ¨æ–¹æ³•å®ç°,åˆ™æ·»åŠ å¤±è´¥</span></span><br><span class="line">        BOOL isSuccess = class_addMethod(cls, oldSelector, method_getImplementation(newMethod), method_getTypeEncoding(newMethod));</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123; <span class="comment">// æ·»åŠ æˆåŠŸ,é‚£ä¹ˆç”¨æ—§çš„æ–¹æ³•å®ç°æ›¿æ¢æ–°çš„æ–¹æ³•å®ç°</span></span><br><span class="line">            class_replaceMethod(cls, newSelector, method_getImplementation(oldMethod), method_getTypeEncoding(oldMethod));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ—§çš„æ–¹æ³•å·²ç»æœ‰äº†å®ç°,ç›´æ¥äº¤æ¢å³å¯</span></span><br><span class="line">            method_exchangeImplementations(newMethod, oldMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®classè·å–æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> class ç±»</span></span><br><span class="line"><span class="comment"> <span class="doctag">@return</span> æ–¹æ³•åç§°æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">+ (NSArray *)ya_getMethodList:(Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ–¹æ³•åˆ—è¡¨æ•°é‡</span></span><br><span class="line">    unsigned int methodCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è·å–æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    Method *methodList = class_copyMethodList(<span class="class"><span class="keyword">class</span>, <span class="type">&amp;methodCount);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­˜å‚¨æ–¹æ³•åç§°</span></span><br><span class="line">    NSMutableArray *array = [NSMutableArray array];</span><br><span class="line">    <span class="keyword">if</span> (methodList) &#123;</span><br><span class="line">        <span class="keyword">for</span> (unsigned int i = <span class="number">0</span>; i &lt; methodCount; i ++) &#123;</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•</span></span><br><span class="line">            Method method = methodList[i];</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•åç§°</span></span><br><span class="line">            SEL sel = method_getName(method);</span><br><span class="line">            </span><br><span class="line">            [array addObject:NSStringFromSelector(sel)];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾</span></span><br><span class="line">        free(methodList);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [NSArray arrayWithArray:array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> äº¤æ¢å®ä¾‹æ–¹æ³•å®ç°</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> class ç±»</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> aSEL æ–¹æ³•ä¸€çš„åç§°</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> bSEL æ–¹æ³•äºŒçš„åç§°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (void)ya_exchangeInstanceMethod:(Class)<span class="class"><span class="keyword">class</span> <span class="title">firstMethod</span>:<span class="type"></span></span>(SEL)aSEL secondMethod:(SEL)bSEL &#123;</span><br><span class="line">    Method aMethad = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">aSEL);</span></span></span><br><span class="line">    Method bMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">bSEL);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äº¤æ¢æ–¹æ³•å®ç°</span></span><br><span class="line">    method_exchangeImplementations(aMethad, bMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> äº¤æ¢ç±»æ–¹æ³•å®ç°</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> class ç±»</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> aSEL æ–¹æ³•ä¸€çš„åç§°</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> bSEL æ–¹æ³•äºŒçš„åç§°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (void)ya_exchangeClassMethod:(Class)<span class="class"><span class="keyword">class</span> <span class="title">firstMethod</span>:<span class="type"></span></span>(SEL)aSEL secondMethod:(SEL)bSEL &#123;</span><br><span class="line">    Method aMethad = class_getClassMethod(<span class="class"><span class="keyword">class</span>, <span class="type">aSEL);</span></span></span><br><span class="line">    Method bMethod = class_getClassMethod(<span class="class"><span class="keyword">class</span>, <span class="type">bSEL);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äº¤æ¢æ–¹æ³•å®ç°</span></span><br><span class="line">    method_exchangeImplementations(aMethad, bMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä¸ºç±»æ·»åŠ åä¸ºnewSELçš„(å®ä¾‹)æ–¹æ³•</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> class ç±»</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> aSEL æ–°çš„æ–¹æ³•åç§°</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> bSEL å·²ç»å­˜åœ¨çš„æ–¹æ³•åç§°</span></span><br><span class="line"><span class="comment"> <span class="doctag">@return</span> æ˜¯å¦æ·»åŠ æˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (BOOL)ya_addMethod:(Class)<span class="class"><span class="keyword">class</span> <span class="title">newSEL</span>:<span class="type"></span></span>(SEL)aSEL existSEL:(SEL)bSEL &#123;</span><br><span class="line">    <span class="comment">// è·å–å·²ç»å­˜åœ¨çš„æ–¹æ³•</span></span><br><span class="line">    Method method = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">bSEL);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å·²ç»å­˜åœ¨çš„æ–¹æ³•çš„å®ç°</span></span><br><span class="line">    IMP imp = class_getMethodImplementation(<span class="class"><span class="keyword">class</span>, <span class="type">bSEL);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–type</span></span><br><span class="line">    const char *type = method_getTypeEncoding(method);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»™classæ·»åŠ åç§°ä¸ºaSELçš„æ–¹æ³•å®ç°</span></span><br><span class="line">    <span class="keyword">return</span> class_addMethod(<span class="class"><span class="keyword">class</span>, <span class="type">aSEL</span>, <span class="type">imp</span>, <span class="type">type);</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    å¦‚æœçˆ¶ç±»ä¸­å·²ç»æœ‰è¯¥åç§°çš„æ–¹æ³•,é‚£ä¹ˆè°ƒç”¨åå°†é‡å†™è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="comment">    å¦‚æœæœ¬ç±»ä¸­å·²ç»æœ‰äº†è¯¥åç§°çš„æ–¹æ³•å®ç°,é‚£ä¹ˆå°†æ·»åŠ å¤±è´¥</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</span><br><span class="line"></span><br><span class="line">å±æ€§ç›¸å…³ä¿¡æ¯</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;         </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value;          </span><br><span class="line">&#125; objc_property_attribute_t;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è·å–å±æ€§</span><br><span class="line">objc_property_t class_getProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line"></span><br><span class="line">è·å–å±æ€§åˆ—è¡¨</span><br><span class="line">objc_property_t *class_copyPropertyList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"></span><br><span class="line">è·å–å±æ€§ä¿¡æ¯åˆ—è¡¨</span><br><span class="line">objc_property_attribute_t *property_copyAttributeList(objc_property_t property, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"></span><br><span class="line">è·å–å±æ€§ä¿¡æ¯ä¸­æŸä¸ªValue</span><br><span class="line"><span class="keyword">char</span> *property_copyAttributeValue(objc_property_t property, <span class="keyword">const</span> <span class="keyword">char</span> *attributeName)</span><br><span class="line"></span><br><span class="line">æ·»åŠ å±æ€§</span><br><span class="line"><span class="built_in">BOOL</span> class_addProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount)</span><br><span class="line"></span><br><span class="line">æ›¿æ¢å±æ€§</span><br><span class="line"><span class="keyword">void</span> class_replaceProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount)</span><br><span class="line"></span><br><span class="line">è·å–å±æ€§åç§°</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *property_getName(objc_property_t property) </span><br><span class="line"></span><br><span class="line">è·å–å±æ€§ç›¸å…³ä¿¡æ¯</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *property_getAttributes(objc_property_t property)</span><br></pre></td></tr></table></figure><p>å®ä¾‹æ¼”ç¤º</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line"></span><br><span class="line">    YAPerson *person = [[YAPerson alloc] init];</span><br><span class="line">    Class cls = [person class];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å±æ€§</span></span><br><span class="line">    <span class="keyword">objc_property_t</span> property = class_getProperty(cls, <span class="string">"school"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å±æ€§åç§°</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,propertyName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å±æ€§ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// objc_property_attribute_t *property_copyAttributeList(objc_property_t property, unsigned int *outCount)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å±æ€§ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *propertyAttributes = property_getAttributes(property);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,propertyAttributes); <span class="comment">// æ‰“å° T@"NSObject",W,N,V_school</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®è·å–å±æ€§ä¿¡æ¯ä¸­çš„nameè·å–å¯¹åº”çš„Value</span></span><br><span class="line">    <span class="keyword">char</span> *propertyValue = property_copyAttributeValue(property, <span class="string">"T"</span>); <span class="comment">// ç±»å‹</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,propertyValue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     T ç±»å‹ ä¾‹å¦‚:NSObject</span></span><br><span class="line"><span class="comment">     V å€¼(æˆå‘˜å˜é‡) ä¾‹å¦‚ _school</span></span><br><span class="line"><span class="comment">     C copy</span></span><br><span class="line"><span class="comment">     N nonatommic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å±æ€§</span></span><br><span class="line">    <span class="keyword">objc_property_attribute_t</span> type = &#123; <span class="string">"T"</span>, [[NSString stringWithFormat:@<span class="string">"@\"%@\""</span>,NSStringFromClass([NSString class])] UTF8String] &#125;; <span class="comment">//type</span></span><br><span class="line">    <span class="keyword">objc_property_attribute_t</span> ownership0 = &#123; <span class="string">"C"</span>, <span class="string">""</span> &#125;; <span class="comment">// C = copy</span></span><br><span class="line">    <span class="keyword">objc_property_attribute_t</span> ownership = &#123; <span class="string">"N"</span>, <span class="string">""</span> &#125;; <span class="comment">//N = nonatomic</span></span><br><span class="line">    <span class="keyword">objc_property_attribute_t</span> backingivar  = &#123; <span class="string">"V"</span>, [[NSString stringWithFormat:@<span class="string">"_%s"</span>, <span class="string">"propertyName"</span>] UTF8String] &#125;;  <span class="comment">//variable name</span></span><br><span class="line">    <span class="keyword">objc_property_attribute_t</span> attrs[] = &#123; type, ownership0, ownership, backingivar &#125;;</span><br><span class="line">    <span class="keyword">if</span> (class_addProperty(cls, <span class="string">"propertyName"</span>, attrs, <span class="number">4</span>)) &#123;</span><br><span class="line">        NSLog(@<span class="string">"æ·»åŠ æˆåŠŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// æ›¿æ¢å±æ€§</span></span><br><span class="line">    <span class="comment">//void class_replaceProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®classè·å–ç±»çš„å±æ€§åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param class ç±»</span></span><br><span class="line"><span class="comment"> @return å±æ€§åˆ—è¡¨æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (NSArray *)ya_getPropertyList:(Class)<span class="class"><span class="keyword">class</span> &#123;</span></span><br><span class="line">    <span class="comment">// ç§æœ‰/å…¬æœ‰/ç±»æ‰©å±•ä¸­çš„æ‰€æœ‰å±æ€§æ•°é‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å±æ€§åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">objc_property_t</span> *propertyList = class_copyPropertyList(class, &amp;count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­˜å‚¨å±æ€§åç§°</span></span><br><span class="line">    NSMutableArray *<span class="built_in">array</span> = [NSMutableArray <span class="built_in">array</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* c_propertyName = property_getName(propertyList[i]);</span><br><span class="line">        [<span class="built_in">array</span> addObject:[NSString stringWithUTF8String:c_propertyName]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">free</span>(propertyList);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [NSArray arrayWithArray:<span class="built_in">array</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h3><p>æœ¬éƒ¨åˆ†åº”ç”¨è¾ƒå°‘ï¼Œæœªåšè¯¦ç»†å®è·µã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_protocol_list &#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *next;</span><br><span class="line">    <span class="keyword">long</span> count;</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> Protocol *list[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">æ˜¯å¦éµå¾ªåè®®</span><br><span class="line"><span class="built_in">BOOL</span> class_conformsToProtocol(Class cls, Protocol *protocol)</span><br><span class="line"></span><br><span class="line">åè®®åˆ—è¡¨</span><br><span class="line">Protocol * __<span class="keyword">unsafe_unretained</span> *class_copyProtocolList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"></span><br><span class="line">Protocol * __<span class="keyword">unsafe_unretained</span> *objc_copyProtocolList(<span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"></span><br><span class="line">Protocol * __<span class="keyword">unsafe_unretained</span> *protocol_copyProtocolList(Protocol *proto, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"></span><br><span class="line">åŠ¨æ€æ·»åŠ åè®®</span><br><span class="line"><span class="built_in">BOOL</span> class_addProtocol(Class cls, Protocol *protocol) </span><br><span class="line"></span><br><span class="line">è·å–æŒ‡å®šåç§°çš„åè®®</span><br><span class="line">Protocol *objc_getProtocol(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line"></span><br><span class="line">åè®®Aæ˜¯å¦éµå¾ªåè®®B</span><br><span class="line"><span class="built_in">BOOL</span> protocol_conformsToProtocol(Protocol *proto, Protocol *other)</span><br><span class="line"></span><br><span class="line">ä¸¤ä¸ªåè®®æ˜¯å¦ç›¸ç­‰</span><br><span class="line"><span class="built_in">BOOL</span> protocol_isEqual(Protocol *proto, Protocol *other)</span><br><span class="line"></span><br><span class="line">è·å–æŸä¸ªåè®®çš„åç§°</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *protocol_getName(Protocol *p)</span><br><span class="line"></span><br><span class="line">åŠ¨æ€ç”Ÿæˆåè®®</span><br><span class="line">Protocol *objc_allocateProtocol(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line"><span class="keyword">void</span> objc_registerProtocol(Protocol *proto) </span><br><span class="line"></span><br><span class="line">ç»™åè®®æ·»åŠ æ–¹æ³•</span><br><span class="line"><span class="keyword">void</span> protocol_addMethodDescription(Protocol *proto, SEL name, <span class="keyword">const</span> <span class="keyword">char</span> *types, <span class="built_in">BOOL</span> isRequiredMethod, <span class="built_in">BOOL</span> isInstanceMethod) </span><br><span class="line"></span><br><span class="line">ç»™åè®®æ·»åŠ åè®®</span><br><span class="line"><span class="keyword">void</span> protocol_addProtocol(Protocol *proto, Protocol *addition) </span><br><span class="line"></span><br><span class="line">ç»™åè®®æ·»åŠ å±æ€§</span><br><span class="line"><span class="keyword">void</span> protocol_addProperty(Protocol *proto, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount, <span class="built_in">BOOL</span> isRequiredProperty, <span class="built_in">BOOL</span> isInstanceProperty)</span><br></pre></td></tr></table></figure><p>æ ¹æ®classè·å–éµå¾ªçš„åè®®åˆ—è¡¨<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®classè·å–éµå¾ªçš„åè®®åˆ—è¡¨</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param class ç±»</span></span><br><span class="line"><span class="comment"> @return åè®®åç§°åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">NSArray</span> *)ya_getProtocolList:(Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="comment">// åè®®åˆ—è¡¨æ•°é‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–åè®®åˆ—è¡¨</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> Protocol **protocolList = class_copyProtocolList(<span class="keyword">class</span>, &amp;count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­˜å‚¨åè®®</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">        <span class="comment">// è·å–åè®®</span></span><br><span class="line">        Protocol *protocol = protocolList[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–åè®®åç§°</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *c_protocolName = protocol_getName(protocol);</span><br><span class="line">        </span><br><span class="line">        [array addObject:[<span class="built_in">NSString</span> stringWithUTF8String:c_protocolName]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾</span></span><br><span class="line">    free(protocolList);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:array];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="äºŒã€æŠ€èƒ½"><a href="#äºŒã€æŠ€èƒ½" class="headerlink" title="äºŒã€æŠ€èƒ½"></a>äºŒã€æŠ€èƒ½</h2><h3 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h3><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong><br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (sel_isEqual(sel, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"ss"</span>))) &#123;</span><br><span class="line">        <span class="comment">// è¦æ±‚å‚æ•°è¦åŒ¹é…</span></span><br><span class="line">        [YARuntime ya_addMethod:[<span class="keyword">self</span> <span class="keyword">class</span>] newSEL:sel existSEL:<span class="keyword">@selector</span>(printPersonalInfo)];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>ç¬¬äºŒæ­¥ï¼š</strong><br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (sel_isEqual(aSelector, NSSelectorFromString(@<span class="string">"ss"</span>))) &#123;</span><br><span class="line">        <span class="comment">// è½¬å‘ç»™å·²ç»å­˜åœ¨çš„å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> [[YAPerson alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">forwardingTargetForSelector:</span>aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>ç¬¬ä¸‰æ­¥ï¼š</strong><br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    NSMethodSignature *signature = [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>aSelector];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°signature(æ–¹æ³•ç­¾å),åªèƒ½æ‰‹åŠ¨æä¾›</span></span><br><span class="line">    <span class="keyword">if</span> (signature == nil) &#123;</span><br><span class="line">        signature = [NSMethodSignature <span class="string">signatureWithObjCTypes:</span><span class="string">"@@:"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</span><br><span class="line">    YAPerson *personClass = [[YAPerson alloc] init];</span><br><span class="line">    SEL sel = anInvocation.selector;</span><br><span class="line">    <span class="keyword">if</span> ([personClass <span class="string">respondsToSelector:</span>sel]) &#123;</span><br><span class="line">        <span class="comment">// æœ€åä¸€æ¬¡æœºä¼š</span></span><br><span class="line">        [anInvocation <span class="string">invokeWithTarget:</span>personClass];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å›å¤©ä¹åŠ›</span></span><br><span class="line">        [self <span class="string">doesNotRecognizeSelector:</span>sel];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="å¤šé‡ç»§æ‰¿"><a href="#å¤šé‡ç»§æ‰¿" class="headerlink" title="å¤šé‡ç»§æ‰¿"></a>å¤šé‡ç»§æ‰¿</h3><blockquote><p>ä¸ä¼šåšèœçš„ç¨‹åºå‘˜ä¸æ˜¯å¥½ç”·äººã€‚</p></blockquote><p>YADeveloper ç»§æ‰¿è‡ª YAManï¼Œæƒ³è®©YADeveloperå®ä¾‹å¯¹è±¡åŒæ—¶å…·å¤‡å“åº” YAManæ–¹æ³•å’Œ YACookæ–¹æ³•çš„èƒ½åŠ›ã€‚</p><p>YAMan:</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAMan </span>: NSObject</span><br><span class="line">- (void)printMan;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> YAMan</span><br><span class="line">- (void)printMan &#123;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"æˆ‘æ˜¯ä¸€ä¸ªç”·äºº"</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><p>YACook:</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YACook </span>: NSObject </span><br><span class="line">- (void)printCook;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> YACook</span><br><span class="line">- (void)printCook &#123;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"æˆ‘æ˜¯ä¸ªä¼šåšèœçš„äºº"</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><p>YADeveloper:</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@class</span> YACook;</span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">YADeveloper </span>: YAMan</span><br><span class="line"><span class="variable">@property</span> (nonatomic,strong) YACook *cook;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">printDev</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜YACookçš„æ–¹æ³•,ä½¿ç¼–è¯‘é€šè¿‡</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">printCook</span>;</span><br><span class="line">@<span class="selector-tag">end</span></span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">YADeveloper</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">printDev</span> &#123;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"æˆ‘æ˜¯ä¸ªä¼šå†™ç¨‹åºçš„äºº"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (sel_isEqual(aSelector, NSSelectorFromString(@<span class="string">"printCook"</span>))) &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦é¢„å…ˆå¯¹self.cookåˆå§‹åŒ–</span></span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">self</span><span class="selector-class">.cook</span>;</span><br><span class="line">        <span class="comment">// æˆ–è€…ç›´æ¥åˆ›å»º</span></span><br><span class="line">        <span class="comment">// return [[YACook alloc] init];</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><h3 id="å…³è”å¼•ç”¨"><a href="#å…³è”å¼•ç”¨" class="headerlink" title="å…³è”å¼•ç”¨"></a>å…³è”å¼•ç”¨</h3><p>æ³¨æ„ç‚¹:</p><ol><li>objc_removeAssociatedObjects å‡½æ•°ä¸€èˆ¬ä¸å¯æ‰‹åŠ¨è°ƒç”¨ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¼šç§»é™¤ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡ï¼Œå°†è¯¥å¯¹è±¡æ¢å¤æˆâ€œåŸå§‹â€çŠ¶æ€ã€‚è¿™æ ·åšå°±å¾ˆæœ‰å¯èƒ½æŠŠåˆ«äººæ·»åŠ çš„å…³è”å¯¹è±¡ä¹Ÿä¸€å¹¶ç§»é™¤ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„ã€‚æ‰€ä»¥ä¸€èˆ¬çš„åšæ³•æ˜¯é€šè¿‡ç»™ objc_setAssociatedObject å‡½æ•°ä¼ å…¥ nil æ¥ç§»é™¤æŸä¸ªå·²æœ‰çš„å…³è”å¯¹è±¡ã€‚</li><li>å…³è”å¯¹è±¡ä¸è¢«å…³è”å¯¹è±¡æœ¬èº«çš„å­˜å‚¨å¹¶æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œå®ƒæ˜¯å­˜å‚¨åœ¨å•ç‹¬çš„å“ˆå¸Œè¡¨ä¸­çš„ã€‚<h4 id="ç»™åˆ†ç±»æ·»åŠ weakå±æ€§"><a href="#ç»™åˆ†ç±»æ·»åŠ weakå±æ€§" class="headerlink" title="ç»™åˆ†ç±»æ·»åŠ weakå±æ€§"></a>ç»™åˆ†ç±»æ·»åŠ weakå±æ€§</h4><blockquote><p>ç»™ä»»æ„å¯¹è±¡A æ·»åŠ  weakå±æ€§ B</p></blockquote></li></ol><p>é—®é¢˜å…³é”®ç‚¹:åœ¨å±æ€§é”€æ¯çš„æ—¶å€™ï¼Œå°†å…¶ç½®ä¸ºç©º(æˆ–è€…è¯´åœ¨å…³è”å¯¹è±¡é”€æ¯çš„æ—¶å€™ï¼Œä½¿objc_getAssociatedObjectå¾—åˆ°çš„æ˜¯nil)ã€‚</p><h5 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h5><p>é€šè¿‡ç»§æ‰¿å…³è”å¯¹è±¡B ï¼Œé‡å†™å…¶deallocæ–¹æ³•å³å¯é€‚æ—¶æŠŠAä¸­çš„å…³è”å¯¹è±¡è¿”å›å€¼è®¾ç½®ä¸ºnilï¼Œè¾¾åˆ°è‡ªåŠ¨ç½®ç©ºçš„ç›®çš„ï¼Œè¿™ä¹Ÿæ˜¯æœ€æœ¬èƒ½çš„æ–¹æ³•ã€‚</p><p>ç»™NSObjectæ·»åŠ åˆ†ç±»ï¼Œä¹Ÿå³ä»»ä½•ç»§æ‰¿è‡ªNSObjectçš„å¯¹è±¡éƒ½å¯ä»¥æœ‰weakå±æ€§ã€‚</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> NSObject (YAWeakProperty)</span><br><span class="line"><span class="variable">@property</span> (nonatomic, weak) YAProperty *property;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> NSObject (YAWeakProperty)</span><br><span class="line"><span class="comment">// const static char *key = "key";</span></span><br><span class="line">- (id)property &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">objc_getAssociatedObject</span>(self, <span class="variable">@selector</span>(property));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">setProperty</span><span class="selector-pseudo">:(YAProperty</span> *)<span class="selector-tag">property</span> &#123;</span><br><span class="line">    <span class="selector-tag">objc_setAssociatedObject</span>(self, <span class="variable">@selector</span>(property), property, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    <span class="selector-attr">[property setAssociate:self selector:@selector(setProperty:)]</span>;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><p>å…³è”å¼•ç”¨çš„keyä¸€èˆ¬ä½¿ç”¨getteræ–¹æ³•çš„selectorï¼Œæ­¤æ—¶getæ–¹æ³•ä¸­çš„keyä¹Ÿå¯ä½¿ç”¨_cmdï¼ŒäºŒè€…ç­‰æ•ˆã€‚</p><p>å±æ€§çš„å®ç°:</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAProperty</span> : <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)setAssociate:(<span class="built_in">NSObject</span> *)associatedObject selector:(SEL)sel;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»æ‰©å±•</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAProperty</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">   __<span class="keyword">weak</span> <span class="keyword">id</span> _associatedObject;</span><br><span class="line">   SEL _sel;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAProperty</span></span></span><br><span class="line">- (<span class="keyword">void</span>)setAssociate:(<span class="built_in">NSObject</span> *)associatedObject selector:(SEL)sel &#123;</span><br><span class="line">    _associatedObject = associatedObject;</span><br><span class="line">    _sel = sel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL,<span class="keyword">id</span>)) objc_msgSend)(_associatedObject, _sel, <span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œæœ‰ä¸ªé—®é¢˜ï¼šæ·»åŠ çš„å±æ€§ç»§æ‰¿è‡ªNSObjectæ—¶éå¸¸å®Œç¾ï¼Œä½†æ˜¯å®é™…é¡¹ç›®ä¸­ä¸å¯èƒ½ç»™ä»»æ„å¯¹è±¡æ·»åŠ çš„å±æ€§éƒ½æ˜¯NSObjectï¼Œæœ‰å¯èƒ½æ˜¯NSString/NSArray/NSDictionary/NSSetç­‰ç­‰ã€‚é‚£ä¹ˆå°±åªèƒ½ç»§æ‰¿è‡ªNSString/NSArray/NSDictionary/NSSetç­‰ç³»ç»Ÿç±»ï¼Œè¿™æ ·ä¼šå‡ºç°ä¸€ç³»åˆ—ä¸€ç³»åˆ—ä¸€ç³»åˆ—é—®é¢˜ï¼Œè‹¹æœå¹¶ä¸å»ºè®®æˆ‘ä»¬ä½¿ç”¨NSString/NSArray/NSDictionary/NSSetç­‰çš„æ´¾ç”Ÿç±»(è¿™äº›ç±»å·²ç»è¶³å¤Ÿå¥½äº†ï¼Œä¸éœ€è¦ç”»è›‡æ·»è¶³)ã€‚</p><h5 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h5><blockquote><p>ç”¨ä¸€ä¸ªNSPointerArrayï¼ˆå¼±å¼•ç”¨ç±»å‹çš„æ•°ç»„ï¼‰åŒ…ä¸€å±‚å°±å¯ä»¥äº†ã€‚è™½ç„¶å…³è”å±æ€§çš„policyä¸æ”¯æŒweakï¼Œä½†æ˜¯ä½ å¯ä»¥æŠŠè¦å…³è”çš„å¯¹è±¡æ”¾å…¥ä¸€ä¸ªå¼±å¼•ç”¨æ•°ç»„é‡Œé¢ï¼Œç„¶åæŠŠè¿™ä¸ªå¼±å¼•ç”¨æ•°ç»„è®¾ç½®ä¸ºå…³è”å¯¹è±¡ï¼Œæ¯æ¬¡å–å€¼çš„æ—¶å€™ï¼Œåªéœ€è¦ä»è¿™ä¸ªå¼±å¼•ç”¨æ•°ç»„é‡Œé¢å–å°±å¯ä»¥äº†ã€‚ä¸€æ ·å¯ä»¥è¾¾åˆ°å…³è”å¼±å¼•ç”¨å¯¹è±¡çš„æ•ˆæœã€‚</p></blockquote><h5 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h5><p>A å…³è” C<br>B å…³è” C<br>C é”€æ¯ é€šçŸ¥B<br>B å†å‘Šè¯‰ A</p><h5 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h5><p>é˜…è¯»å¤§ç¥åšå®¢å‘ç°çš„æ–°æ–¹æ³•ï¼Œè§2019å¹´æ–°å†™çš„æ–‡ç« ï¼š <a href="https://blog.chenyalun.com/2019/01/20/Weak%20Associated%20Object/">Weak Associated Object</a></p><h2 id="ä¸‰ã€è¦ç‚¹"><a href="#ä¸‰ã€è¦ç‚¹" class="headerlink" title="ä¸‰ã€è¦ç‚¹"></a>ä¸‰ã€è¦ç‚¹</h2><h3 id="free"><a href="#free" class="headerlink" title="free()"></a>free()</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>() å‡½æ•°ç”¨æ¥é‡Šæ”¾åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œå…¶åŸå‹ä¸ºï¼š</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">free</span> <span class="params">(<span class="keyword">void</span>* ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>() å¯ä»¥é‡Šæ”¾ç”± <span class="built_in">malloc</span>()ã€<span class="built_in">calloc</span>()ã€<span class="built_in">realloc</span>() åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿å…¶ä»–ç¨‹åºå†æ¬¡ä½¿ç”¨ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠæ—¶é‡Šæ”¾å­—ç¬¦ä¸²å¸¸é‡</span></span><br><span class="line"><span class="keyword">if</span> (argumentType) <span class="built_in">free</span>(argumentType);</span><br></pre></td></tr></table></figure><h3 id="NONNULL"><a href="#NONNULL" class="headerlink" title="NONNULL"></a>NONNULL</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span>å’Œ<span class="built_in">NS_ASSUME_NONNULL_END</span>ã€‚</span><br><span class="line">åœ¨è¿™ä¸¤ä¸ªå®ä¹‹é—´çš„ä»£ç ï¼Œæ‰€æœ‰ç®€å•æŒ‡é’ˆå¯¹è±¡éƒ½è¢«å‡å®šä¸º <span class="keyword">nonnull</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define NS_ASSUME_NONNULL_BEGIN _Pragma(<span class="meta-string">"clang assume_nonnull begin"</span>)</span></span><br><span class="line"><span class="meta">#define NS_ASSUME_NONNULL_END   _Pragma(<span class="meta-string">"clang assume_nonnull end"</span>)</span></span><br></pre></td></tr></table></figure><h3 id="covariant"><a href="#covariant" class="headerlink" title="__covariant"></a>__covariant</h3><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="variable">__covariant</span> - åå˜æ€§ï¼Œå­ç±»å‹å¯ä»¥å¼ºè½¬åˆ°çˆ¶ç±»å‹ï¼ˆé‡Œæ°æ›¿æ¢åŸåˆ™ï¼‰</span><br><span class="line"><span class="variable">__contravariant</span> - é€†å˜æ€§ï¼Œçˆ¶ç±»å‹å¯ä»¥å¼ºè½¬åˆ°å­ç±»å‹ï¼ˆWTFï¼‰</span><br></pre></td></tr></table></figure><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="variable">__kindof</span></span><br></pre></td></tr></table></figure><h3 id="å†…è”"><a href="#å†…è”" class="headerlink" title="å†…è”"></a>å†…è”</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="strong">__attribute__</span>((always_inline)) çš„æ„æ€æ˜¯å¼ºåˆ¶å†…è”</span><br></pre></td></tr></table></figure><blockquote><p>å‚è€ƒå¹¶æ„Ÿè°¢<br><a href="http://www.cnblogs.com/ludashi/p/6294112.html" target="_blank" rel="noopener">é’ç‰ä¼æ¡ˆ</a><br><a href="http://southpeak.github.io/2014/11/06/objective-c-runtime-4/" target="_blank" rel="noopener">å—å³°å­</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;2018.8.26 æ›´æ–°Classå®šä¹‰&lt;br&gt;2019.3.25 æ›´æ–°è®¾ç½®weakå…³è”å±æ€§&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å…³äºRuntimeçš„ç®€å•æ€»ç»“ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>å¼€æºé¡¹ç›®ï¼šYAScrollPlaceView</title>
    <link href="http://blog.chenyalun.com/2017/10/01/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%EF%BC%9AYAScrollPlaceView/"/>
    <id>http://blog.chenyalun.com/2017/10/01/å¼€æºé¡¹ç›®ï¼šYAScrollPlaceView/</id>
    <published>2017-10-01T12:22:33.000Z</published>
    <updated>2019-08-21T07:57:47.135Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2019.8.4 è¡¥å……å†…å®¹</p></blockquote><p></p><p align="center"> å¯ä»¥ç»™UIScrollViewã€UITableViewæ·»åŠ å¤´å°¾è§†å›¾ã€‚ </p><br><a id="more"></a><p></p><h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>ç™¾åº¦ç•…å¬æ˜¯æˆ‘å·¥ä½œåçš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œå¤§æ¦‚å°±æ˜¯æ‰‹ç™¾é‡Œé¢çš„â€œå–œé©¬æ‹‰é›…â€ã€‚</p><p>æŸä¸€å¤©UEæäº†ä¸ªéœ€æ±‚ï¼Œå¤§æ„å°±æ˜¯åœ¨<code>UITableView</code>åº•éƒ¨åŠ ä¸ªlogoå›¾ç‰‡ï¼Œè¦æ±‚è¿™å¼ å›¾ç‰‡èƒ½éšç€<code>UITableViewCell</code>çš„æ»‘åŠ¨è€Œè·Ÿç€æ»‘åŠ¨ã€‚ä¹ä¸€æƒ³ï¼Œå¯ä»¥ä½¿ç”¨ç›´æ¥ä½¿ç”¨<code>UITableView</code>çš„<code>tableFooterView</code>ï¼Œèµ‹å€¼ä¸ª<code>UIImageView</code>å³å¯ï¼Œå¯æ˜¯è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼šå½“æ•°æ®å¾ˆå°‘çš„æ—¶å€™ï¼Œè¿™ä¸ªlogoå›¾ç‰‡å¿…é¡»ç´§æŒ¨ç€å±å¹•æœ€ä¸‹æ–¹ã€‚å¾ˆæ˜¾ç„¶ï¼Œ<code>tableFooterView</code>è‡ªå·±ä¼šè·‘åˆ°é¡¶éƒ¨ï¼Œæ»¡è¶³ä¸äº†éœ€æ±‚ã€‚</p><p>å…³é”®æ˜¯ï¼Œé‚£ä¸€é˜µå­åˆšè¯»äº†<code>MJRefresh</code>çš„æºç ï¼Œåˆç—´è¿·äº<code>Runtime</code>çš„å„ç§é­”æ³•ï¼Œèµ°ç«å…¥é­”çš„å‰å®³ï¼Œè¿˜ç‰¹åˆ«æƒ³å†™ä¸€ä¸ªå¼€æºé¡¹ç›®é€èƒ½ï¼Œäºæ˜¯è¿™ä¸ªèƒ½ç»™<code>UIScrollView</code>æ·»åŠ å¤´éƒ¨ã€å°¾éƒ¨è§†å›¾çš„æ¡†æ¶äº§ç”Ÿäº†ã€‚</p><p>é¡¹ç›®åœ°å€:<a href="https://github.com/ChenYalun/YAScrollPlaceView" target="_blank" rel="noopener">https://github.com/ChenYalun/YAScrollPlaceView</a></p><h1 id="äºŒã€æ€è·¯"><a href="#äºŒã€æ€è·¯" class="headerlink" title="äºŒã€æ€è·¯"></a>äºŒã€æ€è·¯</h1><p>æ€è·¯å¾ˆç®€å•ã€‚</p><ol><li>ä½¿ç”¨KVOç›‘å¬<code>UIScrollView</code>çš„<code>contentSize</code>å’Œ<code>contentOffset</code>ã€‚</li><li><p>æ ¹æ®<code>contentSize</code>ç¡®å®šFooterViewçš„ä½ç½®ã€‚</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç </span></span><br><span class="line">HeaderView<span class="selector-class">.y</span> = -size.<span class="attribute">height</span>;</span><br><span class="line">FooterView<span class="selector-class">.y</span> = contentSize.<span class="attribute">height</span>;</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®<code>UIScrollView</code>çš„<code>contentInset</code>ï¼Œç»™å ä½è§†å›¾è…¾å‡ºç©ºé—´ã€‚</p></li><li>æ ¹æ®<code>contentOffset.y</code>ç¡®å®šå½“å‰å ä½è§†å›¾æ˜¯å¦å¯ä»¥è·Ÿç€æ»‘åŠ¨ã€‚<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç </span></span><br><span class="line"><span class="built_in">if</span> (contentOffset.y + scrollView.<span class="built_in">height</span> - scrollView.contentInset.bottom - scrollView.contentSize.<span class="built_in">height</span> &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    FooterView.y = contentOffset.y + scrollView.<span class="built_in">height</span> - scrollView.contentInset.bottom;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>å¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ—¶æœºå’Œæ¥å£äº†ã€‚</p><ol><li><p>åœ¨<code>didMoveToSuperview</code>ä¸­æ·»åŠ KVOï¼Œåœ¨<code>willMoveToSuperview</code>ä¸­ç§»é™¤KVOã€‚</p><p> è¿™ä¸¤ä¸ªæˆåŒæˆå¯¹ï¼Œä¹‹æ‰€ä»¥ä¸æ”¾åœ¨<code>dealloc</code>é‡Œé¢ç§»é™¤ï¼Œæ˜¯è€ƒè™‘åˆ°æœ‰åŒä¸€ä¸ªè§†å›¾è¢«<code>didMoveToSuperview</code>å¤šæ¬¡çš„æƒ…å†µã€‚å½“ç„¶ï¼Œè§†å›¾<code>dealloc</code>çš„æ—¶å€™æ˜¯ä¼šè°ƒç”¨<code>willMoveToSuperview</code>æ–¹æ³•çš„ï¼Œåªä¸è¿‡è¿™ä¸ª<code>newSuperview</code>ä¸ºç©ºã€‚</p></li><li><p>ç»™<code>UIScrollView</code>æ·»åŠ å…³è”å±æ€§ã€‚<br>æ— éœ€å¤šè¨€ï¼Œæ²¡æœ‰ä¾µå…¥æ€§ã€‚</p> <figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">-</span> (YAScrollHeaderView *)<span class="selector-tag">scrollHeaderView</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">objc_getAssociatedObject</span>(self, <span class="variable">@selector</span>(scrollHeaderView));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">setScrollHeaderView</span><span class="selector-pseudo">:(YAScrollHeaderView</span> *)<span class="selector-tag">scrollHeaderView</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (scrollHeaderView == self.scrollHeaderView) <span class="selector-tag">return</span> ;</span><br><span class="line">    <span class="selector-attr">[self.scrollHeaderView removeFromSuperview]</span>;</span><br><span class="line">    <span class="selector-attr">[self addSubview:scrollHeaderView]</span>;</span><br><span class="line">    <span class="selector-tag">objc_setAssociatedObject</span>(self, <span class="variable">@selector</span>(scrollHeaderView), scrollHeaderView, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç»“æ„è®¾è®¡</p></li></ol><ul><li><code>YAScrollHeaderView</code>å’Œ<code>YAScrollFooterView</code>å‡ç»§æ‰¿è‡ª<code>YAScrollPlaceView</code>ã€‚ï¼ˆè¿™æ˜¯æ¨¡ä»¿äº†<code>MJRefresh</code>ï¼‰ã€‚æ ¸å¿ƒé€»è¾‘ç»Ÿä¸€åœ¨ä¸Šå±‚å®ç°ã€‚</li><li><code>YAScrollHeaderView</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®è‡ªå·±<code>scrollPlaceViewType</code>ä¸º<code>YAScrollPlaceViewTypeHeader</code>ã€‚</li><li><code>YAScrollFooterView</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®è‡ªå·±<code>scrollPlaceViewType</code>ä¸º<code>YAScrollPlaceViewTypeFooter</code>ã€‚<br>è¿™æ ·ï¼Œ<code>YAScrollPlaceView</code>å°±å¯ä»¥æ ¹æ®å­ç±»æ¥ç¡®å®šå ä½è§†å›¾çš„é€»è¾‘ã€‚</li></ul><h1 id="ä¸‰ã€ä½¿ç”¨"><a href="#ä¸‰ã€ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ä½¿ç”¨"></a>ä¸‰ã€ä½¿ç”¨</h1><p>æš´éœ²å‡ºæ¥çš„æ¥å£å¾ˆæ¸…æ™°ã€‚<code>isFixed</code>ç”¨äºè®¾ç½®å ä½è§†å›¾æ˜¯å¦åœ¨offsetè¶…å‡ºå¯è§åŒºåŸŸï¼ˆè¿‡å¤§æˆ–è€…è¿‡å°ï¼‰æ—¶è·Ÿéšç€æ»‘åŠ¨ã€‚è¿™ä¸ªå ä½è§†å›¾å¯ä»¥åŠ¨æ€æ˜¾ç¤ºæˆ–è€…éšè—ï¼Œ<code>canAnimate</code>è®¾ç½®å…¶åŠ¨ç”»æ•ˆæœï¼Œ<code>showAnimationDuration</code>å’Œ<code>dismissAnimationDuration</code>ä¸å¿…å¤šè¯´ï¼Œæ˜¯åŠ¨ç”»æ—¶é—´ã€‚</p><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> isFixed; <span class="comment">///&lt; default NO.Fix the place view to the top or bottom.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> canAnimate; <span class="comment">///&lt; default YES.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> height; <span class="comment">///&lt; default 0</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isVisible;; <span class="comment">///&lt; default NO.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> showAnimationDuration;    <span class="comment">///&lt; default 0.15</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> dismissAnimationDuration;   <span class="comment">///&lt; default 0.15</span></span><br><span class="line">- (<span class="keyword">void</span>)showWithCompletion:(YAScrollPlaceViewShowCompletion)completion;</span><br><span class="line">- (<span class="keyword">void</span>)dismissWithCompletion:(YAScrollPlaceViewDismissCompletion)completion;</span><br></pre></td></tr></table></figure><h3 id="ç»™ScrollViewè®¾ç½®å ä½å›¾ç‰‡"><a href="#ç»™ScrollViewè®¾ç½®å ä½å›¾ç‰‡" class="headerlink" title="ç»™ScrollViewè®¾ç½®å ä½å›¾ç‰‡"></a>ç»™ScrollViewè®¾ç½®å ä½å›¾ç‰‡</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">UIImage *headerImage = [UIImage imageNamed:@<span class="string">"header"</span>]<span class="comment">;</span></span><br><span class="line">YAScrollHeaderView *headerView = [YAScrollHeaderView <span class="keyword">scrollHeaderViewWithSize:CGSizeMake(self.view.bounds.size.width, </span><span class="number">100</span>) <span class="keyword">backgroundImage:headerImage];</span></span><br><span class="line"><span class="keyword">self.scrollView.scrollHeaderView </span>= headerView<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å·¦å›¾ï¼šæ•°æ®è¾ƒå¤šæ—¶ï¼Œè§†å›¾å›ºå®šï¼ˆä¹Ÿå¯ä»¥é…ç½®ä¸å›ºå®šï¼‰ï¼›<br>å³å›¾ï¼šæ•°æ®æå°‘æ—¶ï¼Œè§†å›¾ä¸å›ºå®šã€è·Ÿç€æ»‘åŠ¨ï¼ˆä¹Ÿå¯ä»¥é…ç½®ä¸ºå›ºå®šï¼‰ã€‚</p><p><img src="https://image.chenyalun.com/2017/10/01/003.gif" style="zoom:40%"><img src="https://image.chenyalun.com/2017/10/01/005.gif" style="zoom:40%"></p><h3 id="ç»™tableViewè®¾ç½®ç©ºç™½å ä½"><a href="#ç»™tableViewè®¾ç½®ç©ºç™½å ä½" class="headerlink" title="ç»™tableViewè®¾ç½®ç©ºç™½å ä½"></a>ç»™tableViewè®¾ç½®ç©ºç™½å ä½</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">YAScrollFooterView *footerView = [YAScrollFooterView new]<span class="comment">;</span></span><br><span class="line">footerView.height = <span class="number">100</span><span class="comment">;</span></span><br><span class="line">footerView.isFixed = YES<span class="comment">;</span></span><br><span class="line">self.tableView.<span class="keyword">scrollFooterView </span>= footerView<span class="comment">;</span></span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€åœ°æ˜¾ç¤ºæˆ–è€…éšè—"><a href="#åŠ¨æ€åœ°æ˜¾ç¤ºæˆ–è€…éšè—" class="headerlink" title="åŠ¨æ€åœ°æ˜¾ç¤ºæˆ–è€…éšè—"></a>åŠ¨æ€åœ°æ˜¾ç¤ºæˆ–è€…éšè—</h3><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="built_in">self</span>.tableView.scrollHeaderView = <span class="built_in">self</span>.<span class="keyword">header</span>;</span><br><span class="line"><span class="built_in">self</span>.<span class="keyword">header</span>.showAnimationDuration = <span class="number">0.8</span>f;</span><br><span class="line"><span class="built_in">self</span>.<span class="keyword">header</span>.dismissAnimationDuration = <span class="number">0.8</span>f;</span><br><span class="line"><span class="meta">[</span><span class="built_in">self</span>.<span class="keyword">header</span> show<span class="meta">]</span>;</span><br><span class="line">// <span class="meta">[</span><span class="built_in">self</span>.<span class="keyword">header</span> dismissWithCompletion:nil<span class="meta">]</span>;</span><br></pre></td></tr></table></figure><p><img src="https://image.chenyalun.com/2017/10/01/001.gif" style="zoom:40%"><img src="https://image.chenyalun.com/2017/10/01/002.gif" style="zoom:40%"></p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>æ•´ä½“è€Œè¨€ï¼Œå®ç°èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„ï¼Œæ²¡æœ‰å•¥æå…¶å¤æ‚çš„é€»è¾‘ã€‚ä¸è¿‡ä½œä¸ºæˆ‘çš„ç¬¬ä¸€ä¸ªå¼€æºFrameworkï¼Œè¿˜æŒºæœ‰çºªå¿µæ„ä¹‰çš„ã€‚æœ‰ä¸€æ–¹æœ‰äºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©ã€‚</p><blockquote><p>åè®°<br>2018å¹´ç§‹ï¼Œå­˜åœ¨ä¸¤å¹´çš„ç™¾åº¦ç•…å¬æ­£å¼ä¸‹çº¿ã€‚å–œé©¬æ‹‰é›…ã€æ‡’äººå¬ä¹¦ï¼Œè¿˜æ´»ç€ã€‚<br>2019å¹´8æœˆï¼Œæ•´ç†åšå®¢æ—¶ï¼Œå®Œå–„æ–‡ç« å†…å®¹å¹¶ä¿®å¤æ¡†æ¶çš„bugã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;2019.8.4 è¡¥å……å†…å®¹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;/p&gt;&lt;p align=&quot;center&quot;&gt; å¯ä»¥ç»™UIScrollViewã€UITableViewæ·»åŠ å¤´å°¾è§†å›¾ã€‚ &lt;/p&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="iOSå¼€å‘" scheme="http://blog.chenyalun.com/tags/iOS%E5%BC%80%E5%8F%91/"/>
    
      <category term="å¼€æºé¡¹ç›®" scheme="http://blog.chenyalun.com/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>æŸ¥æ‰¾ç®—æ³•æ€»ç»“</title>
    <link href="http://blog.chenyalun.com/2017/04/21/%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/"/>
    <id>http://blog.chenyalun.com/2017/04/21/æŸ¥æ‰¾ç®—æ³•æ€»ç»“/</id>
    <published>2017-04-21T11:10:17.000Z</published>
    <updated>2019-03-29T03:02:01.090Z</updated>
    
    <content type="html"><![CDATA[<p align="center"> å…³äºæŸ¥æ‰¾ç®—æ³•ã€‚ </p><a id="more"></a><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>æœ¬æ–‡â€å®Œå…¨äºŒå‰æ ‘â€çš„å®šä¹‰é‡‡ç”¨å›½å†…å®šä¹‰<br>B-æ ‘ å³ Bæ ‘,ä¸¤è€…æ˜¯ç›¸åŒæ¦‚å¿µ,è€ŒéæŒ‡äºŒå‰æœç´¢æ ‘(ç™¾åº¦ç™¾ç§‘)</p></blockquote><h2 id="äº‰è®®"><a href="#äº‰è®®" class="headerlink" title="äº‰è®®"></a>äº‰è®®</h2><p>1.å›½å†…æ—©æœŸæ•™æä¸­ï¼Œæ»¡äºŒå‰æ ‘ä¸€èˆ¬æŒ‡ perfect binary treeï¼Œæ‰€ä»¥ä¼šæœ‰æ»¡äºŒå‰æ ‘æ˜¯å®Œå…¨äºŒå‰æ ‘çš„ä¸€ä¸ªç‰¹ä¾‹çš„è¯´æ³•.</p><p>2.æ ‘çš„æ·±åº¦çš„å®šä¹‰ï¼Œæœ‰çš„æ ¹ç»“ç‚¹ä»0å¼€å§‹è®¡æ•°ï¼Œæœ‰çš„ä»1å¼€å§‹è®¡æ•°.</p><p>3.ç»“ç‚¹ ä¸ èŠ‚ç‚¹ æ˜¯å¯¹Nodeçš„ç¿»è¯‘,å¯ä»¥çœ‹åšç­‰åŒ.</p><h2 id="ç»´åŸºç™¾ç§‘å®šä¹‰"><a href="#ç»´åŸºç™¾ç§‘å®šä¹‰" class="headerlink" title="ç»´åŸºç™¾ç§‘å®šä¹‰"></a>ç»´åŸºç™¾ç§‘å®šä¹‰</h2><p>1.æ ¹äºŒå‰æ ‘(Rooted Binary Tree)ï¼š<br>æœ‰ä¸€ä¸ªæ ¹ç»“ç‚¹ï¼Œæ¯ä¸ªç»“ç‚¹è‡³å¤šæœ‰ä¸¤ä¸ªå­©å­ã€‚</p><p>2.æ»¡äºŒå‰æ ‘(Full Binary Tree)ï¼š<br>è¦ä¹ˆæ˜¯å¶å­ç»“ç‚¹(ç»“ç‚¹çš„åº¦ä¸º0)ï¼Œè¦ä¹ˆç»“ç‚¹åŒæ—¶å…·æœ‰å·¦å³å­æ ‘(ç»“ç‚¹çš„åº¦ä¸º2)ã€‚</p><p>3.å®Œå…¨äºŒå‰æ ‘(Complete Binary Tree)ï¼š<br>æ¯å±‚ç»“ç‚¹éƒ½å®Œå…¨å¡«æ»¡ï¼Œåœ¨æœ€åä¸€å±‚ä¸Šå¦‚æœä¸æ˜¯æ»¡çš„ï¼Œåˆ™åªç¼ºå°‘å³è¾¹çš„è‹¥å¹²ç»“ç‚¹ã€‚</p><p>4.å®Œç¾äºŒå‰æ ‘(Perfect Binary Tree)<br>æ‰€æœ‰çš„éå¶å­ç»“ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­©å­ï¼Œæ‰€æœ‰çš„å¶å­ç»“ç‚¹éƒ½åœ¨åŒä¸€å±‚ã€‚å³æ¯å±‚ç»“ç‚¹éƒ½å®Œå…¨å¡«æ»¡ã€‚</p><p>5.æ— é™å®Œå…¨äºŒå‰æ ‘(Infinite Complete Binary Tree)ï¼š    æ¯ä¸ªç»“ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­©å­ï¼Œç»“ç‚¹çš„å±‚æ•°æ˜¯æ— é™çš„ã€‚</p><p>6.å¹³è¡¡äºŒå‰æ ‘(Balanced Binary Tree)ï¼š<br>ä¹Ÿç§°ä¸ºAVLæ ‘ï¼Œå®ƒæ˜¯ä¸€æ£µç©ºæ ‘æˆ–å®ƒçš„å·¦å³ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼Œå¹¶ä¸”å·¦å³ä¸¤ä¸ªå­æ ‘éƒ½æ˜¯ä¸€æ£µå¹³è¡¡äºŒå‰æ ‘ã€‚</p><p><strong>æ»¡äºŒå‰æ ‘(Full Binary Tree)</strong><br>å¦‚æœä¸€æ£µäºŒå‰æ ‘çš„ç»“ç‚¹è¦ä¹ˆæ˜¯å¶å­è¦ä¹ˆæœ‰ä¸¤ä¸ªå­©å­ç»“ç‚¹,åˆ™ä¸ºæ»¡äºŒå‰æ ‘</p><p>æ€§è´¨:<br>1.æ€»ç»“ç‚¹ä¸ªæ•°å‘ˆç°ä¸ªæ•°ä¸º:0 1 3 7 15â€¦æ»¡è¶³2^(n) -1,å…¶ä¸­nä¸ºæ ‘çš„æ·±åº¦(æœ€å¤§å±‚)</p><p>2.ç¬¬kå±‚(kä¸ä¸º0)ç»“ç‚¹ä¸ªæ•°:1 2 4 8â€¦æ»¡è¶³2^(k - 1)</p><p>3.æ»¡äºŒå‰æ ‘æ˜¯å®Œå…¨äºŒå‰æ ‘</p><p><strong>å®Œå…¨äºŒå‰æ ‘(Complete Binary Tree)</strong><br>è‹¥è®¾äºŒå‰æ ‘çš„æ·±åº¦ä¸ºhï¼Œé™¤ç¬¬ h å±‚å¤–ï¼Œå…¶å®ƒå„å±‚ (1ï½h-1) çš„ç»“ç‚¹æ•°éƒ½è¾¾åˆ°æœ€å¤§ä¸ªæ•°ï¼Œç¬¬ h å±‚æ‰€æœ‰çš„ç»“ç‚¹éƒ½è¿ç»­é›†ä¸­åœ¨æœ€å·¦è¾¹ï¼Œè¿™å°±æ˜¯å®Œå…¨äºŒå‰æ ‘ã€‚</p><p>æ€§è´¨:å®Œå…¨äºŒå‰æ ‘ä¸­åº¦ä¸º1çš„ç»“ç‚¹æ•°åªæœ‰ä¸¤ç§å¯èƒ½0æˆ–1,é‚£ä¹ˆ:<br>æ€»ç»“ç‚¹æ•°ä¸ºn,æœ‰  <strong>n0=n/2</strong> æˆ– <strong>n0=(n+1)/2</strong></p><h2 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h2><p>é¡ºåºå­˜å‚¨çš„æ’åºæ•°ç»„<br><img src="http://static.chenyalun.com/2017/04/21/170421004.jpg" alt><br>æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™æ—¶é—´å¤æ‚åº¦è¾¾åˆ°O(n),é¡ºåºå­˜å‚¨ç»“æ„ä¸é€‚äºåŠ¨æ€çš„æƒ…å†µ</p><p>é“¾å¼å­˜å‚¨<br><img src="http://static.chenyalun.com/2017/04/21/170421005.jpg" alt><br>é“¾è¡¨çš„æŸ¥æ‰¾éœ€è¦O(n)</p><h1 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h1><p>æŸ¥æ‰¾è¡¨:ç”±åŒä¸€ç±»å‹çš„æ•°æ®å…ƒç´ æ„æˆçš„é›†åˆ.<br>å…³é”®å­—:æ•°æ®å…ƒç´ ä¸­æŸä¸ªæ•°æ®é¡¹çš„å€¼.<br>ä¸»å…³é”®å­—:å¯ä»¥å”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè®°å½•.<br>æ¬¡å…³é”®å­—:å¯ä»¥è¯†åˆ«å¤šä¸ªæ•°æ®å…ƒç´ .<br>æŸ¥æ‰¾:æ ¹æ®ç»™å®šçš„æŸä¸ªå€¼,åœ¨æŸ¥æ‰¾è¡¨ä¸­ç¡®å®šä¸€ä¸ªå…¶å…³é”®å­—ç­‰äºç»™å®šå€¼çš„æ•°æ®å…ƒç´ (æˆ–è®°å½•).<br>é™æ€æŸ¥æ‰¾è¡¨:åªä½œæŸ¥æ‰¾æ“ä½œçš„æŸ¥æ‰¾è¡¨.<br>åŠ¨æ€æŸ¥æ‰¾è¡¨:åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­åŒæ—¶æ’å…¥æŸ¥æ‰¾è¡¨ä¸­ä¸å­˜åœ¨çš„æ•°æ®å…ƒç´ ,æˆ–è€…ä»æŸ¥æ‰¾è¡¨ä¸­åˆ é™¤å·²ç»å­˜åœ¨çš„æŸä¸ªæ•°æ®å…ƒç´ .</p><h2 id="é¡ºåºè¡¨æŸ¥æ‰¾"><a href="#é¡ºåºè¡¨æŸ¥æ‰¾" class="headerlink" title="é¡ºåºè¡¨æŸ¥æ‰¾"></a>é¡ºåºè¡¨æŸ¥æ‰¾</h2><p>é¡ºåºæŸ¥æ‰¾(çº¿æ€§æŸ¥æ‰¾):ä»è¡¨ä¸­ç¬¬ä¸€ä¸ªè®°å½•å¼€å§‹,é€ä¸ªè¿›è¡Œè®°å½•çš„å…³é”®å­—å’Œç»™å®šå€¼çš„æ¯”è¾ƒ.</p><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é¡ºåºæŸ¥æ‰¾çš„å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sequentialSearch</span><span class="params">(key, numbers)</span></span><span class="symbol">:</span></span><br><span class="line">    length = len(numbers)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(length)<span class="symbol">:</span></span><br><span class="line">        <span class="comment"># æŸ¥æ‰¾æˆåŠŸè¿”å›ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">if</span> key == numbers[i]<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="comment"># æŸ¥æ‰¾å¤±è´¥è¿”å›-1</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure><p>æœ€å¥½æƒ…å†µ:åœ¨ç¬¬ä¸€ä¸ªä½ç½®æ‰¾åˆ°,æ—¶é—´å¤æ‚åº¦ä¸ºO(1)<br>æœ€åæƒ…å†µ:åœ¨æœ€åä¸€ä¸ªä½ç½®æ‰¾åˆ°,æ—¶é—´å¤æ‚åº¦O(n)<br>æŸ¥æ‰¾ä¸æˆåŠŸ:æ—¶é—´å¤æ‚åº¦O(n)<br>å¹³å‡æŸ¥æ‰¾æ¬¡æ•°:(n+1)/2<br>å¹³å‡æ—¶é—´å¤æ‚åº¦:O(n)</p><h2 id="æœ‰åºè¡¨æŸ¥æ‰¾"><a href="#æœ‰åºè¡¨æŸ¥æ‰¾" class="headerlink" title="æœ‰åºè¡¨æŸ¥æ‰¾"></a>æœ‰åºè¡¨æŸ¥æ‰¾</h2><h3 id="1-äºŒåˆ†æŸ¥æ‰¾"><a href="#1-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="1.äºŒåˆ†æŸ¥æ‰¾"></a>1.äºŒåˆ†æŸ¥æ‰¾</h3><p> æŠ˜åŠæŸ¥æ‰¾(äºŒåˆ†æŸ¥æ‰¾):åœ¨çº¿æ€§è¡¨ä¸­çš„è®°å½•æœ‰åºçš„å‰æä¸‹è¿›è¡ŒæŸ¥æ‰¾.å–ä¸­é—´å…ƒç´ ä½œä¸ºæ¯”è¾ƒå¯¹è±¡,è‹¥ç»™å®šå€¼ä¸ä¸­é—´å…ƒç´ ç›¸ç­‰,åˆ™æŸ¥æ‰¾æˆåŠŸ,è‹¥ç»™å®šå€¼å°äºä¸­é—´å…ƒç´ ,åˆ™åœ¨ä¸­é—´å…ƒç´ çš„å·¦åŠåŒºç»§ç»­æŸ¥æ‰¾,è‹¥ç»™å®šå€¼å¤§äºä¸­é—´å…ƒç´ ,åˆ™åœ¨ä¸­é—´å…ƒç´ çš„å³åŠåŒºç»§ç»­æŸ¥æ‰¾,ä¸æ–­é‡å¤æŸ¥æ‰¾è¿‡ç¨‹,ç›´åˆ°æŸ¥æ‰¾æˆåŠŸ,æˆ–æŸ¥æ‰¾å¤±è´¥.</p><figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line"><span class="meta"># äºŒåˆ†æŸ¥æ‰¾çš„å®ç°</span></span><br><span class="line">def binarySearch(<span class="keyword">key</span>, numbers):</span><br><span class="line">    <span class="meta"># å·¦è¾¹ç•Œ</span></span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    <span class="meta"># å³è¾¹ç•Œ</span></span><br><span class="line">    high = len(numbers) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        <span class="meta"># ä¸­é—´å…ƒç´ ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">mid</span> = (low + high) / <span class="number">2</span></span><br><span class="line">        <span class="meta"># æŸ¥æ‰¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] == <span class="keyword">key</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">mid</span></span><br><span class="line">        <span class="meta"># åœ¨å·¦åŒºé—´</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] &gt; <span class="keyword">key</span>:</span><br><span class="line">            high = <span class="keyword">mid</span> - <span class="number">1</span></span><br><span class="line">        <span class="meta"># åœ¨å³åŒºé—´</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] &lt; <span class="keyword">key</span>:</span><br><span class="line">            low = <span class="keyword">mid</span> + <span class="number">1</span></span><br><span class="line">    <span class="meta"># æŸ¥æ‰¾å¤±è´¥è¿”å›-1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><p>æœ€å¥½æƒ…å†µ:æ˜¯ä¸­é—´å…ƒç´ ,ä¸€æ¬¡å³å¯æ‰¾åˆ°,æ—¶é—´å¤æ‚åº¦O(1)<br>æœ€åæƒ…å†µ:å®Œå…¨äºŒå‰æ ‘çš„æ·±åº¦åŠ 1,å³floor(logn) + 1æ¬¡,æ—¶é—´å¤æ‚åº¦O(logn).(æ³¨æ„:lognè¿™é‡ŒæŒ‡ä»¥2ä¸ºåº•,floorè¡¨ç¤ºå‘ä¸‹å–æ•´)</p><h3 id="2-æ’å€¼æŸ¥æ‰¾"><a href="#2-æ’å€¼æŸ¥æ‰¾" class="headerlink" title="2.æ’å€¼æŸ¥æ‰¾"></a>2.æ’å€¼æŸ¥æ‰¾</h3><p>äºŒåˆ†æŸ¥æ‰¾çš„ä¼˜åŒ–ç‰ˆ,æ ¸å¿ƒæ˜¯æ’å€¼å…¬å¼:<br>(key - numbers[low]) / (numbers[high] - numbers[low])</p><p>æ ¸å¿ƒä»£ç :</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ’å€¼</span></span><br><span class="line">mid = low + <span class="comment">(high - low)</span> * <span class="comment">(key - numbers[low])</span> / <span class="comment">(numbers[high] - numbers[low])</span></span><br></pre></td></tr></table></figure><figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line"><span class="meta"># æ’å€¼æŸ¥æ‰¾çš„å®ç°</span></span><br><span class="line">def interpolationSearch(<span class="keyword">key</span>, numbers):</span><br><span class="line">    <span class="meta"># å·¦è¾¹ç•Œ</span></span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    <span class="meta"># å³è¾¹ç•Œ</span></span><br><span class="line">    high = len(numbers) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        <span class="meta"># æ ¸å¿ƒä»£ç </span></span><br><span class="line">        <span class="keyword">mid</span> = low + (high - low) * (<span class="keyword">key</span> - numbers[low]) / (numbers[high] - numbers[low])</span><br><span class="line">        <span class="meta"># æŸ¥æ‰¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] == <span class="keyword">key</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">mid</span></span><br><span class="line">        <span class="meta"># åœ¨å·¦åŒºé—´</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] &gt; <span class="keyword">key</span>:</span><br><span class="line">            high = <span class="keyword">mid</span> - <span class="number">1</span></span><br><span class="line">        <span class="meta"># åœ¨å³åŒºé—´</span></span><br><span class="line">        <span class="keyword">if</span> numbers[<span class="keyword">mid</span>] &lt; <span class="keyword">key</span>:</span><br><span class="line">            low = <span class="keyword">mid</span> + <span class="number">1</span></span><br><span class="line">    <span class="meta"># æŸ¥æ‰¾å¤±è´¥è¿”å›-1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><p>ä»æ—¶é—´å¤æ‚åº¦ä¸Š,ä¾ç„¶æ˜¯O(logn),ä½†æ˜¯å¯¹äºè¡¨é•¿è¾ƒå¤§,å…³é”®å­—åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€çš„æŸ¥æ‰¾è¡¨,æ€§èƒ½ç›¸å¯¹äºŒåˆ†æŸ¥æ‰¾æ›´å¥½.<br>ä½†æ˜¯,åˆ†å¸ƒæä¸å‡åŒ€çš„æ•°æ®,ä¸æ˜¯å¾ˆåˆé€‚,æ¯”å¦‚[1,2,4,3000,3003â€¦9988899,8988998]</p><p>æ’å€¼æŸ¥æ‰¾åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸¤ä¸ªå‡è®¾æ¡ä»¶ï¼š</p><p>(1)æ¯ä¸€æ¬¡å¯¹æ•°æ®çš„è®¿é—®ä¸é€šå¸¸çš„æŒ‡ä»¤ç›¸æ¯”ï¼Œè´¹ç”¨éƒ½æ˜¯ç›¸å½“æ˜‚è´µçš„ã€‚ä¾‹å¦‚ï¼Œå¾…æŸ¥æ‰¾çš„è¡¨ä¸€å®šæ˜¯åœ¨ç£ç›˜è€Œéå†…å­˜ä¸­ï¼Œå› è€Œæ¯ä¸€æ¬¡æ¯”è¾ƒéƒ½è¦è¿›è¡Œç£ç›˜è®¿é—®ã€‚</p><p>(2)æ•°æ®ä¸ä»…æ˜¯å·²è¢«æ’å¥½åºçš„ï¼Œè€Œä¸”å‘ˆç°å‡åŒ€åˆ†å¸ƒç‰¹å¾ã€‚</p><h3 id="3-æ–æ³¢é‚£å¥‘æŸ¥æ‰¾"><a href="#3-æ–æ³¢é‚£å¥‘æŸ¥æ‰¾" class="headerlink" title="3.æ–æ³¢é‚£å¥‘æŸ¥æ‰¾"></a>3.æ–æ³¢é‚£å¥‘æŸ¥æ‰¾</h3><p>åˆ©ç”¨é»„é‡‘åˆ†å‰²åŸç†å®ç°,æŠ˜åŠæŸ¥æ‰¾ç®—æ³•æ¥è¿›è¡Œä¿®æ”¹å’Œæ”¹è¿›.<br>å¯¹äºæ–æ³¢é‚£å¥‘æ•°åˆ—,å‰åä¸¤ä¸ªæ•°å­—çš„æ¯”å€¼éšç€æ•°åˆ—çš„å¢åŠ ,è¶Šæ¥è¶Šæ¥è¿‘é»„é‡‘æ¯”å€¼:0.618</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">0<span class="selector-class">.0</span></span><br><span class="line">1<span class="selector-class">.0</span></span><br><span class="line">0<span class="selector-class">.5</span></span><br><span class="line">0<span class="selector-class">.666666666667</span></span><br><span class="line">0<span class="selector-class">.6</span></span><br><span class="line">0<span class="selector-class">.625</span></span><br><span class="line">0<span class="selector-class">.615384615385</span></span><br><span class="line">0<span class="selector-class">.619047619048</span></span><br><span class="line">0<span class="selector-class">.617647058824</span></span><br><span class="line">0<span class="selector-class">.618181818182</span></span><br><span class="line">0<span class="selector-class">.61797752809</span></span><br><span class="line">0<span class="selector-class">.618055555556</span></span><br><span class="line">0<span class="selector-class">.618025751073</span></span><br><span class="line">0<span class="selector-class">.618037135279</span></span><br><span class="line">0<span class="selector-class">.618032786885</span></span><br><span class="line">0<span class="selector-class">.618034447822</span></span><br><span class="line">0<span class="selector-class">.6180338134</span></span><br><span class="line">0<span class="selector-class">.618034055728</span></span><br><span class="line">0<span class="selector-class">.618033963167</span></span><br><span class="line">0<span class="selector-class">.618033998522</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¯¹äºæ–æ³¢é‚£å¥‘æ•°åˆ—:<br>0 1 1 2 3 5 8 13 21 34 55 89 â€¦</p><p><strong>åŸç†:</strong><br>æ¯”å¦‚è¿™é‡Œçš„89ï¼Œå‡å®šå®ƒæ˜¯æ•´ä¸ªæœ‰åºè¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œè€Œ89æ˜¯ç”±å‰é¢çš„ä¸¤ä¸ªæ•°34å’Œ55ç›¸åŠ ä¹‹åçš„å’Œï¼Œä¹Ÿå³æŠŠå…ƒç´ ä¸ªæ•°ä¸º89çš„æœ‰åºè¡¨åˆ†æˆç”±å‰55ä¸ªæ•°æ®å…ƒç´ ç»„æˆçš„å‰åŠæ®µå’Œç”±å34ä¸ªæ•°æ®å…ƒç´ ç»„æˆçš„ååŠæ®µï¼Œé‚£ä¹ˆå‰åŠæ®µå…ƒç´ ä¸ªæ•°å’Œæ•´ä¸ªæœ‰åºè¡¨é•¿åº¦çš„æ¯”å€¼å°±æ¥è¿‘é»„é‡‘æ¯”å€¼0.618ï¼Œå‡å¦‚è¦æŸ¥æ‰¾çš„å…ƒç´ åœ¨å‰åŠæ®µï¼Œé‚£ä¹ˆç»§ç»­æŒ‰ç…§æ–æ³¢é‚£å¥‘æ•°åˆ—æ¥çœ‹ï¼Œ55 = 34 + 21ï¼Œæ‰€ä»¥ç»§ç»­æŠŠå‰åŠæ®µåˆ†æˆå‰34ä¸ªæ•°æ®å…ƒç´ çš„å‰åŠæ®µå’Œå21ä¸ªå…ƒç´ çš„ååŠæ®µï¼Œç»§ç»­æŸ¥æ‰¾ï¼Œå¦‚æ­¤åå¤ï¼Œç›´åˆ°æŸ¥æ‰¾æˆåŠŸæˆ–å¤±è´¥.</p><p>å½“æœ‰åºè¡¨çš„å…ƒç´ ä¸ªæ•°ä¸æ˜¯æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„æŸä¸ªæ•°å­—æ—¶ï¼Œéœ€è¦æŠŠæœ‰åºè¡¨çš„å…ƒç´ ä¸ªæ•°é•¿åº¦è¡¥é½ï¼Œè®©å®ƒæˆä¸ºæ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„ä¸€ä¸ªæ•°å€¼,ä¹Ÿå³<strong>æŠŠéœ€è¦è¡¥é½çš„çš„å…ƒç´ éƒ½èµ‹å€¼ä¸ºæœ‰åºè¡¨çš„æœ€å¤§å€¼</strong>ã€‚</p><p><strong>æ ¸å¿ƒ:</strong><br>(1)å½“key == numbers[mid],æŸ¥æ‰¾æˆåŠŸ<br>(2)å½“key &lt; numbers[mid],æ–°èŒƒå›´æ˜¯ç¬¬lowä¸ªåˆ°ç¬¬mid-1ä¸ª,èŒƒå›´ä¸ªæ•°æ˜¯F(k-1) - 1ä¸ª,å³æœ‰åºåˆ—è¡¨å·¦è¾¹çš„é•¿åº¦<br>(3)å½“key &gt; numbers[mid]æ—¶,æ–°èŒƒå›´æ˜¯ç¬¬mid+1åˆ°ç¬¬highä¸ª,èŒƒå›´ä¸ªæ•°æ˜¯F(k-2) - 1ä¸ª,å³æœ‰åºåˆ—è¡¨å³è¾¹çš„é•¿åº¦</p><p>k è¡¨ç¤ºåˆ—è¡¨çš„é•¿åº¦<br>k-1è¡¨ç¤ºç´¢å¼•<br>F(k-1)è¡¨ç¤ºåˆ—è¡¨æœ€åä¸€ä¸ªå…ƒç´ </p><p>å…ƒç´ æ€»ä¸ªæ•° = å·¦åŒºé—´ä¸ªæ•° + å³åŒºé—´ä¸ªæ•° + ä¸­é—´çš„ä¸€ä¸ªå…ƒç´ ,å³:</p><pre><code>F(k)-1 = F(k-1)-1  +   F(k-2)-1    +     1</code></pre><p>æ–æ³¢é‚£å¥‘æŸ¥æ‰¾ç®—æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–æ³¢é‚£å¥‘æŸ¥æ‰¾</span></span><br><span class="line">def Fbonacci(index):</span><br><span class="line">    <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="literal">return</span> </span><br><span class="line">    <span class="keyword">a</span>, b = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(index):</span><br><span class="line">        <span class="keyword">a</span>, b = b, <span class="keyword">a</span> + b</span><br><span class="line">    <span class="literal">return</span> <span class="keyword">a</span></span><br><span class="line">    </span><br><span class="line">def FbonacciSearch(key, numbers):</span><br><span class="line">    <span class="comment"># ç¡®å®šè¯¥åºåˆ—åœ¨æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„ä½ç½®</span></span><br><span class="line">    n, <span class="built_in">length</span> = <span class="number">0</span>, <span class="built_in">len</span>(numbers)</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">length</span> &gt; Fbonacci(n) - <span class="number">1</span>:</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">    <span class="comment"># å¡«æ»¡å…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(n,Fbonacci(n)):</span><br><span class="line">        numbers.append(numbers[<span class="number">-1</span>])</span><br><span class="line">    </span><br><span class="line">    low, high = <span class="number">0</span>, n - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        <span class="comment"># è·å–é»„é‡‘åˆ†å‰²ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">mid</span> = low + Fbonacci(n - <span class="number">1</span>) - <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å·¦åŒºé—´</span></span><br><span class="line">        <span class="comment">#è‹¥keyæ¯”è¿™ä¸ªå…ƒç´ å°,åˆ™keyå€¼åº”è¯¥åœ¨lowè‡³mid-1ä¹‹é—´ï¼Œå‰©ä¸‹çš„èŒƒå›´ä¸ªæ•°ä¸ºF(k-1)-1</span></span><br><span class="line">        <span class="keyword">if</span> key &lt; numbers[<span class="keyword">mid</span>]:</span><br><span class="line">            high = <span class="keyword">mid</span> - <span class="number">1</span></span><br><span class="line">            n -= <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># å³åŒºé—´</span></span><br><span class="line">        <span class="comment">#è‹¥keyæ¯”è¿™ä¸ªå…ƒç´ å°,åˆ™keyå€¼åº”è¯¥åœ¨lowè‡³mid-1ä¹‹é—´ï¼Œå‰©ä¸‹çš„èŒƒå›´ä¸ªæ•°ä¸ºF(k-1)-1</span></span><br><span class="line">        <span class="keyword">if</span> key &gt; numbers[<span class="keyword">mid</span>]:</span><br><span class="line">            low = <span class="keyword">mid</span> + <span class="number">1</span></span><br><span class="line">            n -= <span class="number">2</span></span><br><span class="line">        <span class="comment"># ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># æˆåŠŸæ‰¾åˆ°</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">mid</span> &lt;= n:</span><br><span class="line">                <span class="literal">return</span> <span class="keyword">mid</span></span><br><span class="line">            <span class="comment"># è¡¥å…¨çš„æ•°,è¿”å›n</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="literal">return</span> n</span><br><span class="line">    <span class="literal">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><h3 id="4-æ¯”è¾ƒ"><a href="#4-æ¯”è¾ƒ" class="headerlink" title="4.æ¯”è¾ƒ"></a>4.æ¯”è¾ƒ</h3><p>äºŒåˆ†æŸ¥æ‰¾æ˜¯åŠ æ³•ä¸é™¤æ³•è¿ç®—<br>æ’å€¼æŸ¥æ‰¾æ˜¯å¤æ‚çš„å››åˆ™è¿ç®—<br>æ–æ³¢é‚£å¥‘æŸ¥æ‰¾æ˜¯åŠ å‡æ³•è¿ç®—</p><h2 id="çº¿æ€§ç´¢å¼•æŸ¥æ‰¾"><a href="#çº¿æ€§ç´¢å¼•æŸ¥æ‰¾" class="headerlink" title="çº¿æ€§ç´¢å¼•æŸ¥æ‰¾"></a>çº¿æ€§ç´¢å¼•æŸ¥æ‰¾</h2><p>ç´¢å¼•:æŠŠä¸€ä¸ªå…³é”®å­—ä¸å®ƒå¯¹åº”çš„è®°å½•ç›¸å…³è”çš„è¿‡ç¨‹.<br>çº¿æ€§ç´¢å¼•:æŠŠç´¢å¼•é¡¹é›†åˆç»„ç»‡ä¸ºçº¿æ€§ç»“æ„,ä¹Ÿå³ç´¢å¼•è¡¨</p><h3 id="1-ç¨ å¯†ç´¢å¼•"><a href="#1-ç¨ å¯†ç´¢å¼•" class="headerlink" title="1.ç¨ å¯†ç´¢å¼•"></a>1.ç¨ å¯†ç´¢å¼•</h3><p>ç¨ å¯†ç´¢å¼•:å°†æ•°æ®é›†çš„æ¯ä¸ªè®°å½•å¯¹åº”ä¸€ä¸ªç´¢å¼•é¡¹,ä¸”ç´¢å¼•é¡¹ä¸€å®šæŒ‰ç…§å…³é”®ç æœ‰åºæ’åˆ—.</p><h3 id="2-åˆ†å—ç´¢å¼•"><a href="#2-åˆ†å—ç´¢å¼•" class="headerlink" title="2.åˆ†å—ç´¢å¼•"></a>2.åˆ†å—ç´¢å¼•</h3><p>å¯¹æ•°æ®é›†è¿›è¡Œåˆ†å—,ä½¿åˆ†å—æœ‰åº,ç„¶åå¯¹æ¯ä¸€å—å»ºç«‹ä¸€ä¸ªç´¢å¼•é¡¹,ä»è€Œå‡å°‘ç´¢å¼•é¡¹çš„ä¸ªæ•°.</p><p>å—éœ€è¦æ»¡è¶³çš„æ¡ä»¶:<br>(1)å—å†…æ— åº:æ¯ä¸€å—çš„è®°å½•ä¸è¦æ±‚æœ‰åº.<br>(2)å—é—´æœ‰åº:æ¯”å¦‚,è¦æ±‚ç¬¬äºŒå—æ‰€æœ‰è®°å½•çš„å…³é”®å­—å‡è¦å¤§äºç¬¬ä¸€å—æ‰€æœ‰è®°å½•çš„å…³é”®å­—.ç¬¬ä¸‰å—å¤§äºç¬¬äºŒå—â€¦</p><p>åˆ†å—ç´¢å¼•çš„ç´¢å¼•é¡¹ç»“æ„:</p><ul><li>æœ€å¤§å…³é”®ç :å­˜å‚¨æ¯ä¸€å—ä¸­ç‚¹æœ€å¤§å…³é”®å­—</li><li>å­˜å‚¨å—ä¸­è®°å½•çš„ä¸ªæ•°,ä¾¿äºå¾ªç¯</li><li>ç”¨äºæŒ‡å‘å—é¦–æ•°æ®å…ƒç´ çš„æŒ‡é’ˆ,ä¾¿äºéå†</li></ul><p>æŸ¥æ‰¾åˆ†ä¸¤æ­¥:<br>(1)åœ¨åˆ†å—ç´¢å¼•è¡¨ä¸­æŸ¥æ‰¾å…³é”®å­—æ‰€åœ¨çš„å—.<br>(2)æ ¹æ®å—é¦–æŒ‡é’ˆæ‰¾åˆ°ç›¸åº”çš„å—,å¹¶åœ¨å—ä¸­é¡ºåºæŸ¥æ‰¾å…³é”®ç .</p><p>è®¾nä¸ªè®°å½•è¢«å¹³å‡åˆ†æˆmå—,æ¯ä¸ªå—tæ¡è®°å½•,åˆ™n=mt<br>æŸ¥æ‰¾ç´¢å¼•è¡¨çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦:(1+m)/2<br>æŸ¥æ‰¾è®°å½•çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦:(t+1)/2</p><p>åˆ™å—ä¸­æŸ¥æ‰¾è®°å½•çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦:</p><pre><code>  (1+m)/2 + (t+1)/2 = (m+t)/2+1 = (n/t+t)/2+1</code></pre><p>æœ€ä½³æƒ…å†µ:mä¸tç›¸ç­‰,ä¹Ÿå³n = t^2 = m^2 ,åˆ™åŸå¼ä¸º:</p><pre><code>= (t*t/t+t)/2+1= t+1= n^0.5 + 1 (^ è¡¨ç¤ºæ¬¡æ–¹)</code></pre><p>ç”±æ­¤åˆ†å—ç´¢å¼•æ¯”é¡ºåºæŸ¥æ‰¾O(n)æé«˜ä¸å°‘.</p><h3 id="3-å€’æ’ç´¢å¼•"><a href="#3-å€’æ’ç´¢å¼•" class="headerlink" title="3.å€’æ’ç´¢å¼•"></a>3.å€’æ’ç´¢å¼•</h3><p>ç´¢å¼•é¡¹çš„ç»“æ„:æ¬¡å…³é”®ç ä¸è®°å½•å·è¡¨<br>æ ¹æ®å±æ€§(æ¬¡å…³é”®ç ,å­—æ®µ)çš„å€¼æŸ¥æ‰¾è®°å½•.<br>è¯¥ç´¢å¼•è¡¨ä¸­çš„æ¯ä¸€é¡¹åŒ…æ‹¬ä¸€ä¸ªå±æ€§å€¼å’Œå…·æœ‰è¯¥å±æ€§å€¼çš„å„è®°å½•çš„åœ°å€.<br>ç”±äºä¸æ˜¯ç”±è®°å½•ç¡®å®šå±æ€§å€¼è€Œæ˜¯ç”±å±æ€§å€¼ç¡®å®šè®°å½•,å› è€Œç§°ä¸ºå€’æ’ç´¢å¼•.</p><p>ä¼˜ç‚¹:ç”Ÿæˆç´¢å¼•è¡¨åä¸ç”¨è¯»å–è®°å½•å°±å¯çŸ¥é“ç»“æœ,æŸ¥æ‰¾éå¸¸å¿«<br>ç¼ºç‚¹:è®°å½•å·ä¸å®šé•¿</p><h2 id="äºŒå‰æœç´¢æ ‘"><a href="#äºŒå‰æœç´¢æ ‘" class="headerlink" title="äºŒå‰æœç´¢æ ‘"></a>äºŒå‰æœç´¢æ ‘</h2><p>å¦‚æœæŸ¥æ‰¾çš„æ•°æ®é›†æ˜¯æœ‰åºçº¿æ€§è¡¨,å¹¶ä¸”æ˜¯é¡ºåºå­˜å‚¨çš„,å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾/æ’å€¼æŸ¥æ‰¾/æ–æ³¢é‚£å¥‘æŸ¥æ‰¾,ä½†æ˜¯åœ¨æ’å…¥åˆ é™¤æ“ä½œä¸Šè€—è´¹å¤§é‡æ—¶é—´,ç”±æ­¤å¼•å‡ºæ—¢å¯ä»¥ä½¿å¾—æ’å…¥åˆ é™¤æ•ˆç‡ä¸é”™åˆå¯ä»¥é«˜æ•ˆç‡æŸ¥æ‰¾çš„ç®—æ³•====&gt;ä½¿ç”¨äºŒå‰æ ‘æ•°æ®ç»“æ„:åœ¨åˆ›å»ºé›†åˆæ—¶å°±è€ƒè™‘ä½¿ç”¨äºŒå‰æ ‘ç»“æœ,è€Œä¸”æ˜¯æ’å¥½åºçš„äºŒå‰æ ‘.æ„é€ äºŒå‰æœç´¢æ ‘çš„ç›®çš„ä¸æ˜¯ä¸ºäº†æ’åº,è€Œæ˜¯ä¸ºäº†æé«˜æ’å…¥/åˆ é™¤çš„æ•ˆç‡.</p><p>äºŒå‰æŸ¥æ‰¾æ ‘,ä¹Ÿç§°(äºŒå‰æœç´¢æ ‘,æœ‰åºäºŒå‰æ ‘,æ’åºäºŒå‰æ ‘,äºŒå‰æ’åºæ ‘ï¼‰,æ˜¯æŒ‡<strong>ä¸€æ£µç©ºæ ‘</strong>æˆ–è€…å…·æœ‰ä¸‹åˆ—æ€§è´¨çš„<strong>äºŒå‰æ ‘</strong>ï¼š</p><ul><li>è‹¥ä»»æ„èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›</li><li>è‹¥ä»»æ„èŠ‚ç‚¹çš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å¤§äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›</li><li>ä»»æ„èŠ‚ç‚¹çš„å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘ï¼›</li><li>æ²¡æœ‰é”®å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ã€‚</li></ul><p>æ€§è´¨:<br>1.å·¦å°äºæ ¹å°äºå³<br>2.å€¼ä¸é‡å¤<br>3.â€ä¸­åºéå†â€œå¯ä»¥è®©ç»“ç‚¹æœ‰åº<br>4.äºŒå‰æœç´¢æ ‘æœ‰ä¸¤ç§ç»“ç‚¹åˆ é™¤æ–¹å¼:å–è¢«åˆ é™¤ç»“ç‚¹çš„å³å­æ ‘ä¸­çš„æœ€å°å…ƒç´ æ›¿ä»£æˆ–è€…å–è¢«åˆ é™¤ç»“ç‚¹çš„å·¦å­æ ‘ä¸­çš„æœ€å¤§å…ƒç´ æ›¿ä»£</p><p>ä¼˜åŠ¿:<br>æŸ¥æ‰¾ã€æ’å…¥çš„æ—¶é—´å¤æ‚åº¦è¾ƒä½ã€‚ä¸ºO(log n)<br>äºŒå‰æŸ¥æ‰¾æ ‘çš„æœ€åæ•ˆç‡æ˜¯O(n),æ­¤æ—¶é€€åŒ–ä¸ºçº¿æ€§ç»“æ„</p><p><img src="http://static.chenyalun.com/2017/04/21/170421006.jpg" alt></p><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeNode</span>():</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>,val = <span class="number">0</span>)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="keyword">self</span>.val = val</span><br><span class="line"><span class="keyword">self</span>.left = None</span><br><span class="line"><span class="keyword">self</span>.right = None</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯»æ‰¾ç»“ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(<span class="keyword">self</span>, data)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.val == <span class="symbol">data:</span></span><br><span class="line"><span class="keyword">return</span> True</span><br><span class="line">elif data &lt; <span class="keyword">self</span>.val <span class="keyword">and</span> <span class="keyword">self</span>.<span class="symbol">left:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.left.find(data)</span><br><span class="line">elif data &gt; <span class="keyword">self</span>.val <span class="keyword">and</span> <span class="keyword">self</span>.<span class="symbol">right:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.right.find(data)</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯»æ‰¾æœ€å°ç»“ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findMinData</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">left:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.left.findMinData()</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.val</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯»æ‰¾æœ€å¤§ç»“ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findMaxData</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">right:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.right.findMaxData()</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.val</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’å…¥ç»“ç‚¹</span></span><br><span class="line"><span class="comment"># å½“dataä¸äºŒå‰æœç´¢æ ‘ä¸­æŸç»“ç‚¹valç›¸ç­‰æ—¶ä¸ä½œå¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertNode</span><span class="params">(<span class="keyword">self</span>, data)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="comment"># åœ¨å³å­æ ‘ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.val &lt; <span class="symbol">data:</span></span><br><span class="line"><span class="keyword">if</span>  <span class="keyword">self</span>.<span class="symbol">right:</span></span><br><span class="line"><span class="keyword">self</span>.right.insertNode(data)</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">self</span>.right = BinarySearchTreeNode(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å·¦å­æ ‘ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.val &gt; <span class="symbol">data:</span></span><br><span class="line"><span class="keyword">if</span>  <span class="keyword">self</span>.<span class="symbol">left:</span></span><br><span class="line"><span class="keyword">self</span>.left.insertNode(data)</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">self</span>.left = BinarySearchTreeNode(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°äºŒå‰æœç´¢æ ‘</span></span><br><span class="line"><span class="comment"># å·¦æ ¹å³éå†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printTree</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">left:</span></span><br><span class="line"><span class="keyword">self</span>.left.printTree()</span><br><span class="line">print <span class="keyword">self</span>.val,</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">right:</span></span><br><span class="line"><span class="keyword">self</span>.right.printTree()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“ç‚¹çš„åˆ é™¤</span></span><br><span class="line"><span class="comment"># å½“åˆ é™¤ä¸€ä¸ªå¶å­ç»“ç‚¹æ—¶,ç›´æ¥åˆ é™¤å³å¯</span></span><br><span class="line"><span class="comment"># å½“åˆ é™¤çš„ç»“ç‚¹åªæœ‰ä¸€ä¸ªå­©å­æ—¶,ç”¨è¯¥å­©å­æ›¿æ¢</span></span><br><span class="line"><span class="comment"># å½“åˆ é™¤çš„ç»“ç‚¹æœ‰ä¸¤ä¸ªå­©å­æ—¶,å¯»æ‰¾è¯¥ç»“ç‚¹å³å­æ ‘ä¸­çš„æœ€å°æ•°æ®ä»£æ›¿å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">daleteNode</span><span class="params">(<span class="keyword">self</span>, data)</span></span><span class="symbol">:</span></span><br><span class="line"><span class="comment"># å‰ææ˜¯è¯¥ç»“ç‚¹åœ¨äºŒå‰æœç´¢æ ‘ä¸­èƒ½æ‰¾åˆ°</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">self</span>.find(data)<span class="symbol">:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line"><span class="keyword">if</span> data &lt; <span class="keyword">self</span>.<span class="symbol">val:</span></span><br><span class="line"><span class="keyword">self</span>.left = <span class="keyword">self</span>.left.daleteNode(data)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">elif data &gt; <span class="keyword">self</span>.<span class="symbol">val:</span></span><br><span class="line"><span class="keyword">self</span>.right = <span class="keyword">self</span>.right.daleteNode(data)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">elif <span class="keyword">self</span>.left <span class="keyword">and</span> <span class="keyword">self</span>.<span class="symbol">right:</span></span><br><span class="line"><span class="comment"># æ‰¾åˆ°å³å­æ ‘æœ€å°çš„ç»“ç‚¹,è·å–å€¼</span></span><br><span class="line">val = <span class="keyword">self</span>.right.findMinData()</span><br><span class="line"><span class="comment"># æŠŠæœ€å°ç»“ç‚¹çš„å€¼ç»™è‡ªå·±</span></span><br><span class="line"><span class="keyword">self</span>.val = val</span><br><span class="line"><span class="comment"># åˆ é™¤å³å­æ ‘ä¸­çš„æœ€å°ç»“ç‚¹,ä½¿self.rightæŒ‡å‘å³å­æ ‘çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># self.right.daleteNode(val)æœ€ç»ˆè¿”å›å³å­æ ‘çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">self</span>.right = <span class="keyword">self</span>.right.daleteNode(val)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="comment"># å·¦ç»“ç‚¹å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">left:</span></span><br><span class="line"><span class="comment"># ç›´æ¥æŒ‡å‘å·¦ç»“ç‚¹</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.left</span><br><span class="line"><span class="comment"># å³ç»“ç‚¹å­˜åœ¨,æˆ–ä¸å­˜åœ¨ç»“ç‚¹</span></span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="comment"># ç›´æ¥æŒ‡å‘å³ç»“ç‚¹</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>.right</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = BinarySearchTreeNode(<span class="number">10</span>)</span><br><span class="line">a.insertNode(<span class="number">8</span>)</span><br><span class="line">a.insertNode(<span class="number">12</span>)</span><br><span class="line">a.insertNode(<span class="number">6</span>)</span><br><span class="line">a.insertNode(<span class="number">9</span>)</span><br><span class="line">a.insertNode(<span class="number">11</span>)</span><br><span class="line">a.insertNode(<span class="number">14</span>)</span><br><span class="line">a.insertNode(<span class="number">7</span>)</span><br><span class="line">a.insertNode(<span class="number">13</span>)</span><br><span class="line">a.insertNode(<span class="number">5</span>)</span><br><span class="line">a.insertNode(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">a.printTree()</span><br><span class="line">print <span class="string">"\n"</span></span><br><span class="line">print a.find(<span class="number">11</span>)</span><br><span class="line">print a.find(<span class="number">100000</span>)</span><br><span class="line">print a.findMaxData()</span><br><span class="line">print a.findMinData()</span><br><span class="line"></span><br><span class="line">a.daleteNode(<span class="number">1000000</span>)</span><br><span class="line">a.daleteNode(<span class="number">10</span>)</span><br><span class="line">a.daleteNode(<span class="number">14</span>)</span><br><span class="line">a.daleteNode(<span class="number">2</span>)</span><br><span class="line">a.printTree()</span><br></pre></td></tr></table></figure><p>äºŒå‰æœç´¢æ ‘ä»¥é“¾æ¥çš„æ–¹å¼å­˜å‚¨,ä¿æŒäº†é“¾æ¥å­˜å‚¨ç»“æ„åœ¨æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ—¶çš„ä¼˜è¶Šæ€§.</p><p><img src="http://static.chenyalun.com/2017/04/21/170421002.png" alt></p><p>å¯¹äºäºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾,æ¯”è¾ƒæ¬¡æ•°ç­‰äºç»™å®šå€¼çš„ç»“ç‚¹åœ¨äºŒå‰æœç´¢æ ‘çš„å±‚æ•°.æœ€å°‘ä¸º1æ¬¡(ä¸ºæ ¹èŠ‚ç‚¹),æœ€å¤šä¸è¶…è¿‡æ ‘çš„æ·±åº¦(æœ€å·®æ˜¯æç«¯çš„å³æ–œæ ‘æˆ–å·¦æ–œæ ‘).</p><p><img src="http://static.chenyalun.com/2017/04/21/170421001.png" alt></p><p>äºŒå‰æ’åºæ ‘å€˜è‹¥æ˜¯å¹³è¡¡çš„,å…¶æ·±åº¦ä¸å®Œå…¨äºŒå‰æ ‘ç›¸åŒ,å‡ä¸º<code>floor(logn) + 1</code>,æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logn),è¿‘ä¼¼ä¸æŠ˜åŠæŸ¥æ‰¾,è‹¥ä¸æ˜¯å¹³è¡¡çš„,ç”šè‡³æ¼”åŒ–ä¸ºæç«¯çš„å³æ–œæ ‘æˆ–å·¦æ–œæ ‘,æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n),ç­‰åŒäºé¡ºåºæŸ¥æ‰¾.</p><p>å› æ­¤,å¹³è¡¡è‡³å…³é‡è¦.</p><h2 id="å¹³è¡¡äºŒå‰æ ‘-AVLæ ‘"><a href="#å¹³è¡¡äºŒå‰æ ‘-AVLæ ‘" class="headerlink" title="å¹³è¡¡äºŒå‰æ ‘(AVLæ ‘)"></a>å¹³è¡¡äºŒå‰æ ‘(AVLæ ‘)</h2><p>å¹³è¡¡äºŒå‰æœç´¢æ ‘æ˜¯æ”¹è¿›çš„äºŒå‰æœç´¢æ ‘,ä¹Ÿæ˜¯äºŒå‰æœç´¢æ ‘ã€‚</p><p>ä¸€èˆ¬çš„äºŒå‰æœç´¢æ ‘çš„æŸ¥è¯¢å¤æ‚åº¦æ˜¯è·Ÿæ·±åº¦æœ‰å…³ï¼Œå› æ­¤å½“ç»“ç‚¹çš„æ·±åº¦æ™®éè¾ƒå¤§æ—¶ï¼ŒæŸ¥è¯¢çš„å‡æ‘Šå¤æ‚åº¦ä¼šä¸Šå‡ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„æŸ¥è¯¢ï¼Œå¹³è¡¡æ ‘åº”è¿è€Œç”Ÿäº†ã€‚</p><p>å¯ä»¥ä½¿æŸ¥æ‰¾æ ‘çš„é«˜åº¦ä¸º O (log(n)) </p><p>å®šä¹‰:å®ƒæ˜¯ä¸€æ£µç©ºæ ‘æˆ–å®ƒçš„å·¦å³ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼Œå¹¶ä¸”å·¦å³ä¸¤ä¸ªå­æ ‘éƒ½æ˜¯ä¸€æ£µå¹³è¡¡äºŒå‰æ ‘ã€‚</p><p>AVLæ ‘ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æœ‰ä¸€ä¸ªå¹³è¡¡å› å­ï¼ˆbalance factorï¼ŒBFï¼‰ï¼Œå®ƒè¡¨ç¤ºè¿™ä¸ªç»“ç‚¹çš„å·¦ã€å³å­æ ‘çš„æ·±åº¦å·®ï¼Œä¹Ÿå°±æ˜¯å·¦å­æ ‘çš„æ·±åº¦å‡å»å³å­æ ‘çš„æ·±åº¦çš„ç»“æœå€¼ã€‚AVLæ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„BFå€¼åªèƒ½æ˜¯-1ã€0ã€1ã€‚åä¹‹ï¼Œåªè¦äºŒå‰æ ‘ä¸Šä¸€ä¸ªç»“ç‚¹çš„BFçš„ç»å¯¹å€¼å¤§äº1ï¼Œåˆ™è¯¥äºŒå‰æ ‘å°±ä¸æ˜¯å¹³è¡¡äºŒå‰æ ‘ã€‚åœ¨è¿›è¡Œæ’å…¥å’Œåˆ é™¤çš„æ—¶å€™æ‰¾å‡ºå¤±å»å¹³è¡¡çš„èŠ‚ç‚¹ï¼Œè¿›è¡Œå¿…è¦çš„æ—‹è½¬æ“ä½œä¿è¯æ ‘çš„å¹³è¡¡ã€‚</p><p>æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤åœ¨å¹³å‡å’Œæœ€åæƒ…å†µä¸‹éƒ½æ˜¯Oï¼ˆlog nï¼‰</p><h3 id="æœ€å°‘ç»“ç‚¹"><a href="#æœ€å°‘ç»“ç‚¹" class="headerlink" title="æœ€å°‘ç»“ç‚¹"></a>æœ€å°‘ç»“ç‚¹</h3><p>è®¾n(h)æ˜¯é«˜åº¦ä¸ºhçš„AVLæ ‘ï¼Œåˆ™ç»“ç‚¹æ•°æœ€å°‘æ—¶æœ‰:<br>n(h) = n(h-1) + n(h-2) + 1</p><table><thead><tr><th>h(VALæ ‘çš„é«˜åº¦)</th><th>æœ€å°‘ç»“ç‚¹æ•°</th></tr></thead><tbody><tr><td>0</td><td>1</td></tr><tr><td>1</td><td>2</td></tr><tr><td>2</td><td>4</td></tr><tr><td>3</td><td>7</td></tr><tr><td>4</td><td>12</td></tr><tr><td>5</td><td>20</td></tr><tr><td>â€¦</td><td>â€¦</td></tr></tbody></table><p>æ˜¾è€Œæ˜“è§ï¼Œæ»¡è¶³çš„å…³ç³»ä¸º:<br>é«˜åº¦ä¸ºhçš„AVLæ ‘ï¼Œå…¶æœ€å°‘ç»“ç‚¹æ•°é‡ä¸º<code>F(h+2) - 1</code>ï¼Œå…¶ä¸­F(x)ä¸ºæ–æ³¢é‚£å¥‘æ•°åˆ—é€—å·ä¸”è§„å®šä»1å¼€å§‹ï¼Œå³F(0) = 1ï¼ŒF(1) = 2</p><h3 id="è°ƒæ•´"><a href="#è°ƒæ•´" class="headerlink" title="è°ƒæ•´"></a>è°ƒæ•´</h3><p>RR(å³å•æ—‹):éº»çƒ¦ç»“ç‚¹åœ¨å‘ç°ç»“ç‚¹çš„å³å­æ ‘çš„å³å­æ ‘ä¸Š</p><p>RL():éº»çƒ¦ç»“ç‚¹åœ¨å‘ç°ç»“ç‚¹çš„å³å­æ ‘çš„å·¦å­æ ‘ä¸Š</p><p>LL(å·¦å•æ—‹):éº»çƒ¦ç»“ç‚¹åœ¨å‘ç°ç»“ç‚¹çš„å·¦å­æ ‘çš„å·¦å­æ ‘ä¸Š</p><p>LR():éº»çƒ¦ç»“ç‚¹åœ¨å‘ç°ç»“ç‚¹çš„å·¦å­æ ‘çš„å³å­æ ‘ä¸Š</p><h2 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h2><p>å †:ç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘<br>æœ‰åºæ€§:ä»»ä¸€ç»“ç‚¹çš„å…³é”®å­—æ˜¯å…¶å­æ ‘æ‰€æœ‰ç»“ç‚¹çš„æœ€å¤§å€¼(æˆ–è€…æœ€å°å€¼)ï¼Œä»æ ¹ç»“ç‚¹åˆ°ä»»æ„ç»“ç‚¹è·¯å¾„ä¸Šç»“ç‚¹åºåˆ—çš„æœ‰åºæ€§ã€‚<br>æœ€å¤§å †,ä¹Ÿç§°ä¸ºå¤§é¡¶å †:æœ€å¤§å€¼<br>æœ€å°å †,ä¹Ÿç§°ä¸ºå°é¡¶å †:æœ€å°å€¼</p><p>æœ€å¤§å †çš„å»ºç«‹:<br>æ–¹æ³•ä¸€:è‡ªåº•å‘ä¸Šè°ƒæ•´å †ï¼Œé¦–å…ˆå°†nä¸ªèŠ‚ç‚¹æŒ‰è¾“å…¥é¡ºåºå­˜å…¥ï¼Œä½¿å…¶æ»¡è¶³å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ç‰¹æ€§ï¼Œç„¶åè°ƒæ•´å„èŠ‚ç‚¹çš„ä½ç½®ã€‚</p><p>æ–¹æ³•äºŒ:é€šè¿‡æ’å…¥æ“ä½œï¼Œå°†nä¸ªå…ƒç´ ä¸€ä¸ªä¸ªåœ°ç›¸ç»§æ’å…¥åˆ°ä¸€ä¸ªåˆå§‹ä¸ºç©ºçš„å †ä¸­ï¼Œå…¶æ—¶é—´ä»£ä»·æœ€å¤§ä¸ºO(nlogn)ã€‚</p><p>å †é¡¶å…ƒç´ çš„åˆ é™¤<br>å…ƒç´ çš„æ’å…¥</p><h2 id="å“ˆå¤«æ›¼æ ‘"><a href="#å“ˆå¤«æ›¼æ ‘" class="headerlink" title="å“ˆå¤«æ›¼æ ‘"></a>å“ˆå¤«æ›¼æ ‘</h2><p>å¸¦æƒè·¯å¾„é•¿åº¦:è®¾äºŒå‰æ ‘æœ‰nä¸ªå¶å­èŠ‚ç‚¹ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹å¸¦æœ‰æƒå€¼Wï¼Œä»æ ¹èŠ‚ç‚¹åˆ°æ¯ä¸ªå¶å­èŠ‚ç‚¹çš„é•¿åº¦ä¸ºLï¼Œåˆ™æ¯ä¸ªå¶å­èŠ‚ç‚¹çš„å¸¦æƒè·¯å¾„é•¿åº¦ä¹‹å’Œä¸ºWPL=âˆ‘WLã€‚<br>å“ˆå¤«æ›¼æ ‘å³æ˜¯æœ€ä¼˜äºŒå‰æ ‘:WPLæœ€å°çš„äºŒå‰æ ‘ã€‚</p><p>æ€§è´¨:</p><ol><li>æ²¡æœ‰åº¦ä¸º1çš„ç»“ç‚¹(æŒ‰ç…§æ„é€ å“ˆå¤«æ›¼æ ‘çš„è§„åˆ™ï¼Œæ˜¾è€Œæ˜“è§)ã€‚</li><li>nä¸ªå¶å­èŠ‚ç‚¹çš„å“ˆå¤«æ›¼æ ‘å…±æœ‰ <code>2 * n - 1</code>ä¸ªç»“ç‚¹ã€‚</li><li>å“ˆå¤«æ›¼æ ‘çš„ä»»æ„éå¶å­ç»“ç‚¹çš„å·¦å³å­æ ‘äº¤æ¢åä»æ˜¯å“ˆå¤«æ›¼æ ‘ã€‚</li><li>å¯¹åŒä¸€ç»„æƒå€¼çš„ï¼Œå¯èƒ½å­˜åœ¨ä¸åŒç»“æ„çš„å‡ æ£µå“ˆå¤«æ›¼æ ‘ï¼Œä½†æ˜¯å®ƒä»¬çš„WPLæ˜¯ç›¸åŒçš„ã€‚</li></ol><p>æ€§è´¨2æ¨å¯¼:æ ¹æ®å“ˆå¤«æ›¼æ ‘æ²¡æœ‰åº¦ä¸º1çš„ç»“ç‚¹ï¼Œåˆ™ n1 = 0ï¼Œåˆæ ¹æ® n0 = n2 + 1ï¼Œsum = n0 + n1 + n2ï¼Œåˆ™æœ‰:</p><pre><code>sum = n0 + n1 + n2    = n0 + n2    = n0 + n0 - 1    = 2 * n0 - 1    = 2 * n - 1 // nå³n0</code></pre><p>å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡å›¾ç‰‡<br><img src alt></p><p>å›¾açš„WPLä¸º 5 <em> 2 + 7 </em> 2 + 2 <em> 2 + 13 </em> 2 = 54<br>å›¾bçš„WPLä¸º 13 <em> 1 + 7 </em> 2 + 2 <em> 3 + 5 </em> 3 = 48<br>PLçš„è®¡ç®—æ–¹å¼ä¸º:è¯¥èŠ‚ç‚¹çš„æƒå€¼ * ä»æ ¹èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„æ ‘ææ•°é‡</p><p>å“ˆå¤«æ›¼æ ‘çš„æ„é€ :æ¯æ¬¡æŠŠæƒå€¼æœ€å°çš„ä¸¤ä¸ªäºŒå‰æ ‘åˆå¹¶ï¼Œå‚ç…§æœ€å¤§å †çš„è°ƒæ•´ã€‚</p><h2 id="çº¢é»‘æ ‘"><a href="#çº¢é»‘æ ‘" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h2><p>çº¢é»‘æ ‘æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å¸¦æœ‰é¢œè‰²å±æ€§çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œé¢œè‰²ä¸ºçº¢è‰²æˆ–é»‘è‰²ã€‚åœ¨äºŒå‰æŸ¥æ‰¾æ ‘å¼ºåˆ¶ä¸€èˆ¬è¦æ±‚ä»¥å¤–ï¼Œå¯¹äºä»»ä½•æœ‰æ•ˆçš„çº¢é»‘æ ‘æˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹çš„é¢å¤–è¦æ±‚ï¼š</p><p>ï¼ˆ1ï¼‰æ¯ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯é»‘è‰²ï¼Œæˆ–è€…æ˜¯çº¢è‰²ã€‚<br>ï¼ˆ2ï¼‰æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚<br>ï¼ˆ3ï¼‰æ¯ä¸ªå¶å­èŠ‚ç‚¹ï¼ˆNILï¼‰æ˜¯é»‘è‰²ã€‚ [æ³¨æ„ï¼šè¿™é‡Œå¶å­èŠ‚ç‚¹ï¼Œæ˜¯æŒ‡ä¸ºç©º(NILæˆ–NULL)çš„å¶å­èŠ‚ç‚¹ï¼]<br>ï¼ˆ4ï¼‰æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚<br>ï¼ˆ5ï¼‰å¯¹äºä»»ä¸€ç»“ç‚¹è€Œè¨€ï¼Œå…¶åˆ°å¶ç»“ç‚¹æ ‘å°¾ç«¯NILæŒ‡é’ˆçš„æ¯ä¸€æ¡è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘ç»“ç‚¹ã€‚  </p><p>ä¸€æ£µnä¸ªç»“ç‚¹æ˜¯çº¢é»‘æ ‘å§‹ç»ˆä¿æŒäº†lognçš„é«˜åº¦,æ‰€ä»¥çº¢é»‘æ ‘çš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦æœ€åä¸ºO(log n)</p><p>çº¢é»‘æ ‘ä¹‹æ‰€ä»¥æ˜¯å¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¡¨ç¤ºå…¶é¢œè‰²çš„åŸŸå€¼ï¼šçº¢æˆ–é»‘ï¼Œåœ¨æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ—¶å€™ä¾æ®èŠ‚ç‚¹çš„é¢œè‰²å‘å¹³è¡¡çš„æ–¹å‘è°ƒæ•´ã€‚</p><p><img src="http://static.chenyalun.com/2017/04/21/170421007.png" alt></p><p>â€œå¶ç»“ç‚¹â€ æˆ–â€NULLç»“ç‚¹â€ï¼Œå®ƒä¸åŒ…å«æ•°æ®è€Œåªå……å½“æ ‘åœ¨æ­¤ç»“æŸçš„æŒ‡ç¤ºï¼Œè¿™äº›ç»“ç‚¹ä»¥åŠå®ƒä»¬çš„çˆ¶ç»“ç‚¹ï¼Œåœ¨ç»˜å›¾ä¸­éƒ½ä¼šç»å¸¸è¢«çœç•¥ã€‚</p><p>å½“æˆ‘ä»¬åœ¨å¯¹çº¢é»‘æ ‘è¿›è¡Œæ’å…¥å’Œåˆ é™¤ç­‰æ“ä½œæ—¶ï¼Œå¯¹æ ‘åšäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šè¿èƒŒçº¢é»‘æ ‘çš„æ€§è´¨ã€‚ ä¸ºäº†ç»§ç»­ä¿æŒçº¢é»‘æ ‘çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹ç»“ç‚¹è¿›è¡Œé‡æ–°ç€è‰²ï¼Œä»¥åŠå¯¹æ ‘è¿›è¡Œç›¸å…³çš„æ—‹è½¬æ“ä½œ</p><p>å·¦æ—‹:å·¦å³å·¦<br>å³æ—‹:å³å·¦å³</p><h2 id="å¤šè·¯æŸ¥æ‰¾æ ‘-Bæ ‘"><a href="#å¤šè·¯æŸ¥æ‰¾æ ‘-Bæ ‘" class="headerlink" title="å¤šè·¯æŸ¥æ‰¾æ ‘(Bæ ‘)"></a>å¤šè·¯æŸ¥æ‰¾æ ‘(Bæ ‘)</h2><p>Bæ ‘å³ä¸ºB-æ ‘ã€B_æ ‘,åˆå«å¹³è¡¡å¤šè·¯æŸ¥æ‰¾æ ‘.<br>å¤šè·¯æŸ¥æ‰¾æ ‘:å…¶æ¯ä¸€ä¸ªç»“ç‚¹çš„å­©å­æ•°å¯ä»¥å¤šäºä¸¤ä¸ª,æ¯ä¸€ä¸ªç»“ç‚¹å¤„å¯ä»¥å­˜å‚¨å¤šä¸ªå…ƒç´ .</p><p>ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ä¸€ä¸ªå…ƒç´ ,åœ¨å…ƒç´ éå¸¸å¤šçš„æ—¶å€™,å°±ä½¿å¾—è¦ä¹ˆæ ‘çš„åº¦éå¸¸å¤§,è¦ä¹ˆæ ‘çš„é«˜åº¦éå¸¸å¤§,ç”šè‡³ä¸¤è€…éƒ½å¿…é¡»è¶³å¤Ÿå¤§æ‰å¯ä»¥,è¿™ä½¿å¾—å†…å­˜å­˜å–å¤–æ‘æ¬¡æ•°éå¸¸å¤š,é€ æˆäº†æ—¶é—´æ•ˆç‡ä¸Šçš„ç“¶é¢ˆ,äºæ˜¯å¼•å…¥å¤šè·¯æŸ¥æ‰¾æ ‘.</p><p>æ ‘çš„é«˜åº¦è¶Šé«˜ï¼ŒæŸ¥æ‰¾æ–‡ä»¶æ‰€éœ€è¦çš„ç£ç›˜IOè¯»å†™æ¬¡æ•°è¶Šå¤šï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘ç£ç›˜çš„IOè¯»å†™ï¼Œè¦æƒ³åŠæ³•è¿›ä¸€æ­¥é™ä½æ ‘çš„é«˜åº¦ã€‚ å› æ­¤ï¼Œå…·æœ‰å¤šä¸ªå­©å­çš„Bæ ‘ä¾¿åº”è¿è€Œç”Ÿï¼Œå› ä¸ºBæ ‘æ¯ä¸€ä¸ªç»“ç‚¹å¯ä»¥æœ‰å‡ ä¸ªåˆ°å‡ åƒä¸ªå­©å­ï¼Œä½¿å¾—åœ¨ç»“ç‚¹æ•°ç›®ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæ ‘çš„é«˜åº¦ä¼šå¤§å¤§é™ä½ï¼Œä»è€Œæœ‰æ•ˆå‡å°‘ç£ç›˜IOè¯»å†™æ¶ˆè€—ã€‚</p><p>B+æ ‘ã€Bæ ‘ç­‰çš„æ ¹ç»“ç‚¹å’Œéƒ¨åˆ†é¡¶å±‚æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œå¤§éƒ¨åˆ†ä¸‹å±‚æ•°æ®å­˜åœ¨ç£ç›˜ä¸Šã€‚</p><h3 id="2-3æ ‘"><a href="#2-3æ ‘" class="headerlink" title="2-3æ ‘"></a>2-3æ ‘</h3><p>2-3æ ‘æ˜¯è¿™æ ·ä¸€æ£µå¤šè·¯æŸ¥æ‰¾æ ‘:å…¶ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹éƒ½å…·æœ‰ä¸¤ä¸ªå­©å­æˆ–ä¸‰ä¸ªå­©å­.</p><ol><li><p>ä¸€ä¸ª2ç»“ç‚¹åŒ…å«ä¸€ä¸ªå…ƒç´ å’Œä¸¤ä¸ªå­©å­(æˆ–æ²¡æœ‰å­©å­),ä¸äºŒå‰æ’åºæ ‘ç±»ä¼¼,å·¦å­æ ‘åŒ…å«çš„å…ƒç´ å°äºè¯¥å…ƒç´ ,å³å­æ ‘åŒ…å«çš„å…ƒç´ å¤§äºè¯¥å…ƒç´ ,ä¸äºŒå‰æ’åºæ ‘ä¸åŒçš„æ˜¯,è¿™ä¸ª2ç»“ç‚¹è¦ä¹ˆæ²¡æœ‰å­©å­,è¦ä¹ˆå°±æœ‰ä¸¤ä¸ª,ä¸èƒ½åªæœ‰ä¸€ä¸ªå­©å­.</p></li><li><p>ä¸€ä¸ª3ç»“ç‚¹åŒ…å«ä¸€å°ä¸€å¤§ä¸¤ä¸ªå…ƒç´ å’Œä¸‰ä¸ªå­©å­(æˆ–æ²¡æœ‰å­©å­),ä¸€ä¸ª3ç»“ç‚¹è¦ä¹ˆæ²¡æœ‰å­©å­,è¦ä¹ˆå…·æœ‰3ä¸ªå­©å­.å¦‚æœå…·æœ‰3ä¸ªå­©å­çš„è¯,å·¦å­æ ‘åŒ…å«çš„å…ƒç´ å°äºè¾ƒå°å…ƒç´ çš„å…ƒç´ ,å³å­æ ‘åŒ…å«çš„å…ƒç´ å¤§äºè¾ƒå¤§å…ƒç´ çš„å…ƒç´ ,ä¸­é—´å­æ ‘åŒ…å«ä»‹äºä¸¤å…ƒç´ ä¹‹é—´çš„å…ƒç´ .</p></li><li><p>å¹¶ä¸”2-3æ ‘ä¸­æ‰€æœ‰å¶å­éƒ½åœ¨åŒä¸€å±‚æ¬¡ä¸Š.</p></li></ol><p>2-3æ ‘çš„æ’å…¥</p><p>2-3æ ‘çš„åˆ é™¤</p><h3 id="2-3-4æ ‘"><a href="#2-3-4æ ‘" class="headerlink" title="2-3-4æ ‘"></a>2-3-4æ ‘</h3><p>2-3æ ‘çš„æ¦‚å¿µæ‰©å±•,åŒ…æ‹¬äº†4ç»“ç‚¹çš„ä½¿ç”¨.ä¸€ä¸ª4ç»“ç‚¹åŒ…å«å°ä¸­å¤§ä¸‰ä¸ªå…ƒç´ å’Œå››ä¸ªå­©å­(æˆ–è€…æ²¡æœ‰å­©å­).</p><h3 id="Bæ ‘"><a href="#Bæ ‘" class="headerlink" title="Bæ ‘"></a>Bæ ‘</h3><p>Bæ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„å¤šè·¯æŸ¥æ‰¾æ ‘,2-3æ ‘å’Œ2-3-4æ ‘éƒ½æ˜¯Bæ ‘çš„ç‰¹ä¾‹.<br>ç»“ç‚¹æœ€å¤§çš„å­©å­æ•°ç›®ç§°ä¸ºBæ ‘çš„é˜¶.<br>2-3æ ‘æ˜¯3é˜¶Bæ ‘,2-3-4æ ‘æ˜¯4é˜¶Bæ ‘.</p><p>A B-tree of order m is a tree which satisfies the following properties:</p><pre><code>Every node has at most m children.Every non-leaf node (except root) has at least âŒˆm/2âŒ‰ children.The root has at least two children if it is not a leaf node.A non-leaf node with k children contains kâˆ’1 keys.All leaves appear in the same level</code></pre><p>ä¸€æ£µmé˜¶çš„Bæ ‘æ»¡è¶³ä»¥ä¸‹æ¡ä»¶<br>1.æ¯ä¸ªç»“ç‚¹è‡³å¤šæœ‰mæ£µå­æ ‘<br>2.é™¤æ ¹ç»“ç‚¹å¤–,å…¶ä»–åˆ†æ”¯ç»“ç‚¹è‡³å°‘æœ‰ceil(m/2)æ£µå­æ ‘(ceil()å‡½æ•°å‘ä¸Šå–æ•´<br>3.æ ¹ç»“ç‚¹è‡³å°‘æœ‰ä¸¤æ£µå­æ ‘,é™¤éæ ‘åªåŒ…å«ä¸€ä¸ªç»“ç‚¹<br>4.æœ‰kä¸ªå­©å­çš„éå¶ç»“ç‚¹æœ‰k-1ä¸ªå…³é”®ç ,å…³é”®ç æŒ‰é€’å¢æ¬¡åºæ’åˆ—<br>5.æ‰€æœ‰å¶å­ç»“ç‚¹åœ¨åŒä¸€å±‚</p><h4 id="Bæ ‘å¦‚ä½•åšåˆ°å‡å°‘è®¿é—®å¤–å­˜æ¬¡æ•°"><a href="#Bæ ‘å¦‚ä½•åšåˆ°å‡å°‘è®¿é—®å¤–å­˜æ¬¡æ•°" class="headerlink" title="Bæ ‘å¦‚ä½•åšåˆ°å‡å°‘è®¿é—®å¤–å­˜æ¬¡æ•°"></a>Bæ ‘å¦‚ä½•åšåˆ°å‡å°‘è®¿é—®å¤–å­˜æ¬¡æ•°</h4><p>ç¡¬ç›˜å°†ä¿¡æ¯åˆ†å‰²æˆç›¸ç­‰å¤§å°çš„é¡µé¢,æ¯æ¬¡ç¡¬ç›˜è¯»å†™éƒ½æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®Œæ•´çš„é¡µé¢,å¯¹ä¸€ä¸ªç¡¬ç›˜æ¥è¯´,ä¸€é¡µçš„é•¿åº¦å¯èƒ½æ˜¯211åˆ°214å­—èŠ‚.</p><p>åœ¨ä¸€ä¸ªå…¸å‹çš„Bæ ‘åº”ç”¨ä¸­,è¦å¤„ç†çš„ç¡¬ç›˜æ•°æ®é‡å¾ˆå¤§,å› æ­¤æ— æ³•ä¸€æ¬¡å…¨éƒ¨è£…å…¥å†…å­˜,å› æ­¤éœ€è¦å¯¹Bæ ‘è¿›è¡Œè°ƒæ•´,ä½¿å¾—Bæ ‘çš„é˜¶æ ‘ä¸ç¡¬ç›˜å­˜å‚¨çš„é¡µé¢å¤§å°ç›¸åŒ¹é….åœ¨æœ‰é™å†…å­˜çš„æƒ…å†µä¸‹,æ¯ä¸€æ¬¡ç£ç›˜çš„è®¿é—®æˆ‘ä»¬éƒ½å¯ä»¥è·å¾—æœ€å¤§é‡çš„æ•°æ®,ç”±äºBæ ‘æ¯èŠ‚ç‚¹å¯ä»¥å…·æœ‰æ¯”äºŒå‰æ ‘å¤šå¾—å¤šçš„å…ƒç´ ,æ‰€ä»¥å‡å°‘äº†å¿…é¡»è®¿é—®ç»“ç‚¹å’Œæ•°æ®å—çš„æ•°é‡,æé«˜äº†æ€§èƒ½.<br>Bæ ‘çš„æ•°æ®ç»“æ„å°±æ˜¯ä¸ºå†…å¤–å­˜çš„æ•°æ®äº¤äº’å‡†å¤‡çš„.</p><h3 id="B-æ ‘"><a href="#B-æ ‘" class="headerlink" title="B+æ ‘"></a>B+æ ‘</h3><p>B+ æ ‘æ˜¯ä¸€ç§æ ‘æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚NTFS, ReiserFS, NSS, XFS, JFS, ReFS å’ŒBFSç­‰æ–‡ä»¶ç³»ç»Ÿéƒ½åœ¨ä½¿ç”¨B+æ ‘ä½œä¸ºå…ƒæ•°æ®ç´¢å¼•ã€‚</p><p>B+ æ ‘çš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä¿æŒæ•°æ®ç¨³å®šæœ‰åºï¼Œå…¶æ’å…¥ä¸ä¿®æ”¹æ‹¥æœ‰è¾ƒç¨³å®šçš„å¯¹æ•°æ—¶é—´å¤æ‚åº¦ã€‚B+ æ ‘å…ƒç´ è‡ªåº•å‘ä¸Šæ’å…¥ï¼Œè¿™ä¸äºŒå‰æ ‘æ°å¥½ç›¸åã€‚</p><p>ä¸€æ£µmé˜¶çš„B+æ ‘ä¸Bæ ‘çš„åŒºåˆ«åœ¨äº:</p><ol><li>æœ‰næ£µå­æ ‘çš„ç»“ç‚¹åŒ…å«æœ‰nä¸ªå…³é”®å­—</li><li>æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹åŒ…å«å…¨éƒ¨çš„å…³é”®å­—ä¿¡æ¯,ä»¥åŠæŒ‡å‘å«è¿™äº›å…³é”®å­—è®°å½•çš„æŒ‡é’ˆ,å¶å­èŠ‚ç‚¹æœ¬èº«ä¾å…³é”®å­—çš„å¤§å°è‡ªå°è€Œå¤§é¡ºåºé“¾æ¥</li><li>æ‰€æœ‰åˆ†æ”¯ç»“ç‚¹å¯ä»¥çœ‹æˆæ˜¯ç´¢å¼•,ç»“ç‚¹ä¸­ä»…å«æœ‰å…¶å­æ ‘çš„æœ€å¤§(æœ€å°)å…³é”®å­—.</li></ol><p>å¥½å¤„:<br>å¦‚æœè¦éšæœºæŸ¥æ‰¾,å°±ä»æ ¹èŠ‚ç‚¹å‡ºå‘,ä¸Bæ ‘çš„æŸ¥æ‰¾æ–¹å¼ç›¸åŒ,åªä¸è¿‡å³ä½¿åœ¨åˆ†æ”¯ç»“ç‚¹æ‰¾åˆ°äº†å¾…æŸ¥æ‰¾çš„å…³é”®å­—,å®ƒä¹Ÿåªæ˜¯ç”¨æ¥ç´¢å¼•çš„,ä¸èƒ½æä¾›å®é™…è®°å½•çš„è®¿é—®,è¿˜æ˜¯éœ€è¦åˆ°è¾¾åŒ…å«æ­¤å…³é”®å­—çš„ç»ˆç«¯ç»“ç‚¹.</p><p>å¦‚æœéœ€è¦ä»æœ€å°å…³é”®å­—è¿›è¡Œè‡ªå°è€Œå¤§çš„é¡ºåºæŸ¥æ‰¾,å¯ä»¥ä»æœ€å·¦ç«¯çš„å¶å­ç»“ç‚¹å‡ºå‘,ä¸ç»è¿‡åˆ†æ”¯ç»“ç‚¹,è€Œæ˜¯æ²¿ç€æŒ‡å‘ä¸‹ä¸€å¶å­çš„æŒ‡é’ˆå°±å¯éå†æ‰€æœ‰çš„å…³é”®å­—.</p><p>B+æ ‘é€‚åˆæœ‰èŒƒå›´çš„æŸ¥æ‰¾(æ¯”å¦‚å¹´é¾„18â€“22),ä»æ ¹èŠ‚ç‚¹å‡ºå‘æ‰¾åˆ°18,å†åœ¨å¶å­ç»“ç‚¹ä¸­æŒ‰é¡ºåºæ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„è®°å½•.</p><p>B+æ ‘çš„æ’å…¥/åˆ é™¤ä¸Bæ ‘ç±»ä¼¼,åªä¸è¿‡æ’å…¥åˆ é™¤çš„å…ƒç´ éƒ½æ˜¯åœ¨å¶å­ç»“ç‚¹ä¸Šè¿›è¡Œ.</p><h2 id="æ•£åˆ—è¡¨æŸ¥æ‰¾"><a href="#æ•£åˆ—è¡¨æŸ¥æ‰¾" class="headerlink" title="æ•£åˆ—è¡¨æŸ¥æ‰¾"></a>æ•£åˆ—è¡¨æŸ¥æ‰¾</h2><p>å­˜å‚¨ä½ç½® = f(å…³é”®å­—)</p><p>è®°å½•çš„å­˜å‚¨ä½ç½®å’Œå®ƒçš„å…³é”®å­—ä¹‹é—´å»ºç«‹çš„ä¸€ä¸ªç¡®å®šçš„å¯¹åº”å…³ç³».æ¯ä¸ªå…³é”®å­—keyå¯¹åº”ä¸€ä¸ªå­˜å‚¨ä½ç½®f(key),æŸ¥æ‰¾æ—¶æ ¹æ®è¿™ä¸ªç¡®å®šçš„å¯¹åº”å…³ç³»æ‰¾åˆ°ç»™å®škeyçš„æ˜ å°„f(key).</p><p>fç§°ä¸ºæ•£åˆ—å‡½æ•°,åˆç§°å“ˆå¸Œå‡½æ•°,é‡‡ç”¨æ•£åˆ—æŠ€æœ¯å°†è®°å½•å­˜å‚¨åœ¨ä¸€å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ä¸­,è¿™å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ç§°ä¸ºæ•£åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨,å…³é”®å­—å¯¹åº”çš„è®°å½•å­˜å‚¨ä½ç½®ç§°ä¸ºæ•£åˆ—åœ°å€.</p><p>å†²çª:key1ä¸ç­‰äºkey2,ä½†æ˜¯f(key1)=f(key2),key1å’Œkey2ç§°ä¸ºæ•£åˆ—å‡½æ•°çš„åŒä¹‰è¯.</p><h3 id="å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°"><a href="#å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°" class="headerlink" title="å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°"></a>å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°</h3><h4 id="1-ç›´æ¥å®šå€æ³•"><a href="#1-ç›´æ¥å®šå€æ³•" class="headerlink" title="1.ç›´æ¥å®šå€æ³•"></a>1.ç›´æ¥å®šå€æ³•</h4><pre><code>f(key) = a * key + b  (a,bä¸ºå¸¸æ•°)</code></pre><ul><li>ä¼˜ç‚¹:ç®€å•å‡åŒ€,ä¸ä¼šäº§ç”Ÿå†²çª,ä½†éœ€è¦äº‹å…ˆçŸ¥é“å…³é”®å­—çš„åˆ†å¸ƒæƒ…å†µ,é€‚åˆæŸ¥æ‰¾è¡¨è¾ƒå°ä¸”è¿ç»­çš„æƒ…å†µ.</li></ul><h4 id="2-æ•°å­—åˆ†ææ³•"><a href="#2-æ•°å­—åˆ†ææ³•" class="headerlink" title="2.æ•°å­—åˆ†ææ³•"></a>2.æ•°å­—åˆ†ææ³•</h4><p>æ‰‹æœºå·ç ç­‰,å¯¹æ•°å­—è¿›è¡ŒæŠ½å–,åè½¬,å·¦ç¯ä½ç§»,å³ç¯ä½ç§»ç­‰æ–¹å¼åˆç†åœ°å°†å…³é”®å­—åˆ†é…åˆ°æ•£åˆ—è¡¨çš„å„ä½ç½®.</p><ul><li>é€‚åˆå¤„ç†å…³é”®å­—ä½æ•°æ¯”è¾ƒå¤§çš„æƒ…å†µ,å¦‚æœäº‹å…ˆçŸ¥é“å…³é”®å­—çš„åˆ†å¸ƒä¸”å…³é”®å­—çš„è‹¥å¹²ä½åˆ†å¸ƒå‡åŒ€,å¯ä»¥ä½¿ç”¨.</li></ul><h4 id="3-å¹³æ–¹å–ä¸­æ³•"><a href="#3-å¹³æ–¹å–ä¸­æ³•" class="headerlink" title="3.å¹³æ–¹å–ä¸­æ³•"></a>3.å¹³æ–¹å–ä¸­æ³•</h4><p>å…³é”®å­—1234â€”-&gt;å¹³æ–¹å:1522756â€”â€“&gt;æŠ½å–ä¸­é—´çš„3ä½â€”â€”&gt;227,ç”¨ä½œæ•£åˆ—åœ°å€.</p><ul><li>é€‚åˆä¸çŸ¥é“å…³é”®å­—çš„åˆ†å¸ƒ,è€Œä½æ•°åˆä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µ</li></ul><h4 id="4-æŠ˜å æ³•"><a href="#4-æŠ˜å æ³•" class="headerlink" title="4.æŠ˜å æ³•"></a>4.æŠ˜å æ³•</h4><p>ä»å·¦åˆ°å³åˆ†å‰²æˆä½æ•°ç›¸ç­‰çš„å‡ éƒ¨åˆ†,å åŠ æ±‚å’Œ,æŒ‰ç…§æ•£åˆ—è¡¨é•¿,å–åå‡ ä½ä½œä¸ºæ•£åˆ—åœ°å€.</p><p>9876543210â€”â€“&gt;987  654  321 0â€”â€“&gt;æ±‚å’Œ987+654+321+0=1962,æ±‚åä¸‰ä½:962</p><ul><li>é€‚åˆä¸éœ€è¦äº‹å…ˆçŸ¥é“å…³é”®å­—çš„åˆ†å¸ƒ.é€‚åˆå…³é”®å­—ä½æ•°è¾ƒå¤šçš„æƒ…å†µ.</li></ul><h4 id="5-é™¤ç•™ä½™æ•°æ³•"><a href="#5-é™¤ç•™ä½™æ•°æ³•" class="headerlink" title="5.é™¤ç•™ä½™æ•°æ³•"></a>5.é™¤ç•™ä½™æ•°æ³•</h4><p>æœ€å¸¸ç”¨,æ•£åˆ—è¡¨é•¿ä¸ºmçš„å…¬å¼:</p><pre><code>f(key) = key mod p (p&lt;=m)</code></pre><ul><li>è‹¥æ•£åˆ—è¡¨è¡¨é•¿m,é€šå¸¸pä¸ºå°äºæˆ–è€…ç­‰äºè¡¨é•¿çš„æœ€å°è´¨æ•°æˆ–ä¸åŒ…å«å°äº20è´¨å› å­çš„åˆæ•°.</li></ul><h4 id="6-éšæœºæ•°æ³•"><a href="#6-éšæœºæ•°æ³•" class="headerlink" title="6.éšæœºæ•°æ³•"></a>6.éšæœºæ•°æ³•</h4><pre><code>f(key) = random(key)</code></pre><ul><li>å½“å…³é”®å­—çš„é•¿åº¦ä¸ç­‰æ—¶,é‡‡ç”¨è¿™ä¸ªæ–¹æ³•.</li></ul><h3 id="å¸¸ç”¨çš„å¤„ç†å†²çªæ–¹æ³•"><a href="#å¸¸ç”¨çš„å¤„ç†å†²çªæ–¹æ³•" class="headerlink" title="å¸¸ç”¨çš„å¤„ç†å†²çªæ–¹æ³•"></a>å¸¸ç”¨çš„å¤„ç†å†²çªæ–¹æ³•</h3><h4 id="1-å¼€æ”¾å®šå€æ³•"><a href="#1-å¼€æ”¾å®šå€æ³•" class="headerlink" title="1.å¼€æ”¾å®šå€æ³•"></a>1.å¼€æ”¾å®šå€æ³•</h4><p>çº¿æ€§æ¢æµ‹æ³•</p><pre><code>f(key) = (f(key) + d) mod m  (d = 1,2,3...)</code></pre><p>äºŒæ¬¡æ¢æµ‹æ³•</p><pre><code>f(key) = (f(key) + d) mod m  (d = 1^2,-1^2,2^2,-2^2,3^2,-3^2...q^2,-q^2,å…¶ä¸­q&lt;=m/2)</code></pre><p>éšæœºæ¢æµ‹æ³•</p><pre><code>f(key) = (f(key) + d) mod m  (d æ˜¯ä¸€ä¸ªéšæœºæ•°åˆ—)</code></pre><h4 id="2-å†æ•£åˆ—å‡½æ•°æ³•"><a href="#2-å†æ•£åˆ—å‡½æ•°æ³•" class="headerlink" title="2.å†æ•£åˆ—å‡½æ•°æ³•"></a>2.å†æ•£åˆ—å‡½æ•°æ³•</h4><pre><code>f(key) = RH(key)</code></pre><p>æ¯æ¬¡å‘ç”Ÿæ•£åˆ—å†²çªæ—¶,å°±æ¢ä¸€ä¸ªæ•£åˆ—å‡½æ•°è®¡ç®—.</p><h4 id="3-é“¾åœ°å€æ³•"><a href="#3-é“¾åœ°å€æ³•" class="headerlink" title="3.é“¾åœ°å€æ³•"></a>3.é“¾åœ°å€æ³•</h4><p>æä¾›ç»ä¸ä¼šæ‰¾ä¸åˆ°åœ°å€çš„ä¿éšœ,ä½†æ˜¯å¸¦æ¥æŸ¥æ‰¾æ—¶éœ€è¦éå†å•é“¾è¡¨çš„æ€§èƒ½æŸè€—.</p><h4 id="4-å…¬å…±æº¢å‡ºåŒºæ³•"><a href="#4-å…¬å…±æº¢å‡ºåŒºæ³•" class="headerlink" title="4.å…¬å…±æº¢å‡ºåŒºæ³•"></a>4.å…¬å…±æº¢å‡ºåŒºæ³•</h4><p>å¢æ·»æº¢å‡ºè¡¨.<br>å¯¹ç»™å®šå€¼é€šè¿‡æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—åœ°å€å,å…ˆä¸åŸºæœ¬è¡¨çš„ç›¸åº”ä½ç½®è¿›è¡Œæ¯”å¯¹,å¦‚æœç›¸ç­‰,æˆåŠŸ,å¦åˆ™,åˆ°æº¢å‡ºè¡¨ä¸­è¿›è¡Œ<strong>é¡ºåºæŸ¥æ‰¾</strong>.    </p><blockquote><p>å‚è€ƒå¹¶è‡´è°¢<br><a href="https://www.zhihu.com/question/19809666/answer/88158084" target="_blank" rel="noopener">çŸ¥ä¹ ç°æ‰æ ‘</a><br><a href="http://haiyangxu.github.io/posts/2014/2014-05-05-binary_search_tree.html" target="_blank" rel="noopener">HAIYANG XU</a><br><a href="http://blog.csdn.net/v_JULY_v/article/details/6530142/" target="_blank" rel="noopener">v_JULY_v</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p align=&quot;center&quot;&gt; å…³äºæŸ¥æ‰¾ç®—æ³•ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="ç®—æ³•" scheme="http://blog.chenyalun.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
</feed>
