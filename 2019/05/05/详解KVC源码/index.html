<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="详解KVC源码">




  <meta name="keywords" content="iOS开发,阅读,">




  <link rel="alternate" href="/atom.xml" title="Ya">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x">



<link rel="canonical" href="http://blog.chenyalun.com/2019/05/05/详解KVC源码/">


<meta name="description" content="KVC源码阅读。">
<meta name="keywords" content="iOS开发,阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="详解KVC源码">
<meta property="og:url" content="http://blog.chenyalun.com/2019/05/05/详解KVC源码/index.html">
<meta property="og:site_name" content="Ya">
<meta property="og:description" content="KVC源码阅读。">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://image.chenyalun.com/2019/05/05/001.png">
<meta property="og:image" content="https://image.chenyalun.com/2019/05/05/002.png">
<meta property="og:updated_time" content="2019-08-18T04:14:43.151Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="详解KVC源码">
<meta name="twitter:description" content="KVC源码阅读。">
<meta name="twitter:image" content="https://image.chenyalun.com/2019/05/05/001.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">





<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  



    <title> 详解KVC源码 · Ya </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ya</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags/阅读/">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ya</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              时间线
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags/阅读/">
            
            
              阅读
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          详解KVC源码
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019年5月5日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、接口"><span class="toc-text">一、接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#集合代理对象"><span class="toc-text">集合代理对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray"><span class="toc-text">NSArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSet"><span class="toc-text">NSSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSOrderedSet"><span class="toc-text">NSOrderedSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集合操作"><span class="toc-text">集合操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分类的KVC"><span class="toc-text">分类的KVC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、取值"><span class="toc-text">二、取值</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#valueForKey"><span class="toc-text">valueForKey:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方法一"><span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法二"><span class="toc-text">方法二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法三"><span class="toc-text">方法三</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法四"><span class="toc-text">方法四</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法五"><span class="toc-text">方法五</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法指针怎么查找"><span class="toc-text">方法指针怎么查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例变量怎么查找"><span class="toc-text">实例变量怎么查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSKeyValueMethodGetter如何创建"><span class="toc-text">NSKeyValueMethodGetter如何创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-NSKeyValueMethodGetter构造方法中生成IMP"><span class="toc-text">1. NSKeyValueMethodGetter构造方法中生成IMP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-在父类NSKeyValueAccessor中-对class-key-selector-imp-method-参数-参数数量等信息进行保存"><span class="toc-text">2. 在父类NSKeyValueAccessor中, 对class key selector imp method 参数 参数数量等信息进行保存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSKeyValueIvarGetter如何创建"><span class="toc-text">NSKeyValueIvarGetter如何创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么根据Getter取值"><span class="toc-text">怎么根据Getter取值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-线程校验"><span class="toc-text">1. 线程校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-直接调用Getter中存储的方法实现-getter-implementation"><span class="toc-text">2. 直接调用Getter中存储的方法实现(getter.implementation)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#valueForKeyPath"><span class="toc-text">valueForKeyPath:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、设值"><span class="toc-text">三、设值</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#setValue"><span class="toc-text">setValue:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方法一-1"><span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法二-1"><span class="toc-text">方法二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法三-1"><span class="toc-text">方法三</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法四-1"><span class="toc-text">方法四</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么根据Setter设值"><span class="toc-text">怎么根据Setter设值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setValue-forKeyPath"><span class="toc-text">setValue:forKeyPath:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、集合对象的KVC"><span class="toc-text">四、集合对象的KVC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NSArray的KVC"><span class="toc-text">NSArray的KVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口"><span class="toc-text">接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#求和"><span class="toc-text">求和</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#求平均值"><span class="toc-text">求平均值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#求数量"><span class="toc-text">求数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#求最大值"><span class="toc-text">求最大值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#求最小值"><span class="toc-text">求最小值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取数组"><span class="toc-text">获取数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取去重数组"><span class="toc-text">获取去重数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取成员数组"><span class="toc-text">获取成员数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取去重的成员数组"><span class="toc-text">获取去重的成员数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取集合数组"><span class="toc-text">获取集合数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取去重的集合数组"><span class="toc-text">获取去重的集合数组</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSSet的KVC"><span class="toc-text">NSSet的KVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSOrderedSet的KVC"><span class="toc-text">NSOrderedSet的KVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSDictionary的KVC"><span class="toc-text">NSDictionary的KVC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、其他分类的KVC"><span class="toc-text">五、其他分类的KVC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NSMutableDictionary的KVC"><span class="toc-text">NSMutableDictionary的KVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSUserDefaults的KVC"><span class="toc-text">NSUserDefaults的KVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSNull的KVC"><span class="toc-text">NSNull的KVC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六、总结"><span class="toc-text">六、总结</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p></p><p align="center"> KVC源码阅读。 </p><br><a id="more"></a><p></p>
<h1 id="一、接口"><a href="#一、接口" class="headerlink" title="一、接口"></a>一、接口</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line"><span class="comment">// 是否可以直接访问实例变量(实例变量访问开关, 默认YES)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> accessInstanceVariablesDirectly;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过key访问</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// 尝试验证将要设定的value(ioValue指针指向的对象)是否合理有效</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKey:(<span class="built_in">NSString</span> *)inKey error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line"><span class="comment">// 获取相对应的精确容器类型</span></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="built_in">NSMutableSet</span> *)mutableSetValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过keyPath访问</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKeyPath:(<span class="built_in">NSString</span> *)inKeyPath error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="built_in">NSMutableSet</span> *)mutableSetValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找key失败默认抛出异常, 可重写自行实现</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// 设置value失败默认抛出异常, 可重写自行实现</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// 设置value为nil时抛出异常, 可重写自行实现</span></span><br><span class="line">- (<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// 传入key数组, 返回一个成员变量名和变量值的键值对组成的字典(可用于模型转字典)</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br><span class="line"><span class="comment">// 字典转模型</span></span><br><span class="line">- (<span class="keyword">void</span>)setValuesForKeysWithDictionary:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)keyedValues;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 容器扩展</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSDictionary</span>&lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">nullable</span> ObjectType)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableDictionary</span>&lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> ObjectType)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSSet</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSOrderedSet</span>&lt;<span class="title">ObjectType</span>&gt;(<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="集合代理对象"><a href="#集合代理对象" class="headerlink" title="集合代理对象"></a>集合代理对象</h2><p>这里简单总结集合代理对象的使用。</p>
<blockquote>
<p>当我们在对象上调用 <code>-valueForKey:</code> 的时候，它可以返回 <code>NSArray</code>，<code>NSSet</code> 或是 <code>NSOrderedSet</code> 的集合代理对象。这个类没有实现通常的 <code>-&lt;Key&gt;</code> 方法，但是它实现了代理对象所需要使用的很多方法。</p>
</blockquote>
<h3 id="NSArray"><a href="#NSArray" class="headerlink" title="NSArray"></a>NSArray</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Primes</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *primes;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Primes</span></span></span><br><span class="line"><span class="keyword">@dynamic</span> primes; <span class="comment">// 不要生成get方法</span></span><br><span class="line"><span class="keyword">static</span> int32_t <span class="keyword">const</span> primes[] = &#123;</span><br><span class="line">    <span class="number">2</span>, <span class="number">101</span>, <span class="number">233</span>, <span class="number">383</span>, <span class="number">3</span>, <span class="number">103</span>, <span class="number">239</span>, <span class="number">389</span>, <span class="number">5</span>, <span class="number">107</span>, <span class="number">241</span>, <span class="number">397</span>, <span class="number">7</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">251</span>, <span class="number">401</span>, <span class="number">11</span>, <span class="number">113</span>, <span class="number">257</span>, <span class="number">409</span>, <span class="number">13</span>, <span class="number">127</span>, <span class="number">263</span>, <span class="number">419</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">269</span>,</span><br><span class="line">    <span class="number">421</span>, <span class="number">19</span>, <span class="number">137</span>, <span class="number">271</span>, <span class="number">431</span>, <span class="number">23</span>, <span class="number">139</span>, <span class="number">277</span>, <span class="number">433</span>, <span class="number">29</span>, <span class="number">149</span>, <span class="number">281</span>, <span class="number">439</span>,</span><br><span class="line">    <span class="number">31</span>, <span class="number">151</span>, <span class="number">283</span>, <span class="number">443</span>, <span class="number">37</span>, <span class="number">157</span>, <span class="number">293</span>, <span class="number">449</span>, <span class="number">41</span>, <span class="number">163</span>, <span class="number">307</span>, <span class="number">457</span>, <span class="number">43</span>,</span><br><span class="line">    <span class="number">167</span>, <span class="number">311</span>, <span class="number">461</span>, <span class="number">47</span>, <span class="number">173</span>, <span class="number">313</span>, <span class="number">463</span>, <span class="number">53</span>, <span class="number">179</span>, <span class="number">317</span>, <span class="number">467</span>, <span class="number">59</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">331</span>, <span class="number">479</span>, <span class="number">61</span>, <span class="number">191</span>, <span class="number">337</span>, <span class="number">487</span>, <span class="number">67</span>, <span class="number">193</span>, <span class="number">347</span>, <span class="number">491</span>, <span class="number">71</span>, <span class="number">197</span>, <span class="number">349</span>,</span><br><span class="line">    <span class="number">499</span>, <span class="number">73</span>, <span class="number">199</span>, <span class="number">353</span>, <span class="number">503</span>, <span class="number">79</span>, <span class="number">211</span>, <span class="number">359</span>, <span class="number">509</span>, <span class="number">83</span>, <span class="number">223</span>, <span class="number">367</span>, <span class="number">521</span>,</span><br><span class="line">    <span class="number">89</span>, <span class="number">227</span>, <span class="number">373</span>, <span class="number">523</span>, <span class="number">97</span>, <span class="number">229</span>, <span class="number">379</span>, <span class="number">541</span>, <span class="number">547</span>, <span class="number">701</span>, <span class="number">877</span>, <span class="number">1049</span>,</span><br><span class="line">    <span class="number">557</span>, <span class="number">709</span>, <span class="number">881</span>, <span class="number">1051</span>, <span class="number">563</span>, <span class="number">719</span>, <span class="number">883</span>, <span class="number">1061</span>, <span class="number">569</span>, <span class="number">727</span>, <span class="number">887</span>,</span><br><span class="line">    <span class="number">1063</span>, <span class="number">571</span>, <span class="number">733</span>, <span class="number">907</span>, <span class="number">1069</span>, <span class="number">577</span>, <span class="number">739</span>, <span class="number">911</span>, <span class="number">1087</span>, <span class="number">587</span>, <span class="number">743</span>,</span><br><span class="line">    <span class="number">919</span>, <span class="number">1091</span>, <span class="number">593</span>, <span class="number">751</span>, <span class="number">929</span>, <span class="number">1093</span>, <span class="number">599</span>, <span class="number">757</span>, <span class="number">937</span>, <span class="number">1097</span>, <span class="number">601</span>,</span><br><span class="line">    <span class="number">761</span>, <span class="number">941</span>, <span class="number">1103</span>, <span class="number">607</span>, <span class="number">769</span>, <span class="number">947</span>, <span class="number">1109</span>, <span class="number">613</span>, <span class="number">773</span>, <span class="number">953</span>, <span class="number">1117</span>,</span><br><span class="line">    <span class="number">617</span>, <span class="number">787</span>, <span class="number">967</span>, <span class="number">1123</span>, <span class="number">619</span>, <span class="number">797</span>, <span class="number">971</span>, <span class="number">1129</span>, <span class="number">631</span>, <span class="number">809</span>, <span class="number">977</span>,</span><br><span class="line">    <span class="number">1151</span>, <span class="number">641</span>, <span class="number">811</span>, <span class="number">983</span>, <span class="number">1153</span>, <span class="number">643</span>, <span class="number">821</span>, <span class="number">991</span>, <span class="number">1163</span>, <span class="number">647</span>, <span class="number">823</span>,</span><br><span class="line">    <span class="number">997</span>, <span class="number">1171</span>, <span class="number">653</span>, <span class="number">827</span>, <span class="number">1009</span>, <span class="number">1181</span>, <span class="number">659</span>, <span class="number">829</span>, <span class="number">1013</span>, <span class="number">1187</span>, <span class="number">661</span>,</span><br><span class="line">    <span class="number">839</span>, <span class="number">1019</span>, <span class="number">1193</span>, <span class="number">673</span>, <span class="number">853</span>, <span class="number">1021</span>, <span class="number">1201</span>, <span class="number">677</span>, <span class="number">857</span>, <span class="number">1031</span>,</span><br><span class="line">    <span class="number">1213</span>, <span class="number">683</span>, <span class="number">859</span>, <span class="number">1033</span>, <span class="number">1217</span>, <span class="number">691</span>, <span class="number">863</span>, <span class="number">1039</span>, <span class="number">1223</span>, <span class="number">1229</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectInPrimesAtIndex:(<span class="built_in">NSUInteger</span>)idx &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(idx &lt; <span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">    <span class="keyword">return</span> @(primes[idx]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对于NSArray， 实现<code>-countOf&lt;Key&gt;</code>方法，<code>-objectIn&lt;Key&gt;AtIndex:</code>或者<code>-&lt;key&gt;AtIndexes:</code>中的一个即可，当然如果再实现<code>-get&lt;Key&gt;:range:</code>将会增强性能。</p>
<p>上面的例子中，key是”primes”，实际上并没有这个primes数组，而是用了一个C数组代理了。<code>@property (nonatomic, copy, readonly) NSArray *primes;</code>和<code>@dynamic primes;</code> 这两句话可以省略（下文的例子就省略了），这里加上的原因是，便于外界知晓具体的key值。</p>
<p>使用：</p>
<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">Primes *primes = [Primes <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueArray</span>'</span></span><br><span class="line">id obj = [primes valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure>
<p>可见，获得的对象并不是一个NSArray，而是<code>NSKeyValueArray</code>。</p>
<h3 id="NSSet"><a href="#NSSet" class="headerlink" title="NSSet"></a>NSSet</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrimesSet</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrimesSet</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSSet</span> *_numSet;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _numSet = [<span class="built_in">NSSet</span> setWithObjects:@<span class="number">0</span>, @<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, <span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numSet.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSEnumerator</span> *)enumeratorOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numSet.objectEnumerator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)memberOfPrimes:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numSet member:obj];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对于NSSet，要实现<code>-countOf&lt;Key&gt;</code>、<code>-enumeratorOf&lt;Key&gt;</code>和<code>-memberOf&lt;Key&gt;:</code>这三个方法。</p>
<p>使用：</p>
<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">PrimesSet *primesSet = [PrimesSet <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueSet</span>'</span></span><br><span class="line">id obj = [primesSet valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure>
<p>获取到的对象是<code>NSKeyValueSet</code>。</p>
<h3 id="NSOrderedSet"><a href="#NSOrderedSet" class="headerlink" title="NSOrderedSet"></a>NSOrderedSet</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrimesOrderedSet</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrimesOrderedSet</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSOrderedSet</span> *_numOrderedSet;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _numOrderedSet = [<span class="built_in">NSOrderedSet</span> orderedSetWithObjects:@<span class="number">0</span>, @<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, <span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes &#123;</span><br><span class="line">    <span class="keyword">return</span> _numOrderedSet.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)indexInPrimesOfObject:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numOrderedSet indexOfObject:obj];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectInPrimesAtIndex:(<span class="built_in">NSUInteger</span>)idx &#123;</span><br><span class="line">    <span class="keyword">return</span> [_numOrderedSet objectAtIndex:idx];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于提高性能</span></span><br><span class="line">- (<span class="keyword">void</span>)getPrimes:(<span class="keyword">id</span> __<span class="keyword">unsafe_unretained</span> *)buffer range:(<span class="built_in">NSRange</span>)inRange &#123;</span><br><span class="line">    <span class="comment">// 返回提供的缓冲区内指定范围内的数据集合</span></span><br><span class="line">    [_numOrderedSet getObjects:buffer range:inRange];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>必须实现的方法是<code>-countOf&lt;Key&gt;</code>和<code>-indexIn&lt;Key&gt;OfObject:</code>。二选一实现的方法是<code>-objectIn&lt;Key&gt;AtIndex:</code>和<code>-&lt;key&gt;AtIndexes:</code>。如果再实现<code>-get&lt;Key&gt;:range:</code>将会增强性能。</p>
<p>使用：</p>
<figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">PrimesOrderedSet *primesOrderedSet = [PrimesOrderedSet <span class="keyword">new</span>];</span><br><span class="line"><span class="regexp">//</span> obj <span class="keyword">is</span> kind <span class="keyword">of</span> <span class="class"><span class="keyword">class</span> '<span class="title">NSKeyValueOrderedSet</span>'</span></span><br><span class="line">id obj = [primesOrderedSet valueForKey:@<span class="string">"primes"</span>];</span><br></pre></td></tr></table></figure>
<p>获取到的对象是<code>NSKeyValueOrderedSet</code>。</p>
<h2 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h2><p>数组最大值：</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">NSArray <span class="symbol">*</span>array = <span class="meta">@[</span><span class="meta">@1,</span> <span class="meta">@8,</span> <span class="meta">@5];</span></span><br><span class="line">[array valueForKeyPath:<span class="meta">@"</span><span class="meta">@max.self"];</span></span><br></pre></td></tr></table></figure>
<p>模型数组最大值：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">NSArray *<span class="keyword">array</span> = @[person1, person2, person3];</span><br><span class="line">[<span class="keyword">array</span> valueForKeyPath:@<span class="string">"@max.age"</span>];</span><br></pre></td></tr></table></figure>
<p>其他操作符：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@max</span> <span class="variable">@min</span>: 获得数组中最大(或者最小)的一个元素</span><br><span class="line"><span class="variable">@avg</span>: 将集合中对象转换成double类型，返回数组中指定的平均值的number对象</span><br><span class="line"><span class="variable">@sum</span>: 将集合中每个对象都转换成double类型，然后计算总和，最后返回一个值为这个总和的NSNumber对象</span><br><span class="line"><span class="variable">@count</span>：返回集合中对象总数的NSNumber对象</span><br><span class="line"></span><br><span class="line">返回一个由操作符右边的key path指定的对象属性组成的数组，distincUnionOfObjects会对数组去重。</span><br><span class="line">示例：</span><br><span class="line">[personList <span class="attribute">valueForKeyPath</span>:@<span class="string">"@unionOfObjects.name"</span>];</span><br><span class="line"><span class="selector-attr">[personList valueForKeyPath:@"@distinctUnionOfObjects.name"]</span>;</span><br><span class="line">操作对象：<span class="variable">@unionOfObjects</span>/<span class="variable">@distincUnionOfObjects</span> </span><br><span class="line">操作数组：<span class="variable">@distinctUnionOfArrays</span>/<span class="variable">@unionOfArrays</span></span><br><span class="line">操作集合：<span class="variable">@distinctUnionOfSets</span> 和<span class="variable">@distinctUnionOfArrays</span></span><br></pre></td></tr></table></figure>
<h2 id="分类的KVC"><a href="#分类的KVC" class="headerlink" title="分类的KVC"></a>分类的KVC</h2><p>一般的场景是这样：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 主类</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> :  <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分类</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> (<span class="title">PrimitiveAccessors</span>)</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span> (<span class="title">PrimitiveAccessors</span>)</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSNumber</span> *gVolume;</span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume &#123;</span><br><span class="line">    <span class="keyword">return</span> gVolume;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value &#123;</span><br><span class="line">    gVolume = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对于主类中没有的key，分类实现特定的方法后，KVC也将会生效。如果是取值，分类必须实现这样的方法：<code>getPrimitive&lt;key&gt;</code>或者<code>primitive&lt;key&gt;</code>。上面的例子中，key是volume。如果是设值，分类必须实现<code>setPrimitive&lt;key&gt;:</code>方法。</p>
<p>使用：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">Portion *p = [Portion <span class="keyword">new</span>];</span><br><span class="line">[p <span class="string">setValue:</span>@<span class="number">234</span> <span class="string">forKey:</span>@<span class="string">"volume"</span>];</span><br><span class="line">id m = [p <span class="string">valueForKey:</span>@<span class="string">"volume"</span>];</span><br></pre></td></tr></table></figure>
<p>当然，本质上来讲，并KVC不介意这些方法在主类还是分类实现的，只有实现就成。上面的只是一个例子，实际上，完全依靠主类也是无妨的。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Portion</span> :  <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Portion</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSNumber</span> *gVolume;</span><br><span class="line">- (<span class="built_in">NSNumber</span> *)primitiveVolume &#123;</span><br><span class="line">    <span class="keyword">return</span> gVolume;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setPrimitiveVolume:(<span class="built_in">NSNumber</span> *)value &#123;</span><br><span class="line">    gVolume = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h1 id="二、取值"><a href="#二、取值" class="headerlink" title="二、取值"></a>二、取值</h1><h2 id="valueForKey"><a href="#valueForKey" class="headerlink" title="valueForKey:"></a>valueForKey:</h2><p>苹果在接口这里已经给出了其基本原理：</p>
<blockquote>
<p>The default implementation of this method does the following:</p>
<ol>
<li><p>Searches the class of the receiver for an accessor method whose name matches the pattern <code>-get&lt;Key&gt;, -&lt;key&gt;, or -is&lt;Key&gt;</code>, in that order. If such a method is found it is invoked. If the type of the method’s result is an object pointer type the result is simply returned. If the type of the result is one of the scalar types supported by NSNumber conversion is done and an NSNumber is returned. Otherwise, conversion is done and an NSValue is returned (new in Mac OS 10.5: results of arbitrary type are converted to NSValues, not just NSPoint, NRange, NSRect, and NSSize).</p>
</li>
<li><p>(introduced in Mac OS 10.7). Otherwise (no simple accessor method is found), searches the class of the receiver for methods whose names match the patterns <code>-countOf&lt;Key&gt; and -indexIn&lt;Key&gt;OfObject: and -objectIn&lt;Key&gt;AtIndex:</code>(corresponding to the primitive methods defined by the NSOrderedSet class) and also <code>-&lt;key&gt;AtIndexes:</code> (corresponding to -[NSOrderedSet objectsAtIndexes:]). If a count method and an indexOf method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSOrderedSet methods is returned. Each NSOrderedSet message sent to the collection proxy object will result in some combination of<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:, -objectIn&lt;Key&gt;AtIndex:, and -&lt;key&gt;AtIndexes:</code> messages being sent to the original receiver of <code>-valueForKey:</code>. If the class of the receiver also implements an optional method whose name matches the pattern -get<key>:range: that method will be used when appropriate for best performance.</key></p>
</li>
</ol>
<ol start="3">
<li><p>Otherwise (no simple accessor method or set of ordered set access methods is found), searches the class of the receiver for methods whose names match the patterns <code>-countOf&lt;Key&gt; and -objectIn&lt;Key&gt;AtIndex:</code>(corresponding to the primitive methods defined by the NSArray class) and (introduced in Mac OS 10.4) also<code>-&lt;key&gt;AtIndexes:</code>(corresponding to -[NSArray objectsAtIndexes:]). If a count method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSArray methods is returned. Each NSArray message sent to the collection proxy object will result in some combination of <code>-countOf&lt;Key&gt;, -objectIn&lt;Key&gt;AtIndex:, and -&lt;key&gt;AtIndexes:</code> messages being sent to the original receiver of <code>-valueForKey:</code>. If the class of the receiver also implements an optional method whose name matches the pattern <code>-get&lt;Key&gt;:range:</code> that method will be used when appropriate for best performance.</p>
</li>
<li><p>(introduced in Mac OS 10.4). Otherwise (no simple accessor method or set of ordered set or array access methods is found), searches the class of the receiver for a threesome of methods whose names match the patterns <code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;:</code> (corresponding to the primitive methods defined by the NSSet class). If all three such methods are found a collection proxy object that responds to all NSSet methods is returned. Each NSSet message sent to the collection proxy object will result in some combination of <code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;:</code>messages being sent to the original receiver of <code>-valueForKey:</code>.</p>
</li>
<li><p>Otherwise (no simple accessor method or set of collection access methods is found), if the receiver’s class’ +accessInstanceVariablesDirectly property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern <code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;</code>, in that order. If such an instance variable is found, the value of the instance variable in the receiver is returned, with the same sort of conversion to NSNumber or NSValue as in step 1.</p>
</li>
<li><p>Otherwise (no simple accessor method, set of collection access methods, or instance variable is found), invokes <code>-valueForUndefinedKey:</code> and returns the result. The default implementation of <code>-valueForUndefinedKey:</code> raises an NSUndefinedKeyException, but you can override it in your application.</p>
</li>
</ol>
<p>Compatibility notes:</p>
<ul>
<li>For backward binary compatibility, an accessor method whose name matches the pattern <code>-_get&lt;Key&gt;</code>, or <code>-_&lt;key&gt;</code> is searched for between steps 1 and 3. If such a method is found it is invoked, with the same sort of conversion to NSNumber or NSValue as in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</li>
<li>The behavior described in step 5 is a change from Mac OS 10.2, in which the instance variable search order was <code>&lt;key&gt;, _&lt;key&gt;</code>.</li>
<li>For backward binary compatibility, <code>-handleQueryWithUnboundKey:</code> will be invoked instead of <code>-valueForUndefinedKey:</code> in step 6, if the implementation of <code>-handleQueryWithUnboundKey:</code> in the receiver’s class is not NSObject’s.</li>
</ul>
</blockquote>
<p>用蹩脚的英语翻译如下：</p>
<ol>
<li>按照<code>-get&lt;Key&gt;, -&lt;key&gt;, -is&lt;Key&gt;</code>的顺序搜索该类的存取器方法，若找到，则直接调用。如果方法调用的结果是<code>id</code>类型，直接把结果返回。如果方法调用的结果是能够被<code>NSNumber</code>转换的标量类型，则结果会被转为<code>NSNumber</code>返回。否则对于一般的标量类型，这些类型将会被转化为<code>NSValue</code>（在Mac OS 10.5及以后，不仅仅支持<code>NSPoint, NRange, NSRect</code>，以及<code>NSSize</code>这些类型）。</li>
<li>如果简单的存取器方法没有找到，那么搜索该类的<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:</code>方法，还有<code>-objectIn&lt;Key&gt;AtIndex:</code>（对应被<code>NSOrderedSet</code>类所定义的方法），<code>-&lt;key&gt;AtIndexes:</code>（对应<code>-[NSOrderedSet objectsAtIndexes:]</code>）方法。如果<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:</code>这两个方法被找到，另外两个方法中的至少一个被找到，那么这个能响应<code>NSOrderedSet</code>所有方法的集合代理对象会被返回。发送给原来消息接收者的<code>-valueForKey:</code>消息，将会被这个集合代理对象的<code>-countOf&lt;Key&gt;, -indexIn&lt;Key&gt;OfObject:, -objectIn&lt;Key&gt;AtIndex:, -&lt;key&gt;AtIndexes:</code>这些方法共同处理。如果这个代理对象也实现了可选的<code>-get&lt;Key&gt;:range:</code>方法，这将有助于增强性能。</li>
<li>如果存取器方法和<code>ordered set</code>的代理方法没有被找到，那么搜索该类的<code>-countOf&lt;Key&gt;</code>方法，还有<code>-objectIn&lt;Key&gt;AtIndex:</code>（对应被<code>NSArray</code>类所定义的方法），<code>-&lt;key&gt;AtIndexes:</code>（对应<code>-[NSArray objectsAtIndexes:]</code>）方法。如果<code>-countOf&lt;Key&gt;</code>这个方法被找到，另外两个方法中的至少一个被找到，那么这个能响应<code>NSArray</code>所有方法的集合代理对象会被返回。发送给原来消息接收者的<code>-valueForKey:</code>消息，将会被这个集合代理对象的<code>-countOf&lt;Key&gt;, -objectIn&lt;Key&gt;AtIndex:, -&lt;key&gt;AtIndexes:</code>这些方法共同处理。如果这个代理对象也实现了可选的<code>-get&lt;Key&gt;:range:</code>方法，这将有助于增强性能。</li>
<li>如果存取器方法、<code>ordered set</code>和<code>array</code>的代理方法都没有被找到，那么尝试搜索<code>-countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;,  -memberOf&lt;Key&gt;:</code>这些(被<code>NSSet</code>类所定义的)方法。如果这三个方法都能被找到，那么这个能响应<code>NSSet</code>所有方法的集合代理对象会被返回。发送给原来消息接收者的<code>-valueForKey:</code>消息，将会被这个集合代理对象的<code>countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;,  -memberOf&lt;Key&gt;:</code>这些方法共同处理。</li>
<li>如果存取器方法、<code>ordered set</code>、<code>array</code>以及<code>set</code>的代理方法都没有被找到，倘若此时消息接收者的<code>+accessInstanceVariablesDirectly</code>属性返回的是<code>YES</code>，那么按照<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>的顺序搜索该类的实例变量。如果找到这个实例变量，那么按照步骤1中的类型转换规则返回这个实例变量的值。</li>
<li>否则(啥也没找到)，调用<code>-valueForUndefinedKey:</code>方法并返回结果。这个方法的默认实现是抛出<code>NSUndefinedKeyException</code>异常，不过你可以重写该方法自行实现。</li>
</ol>
<p>兼容性：</p>
<ul>
<li><p>为了向后兼容，会在步骤1中查找名称为<code>-_get&lt;Key&gt;,  -_&lt;key&gt;</code>的存取器方法。如果找到了，会进行调用并按照步骤1中的类型转换规则返回调用的结果。</p>
</li>
<li><p>从Mac OS 10.2开始，步骤5中的实例变量搜索顺序从原先的<code>&lt;key&gt;, _&lt;key&gt;</code>改为现在的<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>。</p>
</li>
<li><p>如果<code>-handleQueryWithUnboundKey:</code>的实现不是<code>NSObject</code>的默认实现（换句话说，自己手动实现了<code>-handleQueryWithUnboundKey:</code>方法），那在步骤6中，<code>-handleQueryWithUnboundKey:</code>方法将会代替<code>-valueForUndefinedKey:</code>方法被调用。</p>
</li>
</ul>
<p>说得清晰明了。流程图如下：</p>
<p><img src="https://image.chenyalun.com/2019/05/05/001.png" alt></p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(key) &#123;</span><br><span class="line">        OSSpinLockLock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// 创建缓存getter的CFSet集合NSKeyValueCachedGetters</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NSKeyValueCachedGetters</span>) &#123;</span><br><span class="line">            <span class="comment">// CFSet对象需要的结构体参数, 告诉这个集合怎么管理容器中的对象</span></span><br><span class="line">            <span class="comment">// retain\release是内存管理 equal\hash是对象处理 copyDescription是复制处理</span></span><br><span class="line">            <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            callbacks.version = kCFTypeSetCallBacks.version;</span><br><span class="line">            <span class="comment">// 也可以禁用掉retain和release, 这样当对象销毁时需要及时将其从集合中移除否则会崩溃</span></span><br><span class="line">            <span class="comment">// callbacks.retain = NULL;</span></span><br><span class="line">            <span class="comment">// callbacks.release = NULL;</span></span><br><span class="line">            callbacks.retain = kCFTypeSetCallBacks.retain;</span><br><span class="line">            callbacks.release = kCFTypeSetCallBacks.release;</span><br><span class="line">            callbacks.copyDescription = kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">            callbacks.equal = (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValueAccessorIsEqual</span>;</span><br><span class="line">            callbacks.hash = (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValueAccessorHash</span>;</span><br><span class="line">            <span class="built_in">NSKeyValueCachedGetters</span> = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>,<span class="number">0</span>,&amp;callbacks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据class、key和hash创建唯一的NSKeyValueGetter对象, 作为从缓存集合中查找的"引子"</span></span><br><span class="line">        <span class="comment">// 只要hashValue一致, 不管其他属性是否一致, 就可以判定这两个对象是一致的</span></span><br><span class="line">        <span class="comment">// 这也是为啥首先根据class和key, 创建一个"简单"的finder到缓存集合中查找的原因</span></span><br><span class="line">        <span class="built_in">NSKeyValueGetter</span> *finder = [<span class="built_in">NSKeyValueGetter</span> new];</span><br><span class="line">        finder.containerClassID = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        finder.key = key;</span><br><span class="line">        finder.hashValue = <span class="built_in">CFHash</span>(key) ^ (<span class="built_in">NSUInteger</span>)(object_getClass(<span class="keyword">self</span>));</span><br><span class="line">        <span class="comment">// 缓存集合中是否含有特定的NSKeyValueGetter</span></span><br><span class="line">        <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span> =  <span class="built_in">CFSetGetValue</span>(<span class="built_in">NSKeyValueCachedGetters</span>, finder);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">getter</span>) &#123;</span><br><span class="line">            <span class="comment">// 缓存中没有找到, 创建getter</span></span><br><span class="line">            <span class="keyword">getter</span> = [object_getClass(<span class="keyword">self</span>) _createValueGetterWithContainerClassID:object_getClass(<span class="keyword">self</span>) key:key];</span><br><span class="line">            <span class="comment">// 这里的getter相比上面的finder更加具体详细, 虽然根据哈希来说, 二者是"相同的对象"</span></span><br><span class="line">            <span class="comment">// 创建好getter后, 把它放到缓存集合中</span></span><br><span class="line">            <span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueCachedGetters</span>, <span class="keyword">getter</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        OSSpinLockUnlock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// 找到getter, 交给_NSGetUsingKeyValueGetter函数处理</span></span><br><span class="line">        <span class="keyword">return</span> _NSGetUsingKeyValueGetter(<span class="keyword">self</span>, <span class="keyword">getter</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// key为空, 抛出异常</span></span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"%@: attempt to retrieve a value for a nil key"</span>,_NSMethodExceptionProem(<span class="keyword">self</span>,_cmd)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法主要做了四件事:</p>
<ol>
<li><p>取值时，使用<code>OSSpinLockLock</code>保证线程安全</p>
</li>
<li><p>根据class和key，生成一个<code>NSKeyValueGetter</code>对象，用于封装信息</p>
</li>
<li><p>取值时，会根据class和key配置一个简单的<code>Getter</code>，首先到<code>CFSet</code>缓存集合中进行查找，以提高查找速度</p>
</li>
<li><p>当<code>key</code>不存在时，直接抛出异常: 参数有误</p>
</li>
</ol>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>当缓存集合中不存在时，便进入了更为具体的”查找”流程中。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 详细的查找流程(此处假定key为"name")</span></span><br><span class="line">+ (<span class="built_in">NSKeyValueGetter</span> *)_createValueGetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueGetter</span> * <span class="keyword">getter</span> = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取字节长度</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> keyLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// 这个数组用于存放首字符大写的key, 例如: "Name"</span></span><br><span class="line">    <span class="keyword">char</span> keyCStrUpFirst[keyLen + <span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 将key转为C字符串, 存储在keyCStrUpFirst数组中</span></span><br><span class="line">    [key getCString:keyCStrUpFirst maxLength:keyLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span> (key.length) &#123;</span><br><span class="line">        <span class="comment">// 将小写字母转为大写字母</span></span><br><span class="line">        keyCStrUpFirst[<span class="number">0</span>] = toupper(keyCStrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这个数组用于存放与key一致的字符, 例如: "name"</span></span><br><span class="line">    <span class="keyword">char</span> keyCStr[keyLen + <span class="number">16</span>];</span><br><span class="line">    <span class="comment">// 再将key转为C字符串, 存储在keyCStr数组中</span></span><br><span class="line">    [key getCString:keyCStr maxLength:keyLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    Method getMethod = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 查询方法指针, 使用'逻辑或'固定了默认顺序:getName==&gt;name==&gt;isName==&gt;_getName==&gt;_name</span></span><br><span class="line">    <span class="comment">// 此处证明了接口文档中的第一步</span></span><br><span class="line">    <span class="comment">// 1. Whose name matches the pattern -get&lt;Key&gt;, -&lt;key&gt;, or -is&lt;Key&gt;, in that order.</span></span><br><span class="line">    <span class="comment">// 2. For backward binary compatibility, an accessor method whose name matches the pattern -_get&lt;Key&gt;, or -_&lt;key&gt; is searched for between steps 1 and 3.</span></span><br><span class="line">    <span class="keyword">if</span>((getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"get%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"%s"</span>,keyCStr)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"is%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"_get%s"</span>,keyCStrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"_%s"</span>,keyCStr))) &#123;</span><br><span class="line">        <span class="comment">// 成功找到, 创建NSKeyValueMethodGetter对象, 保存找到的method</span></span><br><span class="line">        <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueMethodGetter</span> alloc] initWithContainerClassID:containerClassID key:key method:getMethod];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        没有找到, 进入下个流程, 假定key为"name", 则:</span></span><br><span class="line"><span class="comment">        ountOf_Method 对应 countOfName</span></span><br><span class="line"><span class="comment">        ObjectIn_AtIndexMethod 对应 objectInNameAtIndex:</span></span><br><span class="line"><span class="comment">        _AtIndexesMethod 对应 nameAtIndexes:</span></span><br><span class="line"><span class="comment">        IndexIn_OfObjectMethod 对应 indexInNameOfObject:</span></span><br><span class="line"><span class="comment">        enumeratorOf_Method 对应 enumeratorOfName</span></span><br><span class="line"><span class="comment">        memberOf_Method 对应 memberOfName:</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Method ountOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"countOf%"</span>, keyCStrUpFirst);</span><br><span class="line">        Method ObjectIn_AtIndexMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"objectIn%sAtIndex:"</span>, keyCStrUpFirst);</span><br><span class="line">        Method _AtIndexesMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"%sAtIndexes:"</span>, keyCStr);</span><br><span class="line">        Method IndexIn_OfObjectMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"indexIn%sOfObject:"</span>, keyCStrUpFirst);</span><br><span class="line">        </span><br><span class="line">        Method enumeratorOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"enumeratorOf%s"</span>, keyCStrUpFirst);</span><br><span class="line">        Method memberOf_Method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"memberOf%s:"</span>, keyCStrUpFirst);</span><br><span class="line">        <span class="keyword">if</span>(ountOf_Method &amp;&amp; IndexIn_OfObjectMethod &amp;&amp; (ObjectIn_AtIndexMethod || _AtIndexesMethod)) &#123;</span><br><span class="line">            <span class="comment">// 第二步, 针对NSOrderedSet, ountOf_Method、IndexIn_OfObjectMethod，以及ObjectIn_AtIndexMethod或者_AtIndexesMethod中的一个存在(实现代理集合对象)</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingOrderedSetMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingOrderedSetMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.objectAtIndex =  ObjectIn_AtIndexMethod;</span><br><span class="line">            methodSet.indexOfObject =  IndexIn_OfObjectMethod;</span><br><span class="line">            methodSet.objectsAtIndexes =  _AtIndexesMethod;</span><br><span class="line">            <span class="comment">// eg: getName:range:方法(用于增强性能)</span></span><br><span class="line">            methodSet.getObjectsRange =  <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"get%s:range:"</span>, keyCStrUpFirst);</span><br><span class="line">            <span class="comment">// NSKeyValueNonmutatingOrderedSetMethodSet就是一个拥有几个属性的简单的对象, 用于保存count、objectAtIndex等方法指针信息</span></span><br><span class="line">            <span class="comment">// 成功找到, 创建NSKeyValueCollectionGetter对象, 保存保存好的methodSet对象</span></span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueOrderedSet</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ountOf_Method &amp;&amp; (ObjectIn_AtIndexMethod || _AtIndexesMethod))&#123;</span><br><span class="line">            <span class="comment">// 第三步, 针对NSArray, ountOf_Method、以及ObjectIn_AtIndexMethod或者_AtIndexesMethod中的一个存在</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingArrayMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingArrayMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.objectAtIndex =  ObjectIn_AtIndexMethod;</span><br><span class="line">            methodSet.objectsAtIndexes =  _AtIndexesMethod;</span><br><span class="line">            methodSet.getObjectsRange =  <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"get%s:range:"</span>, keyCStrUpFirst);</span><br><span class="line">            <span class="comment">// 同样的, 成功找到, 创建NSKeyValueCollectionGetter对象,保存methodSet</span></span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueArray</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ountOf_Method &amp;&amp; enumeratorOf_Method &amp;&amp; memberOf_Method)&#123;</span><br><span class="line">            <span class="comment">// 第四步, 针对NSSet, ountOf_Method、enumeratorOf_Method以及memberOf_Method</span></span><br><span class="line">            <span class="built_in">NSKeyValueNonmutatingSetMethodSet</span> *methodSet = [[<span class="built_in">NSKeyValueNonmutatingSetMethodSet</span> alloc] init];</span><br><span class="line">            methodSet.count =  ountOf_Method;</span><br><span class="line">            methodSet.enumerator =  enumeratorOf_Method;</span><br><span class="line">            methodSet.member =  memberOf_Method;</span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueCollectionGetter</span> alloc] initWithContainerClassID:containerClassID key:key  methods:methodSet proxyClass:<span class="built_in">NSKeyValueSet</span>.self];</span><br><span class="line">            [methodSet release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">            <span class="comment">// 第五步, 如果允许直接访问实例变量, 也即accessInstanceVariablesDirectly为YES, 则直接取出实例变量</span></span><br><span class="line">            <span class="comment">// 默认顺序为_name==&gt;_isName==&gt;name==&gt;isName</span></span><br><span class="line">            Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span>((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCStr)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCStrUpFirst)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCStr)) ||</span><br><span class="line">               (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCStrUpFirst))</span><br><span class="line">               ) &#123;</span><br><span class="line">                <span class="comment">// 此时ivar有值, 创建NSKeyValueIvarGetter</span></span><br><span class="line">                <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueIvarGetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">getter</span>) &#123;</span><br><span class="line">        <span class="comment">// 最后, getter创建失败, 说明方法、实例变量查询失败, 进入下个流程</span></span><br><span class="line">        <span class="keyword">getter</span> = [<span class="keyword">self</span> _createValuePrimitiveGetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">getter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法详细地设定了查找的顺序，值得关注的是，<code>NSKeyValueMethodForPattern()</code>这个函数调用的次数相当的多。</p>
<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//最后一次查找</span></span><br><span class="line">+ (<span class="built_in">NSKeyValueGetter</span> *)_createValuePrimitiveGetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> keyCstrLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">char</span> keyCstrUpFirst[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstrUpFirst maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span>(key.length) &#123;</span><br><span class="line">        keyCstrUpFirst[<span class="number">0</span>] = toupper(keyCstrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> keyCstr[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstr maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    Method getMethod = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 同样的套路, 查找顺序: getPrimitiveName==&gt;primitiveName</span></span><br><span class="line">    <span class="keyword">if</span>((getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"getPrimitive%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">       (getMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"primitive%s"</span>, keyCstrUpFirst))</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">getter</span> =  [[<span class="built_in">NSKeyValueMethodGetter</span> alloc] initWithContainerClassID:containerClassID key:key method:getMethod];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">        Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 直接访问实例变量</span></span><br><span class="line">        <span class="comment">// 在方法二中找过一遍了, 为啥还要再找一遍?</span></span><br><span class="line">        <span class="comment">// 说明要么是根本没有找到, 要么是虽然找到了, 但是在创建NSKeyValueIvarGetter或者NSKeyValueMethodGetter的时候失败了, 最终的getter还是nil</span></span><br><span class="line">        <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCstrUpFirst))</span><br><span class="line">            ) &#123;</span><br><span class="line">            <span class="keyword">getter</span> = [[<span class="built_in">NSKeyValueIvarGetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">getter</span>) &#123;</span><br><span class="line">        <span class="keyword">getter</span> = [<span class="keyword">self</span> _createOtherValueGetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">getter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a>方法四</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转发处理给NSKeyValueUndefinedGetter对象</span></span><br><span class="line">+ (id)<span class="string">_createOtherValueGetterWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [[NSKeyValueUndefinedGetter alloc] <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">containerIsa:</span>self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法五"><a href="#方法五" class="headerlink" title="方法五"></a>方法五</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueUndefinedGetter负责调用其父类(NSKeyValueGetter)的构造方法</span></span><br><span class="line"><span class="meta">@implementation</span> NSKeyValueUndefinedGetter</span><br><span class="line">- (id)<span class="string">initWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key <span class="string">containerIsa:</span>(Class)containerIsa &#123;</span><br><span class="line">    <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    arguments[<span class="number">0</span>] = key;</span><br><span class="line">    <span class="comment">// 调用valueForUndefinedKey方法, 该方法默认实现抛出异常</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">implementation:</span>methogetImplementation(class_getInstanceMethod(containerIsa,<span class="meta">@selector</span>(<span class="string">valueForUndefinedKey:</span>))) <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">valueForUndefinedKey:</span>) <span class="string">extraArguments:</span>arguments <span class="string">count:</span><span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="方法指针怎么查找"><a href="#方法指针怎么查找" class="headerlink" title="方法指针怎么查找"></a>方法指针怎么查找</h3><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueMethodForPattern</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">NSKeyValueMethodForPattern</span><span class="params">(<span class="keyword">Class</span> <span class="keyword">class</span>, <span class="keyword">const</span> char *pattern,<span class="keyword">const</span> char *param)</span> <span class="comment">&#123;</span></span></span><br><span class="line"><span class="function"><span class="comment">    size_t paramLen = strlen(param);</span></span></span><br><span class="line"><span class="function"><span class="comment">    size_t patternLen = strlen(pattern);</span></span></span><br><span class="line"><span class="function"><span class="comment">    char selName[patternLen + paramLen * 2 + 1];</span></span></span><br><span class="line"><span class="function"><span class="comment">    snprintf(selName, (patternLen + paramLen * 2 + 1), pattern,param,param);</span></span></span><br><span class="line"><span class="function"><span class="comment">    // 依赖Runtime的class_getInstanceMethod</span></span></span><br><span class="line"><span class="function"><span class="comment">    return class_getInstanceMethod(class, sel_registerName(selName));</span></span></span><br><span class="line"><span class="function"><span class="comment">&#125;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="实例变量怎么查找"><a href="#实例变量怎么查找" class="headerlink" title="实例变量怎么查找"></a>实例变量怎么查找</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKeyValueIvarForPattern</span></span><br><span class="line"><span class="function">Ivar <span class="title">NSKeyValueIvarForPattern</span><span class="params">(Class class, <span class="keyword">const</span> <span class="keyword">char</span> *pattern,<span class="keyword">const</span> <span class="keyword">char</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> paramLen = <span class="built_in">strlen</span>(param);</span><br><span class="line">    <span class="keyword">size_t</span> patternLen = <span class="built_in">strlen</span>(pattern);</span><br><span class="line">    <span class="keyword">char</span> ivarName[paramLen + patternLen + <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(ivarName, paramLen + patternLen + <span class="number">1</span>, pattern,param);</span><br><span class="line">    <span class="comment">// 依赖Runtime的class_getInstanceVariable</span></span><br><span class="line">    <span class="keyword">return</span> class_getInstanceVariable(class, ivarName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NSKeyValueMethodGetter如何创建"><a href="#NSKeyValueMethodGetter如何创建" class="headerlink" title="NSKeyValueMethodGetter如何创建"></a>NSKeyValueMethodGetter如何创建</h3><h4 id="1-NSKeyValueMethodGetter构造方法中生成IMP"><a href="#1-NSKeyValueMethodGetter构造方法中生成IMP" class="headerlink" title="1. NSKeyValueMethodGetter构造方法中生成IMP"></a>1. NSKeyValueMethodGetter构造方法中生成IMP</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSKeyValueMethodGetter</span></span></span><br><span class="line">- (<span class="keyword">id</span>)initWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key method:(Method)method &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> methodArgumentsCount = methogetNumberOfArguments(method);</span><br><span class="line">    <span class="built_in">NSUInteger</span> extraAtgumentCount = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 默认两个参数((void (*)(id, SEL))objc_msgSend)</span></span><br><span class="line">    <span class="keyword">if</span>(methodArgumentsCount == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> *returnType = methocopyReturnType(method);</span><br><span class="line">        IMP imp = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">switch</span> (returnType[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'@'</span>: &#123;</span><br><span class="line">                <span class="comment">// 返回类型是对象时, 直接获取method的函数指针</span></span><br><span class="line">                <span class="comment">// 还是以key为"name"举例, 则方法为- (NSString *)name; 这里直接获取其IMP</span></span><br><span class="line">                imp = methogetImplementation(method);</span><br><span class="line">                extraAtgumentCount = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'B'</span>: &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 // 获取将BOOL类型转为NSNumber对象类型的函数指针</span></span><br><span class="line"><span class="comment">                 NSNumber * _NSGetBoolValueWithMethod(id object, SEL selctor, Method method) &#123;</span></span><br><span class="line"><span class="comment">                 return [[[NSNumber alloc] initWithBool: ((BOOL (*)(id,SEL))methogetImplementation(method))(object, methogetName(method))] autorelease];</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 // 比如key为"isMan", 则方法为 - (BOOL)iaMan;</span></span><br><span class="line"><span class="comment">                 // 获取的IMP便是将普通BOOL类型值转化为NSNumber类型对象的函数指针, 其他类似</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetBoolValueWithMethod;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'C'</span>: &#123;imp = (IMP)_NSGetUnsignedCharValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'I'</span>: &#123;imp = (IMP)_NSGetUnsignedIntValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Q'</span>: &#123;imp = (IMP)_NSGetUnsignedLongLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'L'</span>: &#123;imp = (IMP)_NSGetUnsignedLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>: &#123;imp = (IMP)_NSGetUnsignedShortValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'c'</span>: &#123;imp = (IMP)_NSGetCharValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'d'</span>: &#123;imp = (IMP)_NSGetDoubleValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'f'</span>: &#123;imp = (IMP)_NSGetFloatValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'i'</span>: &#123;imp = (IMP)_NSGetIntValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'l'</span>: &#123;imp = (IMP)_NSGetLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'q'</span>: &#123;imp = (IMP)_NSGetLongLongValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>: &#123;imp = (IMP)_NSGetShortValueWithMethod;&#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">                <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGPoint</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetPointValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">NSRange</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetRangeValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGRect</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetRectValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(<span class="built_in">CGSize</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">                    imp = (IMP)_NSGetSizeValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    imp = (IMP)_NSGetValueWithMethod;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        free(returnType);</span><br><span class="line">        <span class="keyword">if</span>(imp) &#123;</span><br><span class="line">            <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span>(extraAtgumentCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                arguments[<span class="number">0</span>] = method;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将class key selector imp method 参数 参数数量等信息交给父类处理</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">super</span> initWithContainerClassID:containerClassID key:key implementation:imp selector:methogetName(method) extraArguments:arguments count:extraAtgumentCount];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span> release];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> release];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>由于KVC返回的类型为对象<code>(NSObject)</code>，所以需要对方法返回值类型分别进行判断从而为<code>Getter</code>赋值不同的函数指针。也即从<code>BOOL、double、int、CGSize</code>等普通类型转化为<code>NSNumber、NSValue、id</code>等对象类型的函数(指针)。</p>
<h4 id="2-在父类NSKeyValueAccessor中-对class-key-selector-imp-method-参数-参数数量等信息进行保存"><a href="#2-在父类NSKeyValueAccessor中-对class-key-selector-imp-method-参数-参数数量等信息进行保存" class="headerlink" title="2. 在父类NSKeyValueAccessor中, 对class key selector imp method 参数 参数数量等信息进行保存"></a>2. 在父类<code>NSKeyValueAccessor</code>中, 对<code>class key selector imp method</code> 参数 参数数量等信息进行保存</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">@implementation NSKeyValueAccessor</span><br><span class="line">- (id)initWithContainerClassID:(id)containerClassID key:(NSString *)key implementation:(IMP)implementation selector:(SEL)selector extraArguments:(void *[<span class="number">3</span>])extraArguments <span class="built_in">count</span>:(NSUInteger)<span class="built_in">count</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (self = [super init]) &#123;</span><br><span class="line">        <span class="variable">_containerClassID</span> = containerClassID;</span><br><span class="line">        <span class="variable">_key</span> = key.copy;</span><br><span class="line">        <span class="variable">_implementation</span> = implementation;</span><br><span class="line">        <span class="variable">_selector</span> = selector;</span><br><span class="line">        </span><br><span class="line">        NSUInteger hash = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (key) &#123;</span><br><span class="line">            hash = CFHash(key);</span><br><span class="line">        &#125;</span><br><span class="line">        hash ^= (NSUInteger)containerClassID;</span><br><span class="line">        <span class="variable">_hashValue</span> = hash;</span><br><span class="line">        <span class="variable">_extraArgumentCount</span> = <span class="built_in">count</span>;</span><br><span class="line">        <span class="variable">_extraArgument1</span> = extraArguments[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_extraArgument1</span> == key) &#123;</span><br><span class="line">            <span class="variable">_extraArgument1</span> = <span class="variable">_key</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">_extraArgument2</span> = extraArguments[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_extraArgument2</span> == key) &#123;</span><br><span class="line">            <span class="variable">_extraArgument2</span> = <span class="variable">_key</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">_extraArgument3</span> = extraArguments[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h3 id="NSKeyValueIvarGetter如何创建"><a href="#NSKeyValueIvarGetter如何创建" class="headerlink" title="NSKeyValueIvarGetter如何创建"></a>NSKeyValueIvarGetter如何创建</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key containerIsa:(Class)containerIsa ivar:(Ivar)ivar &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ivarEncoding = ivar_getTypeEncoding(ivar);</span><br><span class="line">    IMP imp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (ivarEncoding[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'@'</span>: &#123;</span><br><span class="line">            objc_ivar_memory_management_t mngment = objc_ivar_memoryUnknown;<span class="comment">//_class_getIvarMemoryManagement(containerIsa, ivar);</span></span><br><span class="line">            <span class="keyword">if</span>(mngment &lt; objc_ivar_memoryWeak) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 id _NSGetObjectGetAssignValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">                 return *(id *)object_getIvarAddress(object, ivar);</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetObjectGetAssignValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mngment == objc_ivar_memoryWeak) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 id _NSGetObjectGetWeakValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">                 return objc_loadWeak((id *)object_getIvarAddress(object, ivar));</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                imp = (IMP)_NSGetObjectGetWeakValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mngment == objc_ivar_memoryUnretained) &#123;</span><br><span class="line">                imp = (IMP)_NSGetObjectGetAssignValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                imp = (IMP)_NSGetObjectGetIvarValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'C'</span>: &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             NSNumber * _NSGetUnsignedCharValueInIvar(id object, SEL selector, Ivar ivar) &#123;</span></span><br><span class="line"><span class="comment">             unsigned char value = *(unsigned char *)object_getIvarAddress(object, ivar);</span></span><br><span class="line"><span class="comment">             return [[[NSNumber alloc] initWithUnsignedChar:value] autorelease];</span></span><br><span class="line"><span class="comment">             &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            imp = (IMP)_NSGetUnsignedCharValueInIvar;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'B'</span>: &#123;imp = (IMP)_NSGetBoolValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'I'</span>: &#123;imp = (IMP)_NSGetUnsignedIntValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'L'</span>: &#123;imp = (IMP)_NSGetUnsignedLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'Q'</span>: &#123;imp = (IMP)_NSGetUnsignedLongLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'S'</span>: &#123;imp = (IMP)_NSGetUnsignedShortValueInIvar;&#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">            <span class="keyword">char</span>* idx = index(ivarEncoding, <span class="string">'='</span>);</span><br><span class="line">            <span class="keyword">if</span> (idx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                imp = (IMP)_NSGetValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGPoint</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetPointValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">NSRange</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetRangeValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGRect</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetRectValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(ivarEncoding, <span class="keyword">@encode</span>(<span class="built_in">CGSize</span>), idx - ivarEncoding) == <span class="number">0</span>)&#123;</span><br><span class="line">                imp = (IMP)_NSGetSizeValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                imp = (IMP)_NSGetValueInIvar;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'c'</span>: &#123;imp = (IMP)_NSGetCharValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'d'</span>: &#123;imp = (IMP)_NSGetDoubleValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'f'</span>: &#123;imp = (IMP)_NSGetFloatValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'i'</span>: &#123;imp = (IMP)_NSGetIntValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'l'</span>: &#123;imp = (IMP)_NSGetLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'q'</span>: &#123;imp = (IMP)_NSGetLongLongValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'s'</span>: &#123;imp = (IMP)_NSGetShortValueInIvar;&#125;<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(imp) &#123;</span><br><span class="line">        <span class="keyword">void</span> *arguments[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        arguments[<span class="number">0</span>] = ivar;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> initWithContainerClassID:containerClassID key:key implementation:imp selector:<span class="literal">NULL</span> extraArguments:arguments count:<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> release];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样地，判断实例变量的类型编码，进而赋值不同的IMP。</p>
<h3 id="怎么根据Getter取值"><a href="#怎么根据Getter取值" class="headerlink" title="怎么根据Getter取值"></a>怎么根据Getter取值</h3><h4 id="1-线程校验"><a href="#1-线程校验" class="headerlink" title="1. 线程校验"></a>1. 线程校验</h4><figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">void NSKeyValueObservingAssertRegistrationLockNotHeld() &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">_NSKeyValueObserverRegistrationEnableLockingAssertions</span> &amp;&amp; <span class="variable">_NSKeyValueObserverRegistrationLockOwner</span> == pthreaself()) &#123;</span><br><span class="line">        <span class="built_in">assert</span>(pthreaself() != <span class="variable">_NSKeyValueObserverRegistrationLockOwner</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-直接调用Getter中存储的方法实现-getter-implementation"><a href="#2-直接调用Getter中存储的方法实现-getter-implementation" class="headerlink" title="2. 直接调用Getter中存储的方法实现(getter.implementation)"></a>2. 直接调用Getter中存储的方法实现(getter.implementation)</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> _NSGetUsingKeyValueGetter(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueGetter</span> *<span class="keyword">getter</span>) &#123;</span><br><span class="line">    <span class="comment">// 线程判断</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingAssertRegistrationLockNotHeld</span>();</span><br><span class="line">    <span class="comment">// 根据其他参数数量extraArgumentCount分别进行函数调用</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">getter</span>.extraArgumentCount) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1, <span class="keyword">getter</span>.extraArgument2);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">void</span>*,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">getter</span>.implementation )(object,<span class="keyword">getter</span>.selector, <span class="keyword">getter</span>.extraArgument1, <span class="keyword">getter</span>.extraArgument2, <span class="keyword">getter</span>.extraArgument3);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="valueForKeyPath"><a href="#valueForKeyPath" class="headerlink" title="valueForKeyPath:"></a>valueForKeyPath:</h2><p>假定这里的keyPath为<code>@&quot;key1.key2.key3.key4&quot;</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span>(keyPath) &#123;</span><br><span class="line">        <span class="comment">// 字符串编码判断</span></span><br><span class="line">        <span class="built_in">CFStringEncoding</span> encoding = __CFDefaultEightBitStringEncoding;</span><br><span class="line">        <span class="keyword">if</span>(encoding == kCFStringEncodingInvalidId) &#123;</span><br><span class="line">            <span class="comment">// 编码无效 kCFStringEncodingInvalidId就是 (0xffffffffU)</span></span><br><span class="line">            encoding = __CFStringComputeEightBitStringEncoding();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建C字符串: "key1.key2.key3.key4"</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cStr = <span class="built_in">CFStringGetCStringPtr</span>((<span class="built_in">CFStringRef</span>)keyPath, encoding);</span><br><span class="line">        <span class="keyword">if</span>(cStr) &#123;</span><br><span class="line">            <span class="comment">// memchr函数:从头开始搜寻s 所指的内存内容前n 个字节，直到发现第一个值为c 的字节，则返回指向该字节的指针</span></span><br><span class="line">            <span class="comment">// 所以最后获取到包含'点符号'的后部分 即firstDotPointers为 ".key2.key3.key4"</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *firstDotPointer = memchr(cStr, <span class="string">'.'</span>, keyPath.length);</span><br><span class="line">            <span class="keyword">if</span>(firstDotPointer) &#123;</span><br><span class="line">                <span class="comment">// 这里的subKey是 "key1"</span></span><br><span class="line">                <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, firstDotPointer - cStr)] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="comment">// 这里的subKeyPathLeft是 "key2.key3.key4"</span></span><br><span class="line">                <span class="built_in">NSString</span> *subKeyPathLeft =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(firstDotPointer - cStr + <span class="number">1</span>, keyPath.length -  (firstDotPointer - cStr + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="comment">// 先获取到subKey的结果, 然后用它的结果再求subKeyPathLeft, 进入递归中</span></span><br><span class="line">                <span class="keyword">id</span> value = [[<span class="keyword">self</span> valueForKey:subKey] valueForKeyPath:subKeyPathLeft];</span><br><span class="line">                [subKey release];</span><br><span class="line">                [subKeyPathLeft release];</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// firstDotPointer不存在, 说明keyPath中没有'点符号', 则直接调用valueForKey</span></span><br><span class="line">                <span class="keyword">return</span> [<span class="keyword">self</span> valueForKey:keyPath];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 走到这里, 上面代码没有return, 说明keyPath为nil或者cStr为nil</span></span><br><span class="line">    <span class="built_in">NSRange</span> range = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">    <span class="keyword">if</span>(range.length) &#123;</span><br><span class="line">        <span class="comment">// range.length不为0, 也即keyPath中有'点符号'</span></span><br><span class="line">        <span class="comment">// subKey为"key1"</span></span><br><span class="line">        <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, range.location)] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="comment">// subKeyPathLeft为"key2.key3.key4"</span></span><br><span class="line">        <span class="built_in">NSString</span> *subKeyPathLeft =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(range.location + <span class="number">1</span>, keyPath.length -  (range.location + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="comment">// 同样的, 先获取到subKey的结果, 然后用它的结果再求subKeyPathLeft, 进入递归中</span></span><br><span class="line">        <span class="keyword">id</span> value = [[<span class="keyword">self</span> valueForKey:subKey] valueForKeyPath:subKeyPathLeft];</span><br><span class="line">        [subKey release];</span><br><span class="line">        [subKeyPathLeft release];</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// keyPath为nil或者keyPath中没有'点符号', 直接调用valueForKey</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> valueForKey:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就有一个问题了，相似的把keyPath拆分逻辑的逻辑为啥要写两个，一个转为C字符串拆分，一个直接拆分?  揣测两者的区别主要是对字符串编码的判断。</p>
<h1 id="三、设值"><a href="#三、设值" class="headerlink" title="三、设值"></a>三、设值</h1><p>设值的流程就比较简单了。</p>
<blockquote>
<p>The default implementation of this method does the following:</p>
<ol>
<li><p>Searches the class of the receiver for an accessor method whose name matches the pattern <code>-set&lt;Key&gt;:</code>. If such a method is found the type of its parameter is checked. If the parameter type is not an object pointer type but the value is nil <code>-setNilValueForKey:</code> is invoked. The default implementation of <code>-setNilValueForKey:</code> raises an NSInvalidArgumentException, but you can override it in your application. Otherwise, if the type of the method’s parameter is an object pointer type the method is simply invoked with the value as the argument. If the type of the method’s parameter is some other type the inverse of the NSNumber/NSValue conversion done by <code>-valueForKey:</code> is performed before the method is invoked.</p>
</li>
<li><p>Otherwise (no accessor method is found), if the receiver’s class’ <code>+accessInstanceVariablesDirectly</code> property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern <code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;</code>, in that order. If such an instance variable is found and its type is an object pointer type the value is retained and the result is set in the instance variable, after the instance variable’s old value is first released. If the instance variable’s type is some other type its value is set after the same sort of conversion from NSNumber or NSValue as in step 1.</p>
</li>
<li><p>Otherwise (no accessor method or instance variable is found), invokes <code>-setValue:forUndefinedKey:</code>. The default implementation of <code>-setValue:forUndefinedKey:</code> raises an NSUndefinedKeyException, but you can override it in your application.</p>
</li>
</ol>
<p>Compatibility notes:</p>
<ul>
<li>For backward binary compatibility with <code>-takeValue:forKey:</code>‘s behavior, a method whose name matches the pattern <code>-_set&lt;Key&gt;:</code> is also recognized in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</li>
<li>For backward binary compatibility, -unableToSetNilForKey: will be invoked instead of <code>-setNilValueForKey:</code> in step 1, if the implementation of <code>-unableToSetNilForKey:</code> in the receiver’s class is not NSObject’s.</li>
<li>The behavior described in step 2 is different from <code>-takeValue:forKey:</code>‘s, in which the instance variable search order is <code>&lt;key&gt;, _&lt;key&gt;</code>.</li>
<li>For backward binary compatibility with <code>-takeValue:forKey:</code>‘s behavior, <code>-handleTakeValue:forUnboundKey:</code> will be invoked instead of <code>-setValue:forUndefinedKey:</code> in step 3, if the implementation of <code>-handleTakeValue:forUnboundKey:</code> in the receiver’s class is not NSObject’s.</li>
</ul>
</blockquote>
<p>翻译如下：<br>这个方法的默认实现是这样的：</p>
<ol>
<li>搜索该类名称为<code>-set&lt;Key&gt;:</code>的存取器方法，如果找到，检查其参数类型。如果参数为<code>nil</code>，<code>-setNilValueForKey:</code>方法将会被调用。这个方法的默认实现是抛出<code>NSInvalidArgumentException</code>异常，不过你可以重写该方法自行实现。如果参数类型为对象类型，该存取器方法会被直接调用，这个参数也会被直接使用。如果参数能被转化为<code>NSNumber/NSValue</code>类型，参数会在存取器方法被调用之前进行转换。</li>
<li>如果存取器方法没有被找到，倘若此时消息接收者的<code>+accessInstanceVariablesDirectly</code>属性返回的是<code>YES</code>，那么按照<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;</code>的顺序搜索该类的实例变量。如果找到这个实例变量，当其为对象类型时，该实例变量会在旧值释放之后被设置新值。当其为其他类型时，那么按照步骤1中的类型转换规则设置这个实例变量的值。</li>
<li>如果存取器方法和实例变量都没有被找到，<code>-setValue:forUndefinedKey:</code>方法将会被调用。这个方法的默认实现是抛出<code>NSUndefinedKeyException</code>异常，不过你可以重写该方法自行实现。</li>
</ol>
<p>兼容性：</p>
<ul>
<li>为了向后兼容<code>-takeValue:forKey:</code>，名称为<code>-_set&lt;Key&gt;:</code>的方法也会在步骤1中被查找。</li>
<li>如果<code>-unableToSetNilForKey:</code>的实现不是<code>NSObject</code>的默认实现（换句话说，自己手动实现了<code>-unableToSetNilForKey:</code>方法），那在步骤1中，<code>-unableToSetNilForKey:</code>方法将会代替<code>-setNilValueForKey:</code>方法被调用。</li>
<li>对于<code>-takeValue:forKey:</code>，其实例变量的查找顺序不同于步骤2所描述的，调用它时，实例变量查找顺序是<code>&lt;key&gt;, _&lt;key&gt;</code>。</li>
<li>为了向后兼容<code>-takeValue:forKey:</code>，如果<code>-handleTakeValue:forUnboundKey:</code>的实现不是<code>NSObject</code>的默认实现（换句话说，自己手动实现了<code>-handleTakeValue:forUnboundKey:</code>方法），那在步骤3中，<code>-handleTakeValue:forUnboundKey:</code>方法将会代替<code>-setValue:forUndefinedKey:</code>方法被调用。</li>
</ul>
<p>流程图如下：<br><img src="https://image.chenyalun.com/2019/05/05/002.png" alt></p>
<h2 id="setValue"><a href="#setValue" class="headerlink" title="setValue:"></a>setValue:</h2><h3 id="方法一-1"><a href="#方法一-1" class="headerlink" title="方法一"></a>方法一</h3><p>这里使用<code>NSKeyValueCachedSetters</code>缓存<code>setter</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 假定key为@"name"</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        OSSpinLockLock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NSKeyValueCachedSetters</span>) &#123;</span><br><span class="line">            <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            callbacks.version = kCFTypeSetCallBacks.version;</span><br><span class="line">            callbacks.retain = kCFTypeSetCallBacks.retain;</span><br><span class="line">            callbacks.release = kCFTypeSetCallBacks.release;</span><br><span class="line">            callbacks.copyDescription = kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">            callbacks.equal = (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValueAccessorIsEqual</span>;</span><br><span class="line">            callbacks.hash = (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValueAccessorHash</span>;</span><br><span class="line">            <span class="built_in">NSKeyValueCachedSetters</span> = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>,<span class="number">0</span>,&amp;callbacks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSKeyValueSetter</span> *finder = [<span class="built_in">NSKeyValueSetter</span> new];</span><br><span class="line">        finder.containerClassID = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        finder.key = key;</span><br><span class="line">        finder.hashValue = <span class="built_in">CFHash</span>((<span class="built_in">CFTypeRef</span>)key) ^ (<span class="built_in">NSUInteger</span>)(object_getClass(<span class="keyword">self</span>));</span><br><span class="line">        <span class="comment">// 缓存中取Setter</span></span><br><span class="line">        <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> =  <span class="built_in">CFSetGetValue</span>(<span class="built_in">NSKeyValueCachedSetters</span>, (<span class="keyword">void</span> *)finder);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">setter</span>) &#123;</span><br><span class="line">            <span class="keyword">setter</span> = [object_getClass(<span class="keyword">self</span>) _createValueSetterWithContainerClassID:object_getClass(<span class="keyword">self</span>) key:key];</span><br><span class="line">            <span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueCachedSetters</span>, (<span class="keyword">void</span>*)<span class="keyword">setter</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        OSSpinLockUnlock(&amp;<span class="built_in">NSKeyValueCachedAccessorSpinLock</span>);</span><br><span class="line">        <span class="comment">// 设值</span></span><br><span class="line">        _NSSetUsingKeyValueSetter(<span class="keyword">self</span>,<span class="keyword">setter</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"%@: attempt to set a value for a nil key"</span>,_NSMethodExceptionProem(<span class="keyword">self</span>,_cmd)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法二-1"><a href="#方法二-1" class="headerlink" title="方法二"></a>方法二</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSKeyValueSetter</span> *)_createValueSetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> key_cstr_len = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// 首字符大写的key</span></span><br><span class="line">    <span class="keyword">char</span> key_cstr_upfirst[key_cstr_len + <span class="number">1</span>];</span><br><span class="line">    [key getCString:key_cstr_upfirst maxLength:key_cstr_len + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span> (key.length) &#123;</span><br><span class="line">        key_cstr_upfirst[<span class="number">0</span>] = toupper(key_cstr_upfirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 原来的key</span></span><br><span class="line">    <span class="keyword">char</span> key_cstr[key_cstr_len + <span class="number">1</span>];</span><br><span class="line">    [key getCString:key_cstr maxLength:key_cstr_len + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    Method method = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 查找方法顺序, 假定key为@"name"</span></span><br><span class="line">    <span class="comment">// setName: ==&gt; _setName: ==&gt; setIsName:</span></span><br><span class="line">    <span class="keyword">if</span> ((method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"set%s:"</span>, key_cstr_upfirst)) ||</span><br><span class="line">        (method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"_set%s:"</span>, key_cstr_upfirst)) ||</span><br><span class="line">        (method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>, <span class="string">"setIs%s:"</span>, key_cstr_upfirst))</span><br><span class="line">        ) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueMethodSetter</span> alloc] initWithContainerClassID:containerClassID key:key method:method];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">        Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 允许直接访问实例变量, 查找顺序为: _name ==&gt; _isName ==&gt; name ==&gt; isName</span></span><br><span class="line">        <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, key_cstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, key_cstr_upfirst)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, key_cstr)) ||</span><br><span class="line">            (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, key_cstr_upfirst))</span><br><span class="line">            ) &#123;</span><br><span class="line">            <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueIvarSetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">setter</span>) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [<span class="keyword">self</span> _createValuePrimitiveSetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">setter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法三-1"><a href="#方法三-1" class="headerlink" title="方法三"></a>方法三</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSKeyValueSetter</span> *)_createValuePrimitiveSetterWithContainerClassID:(<span class="keyword">id</span>)containerClassID key:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> keyCstrLen = [key lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">char</span> keyCstrUpFirst[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    [key getCString:keyCstrUpFirst maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(key.length) &#123;</span><br><span class="line">        keyCstrUpFirst[<span class="number">0</span>] = toupper(keyCstrUpFirst[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> keyCstr[keyCstrLen + <span class="number">1</span>];</span><br><span class="line">    [key getCString:keyCstr maxLength:keyCstrLen + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="comment">// 假定key为@"name", 查询 setPrimitiveName:方法</span></span><br><span class="line">    Method method = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>,<span class="string">"setPrimitive%s:"</span>,keyCstrUpFirst);</span><br><span class="line">    <span class="keyword">if</span>(method) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueMethodSetter</span> alloc] initWithContainerClassID:containerClassID key:key method:method];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>([<span class="keyword">self</span> accessInstanceVariablesDirectly]) &#123;</span><br><span class="line">            Ivar ivar = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_%s"</span>, keyCstr)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"_is%s"</span>, keyCstrUpFirst)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"%s"</span>, keyCstr)) ||</span><br><span class="line">                (ivar = <span class="built_in">NSKeyValueIvarForPattern</span>(<span class="keyword">self</span>, <span class="string">"is%s"</span>, keyCstrUpFirst))</span><br><span class="line">                ) &#123;</span><br><span class="line">                <span class="keyword">setter</span> = [[<span class="built_in">NSKeyValueIvarSetter</span> alloc] initWithContainerClassID:containerClassID key:key containerIsa:<span class="keyword">self</span> ivar:ivar];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">setter</span>) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [<span class="keyword">self</span> _createOtherValueSetterWithContainerClassID:containerClassID key:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">setter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法四-1"><a href="#方法四-1" class="headerlink" title="方法四"></a>方法四</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">+ (NSKeyValueSetter *)<span class="string">_createOtherValueSetterWithContainerClassID:</span>(id)containerClassID <span class="string">key:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [[NSKeyValueUndefinedSetter alloc] <span class="string">initWithContainerClassID:</span>containerClassID <span class="string">key:</span>key <span class="string">containerIsa:</span>self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="怎么根据Setter设值"><a href="#怎么根据Setter设值" class="headerlink" title="怎么根据Setter设值"></a>怎么根据Setter设值</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSSetUsingKeyValueSetter(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueSetter</span> *<span class="keyword">setter</span>, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">setter</span>.extraArgumentCount) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector,value);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1, <span class="keyword">setter</span>.extraArgument2);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">            ( (<span class="keyword">id</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="keyword">void</span>*,<span class="keyword">void</span>*,<span class="keyword">void</span>*))<span class="keyword">setter</span>.implementation )(object,<span class="keyword">setter</span>.selector, value, <span class="keyword">setter</span>.extraArgument1, <span class="keyword">setter</span>.extraArgument2, <span class="keyword">setter</span>.extraArgument3);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接调用Setter中存储的方法实现(getter.implementation)。</p>
<h2 id="setValue-forKeyPath"><a href="#setValue-forKeyPath" class="headerlink" title="setValue:forKeyPath:"></a>setValue:forKeyPath:</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span>(keyPath) &#123;</span><br><span class="line">        <span class="built_in">CFStringEncoding</span> encoding = __CFDefaultEightBitStringEncoding;</span><br><span class="line">        <span class="keyword">if</span>(encoding == kCFStringEncodingInvalidId) &#123;</span><br><span class="line">            encoding = __CFStringComputeEightBitStringEncoding();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *keyPathCStr = <span class="built_in">CFStringGetCStringPtr</span>((<span class="built_in">CFStringRef</span>)keyPath, encoding);</span><br><span class="line">        <span class="keyword">if</span>(keyPathCStr) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *firstDotPointer = memchr(keyPathCStr, <span class="string">'.'</span>, keyPath.length);</span><br><span class="line">            <span class="keyword">if</span>(firstDotPointer) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, firstDotPointer - keyPathCStr)] <span class="keyword">retain</span>];</span><br><span class="line">                <span class="built_in">NSString</span> *subKeyPathAfterDot =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(firstDotPointer - keyPathCStr + <span class="number">1</span>, keyPath.length -  (firstDotPointer - keyPathCStr + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">                </span><br><span class="line">                [[<span class="keyword">self</span> valueForKey:subKey] setValue:value forKeyPath:subKeyPathAfterDot];</span><br><span class="line">                </span><br><span class="line">                [subKey release];</span><br><span class="line">                [subKeyPathAfterDot release];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span> setValue:value forKey:keyPath];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSRange</span> dotRange = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">    <span class="keyword">if</span>(dotRange.length) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *subKey =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, dotRange.location)] <span class="keyword">retain</span>];</span><br><span class="line">        <span class="built_in">NSString</span> *subKeyPathAfterDot =  [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(dotRange.location + <span class="number">1</span>, keyPath.length -  (dotRange.location + <span class="number">1</span>))] <span class="keyword">retain</span>];</span><br><span class="line">        </span><br><span class="line">        [[<span class="keyword">self</span> valueForKey:subKey] setValue:value forKeyPath:subKeyPathAfterDot];</span><br><span class="line">        </span><br><span class="line">        [subKey release];</span><br><span class="line">        [subKeyPathAfterDot release];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">         [<span class="keyword">self</span> setValue:value forKey:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本是与取值类似的逻辑。</p>
<h1 id="四、集合对象的KVC"><a href="#四、集合对象的KVC" class="headerlink" title="四、集合对象的KVC"></a>四、集合对象的KVC</h1><h2 id="NSArray的KVC"><a href="#NSArray的KVC" class="headerlink" title="NSArray的KVC"></a>NSArray的KVC</h2><h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line"><span class="comment">// 返回Array内每个对象的“key”对应值组成的数组</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">// 如果keyPath中包含集合运算符, 则返回运算结果, 否则返回Array内每个对象的“keyPath”对应值组成的数组</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="comment">// 设置Array里每个对象的key对应值为value</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *operationKey = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 集合运算符:如@count, @firstObject, @lastObject等</span></span><br><span class="line">    <span class="keyword">if</span> (key.length &amp;&amp; [key characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span> &amp;&amp; (operationKey = [key substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, key.length - <span class="number">1</span>)])) &#123;</span><br><span class="line">        <span class="comment">// 去掉'@'便是operationKey</span></span><br><span class="line">        <span class="keyword">id</span> value =  [<span class="keyword">super</span> valueForKey:operationKey];</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建与自身相等数量的array</span></span><br><span class="line">        <span class="keyword">id</span> *objectsBuff = <span class="built_in">NSAllocateObjectArray</span>(<span class="keyword">self</span>.count);</span><br><span class="line">        <span class="comment">// 现在, 指针p与指针objectsBuff指向一致</span></span><br><span class="line">        <span class="keyword">id</span> *p = objectsBuff;</span><br><span class="line">        <span class="comment">// 遍历自身</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="comment">// 取出容器中的元素对应的value</span></span><br><span class="line">            <span class="keyword">id</span> eachValue = [object valueForKey:key];</span><br><span class="line">            <span class="comment">// 如果eachValue不存在, 则p的next指针指向的对象设置成 NSNull实例对象</span></span><br><span class="line">            <span class="comment">// 如果eachValue有值, 则p的next指针指向的对象设置为eachValue</span></span><br><span class="line">            *(p++) = (eachValue ? : [<span class="built_in">NSNull</span> null]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据objectsBuff创建一个数组, 这个objectsBuff就是'eachValue'的集合</span></span><br><span class="line">        <span class="comment">// 也即假定key为@"name", 遍历容器中所有元素, 取出每个元素key为@"name"对应的值, 这些值的集合就是数组arrayValue</span></span><br><span class="line">        <span class="built_in">NSArray</span> *arrayValue = [[[<span class="built_in">NSArray</span> alloc] initWithObjects:objectsBuff count:<span class="keyword">self</span>.count] autorelease];</span><br><span class="line">        <span class="comment">// 释放objectsBuff</span></span><br><span class="line">        <span class="built_in">NSFreeObjectArray</span>(objectsBuff);</span><br><span class="line">        <span class="keyword">return</span> arrayValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="comment">// 集合运算符: 如@count, @firstObject, @"@unionOfObjects.friend.name"等</span></span><br><span class="line">    <span class="comment">// 这里以 @"@unionOfObjects.friend"为例</span></span><br><span class="line">    <span class="keyword">if</span>(keyPath.length &amp;&amp; [keyPath characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span>) &#123;</span><br><span class="line">        <span class="comment">// 说明keyPath中有'@符号', 且'@符号'在第0个位置处</span></span><br><span class="line">        <span class="built_in">NSRange</span> dotRange = [keyPath rangeOfString:<span class="string">@"."</span> options:<span class="built_in">NSLiteralSearch</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, keyPath.length)];</span><br><span class="line">        <span class="keyword">if</span>(dotRange.length) &#123;</span><br><span class="line">            <span class="comment">// dotRange.length不为0, 说明keyPath中有'@符号', 而且还有'点符号'</span></span><br><span class="line">            <span class="comment">// 取出包含运算符的那部分,如 @"unionOfObjects"</span></span><br><span class="line">            <span class="built_in">NSString</span> *operator = [keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, dotRange.location)];</span><br><span class="line">            <span class="comment">// 取出除运算符之外的那部分,如 @"friend"</span></span><br><span class="line">            <span class="built_in">NSString</span> *keyPathForOperator = [keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(dotRange.location + <span class="number">1</span>, keyPath.length - (dotRange.location + <span class="number">1</span>))];</span><br><span class="line">            <span class="keyword">if</span>(keyPathForOperator) &#123;</span><br><span class="line">                <span class="comment">// 说明含运算符的那部分如 @"unionOfObjects" 和除运算符之外的那部分如 @"friend" 都存在</span></span><br><span class="line">                <span class="built_in">NSUInteger</span> operatorCStrLength = [operator lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                <span class="keyword">char</span> operatorCStr[operatorCStrLength + <span class="number">1</span>];</span><br><span class="line">                <span class="comment">// 转为C字符串operatorCStr, 也即 @"unionOfObjects" 转为 "unionOfObjects"</span></span><br><span class="line">                [operator getCString:operatorCStr maxLength:operatorCStrLength + <span class="number">1</span> encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                <span class="comment">// 查找方法, 即: "unionOfObjectsForKeyPath:"</span></span><br><span class="line">                Method operatorMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>.class, <span class="string">"%sForKeyPath:"</span>, operatorCStr);</span><br><span class="line">                <span class="keyword">if</span>(!operatorMethod) &#123;</span><br><span class="line">                    <span class="comment">// 上面的方法没找到, 就查找带下划线的那个: "_unionOfObjectsForKeyPath:"</span></span><br><span class="line">                    operatorMethod = <span class="built_in">NSKeyValueMethodForPattern</span>(<span class="keyword">self</span>.class, <span class="string">"_%sForKeyPath:"</span>, operatorCStr);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (operatorMethod) &#123;</span><br><span class="line">                    <span class="comment">// 查找成功, 调用运算符对应的方法</span></span><br><span class="line">                    <span class="keyword">id</span> value = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>,Method,<span class="built_in">NSString</span> *))methoinvoke)(<span class="keyword">self</span>,operatorMethod,keyPathForOperator);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 没有找到, 说明是不支持的运算符</span></span><br><span class="line">                    [<span class="built_in">NSException</span> raise:<span class="built_in">NSInvalidArgumentException</span> format:<span class="string">@"[&lt;%@ %p&gt; valueForKeyPath:]: this class does not implement the %@ operation."</span>, <span class="keyword">self</span>.class,<span class="keyword">self</span>,operator];</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 说明只有包含运算符的那部分如 @"friend", 走NSObject的valueForKey逻辑</span></span><br><span class="line">                <span class="keyword">id</span> value = [<span class="keyword">super</span> valueForKey:operator];</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// keyPath中有'@符号', 但是没有'点符号', 取出除'@符号'之外的key</span></span><br><span class="line">            <span class="built_in">NSString</span> *key = [[keyPath substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, keyPath.length - <span class="number">1</span>)] <span class="keyword">retain</span>];</span><br><span class="line">            <span class="comment">// 走NSObject的valueForKey逻辑</span></span><br><span class="line">            <span class="keyword">id</span> value = [<span class="keyword">super</span> valueForKey:key];</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有'@符号',可能有'点符号', 走NSObject的valueForKeyPath逻辑</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> valueForKeyPath: keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// 对容器内的每一个元素都设值</span></span><br><span class="line">        [object setValue:value forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求和"><a href="#求和" class="headerlink" title="求和"></a>求和</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// @sum.keyPath, 例如 @"@sum.price", 传递到这个方法中, 参数keyPath为@"price"</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_sumForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSDecimal</span> resultDecimal = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">NSDecimalNumber</span> *zero = [<span class="built_in">NSDecimalNumber</span> zero];</span><br><span class="line">    <span class="keyword">if</span> (zero) resultDecimal = [zero decimalValue];</span><br><span class="line">    <span class="comment">// 这里使用NSDecimalNumber 保证精确度</span></span><br><span class="line">    <span class="built_in">NSDecimal</span> eachDecimal = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="comment">// 获取每个对象的keyPath(如@"price")对应值</span></span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            eachDecimal = [eachValue decimalValue];</span><br><span class="line">            <span class="comment">// 累加</span></span><br><span class="line">            <span class="built_in">NSDecimalAdd</span>(&amp;resultDecimal, &amp;resultDecimal, &amp;eachDecimal, <span class="built_in">NSRoundBankers</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDecimalNumber</span> decimalNumberWithDecimal:resultDecimal];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求平均值"><a href="#求平均值" class="headerlink" title="求平均值"></a>求平均值</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 对 Array中每个对象的keyPath对应值 求平均值</span></span><br><span class="line"><span class="comment">// @avg.keyPath</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_avgForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.count) &#123;</span><br><span class="line">        <span class="comment">//总和 / 对象数</span></span><br><span class="line">        <span class="keyword">return</span> [(<span class="built_in">NSDecimalNumber</span>*)[<span class="keyword">self</span> _sumForKeyPath:keyPath]  decimalNumberByDividingBy:(<span class="built_in">NSDecimalNumber</span>*)[<span class="built_in">NSDecimalNumber</span> numberWithUnsignedInteger:<span class="keyword">self</span>.count]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求数量"><a href="#求数量" class="headerlink" title="求数量"></a>求数量</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取对象数目</span></span><br><span class="line"><span class="comment">// @count</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)_countForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithInteger:<span class="keyword">self</span>.count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求最大值"><a href="#求最大值" class="headerlink" title="求最大值"></a>求最大值</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 对 Array中每个对象的keyPath对应值 求最大值</span></span><br><span class="line"><span class="comment">// @max.keyPath</span></span><br><span class="line">- (<span class="keyword">id</span>)_maxForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">id</span> maxValue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!maxValue) &#123;</span><br><span class="line">                maxValue = eachValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([maxValue compare:eachValue] == <span class="built_in">NSOrderedAscending</span>)&#123;</span><br><span class="line">                maxValue = eachValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maxValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求最小值"><a href="#求最小值" class="headerlink" title="求最小值"></a>求最小值</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 对 Array中每个对象的keyPath对应值 求最小值</span></span><br><span class="line"><span class="comment">// @min.keyPath</span></span><br><span class="line">- (<span class="keyword">id</span>)_minForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">id</span> minValue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!minValue) &#123;</span><br><span class="line">                minValue = eachValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([minValue compare:eachValue] == <span class="built_in">NSOrderedDescending</span>)&#123;</span><br><span class="line">                minValue = eachValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取数组"><a href="#获取数组" class="headerlink" title="获取数组"></a>获取数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应值 组成数组</span></span><br><span class="line"><span class="comment">// @unionOfObjects.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfObjectsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObject:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取去重数组"><a href="#获取去重数组" class="headerlink" title="获取去重数组"></a>获取去重数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应值 组成去重数组</span></span><br><span class="line"><span class="comment">// @distinctUnionOfObjects.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfObjectsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *unionArray = [<span class="keyword">self</span> _unionOfObjectsForKeyPath:keyPath];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithArray:unionArray].allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取成员数组"><a href="#获取成员数组" class="headerlink" title="获取成员数组"></a>获取成员数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应数组的每个成员 组成数组 这里每个keyPath对应值是也是数组，获取的是每个数组展开后组成的总数组</span></span><br><span class="line"><span class="comment">// @unionOfArrays.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfArraysForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObjectsFromArray:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取去重的成员数组"><a href="#获取去重的成员数组" class="headerlink" title="获取去重的成员数组"></a>获取去重的成员数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应数组的每个成员 组成的去重复数组.</span></span><br><span class="line"><span class="comment">// @distinctUnionOfArrays.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfArraysForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *unionArray = [<span class="keyword">self</span> _unionOfArraysForKeyPath:keyPath];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithArray:unionArray].allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取集合数组"><a href="#获取集合数组" class="headerlink" title="获取集合数组"></a>获取集合数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应集合的每个成员 组成的数组. 这里每个keyPath对应值是是集合，获取的是每个集合展开后组成的总数组</span></span><br><span class="line"><span class="comment">// @unionOfSets.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_unionOfSetsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *unionArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionArray addObjectsFromArray:[eachValue allObjects]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取去重的集合数组"><a href="#获取去重的集合数组" class="headerlink" title="获取去重的集合数组"></a>获取去重的集合数组</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回 Array中每个对象的keyPath对应集合的每个成员 组成的去重复数组.</span></span><br><span class="line"><span class="comment">// @distinctUnionOfSets.keyPath</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)_distinctUnionOfSetsForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="built_in">NSMutableSet</span> *unionSet = [<span class="built_in">NSMutableSet</span> setWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i=<span class="number">0</span>; i&lt;<span class="keyword">self</span>.count; ++i) &#123;</span><br><span class="line">        <span class="keyword">id</span> eachValue = [<span class="keyword">self</span> _valueForKeyPath:keyPath ofObjectAtIndex:i];</span><br><span class="line">        <span class="keyword">if</span> (eachValue) &#123;</span><br><span class="line">            [unionSet unionSet:eachValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unionSet.allObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NSSet的KVC"><a href="#NSSet的KVC" class="headerlink" title="NSSet的KVC"></a>NSSet的KVC</h2><p>与NSArray的逻辑基本保持一致。</p>
<h2 id="NSOrderedSet的KVC"><a href="#NSOrderedSet的KVC" class="headerlink" title="NSOrderedSet的KVC"></a>NSOrderedSet的KVC</h2><p>与NSArray的逻辑基本保持一致。</p>
<h2 id="NSDictionary的KVC"><a href="#NSDictionary的KVC" class="headerlink" title="NSDictionary的KVC"></a>NSDictionary的KVC</h2><p>与NSArray相比，主要区别在于：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">- (id)<span class="symbol">valueForKey:</span>(NSString *)key &#123;</span><br><span class="line">    NSString *operationKey = <span class="literal">nil</span>;</span><br><span class="line">    /<span class="regexp">/ key中包含'@字符', 且'@字符'在第0位, 如 @"@count"</span></span><br><span class="line"><span class="regexp">    if(key.length &amp;&amp; [key characterAtIndex:0] == '@' &amp;&amp; (operationKey = [key substringWithRange:NSMakeRange(1, key.length - 1)])) &#123;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ 此时, operationKey为 @"count"</span></span><br><span class="line"><span class="regexp">        return [super valueForKey:operationKey];</span></span><br><span class="line"><span class="regexp">    &#125; else &#123;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ 没有'@字符', 走字典的objectForKey逻辑</span></span><br><span class="line"><span class="regexp">        return [self objectForKey:key];</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>valueForKey:</code>取值逻辑多了对<code>@</code>字符的处理。</p>
<p><code>valueForKeyPath:</code>与NSArray的逻辑一致。</p>
<h1 id="五、其他分类的KVC"><a href="#五、其他分类的KVC" class="headerlink" title="五、其他分类的KVC"></a>五、其他分类的KVC</h1><h2 id="NSMutableDictionary的KVC"><a href="#NSMutableDictionary的KVC" class="headerlink" title="NSMutableDictionary的KVC"></a>NSMutableDictionary的KVC</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="meta">@implementation</span> NSMutableDictionary (NSKeyValueCoding)</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">setValue:</span>(id)value <span class="string">forKey:</span>(NSString *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(value) &#123;</span><br><span class="line">        [self <span class="string">setObject:</span>value <span class="string">forKey:</span>key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [self <span class="string">removeObjectForKey:</span>key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure>
<p>相比主类增加的特性是：在<code>NSMutableDictionary</code>中，如果设置的<code>value</code>为空，则自动将<code>key</code>对应的<code>value</code>移除。</p>
<h2 id="NSUserDefaults的KVC"><a href="#NSUserDefaults的KVC" class="headerlink" title="NSUserDefaults的KVC"></a>NSUserDefaults的KVC</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSUserDefaults</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *subKey = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span>(key.length &amp;&amp; [key characterAtIndex:<span class="number">0</span>] == <span class="string">'@'</span> &amp;&amp; (subKey = [key substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, key.length - <span class="number">1</span>)])) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> valueForKey:subKey];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> objectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span>(value) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setObject:value forKey:key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>整合了<code>NSDictionary</code>与<code>NSMutableDictionary</code>的特色。</p>
<ol>
<li>增加了对<code>@</code>字符的处理。</li>
<li>如果设置的<code>value</code>为空，则自动将<code>key</code>对应的<code>value</code>移除。</li>
</ol>
<h2 id="NSNull的KVC"><a href="#NSNull的KVC" class="headerlink" title="NSNull的KVC"></a>NSNull的KVC</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSNull</span> (<span class="title">NSKeyValueCoding</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对于<code>NSNull</code>来说，无论怎么设值，取出来的值总是<code>NSNull</code>对象。</p>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>纵观全流程，使用KVC与直接使用存取器相比，速度方面稍有逊色，揣测主要原因如下：</p>
<ol>
<li>字符串处理。尤其是含有键路径的时候，使用到递归。（当然，含有<code>@</code>字符的集合运算符也算。）</li>
<li>方法查找。流程颇多，尽管有使用<code>CFSet</code>作为缓存。</li>
<li>装箱拆箱。KVC要求设值参数和取值参数均为对象，这就需要一般值类型和对象类型的相互转换。</li>
</ol>
<p>这也是为啥现在字典转模型都不使用KVC了，参见<a href="https://blog.chenyalun.com/2018/12/20/读「YYModel」/">读YYModel</a>。</p>
<p>强烈建议阅读：</p>
<blockquote>
<p><a href="https://myzerone.com/posts/2016/10/20/KVC(Key-Value-Coding)/" target="_blank" rel="noopener">https://myzerone.com/posts/2016/10/20/KVC(Key-Value-Coding)/</a><br><a href="https://objccn.io/issue-7-3/" target="_blank" rel="noopener">https://objccn.io/issue-7-3/</a></p>
</blockquote>
<p>源码来自：<a href="https://github.com/renjinkui2719/DIS_KVC_KVO" target="_blank" rel="noopener">https://github.com/renjinkui2719/DIS_KVC_KVO</a> 。感谢作者。</p>
<blockquote>
<p>参考资料<br><a href="https://nshipster.cn/kvc-collection-operators/" target="_blank" rel="noopener">https://nshipster.cn/kvc-collection-operators/</a><br><a href="https://www.jianshu.com/p/a50ea091e1f4" target="_blank" rel="noopener">https://www.jianshu.com/p/a50ea091e1f4</a><br><a href="http://hufeng825.github.io/2013/09/23/ios33/" target="_blank" rel="noopener">http://hufeng825.github.io/2013/09/23/ios33/</a><br><a href="https://www.jianshu.com/p/938855e842e4" target="_blank" rel="noopener">https://www.jianshu.com/p/938855e842e4</a><br><a href="https://suhou.github.io/2017/09/29/KVC原理小记/" target="_blank" rel="noopener">https://suhou.github.io/2017/09/29/KVC原理小记/</a><br><a href="http://blog.cocoabit.com/ios-settter-benchmark/" target="_blank" rel="noopener">http://blog.cocoabit.com/ios-settter-benchmark/</a></p>
</blockquote>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/iOS开发/">iOS开发</a>
            
              <a href="/tags/阅读/">阅读</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/05/31/读KVO源码/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">读KVO源码</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2019/04/25/读「FDFullscreenPopGesture」/">
        <span class="next-text nav-default">读「FDFullscreenPopGesture」</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ChenYalun" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://weibo.com/icqk" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
      
        
          <a href="https://stackoverflow.com/users/7026915/allen" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    May Be 
  </span>
  
  <span class="theme-info">
    Better  
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even"> </a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ya</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  
  <script>
    var cloudTieConfig = {
      url: document.location.href, 
      sourceId: "",
      productKey: "f132359147224247aa1c3ad32d20490b",
      target: "cloud-tie-wrapper"
    };
  </script>
  <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>





    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
