<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="Key-Value Observing源码初探">




  <meta name="keywords" content="iOS开发,阅读,">




  <link rel="alternate" href="/atom.xml" title="Ya">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x">



<link rel="canonical" href="http://blog.chenyalun.com/2019/05/31/Key-Value Observing源码初探/">


<meta name="description" content="KVO源码阅读。">
<meta name="keywords" content="iOS开发,阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="Key-Value Observing源码初探">
<meta property="og:url" content="http://blog.chenyalun.com/2019/05/31/Key-Value Observing源码初探/index.html">
<meta property="og:site_name" content="Ya">
<meta property="og:description" content="KVO源码阅读。">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://image.chenyalun.com/2019/05/30/001.png">
<meta property="og:updated_time" content="2019-09-17T03:33:08.930Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Key-Value Observing源码初探">
<meta name="twitter:description" content="KVO源码阅读。">
<meta name="twitter:image" content="https://image.chenyalun.com/2019/05/30/001.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">





<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  



    <title> Key-Value Observing源码初探 · Ya </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ya</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags/阅读/">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ya</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              时间线
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags/阅读/">
            
            
              阅读
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Key-Value Observing源码初探
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019年5月31日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、常用接口"><span class="toc-text">一、常用接口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、技巧回顾"><span class="toc-text">二、技巧回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-如何使得属性在未改变的情况下不发送通知-手动控制"><span class="toc-text">1.如何使得属性在未改变的情况下不发送通知(手动控制)?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-如何注册依赖键-多个属性影响到某一个属性"><span class="toc-text">2.如何注册依赖键(多个属性影响到某一个属性)?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-当NSMutableArray中元素增加和减少时如何监听到"><span class="toc-text">3.当NSMutableArray中元素增加和减少时如何监听到?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、几个问题"><span class="toc-text">三、几个问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-KVO的实现原理是什么"><span class="toc-text">1.KVO的实现原理是什么?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-KVO源码中添加观察者时整体的大致流程是什么"><span class="toc-text">2.KVO源码中添加观察者时整体的大致流程是什么?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-KVO中所封装组件的关系是怎样的"><span class="toc-text">3.KVO中所封装组件的关系是怎样的?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到"><span class="toc-text">4.KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-如何手动触发KVO"><span class="toc-text">5.如何手动触发KVO?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-通过KVC修改属性会触发KVO吗"><span class="toc-text">6.通过KVC修改属性会触发KVO吗?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、添加观察者"><span class="toc-text">四、添加观察者</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-封装"><span class="toc-text">1.封装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1接口方法"><span class="toc-text">1.1接口方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-添加对NSKeyValueProperty的观察的具体实现"><span class="toc-text">1.2.添加对NSKeyValueProperty的观察的具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#函数1-设置changeDictionary并调用NSKVONotify-函数"><span class="toc-text">函数1: 设置changeDictionary并调用NSKVONotify()函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数2-获取object的observationInfo对象"><span class="toc-text">函数2: 获取object的observationInfo对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数3-获取’添加观察者’时所需要的NSKeyValueObservationInfo"><span class="toc-text">函数3: 获取’添加观察者’时所需要的NSKeyValueObservationInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数4-将object的observationInfo设置为newObservationInfo"><span class="toc-text">函数4:将object的observationInfo设置为newObservationInfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-缓存"><span class="toc-text">2.缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-NSKeyValueProperty的缓存"><span class="toc-text">2.1.NSKeyValueProperty的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-NSKeyValueObservance的缓存"><span class="toc-text">2.2.NSKeyValueObservance的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-NSKeyValueObservationInfo的缓存"><span class="toc-text">2.3.NSKeyValueObservationInfo的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-NSKeyValueObservationInfo的存储-observationInfo"><span class="toc-text">2.4.NSKeyValueObservationInfo的存储(observationInfo)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-新建与重写"><span class="toc-text">3.新建与重写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1动态创建子类的核心实现"><span class="toc-text">3.1动态创建子类的核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加-isKVOA方法"><span class="toc-text">添加_isKVOA方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重写class方法"><span class="toc-text">重写class方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重写dealloc方法"><span class="toc-text">重写dealloc方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-回调通知"><span class="toc-text">4.回调通知</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、移除观察者"><span class="toc-text">五、移除观察者</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六、KVO自实现"><span class="toc-text">六、KVO自实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-接口"><span class="toc-text">1.接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-实现"><span class="toc-text">2.实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能check"><span class="toc-text">功能check</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七、小结"><span class="toc-text">七、小结</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p align="center"> KVO源码阅读。 </p>

<a id="more"></a>
<p>尝试去读一遍KVO的源码，发现它比KVC复杂的多，只能明白个大概。<br>文章最后按照自己的理解，再结合源码的实现流程自己写了一个KVO，锻炼锻炼。</p>
<h1 id="一、常用接口"><a href="#一、常用接口" class="headerlink" title="一、常用接口"></a>一、常用接口</h1><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// KVO的回调</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueObserving</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加及移除观察者</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">NSKeyValueObserverRegistration</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h1 id="二、技巧回顾"><a href="#二、技巧回顾" class="headerlink" title="二、技巧回顾"></a>二、技巧回顾</h1><h2 id="1-如何使得属性在未改变的情况下不发送通知-手动控制"><a href="#1-如何使得属性在未改变的情况下不发送通知-手动控制" class="headerlink" title="1.如何使得属性在未改变的情况下不发送通知(手动控制)?"></a>1.如何使得属性在未改变的情况下不发送通知(手动控制)?</h2><p>示例如下，主要有:</p>
<ol>
<li>重写<code>automaticallyNotifiesObserversForKey:</code>方法</li>
<li>重写<code>setter</code>方法</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAObject</span></span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">if</span> (name != _name) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">        _name = name;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="2-如何注册依赖键-多个属性影响到某一个属性"><a href="#2-如何注册依赖键-多个属性影响到某一个属性" class="headerlink" title="2.如何注册依赖键(多个属性影响到某一个属性)?"></a>2.如何注册依赖键(多个属性影响到某一个属性)?</h2><ol>
<li>重写<code>getter</code>方法，定义依赖关系</li>
<li>重写<code>keyPathsForValuesAffectingValueForKey:</code>方法，添加依赖的key集合</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *firstName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *lastName;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAObject</span></span></span><br><span class="line">- (<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="comment">// 定义依赖关系</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"firstName is %@ and lastName is %@"</span>, <span class="keyword">self</span>.firstName, <span class="keyword">self</span>.lastName];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSSet</span> *keyPaths = [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) &#123;</span><br><span class="line">        keyPaths = [keyPaths setByAddingObjectsFromArray:@[<span class="string">@"firstName"</span>, <span class="string">@"lastName"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyPaths;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> // 也可以命名为keyPathsForValuesAffecting&lt;Key&gt;的类方法来达到同样的目的</span></span><br><span class="line"><span class="comment"> + (NSSet&lt;NSString *&gt; *)keyPathsForValuesAffectingName &#123;</span></span><br><span class="line"><span class="comment">     return [NSSet setWithObjects:@"firstName", @"lastName", nil];</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="3-当NSMutableArray中元素增加和减少时如何监听到"><a href="#3-当NSMutableArray中元素增加和减少时如何监听到" class="headerlink" title="3.当NSMutableArray中元素增加和减少时如何监听到?"></a>3.当NSMutableArray中元素增加和减少时如何监听到?</h2><p>示例代码:</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAObject </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) NSMutableArray *nameList;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YAObject</span><br><span class="line"><span class="comment">// 实现集合代理对象: 一般建议-countOf&lt;Key&gt;和-objectIn&lt;Key&gt;AtIndex:</span></span><br><span class="line">- (NSUInteger)countOfNameList &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[_nameList count]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (id)<span class="selector-tag">objectInNameListAtIndex</span><span class="selector-pseudo">:(NSUInteger)index</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[_nameList objectAtIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 至少实现一个插入方法和一个删除方法</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">insertObject</span><span class="selector-pseudo">:(id)object</span> <span class="selector-tag">inNameListAtIndex</span><span class="selector-pseudo">:(NSUInteger)index</span> &#123;</span><br><span class="line">    <span class="selector-attr">[_nameList insertObject:object atIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="attribute">removeObjectFromNameListAtIndex</span>:(NSUInteger)index &#123;</span><br><span class="line">    <span class="selector-attr">[_nameList removeObjectAtIndex:index]</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>使用:</p>
<ol>
<li>务必使用<code>mutableArrayValueForKey</code>获取集合</li>
<li>使用<code>insertObject</code>方法添加元素</li>
</ol>
<p>比如:</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSMutableArray *nameList = [self.obj <span class="string">mutableArrayValueForKey:</span>@<span class="string">"nameList"</span>];</span><br><span class="line">[nameList <span class="string">insertObject:</span>obj <span class="string">atIndex:</span><span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<h1 id="三、几个问题"><a href="#三、几个问题" class="headerlink" title="三、几个问题"></a>三、几个问题</h1><p>总结的几个问题。</p>
<h2 id="1-KVO的实现原理是什么"><a href="#1-KVO的实现原理是什么" class="headerlink" title="1.KVO的实现原理是什么?"></a>1.KVO的实现原理是什么?</h2><blockquote>
<p>Objective-C依托于强大的runtime机制来实现KVO。当我们第一次观察某个对象的属性时，runtime会创建一个新的继承自这个对象的class的subclass(前缀是<code>NSKVONotifying_</code>)。在这个新的subclass中，它会重写所有被观察的key的setter，然后将object的isa指针指向新创建的class(这个指针告诉Objective-C运行时某个object到底是什么类型的)。所以object神奇地变成了新的子类的实例。</p>
</blockquote>
<p>——摘自南峰子的博客。</p>
<p>新类重写了<code>setter</code>方法、<code>class</code>方法、<code>dealloc</code>方法和<code>_isKVOA</code>方法。如果自己生成重名的NSKVONotifying_XX类，会造成KVO失效。以监听YAPerson对象的age属性为例，主要逻辑的伪代码如下：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YAPerson </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) NSUInteger age;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> YAPerson</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">NSKVONotifying_YAPerson </span>: YAPerson</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"><span class="variable">@implementation</span> NSKVONotifying_YAPerson</span><br><span class="line">- (void)<span class="attribute">setAge</span>:(NSUInteger)age &#123;</span><br><span class="line">    <span class="selector-tag">_NSSetUnsignedLongLongValueAndNotify</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">_NSSetUnsignedLongLongValueAndNotify</span>() &#123;</span><br><span class="line">    <span class="selector-attr">[self willChangeValueForKey:@"age"]</span>;</span><br><span class="line">    <span class="selector-attr">[super setAge:age]</span>;</span><br><span class="line">    <span class="selector-attr">[self didChangeValueForKey:@"age"]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="attribute">didChangeValueForKey</span>:(NSString *)key &#123;</span><br><span class="line">    <span class="selector-attr">[observer observeValueForKeyPath:@"age" ofObject:self change:change context:context]</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="2-KVO源码中添加观察者时整体的大致流程是什么"><a href="#2-KVO源码中添加观察者时整体的大致流程是什么" class="headerlink" title="2.KVO源码中添加观察者时整体的大致流程是什么?"></a>2.KVO源码中添加观察者时整体的大致流程是什么?</h2><ol>
<li>将<code>keyPath</code>、<code>class</code>等信息封装成<code>NSKeyValueProperty</code>，分别解析一般属性(<code>@&quot;aa&quot;</code>)、可计算属性(<code>@&quot;@aa&quot;</code>)、属性链(<code>@&quot;aa.bb.@cc.dd&quot;</code>)，进行子类化，缓存在<code>CFMutableSet</code>中方便下次快速取出。</li>
<li>将<code>NSKeyValueProperty</code>、<code>context</code>、<code>options</code>、<code>observer</code>等信息封装成<code>NSKeyValueObservance</code>，缓存在<code>NSHashTable</code>中。</li>
<li>倘若设置了<code>NSKeyValueObservingOptionInitial</code>选项，会在注册观察服务时调用一次触发方法。</li>
<li>动态创建名为<code>NSKVONotifying_+原来类名</code>的新类，重写其<code>dealloc</code>、<code>_isKVOA</code>方法，再重写<code>class</code>方法，利用<code>object_setClass()</code>函数将其isa指针指向原先的类。</li>
<li>重写<code>willChangeValueForKey:</code>和<code>didChangeValueForKey:</code>方法，重写被观察属性的<code>setter</code>方法，在<code>setter</code>中先调用<code>willChangeValueForKey:</code>方法，然后调用父类的 <code>setter</code> 方法对成员变量赋值，之后再调用 <code>didChangeValueForKey:</code> 方法。</li>
<li><code>didChangeValueForKey:</code> 方法中会调用<code>observeValueForKeyPath:ofObject:change:context:</code>方法。</li>
</ol>
<h2 id="3-KVO中所封装组件的关系是怎样的"><a href="#3-KVO中所封装组件的关系是怎样的" class="headerlink" title="3.KVO中所封装组件的关系是怎样的?"></a>3.KVO中所封装组件的关系是怎样的?</h2><ol>
<li>将<code>keyPath、class</code>等信息封装成<code>NSKeyValueProperty</code>，使用<code>CFMutableSet</code>缓存<code>NSKeyValueProperty</code>。</li>
<li>将<code>observer、property、options、context 、originalObservable</code>等信息封装成<code>NSKeyValueObservance</code>，<code>使用NSHashTable(NSKeyValueShareableObservationInfos)</code>缓存。</li>
<li><code>NSKeyValueObservationInfo</code>与<code>NSKeyValueObservance</code>的关系是: <code>NSKeyValueObservationInfo</code>中有一个<code>observances</code>数组，数组里面是<code>NSKeyValueObservance</code>对象。</li>
<li>每一个<code>object</code>都有一个<code>observationInfo</code>属性(<code>void *</code>类型)，它与<code>NSKeyValueObservationInfo</code>会相互转化。</li>
</ol>
<p><code>class</code>和<code>keyPath</code>决定了是否是同一个<code>NSKeyValueProperty</code>。<br><code>NSKeyValueProperty</code>、<code>Observer</code>、<code>options</code>、<code>context</code> 决定了是否是同一个<code>NSKeyValueObservance</code>。</p>
<h2 id="4-KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到"><a href="#4-KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到" class="headerlink" title="4.KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到?"></a>4.KVO多次使用完全相同的参数进行addObserver操作，也会得到相应次数的回调，如何做到?</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br><span class="line">[self.obj <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>NULL];</span><br></pre></td></tr></table></figure>
<p>如上面代码，会有四次回调。</p>
<p>在每次添加观察者时，都会获取<code>NSKeyValueObservance</code>对象(可能从缓存中获取也可能新建)，并把它追加到object的<code>observances</code>数组中(即使该数组中已经存在完全相同（指针一致）的<code>NSKeyValueObservance</code>对象)，由此保证了多次<code>addObserver</code>操作会有多次回调。</p>
<p>通过打印可以证明：</p>
<p><img src="https://image.chenyalun.com/2019/05/30/001.png" style="zoom:50%"></p>
<h2 id="5-如何手动触发KVO"><a href="#5-如何手动触发KVO" class="headerlink" title="5.如何手动触发KVO?"></a>5.如何手动触发KVO?</h2><p>手动调用<code>willChangeValueForKey:</code>和<code>didChangeValueForKey:</code>。也即：<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)invokeKVOForAge &#123;</span><br><span class="line">    [<span class="meta">self.person willChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br><span class="line">    [<span class="meta">self.person didChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只手动调用一个还不行，为什么？由原理可知，<code>didChangeValueForKey:</code>中才真正调用了<code>observeValueForKeyPath:ofObject:change:context</code>方法，所以<code>didChangeValueForKey:</code>毋庸置疑不可或缺。那么为什么还需要<code>willChangeValueForKey:</code>呢？<br>查看文档，苹果一如既往地冷酷：</p>
<blockquote>
<p>Calls to this method are always paired with a matching call to willChangeValueForKey:.</p>
</blockquote>
<p>意思是，这俩是成对存在的，你只管调就是了。好吧，这块源码确实没看明白，先挖个坑吧。</p>
<h2 id="6-通过KVC修改属性会触发KVO吗"><a href="#6-通过KVC修改属性会触发KVO吗" class="headerlink" title="6.通过KVC修改属性会触发KVO吗?"></a>6.通过KVC修改属性会触发KVO吗?</h2><p>当KVC是通过setter方法设值时，无需多言，会触发KVO。当KVC是通过成员变量设值时，也会触发KVO，为什么？<br>阅读源码可知，直接通过成员变量设值，会创建NSKeyValueIvarSetter对象，在该对象的构造方法中会调用<code>_NSSetValueAndNotifyForKeyInIvar()</code>函数，其实现如下：<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSSetValueAndNotifyForKeyInIvar(<span class="keyword">id</span> object, SEL selector, <span class="keyword">id</span> value, <span class="built_in">NSString</span> *key, Ivar ivar, IMP imp) &#123;</span><br><span class="line">    [object willChangeValueForKey:key];</span><br><span class="line">    </span><br><span class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>,SEL,<span class="keyword">id</span>,<span class="built_in">NSString</span> *, Ivar))imp)(object,<span class="literal">NULL</span>,value,key,ivar);</span><br><span class="line">    </span><br><span class="line">    [object didChangeValueForKey:key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>真相大白了，它调用了<code>willChangeValueForKey:</code>和<code>didChangeValueForKey:</code>方法，正是这个触发了KVO。需要注意的是，<strong>直接修改成员变量是不会触发KVO的</strong>。</p>
<h1 id="四、添加观察者"><a href="#四、添加观察者" class="headerlink" title="四、添加观察者"></a>四、添加观察者</h1><p>这一步骤中封装出了许多的类，同时也把产生的许多对象做了进一步的缓存处理。</p>
<h2 id="1-封装"><a href="#1-封装" class="headerlink" title="1.封装"></a>1.封装</h2><h3 id="1-1接口方法"><a href="#1-1接口方法" class="headerlink" title="1.1接口方法"></a>1.1接口方法</h3><p>加锁，接口方法中使用<code>pthread</code>中的<code>pthread_mutex_lock()</code>和<code>pthread_mutex_unlock</code>函数。</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 这是个接口方法, 添加观察者分为两个流程: 1，根据class和keyPath获取NSKeyValueProperty对象。2，添加对property的观察。</span></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">d_addObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">context:</span>(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="comment">// 加锁</span></span><br><span class="line">    pthread_mutex_lock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">    <span class="comment">// 获取当前线程pthread</span></span><br><span class="line">    _NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    <span class="comment">// 根据class和keyPath获取NSKeyValueProperty</span></span><br><span class="line">    NSKeyValueProperty *property = NSKeyValuePropertyForIsaAndKeyPath(object_getClass(self),keyPath);</span><br><span class="line">    <span class="comment">// 添加对property的观察</span></span><br><span class="line">    [self <span class="string">_d_addObserver:</span>observer <span class="string">forProperty:</span>property <span class="string">options:</span>options <span class="string">context:</span>context];</span><br><span class="line">    <span class="comment">// 解锁</span></span><br><span class="line">    pthread_mutex_unlock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-添加对NSKeyValueProperty的观察的具体实现"><a href="#1-2-添加对NSKeyValueProperty的观察的具体实现" class="headerlink" title="1.2.添加对NSKeyValueProperty的观察的具体实现"></a>1.2.添加对NSKeyValueProperty的观察的具体实现</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 添加观察者过程中, 不是单纯地'观察'keyPath, 而是观察对keyPath封装的NSKeyValueProperty</span></span><br><span class="line">- (<span class="keyword">void</span>)_addObserver:(<span class="keyword">id</span>)observer forProperty:(<span class="built_in">NSKeyValueProperty</span> *)property options:(<span class="keyword">int</span>)options context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span>(options &amp; <span class="built_in">NSKeyValueObservingOptionInitial</span>) &#123;</span><br><span class="line">        <span class="comment">// NSKeyValueObservingOptionInitial: 观察最初的值（在注册观察服务时会调用一次触发方法）</span></span><br><span class="line">        <span class="built_in">NSString</span> *keyPath = [property keyPath];</span><br><span class="line">        _NSKeyValueObserverRegistrationLockOwner = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        pthread_mutex_unlock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">            <span class="comment">// newValue就是当前的值</span></span><br><span class="line">            newValue = [<span class="keyword">self</span> valueForKeyPath:keyPath];</span><br><span class="line">            <span class="keyword">if</span> (!newValue) &#123;</span><br><span class="line">                newValue = [<span class="built_in">NSNull</span> null]; <span class="comment">// 使用NSNull对象</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSKeyValueChangeDictionary</span> *changeDictionary = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// 创建NSKeyValueChangeDetails结构体</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         typedef struct &#123;</span></span><br><span class="line"><span class="comment">             NSKeyValueChange kind;</span></span><br><span class="line"><span class="comment">             id oldValue;</span></span><br><span class="line"><span class="comment">             id newValue;</span></span><br><span class="line"><span class="comment">             NSIndexSet *indexes;</span></span><br><span class="line"><span class="comment">             id extraData;</span></span><br><span class="line"><span class="comment">         &#125; NSKeyValueChangeDetails;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">NSKeyValueChangeDetails</span> changeDetails = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        changeDetails.kind = <span class="built_in">NSKeyValueChangeSetting</span>;</span><br><span class="line">        changeDetails.oldValue = <span class="literal">nil</span>;</span><br><span class="line">        changeDetails.newValue = newValue;</span><br><span class="line">        changeDetails.indexes = <span class="literal">nil</span>;</span><br><span class="line">        changeDetails.extraData = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// 函数1: 通知观察者, 传递结构体changeDetails</span></span><br><span class="line">        <span class="built_in">NSKeyValueNotifyObserver</span>(observer,keyPath, <span class="keyword">self</span>, context, <span class="literal">nil</span>, <span class="literal">NO</span>,changeDetails, &amp;changeDictionary);</span><br><span class="line">        </span><br><span class="line">        [changeDictionary release];</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        pthread_mutex_lock(&amp;_NSKeyValueObserverRegistrationLock);</span><br><span class="line">        <span class="comment">// 获取当前pthread</span></span><br><span class="line">        _NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 函数2: 获取oldObservationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *oldObservationInfo = _NSKeyValueRetainedObservationInfoForObject(<span class="keyword">self</span>,property.containerClass);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> cacheHit = <span class="literal">NO</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *addedObservance = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">id</span> originalObservable = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((options &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x01</span>) &#123;</span><br><span class="line">        <span class="comment">// _CFGetTSD: 获取线程信息</span></span><br><span class="line">        <span class="comment">// Get some thread specific data from a pre-assigned slot.</span></span><br><span class="line">        <span class="built_in">NSKeyValueObservingTSD</span> *TSD = _CFGetTSD(<span class="built_in">NSKeyValueObservingTSDKey</span>);</span><br><span class="line">        <span class="keyword">if</span> (TSD) &#123;</span><br><span class="line">            originalObservable = TSD-&gt;implicitObservanceAdditionInfo.originalObservable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 函数3: 获取newObservationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *newObservationInfo = _NSKeyValueObservationInfoCreateByAdding(oldObservationInfo, observer, property, options, context, originalObservable,&amp;cacheHit,&amp;addedObservance);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 函数4: 将self的observationInfo设置为newObservationInfo</span></span><br><span class="line">    _NSKeyValueReplaceObservationInfoForObject(<span class="keyword">self</span>,property.containerClass,oldObservationInfo,newObservationInfo);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// - (void)object:(id)object didAddObservance:(NSKeyValueObservance *)observance recurse:(BOOL)recurse &#123;&#125;</span></span><br><span class="line">    <span class="comment">// 实际上这个方法啥事也没做</span></span><br><span class="line">    [property object:<span class="keyword">self</span> didAddObservance:addedObservance recurse:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 核心方法: 获取property中已经修改过的class</span></span><br><span class="line">    Class isaForAutonotifying = [property isaForAutonotifying];</span><br><span class="line">    <span class="keyword">if</span>(isaForAutonotifying) &#123;</span><br><span class="line">        Class cls = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">if</span>(cls != isaForAutonotifying) &#123;</span><br><span class="line">            <span class="comment">// 通过 object_setClass()修改isa指针, 设置自己的class为property的isaForAutonotifying</span></span><br><span class="line">            object_setClass(<span class="keyword">self</span>,isaForAutonotifying);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [newObservationInfo release];</span><br><span class="line">    [oldObservationInfo release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数1-设置changeDictionary并调用NSKVONotify-函数"><a href="#函数1-设置changeDictionary并调用NSKVONotify-函数" class="headerlink" title="函数1: 设置changeDictionary并调用NSKVONotify()函数"></a>函数1: 设置changeDictionary并调用NSKVONotify()函数</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="built_in">NSKeyValueNotifyObserver</span>(<span class="keyword">id</span> observer,<span class="built_in">NSString</span> * keyPath, <span class="keyword">id</span> object, <span class="keyword">void</span> *context, <span class="keyword">id</span> originalObservable, <span class="built_in">BOOL</span> isPriorNotification, <span class="built_in">NSKeyValueChangeDetails</span> changeDetails, <span class="built_in">NSKeyValueChangeDictionary</span> **changeDictionary) &#123;</span><br><span class="line">    <span class="keyword">if</span>(*changeDictionary) &#123;</span><br><span class="line">        [*changeDictionary setDetailsNoCopy:changeDetails originalObservable:originalObservable];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *changeDictionary =  [[<span class="built_in">NSKeyValueChangeDictionary</span> alloc] initWithDetailsNoCopy:changeDetails originalObservable:originalObservable isPriorNotification:isPriorNotification];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSUInteger</span> retainCountBefore = [*changeDictionary retainCount];</span><br><span class="line">    <span class="built_in">NSKVONotify</span>(observer, keyPath, object, *changeDictionary, context);</span><br><span class="line">    <span class="keyword">if</span>(retainCountBefore != (<span class="built_in">NSUInteger</span>)INTMAX_MAX &amp;&amp; retainCountBefore != [*changeDictionary retainCount]) &#123;</span><br><span class="line">        [*changeDictionary retainObjects];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSKVONotify()函数就是调用observeValueForKeyPath方法</span></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">NSKVONotify</span>(<span class="keyword">id</span> observer, <span class="built_in">NSString</span> *keyPath, <span class="keyword">id</span> object, <span class="built_in">NSDictionary</span> *changeDictionary, <span class="keyword">void</span> *context) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservingAssertRegistrationLockNotHeld</span>();</span><br><span class="line">    [observer observeValueForKeyPath:keyPath ofObject:object change:changeDictionary context:context];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数2-获取object的observationInfo对象"><a href="#函数2-获取object的observationInfo对象" class="headerlink" title="函数2: 获取object的observationInfo对象"></a>函数2: 获取object的observationInfo对象</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueRetainedObservationInfoForObject(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueContainerClass</span> *containerClass) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *observationInfo = <span class="literal">nil</span>;</span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    <span class="keyword">if</span> (containerClass) &#123;</span><br><span class="line">        <span class="comment">// 调用containerClass的cachedObservationInfoImplementation实现</span></span><br><span class="line">        observationInfo = ((<span class="built_in">NSKeyValueObservationInfo</span> * (*)(<span class="keyword">id</span>,SEL))containerClass.cachedObservationInfoImplementation)(object, <span class="keyword">@selector</span>(observationInfo));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 直接获取object的d_observationInfo对象</span></span><br><span class="line">        observationInfo = (<span class="built_in">NSKeyValueObservationInfo</span> *)[object d_observationInfo];</span><br><span class="line">    &#125;</span><br><span class="line">    [observationInfo <span class="keyword">retain</span>];</span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    <span class="keyword">return</span>  observationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数3-获取’添加观察者’时所需要的NSKeyValueObservationInfo"><a href="#函数3-获取’添加观察者’时所需要的NSKeyValueObservationInfo" class="headerlink" title="函数3: 获取’添加观察者’时所需要的NSKeyValueObservationInfo"></a>函数3: 获取’添加观察者’时所需要的NSKeyValueObservationInfo</h4><p>如果<code>baseObservationInfo</code>存在，则一顿封装操作后，会把封装完毕的<code>NSKeyValueObservance</code>“追加”到<code>baseObservationInfo</code>的<code>observances</code>数组中。如果<code>baseObservationInfo</code>不存在，则一顿封装操作后，会把封装完毕的<code>NSKeyValueObservance</code>放到新创建的<code>NSKeyValueObservationInfo</code>对象的<code>observances</code>数组中。最后，<code>cacheHit</code>告诉调用者是否有命中缓存，<code>*addedObservance</code>指向了<code>observance</code>对象。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueObservationInfoCreateByAdding(<span class="built_in">NSKeyValueObservationInfo</span> *baseObservationInfo, <span class="keyword">id</span> observer, <span class="built_in">NSKeyValueProperty</span> *property, <span class="keyword">int</span> options, <span class="keyword">void</span> *context, <span class="keyword">id</span> originalObservable,  <span class="built_in">BOOL</span> *cacheHit, <span class="built_in">NSKeyValueObservance</span> **addedObservance) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *createdObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用弱引用表NSKeyValueShareableObservationInfos缓存观察者对象</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">        <span class="comment">// 自定义NSPointerFunctions</span></span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">        <span class="comment">// 设置hash函数</span></span><br><span class="line">        [pointerFunctions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">        <span class="comment">// 设置判等函数</span></span><br><span class="line">        [pointerFunctions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">        <span class="comment">// 创建NSHashTable</span></span><br><span class="line">        <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span>) &#123;</span><br><span class="line">        <span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span> = [<span class="built_in">NSKeyValueShareableObservationInfoKey</span> <span class="keyword">class</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过这个公共key到缓存表NSKeyValueShareableObservationInfos中查找</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservationInfoKey</span> * shareableObservationInfoKey;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!shareableObservationInfoKey) &#123;</span><br><span class="line">        <span class="comment">// 第一次使用, 为空时创建</span></span><br><span class="line">        shareableObservationInfoKey = [[<span class="built_in">NSKeyValueShareableObservationInfoKey</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置key的信息</span></span><br><span class="line">    shareableObservationInfoKey.addingNotRemoving = <span class="literal">YES</span>;</span><br><span class="line">    shareableObservationInfoKey.baseObservationInfo = baseObservationInfo;</span><br><span class="line">    shareableObservationInfoKey.additionObserver = observer;</span><br><span class="line">    shareableObservationInfoKey.additionProperty = property;</span><br><span class="line">    shareableObservationInfoKey.additionOptions = options;</span><br><span class="line">    shareableObservationInfoKey.additionContext = context;</span><br><span class="line">    shareableObservationInfoKey.additionOriginalObservable = originalObservable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据shareableObservationInfoKey的已有信息进行查找</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> * existsObservationInfo = [<span class="built_in">NSKeyValueShareableObservationInfos</span> member:shareableObservationInfoKey];</span><br><span class="line">    <span class="comment">// 清空shareableObservationInfoKey的废弃信息(主要是减少对observer的引用计数)</span></span><br><span class="line">    shareableObservationInfoKey.additionOriginalObservable = <span class="literal">nil</span>;</span><br><span class="line">    shareableObservationInfoKey.additionObserver = <span class="literal">nil</span>;</span><br><span class="line">    shareableObservationInfoKey.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!existsObservationInfo) &#123; <span class="comment">// 缓存中不存在</span></span><br><span class="line">        <span class="comment">// (一般是第一次使用时)NSHashTable为空, 创建</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservances</span>) &#123;</span><br><span class="line">            <span class="built_in">NSKeyValueShareableObservances</span> = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过这个公共key到缓存表NSKeyValueShareableObservances中查找</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservanceKey</span> *shareableObservanceKey;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!shareableObservanceKey) &#123; <span class="comment">// key不存在时创建</span></span><br><span class="line">            shareableObservanceKey = [[<span class="built_in">NSKeyValueShareableObservanceKey</span> alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置key的信息</span></span><br><span class="line">        shareableObservanceKey.observer = observer;</span><br><span class="line">        shareableObservanceKey.property = property;</span><br><span class="line">        shareableObservanceKey.options = options;</span><br><span class="line">        shareableObservanceKey.context = context;</span><br><span class="line">        shareableObservanceKey.originalObservable = originalObservable;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查找Observance缓存</span></span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *existsObservance = [<span class="built_in">NSKeyValueShareableObservances</span> member:shareableObservanceKey];</span><br><span class="line">        <span class="comment">// 清空shareableObservanceKey的废弃信息</span></span><br><span class="line">        shareableObservanceKey.originalObservable = <span class="literal">nil</span>;</span><br><span class="line">        shareableObservanceKey.observer = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *observance = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!existsObservance) &#123;</span><br><span class="line">            <span class="comment">// 没有找到, 则创建observance</span></span><br><span class="line">            observance = [[<span class="built_in">NSKeyValueObservance</span> alloc] _initWithObserver:observer property:property options:options context:context originalObservable:originalObservable];</span><br><span class="line">            <span class="keyword">if</span>(observance.cachedIsShareable) &#123;</span><br><span class="line">                <span class="comment">// 可以缓存, 放入NSKeyValueShareableObservances中</span></span><br><span class="line">                [<span class="built_in">NSKeyValueShareableObservances</span> addObject:observance];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 找到了, observance就指向existsObservance</span></span><br><span class="line">            observance = existsObservance;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (baseObservationInfo) &#123;</span><br><span class="line">            <span class="comment">// 复制baseObservationInfo并追加observance</span></span><br><span class="line">            createdObservationInfo = [baseObservationInfo _copyByAddingObservance:observance];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 创建新的ObservationInfo</span></span><br><span class="line">            createdObservationInfo = [[<span class="built_in">NSKeyValueObservationInfo</span> alloc] _initWithObservances:&amp;observance count:<span class="number">1</span> hashValue:<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (createdObservationInfo.cachedIsShareable)&#123;</span><br><span class="line">            <span class="comment">// 允许缓存, 添加到NSKeyValueShareableObservationInfos中</span></span><br><span class="line">            [<span class="built_in">NSKeyValueShareableObservationInfos</span> addObject:createdObservationInfo];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有命中缓存</span></span><br><span class="line">        *cacheHit = <span class="literal">NO</span>;</span><br><span class="line">        <span class="comment">// 设置新添加的Observance</span></span><br><span class="line">        *addedObservance = observance;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 缓存中存在</span></span><br><span class="line">        <span class="comment">// 设置命中缓存</span></span><br><span class="line">        *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// observance必定就是已存在的info.observance列表最后一个, 因为判断equal就是按照这个原则去判断的</span></span><br><span class="line">        <span class="comment">// 判等函数: NSKeyValueShareableObservationInfoNSHTIsEqual()</span></span><br><span class="line">        *addedObservance = existsObservationInfo.observances.lastObject;</span><br><span class="line">        <span class="comment">// 设置createdObservationInfo</span></span><br><span class="line">        createdObservationInfo = existsObservationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解锁</span></span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">    <span class="keyword">return</span> createdObservationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数4-将object的observationInfo设置为newObservationInfo"><a href="#函数4-将object的observationInfo设置为newObservationInfo" class="headerlink" title="函数4:将object的observationInfo设置为newObservationInfo"></a>函数4:将object的observationInfo设置为newObservationInfo</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSKeyValueReplaceObservationInfoForObject(<span class="keyword">id</span> object, <span class="built_in">NSKeyValueContainerClass</span> * containerClass, <span class="built_in">NSKeyValueObservationInfo</span> *oldObservationInfo, <span class="built_in">NSKeyValueObservationInfo</span> *newObservationInfo) &#123;</span><br><span class="line">    os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newObservationInfo) [newObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不理解??????</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     typedef struct &#123;</span></span><br><span class="line"><span class="comment">         CFMutableArrayRef pendingArray;//0</span></span><br><span class="line"><span class="comment">         ObservationInfoWatcher *firstWatcher;//4</span></span><br><span class="line"><span class="comment">         ImplicitObservanceAdditionInfo  implicitObservanceAdditionInfo;</span></span><br><span class="line"><span class="comment">         ImplicitObservanceRemovalInfo implicitObservanceRemovalInfo;</span></span><br><span class="line"><span class="comment">     &#125; NSKeyValueObservingTSD;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservingTSD</span> *TSD = _CFGetTSD(<span class="built_in">NSKeyValueObservingTSDKey</span>);</span><br><span class="line">    <span class="keyword">if</span>(TSD) &#123;</span><br><span class="line">        ObservationInfoWatcher *next = TSD-&gt;firstWatcher;</span><br><span class="line">        <span class="keyword">while</span>(next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (next-&gt;object == object) &#123;</span><br><span class="line">                [next-&gt;observationInfo release];</span><br><span class="line">                next-&gt;observationInfo = [newObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            next = next-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(containerClass) &#123;</span><br><span class="line">        <span class="comment">// 调用object的d_setObservationInfo:方法, 并传参数newObservationInfo</span></span><br><span class="line">        containerClass.cacheNSetObservationInfoImplementation(object, <span class="keyword">@selector</span>(d_setObservationInfo:), newObservationInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 直接设置新值</span></span><br><span class="line">        [object d_setObservationInfo: newObservationInfo];</span><br><span class="line">    &#125;</span><br><span class="line">    os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoSpinLock</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-缓存"><a href="#2-缓存" class="headerlink" title="2.缓存"></a>2.缓存</h2><p>缓存查找逻辑是一致的: 确定这些对象的<code>hash</code>和<code>isEqual:</code>方法，通过创建与目标对象判等属性一致的key去查找。</p>
<h3 id="2-1-NSKeyValueProperty的缓存"><a href="#2-1-NSKeyValueProperty的缓存" class="headerlink" title="2.1.NSKeyValueProperty的缓存"></a>2.1.NSKeyValueProperty的缓存</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueProperties</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建集合NSKeyValueProperties</span></span><br><span class="line">    <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    callbacks.version =  kCFTypeSetCallBacks.version;</span><br><span class="line">    callbacks.retain =  kCFTypeSetCallBacks.retain;</span><br><span class="line">    callbacks.release =  kCFTypeSetCallBacks.release;</span><br><span class="line">    callbacks.copyDescription =  kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">    <span class="comment">// 设置CFSet集合中元素判等的依据</span></span><br><span class="line">    callbacks.equal =  (<span class="built_in">CFSetEqualCallBack</span>)<span class="built_in">NSKeyValuePropertyIsEqual</span>;</span><br><span class="line">    <span class="comment">// 设置CFSet集合中元素的hash值获取函数</span></span><br><span class="line">    callbacks.hash =  (<span class="built_in">CFSetHashCallBack</span>)<span class="built_in">NSKeyValuePropertyHash</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueProperties</span> =  <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;callbacks);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 把property添加到NSKeyValueProperties集合中</span></span><br><span class="line"><span class="built_in">CFSetAddValue</span>(<span class="built_in">NSKeyValueProperties</span>, property);</span><br></pre></td></tr></table></figure>
<p>CFSet集合中元素判等的依据</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> <span class="built_in">NSKeyValuePropertyIsEqual</span>(<span class="built_in">NSKeyValueProperty</span> *property1, <span class="built_in">NSKeyValueProperty</span> *property2) &#123;</span><br><span class="line">    <span class="keyword">return</span> (property1.containerClass == property2.containerClass) &amp;&amp;</span><br><span class="line">    (property1.keyPath == property2.keyPath || [property1.keyPath isEqual: property2.keyPath]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回NSKeyValueProperty的hash值</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">NSUInteger NSKeyValuePropertyHash(NSKeyValueProperty *<span class="keyword">property</span><span class="title"></span>) &#123;</span><br><span class="line">    return <span class="keyword">property</span>.<span class="title"></span>keyPath.hash ^ (NSUInteger)(void *)<span class="keyword">property</span>.<span class="title"></span>containerClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次证明了 <code>class</code>和<code>keyPath</code>决定了是否是同一个<code>NSKeyValueProperty</code>。</p>
<h3 id="2-2-NSKeyValueObservance的缓存"><a href="#2-2-NSKeyValueObservance的缓存" class="headerlink" title="2.2.NSKeyValueObservance的缓存"></a>2.2.NSKeyValueObservance的缓存</h3><p>缓存查找</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSHashTable</span> *<span class="built_in">NSKeyValueShareableObservances</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservances</span>) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueShareableObservances</span> = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// observance查找key</span></span><br><span class="line"><span class="keyword">static</span> DNSKeyValueShareableObservanceKey *shareableObservanceKey;</span><br><span class="line"><span class="keyword">if</span>(!shareableObservanceKey) &#123;</span><br><span class="line">    shareableObservanceKey = [[DNSKeyValueShareableObservanceKey alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">shareableObservanceKey.observer = observer;</span><br><span class="line">shareableObservanceKey.property = property;</span><br><span class="line">shareableObservanceKey.options = options;</span><br><span class="line">shareableObservanceKey.context = context;</span><br><span class="line">shareableObservanceKey.originalObservable = originalObservable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找缓存</span></span><br><span class="line"><span class="built_in">NSKeyValueObservance</span> *existsObservance = [<span class="built_in">NSKeyValueShareableObservances</span> member:shareableObservanceKey];</span><br><span class="line">shareableObservanceKey.originalObservable = <span class="literal">nil</span>;</span><br><span class="line">shareableObservanceKey.observer = <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure>
<p>重写<code>NSKeyValueObservance</code>的<code>hash</code>和<code>isEqual:</code>方法</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="keyword">return</span> _NSKVOPointersHash(<span class="number">5</span>, _observer, _property, (<span class="keyword">void</span> *)(<span class="built_in">NSUInteger</span>)(_options), _context, _originalObservable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isKindOfClass: <span class="keyword">self</span>.class])  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *other = (<span class="built_in">NSKeyValueObservance</span> *)object;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> other.observer == <span class="keyword">self</span>.observer &amp;&amp;</span><br><span class="line">    other.options == <span class="keyword">self</span>.options &amp;&amp;</span><br><span class="line">    other.context == <span class="keyword">self</span>.context &amp;&amp;</span><br><span class="line">    other.originalObservable == <span class="keyword">self</span>.originalObservable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-NSKeyValueObservationInfo的缓存"><a href="#2-3-NSKeyValueObservationInfo的缓存" class="headerlink" title="2.3.NSKeyValueObservationInfo的缓存"></a>2.3.NSKeyValueObservationInfo的缓存</h3><p>缓存查找</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSHashTable</span> *<span class="built_in">NSKeyValueShareableObservationInfos</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// observationInfo缓存</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">    <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">    [pointerFunctions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">    [pointerFunctions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">    <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-NSKeyValueObservationInfo的存储-observationInfo"><a href="#2-4-NSKeyValueObservationInfo的存储-observationInfo" class="headerlink" title="2.4.NSKeyValueObservationInfo的存储(observationInfo)"></a>2.4.NSKeyValueObservationInfo的存储(observationInfo)</h3><p>当封装成<code>NSKeyValueObservationInfo</code>时，<code>weak</code>的<code>NSHashTable</code>并不负责存储，那么，谁负责真正的存储呢?</p>
<p>Take or return a pointer that identifies information about all of the observers that are registered with the receiver, the options that were used at registration-time, etc. The default implementation of these methoNS store observation info in a global dictionary keyed by the receivers’ pointers. For improved performance, you can override these methoNS to store the opaque data pointer in an instance variable. Overrides of these methoNS must not attempt to send Objective-C messages to the passed-in observation info, including -retain and -release.</p>
<blockquote>
<p>这个方法的默认实现是以对象的指针作为key，从一个全局的字典中获取信息。</p>
</blockquote>
<p>如何获取对象的指针？这里有个定义：<br><code>OBSERVATION_INFO_KEY</code>的定义是: <code>#define OBSERVATION_INFO_KEY(object) ((void *)(~(NSUInteger)(object)))</code></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CFMutableDictionaryRef</span> <span class="built_in">NSKeyValueObservationInfoPerObject</span> = <span class="literal">NULL</span>;</span><br><span class="line">- (<span class="keyword">void</span> *)observationInfo &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NSKeyValueObservationInfoPerObject</span> ? (<span class="keyword">void</span> *)<span class="built_in">CFDictionaryGetValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>)) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObservationInfo:(<span class="keyword">void</span> *)info &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NSKeyValueObservationInfoPerObject</span>) &#123;</span><br><span class="line">        <span class="built_in">NSKeyValueObservationInfoPerObject</span> = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (info) &#123;</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>), info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryRemoveValue</span>(<span class="built_in">NSKeyValueObservationInfoPerObject</span>, OBSERVATION_INFO_KEY(<span class="keyword">self</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>即这个方法的默认实现是以对象的指针作为key，从一个全局的字典中获取信息。由此，我们可以理解为，KVO的信息是存储在一个全局字典中，而不是存储在对象本身。<br>不过，为了提高效率，我们可以重写observationInfo属性的set和get方法，以将这个不透明的数据指针存储到一个实例变量中。但是，在重写时，我们不应该尝试去向这些数据发送一个Objective-C消息，包括retain和release。</p>
</blockquote>
<h2 id="3-新建与重写"><a href="#3-新建与重写" class="headerlink" title="3.新建与重写"></a>3.新建与重写</h2><p>在这一步骤中，动态创建了原来class的子类，当然，也重写和添加了许多方法。</p>
<h3 id="3-1动态创建子类的核心实现"><a href="#3-1动态创建子类的核心实现" class="headerlink" title="3.1动态创建子类的核心实现"></a>3.1动态创建子类的核心实现</h3><p>动态创建子类中，重写了<code>dealloc、class、_isKVOA</code>方法。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueNotifyingInfo</span> *_NSKVONotifyingCreateInfoWithOriginalClass(Class originalClass) &#123;</span><br><span class="line">    <span class="keyword">static</span> IMP <span class="built_in">NSObjectWillChange</span>;</span><br><span class="line">    <span class="keyword">static</span> IMP <span class="built_in">NSObjectDidChange</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造新的子类名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalClassName = class_getName(originalClass);</span><br><span class="line">    size_t size = strlen(originalClassName) + <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">char</span> *newClassName = (<span class="keyword">char</span> *)malloc(size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// #define NOTIFY_CLASSNAME_PREFIX "NSKVONotifying_"</span></span><br><span class="line">    strlcpy(newClassName, NOTIFY_CLASSNAME_PREFIX, size);</span><br><span class="line">    strlcat(newClassName, originalClassName, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建子类</span></span><br><span class="line">    Class newSubClass = objc_allocateClassPair(originalClass, newClassName, <span class="keyword">sizeof</span>(<span class="built_in">NSKeyValueNotifyingInfo</span>));</span><br><span class="line">    objc_registerClassPair(newSubClass);</span><br><span class="line">    </span><br><span class="line">    free(newClassName);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ivars = object_getIndexedIvars(newSubClass);</span><br><span class="line">    <span class="comment">// 创建NSKeyValueNotifyingInfo对象, 封装子类\原始类等信息</span></span><br><span class="line">    <span class="built_in">NSKeyValueNotifyingInfo</span> *notifyingInfo = (<span class="built_in">NSKeyValueNotifyingInfo</span> *)ivars;</span><br><span class="line">    notifyingInfo-&gt;originalClass = originalClass;</span><br><span class="line">    notifyingInfo-&gt;newSubClass = newSubClass;</span><br><span class="line">    notifyingInfo-&gt;notifyingKeys = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;kCFCopyStringSetCallBacks);</span><br><span class="line">    notifyingInfo-&gt;selKeyMap = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">    </span><br><span class="line">    pthread_mutexattr_t mutexattr;</span><br><span class="line">    pthread_mutexattr_init(&amp;mutexattr);</span><br><span class="line">    pthread_mutexattr_settype(&amp;mutexattr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">    pthread_mutex_init(&amp;notifyingInfo-&gt;mutex, &amp;mutexattr);</span><br><span class="line">    pthread_mutexattr_destroy(&amp;mutexattr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取NSObject类的 willChangeValueForKey 和 didChangeValueForKey实现</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> <span class="built_in">NSObjectIMPLookupOnce</span>;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;<span class="built_in">NSObjectIMPLookupOnce</span>, ^&#123;</span><br><span class="line">        <span class="built_in">NSObjectWillChange</span> = class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(d_willChangeValueForKey:));</span><br><span class="line">        <span class="built_in">NSObjectDidChange</span> = class_getMethodImplementation([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(d_didChangeValueForKey:));</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断originalClass类是否重写了 willChangeValueForKey 或  didChangeValueForKey</span></span><br><span class="line">    <span class="comment">// 就是拿NSObject的实现与originalClass的实现做对比(函数指针IMP比较)</span></span><br><span class="line">    notifyingInfo-&gt;overrideWillOrDidChange = class_getMethodImplementation(notifyingInfo-&gt;originalClass, <span class="keyword">@selector</span>(d_willChangeValueForKey:)) != <span class="built_in">NSObjectWillChange</span> || class_getMethodImplementation(notifyingInfo-&gt;originalClass, <span class="keyword">@selector</span>(d_didChangeValueForKey:)) != <span class="built_in">NSObjectDidChange</span>;</span><br><span class="line">    <span class="comment">// 对notifyingInfo的originalClass添加 _isKVOA方法</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, ISKVOA_SELECTOR, (IMP)<span class="built_in">NSKVOIsAutonotifying</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 对notifyingInfo的originalClass添加 dealloc方法</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, <span class="keyword">@selector</span>(dealloc), (IMP)<span class="built_in">NSKVODeallocate</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 对notifyingInfo的originalClass添加 class方法</span></span><br><span class="line">    <span class="built_in">NSKVONotifyingSetMethodImplementation</span>(notifyingInfo, <span class="keyword">@selector</span>(<span class="keyword">class</span>), (IMP)<span class="built_in">NSKVOClass</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> notifyingInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加-isKVOA方法"><a href="#添加-isKVOA方法" class="headerlink" title="添加_isKVOA方法"></a>添加_isKVOA方法</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> <span class="built_in">NSKVOIsAutonotifying</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重写class方法"><a href="#重写class方法" class="headerlink" title="重写class方法"></a>重写class方法</h4><figure class="highlight monkey"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">NSKVOClass</span>(<span class="title">id</span> <span class="title">object</span>, <span class="title">SEL</span> <span class="title">selector</span>) &#123;</span></span><br><span class="line">    // 新的<span class="class"><span class="keyword">class</span>: <span class="title">NSKVONotifying_XXXX</span></span></span><br><span class="line">    <span class="class"><span class="keyword">Class</span> <span class="title">currentClass</span> = <span class="title">object_getClass</span>(<span class="title">object</span>);</span></span><br><span class="line">    // 原先的<span class="class"><span class="keyword">class</span>: <span class="title">XXXX</span></span></span><br><span class="line">    <span class="class"><span class="keyword">Class</span> <span class="title">originalClass</span> =  <span class="title">_NSKVONotifyingOriginalClassForIsa</span>(<span class="title">currentClass</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (currentClass == originalClass) &#123;</span><br><span class="line">        // 相同, 返回object的currentClass</span><br><span class="line">        <span class="function"><span class="keyword">Method</span> <span class="title">m</span> =</span> class_getInstanceMethod(currentClass, selector);</span><br><span class="line">        <span class="keyword">return</span> ((<span class="class"><span class="keyword">Class</span> (*)(<span class="title">id</span>,<span class="title">Method</span>))<span class="title">method_invoke</span>)(<span class="title">object</span>, <span class="title">m</span>);</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        // 不同, 返回originalClass</span><br><span class="line">        <span class="keyword">return</span> [originalClass <span class="class"><span class="keyword">class</span>];</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重写dealloc方法"><a href="#重写dealloc方法" class="headerlink" title="重写dealloc方法"></a>重写dealloc方法</h4><p>获取<code>object</code>对应的<code>observationInfo</code>(对象)并把它放到结构体中，在调用完<code>object</code>原先的<code>dealloc</code>方法之后判断<code>observationInfo</code>是否还存在，若存在说明<code>observer</code>没有在<code>dealloc</code>之前被移除掉，进而抛出异常。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="built_in">NSKVODeallocate</span>(<span class="keyword">id</span> object, SEL selector) &#123;</span><br><span class="line">    <span class="comment">// 获取object对应的observationInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *observationInfo = _NSKeyValueRetainedObservationInfoForObject(object, <span class="literal">nil</span>);</span><br><span class="line">    ObservationInfoWatcher watcher = &#123;object, observationInfo, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    _NSKeyValueAddObservationInfoWatcher(&amp;watcher);</span><br><span class="line">    <span class="comment">// 获取notifyInfo</span></span><br><span class="line">    <span class="built_in">NSKeyValueNotifyingInfo</span> *notifyInfo = (<span class="built_in">NSKeyValueNotifyingInfo</span> *)object_getIndexedIvars(object_getClass(object));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用object原来的dealloc实现</span></span><br><span class="line">    Method originDellocMethod = class_getInstanceMethod(notifyInfo-&gt;originalClass, selector);</span><br><span class="line">    ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>,Method))method_invoke)(object, originDellocMethod);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(watcher.observationInfo) &#123;</span><br><span class="line">            <span class="comment">// observationInfo不存在才对, 如果还存在, 说明没有正确地移除observer</span></span><br><span class="line">            <span class="built_in">BOOL</span> keyExistsAndHasValidFormat = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">BOOL</span> cleansUpBeforeThrowing = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            cleansUpBeforeThrowing = (<span class="built_in">BOOL</span>)<span class="built_in">CFPreferencesGetAppBooleanValue</span>(<span class="built_in">CFSTR</span>(<span class="string">"NSKVODeallocateCleansUpBeforeThrowing"</span>), kCFPreferencesCurrentApplication, (Boolean *)&amp;keyExistsAndHasValidFormat);</span><br><span class="line">            <span class="comment">// key存在且key对应的value为YES</span></span><br><span class="line">            cleansUpBeforeThrowing = cleansUpBeforeThrowing &amp;&amp; keyExistsAndHasValidFormat;</span><br><span class="line">            <span class="comment">// dyld_get_program_sdk_version返回系统版本</span></span><br><span class="line">            <span class="keyword">if</span> (dyld_get_program_sdk_version() &gt; <span class="number">0x7FFFF</span> || cleansUpBeforeThrowing) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cleansUpBeforeThrowing) &#123;</span><br><span class="line">                    _NSKeyValueRemoveObservationInfoForObject(object, watcher.observationInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                [<span class="built_in">NSException</span> raise:<span class="built_in">NSInternalInconsistencyException</span> format:<span class="string">@"An instance %p of class %@ was deallocated while key value observers were still registered with it. Current observation info: %@"</span>, object, notifyInfo-&gt;originalClass, watcher.observationInfo];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSKVODeallocateBreak</span>(object);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">        [exception raise];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@finally</span> &#123;</span><br><span class="line">        <span class="comment">// 移除watcher</span></span><br><span class="line">        _NSKeyValueRemoveObservationInfoWatcher(&amp;watcher);</span><br><span class="line">        </span><br><span class="line">        [watcher.observationInfo release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-回调通知"><a href="#4-回调通知" class="headerlink" title="4.回调通知"></a>4.回调通知</h2><p>上文分析，<code>NSKeyValueNotifyObserver()</code>就是回调的函数，通过它调用<code>observeValueForKeyPath:ofObject:change:context:</code>方法。这里还剩下最后一个问题，回调是怎么处理的?</p>
<p>在<code>NSKVONotifyingEnableForInfoAndKey()</code>函数中重写setter方法，之后在<code>NSSetPrimitiveValueAndNotify()</code>函数中先调用<code>willChangeValueForKey</code>，再调用原先的setter方法，再调用<code>didChangeValueForKey</code>。</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">static inline void NSSetPrimitiveValueAndNotify(id object,SEL selector, void (^setValueWithImplementation)(IMP imp)) &#123;</span><br><span class="line">    NSKeyValueNotifyingInfo *info = object_getIndexedIvars(object_getClass(object));</span><br><span class="line">    <span class="function"><span class="title">pthread_mutex_lock</span>(&amp;info-&gt;</span>mutex);</span><br><span class="line">    NSS<span class="function"><span class="title">tring</span> *key = CFDictionaryGetValue(info-&gt;</span>selKeyMap, selector);</span><br><span class="line">    key = [key copyWithZone:<span class="literal">nil</span>];</span><br><span class="line">    <span class="function"><span class="title">pthread_mutex_unlock</span>(&amp;info-&gt;</span>mutex);</span><br><span class="line">    <span class="function"><span class="title">if</span> (info-&gt;</span>overrideWillOrDidChange) &#123;</span><br><span class="line">        [object willChangeValueForKey:key];</span><br><span class="line">        IMP <span class="function"><span class="title">imp</span> = class_getMethodImplementation(info-&gt;</span>originalClass, selector);</span><br><span class="line">        setValueWithImplementation(imp);</span><br><span class="line">        [object didChangeValueForKey:key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [object changeValueForKey:key key:<span class="literal">nil</span> key:<span class="literal">nil</span> usingBlock:^&#123;</span><br><span class="line">            IMP <span class="function"><span class="title">imp</span> = class_getMethodImplementation(info-&gt;</span>originalClass, selector);</span><br><span class="line">            setValueWithImplementation(imp);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    [key release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，这里的<code>didChangeValueForKey</code>也被重写实现了，它会调用真正的回调<code>observeValueForKeyPath:ofObject:change:context:</code>方法。</p>
<h1 id="五、移除观察者"><a href="#五、移除观察者" class="headerlink" title="五、移除观察者"></a>五、移除观察者</h1><p>找到NSKeyValueObservance移除即可。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSKeyValueObservationInfo</span> *_NSKeyValueObservationInfoCreateByRemoving(<span class="built_in">NSKeyValueObservationInfo</span> *baseObservationInfo, <span class="keyword">id</span> observer, <span class="built_in">NSKeyValueProperty</span> *property, <span class="keyword">void</span> *context, <span class="built_in">BOOL</span> shouldCompareContext,  <span class="keyword">id</span> originalObservable,  <span class="built_in">BOOL</span> *cacheHit, <span class="built_in">NSKeyValueObservance</span> **removalObservance) &#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservationInfo</span> *createdObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前已经存在的observance的数量</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> observanceCount = <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)baseObservationInfo.observances);</span><br><span class="line">    <span class="built_in">NSKeyValueObservance</span> *observancesBuff[observanceCount];</span><br><span class="line">    <span class="built_in">CFArrayGetValues</span>((<span class="built_in">CFArrayRef</span>)baseObservationInfo.observances, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, observanceCount), (<span class="keyword">const</span> <span class="keyword">void</span> **)observancesBuff);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSUInteger</span> removalObservanceIndex = <span class="built_in">NSNotFound</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = observanceCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="comment">// 逐个遍历observancesBuff数组中的元素</span></span><br><span class="line">        <span class="built_in">NSKeyValueObservance</span> *observance = observancesBuff[i];</span><br><span class="line">        <span class="comment">// property和observer一致</span></span><br><span class="line">        <span class="keyword">if</span> (observance.property == property &amp;&amp; observance.observer == observer) &#123;</span><br><span class="line">            <span class="comment">// 不需要比较context或者context一致</span></span><br><span class="line">            <span class="keyword">if</span> (!shouldCompareContext || observance.context == context) &#123;</span><br><span class="line">                <span class="comment">// originalObservable一致</span></span><br><span class="line">                <span class="keyword">if</span> (!originalObservable || observance.originalObservable == originalObservable) &#123;</span><br><span class="line">                    <span class="comment">// 需要移除的observance</span></span><br><span class="line">                    *removalObservance = observance;</span><br><span class="line">                    <span class="comment">// 确定了将要移除的observance的索引</span></span><br><span class="line">                    removalObservanceIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 已经找到需要移除的observance</span></span><br><span class="line">    <span class="keyword">if</span> (*removalObservance) &#123;</span><br><span class="line">        <span class="comment">// 原先observance的数量大于1个</span></span><br><span class="line">        <span class="keyword">if</span> (observanceCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            os_lock_lock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">            <span class="comment">// NSKeyValueShareableObservationInfos缓存不存在, 创建</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">NSKeyValueShareableObservationInfos</span>) &#123;</span><br><span class="line">                <span class="built_in">NSPointerFunctions</span> *functions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">                [functions setHashFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>];</span><br><span class="line">                [functions setIsEqualFunction:<span class="built_in">NSKeyValueShareableObservationInfoNSHTIsEqual</span>];</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSKeyValueShareableObservationInfos</span> = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:functions capacity:<span class="number">0</span>];</span><br><span class="line">                </span><br><span class="line">                [functions release];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span>) &#123;</span><br><span class="line">                <span class="comment">// 就是NSKeyValueShareableObservationInfoKey.class</span></span><br><span class="line">                <span class="built_in">NSKeyValueShareableObservationInfoKeyIsa</span> = <span class="built_in">NSKeyValueShareableObservationInfoKey</span>.self;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">static</span> <span class="built_in">NSKeyValueShareableObservationInfoKey</span> * shareableObservationInfoKey = <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// 构建查找缓存的Key</span></span><br><span class="line">            <span class="keyword">if</span> (!shareableObservationInfoKey) &#123;</span><br><span class="line">                shareableObservationInfoKey = [[<span class="built_in">NSKeyValueShareableObservationInfoKey</span> alloc] init];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            shareableObservationInfoKey.addingNotRemoving = <span class="literal">NO</span>;</span><br><span class="line">            shareableObservationInfoKey.baseObservationInfo = baseObservationInfo;</span><br><span class="line">            shareableObservationInfoKey.removalObservance = *removalObservance;</span><br><span class="line">            shareableObservationInfoKey.removalObservanceIndex = removalObservanceIndex;</span><br><span class="line">            shareableObservationInfoKey.cachedHash = <span class="built_in">NSKeyValueShareableObservationInfoNSHTHash</span>(shareableObservationInfoKey, <span class="literal">NULL</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 尝试在缓存中查找NSKeyValueObservationInfo</span></span><br><span class="line">            <span class="built_in">NSKeyValueObservationInfo</span> *existsObservationInfo = [<span class="built_in">NSKeyValueShareableObservationInfos</span> member:shareableObservationInfoKey];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重置key的数据</span></span><br><span class="line">            shareableObservationInfoKey.removalObservance = <span class="literal">nil</span>;</span><br><span class="line">            shareableObservationInfoKey.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSUInteger</span> cachedHash = shareableObservationInfoKey.cachedHash;</span><br><span class="line">            </span><br><span class="line">            shareableObservationInfoKey.cachedHash = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!existsObservationInfo) &#123;</span><br><span class="line">                <span class="comment">// 在缓存中没有找到, 移除removalObservanceIndex对应的元素</span></span><br><span class="line">                memmove(observancesBuff + removalObservanceIndex, observancesBuff + removalObservanceIndex + <span class="number">1</span>, (observanceCount - (removalObservanceIndex + <span class="number">1</span>)) * <span class="keyword">sizeof</span>(<span class="built_in">NSKeyValueObservance</span> *));</span><br><span class="line">                <span class="comment">// 重新创建ObservationInfo, 数量为observanceCount - 1</span></span><br><span class="line">                createdObservationInfo = [[<span class="built_in">NSKeyValueObservationInfo</span> alloc] _initWithObservances:observancesBuff count:observanceCount - <span class="number">1</span> hashValue:cachedHash];</span><br><span class="line">                <span class="keyword">if</span> (createdObservationInfo.cachedIsShareable) &#123;</span><br><span class="line">                    <span class="comment">// 缓存ObservationInfo</span></span><br><span class="line">                    [<span class="built_in">NSKeyValueShareableObservationInfos</span> addObject:createdObservationInfo];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 没有命中缓存</span></span><br><span class="line">                *cacheHit = <span class="literal">NO</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 命中缓存</span></span><br><span class="line">                *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">                <span class="comment">// 直接赋值existsObservationInfo</span></span><br><span class="line">                createdObservationInfo = [existsObservationInfo <span class="keyword">retain</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            os_lock_unlock(&amp;<span class="built_in">NSKeyValueObservationInfoCreationSpinLock</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> createdObservationInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 原先只有一个observance, 命中缓存</span></span><br><span class="line">            *cacheHit = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有找到需要移除的observance, 返回nil</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="六、KVO自实现"><a href="#六、KVO自实现" class="headerlink" title="六、KVO自实现"></a>六、KVO自实现</h1><p>有很多同学尝试自己实现了KVO，有按照原生接口的，也有自我发挥直接传递block的。由于之前我已经读过一些开源的代码，见<a href="https://blog.chenyalun.com/2019/01/12/「KVOController」的封装/">《「KVOController」的封装》</a>，作者就是使用了block很好地封装了KVO的回调。所以，这里还是试着按照原生接口实现一下。</p>
<p>由于对源码理解地不是十分透彻，再加上能力有限，在尝试实现过程中遇到不少问题，幸好都解决了。当然，代码肯定有不少问题的，而且仅仅实现一点核心功能，姑且当做玩具看看吧。</p>
<h2 id="1-接口"><a href="#1-接口" class="headerlink" title="1.接口"></a>1.接口</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="meta">@interface</span> NSObject(YAKVO)</span><br><span class="line"><span class="meta">@property</span> <span class="keyword">void</span> *ya_observationInfo;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_willChangeValueForKey:</span>(NSString *)key;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_didChangeValueForKey:</span>(NSString *)key;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_addObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_removeObserver:</span>(NSObject *)observer <span class="string">forKeyPath:</span>(NSString *)keyPath <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">ya_observeValueForKeyPath:</span>(NSString *)keyPath <span class="string">ofObject:</span>(id)object <span class="string">change:</span>(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change <span class="string">context:</span>(<span class="keyword">void</span> *)context;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="2-实现"><a href="#2-实现" class="headerlink" title="2.实现"></a>2.实现</h2><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#define ClassPrefixCStr <span class="meta-string">"YAKVONotifying_"</span> // 新类的前缀</span></span><br><span class="line"><span class="meta">#define ClassPrefix     @ ClassPrefixCStr</span></span><br><span class="line"><span class="meta">#define OBSERVATION_INFO_KEY(object) ((void *)(~(NSUInteger)(object)))</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *YAKeyValueChangeDictionary = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 一些私有方法和属性</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span>(<span class="title">YAKVOPrivate</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">YAKVOPrivate</span>)</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)ya_isKVOClass &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_changeValueForKey:(<span class="built_in">NSString</span> *)key usingBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">    [<span class="keyword">self</span> ya_willChangeValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (block) block();</span><br><span class="line">    [<span class="keyword">self</span> ya_didChangeValueForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 包装keyPath和originalClass</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueProperty</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) Class isaForAutonotifying;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *keyPath;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) Class originalClass;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOriginalClass:(Class)originalClass keyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueProperty</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOriginalClass:(Class)originalClass</span><br><span class="line">                              keyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _originalClass = originalClass;</span><br><span class="line">        _keyPath = keyPath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)isaForAutonotifying &#123;</span><br><span class="line">    <span class="comment">// 构造新的子类名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalClassName = class_getName(_originalClass);</span><br><span class="line">    size_t size = strlen(originalClassName) + <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">char</span> *newClassName = (<span class="keyword">char</span> *)malloc(size);</span><br><span class="line">    </span><br><span class="line">    strlcpy(newClassName, ClassPrefixCStr, size);</span><br><span class="line">    strlcat(newClassName, originalClassName, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建子类</span></span><br><span class="line">    Class newSubClass = objc_allocateClassPair(_originalClass, newClassName, <span class="number">0</span>);</span><br><span class="line">    objc_registerClassPair(newSubClass);</span><br><span class="line">    free(newClassName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Setter方法替换</span></span><br><span class="line">    <span class="built_in">NSString</span> *uppercase= [[_keyPath substringToIndex:<span class="number">1</span>] uppercaseString];</span><br><span class="line">    <span class="built_in">NSString</span> *last = [_keyPath substringFromIndex:<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *<span class="keyword">setter</span> = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>, uppercase, last];</span><br><span class="line">    SEL sel = <span class="built_in">NSSelectorFromString</span>(<span class="keyword">setter</span>);</span><br><span class="line">    Method method = class_getInstanceMethod(newSubClass, sel);</span><br><span class="line">    <span class="keyword">if</span> (method) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = method_getTypeEncoding(method);</span><br><span class="line">        class_replaceMethod(newSubClass, sel, (IMP)YASetValueAndNotifyForKey, typeEncoding);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [[<span class="built_in">NSException</span> exceptionWithName:<span class="string">@"缺少参数"</span> reason:<span class="string">@"没有实现Setter方法"</span> userInfo:<span class="literal">nil</span>] raise];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// class方法替换、ya_isKVOClass方法替换</span></span><br><span class="line">    YAKVONotifyingSetMethodImplementation(newSubClass, <span class="keyword">@selector</span>(ya_isKVOClass), (IMP)YAKVOIsAutonotifying);</span><br><span class="line">    YAKVONotifyingSetMethodImplementation(newSubClass, <span class="keyword">@selector</span>(<span class="keyword">class</span>), (IMP)YAKVOClass);</span><br><span class="line">    <span class="keyword">return</span> newSubClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应originalClass的ya_isKVOClass方法</span></span><br><span class="line"><span class="built_in">BOOL</span> YAKVOIsAutonotifying(<span class="keyword">id</span> object, SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应originalClass的class方法</span></span><br><span class="line">Class YAKVOClass(<span class="keyword">id</span> object, SEL sel) &#123;</span><br><span class="line">    <span class="comment">// 新的class: NSKVONotifying_XXXX</span></span><br><span class="line">    Class currentClass = object_getClass(object);</span><br><span class="line">    <span class="keyword">if</span> ([object ya_isKVOClass]) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *clsStr = [<span class="built_in">NSStringFromClass</span>(currentClass) stringByReplacingOccurrencesOfString:ClassPrefix withString:<span class="string">@""</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应originalClass的setter方法</span></span><br><span class="line"><span class="keyword">void</span> YASetValueAndNotifyForKey(<span class="keyword">id</span> obj, SEL sel, <span class="keyword">id</span> value, IMP imp) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *key = [[<span class="built_in">NSStringFromSelector</span>(sel) substringFromIndex:<span class="number">3</span>] lowercaseString];</span><br><span class="line">    key = [key substringToIndex:key.length - <span class="number">1</span>];</span><br><span class="line">    [obj ya_changeValueForKey:key usingBlock:^&#123;</span><br><span class="line">        Class cls = [obj <span class="keyword">class</span>];</span><br><span class="line">        <span class="comment">// 调用父类的setter方法</span></span><br><span class="line">        IMP superImp = class_getMethodImplementation(cls, sel);</span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span> ,SEL , <span class="keyword">id</span>))superImp)(obj, sel, value);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对某个class添加实例方法</span></span><br><span class="line"><span class="keyword">void</span> YAKVONotifyingSetMethodImplementation(Class cls, SEL sel, IMP imp) &#123;</span><br><span class="line">    Method originMethod = class_getInstanceMethod(cls, sel);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *encoding = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (originMethod) &#123;</span><br><span class="line">        encoding = method_getTypeEncoding(originMethod);</span><br><span class="line">        class_addMethod(cls, sel, imp, encoding);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 包装property、observer、context、options</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservance</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) YAKeyValueProperty *property;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> observer;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">void</span> *context;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> options;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">id</span>)observer property:(YAKeyValueProperty *)property options:(<span class="keyword">int</span>)options context:(<span class="keyword">void</span> *)context;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservance</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObserver:(<span class="keyword">id</span>)observer</span><br><span class="line">                        property:(YAKeyValueProperty *)property</span><br><span class="line">                         options:(<span class="keyword">int</span>)options</span><br><span class="line">                         context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _observer = observer;</span><br><span class="line">        _property = property;</span><br><span class="line">        _options = options;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> observerContextHash = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-%p"</span>, _observer, _context] hash];</span><br><span class="line">    <span class="keyword">return</span> observerContextHash ^ _property.hash ^ _options;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isKindOfClass:object_getClass(<span class="keyword">self</span>)]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    YAKeyValueObservance *other = (YAKeyValueObservance *)object;</span><br><span class="line">    <span class="keyword">return</span> other.observer == <span class="keyword">self</span>.observer &amp;&amp;</span><br><span class="line">    other.options == <span class="keyword">self</span>.options &amp;&amp;</span><br><span class="line">    other.context == <span class="keyword">self</span>.context;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 包装YAKeyValueObservance数组</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservationInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observances;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObservances:(<span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *)observances</span><br><span class="line">                              count:(<span class="built_in">NSUInteger</span>)count;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservationInfo</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithObservances:(<span class="built_in">NSArray</span>&lt;YAKeyValueObservance *&gt; *)observances</span><br><span class="line">                              count:(<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _observances = [[<span class="built_in">NSArray</span> alloc] initWithArray:observances];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 配置YAKeyValueObservationInfoKey，去查询匹配的YAKeyValueObservationInfo</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YAKeyValueObservationInfoKey</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) YAKeyValueObservationInfo *baseObservationInfo;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSObject</span> *additionObserver;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) YAKeyValueProperty *additionProperty;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> additionOptions;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">void</span>* additionContext;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YAKeyValueObservationInfoKey</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private methods</span></span><br><span class="line"><span class="built_in">BOOL</span> YAKeyValuePropertyIsEqual(YAKeyValueProperty *property1, YAKeyValueProperty *property2) &#123;</span><br><span class="line">    <span class="keyword">return</span> (property1.originalClass == property2.originalClass) &amp;&amp;</span><br><span class="line">    (property1.keyPath == property2.keyPath || [property1.keyPath isEqual: property2.keyPath]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSUInteger</span> YAKeyValuePropertyHash(YAKeyValueProperty *property) &#123;</span><br><span class="line">    <span class="keyword">return</span> property.keyPath.hash ^ (<span class="built_in">NSUInteger</span>)(__bridge <span class="keyword">void</span> *)property.originalClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取YAKeyValueProperty</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> YAKeyValueProperty *getKeyValueProperty(Class cls, <span class="built_in">NSString</span> *keyPath) &#123;</span><br><span class="line">    <span class="comment">// 缓存集合</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableSetRef</span> YAKeyValueProperties;</span><br><span class="line">    <span class="keyword">if</span>(!YAKeyValueProperties) &#123;</span><br><span class="line">        <span class="comment">// 创建YAKeyValueProperties</span></span><br><span class="line">        <span class="built_in">CFSetCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        callbacks.version =  kCFTypeSetCallBacks.version;</span><br><span class="line">        callbacks.retain =  kCFTypeSetCallBacks.retain;</span><br><span class="line">        callbacks.release =  kCFTypeSetCallBacks.release;</span><br><span class="line">        callbacks.copyDescription =  kCFTypeSetCallBacks.copyDescription;</span><br><span class="line">        callbacks.equal =  (<span class="built_in">CFSetEqualCallBack</span>)YAKeyValuePropertyIsEqual;</span><br><span class="line">        callbacks.hash =  (<span class="built_in">CFSetHashCallBack</span>)YAKeyValuePropertyHash;</span><br><span class="line">        YAKeyValueProperties = <span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueProperty *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) finder = [YAKeyValueProperty new];</span><br><span class="line">    finder.originalClass = cls;</span><br><span class="line">    finder.keyPath = keyPath;</span><br><span class="line">    YAKeyValueProperty *property = <span class="built_in">CFSetGetValue</span>(YAKeyValueProperties, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(finder));</span><br><span class="line">    <span class="keyword">if</span> (!property) &#123;</span><br><span class="line">        <span class="comment">// 缓存中没有找到, 创建</span></span><br><span class="line">        property = [[YAKeyValueProperty alloc] initWithOriginalClass:cls keyPath:keyPath];</span><br><span class="line">        <span class="comment">// 添加到缓存中</span></span><br><span class="line">        <span class="built_in">CFSetAddValue</span>(YAKeyValueProperties, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(property));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> property;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取YAKeyValueObservance</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> YAKeyValueObservance *getKeyValueObservance(YAKeyValueProperty *property,</span><br><span class="line">                                                          <span class="keyword">id</span> observer,</span><br><span class="line">                                                          <span class="keyword">void</span> *context,</span><br><span class="line">                                                          <span class="keyword">int</span> options) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSHashTable</span> *YAKeyValueShareableObservances;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueShareableObservances) &#123;</span><br><span class="line">        YAKeyValueShareableObservances = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueObservance *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) finder = [YAKeyValueObservance new];</span><br><span class="line">    finder.property = property;</span><br><span class="line">    finder.context = context;</span><br><span class="line">    finder.observer = observer;</span><br><span class="line">    finder.options = options;</span><br><span class="line">    YAKeyValueObservance *observance = [YAKeyValueShareableObservances member:finder];</span><br><span class="line">    <span class="keyword">if</span> (!observance) &#123;</span><br><span class="line">        <span class="comment">// 缓存中没有找到, 创建</span></span><br><span class="line">        observance = [[YAKeyValueObservance alloc] initWithObserver:observer property:property options:options context:context];</span><br><span class="line">        <span class="comment">// 添加到缓存中</span></span><br><span class="line">        [YAKeyValueShareableObservances addObject:observance];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSUInteger</span> YAKeyValueObservationInfoNSHTHash(<span class="keyword">const</span> <span class="keyword">void</span> *item, <span class="built_in">NSUInteger</span> (*size)(<span class="keyword">const</span> <span class="keyword">void</span> *item)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">        YAKeyValueObservationInfoKey *key = (__bridge YAKeyValueObservationInfoKey *)item;</span><br><span class="line">        <span class="keyword">return</span> key.baseObservationInfo.observances.firstObject.hash;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        YAKeyValueObservationInfo *info = (__bridge YAKeyValueObservationInfo *)item;</span><br><span class="line">        <span class="keyword">return</span> info.observances.firstObject.hash;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> YAKeyValueObservationInfoNSHTIsEqual(<span class="keyword">const</span> <span class="keyword">void</span> *item1, <span class="keyword">const</span> <span class="keyword">void</span> *item2, <span class="built_in">NSUInteger</span> (* size)(<span class="keyword">const</span> <span class="keyword">void</span> * item)) &#123;</span><br><span class="line">    <span class="comment">// 这里仅仅写了YAKeyValueObservationInfoKey与YAKeyValueObservationInfo的比较</span></span><br><span class="line">    <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item1) == YAKeyValueObservationInfoKey.class || object_getClass((__bridge <span class="keyword">id</span>)item2) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">        YAKeyValueObservationInfo *info = <span class="literal">nil</span>;</span><br><span class="line">        YAKeyValueObservationInfoKey *key = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确定哪一个是info, 哪一个是key</span></span><br><span class="line">        <span class="keyword">if</span> (object_getClass((__bridge <span class="keyword">id</span>)item1) == YAKeyValueObservationInfoKey.class) &#123;</span><br><span class="line">            info = (__bridge YAKeyValueObservationInfo *)item2;</span><br><span class="line">            key = (__bridge YAKeyValueObservationInfoKey *)item1;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            info = (__bridge YAKeyValueObservationInfo *)item1;</span><br><span class="line">            key = (__bridge YAKeyValueObservationInfoKey *)item2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observancesInKey = key.baseObservationInfo.observances;</span><br><span class="line">        <span class="built_in">NSArray</span> &lt;YAKeyValueObservance *&gt; *observancesInInfo = info.observances;</span><br><span class="line">        <span class="comment">// key中observance的数量</span></span><br><span class="line">        <span class="built_in">NSUInteger</span> countInkey = observancesInKey.count;</span><br><span class="line">        <span class="comment">// info中observance的数量</span></span><br><span class="line">        <span class="built_in">NSUInteger</span> countInInfo = observancesInInfo.count;</span><br><span class="line">        <span class="keyword">if</span> (countInkey != countInInfo) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; countInkey; i++) &#123;</span><br><span class="line">            <span class="comment">// 保证每个observance完全匹配</span></span><br><span class="line">            <span class="keyword">if</span> (observancesInKey[i] != observancesInInfo[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Public methods</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span>(<span class="title">YAKVO</span>)</span></span><br><span class="line"><span class="built_in">CFMutableDictionaryRef</span> YAKeyValueObservationInfoPerObject = <span class="literal">NULL</span>;</span><br><span class="line">- (<span class="keyword">void</span> *)ya_observationInfo &#123;</span><br><span class="line">    <span class="keyword">return</span> YAKeyValueObservationInfoPerObject ? (<span class="keyword">void</span> *)<span class="built_in">CFDictionaryGetValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>)) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setYa_observationInfo:(<span class="keyword">void</span> *)info &#123;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueObservationInfoPerObject) &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryValueCallBacks</span> callbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        callbacks.version = kCFTypeDictionaryKeyCallBacks.version;</span><br><span class="line">        callbacks.retain = kCFTypeDictionaryKeyCallBacks.retain;</span><br><span class="line">        callbacks.release = kCFTypeDictionaryKeyCallBacks.release;</span><br><span class="line">        callbacks.copyDescription = kCFTypeDictionaryKeyCallBacks.copyDescription;</span><br><span class="line">        YAKeyValueObservationInfoPerObject = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (info) &#123;</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>), info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryRemoveValue</span>(YAKeyValueObservationInfoPerObject, OBSERVATION_INFO_KEY(<span class="keyword">self</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_willChangeValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueChangeDictionary) &#123;</span><br><span class="line">        YAKeyValueChangeDictionary = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">id</span> oldValue = <span class="literal">nil</span>;</span><br><span class="line">    oldValue = [<span class="keyword">self</span> valueForKeyPath:key];</span><br><span class="line">    <span class="keyword">if</span> (!oldValue) oldValue = [<span class="built_in">NSNull</span> null];</span><br><span class="line">    [YAKeyValueChangeDictionary setObject:oldValue forKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_didChangeValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, key);</span><br><span class="line">        YAKeyValueObservationInfo *observation = <span class="keyword">self</span>.ya_observationInfo;</span><br><span class="line">        [observation.observances enumerateObjectsUsingBlock:^(YAKeyValueObservance *obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj.property isEqual:property]) &#123;</span><br><span class="line">                <span class="built_in">NSMutableDictionary</span> *change = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">                <span class="keyword">if</span> (obj.options &amp; <span class="built_in">NSKeyValueObservingOptionOld</span>) &#123;</span><br><span class="line">                    <span class="keyword">id</span> old = [YAKeyValueChangeDictionary objectForKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                    [change setObject:old forKey:<span class="string">@"old"</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    [YAKeyValueChangeDictionary removeObjectForKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-old"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (obj.options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">                    <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">                    newValue = [<span class="keyword">self</span> valueForKeyPath:key];</span><br><span class="line">                    <span class="keyword">if</span> (!newValue) newValue = [<span class="built_in">NSNull</span> null];</span><br><span class="line">                    [YAKeyValueChangeDictionary setObject:newValue forKey:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p-new"</span>, <span class="keyword">self</span>]];</span><br><span class="line">                    [change setObject:newValue forKey:<span class="string">@"new"</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                [obj.observer ya_observeValueForKeyPath:key ofObject:<span class="keyword">self</span> change:change context:<span class="literal">nil</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_addObserver:(<span class="built_in">NSObject</span> *)observer</span><br><span class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">               options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</span><br><span class="line">               context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, keyPath);</span><br><span class="line">    YAKeyValueObservance *observance = getKeyValueObservance(property, observer, context, options);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSHashTable</span> *YAKeyValueShareableObservationInfos;</span><br><span class="line">    <span class="keyword">if</span> (!YAKeyValueShareableObservationInfos) &#123;</span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *pointerFunctions = [[<span class="built_in">NSPointerFunctions</span> alloc] initWithOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span>];</span><br><span class="line">        [pointerFunctions setHashFunction:YAKeyValueObservationInfoNSHTHash];</span><br><span class="line">        [pointerFunctions setIsEqualFunction:YAKeyValueObservationInfoNSHTIsEqual];</span><br><span class="line">        YAKeyValueShareableObservationInfos = [[<span class="built_in">NSHashTable</span> alloc] initWithPointerFunctions:pointerFunctions capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> YAKeyValueObservationInfoKey *finder;</span><br><span class="line">    <span class="keyword">if</span> (!finder) &#123;</span><br><span class="line">        finder = [YAKeyValueObservationInfoKey new];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueObservationInfo *info = (__bridge <span class="keyword">id</span>)[<span class="keyword">self</span> ya_observationInfo];</span><br><span class="line">    finder.baseObservationInfo = info;</span><br><span class="line">    finder.additionObserver = observer;</span><br><span class="line">    finder.additionContext = context;</span><br><span class="line">    finder.additionOptions = options;</span><br><span class="line">    finder.additionProperty = property;</span><br><span class="line">    </span><br><span class="line">    YAKeyValueObservationInfo *observation = [YAKeyValueShareableObservationInfos member:finder];</span><br><span class="line">    <span class="comment">// 重置finder数据</span></span><br><span class="line">    finder.baseObservationInfo = <span class="literal">nil</span>;</span><br><span class="line">    finder.additionObserver = <span class="literal">nil</span>;</span><br><span class="line">    finder.additionContext = <span class="literal">NULL</span>;</span><br><span class="line">    finder.additionOptions = <span class="number">0</span>;</span><br><span class="line">    finder.additionProperty = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!observation) &#123;</span><br><span class="line">        <span class="comment">// 缓存中没有找到, 创建</span></span><br><span class="line">        observation = [[YAKeyValueObservationInfo alloc] initWithObservances:@[observance] count:<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 添加到缓存中</span></span><br><span class="line">        [YAKeyValueShareableObservationInfos addObject:observation];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *buffer = [<span class="built_in">NSMutableArray</span> arrayWithArray:observation.observances];</span><br><span class="line">        [buffer addObject:observance];</span><br><span class="line">        observation.observances = [<span class="built_in">NSArray</span> arrayWithArray:buffer];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.ya_observationInfo = (__bridge <span class="keyword">void</span> *)(observation);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        Class isaForAutonotifying = [property isaForAutonotifying];</span><br><span class="line">        <span class="comment">// 更改isa指针</span></span><br><span class="line">        object_setClass(<span class="keyword">self</span>, isaForAutonotifying);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionInitial</span>) &#123;</span><br><span class="line">        <span class="keyword">id</span> newValue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (options &amp; <span class="built_in">NSKeyValueObservingOptionNew</span>) &#123;</span><br><span class="line">            newValue = [<span class="keyword">self</span> valueForKeyPath:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!newValue) newValue = [<span class="built_in">NSNull</span> null]; <span class="comment">// 使用NSNull对象</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *change = @&#123;<span class="string">@"new"</span>: newValue&#125;;</span><br><span class="line">        [observer ya_observeValueForKeyPath:keyPath ofObject:<span class="keyword">self</span> change:change context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.ya_isKVOClass) &#123;</span><br><span class="line">        YAKeyValueProperty *property = getKeyValueProperty(<span class="keyword">self</span>.class, keyPath);</span><br><span class="line">        YAKeyValueObservationInfo *observation = <span class="keyword">self</span>.ya_observationInfo;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *diff = [<span class="built_in">NSMutableArray</span> arrayWithArray:observation.observances];</span><br><span class="line">        __block <span class="built_in">NSInteger</span> removeIdx = <span class="number">-1</span>;</span><br><span class="line">        [diff enumerateObjectsUsingBlock:^(YAKeyValueObservance *obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([obj.property isEqual:property] &amp;&amp; obj.observer == observer &amp;&amp; obj.context == context) &#123;</span><br><span class="line">                removeIdx = idx;</span><br><span class="line">                *stop = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">if</span> (removeIdx != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// 找到需要移除的元素</span></span><br><span class="line">            [diff removeObjectAtIndex:removeIdx];</span><br><span class="line">            observation.observances = [<span class="built_in">NSArray</span> arrayWithArray:diff];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ya_observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context&#123;&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="功能check"><a href="#功能check" class="headerlink" title="功能check"></a>功能check</h2><p>1.添加观察者与设置回调：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"> [<span class="keyword">self</span>.obj ya_addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="string">"NULL"</span>];</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)ya_observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, change);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">self</span>.obj.name = <span class="string">@"Aaron"</span>;</span><br><span class="line"><span class="keyword">self</span>.obj.name = <span class="string">@"Jack"</span>;</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:41:23.595046<span class="string">+0800</span> Aaron[24893:604622] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">    old = "&lt;null&gt;";</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:41:23.595215<span class="string">+0800</span> Aaron[24893:604622] &#123;</span><br><span class="line">    new = Jack;</span><br><span class="line">    old = Aaron;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.使用NSKeyValueObservingOptionInitial</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionInitial <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">self.obj.name = @<span class="string">"Aaron"</span>;</span><br></pre></td></tr></table></figure>
<p>打印<br><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-05</span><span class="number">-30</span> <span class="number">09</span>:<span class="type">45</span>:<span class="number">01.717131</span>+<span class="number">0800</span> Aaron[<span class="number">25010</span>:<span class="type">609398</span>] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type"></span>= <span class="string">"&lt;null&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.多次添加观察者</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">[self.obj <span class="string">ya_addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"name"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span><span class="string">"NULL"</span>];</span><br><span class="line">self.obj.name = @<span class="string">"Aaron"</span>;</span><br></pre></td></tr></table></figure>
<p>打印</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.625826<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.625992<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br><span class="line">2019<span class="string">-05</span><span class="string">-30</span> 09:47:20.626128<span class="string">+0800</span> Aaron[25107:613531] &#123;</span><br><span class="line">    new = Aaron;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的代码放到了github上：<a href="https://github.com/ChenYalun/Project/tree/master/KVO" target="_blank" rel="noopener">https://github.com/ChenYalun/Project/tree/master/KVO</a></p>
<h1 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h1><p>这里学到一个技巧：如何确认<code>NSUserDefaults</code>中某个key是否存在?</p>
<p>比如</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">BOOL result</span> = [NSUserDefaults.standardUserDefaults boolForKey:@<span class="string">"key"</span>];</span><br></pre></td></tr></table></figure>
<p>当result为NO时，怎么判断是存储键<code>@&quot;key&quot;</code>对应的value是NO，还是说压根就没有存过这个key呢?可以使用<code>CFPreferencesGetAppBooleanValue()</code>函数。<br>KVO中有这么一段代码:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> keyExistsAndHasValidFormat = <span class="literal">false</span>; <span class="comment">// key是否存在</span></span><br><span class="line"><span class="built_in">BOOL</span> cleansUpBeforeThrowing = <span class="literal">false</span>; <span class="comment">// 存储的值为YES或者NO</span></span><br><span class="line"></span><br><span class="line">cleansUpBeforeThrowing = (<span class="built_in">BOOL</span>)<span class="built_in">CFPreferencesGetAppBooleanValue</span>(<span class="built_in">CFSTR</span>(<span class="string">"key"</span>), kCFPreferencesCurrentApplication, (Boolean *)&amp;keyExistsAndHasValidFormat);</span><br><span class="line"><span class="comment">// 能判断出key存在</span></span><br><span class="line">cleansUpBeforeThrowing = cleansUpBeforeThrowing &amp;&amp; keyExistsAndHasValidFormat;</span><br></pre></td></tr></table></figure>
<p>好了，说正题，本文简单总结了KVO的原理，并尝试阅读源码，然而能力有限、时间有限，只能明白个大概。在应用场景方面，就是“观察”，实际开发中，监听UIScrollView（及其子类）的属性比较多。最后，给自己挖了个坑：<code>willChangeValueForKey:</code>和<code>didChangeValueForKey:</code>为什么要成对出现？哪天有时间了，再仔细看一看。</p>
<hr>
<p>KVO的源码来自：<a href="https://github.com/renjinkui2719/DIS_KVC_KVO" target="_blank" rel="noopener">https://github.com/renjinkui2719/DIS_KVC_KVO</a> 。感谢作者。</p>
<blockquote>
<p>参考文章<br><a href="http://southpeak.github.io/2015/04/23/cocoa-foundation-nskeyvalueobserving/" target="_blank" rel="noopener">Foundation: NSKeyValueObserving(KVO)</a><br><a href="https://tech.glowing.com/cn/implement-kvo/" target="_blank" rel="noopener">如何自己动手实现 KVO</a><br><a href="https://knightsj.github.io/2017/05/15/使用Block实现KVO/" target="_blank" rel="noopener">使用Block实现KVO</a><br><a href="https://blog.sunnyxx.com/2014/03/09/objc_kvo_secret/" target="_blank" rel="noopener">objc kvo简单探索</a><br><a href="http://chuquan.me/2018/12/12/kvo-principle/" target="_blank" rel="noopener">KVO 原理详解</a> </p>
</blockquote>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/iOS开发/">iOS开发</a>
            
              <a href="/tags/阅读/">阅读</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/07/31/数据结构的Swift实现/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">数据结构的Swift实现</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2019/05/05/详解Key-Value Coding源码/">
        <span class="next-text nav-default">详解Key-Value Coding源码</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ChenYalun" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://weibo.com/icqk" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
      
        
          <a href="https://stackoverflow.com/users/7026915/allen" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    May Be 
  </span>
  
  <span class="theme-info">
    Better  
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even"> </a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ya</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  
  <script>
    var cloudTieConfig = {
      url: document.location.href, 
      sourceId: "",
      productKey: "f132359147224247aa1c3ad32d20490b",
      target: "cloud-tie-wrapper"
    };
  </script>
  <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>





    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
