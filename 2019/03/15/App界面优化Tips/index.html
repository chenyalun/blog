<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="Appç•Œé¢ä¼˜åŒ–Tips">




  <meta name="keywords" content="iOSå¼€å‘,é˜…è¯»,">




  <link rel="alternate" href="/atom.xml" title="Ya">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x">



<link rel="canonical" href="http://blog.chenyalun.com/2019/03/15/Appç•Œé¢ä¼˜åŒ–Tips/">


<meta name="description" content="Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚">
<meta name="keywords" content="iOSå¼€å‘,é˜…è¯»">
<meta property="og:type" content="article">
<meta property="og:title" content="Appç•Œé¢ä¼˜åŒ–Tips">
<meta property="og:url" content="http://blog.chenyalun.com/2019/03/15/Appç•Œé¢ä¼˜åŒ–Tips/index.html">
<meta property="og:site_name" content="Ya">
<meta property="og:description" content="Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-12-21T07:56:39.480Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Appç•Œé¢ä¼˜åŒ–Tips">
<meta name="twitter:description" content="Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">





<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  



    <title> Appç•Œé¢ä¼˜åŒ–Tips Â· Ya </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ya</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags/é˜…è¯»/">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ya</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              æ—¶é—´çº¿
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags/é˜…è¯»/">
            
            
              é˜…è¯»
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Appç•Œé¢ä¼˜åŒ–Tips
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019å¹´3æœˆ15æ—¥
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸€ã€åˆ—è¡¨è§†å›¾"><span class="toc-text">ä¸€ã€åˆ—è¡¨è§†å›¾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#å®šé«˜Cell"><span class="toc-text">å®šé«˜Cell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ï¼Œå¤ç”¨"><span class="toc-text">1ï¼Œå¤ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ï¼Œè®¾ç½®è¡Œé«˜"><span class="toc-text">2ï¼Œè®¾ç½®è¡Œé«˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ï¼Œæ¨¡å‹ç”Ÿæˆ"><span class="toc-text">3ï¼Œæ¨¡å‹ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4ï¼Œsubviewsæ“ä½œ"><span class="toc-text">4ï¼Œsubviewsæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“"><span class="toc-text">5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6ï¼Œåœ†è§’"><span class="toc-text">6ï¼Œåœ†è§’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7ï¼Œé˜´å½±"><span class="toc-text">7ï¼Œé˜´å½±</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸å®šé«˜cell"><span class="toc-text">ä¸å®šé«˜cell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#äºŒã€å¼‚æ­¥æ¸²æŸ“"><span class="toc-text">äºŒã€å¼‚æ­¥æ¸²æŸ“</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ¥å£"><span class="toc-text">æ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä½¿ç”¨"><span class="toc-text">ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å¼‚æ­¥ç»˜åˆ¶æ–‡å­—"><span class="toc-text">å¼‚æ­¥ç»˜åˆ¶æ–‡å­—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç é˜…è¯»"><span class="toc-text">æºç é˜…è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYSentinel"><span class="toc-text">YYSentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYTransaction"><span class="toc-text">YYTransaction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYAsyncLayer"><span class="toc-text">YYAsyncLayer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1ï¼Œå­çº¿ç¨‹çš„å¤„ç†"><span class="toc-text">1ï¼Œå­çº¿ç¨‹çš„å¤„ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶"><span class="toc-text">2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3ï¼Œç»˜åˆ¶æ—¶æœº"><span class="toc-text">3ï¼Œç»˜åˆ¶æ—¶æœº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4ï¼Œç»˜åˆ¶æ“ä½œ"><span class="toc-text">4ï¼Œç»˜åˆ¶æ“ä½œ</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸‰ã€å°ç»“"><span class="toc-text">ä¸‰ã€å°ç»“</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p></p><p align="center"> Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚</p><br><a id="more"></a><p></p>
<p>æœ¬æ¥è¿™ç¯‡æ–‡ç« åªæ˜¯é˜…è¯»YYAsyncLayeråçš„ä½“ä¼šï¼Œåæ¥ä¸€å†æ‰©å……ï¼Œå˜æˆäº†Appç•Œé¢ä¼˜åŒ–çš„å°Tipsã€‚ã€‚ã€‚</p>
<h1 id="ä¸€ã€åˆ—è¡¨è§†å›¾"><a href="#ä¸€ã€åˆ—è¡¨è§†å›¾" class="headerlink" title="ä¸€ã€åˆ—è¡¨è§†å›¾"></a>ä¸€ã€åˆ—è¡¨è§†å›¾</h1><h2 id="å®šé«˜Cell"><a href="#å®šé«˜Cell" class="headerlink" title="å®šé«˜Cell"></a>å®šé«˜Cell</h2><h3 id="1ï¼Œå¤ç”¨"><a href="#1ï¼Œå¤ç”¨" class="headerlink" title="1ï¼Œå¤ç”¨"></a>1ï¼Œå¤ç”¨</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kWBStatusCellIdentifier = <span class="string">@"kWBStatusCellIdentifier"</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView</span><br><span class="line">         cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    WBStatusCell *cell = [tableView dequeueReusableCellWithIdentifier:kWBStatusCellIdentifier forIndexPath:indexPath];</span><br><span class="line">    [cell setLayout:_layouts[indexPath.row]];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ‡å‡†åŒ–çš„å†™æ³•æ˜¯è¿™æ ·çš„ã€‚<code>dequeueReusableCellWithIdentifier:forIndexPath:</code>æ–¹æ³•æ¯”<code>dequeueReusableCellWithIdentifier:</code>æ–¹æ³•å¤šäº†â€œè‡ªåŠ¨åˆ›å»ºâ€ã€‚cellçš„é‡ç”¨IDæœ€å¥½ä½¿ç”¨é™æ€å¸¸é‡ï¼Œå°½ç®¡ç›´æ¥ä½¿ç”¨<code>@&quot;kWBStatusCellIdentifier&quot;</code>ï¼Œç¼–è¯‘å™¨å±‚é¢ä¹Ÿä¼šåšä¼˜åŒ–ï¼Œå¸®æˆ‘ä»¬ç”Ÿæˆé™æ€å¸¸é‡ï¼Œä½†æ˜¯æ„ä¹‰ä¸ä¸€æ ·ã€‚</p>
<p>cellçš„ç§ç±»ä¸è¦å¤ªå¤šï¼Œå°½é‡é€šè¿‡hidden subviewæ¥åŒºåˆ«ã€‚</p>
<h3 id="2ï¼Œè®¾ç½®è¡Œé«˜"><a href="#2ï¼Œè®¾ç½®è¡Œé«˜" class="headerlink" title="2ï¼Œè®¾ç½®è¡Œé«˜"></a>2ï¼Œè®¾ç½®è¡Œé«˜</h3><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">_tableView.rowHeight = <span class="number">60</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºæ˜¯å›ºå®šè¡Œé«˜ï¼Œç›´æ¥åœ¨é…ç½®TableViewçš„æ‡’åŠ è½½ä¸­ç›´æ¥è®¾ç½®rowHeightå±æ€§å³å¯ã€‚å¦‚æœä½¿ç”¨ä»£ç†ï¼Œä¼šä½¿TableViewå¤šæ¬¡è¯¢é—®ï¼Œå¢åŠ ä¸å¿…è¦çš„è°ƒç”¨ã€‚<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">CGFloat</span>)tableView:(<span class="built_in">UITableView</span> *)tableView heightForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">60</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œèƒ½ä½¿ç”¨æ•´æ•°çš„åœ°æ–¹å°±ä¸è¦ä½¿ç”¨å°æ•°ï¼Œ<code>60</code>è¦æ¯”<code>60.2</code>æ›´å¥½ä¸€ç‚¹ï¼ŒCPUä¸å–œæ¬¢å°æ•°ã€‚ä¸ä»…ä»…æŒ‡rowHeightè¿™ä¸ªå±æ€§ï¼Œå…¶ä»–è§†å›¾çš„widthã€heightç­‰å±æ€§ï¼Œåœ¨æ»¡è¶³UEè¦æ±‚çš„æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥å°½å¯èƒ½åœ°é‡‡ç”¨æ•´æ•°ã€‚</p>
<h3 id="3ï¼Œæ¨¡å‹ç”Ÿæˆ"><a href="#3ï¼Œæ¨¡å‹ç”Ÿæˆ" class="headerlink" title="3ï¼Œæ¨¡å‹ç”Ÿæˆ"></a>3ï¼Œæ¨¡å‹ç”Ÿæˆ</h3><p>é‡‡ç”¨MVVMï¼Œéœ€è¦å­—å…¸è½¬æ¨¡å‹ï¼›å»ModelåŒ–ï¼Œéœ€è¦æ ¼å¼åŒ–å­—å…¸ï¼›æ— è®ºæ€æ ·ï¼Œéƒ½è¦æŠŠæ•°æ®è½¬æ¢æˆè§†å›¾å–œæ¬¢çš„æ ·å­ï¼Œè¿™äº›æ“ä½œå°±å¯ä»¥æ”¾åˆ°å­çº¿ç¨‹ä¸­è¿›è¡Œã€‚å°¤å…¶æ˜¯é‡åˆ°DateFormatterã€stringWithFormatè¿™äº›ç¨å¾®è€—æ€§èƒ½çš„æ–¹æ³•ï¼Œè¯¥ç¼“å­˜å°±ç¼“å­˜ï¼Œè¯¥æ›¿æ¢å°±æ›¿æ¢ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">   <span class="comment">// å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">   WBTimelineItem *item = [WBTimelineItem modelWithJSON:data];</span><br><span class="line">   _statuses = item.statuses;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// ä¸»çº¿ç¨‹åˆ·æ–°</span></span><br><span class="line">   <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       [_tableView reloadData];</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="4ï¼Œsubviewsæ“ä½œ"><a href="#4ï¼Œsubviewsæ“ä½œ" class="headerlink" title="4ï¼Œsubviewsæ“ä½œ"></a>4ï¼Œsubviewsæ“ä½œ</h3><p>1ï¼Œå­è§†å›¾è¶Šå°‘ï¼Œå‡ºç°é—®é¢˜çš„å¯èƒ½æ€§ä¹Ÿè¶Šå°ã€‚æ‰€ä»¥åœ¨æ„æ€çš„æ—¶å€™ï¼Œä¸€ä¸ªè§†å›¾èƒ½è§£å†³çš„é—®é¢˜ï¼Œæ²¡å¿…è¦å¤šå†™å‡ ä¸ªè§†å›¾ã€‚æ¯”å¦‚éœ€è¦åœ¨åŒä¸€è¡Œå±•ç¤ºå†…å®¹aå’Œå†…å®¹bï¼Œå¯ä»¥è€ƒè™‘åªä½¿ç”¨ä¸€ä¸ªLabelã€‚<br>2ï¼Œè§†å›¾çš„åŠ¨æ€åˆ›å»ºå’Œé”€æ¯ä¹Ÿæ˜¯å¾ˆheavilyçš„ï¼Œè€ƒè™‘è®¾ç½®hiddenå±æ€§æ¥æ§åˆ¶æ˜¾ç¤ºå’Œéšè—ã€‚<br>3ï¼Œå°½é‡é€‰ç”¨è½»é‡çº§çš„æ§ä»¶ï¼Œä¸éœ€è¦ç”¨æˆ·å“åº”çš„å¯ä»¥æ¢æˆCALayerï¼Œæ¯”å¦‚CALayeræ›¿ä»£UIImageViewï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">CALayer</span> *)photoImageViewLayer &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_photoImageViewLayer) &#123;</span><br><span class="line">        _photoImageViewLayer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line">        _photoImageViewLayer.contentsGravity = <span class="string">@"resizeAspectFill"</span>;</span><br><span class="line">        _photoImageViewLayer.masksToBounds = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _photoImageViewLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®</span></span><br><span class="line">[<span class="keyword">self</span>.photoImageViewLayer yy_setImageWithURL:url</span><br><span class="line">                                    placeholder:<span class="built_in">UIImage</span>.randomColorImage</span><br><span class="line">                                        options:options</span><br><span class="line">                                    completion:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯CALayerä¸èƒ½è®¾ç½®çº¦æŸï¼Œè¿™å°±éœ€è¦è‡ªå·±è®¡ç®—frameäº†ã€‚</p>
<h3 id="5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“"><a href="#5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“" class="headerlink" title="5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“"></a>5ï¼Œè§¦å‘ç¦»å±æ¸²æŸ“</h3><p>ç¦»å±›æ¸²æŸ“éœ€è¦å¼€è¾Ÿä¸€å—æ–°çš„ç¼“å†²åŒºï¼Œåœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­è¿˜ä¼šæœ‰å¤šæ¬¡çš„åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œè¿™äº›å¾ˆæ¶ˆè€—æ€§èƒ½ã€‚</p>
<blockquote>
<p>å¦‚æœè¦åœ¨æ˜¾ç¤ºå±ä¸Šæ˜¾ç¤ºå†…å®¹ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¸€å—ä¸å±å¹•åƒç´ æ•°æ®é‡ä¸€æ ·å¤§çš„frame bufferï¼Œä½œä¸ºåƒç´ æ•°æ®å­˜å‚¨åŒºåŸŸï¼Œè€Œè¿™ä¹Ÿæ˜¯GPUå­˜å‚¨æ¸²æŸ“ç»“æœçš„åœ°æ–¹ã€‚å¦‚æœæœ‰æ—¶å› ä¸ºé¢ä¸´ä¸€äº›é™åˆ¶ï¼Œæ— æ³•æŠŠæ¸²æŸ“ç»“æœç›´æ¥å†™å…¥frame bufferï¼Œè€Œæ˜¯å…ˆæš‚å­˜åœ¨å¦å¤–çš„å†…å­˜åŒºåŸŸï¼Œä¹‹åå†å†™å…¥frame bufferï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¹‹ä¸ºç¦»å±æ¸²æŸ“ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯å¸¸è§çš„å¯èƒ½è§¦å‘ç¦»å±æ¸²æŸ“çš„æ“ä½œï¼š</p>
<p>1ï¼Œ layer.cornerRadius + layer.masksToBoundsä¸€èµ·è®¾ç½®<br>2ï¼Œ è®¾ç½®å›¾å±‚é˜´å½±layer.shadow<br>3ï¼Œ è®¾ç½®è’™å±‚layer.mask<br>4ï¼Œ layer.allowsGroupOpacity è®¾ç½®ä¸ºYESåŒæ—¶layer.opacityå°äº1.0<br>5ï¼Œ layer.shouldRasterizeè®¾ç½®ä¸ºYESã€‚<br>å¼€å¯ Rasterization åï¼ŒGPU åªåˆæˆä¸€æ¬¡å†…å®¹ï¼Œç„¶åå¤ç”¨åˆæˆçš„ç»“æœï¼›åˆæˆçš„å†…å®¹è¶…è¿‡100msæ²¡æœ‰ä½¿ç”¨ä¼šä»ç¼“å­˜é‡Œç§»é™¤ï¼Œæ‰€ä»¥å¯¹äºä¸è¿ç»­ä½¿ç”¨çš„å†…å®¹è¿›è¡Œå…‰æ …åŒ–æ˜¯æ—¢æ²¡æœ‰æ„ä¹‰åˆæµªè´¹èµ„æºçš„ï¼Œåœ¨æ›´æ–°å†…å®¹æ—¶è¿˜ä¼šäº§ç”Ÿæ›´å¤šçš„ç¦»å±æ¸²æŸ“ã€‚å¯¹äºå†…å®¹ä¸å‘ç”Ÿå˜åŒ–çš„è§†å›¾ï¼Œè¿›è¡Œå…‰æ …åŒ–ä¼šä½¿åŸæœ¬æ‹–åè…¿çš„ç¦»å±æ¸²æŸ“å°±æˆä¸ºäº†åŠ©åŠ›ï¼›å¦‚æœè§†å›¾å†…å®¹æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆæœ‰å¯èƒ½è®©æ€§èƒ½å˜å¾—æ›´ç³Ÿã€‚ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œç³»ç»Ÿé™åˆ¶ç¼“å­˜çš„å¤§å°ä¸º 2.5x screen sizeï¼Œè¿‡åº¦ä½¿ç”¨çš„è¯ä¹Ÿä¼šé€ æˆç¦»å±æ¸²æŸ“ã€‚ï¼ˆä¸€èˆ¬ç”¨åœ¨å•ç‹¬çš„è§†å›¾ä¸Šï¼Œè€Œä¸æ˜¯cellçš„layerï¼‰<br>6ï¼Œ ä½¿ç”¨UIBlurEffect</p>
<p><a href="https://zhuanlan.zhihu.com/p/72653360" target="_blank" rel="noopener">å³åˆ»App</a>çš„ä¼˜åŒ–æ€è·¯æ˜¯è¿™æ ·ï¼š<br>1ï¼Œå¯¹äºå›¾ç‰‡çš„åœ†è§’ï¼Œç»Ÿä¸€é‡‡ç”¨â€œprecompositeâ€çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸ç»ç”±å®¹å™¨æ¥åšå‰ªåˆ‡ï¼Œè€Œæ˜¯é¢„å…ˆä½¿ç”¨CoreGraphicsä¸ºå›¾ç‰‡è£å‰ªåœ†è§’<br>2ï¼Œå¯¹äºè§†é¢‘çš„åœ†è§’ï¼Œç”±äºå®æ—¶å‰ªåˆ‡éå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºå››ä¸ªç™½è‰²å¼§å½¢çš„layerç›–ä½å››ä¸ªè§’ï¼Œä»è§†è§‰ä¸Šåˆ¶é€ åœ†è§’çš„æ•ˆæœ<br>3ï¼Œå¯¹äºviewçš„åœ†å½¢è¾¹æ¡†ï¼Œå¦‚æœæ²¡æœ‰backgroundColorï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨cornerRadiusæ¥åš<br>4ï¼Œå¯¹äºæ‰€æœ‰çš„é˜´å½±ï¼Œä½¿ç”¨shadowPathæ¥è§„é¿ç¦»å±æ¸²æŸ“<br>5ï¼Œå¯¹äºç‰¹æ®Šå½¢çŠ¶çš„viewï¼Œä½¿ç”¨layer maskå¹¶æ‰“å¼€shouldRasterizeæ¥å¯¹æ¸²æŸ“ç»“æœè¿›è¡Œç¼“å­˜<br>6ï¼Œå¯¹äºæ¨¡ç³Šæ•ˆæœï¼Œä¸é‡‡ç”¨ç³»ç»Ÿæä¾›çš„UIVisualEffectï¼Œè€Œæ˜¯å¦å¤–å®ç°æ¨¡ç³Šæ•ˆæœï¼ˆCIGaussianBlurï¼‰ï¼Œå¹¶æ‰‹åŠ¨ç®¡ç†æ¸²æŸ“ç»“æœ</p>
<h3 id="6ï¼Œåœ†è§’"><a href="#6ï¼Œåœ†è§’" class="headerlink" title="6ï¼Œåœ†è§’"></a>6ï¼Œåœ†è§’</h3><p>â€œcornerRadiuså’ŒmaskToBoundsä¸€èµ·è®¾ç½®ä¼šè§¦å‘ç¦»å±æ¸²æŸ“â€ï¼Œè¿™å¥è¯éœ€è¦è®¨è®ºä¸€ä¸‹äº†ï¼š</p>
<p>1ï¼ŒUIViewè¿™èˆ¬è®¾ç½®åœ†è§’ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ã€‚<br>2ï¼ŒiOS9.0ä¹‹åUIImageViewä¸­çš„pngå›¾ç‰‡è¿™èˆ¬è®¾ç½®åœ†è§’ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Œä½†æ˜¯å¦‚æœUIImageViewçš„backgroundColorä¸æ˜¯clearColoræˆ–è€…ä¸æ˜¯nilï¼Œåˆ™ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ã€‚</p>
<p>ä¸Šé¢ä¸¤æ¡æ˜¯æˆ‘æœäº†å¾ˆå¤šèµ„æ–™å‘ç°çš„ï¼Œäº²è‡ªéªŒè¯äº†ä¸€ä¸‹ï¼Œåœ¨iOS13ä¸Šç¬¬ä¸€æ¡æ˜¯çœŸçš„ã€‚ç¬¬äºŒæ¡è¯•ç€ä¸è®¾ç½®backgroundColoræœç„¶ä¹Ÿæ²¡æœ‰å‡ºç°ç¦»å±æ¸²æŸ“ã€‚ä½†æ˜¯ï¼Œæ˜¯ä¸æ˜¯ä»iOS9å¼€å§‹çš„ï¼Œæˆ‘æ²¡æœ‰çœŸæœºä¹Ÿæ²¡æ³•åšåˆ¤æ–­ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å®˜æ–¹çš„è¯´æ˜ã€‚</p>
<p><strong>ä¸‹é¢æ˜¯ä¹‹å‰çš„UIImageViewè®¾ç½®åœ†è§’çš„å¤„ç†æ–¹å¼</strong><br>ç›´æ¥ä½¿ç”¨layer.maskæ¥è¾¾åˆ°åœ†è§’æ•ˆæœåŒæ ·ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Œå¯¹äºç½‘ç»œå›¾ç‰‡çš„åœ†è§’å¤„ç†é€šå¸¸æ˜¯å…ˆä¸‹è½½ååœ†è§’åŒ–ã€‚<br>ä¸‹è½½é€»è¾‘ï¼ˆä»¥æˆ‘å–œæ¬¢çš„YYWebImageä¸ºä¾‹ï¼‰ï¼š<br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">NSString *radiusKey = [url.absoluteString <span class="string">stringByAppendingString:</span>@<span class="string">"radiusCache"</span>];</span><br><span class="line">UIImage *radiusImage = [YYImageCache.sharedCache <span class="string">getImageForKey:</span>radiusKey];</span><br><span class="line"><span class="keyword">if</span> (radiusImage) &#123;</span><br><span class="line">   self.photoImageView.image = radiusImage;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   [YYWebImageManager.sharedManager <span class="string">requestImageWithURL:</span>url <span class="string">options:</span>YYWebImageOptionShowNetworkActivity <span class="string">progress:</span>nil <span class="string">transform:</span>nil <span class="string">completion:</span>^(UIImage *image, NSURL *url, YYWebImageFromType from, YYWebImageStage stage, NSError * error) &#123;</span><br><span class="line">       dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">           <span class="keyword">if</span> (!error &amp;&amp; image) &#123;</span><br><span class="line">               [YYImageCache.sharedCache <span class="string">setImage:</span>radiusImage <span class="string">imageData:</span>nil <span class="string">forKey:</span>radiusKey <span class="string">withType:</span>YYImageCacheTypeAll];</span><br><span class="line">               self.photoImageView.image = image.radiusImage;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å›¾ç‰‡ä¸‹è½½å®Œæ¯•ååšåœ†è§’å¤„ç†å¹¶ä¿å­˜ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦æ€è€ƒï¼š<br>1ï¼Œè¿™å¼ å›¾ç‰‡çš„åœ†è§’åŠå¾„åœ¨ä¸šåŠ¡ä¸Šæ˜¯å›ºå®šçš„å—ï¼Œå¦‚æœä¸å›ºå®šï¼ˆæ¯”å¦‚éœ€è¦10pxã€20pxä¸¤ç§ï¼‰é‚£å°±éœ€è¦å­˜å‚¨å¤šä»½äº†ï¼›<br>2ï¼Œè¿™å¼ å›¾ç‰‡çš„å±•ç¤ºæ•ˆæœæ˜¯å¦åªæœ‰åœ†è§’ä¸€ç§ï¼Œæ˜¯å¦åŒæ—¶å­˜åœ¨æœ‰æ–¹å›¾å’Œåœ†è§’å›¾ä¸¤ç§å½¢å¼ï¼Ÿéœ€è¦ä¿ç•™åŸå›¾å—ï¼›</p>
<p>è¿™ä¸ªæ˜¯ä½¿ç”¨Core Graphicsåˆ›å»ºåœ†è§’å›¾ç‰‡çš„ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“çš„ç¤ºä¾‹ï¼Œå¯ä»¥å­çº¿ç¨‹ç»˜åˆ¶ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)radiusImage &#123;</span><br><span class="line">    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.size.width, <span class="keyword">self</span>.size.height);</span><br><span class="line">    <span class="built_in">CGFloat</span> radius = <span class="number">100.</span>f; <span class="comment">// è¿™ä¸ªåº¦é‡æ˜¯å›¾ç‰‡çš„ï¼Œè€Œä¸æ˜¯imageViewçš„</span></span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(rect.size, <span class="literal">false</span>, <span class="built_in">UIScreen</span>.mainScreen.scale);</span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:rect byRoundingCorners:<span class="built_in">UIRectCornerAllCorners</span> cornerRadii:<span class="built_in">CGSizeMake</span>(radius, radius)];</span><br><span class="line">    <span class="built_in">CGContextAddPath</span>(context, path.CGPath);</span><br><span class="line">    <span class="built_in">CGContextClip</span>(context);</span><br><span class="line">    [<span class="keyword">self</span> drawInRect:rect];</span><br><span class="line">    <span class="built_in">CGContextDrawPath</span>(context, kCGPathFillStroke);</span><br><span class="line">    <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="7ï¼Œé˜´å½±"><a href="#7ï¼Œé˜´å½±" class="headerlink" title="7ï¼Œé˜´å½±"></a>7ï¼Œé˜´å½±</h3><p>å‡å¦‚éœ€è¦è¿™ä¹ˆè®¾ç½®é˜´å½±æ•ˆæœï¼š<br><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">button.layer.shadowColor </span>= UIColor.<span class="keyword">blackColor.CGColor;</span></span><br><span class="line"><span class="keyword">button.layer.shadowOpacity </span>= <span class="number">0</span>.<span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">button.layer.shadowRadius </span>= <span class="number">10</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">button.layer.shadowOffset </span>= CGSizeMake(<span class="number">10</span>, <span class="number">10</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>åªéœ€è¦å†åŠ ä¸Šä¸€å¥è¯å°±èƒ½é¿å…ç¦»å±æ¸²æŸ“äº†ï¼š<br><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line"><span class="keyword">button</span>.layer.shadowPath = [UIBezierPath bezierPathWithRect:<span class="keyword">button</span>.bounds].CGPath;</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªå…·æœ‰é˜´å½±æ•ˆæœçš„è§†å›¾éœ€è¦åšframeåŠ¨ç”»ï¼Œé‚£å®ƒçš„shadowæ•ˆæœæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè¿™è¿˜å¾—å†æƒ³åŠæ³•è§£å†³ï¼š<a href="https://www.jianshu.com/p/fd0e7709a404" target="_blank" rel="noopener">æ˜¾å¼æŒ‡å®šshadowPathçš„åŠ¨ç”»æ•ˆæœ</a>ã€‚</p>
<h2 id="ä¸å®šé«˜cell"><a href="#ä¸å®šé«˜cell" class="headerlink" title="ä¸å®šé«˜cell"></a>ä¸å®šé«˜cell</h2><p>ä¸å®šé«˜çš„celléœ€è¦è®¡ç®—cellçš„é«˜åº¦ã€‚æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€æ˜¯è‡ªå·±åœ¨åå°æ ¹æ®æ¨¡å‹æ•°æ®é…ç½®å­è§†å›¾çš„å¸ƒå±€ï¼Œæ‰‹åŠ¨è®¡ç®—ï¼Œå¹¶æŠŠé«˜åº¦å­˜å‚¨åˆ°å¯¹åº”çš„æ¨¡å‹ä¸­ï¼›äºŒæ˜¯å€ŸåŠ©è‡ªåŠ¨å¸ƒå±€ï¼Œä¿è¯å­è§†å›¾â€œæ’‘æ»¡â€cellï¼Œè‡ªåŠ¨æ›´æ–°cellçš„é«˜åº¦ã€‚</p>
<p>å¦‚æœå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæˆ–è€…å¼€å‘å‘¨æœŸçŸ­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Auto Layoutï¼Œå†é…åˆ<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/" target="_blank" rel="noopener">FDTemplateLayoutCell</a>çš„é«˜åº¦ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥è¯´å·²ç»å¾ˆæ–¹ä¾¿äº†ã€‚ä¸ç„¶åªèƒ½è‡ªå·±è®¡ç®—å¹¶åšç¼“å­˜å¤„ç†ã€‚</p>
<h1 id="äºŒã€å¼‚æ­¥æ¸²æŸ“"><a href="#äºŒã€å¼‚æ­¥æ¸²æŸ“" class="headerlink" title="äºŒã€å¼‚æ­¥æ¸²æŸ“"></a>äºŒã€å¼‚æ­¥æ¸²æŸ“</h1><p>TableViewå’ŒCollectionViewçš„ä¼˜åŒ–ä¹Ÿå¯ä»¥å€ŸåŠ©å¼‚æ­¥æ¸²æŸ“ï¼ŒYYAsyncLayeræè¿°äº†å¼‚æ­¥æ¸²æŸ“çš„æ ¸å¿ƒåŸç†ã€‚</p>
<h2 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h2><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">YYAsyncLayer </span>: CALayer</span><br><span class="line"><span class="comment">// Default is YES.</span></span><br><span class="line"><span class="variable">@property</span> BOOL displaysAsynchronously;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@protocol</span> YYAsyncLayerDelegate &lt;NSObject&gt;</span><br><span class="line"><span class="variable">@required</span></span><br><span class="line">- (YYAsyncLayerDisplayTask *)newAsyncDisplayTask;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¦ç»˜åˆ¶ã€æ­£åœ¨ç»˜åˆ¶ã€ç»˜åˆ¶å®Œæ¯• å¯¹åº”çš„block</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">YYAsyncLayerDisplayTask </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^willDisplay)(CALayer *layer);</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^display)(CGContextRef context, CGSize size, BOOL(^isCancelled)(void));</span><br><span class="line"><span class="variable">@property</span> (nullable, nonatomic, copy) void (^didDisplay)(CALayer *layer, BOOL finished);</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>è§†å›¾åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¹‹å‰è°ƒç”¨UIViewç±»æ–¹æ³•layerClassï¼Œå¹¶ä¸”ä½¿ç”¨è¿”å›çš„ç±»æ¥åˆ›å»ºlayerå¯¹è±¡ã€‚é€šè¿‡åˆ›å»ºUIViewçš„å­ç±»ï¼Œé‡å†™layerClassç±»å‡½æ•°å¯ä»¥æ”¹å˜åˆ›å»ºå›¾å±‚æ—¶çš„é»˜è®¤çš„CALayerç±»ã€‚åœ¨è‡ªå®šä¹‰è§†å›¾å¯¹è±¡ä¸­ï¼Œè¿”å›ä¸€ä¸ªYYAsyncLayerDisplayTaskï¼Œè¿™ä¸ªtaskæ‰¿æ‹…ç€ç»˜åˆ¶çš„ä»»åŠ¡ã€‚</p>
<h3 id="å¼‚æ­¥ç»˜åˆ¶æ–‡å­—"><a href="#å¼‚æ­¥ç»˜åˆ¶æ–‡å­—" class="headerlink" title="å¼‚æ­¥ç»˜åˆ¶æ–‡å­—"></a>å¼‚æ­¥ç»˜åˆ¶æ–‡å­—</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YALabel</span> : <span class="title">UIView</span> &lt;<span class="title">YYAsyncLayerDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSAttributedString</span> *attributedString;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YALabel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAttributedString:(<span class="built_in">NSAttributedString</span> *)attributedString &#123;</span><br><span class="line">    _attributedString = attributedString;</span><br><span class="line">    <span class="comment">// YYTransaction let you perform a selector once before current runloop sleep.</span></span><br><span class="line">    [[YYTransaction transactionWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(setTextNeedsDisplay)] commit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">    [[YYTransaction transactionWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(setTextNeedsDisplay)] commit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTextNeedsDisplay &#123;</span><br><span class="line">    [<span class="keyword">self</span>.layer setNeedsDisplay];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)layerClass &#123;</span><br><span class="line">    <span class="keyword">return</span> YYAsyncLayer.class;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (YYAsyncLayerDisplayTask *)newAsyncDisplayTask &#123;</span><br><span class="line">    YYAsyncLayerDisplayTask *task = [YYAsyncLayerDisplayTask new];</span><br><span class="line">    task.display = ^(<span class="built_in">CGContextRef</span> context, <span class="built_in">CGSize</span> size, <span class="built_in">BOOL</span> (^isCancelled)(<span class="keyword">void</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled() || <span class="keyword">self</span>.attributedString.string.length &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// ä¿®å¤ç»˜åˆ¶æ–‡å­—ä¼šé¢ å€’</span></span><br><span class="line">        [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</span><br><span class="line">            <span class="built_in">CGContextTranslateCTM</span>(context, <span class="number">0</span>, <span class="keyword">self</span>.bounds.size.height);</span><br><span class="line">            <span class="built_in">CGContextScaleCTM</span>(context, <span class="number">1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="built_in">NSAttributedString</span> *str = <span class="keyword">self</span>.attributedString;</span><br><span class="line">        [str enumerateAttribute:<span class="built_in">NSFontAttributeName</span> inRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, str.length) options:<span class="built_in">NSAttributedStringEnumerationLongestEffectiveRangeNotRequired</span> usingBlock:^(<span class="built_in">UIFont</span> *font, <span class="built_in">NSRange</span> range, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å­—ä½“è®¾ç½®pointSize</span></span><br><span class="line">            <span class="built_in">CGContextSetTextPosition</span>(context, <span class="number">0</span>, font.pointSize);</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶</span></span><br><span class="line">        <span class="built_in">CTLineRef</span> line = <span class="built_in">CTLineCreateWithAttributedString</span>((__bridge <span class="built_in">CFAttributedStringRef</span>)str);</span><br><span class="line">        <span class="built_in">CTLineDraw</span>(line, context);</span><br><span class="line">        <span class="built_in">CFRelease</span>(line);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çš„æ—¶å€™å¾ˆç®€å•äº†ï¼Œè®¾ç½®ä¸€ä¸ªAttributedStringå³å¯ï¼š<br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">YALabel *<span class="keyword">label</span><span class="bash"> = [YALabel new];</span></span><br><span class="line"><span class="bash">NSAttributedString *str = [[NSAttributedString alloc] initWithString:@<span class="string">"ğŸ˜€ğŸ˜ğŸ¤£ğŸ˜‚Labelçš„å¼‚æ­¥ç»˜åˆ¶"</span> attributes:@&#123;NSFontAttributeName:[UIFont systemFontOfSize:15]&#125;];</span></span><br><span class="line"><span class="bash">label.attributedString = str;</span></span><br><span class="line"><span class="bash">label.backgroundColor = UIColor.orangeColor;</span></span><br><span class="line"><span class="bash">label.frame = CGRectMake(100, 100, 200, 50);</span></span><br><span class="line"><span class="bash">[self.view addSubview:label];</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„newAsyncDisplayTaskæ¯”è¾ƒç®€å•ï¼Œåªç»˜åˆ¶äº†å•è¡Œæ–‡æœ¬ï¼Œå¦‚æœçœŸçš„è¦åº”ç”¨åˆ°é¡¹ç›®ä¸­ï¼Œå¯ä»¥åˆ©ç”¨CoreTextæ›´åŠ å®Œå–„äº›ï¼ŒåŠ ä¸Šè‡ªåŠ¨æ¢è¡Œï¼Œè‡ªé€‚åº”sizeï¼Œå›¾æ–‡æ··æ’ç­‰åŠŸèƒ½ã€‚</p>
<p>æœ‰å‰è¾ˆå†™äº†ä¸€ä¸ªIMçš„Demoï¼Œé‡Œé¢æœ‰ç”¨åˆ°å¼‚æ­¥ç»˜åˆ¶ï¼š<a href="https://github.com/Yuzeyang/GCAsyncDisplayDemo" target="_blank" rel="noopener">https://github.com/Yuzeyang/GCAsyncDisplayDemo</a>  ï¼Œè¯»ä¸€è¯»è¿˜æ˜¯å¾ˆæ£’çš„ã€‚</p>
<h2 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h2><p>æºç ä¸æ˜¯å¾ˆå¤šï¼Œå°±å‡ ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è·Ÿä½œè€…çš„å…¶ä»–æ¡†æ¶ä¸€æ ·ï¼Œä»£ç ç‰¹åˆ«ä¼˜ç§€ã€‚</p>
<h3 id="YYSentinel"><a href="#YYSentinel" class="headerlink" title="YYSentinel"></a>YYSentinel</h3><p>è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨? ä¸»è¦æ˜¯ä¾èµ–äºåŸå­å‡½æ•°<code>OSAtomicIncrement32()</code>ã€‚</p>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦åˆå§‹åŒ–ä¸€ä¸ªå…±äº«çš„æ•°æ®ç»“æ„ï¼Œç„¶åè‡ªåŠ¨å¢åŠ æŸä¸ªå˜é‡å€¼æ¥æ ‡è¯†åˆå§‹åŒ–æ“ä½œå®Œæˆï¼Œåˆ™æˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code>OSAtomicIncrement32Barrier</code>æ¥ç¡®ä¿æ•°æ®ç»“æ„çš„å­˜å‚¨æ“ä½œåœ¨å˜é‡è‡ªåŠ¨å¢åŠ å‰å®Œæˆã€‚</p>
</blockquote>
<p>ä½¿ç”¨è¿™ä¸ªç±»çš„ç›®çš„ï¼š æ ‡è®°æŸä¸ªæ“ä½œæ˜¯å¦å®Œæˆï¼Œä¹Ÿå³åˆ¤æ–­æˆ–è€…æ ‡è®°å¼‚æ­¥æ¸²æŸ“æ“ä½œçš„å®Œæˆæƒ…å†µ</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;libkern/OSAtomic.h&gt;</span></span></span><br><span class="line"><span class="comment">// çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYSentinel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) int32_t value;</span><br><span class="line">- (int32_t)increase;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYSentinel</span> </span>&#123;</span><br><span class="line">    int32_t _value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int32_t)value &#123;</span><br><span class="line">    <span class="keyword">return</span> _value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int32_t)increase &#123;</span><br><span class="line">    <span class="keyword">return</span> OSAtomicIncrement32(&amp;_value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="YYTransaction"><a href="#YYTransaction" class="headerlink" title="YYTransaction"></a>YYTransaction</h3><p>åªæœ‰ä¸¤ä¸ªæ–¹æ³•æ¥å£ã€‚<br>æ–¹æ³•ä¸€ï¼š åŒ…è£…<code>target</code>å’Œ<code>selector</code>å¹¶ç”Ÿæˆä¸€ä¸ª<code>YYTransaction</code>å¯¹è±¡ã€‚<br>æ–¹æ³•äºŒï¼š commitè¿™ä¸ªå¯¹è±¡ã€‚<br>åŒ…è£…æˆYYTransactionå¯¹è±¡çš„æ–¹æ³•ä¸ç”¨å¤šè¯´ï¼Œå…¶å†…éƒ¨ä½¿ç”¨å®ä¾‹å˜é‡å¼•ç”¨ç€ä¼ é€’çš„å‚æ•°ã€‚<br>æœ€å…³é”®çš„æ˜¯<code>commit</code>æ–¹æ³•ã€‚It will perform the selector on the target once before main runloopâ€™s current loop sleep. If the same transaction (same target and same selector) has already commit to runloop in this loop, this method do nothing. ä¹Ÿå°±æ˜¯è¯´åœ¨Runloopæ¯æ¬¡ä¼‘çœ ä¹‹å‰åªè°ƒç”¨ä¸€æ¬¡<code>target</code>çš„<code>selector</code>æ–¹æ³•ã€‚</p>
<p>commitæ–¹æ³•å†…éƒ¨ä½¿ç”¨transactionSeté›†åˆæ·»åŠ äº†è¿™ä¸ª<code>YYTransaction</code>å¯¹è±¡ã€‚ä½œè€…ç»™Runloopæ·»åŠ äº†ä¸€ä¸ªobserverï¼Œåœ¨ <code>kCFRunLoopBeforeWaiting</code> å’Œ <code>kCFRunLoopExit</code>è¿™ä¸¤ç§çŠ¶æ€ä¸‹ä¼šè°ƒç”¨æŒ‡å®šçš„<code>YYRunLoopObserverCallBack()</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å¾ˆç®€å•ï¼šé€ä¸ªéå†transactionSeté›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½¿å…¶<code>target</code>è°ƒç”¨å¯¹åº”çš„<code>selector</code>ã€‚</p>
<p><code>YYTransaction</code>é‡å†™äº†<code>- (NSUInteger)hash</code>æ–¹æ³•å’Œ<code>- (BOOL)isEqual:(id)object</code>æ–¹æ³•æ¥ç¡®å®šâ€œå¯¹è±¡ç›¸ç­‰â€ã€‚è¿™ä¿è¯äº†Seté›†åˆä¸­çš„å…ƒç´ å”¯ä¸€æ€§ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYTransaction</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (YYTransaction *)transactionWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector;</span><br><span class="line">- (<span class="keyword">void</span>)commit;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYTransaction</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) SEL selector;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableSet</span> *transactionSet = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€ä¸ªéå†transactionSetä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½¿å…¶targetè°ƒç”¨å¯¹åº”çš„selector</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> YYRunLoopObserverCallBack(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity, <span class="keyword">void</span> *info) &#123;</span><br><span class="line">    <span class="keyword">if</span> (transactionSet.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">NSSet</span> *currentSet = transactionSet;</span><br><span class="line">    transactionSet = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">    [currentSet enumerateObjectsUsingBlock:^(YYTransaction *transaction, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-performSelector-leaks"</span></span></span><br><span class="line">        [transaction.target performSelector:transaction.selector];</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“Runloopå¤„äºkCFRunLoopBeforeWaitingæˆ–è€…kCFRunLoopExitçš„çŠ¶æ€çš„æ—¶å€™è°ƒç”¨YYRunLoopObserverCallBack()å‡½æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> YYTransactionSetup() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        transactionSet = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        <span class="built_in">CFRunLoopRef</span> runloop = <span class="built_in">CFRunLoopGetMain</span>();</span><br><span class="line">        <span class="built_in">CFRunLoopObserverRef</span> observer;</span><br><span class="line">        </span><br><span class="line">        observer = <span class="built_in">CFRunLoopObserverCreate</span>(<span class="built_in">CFAllocatorGetDefault</span>(),</span><br><span class="line">                                           kCFRunLoopBeforeWaiting | kCFRunLoopExit,</span><br><span class="line">                                           <span class="literal">true</span>,      <span class="comment">// repeat</span></span><br><span class="line">                                           <span class="number">0xFFFFFF</span>,  <span class="comment">// after CATransaction(2000000)</span></span><br><span class="line">                                           YYRunLoopObserverCallBack, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">CFRunLoopAddObserver</span>(runloop, observer, kCFRunLoopCommonModes);</span><br><span class="line">        <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYTransaction</span></span></span><br><span class="line"></span><br><span class="line">+ (YYTransaction *)transactionWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector&#123;</span><br><span class="line">    <span class="keyword">if</span> (!target || !selector) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    YYTransaction *t = [YYTransaction new];</span><br><span class="line">    t.target = target;</span><br><span class="line">    t.selector = selector;</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠç”Ÿæˆçš„YYTransactionå¯¹è±¡æ”¾å…¥transactionSetä¸­</span></span><br><span class="line">- (<span class="keyword">void</span>)commit &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_target || !_selector) <span class="keyword">return</span>;</span><br><span class="line">    YYTransactionSetup();</span><br><span class="line">    [transactionSet addObject:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// isEqual: æ˜¯é€šè¿‡hashæ–¹æ³•æ¥åˆ¤ç­‰çš„</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)hash &#123;</span><br><span class="line">    <span class="keyword">long</span> v1 = (<span class="keyword">long</span>)((<span class="keyword">void</span> *)_selector);</span><br><span class="line">    <span class="keyword">long</span> v2 = (<span class="keyword">long</span>)_target;</span><br><span class="line">    <span class="keyword">return</span> v1 ^ v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªè¦_targetå’Œ_selectoréƒ½ä¸€è‡´ï¼Œå°±è¯´æ˜'YYTransaction'æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqual:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> == object) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (![object isMemberOfClass:<span class="keyword">self</span>.class]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    YYTransaction *other = object;</span><br><span class="line">    <span class="keyword">return</span> other.selector == _selector &amp;&amp; other.target == _target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="YYAsyncLayer"><a href="#YYAsyncLayer" class="headerlink" title="YYAsyncLayer"></a>YYAsyncLayer</h3><p>æœ€åæ˜¯YYAsyncLayerçš„å®ç°ï¼Œæœ€æ ¸å¿ƒçš„é€»è¾‘å°±åœ¨è¿™é‡Œäº†ã€‚æˆ‘ä¸€å¹´ä¹‹å‰å°±æ›¾ç»è¯»è¿‡è¿™å—æºç ï¼Œå½“æ—¶æœ‰å¥½å¤šç–‘æƒ‘ï¼Œç°åœ¨å†æ¥çœ‹ï¼Œæœ‰çš„ç–‘æƒ‘å·²ç»è§£å¼€äº†ï¼Œæœ‰çš„è¿˜æ²¡æœ‰ï¼Œåœ¨è¿™è®°å½•ä¸€ä¸‹ã€‚</p>
<h4 id="1ï¼Œå­çº¿ç¨‹çš„å¤„ç†"><a href="#1ï¼Œå­çº¿ç¨‹çš„å¤„ç†" class="headerlink" title="1ï¼Œå­çº¿ç¨‹çš„å¤„ç†"></a>1ï¼Œå­çº¿ç¨‹çš„å¤„ç†</h4><p>å¼‚æ­¥ï¼Œè‡ªç„¶è¦æ”¾åˆ°å­çº¿ç¨‹ã€‚ä¸»é˜Ÿåˆ—å¯¹åº”çš„æ˜¯ä¸»çº¿ç¨‹ï¼Œ4ä¸ªä¸åŒä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—å¹¶ä¸å¯¹åº”4ä¸ªå­çº¿ç¨‹ã€‚æ¯…ç„¶æ”¾åœ¨å…¨å±€é˜Ÿåˆ—ä¸å¤ªå¯å–ï¼Œå¯èƒ½ä¼šå‡ºç°Appåœ¨åŒä¸€æ—¶åˆ»å­˜åœ¨å‡ åä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œã€åˆ›å»ºã€é”€æ¯çš„æƒ…å†µã€‚â€œå½“å¤§é‡çº¿ç¨‹åŒæ—¶åˆ›å»ºè¿è¡Œé”€æ¯æ—¶ï¼Œè¿™äº›æ“ä½œä»ç„¶ä¼šæŒ¤å æ‰ä¸»çº¿ç¨‹çš„ CPU èµ„æºã€‚â€ã€‚ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—åˆæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„èµ„æºã€‚ä½œè€…åœ¨YYAsyncLayerä¸­çš„æ€è·¯æ˜¯ï¼šåˆ›å»ºå’Œ CPU æ•°é‡ç›¸åŒçš„ä¸²è¡Œqueueï¼ˆæœ€å¤š16ä¸ªï¼‰ï¼Œæ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ¯æ¬¡ä»æ•°ç»„ä¸­éšæœºè·å–å…¶ä¸­çš„ä¸€ä¸ªqueueã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Global display queue, used for content rendering.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> dispatch_queue_t <span class="title">YYAsyncLayerGetDisplayQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_QUEUE_COUNT 16</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> queueCount;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_queue_t</span> queues[MAX_QUEUE_COUNT];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int32_t</span> counter = <span class="number">0</span>;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// è·å–è¿è¡Œè¯¥è¿›ç¨‹çš„ç³»ç»Ÿçš„å¤„äºæ¿€æ´»çŠ¶æ€çš„å¤„ç†å™¨æ•°é‡, iPhone 6s æ˜¯2ä¸ª</span></span><br><span class="line">        queueCount = (<span class="keyword">int</span>)[NSProcessInfo processInfo].activeProcessorCount;</span><br><span class="line">        queueCount = queueCount &lt; <span class="number">1</span> ? <span class="number">1</span> : queueCount &gt; MAX_QUEUE_COUNT ? MAX_QUEUE_COUNT : queueCount;</span><br><span class="line">        <span class="keyword">for</span> (NSUInteger i = <span class="number">0</span>; i &lt; queueCount; i++) &#123;</span><br><span class="line">            <span class="keyword">dispatch_queue_attr_t</span> attr =</span><br><span class="line">            <span class="comment">// QOS_CLASS_USER_INITIATED ç”¨æˆ·å‘èµ·å¹¶ç­‰å¾…çš„ä¼˜å…ˆçº§</span></span><br><span class="line">            dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_USER_INITIATED, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line">            queues[i] = dispatch_queue_create(<span class="string">"com.ibireme.yykit.render"</span>, attr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// å¤§é‡ä½¿ç”¨ OSAtomicIncrement32,ç”±äºè¯¥å‡½æ•°å¯¹æŸä¸ªå€¼è¿›è¡Œè‡ªå¢è®¡ç®—,è€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„,æ‰€ä»¥è¢«ç”¨æ¥ä½œä¸ºç»˜åˆ¶æ—¶çš„æ ‡è®°ä½(å“¨å…µ).å¼‚æ­¥ç»˜åˆ¶çš„å…³é”®åœ¨äºæ¯æ¬¡è°ƒç”¨ setNeedDisplay æ—¶éƒ½ä¼šå°†å“¨å…µå˜é‡è‡ªå¢,åœ¨ display æ–¹æ³•ä¸­,æ ¹æ®è¿™ä¸ªå“¨å…µå˜é‡æ¥ç¡®å®šæ˜¯å¦ç»§ç»­ç»˜åˆ¶è¿˜æ˜¯åœæ­¢ç»˜åˆ¶.ä¸€è‡´åˆ™ç»§ç»­ç»˜åˆ¶, ä¸ä¸€è‡´åˆ™åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">    <span class="keyword">int32_t</span> cur = OSAtomicIncrement32(&amp;counter); <span class="comment">// counterè‡ªå¢ä¸€, å¹¶å–å‡ºè¯¥å€¼,</span></span><br><span class="line">    <span class="keyword">if</span> (cur &lt; <span class="number">0</span>) cur = -cur; <span class="comment">// å•¥æ—¶å€™ä¼šå‡ºç°?? counterå–INT_MAXçš„æ—¶å€™å‡ºç°</span></span><br><span class="line">    <span class="keyword">return</span> queues[(cur) % queueCount]; <span class="comment">// å–ä½™</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> MAX_QUEUE_COUNT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å•çº¯å°±å­çº¿ç¨‹ç»˜åˆ¶è¿™ä¸ªé—®é¢˜è€Œè¨€ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œæ—¢ç„¶ä¼šå‡ºç°â€œåŒä¸€æ—¶åˆ»å­˜åœ¨å‡ åä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œã€åˆ›å»ºã€é”€æ¯â€çš„æƒ…å†µï¼Œé‚£å¦‚æœç›´æ¥æ“ä½œçº¿ç¨‹å‘¢ï¼Œç›´æ¥åˆ›å»ºä¸‰äº”ä¸ªNSThreadå¯¹è±¡ï¼Œè®©å®ƒä»¬å¤„ç†Appä¸­çš„æ‰€æœ‰å¼‚æ­¥æ¸²æŸ“æ“ä½œã€‚å¦‚æœè¿™æ ·çš„è¯ï¼Œå°±éœ€è¦å¯¹è¿™ä¸‰äº”ä¸ªNSThreadå¯¹è±¡è¿›è¡Œçº¿ç¨‹ä¿æ´»ï¼Œä¿è¯å®ƒä»¬æ°¸è¿œå­˜åœ¨ã€‚å†è€…åªèƒ½é€šè¿‡performSelector:onThread:è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼ˆæˆ–è€…å†åšä¸€ä¸ªblockæ–¹å¼çš„å°è£…ï¼‰ã€‚<strong>æœ€åä¹Ÿæ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œæ²¡åŠæ³•åˆ©ç”¨è®¾å¤‡å¤šæ ¸çš„ä¼˜åŠ¿ã€‚</strong>å•æ ¸ä¸­çš„å¤šçº¿ç¨‹å®é™…ä¸Šæ˜¯æ¯ä¸ªæ—¶é—´ç‰‡ä¸Šåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œè€Œå¤šæ ¸å®é™…ä¸Šæ˜¯çœŸçš„å¤šçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªæ—¶é—´ç‰‡æ¯ä¸ªæ ¸éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚dispatch_asyncæ˜¯å¤šæ ¸çº§åˆ«ç¼–ç¨‹æ¡†æ¶è°ƒåº¦å‡½æ•°ï¼Œè¿™æ‰çœŸæ­£å†³å®šäº†ä¸ºå•¥è¦ä½¿ç”¨GCDã€‚</p>
<h4 id="2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶"><a href="#2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶" class="headerlink" title="2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶"></a>2ï¼Œå¼‚æ­¥ç»˜åˆ¶å¼€å…³æ§åˆ¶</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é‡å†™ä¿®æ”¹CALayeræˆ–å…¶å­ç±»å±æ€§çš„é»˜è®¤å€¼ï¼Œkeyä¸ºå±æ€§åç§°ï¼Œå¦‚æœæ²¡æœ‰è¯¥å±æ€§åˆ™è¿”å›nilã€‚</span></span><br><span class="line">+ (<span class="keyword">id</span>)defaultValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"displaysAsynchronously"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> @(<span class="literal">YES</span>); <span class="comment">// ä»…ä»…é’ˆå¯¹displaysAsynchronouslyè¿™ä¸ªå±æ€§ä¿®æ”¹</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> defaultValueForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="comment">// è®¾ç½®å±å¹•ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CGFloat</span> scale; <span class="comment">// global</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        scale = [<span class="built_in">UIScreen</span> mainScreen].scale;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">self</span>.contentsScale = scale;</span><br><span class="line">    <span class="comment">// è®¡æ•°å™¨, æ§åˆ¶å¤šçº¿ç¨‹è®¿é—®</span></span><br><span class="line">    _sentinel = [YYSentinel new];</span><br><span class="line">    <span class="comment">// é»˜è®¤æ˜¯YES</span></span><br><span class="line">    _displaysAsynchronously = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>displaysAsynchronously</code>æ¥æ§åˆ¶æ˜¯å¦å¼€å¯å¼‚æ­¥æ¸²æŸ“ã€‚<br>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜æƒ³ä¸é€šï¼ŒYYAsyncLayerçš„initæ–¹æ³•ä¸­å·²ç»åˆå§‹åŒ–<code>_displaysAsynchronously</code>çš„å€¼ä¸ºYESäº†ï¼Œä½†æ˜¯ä½œè€…åˆé‡å†™defaultValueForKeyæ–¹æ³•å¹¶åœ¨å…¶ä¸­å†æ¬¡è®¾ç½®displaysAsynchronouslyå±æ€§ä¸ºYESã€‚è¿™ä¸¤ä¸ªæ–¹å¼çš„æ•ˆæœä¸€æ ·å‘€ï¼Œä¼šä¸ä¼šå¤šæ­¤ä¸€ä¸¾äº†å‘¢ï¼Ÿ</p>
<h4 id="3ï¼Œç»˜åˆ¶æ—¶æœº"><a href="#3ï¼Œç»˜åˆ¶æ—¶æœº" class="headerlink" title="3ï¼Œç»˜åˆ¶æ—¶æœº"></a>3ï¼Œç»˜åˆ¶æ—¶æœº</h4><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="comment">// layeré”€æ¯çš„æ—¶å€™, è®¡æ•°å™¨åŠ 1, è¡¨ç¤ºåŸå…ˆçš„ç»˜åˆ¶éœ€è¦å–æ¶ˆ</span></span><br><span class="line">    [<span class="meta">_sentinel increase</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNeedsDisplay &#123;</span><br><span class="line">    <span class="comment">// è¢«æ ‡è®°éœ€è¦é‡æ–°ç»˜åˆ¶, åˆ™å–æ¶ˆä¸Šæ¬¡çš„å¼‚æ­¥è°ƒç”¨</span></span><br><span class="line">    [<span class="meta">self _cancelAsyncDisplay</span>];</span><br><span class="line">    [<span class="meta">super setNeedsDisplay</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reload the content of this layer.</span></span><br><span class="line"><span class="comment">// Subclasses can override this method and use it to set the layerâ€™s contents property directly. You might do this if your custom layer subclass handles layer updates differently.</span></span><br><span class="line">- (<span class="keyword">void</span>)display &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªèµ‹å€¼æ˜¯å› ä¸ºè¿™æ ·å—??</span></span><br><span class="line">    <span class="comment">// Assigning a value to this property causes the layer to use your image rather than create a separate backing store.</span></span><br><span class="line">    super.contents = super.contents;</span><br><span class="line">    [<span class="meta">self _displayAsync:_displaysAsynchronously</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)_cancelAsyncDisplay &#123;</span><br><span class="line">    <span class="comment">// increaseå¢åŠ 1, ä¸ç›®å‰çš„ä¸ä¸€è‡´äº†, è¡¨ç¤ºç›®å‰çš„æ¸²æŸ“å·²å–æ¶ˆ</span></span><br><span class="line">    [<span class="meta">_sentinel increase</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®é™…çš„ç»˜åˆ¶é€»è¾‘ä¸­ï¼Œæ˜¯é€šè¿‡åˆ¤æ–­è®¡æ•°å™¨<code>_sentinel</code>çš„å€¼æ¥ç¡®å®šæ˜¯å¦å–æ¶ˆç»˜åˆ¶ï¼š<br><figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line">YYSentinel *sentinel = <span class="number">_</span>sentinel;</span><br><span class="line">int<span class="number">32_</span>t <span class="keyword">value</span> = sentinel.<span class="keyword">value</span>;</span><br><span class="line">BOOL (^isCancelled)(<span class="keyword">void</span>) = ^BOOL() &#123;</span><br><span class="line">  <span class="comment">// å€¼ç›¸ç­‰, è¯´æ˜æ­£åœ¨ç»˜åˆ¶æ²¡æœ‰å–æ¶ˆ, å¦åˆ™è¯´æ˜å·²ç»å–æ¶ˆå•¦</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">value</span> != sentinel.<span class="keyword">value</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>åè¿‡æ¥ï¼Œåªéœ€è¦æŠŠè®¡æ•°å™¨çš„å€¼è‡ªå¢ï¼ˆ<code>[_sentinel increase]</code>ï¼‰å°±å¯ä»¥è¡¨ç¤ºç›®å‰çš„ç»˜åˆ¶æ“ä½œå–æ¶ˆäº†ã€‚åœ¨Layeré”€æ¯çš„æ—¶å€™ï¼ˆdeallocï¼‰å’Œè¢«æ ‡è®°éœ€è¦é‡æ–°ç»˜åˆ¶çš„æ—¶å€™ï¼ˆsetNeedsDisplayï¼‰åº”è¯¥å–æ¶ˆåŸå…ˆçš„ç»˜åˆ¶æ“ä½œã€‚</p>
<p>æŒ‰ç…§è‹¹æœçš„è¯´æ˜ï¼ŒCALayerçš„å­ç±»å¯ä»¥é‡å†™displayæ–¹æ³•å¹¶åœ¨å…¶ä¸­ç›´æ¥è®¾ç½®contentsã€‚YYAsyncLayerä¾¿åœ¨å…¶ä¸­åšäº†å¼‚æ­¥ç»˜åˆ¶æ“ä½œã€‚è¿™é‡Œçš„<code>super.contents = super.contents;</code>ä¸€å¥è¯ç¡®å®å½“ç„¶æ²¡çœ‹æ‡‚ï¼Œåæ¥å‘ç°ä¹Ÿæœ‰å°ä¼™ä¼´è·Ÿæˆ‘ä¸€æ ·æ²¡å¼„æ˜ç™½ï¼Œç„¶åæŸ¥é˜…èµ„æ–™å‘ç°äº†è‹¹æœçš„è§£é‡Šï¼šAssigning a value to this property causes the layer to use your image rather than create a separate backing store.</p>
<h4 id="4ï¼Œç»˜åˆ¶æ“ä½œ"><a href="#4ï¼Œç»˜åˆ¶æ“ä½œ" class="headerlink" title="4ï¼Œç»˜åˆ¶æ“ä½œ"></a>4ï¼Œç»˜åˆ¶æ“ä½œ</h4><p>æœ€åä¾¿æ˜¯ç»˜åˆ¶çš„æ“ä½œäº†ï¼Œå†™äº†å¾ˆè¯¦ç»†çš„æ³¨é‡Šï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)_displayAsync:(<span class="built_in">BOOL</span>)async &#123;</span><br><span class="line">    <span class="comment">// å¼ºå¼•ç”¨ä»£ç†, é¿å…é‡Šæ”¾</span></span><br><span class="line">    __<span class="keyword">strong</span> <span class="keyword">id</span>&lt;YYAsyncLayerDelegate&gt; delegate = (<span class="keyword">id</span>)<span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="comment">// è·å–ä¸€ä¸ªDisplay Task</span></span><br><span class="line">    YYAsyncLayerDisplayTask *task = [delegate newAsyncDisplayTask];</span><br><span class="line">    <span class="keyword">if</span> (!task.display) &#123; <span class="comment">// æ²¡æœ‰éœ€è¦ç»˜åˆ¶çš„å†…å®¹, è®¾ç½®contentsä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (async) &#123; <span class="comment">// å¼‚æ­¥ç»˜åˆ¶</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        YYSentinel *sentinel = _sentinel;</span><br><span class="line">        int32_t value = sentinel.value;</span><br><span class="line">        <span class="built_in">BOOL</span> (^isCancelled)(<span class="keyword">void</span>) = ^<span class="built_in">BOOL</span>() &#123;</span><br><span class="line">            <span class="comment">// å€¼ç›¸ç­‰, è¯´æ˜æ­£åœ¨ç»˜åˆ¶æ²¡æœ‰å–æ¶ˆ, å¦åˆ™è¯´æ˜å·²ç»å–æ¶ˆå•¦</span></span><br><span class="line">            <span class="keyword">return</span> value != sentinel.value;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">CGSize</span> size = <span class="keyword">self</span>.bounds.size;</span><br><span class="line">        <span class="built_in">BOOL</span> opaque = <span class="keyword">self</span>.opaque;</span><br><span class="line">        <span class="built_in">CGFloat</span> scale = <span class="keyword">self</span>.contentsScale;</span><br><span class="line">        <span class="comment">// è·å–èƒŒæ™¯è‰²</span></span><br><span class="line">        <span class="built_in">CGColorRef</span> backgroundColor = (opaque &amp;&amp; <span class="keyword">self</span>.backgroundColor) ? <span class="built_in">CGColorRetain</span>(<span class="keyword">self</span>.backgroundColor) : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (size.width &lt; <span class="number">1</span> || size.height &lt; <span class="number">1</span>) &#123; <span class="comment">// å®½æˆ–è€…é«˜å°äº1çš„æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// è·å–å›¾ç‰‡å†é‡Šæ”¾æ‰, ä¸ºå•¥è¦å¤šæ­¤ä¸€ä¸¾?</span></span><br><span class="line">            <span class="comment">// å› ä¸ºèµ‹å€¼ç»™contentsçš„å°±æ˜¯ä¸€ä¸ªCGImageRef, å¦‚æœç›´æ¥self.contents = nil;ä¼šé€ æˆè¿™ä¸ªimageåœ¨å½“å‰çº¿ç¨‹(ä¸»çº¿ç¨‹)é‡Šæ”¾ã€‚ä½œè€…æ‰‹åŠ¨æŠŠè¿™ä¸ªimageå–å‡ºæ¥çš„ç›®çš„å°±æ˜¯æŠŠ'release'æ“ä½œæ”¾åœ¨YYAsyncLayerGetReleaseQueue()è¿™ä¸ªé˜Ÿåˆ—ä¸­</span></span><br><span class="line">            <span class="built_in">CGImageRef</span> image = (__bridge_retained <span class="built_in">CGImageRef</span>)(<span class="keyword">self</span>.contents);</span><br><span class="line">            <span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(YYAsyncLayerGetReleaseQueue(), ^&#123;</span><br><span class="line">                    <span class="built_in">CFRelease</span>(image);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">            <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»è¿™é‡Œå¼€å§‹è¿›å…¥å­çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(YYAsyncLayerGetDisplayQueue(), ^&#123;</span><br><span class="line">            <span class="comment">// è¿›å…¥å­çº¿ç¨‹å, ç¬¬1æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼€å¯å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">            <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, opaque, scale);</span><br><span class="line">            <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">            <span class="keyword">if</span> (opaque) &#123;</span><br><span class="line">            <span class="comment">// UIGraphicsPushContext:å‹æ ˆå½“å‰çš„ç»˜åˆ¶å¯¹è±¡, ç”Ÿæˆæ–°çš„ç»˜åˆ¶å›¾å±‚ã€‚UIKitçš„ç»˜åˆ¶å¿…é¡»åœ¨å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­ç»˜åˆ¶ï¼Œè€ŒUIGraphicsPushContextå¯ä»¥å°†å½“å‰çš„å‚æ•°contextè½¬åŒ–ä¸ºå¯ä»¥UIKitç»˜åˆ¶çš„ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œç»˜åˆ¶å›¾ç‰‡ã€‚</span></span><br><span class="line">            <span class="comment">// CGContextSaveGState:å‹æ ˆå½“å‰çš„ç»˜åˆ¶çŠ¶æ€</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯ä¸ºäº†ä¸"æ±¡æŸ“"åŸå…ˆçš„contextå†…å®¹, ä¿å­˜çŠ¶æ€åç»˜åˆ¶æ–°çš„å†…å®¹</span></span><br><span class="line">                <span class="built_in">CGContextSaveGState</span>(context);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰èƒŒæ™¯è‰²æˆ–è€… é€æ˜åº¦å°äº1, ä½¿ç”¨ç™½è‰²å¡«å……</span></span><br><span class="line">                    <span class="keyword">if</span> (!backgroundColor || <span class="built_in">CGColorGetAlpha</span>(backgroundColor) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="built_in">CGContextSetFillColorWithColor</span>(context, [<span class="built_in">UIColor</span> whiteColor].CGColor);</span><br><span class="line">                        <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width * scale, size.height * scale));</span><br><span class="line">                        <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œä½¿ç”¨backgroundColorå¡«å……</span></span><br><span class="line">                    <span class="keyword">if</span> (backgroundColor) &#123;</span><br><span class="line">                        <span class="built_in">CGContextSetFillColorWithColor</span>(context, backgroundColor);</span><br><span class="line">                        <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width * scale, size.height * scale));</span><br><span class="line">                        <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">CGContextRestoreGState</span>(context);</span><br><span class="line">                <span class="built_in">CGColorRelease</span>(backgroundColor);</span><br><span class="line">            &#125;</span><br><span class="line">            task.display(context, size, isCancelled);</span><br><span class="line">            <span class="comment">// displayå®Œæ¯•å, ç¬¬2æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœç¡®å®šå·²ç»å–æ¶ˆç»˜åˆ¶äº†, å…³é—­å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">                <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»å½“å‰ä¸Šä¸‹æ–‡ä¸­è·å–ç”Ÿæˆçš„æ–°å†…å®¹</span></span><br><span class="line">            <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">            <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">            <span class="comment">// ä»ä¸Šä¸‹æ–‡ä¸­è·å–å›¾ç‰‡å, ç¬¬3æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                <span class="comment">// è½¬åˆ°ä¸»çº¿ç¨‹å¯¹contentsèµ‹å€¼ï¼Œç¬¬4æ¬¡å–æ¶ˆç»˜åˆ¶åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">NO</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// åœ¨è¿™é‡Œå¯¹contentsèµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br><span class="line">                    <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// éå¼‚æ­¥ç»˜åˆ¶</span></span><br><span class="line">        <span class="comment">// ä¸éœ€è¦è¿›è¡Œçº¿ç¨‹å®‰å…¨åˆ¤æ–­äº†</span></span><br><span class="line">        [_sentinel increase];</span><br><span class="line">        <span class="comment">// ä¸‹é¢çš„ä»£ç éƒ½æ˜¯å’Œå¼‚æ­¥ç»˜åˆ¶ç›¸åŒçš„å¥—è·¯</span></span><br><span class="line">        <span class="keyword">if</span> (task.willDisplay) task.willDisplay(<span class="keyword">self</span>);</span><br><span class="line">        <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(<span class="keyword">self</span>.bounds.size, <span class="keyword">self</span>.opaque, <span class="keyword">self</span>.contentsScale);</span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.opaque) &#123;</span><br><span class="line">            <span class="built_in">CGSize</span> size = <span class="keyword">self</span>.bounds.size;</span><br><span class="line">            size.width *= <span class="keyword">self</span>.contentsScale;</span><br><span class="line">            size.height *= <span class="keyword">self</span>.contentsScale;</span><br><span class="line">            <span class="built_in">CGContextSaveGState</span>(context); &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">self</span>.backgroundColor || <span class="built_in">CGColorGetAlpha</span>(<span class="keyword">self</span>.backgroundColor) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">CGContextSetFillColorWithColor</span>(context, [<span class="built_in">UIColor</span> whiteColor].CGColor);</span><br><span class="line">                    <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width, size.height));</span><br><span class="line">                    <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.backgroundColor) &#123;</span><br><span class="line">                    <span class="built_in">CGContextSetFillColorWithColor</span>(context, <span class="keyword">self</span>.backgroundColor);</span><br><span class="line">                    <span class="built_in">CGContextAddRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width, size.height));</span><br><span class="line">                    <span class="built_in">CGContextFillPath</span>(context);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="built_in">CGContextRestoreGState</span>(context);</span><br><span class="line">        &#125;</span><br><span class="line">        task.display(context, <span class="keyword">self</span>.bounds.size, ^&#123;<span class="keyword">return</span> <span class="literal">NO</span>;&#125;);</span><br><span class="line">        <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">        <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">        <span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br><span class="line">        <span class="keyword">if</span> (task.didDisplay) task.didDisplay(<span class="keyword">self</span>, <span class="literal">YES</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>çœ‹èµ·æ¥è²Œä¼¼å¾ˆå¤šï¼Œå®é™…çš„ç»˜åˆ¶åŸç†ä¸‰è¡Œä»£ç å¯ä»¥è¯´æ¸…æ¥šï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¼Œä»å½“å‰å›¾å½¢ä¸Šä¸‹æ–‡ä¸­è·å–Image</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line"><span class="comment">// 2ï¼Œå…³é—­å›¾å½¢ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line"><span class="comment">// 3ï¼Œå°†imageèµ‹å€¼ç»™layerçš„contentså±æ€§</span></span><br><span class="line"><span class="keyword">self</span>.contents = (__bridge <span class="keyword">id</span>)(image.CGImage);</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¹‹å¤–æ›´å¤šçš„æ˜¯ æ˜¯å¦å–æ¶ˆç»˜åˆ¶çš„åˆ¤æ–­ã€æ²¡æœ‰èƒŒæ™¯è‰²æˆ–è€…é€æ˜åº¦å°äº1çš„å¤„ç†ã€sizeæå°å€¼çš„å¤„ç†ç­‰ç­‰ã€‚</p>
<p>å½“ç„¶è¿˜æœ‰é‚£ä¸ªå·§å¦™çš„å­çº¿ç¨‹å¼‚æ­¥é‡Šæ”¾å¯¹è±¡çš„é€»è¾‘ï¼Œè®°å¾—ä¹Ÿè§è¿‡å¥½å¤šæ¬¡äº†ï¼š<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGImageRef</span> image = (__bridge_retained <span class="built_in">CGImageRef</span>)(<span class="keyword">self</span>.contents);</span><br><span class="line"><span class="keyword">self</span>.contents = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">if</span> (image) &#123;</span><br><span class="line"> <span class="built_in">dispatch_async</span>(YYAsyncLayerGetReleaseQueue(), ^&#123;</span><br><span class="line">     <span class="built_in">CFRelease</span>(image);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¹³æ—¶çš„ä¸šåŠ¡å¼€å‘ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ä¹ˆç”¨ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">// å«æœ‰å¤§é‡å…ƒç´ çš„æ•°ç»„</span><br><span class="line">NSMutableArray *array = self.itemArray;</span><br><span class="line">self.itemArray = nil;</span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">  <span class="built_in"> array </span>= nil; // å­çº¿ç¨‹é‡Šæ”¾</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h1 id="ä¸‰ã€å°ç»“"><a href="#ä¸‰ã€å°ç»“" class="headerlink" title="ä¸‰ã€å°ç»“"></a>ä¸‰ã€å°ç»“</h1><p><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">ã€ŠiOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ã€‹</a>è¿™ç¯‡æ–‡ç« æƒ³å¿…å¾ˆå¤šäººéƒ½æœ‰äººé˜…è¯»è¿‡ï¼Œä¹Ÿéƒ½èƒ½ä»ä¸­å—ç›Šã€‚<br>è¿™é‡Œå›é¡¾ä¸€ä¸‹ibiremeå¤§ç¥çš„å¾®åšDemoæ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼š<br><strong>1ï¼Œé¢„æ’ç‰ˆ</strong><br>è¿™é‡Œæ˜¯æŒ‡ä¸å®šé«˜cellçš„é¢„æ’ç‰ˆï¼Œæœ¬æ–‡ä¹Ÿå·²ç»æè¿‡ï¼Œframeå¸ƒå±€ï¼Œå¯ä»¥å­çº¿ç¨‹æ‰‹åŠ¨è®¡ç®—å¹¶æŠŠlayoutæ•°æ®ç¼“å­˜åœ¨æ¨¡å‹ä¸­ï¼Œautolayoutå¸ƒå±€ï¼Œå¯ä»¥å€ŸåŠ©FDTemplateLayoutCellåšé«˜åº¦ç¼“å­˜ã€‚<br><strong>2ï¼Œé¢„æ¸²æŸ“</strong><br>ä½œè€…ä¸¾äº†ä¸€ä¸ªåœ†è§’å›¾ç‰‡é¢„å…ˆè£å‰ªå¹¶åšç¼“å­˜å¤„ç†æ¥é¿å…ç¦»å±æ¸²æŸ“çš„ä¾‹å­ï¼Œä¹Ÿæ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œlayer.cornerRadius + layer.masksToBoundsä¸€èµ·è®¾ç½®åœ¨æ–°ç‰ˆæœ¬ç³»ç»Ÿä¸Šå·²ç»ä¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼ˆå¤§å¤šæ•°äººè¯´æ˜¯iOS9ï¼Œæˆ‘è¿˜æ²¡æœ‰ç¡®è®¤ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªæ€è·¯å¯ä»¥ä¸¾ä¸€åä¸‰ï¼Œå¾ˆå¤šå¯ä»¥æå‰çš„å·¥ä½œæ²¡å¿…è¦ç­‰åˆ°cellè¦å±•ç¤ºäº†æ‰å¼€å§‹åšã€‚<br><strong>3ï¼Œå¼‚æ­¥ç»˜åˆ¶+å…¨å±€å¹¶å‘æ§åˆ¶</strong></p>
<ul>
<li>å€ŸåŠ©YYDispatchQueuePoolæŠŠAppå†…æ‰€æœ‰å¼‚æ­¥æ“ä½œæŒ‰ä¼˜å…ˆçº§ä¸åŒæ”¾å…¥äº†å…¨å±€çš„ serial queue ä¸­æ‰§è¡Œï¼Œå°½é‡é¿å…äº†è¿‡å¤šçº¿ç¨‹å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚</li>
<li>å€ŸåŠ©YYAsyncLayerå’ŒCoreTextå®ç°å¯Œæ–‡æœ¬çš„å¼‚æ­¥ç»˜åˆ¶ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åŠŸèƒ½æ›´å¼ºå¤§çš„YYTextï¼Œä½œè€…æŠŠè·¯éƒ½ç»™é“ºå¥½äº†ğŸ˜‚ï¼‰ã€‚</li>
</ul>
<p><strong>4ï¼Œå¼‚æ­¥å›¾ç‰‡åŠ è½½</strong><br>å¤§å¤šæ—¶å€™ï¼Œåªæ˜¯æ˜¾ç¤ºç®€å•çš„å•å¼ å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨UIView.layer.contentsï¼Œè€Œä¸éœ€è¦ä½¿ç”¨UIImageViewã€‚å½“ç„¶ï¼ŒSDWebImageå’ŒYYWebImageæŠŠå¾ˆå¤šå·¥ä½œéƒ½åšå¥½äº†ã€‚<br><strong>5ï¼Œä¸éœ€è¦è§¦æ‘¸äº‹ä»¶çš„UIViewæ¢æˆCALayer</strong><br>å¯ä»¥è¿™ä¹ˆåšï¼Œä½†æ˜¯CALayeræ²¡æ³•è®¾ç½®çº¦æŸäº†ï¼Œå¦‚æœä½¿ç”¨è‡ªåŠ¨å¸ƒå±€å°±å¾ˆè›‹ç–¼äº†ã€‚<br><strong>6ï¼Œå¤šä¸ªè§†è§‰å…ƒç´ åˆæˆä¸€å¼ å›¾</strong><br>ä¹Ÿæ˜¯ä¸€ç§æ€è·¯ï¼Œç”šè‡³ä¹Ÿä¸€å®šæ¡ä»¶ä¸‹å¯ä»¥æŠŠcellçš„å…¨éƒ¨å†…å®¹åˆæˆä¸€å¼ å›¾ç‰‡ï¼Œä½†æ˜¯å¯èƒ½æ€§æ¯”è¾ƒå°ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡æ¥èµ°ã€‚<br>ä»¥å¾®åšä¸ºä¾‹ï¼Œâ€œæ¥è‡ªiPhoneâ€ã€ä¼šå‘˜å›¾æ ‡ã€è¯é¢˜ã€è½¬å‘å¾®åšåŸä½œè€…æ˜µç§°ã€å¾®åšå†…å®¹çš„é“¾æ¥è¿™äº›å…ƒç´ éƒ½éœ€è¦å“åº”ç‚¹å‡»äº‹ä»¶ï¼Œæ ¹æœ¬ä¸å¯èƒ½ç”¨ä¸€ç§å›¾ç‰‡ä»£æ›¿ã€‚<br>ç™¾åº¦çš„feedæµï¼Œå¾ˆå¤šæ–°é—»çš„æ ·å¼æ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”ä¸åƒå¾®åšéœ€è¦å¤„ç†å¾ˆå¤šå­å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ï¼Œå¾ˆå¤šæƒ…å†µä¸‹åªéœ€è¦å¤„ç†cellçš„ç‚¹å‡»äº‹ä»¶å°±å¯ä»¥äº†ï¼Œè¿™æ‰æœ‰åˆæˆä¸€å¼ å›¾ç‰‡çš„å¯èƒ½æ€§ã€‚</p>
<p>è¿‡æ—©çš„ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºï¼Œæ‰€æœ‰çš„tipséƒ½åªæ˜¯å»ºè®®ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚å¾ˆå¤šå‰è¾ˆç»™æˆ‘ä»¬æä¾›äº†è¯¸å¤šä¾¿åˆ©çš„å·¥å…·ï¼Œå¯¹äºæˆ‘ä»¬ï¼Œå¹³æ—¶è¸è¸å®å®å†™ä»£ç ï¼Œå°‘å†™bugï¼Œä¸å†™crashï¼Œè¿™æ‰æ˜¯æœ€é‡è¦çš„ã€‚</p>
<blockquote>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">ã€ŠiOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ã€‹</a><br><a href="http://tutuge.me/2015/02/19/æå‡UITableViewæ€§èƒ½-å¤æ‚é¡µé¢çš„ä¼˜åŒ–/" target="_blank" rel="noopener">ã€Šæå‡UITableViewæ€§èƒ½-å¤æ‚é¡µé¢çš„ä¼˜åŒ–ã€‹</a><br><a href="https://www.jianshu.com/p/15b8b1844e9c" target="_blank" rel="noopener">ã€ŠiOS é˜´å½±ï¼Œåœ†è§’ï¼Œé¿å…ç¦»å±æ¸²æŸ“ã€‹</a><br><a href="https://juejin.im/post/5acf34eff265da237314d6e0" target="_blank" rel="noopener">ã€ŠUITableView æ€§èƒ½ä¼˜åŒ–ã€‹</a></p>
</blockquote>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/iOSå¼€å‘/">iOSå¼€å‘</a>
            
              <a href="/tags/é˜…è¯»/">é˜…è¯»</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/03/21/å¼€æºé¡¹ç›®ï¼šPageMenu/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">å¼€æºé¡¹ç›®ï¼šPageMenu</span>
        <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
      </a>
    
    
      <a class="next" href="/2019/01/28/NSNotificationCenteræ¢ç´¢/">
        <span class="next-text nav-default">NSNotificationCenteræ¢ç´¢</span>
        <span class="prev-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ChenYalun" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://weibo.com/icqk" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
      
        
          <a href="https://stackoverflow.com/users/7026915/allen" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    May Be 
  </span>
  
  <span class="theme-info">
    Better  
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even"> </a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ya</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  
  <script>
    var cloudTieConfig = {
      url: document.location.href, 
      sourceId: "",
      productKey: "f132359147224247aa1c3ad32d20490b",
      target: "cloud-tie-wrapper"
    };
  </script>
  <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>





    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
