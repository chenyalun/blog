<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="iOS应用优化总结"/>




  <meta name="keywords" content="iOS,优化," />




  <link rel="alternate" href="/atom.xml" title="Ya">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://blog.chenyalun.com/2017/02/14/iOS应用优化总结/"/>


<meta name="description" content="一些优化的Tips。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS应用优化总结">
<meta property="og:url" content="http://blog.chenyalun.com/2017/02/14/iOS应用优化总结/index.html">
<meta property="og:site_name" content="Ya">
<meta property="og:description" content="一些优化的Tips。">
<meta property="og:updated_time" content="2017-03-15T09:17:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS应用优化总结">
<meta name="twitter:description" content="一些优化的Tips。">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  



    <title> iOS应用优化总结 · Ya </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ya</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/categories/阅读/">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ya</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              时间线
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories/阅读/">
            
            
              阅读
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          iOS应用优化总结
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年2月14日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#内存"><span class="toc-text">内存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#优化"><span class="toc-text">优化</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p align="center"> 一些优化的Tips。 </p>

<a id="more"></a>
<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><ul>
<li><p>UITableView采用注册的方式使用reuseIdentifier<br><code>static NSString *CellIdentifier = @&quot;Cell&quot;;</code>复用 Cell 与各个 Section 的 Header 和 Footer。<br>复用 Cell 时， storyboard 中的 cell 设置 reuseIdentifier 完毕即可，无需注册，xib 与 class 自定义的cell 需要设置 reuseIdentifier 而且要注册。</p>
</li>
<li><p>使用UITableView+FDTemplateLayoutCell<br>优点:预缓存机制/自动的缓存失效机制/根据 autolayout 约束自动计算高度。<br>注意:cacheByKey比cacheByIndexPath 更为高效。</p>
 <figure class="highlight groovy"><table><tr><td class="code"><pre><div class="line"><span class="keyword">return</span> [tableView <span class="string">fd_heightForCellWithIdentifier:</span>reuseIdentifier <span class="string">cacheByIndexPath:</span>indexPath <span class="string">configuration:</span>^(YACommentTableViewCell *cell) &#123;</div><div class="line">       cell.comment = self.comments[indexPath.section][indexPath.row];</div><div class="line">   &#125;];</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>使用</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 不缓存高度</span></div><div class="line"><span class="keyword">return</span> [tableView <span class="string">fd_heightForCellWithIdentifier:</span>reuseIdentifier <span class="string">configuration:</span>^(YACommentTableViewCell *cell)&#123;</div><div class="line">    cell.comment = self.comments[indexPath.section][indexPath.row];</div><div class="line">    </div><div class="line">&#125;];</div><div class="line">     </div><div class="line"><span class="comment">// 更高效，但是当高度变化时，需要手动清除缓存</span></div><div class="line">YACommentModel *model = self.comments[indexPath.section][indexPath.row];</div><div class="line"><span class="keyword">return</span> [tableView <span class="string">fd_heightForCellWithIdentifier:</span>reuseIdentifier <span class="string">cacheByKey:</span>model.ID <span class="string">configuration:</span>^(id cell) &#123;</div><div class="line">     cell.comment = self.comments[indexPath.section][indexPath.row];</div><div class="line">&#125;];</div><div class="line">     </div><div class="line"><span class="comment">// 移除 key 对应的高度缓存</span></div><div class="line">[tableView.fd_keyedHeightCache <span class="string">invalidateHeightForKey:</span>key];</div><div class="line"><span class="comment">// 移除所有高度缓存</span></div><div class="line">[tableView.fd_keyedHeightCache invalidateAllHeightCache];</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>设置 opaque 为YES，尽量把 view 设置为透明。</li>
</ul>
<ul>
<li><p>尽量不使用<code>cellForRowAtIndexPath:</code>，用一次然后缓存结果。</p>
</li>
<li><p>尝试缓存。</p>
</li>
<li><p>保证XIB文件的小巧灵活。</p>
</li>
<li><p>预处理懒加载。</p>
</li>
<li><p>处理内存警告。</p>
</li>
<li><p>单一固定的情况下，使用<code>rowHeight</code>， <code>sectionFooterHeight</code>和 <code>sectionHeaderHeight</code>来设定固定的高，而不是请求delegate。</p>
</li>
<li><p>使用</p>
<figure class="highlight cos"><table><tr><td class="code"><pre><div class="line">shadowPath，<span class="keyword">view</span>.layer.shadowPath = [[UIBezierPath bezierPathWithRect:<span class="keyword">view</span>.bounds] CGPath]<span class="comment">;</span></div><div class="line"></div><div class="line">  <span class="comment">// 而不是:</span></div><div class="line"></div><div class="line">  <span class="keyword">view</span>.layer.shadowOffset = CGSizeMake(-<span class="number">1</span>， <span class="number">1</span>)<span class="comment">;</span></div><div class="line">  </div><div class="line">  <span class="keyword">view</span>.layer.shadowRadius = <span class="number">1.0</span>f<span class="comment">;</span></div><div class="line">  </div><div class="line">  <span class="keyword">view</span>.layer.shadowOpacity = <span class="number">0.1</span><span class="comment">;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><ul>
<li><p>合理开线程，主线程占1M，子线程占512K。UI 操作和 DataSource 的操作一定在主线程。DB 操作、日志记录、网络回调都在各自的固定线程。</p>
</li>
<li><p>选择合适的容器，减少subviews的数量。<br>NSArrayi:有序的。能搞按照索引快速查找元素。按照值查找很慢，插入和删除很慢。<br>NSDictionary:无序的。键值对存储。按照key可以快速查找。<br>NSSet: 无序的。按照值可以快速查找，插入和删除很快。</p>
</li>
<li><p>正确使用 <code>imageNamed:</code> 与 <code>imageWithContentsOfFile:</code>，<code>imageNamed:</code>的优点是当加载时会缓存图片，所以当图片会频繁的使用时，用<code>imageNamed:</code>。<code>imageWithContentsOfFile：</code>仅加载图片，图像数据不会缓存，对于较大的图片以及使用情况较少时，就可以用该方法，降低内存消耗。</p>
</li>
<li><p>慎用 NSDateFormatter和NSCalendar，缓存 NSDateFormatter 的结果。<br>Creating a date formatter is not a cheap operation. If you are likely to use a formatter frequently， it is typically more efficient to cache a single instance than to create and dispose of multiple instances. One approach is to use a static variable.</p>
</li>
</ul>
<ul>
<li><p>在iOS 7、macOS 10.9及以上系统版本，NSDateFormatter都是线程安全的。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>， <span class="keyword">strong</span>) <span class="built_in">NSDateFormatter</span> *formatter;</div><div class="line">   </div><div class="line">- (<span class="built_in">NSDateFormatter</span> *)formatter &#123;</div><div class="line"> <span class="keyword">static</span> <span class="built_in">NSDateFormatter</span> *formatter;</div><div class="line"> <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line"> <span class="built_in">dispatch_once</span>(&amp;onceToken， ^&#123;</div><div class="line">     _formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</div><div class="line">     _formatter.dateFormat = <span class="string">@"EEE MMM dd HH:mm:ss Z yyyy"</span>; <span class="comment">// twitter date format</span></div><div class="line"> &#125;);</div><div class="line"> <span class="keyword">return</span> formatter</div><div class="line">;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>寻找 (NSDate *)dateFromString:(NSString )string 的替换品。下面是ISO8601 转成 NSDate 的 NSDateFormatter 的最著名替代品，也可以使用开源作品:NSDate+SSToolkitAdditions。</p>
 <figure class="highlight perl"><table><tr><td class="code"><pre><div class="line">  //<span class="comment">#include &lt;time.h&gt;</span></div><div class="line">time_t t;</div><div class="line">struct tm tm;</div><div class="line">strptime([iso8601String cStringUsingEncoding:NSUTF8StringEncoding]， <span class="string">"%Y-%m-%dT%H:%M:%S%z"</span>， &amp;tm);</div><div class="line">tm.tm_isdst = -<span class="number">1</span>;</div><div class="line">t = mktime(&amp;tm);</div><div class="line">[NSDate dateWithTimeIntervalSince197<span class="number">0</span>:t + [[NSTimeZone localTimeZone] secondsFromGM</div><div class="line">T]];</div></pre></td></tr></table></figure>
</li>
<li><p>不要随意使用 <code>NSLog()</code>。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></div><div class="line"><span class="comment">// Only log when attached to the debugger</span></div><div class="line"><span class="meta">#    <span class="meta-keyword">define</span> DLog(...) NSLog(__VA_ARGS__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#    <span class="meta-keyword">define</span> DLog(...) <span class="comment">/* */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="comment">// Always log， even in production</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALog(...) NSLog(__VA_ARGS__)</span></div></pre></td></tr></table></figure>
</li>
<li><p>当试图获取磁盘中一个文件的属性信息时，使用 <code>[NSFileManager attributesOfItemAtPath:error:]</code>会浪费大量时间读取可能根本不需要的附加属性。这时可以使用 stat 代替 NSFileManager，直接获取文件属性：</p>
 <figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line">  <span class="keyword">struct</span> stat statbuf;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *cpath = [filePath fileSystemRepresentation];</div><div class="line">  <span class="keyword">if</span> (cpath &amp;&amp; stat(cpath， &amp;statbuf) == <span class="number">0</span>) &#123;</div><div class="line">      <span class="built_in">NSNumber</span> *fileSize = [<span class="built_in">NSNumber</span> numberWithUnsignedLongLong:statbuf.st_size];</div><div class="line">      <span class="built_in">NSDate</span> *modificationDate = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:statbuf.st_mtime];</div><div class="line">      <span class="built_in">NSDate</span> *creationDate = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:statbuf.st_ctime];</div><div class="line">      <span class="comment">// etc</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>MLeakFinder 能在开发阶段，把内存泄露问题暴露无遗，减少了很多潜在的性能问题.    原理:在一个 ViewController 被 pop 或 dismiss 一小段时间后，看看该 UIViewController，它的 view，view 的 subviews 等等是否还存在。</p>
</li>
<li><p>接入bugly。</p>
</li>
<li><p>创造圆形图片避免使用以下方式(会造成离屏渲染):</p>
 <figure class="highlight maxima"><table><tr><td class="code"><pre><div class="line"><span class="built_in">view</span>.layer.cornerRadius = <span class="built_in">view</span>.<span class="built_in">width</span> * <span class="number">0.5</span>;</div><div class="line">   <span class="built_in">view</span>.layer.masksToBounds = <span class="literal">true</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>圆形图片</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><div class="line">UIBezierPath *clipPath = [UIBezierPath bezierPathWithOvalInRect:CGRectMake(<span class="number">0</span>， <span class="number">0</span>， <span class="built_in">image</span>.<span class="built_in">size</span>.<span class="built_in">width</span>， <span class="built_in">image</span>.<span class="built_in">size</span>.<span class="built_in">height</span>)] ;</div><div class="line">     </div><div class="line">[clipPath addClip] ;</div><div class="line">    </div><div class="line">[<span class="built_in">image</span> drawAtPoint:CGPointZero] ;</div><div class="line">     </div><div class="line"><span class="built_in">image</span> = UIGraphicsGetImageFromCurrentImageContext() ;</div><div class="line"> </div><div class="line">UIGraphicsEndImageContext() ;</div><div class="line">     </div><div class="line"><span class="built_in">return</span> <span class="built_in">image</span> ;</div></pre></td></tr></table></figure>
</li>
<li><p>设置Label的圆角。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 不要这么做：label.backgroundColor = aColor </span></div><div class="line"><span class="comment">// 以及不要在 IB 里为 label 设置背景色</span></div><div class="line"><span class="selector-tag">label</span><span class="selector-class">.layer</span><span class="selector-class">.backgroundColor</span> = aColor</div><div class="line"><span class="selector-tag">label</span><span class="selector-class">.layer</span><span class="selector-class">.cornerRadius</span> = <span class="number">5</span></div></pre></td></tr></table></figure>
</li>
<li><p>指定图片的宽高为整数，否则造成离屏渲染。</p>
</li>
<li><p>cell当中不要动态的添加子控件，选中适时地显示与隐藏。</p>
</li>
<li><p>当控件非常多时，把不需要与用户进行交互的控件.通过异步绘制成一张图片，把图片添加到cell当中。</p>
</li>
<li>将 UIView 的属性 clearsContextBeforeDrawing 设置为 NO 在多数情况下可以提高绘制性能，尤其是在用绘制代码实现了一个定制 view 的时候。</li>
<li><p>设置阴影。</p>
<figure class="highlight cos"><table><tr><td class="code"><pre><div class="line"><span class="keyword">view</span>.layer.shadowPath = [[UIBezierPath bezierPathWithRect:<span class="keyword">view</span>.bounds] CGPath]<span class="comment">;</span></div><div class="line">   </div><div class="line"><span class="comment">// 而不是</span></div><div class="line"><span class="keyword">view</span>.layer.shadowOffset = CGSizeMake(-<span class="number">1.0</span>f， <span class="number">1.0</span>f)<span class="comment">;</span></div><div class="line"><span class="keyword">view</span>.layer.shadowRadius = <span class="number">5.0</span>f<span class="comment">;</span></div><div class="line"><span class="keyword">view</span>.layer.shadowOpacity = <span class="number">0.6</span><span class="comment">;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通常图层的以下属性将会触发离屏渲染：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">阴影（UIView<span class="selector-class">.layer</span><span class="selector-class">.shadowOffset</span>/shadowRadius/…）</div><div class="line">圆角（当 UIView<span class="selector-class">.layer</span><span class="selector-class">.cornerRadius</span> 和 UIView<span class="selector-class">.layer</span><span class="selector-class">.maskToBounds</span> 一起使用时）</div><div class="line">图层蒙板</div></pre></td></tr></table></figure>
</li>
<li><p>使用 Autorelease Pool，当需要在代码中创建许多临时对象时，可以显式的使用 Autorelease Pool。</p>
</li>
<li><p>使用IMP。</p>
</li>
</ul>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/iOS/">iOS</a>
            
              <a href="/tags/优化/">优化</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/02/20/Git:LLDB:Linux等常用命令/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Git/LLDB/Linux等常用命令</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/02/11/iOS常用设计模式/">
        <span class="next-text nav-default">iOS常用设计模式</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ChenYalun" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/icqk" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
      
        
          <a href="http://stackoverflow.com/users/7026915/allen" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    May Be 
  </span>
  
  <span class="theme-info">
    Better  
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even"> </a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ya</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  
  <script>
    var cloudTieConfig = {
      url: document.location.href, 
      sourceId: "",
      productKey: "f132359147224247aa1c3ad32d20490b",
      target: "cloud-tie-wrapper"
    };
  </script>
  <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>





    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
